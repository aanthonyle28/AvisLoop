---
phase: 30.1-audit-gaps
plan: 04
type: execute
wave: 2
depends_on:
  - 30.1-01
files_modified:
  - app/(dashboard)/campaigns/[id]/page.tsx
  - lib/data/campaign.ts
autonomous: true

must_haves:
  truths:
    - "Campaign detail page shows paginated enrollment list"
    - "Pagination controls visible when enrollments exceed page size"
    - "User can navigate between pages of enrollments"
  artifacts:
    - path: "app/(dashboard)/campaigns/[id]/page.tsx"
      provides: "Paginated enrollment list UI"
      contains: "EnrollmentPagination"
    - path: "lib/data/campaign.ts"
      provides: "Paginated enrollment fetch function"
      exports: ["getCampaignEnrollments"]
  key_links:
    - from: "app/(dashboard)/campaigns/[id]/page.tsx"
      to: "lib/data/campaign.ts"
      via: "getCampaignEnrollments with pagination"
      pattern: "getCampaignEnrollments.*page|offset"
---

<objective>
Add pagination to campaign enrollment list on campaign detail page.

Purpose: Campaign enrollments can be large; pagination prevents performance issues and improves UX (QA-AUDIT M04-01).

Output: Campaign detail page with paginated enrollment list (20 per page).
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/QA-AUDIT.md (M04-01: Enrollment list pagination)

Campaign detail page: @app/(dashboard)/campaigns/[id]/page.tsx
Campaign data: @lib/data/campaign.ts
Current state: getCampaignEnrollments fetches max 20, no pagination controls
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pagination to getCampaignEnrollments</name>
  <files>lib/data/campaign.ts</files>
  <action>
Update getCampaignEnrollments to support pagination with total count:

```tsx
interface GetCampaignEnrollmentsOptions {
  limit?: number
  offset?: number
}

interface CampaignEnrollmentsResult {
  enrollments: CampaignEnrollmentWithRelations[]
  total: number
}

export async function getCampaignEnrollments(
  campaignId: string,
  options: GetCampaignEnrollmentsOptions = {}
): Promise<CampaignEnrollmentsResult> {
  const { limit = 20, offset = 0 } = options
  const supabase = await createClient()

  // Get total count
  const { count } = await supabase
    .from('campaign_enrollments')
    .select('*', { count: 'exact', head: true })
    .eq('campaign_id', campaignId)

  // Get paginated enrollments
  const { data: enrollments } = await supabase
    .from('campaign_enrollments')
    .select(`
      *,
      customers (name, email),
      jobs (service_type)
    `)
    .eq('campaign_id', campaignId)
    .order('enrolled_at', { ascending: false })
    .range(offset, offset + limit - 1)

  return {
    enrollments: enrollments || [],
    total: count || 0,
  }
}
```

Ensure the function maintains backward compatibility - existing calls with just limit will still work.
  </action>
  <verify>grep "offset" lib/data/campaign.ts shows pagination parameter</verify>
  <done>getCampaignEnrollments supports pagination with offset and returns total count</done>
</task>

<task type="auto">
  <name>Task 2: Add pagination UI to campaign detail page</name>
  <files>app/(dashboard)/campaigns/[id]/page.tsx</files>
  <action>
Convert campaign detail page to handle pagination via URL search params:

1. Accept searchParams for page number
2. Calculate offset from page
3. Render pagination controls when needed

```tsx
import { Button } from '@/components/ui/button'
import { CaretLeft, CaretRight } from '@phosphor-icons/react/dist/ssr'

interface CampaignDetailPageProps {
  params: Promise<{ id: string }>
  searchParams: Promise<{ page?: string }>
}

export default async function CampaignDetailPage({ params, searchParams }: CampaignDetailPageProps) {
  const { id } = await params
  const { page: pageParam } = await searchParams

  const currentPage = Math.max(1, parseInt(pageParam || '1', 10))
  const pageSize = 20
  const offset = (currentPage - 1) * pageSize

  const [campaign, { enrollments, total }, counts, analytics] = await Promise.all([
    getCampaign(id),
    getCampaignEnrollments(id, { limit: pageSize, offset }),
    getCampaignEnrollmentCounts(id),
    getCampaignAnalytics(id),
  ])

  const totalPages = Math.ceil(total / pageSize)

  // ... existing content ...

  // In the enrollments card, add pagination:
  {total > pageSize && (
    <div className="flex items-center justify-between pt-4 border-t mt-4">
      <p className="text-sm text-muted-foreground">
        Showing {offset + 1}-{Math.min(offset + pageSize, total)} of {total} enrollments
      </p>
      <div className="flex items-center gap-2">
        <Link
          href={`/campaigns/${id}?page=${currentPage - 1}`}
          className={currentPage <= 1 ? 'pointer-events-none opacity-50' : ''}
        >
          <Button variant="outline" size="sm" disabled={currentPage <= 1}>
            <CaretLeft className="h-4 w-4 mr-1" />
            Previous
          </Button>
        </Link>
        <span className="text-sm text-muted-foreground">
          Page {currentPage} of {totalPages}
        </span>
        <Link
          href={`/campaigns/${id}?page=${currentPage + 1}`}
          className={currentPage >= totalPages ? 'pointer-events-none opacity-50' : ''}
        >
          <Button variant="outline" size="sm" disabled={currentPage >= totalPages}>
            Next
            <CaretRight className="h-4 w-4 ml-1" />
          </Button>
        </Link>
      </div>
    </div>
  )}
```

Update the card title to show count:
```tsx
<CardTitle>Recent Enrollments ({total})</CardTitle>
```
  </action>
  <verify>
- grep "searchParams" app/(dashboard)/campaigns/[id]/page.tsx
- grep "totalPages" app/(dashboard)/campaigns/[id]/page.tsx
- grep "Previous" app/(dashboard)/campaigns/[id]/page.tsx
  </verify>
  <done>Campaign detail page has paginated enrollment list with navigation controls</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. Campaign detail page shows enrollment count in title
4. When >20 enrollments, pagination controls appear
5. Clicking Next/Previous updates page via URL
6. Page 1 shows enrollments 1-20, page 2 shows 21-40, etc.
</verification>

<success_criteria>
- getCampaignEnrollments accepts offset parameter and returns total count
- Campaign detail page reads page from URL search params
- Pagination controls visible when total > 20
- Navigation works via links (SEO-friendly, no client state)
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/30.1-audit-gaps/30.1-04-SUMMARY.md`
</output>
