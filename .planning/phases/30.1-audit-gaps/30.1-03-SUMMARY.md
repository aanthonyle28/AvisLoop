---
phase: 30.1-audit-gaps
plan: 03
subsystem: ui
tags: [jobs, campaigns, enrollment, preview, table]

# Dependency graph
requires:
  - phase: 24
    provides: campaign enrollments, campaign_enrollments table
  - phase: 22
    provides: jobs table with service_type
provides:
  - Campaign enrollment preview column in job table
  - getMatchingCampaignsForJobs batch lookup function
  - JobWithEnrollment type with enrollment relations
affects: [job-detail-drawer, mobile-jobs-view]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Campaign map pattern: batch fetch matching campaigns, pass as Map through component tree"
    - "Enrollment status display: active=green, completed=muted, stopped=muted, preview=clock+primary"

key-files:
  created: []
  modified:
    - lib/data/campaign.ts
    - lib/data/jobs.ts
    - lib/types/database.ts
    - components/jobs/job-columns.tsx
    - components/jobs/job-table.tsx
    - components/jobs/jobs-client.tsx
    - app/(dashboard)/jobs/page.tsx

key-decisions:
  - "Batch campaign lookup for efficiency - single query for all service types"
  - "Campaign preview shows timing as hours or days (24h threshold)"
  - "Enrollment status icons: CheckCircle (enrolled), Clock (preview), XCircle (not enrolled), Minus (stopped)"

patterns-established:
  - "Campaign enrollment preview pattern: fetch campaignMap in page, pass through client, enhance jobs in table"

# Metrics
duration: 4min
completed: 2026-02-06
---

# Phase 30.1 Plan 03: Campaign Enrollment Preview Summary

**Job table now shows campaign enrollment preview column with status icons and timing for scheduled jobs**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-06T10:06:29Z
- **Completed:** 2026-02-06T10:10:52Z
- **Tasks:** 3
- **Files modified:** 7

## Accomplishments
- Added getMatchingCampaignForJob and getMatchingCampaignsForJobs functions for campaign lookup
- Created JobWithEnrollment type with enrollment relations and matchingCampaign client-side field
- Added Campaign column to job table showing enrollment status and preview
- Scheduled jobs show "HVAC Campaign in 24h" style preview
- Completed enrolled jobs show green checkmark with campaign name
- do_not_send jobs show "Not enrolled" indicator

## Task Commits

Each task was committed atomically:

1. **Task 1: Add getMatchingCampaignForJob function** - `10476a3` (feat)
2. **Task 2: Add enrollment preview column to job table** - `98f8e85` (feat)
3. **Task 3: Update Jobs page to pass campaign data** - `a03416d` (feat)

## Files Created/Modified
- `lib/data/campaign.ts` - Added getMatchingCampaignForJob and getMatchingCampaignsForJobs functions
- `lib/data/jobs.ts` - Updated getJobs to fetch enrollment data and return businessId
- `lib/types/database.ts` - Added JobWithEnrollment type with enrollment relations
- `components/jobs/job-columns.tsx` - Added Campaign column with enrollment status display
- `components/jobs/job-table.tsx` - Added campaignMap prop and enhancedJobs useMemo
- `components/jobs/jobs-client.tsx` - Added campaignMap prop passthrough
- `app/(dashboard)/jobs/page.tsx` - Fetch and pass campaign data to client

## Decisions Made
- Used batch lookup (getMatchingCampaignsForJobs) for efficiency - single query fetches all active campaigns
- Display timing as hours if < 24h, otherwise as days (rounded)
- Enrollment status icons: CheckCircle (active enrollment), Clock (preview/pending), XCircle (not enrolled), Minus (stopped)
- Enhanced jobs with matchingCampaign on client side via useMemo for reactive filtering

## Deviations from Plan

None - plan executed exactly as written.

Note: Plan mentioned job-detail-drawer.tsx but this file doesn't exist yet. The primary deliverable (table column) is complete. Detail drawer enrollment info can be added when that component is created.

## Issues Encountered
- Linter was auto-reformatting files during edits, causing need to re-read files between edits
- Resolved by reading latest file state before each edit

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Campaign enrollment preview visible in job table
- Ready for job-detail-drawer implementation when that component is built
- No blockers

---
*Phase: 30.1-audit-gaps*
*Completed: 2026-02-06*
