---
phase: 17-deployment-critical-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00009b_create_scheduled_sends.sql
autonomous: true

must_haves:
  truths:
    - "Migration 00009b creates the scheduled_sends table before 00010 references it"
    - "RLS is enabled on scheduled_sends with SELECT, INSERT, UPDATE policies"
    - "Migration sequence is valid: 00009 -> 00009b -> 00010 in alphabetical order"
  artifacts:
    - path: "supabase/migrations/00009b_create_scheduled_sends.sql"
      provides: "scheduled_sends table creation with RLS and indexes"
      contains: "CREATE TABLE"
  key_links:
    - from: "supabase/migrations/00009b_create_scheduled_sends.sql"
      to: "supabase/migrations/00010_claim_due_scheduled_sends.sql"
      via: "table dependency"
      pattern: "scheduled_sends"
---

<objective>
Create the missing `scheduled_sends` table migration that must run before migration 00010 (which references `SETOF scheduled_sends`).

Purpose: Fix deployment blocker -- a fresh database deploy currently fails at migration 00010 because no prior migration creates the `scheduled_sends` table. The table was manually applied during development but never captured as a migration file.

Output: Migration file `00009b_create_scheduled_sends.sql` that slots between 00009 and 00010 alphabetically.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

The ScheduledSend TypeScript type defines the table columns (from lib/types/database.ts):

```typescript
export interface ScheduledSend {
  id: string                                          // UUID PK
  business_id: string                                 // FK -> businesses.id
  contact_ids: string[]                               // UUID array (contacts to send to)
  template_id: string | null                          // FK -> email_templates.id (optional)
  custom_subject: string | null                       // Override subject line
  scheduled_for: string                               // TIMESTAMPTZ when to send
  status: 'pending' | 'completed' | 'failed' | 'cancelled'  // Processing state
  executed_at: string | null                          // TIMESTAMPTZ when actually processed
  send_log_ids: string[] | null                       // UUID array (resulting send_log records)
  error_message: string | null                        // Error details on failure
  created_at: string                                  // TIMESTAMPTZ
  updated_at: string                                  // TIMESTAMPTZ
}
```

Existing migration patterns to follow (from 00005_create_send_logs.sql and similar):
- RLS enabled with subquery pattern (SELECT business_id FROM businesses WHERE user_id = auth.uid())
- SELECT, INSERT, UPDATE policies (no DELETE -- use status changes instead)
- moddatetime trigger for updated_at
- Indexes on business_id, status, and scheduled_for for cron query performance
- CASCADE on business_id FK, SET NULL on template_id FK

Migration 00010 creates functions:
- `claim_due_scheduled_sends(limit_count INT)` - RETURNS SETOF scheduled_sends
- `recover_stuck_scheduled_sends(stale_minutes INT)` - RETURNS SETOF scheduled_sends

Both reference the scheduled_sends table, so 00009b MUST run first.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scheduled_sends table migration</name>
  <files>supabase/migrations/00009b_create_scheduled_sends.sql</files>
  <action>
Create migration file `supabase/migrations/00009b_create_scheduled_sends.sql` with:

1. **Table creation** matching the ScheduledSend TypeScript interface:
   ```sql
   CREATE TABLE IF NOT EXISTS public.scheduled_sends (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     business_id UUID NOT NULL REFERENCES public.businesses(id) ON DELETE CASCADE,
     contact_ids UUID[] NOT NULL,
     template_id UUID REFERENCES public.email_templates(id) ON DELETE SET NULL,
     custom_subject TEXT,
     scheduled_for TIMESTAMPTZ NOT NULL,
     status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'cancelled')),
     executed_at TIMESTAMPTZ,
     send_log_ids UUID[],
     error_message TEXT,
     created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
     updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
   );
   ```
   Note: Include 'processing' in status CHECK -- the claim function in 00010 sets status to 'processing'.

2. **Enable RLS:**
   ```sql
   ALTER TABLE public.scheduled_sends ENABLE ROW LEVEL SECURITY;
   ```

3. **RLS policies** using the same subquery pattern as other tables:
   - SELECT: "Users can view own scheduled_sends" -- WHERE business_id IN (SELECT id FROM businesses WHERE user_id = auth.uid())
   - INSERT: "Users can insert own scheduled_sends" -- same subquery in WITH CHECK
   - UPDATE: "Users can update own scheduled_sends" -- same subquery in USING and WITH CHECK

4. **Indexes for cron performance:**
   - `idx_scheduled_sends_business_id` on (business_id) -- FK lookups
   - `idx_scheduled_sends_pending_due` on (status, scheduled_for) WHERE status = 'pending' -- partial index for cron claim query
   - `idx_scheduled_sends_created_at` on (created_at DESC) -- listing queries

5. **moddatetime trigger** for auto-updating updated_at:
   ```sql
   CREATE TRIGGER set_scheduled_sends_updated_at
     BEFORE UPDATE ON public.scheduled_sends
     FOR EACH ROW
     EXECUTE FUNCTION moddatetime(updated_at);
   ```

Add a header comment explaining this migration fills the gap between 00009 and 00010.
  </action>
  <verify>
  1. Confirm file exists: `ls supabase/migrations/00009b_create_scheduled_sends.sql`
  2. Confirm alphabetical order: `ls supabase/migrations/ | head -12` should show 00009 -> 00009b -> 00010
  3. Confirm SQL contains: CREATE TABLE, ENABLE ROW LEVEL SECURITY, CREATE POLICY (3x), CREATE INDEX (3x), CREATE TRIGGER
  4. Run `pnpm typecheck` to confirm no regressions
  </verify>
  <done>
  Migration file exists at supabase/migrations/00009b_create_scheduled_sends.sql with table, RLS, indexes, and trigger. Alphabetical sort places it after 00009 and before 00010.
  </done>
</task>

</tasks>

<verification>
1. `ls supabase/migrations/` shows 00009b between 00009 and 00010
2. Migration SQL contains all required elements (table, 5 status values including 'processing', RLS enable, 3 policies, 3 indexes, trigger)
3. `pnpm typecheck` passes
4. Table columns match ScheduledSend TypeScript interface exactly
</verification>

<success_criteria>
- Migration file `00009b_create_scheduled_sends.sql` exists and sorts between 00009 and 00010
- Table schema matches TypeScript ScheduledSend interface
- RLS enabled with SELECT/INSERT/UPDATE policies
- Partial index on pending+scheduled_for for cron query performance
- moddatetime trigger for updated_at
- Status CHECK includes 'processing' (used by claim function in 00010)
</success_criteria>

<output>
After completion, create `.planning/phases/17-deployment-critical-fixes/17-01-SUMMARY.md`
</output>
