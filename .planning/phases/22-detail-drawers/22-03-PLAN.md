---
phase: 22-detail-drawers
plan: 03
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - components/contacts/contact-detail-drawer.tsx
  - components/contacts/contacts-client.tsx
  - components/contacts/contact-table.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a contact row on the contacts page opens a detail drawer from the right"
    - "The drawer shows contact info (name, email, phone, initials avatar)"
    - "The drawer has an editable notes textarea that auto-saves with debounce"
    - "Notes typed and saved persist to the database and reappear on next drawer open"
    - "The drawer has action buttons: Send Request, Edit Contact, Archive, View History"
    - "Clicking action buttons in table rows (edit, archive) does NOT also open the drawer (stopPropagation)"
  artifacts:
    - path: "components/contacts/contact-detail-drawer.tsx"
      provides: "Contact detail drawer with notes auto-save"
      exports: ["ContactDetailDrawer"]
      min_lines: 80
    - path: "components/contacts/contacts-client.tsx"
      provides: "Drawer state management + row click handler"
      contains: "ContactDetailDrawer"
    - path: "components/contacts/contact-table.tsx"
      provides: "Row click handler + stopPropagation on action buttons"
      contains: "onRowClick"
  key_links:
    - from: "components/contacts/contact-table.tsx"
      to: "components/contacts/contacts-client.tsx"
      via: "onRowClick callback"
      pattern: "onRowClick"
    - from: "components/contacts/contacts-client.tsx"
      to: "components/contacts/contact-detail-drawer.tsx"
      via: "renders ContactDetailDrawer with selectedContact state"
      pattern: "ContactDetailDrawer"
    - from: "components/contacts/contact-detail-drawer.tsx"
      to: "lib/actions/contact.ts"
      via: "calls updateContactNotes on debounced change"
      pattern: "updateContactNotes"
---

<objective>
Create the contact detail drawer component and wire it into the contacts page so clicking a contact row opens a right-side drawer with contact info, auto-saving notes, and action buttons.

Purpose: Satisfies DRWR-02 (contact detail drawer with info + notes + actions) and DRWR-04 (editable notes that persist to database).
Output: ContactDetailDrawer component, wired contacts page, row click handling with stopPropagation on action buttons.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-detail-drawers/22-RESEARCH.md
@.planning/phases/22-detail-drawers/22-01-SUMMARY.md
@components/contacts/contacts-client.tsx
@components/contacts/contact-table.tsx
@components/contacts/edit-contact-sheet.tsx
@components/history/request-detail-drawer.tsx
@lib/actions/contact.ts
@lib/types/database.ts
@components/ui/textarea.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ContactDetailDrawer component</name>
  <files>
    components/contacts/contact-detail-drawer.tsx
  </files>
  <action>
    Create `components/contacts/contact-detail-drawer.tsx` as a 'use client' component.

    **Structure** (follow the pattern from `request-detail-drawer.tsx` and research code examples):

    ```
    Props:
      open: boolean
      onOpenChange: (open: boolean) => void
      contact: Contact | null
      onSend: (contact: Contact) => void
      onEdit: (contact: Contact) => void
      onArchive: (contactId: string) => void
      onViewHistory: (contactId: string) => void
    ```

    **Sections (top to bottom):**

    1. **Header**: SheetTitle "Contact Details", SheetDescription "View contact information, add notes, and take actions"

    2. **Contact Info**: Initials avatar (bg-primary/10, text-primary), name (font-medium), email (text-muted-foreground), phone if present

    3. **Separator**

    4. **Notes Field** (auto-save with 500ms debounce):
       - Label "Notes"
       - Helper text: "Add private notes about this contact (auto-saved)" in text-xs text-muted-foreground
       - Textarea component (from `@/components/ui/textarea`) with `min-h-[120px]`
       - State: `const [notes, setNotes] = useState('')`
       - Sync notes when contact changes: `useEffect` keyed on `contact?.id` that sets `setNotes(contact?.notes || '')`
       - Debounced save: on change, clear existing timeout, set new 500ms timeout calling `updateContactNotes(contact.id, newValue)`
       - **Flush on close**: In the `onOpenChange` handler (in parent), flush any pending save before closing. Alternatively, in the drawer itself, add a `useEffect` cleanup that flushes pending save AND also save immediately when `open` transitions from true to false.
       - Use `useRef<ReturnType<typeof setTimeout>>` for the timeout ref
       - Track `lastSavedRef` to avoid saving unchanged values on unmount

    5. **Separator**

    6. **Activity Summary**: "Last sent" (date or "Never"), "Total sent" (count), "Status" (capitalize). Use `format(new Date(contact.last_sent_at), 'MMM d, yyyy')` from date-fns.

    7. **Separator**

    8. **Action Buttons** (vertical stack, full width):
       - "Send Request" (default variant, PaperPlaneRight icon) -> calls `onSend(contact)`
       - "Edit Contact" (outline variant, PencilSimple icon) -> calls `onEdit(contact)`
       - "Archive" (outline variant, Archive icon) -> calls `onArchive(contact.id)`
       - "View History" (ghost variant, ClockCounterClockwise icon) -> calls `onViewHistory(contact.id)`

    **Icons**: Use Phosphor icons (PaperPlaneRight, PencilSimple, Archive, ClockCounterClockwise) -- consistent with rest of app.

    **Imports needed:**
    - Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription from `@/components/ui/sheet`
    - Button from `@/components/ui/button`
    - Textarea from `@/components/ui/textarea`
    - Label from `@/components/ui/label`
    - Separator from `@/components/ui/separator`
    - Phosphor icons
    - updateContactNotes from `@/lib/actions/contact`
    - format from `date-fns`
    - Contact type from `@/lib/types/database`

    **Critical: Flush pending notes on close.** Use this pattern:
    ```typescript
    // Track current value for flush
    const notesRef = useRef(notes)
    notesRef.current = notes
    const initialNotesRef = useRef('')

    useEffect(() => {
      if (contact) {
        const initial = contact.notes || ''
        setNotes(initial)
        initialNotesRef.current = initial
      }
    }, [contact?.id])

    // Flush on unmount or when open changes to false
    useEffect(() => {
      if (!open && contact && timeoutRef.current) {
        clearTimeout(timeoutRef.current)
        timeoutRef.current = undefined
        if (notesRef.current !== initialNotesRef.current) {
          updateContactNotes(contact.id, notesRef.current)
        }
      }
    }, [open])
    ```

    **Dark mode**: Use semantic tokens throughout (bg-card, text-foreground, text-muted-foreground, border-border, bg-muted). SheetContent already handles dark mode via the Sheet component.

    Guard: `if (!contact) return null` before rendering.
  </action>
  <verify>
    - `pnpm typecheck` passes
    - Component renders contact info, notes textarea, activity summary, and 4 action buttons
    - Notes auto-save fires after 500ms of inactivity
    - Notes flush on drawer close
  </verify>
  <done>
    - ContactDetailDrawer component created with all required sections
    - Auto-saving notes with 500ms debounce
    - Flush-on-close prevents data loss
    - All 4 action buttons present with correct icons
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire drawer into contacts page + add row click</name>
  <files>
    components/contacts/contacts-client.tsx
    components/contacts/contact-table.tsx
  </files>
  <action>
    **In `contacts-client.tsx`:**

    1. Import ContactDetailDrawer:
       ```typescript
       import { ContactDetailDrawer } from './contact-detail-drawer'
       ```

    2. Add state for detail drawer (alongside existing edit sheet state):
       ```typescript
       const [detailContact, setDetailContact] = useState<Contact | null>(null)
       const [detailDrawerOpen, setDetailDrawerOpen] = useState(false)
       ```

    3. Add row click handler:
       ```typescript
       const handleRowClick = (contact: Contact) => {
         setDetailContact(contact)
         setDetailDrawerOpen(true)
       }
       ```

    4. Add action handlers for the drawer buttons:
       ```typescript
       const handleSendFromDrawer = (contact: Contact) => {
         // Navigate to send page with contact pre-selected
         // For now, just navigate to /send (can enhance later)
         router.push('/send')
         setDetailDrawerOpen(false)
       }

       const handleEditFromDrawer = (contact: Contact) => {
         setDetailDrawerOpen(false)
         // Small delay to avoid two sheets overlapping
         setTimeout(() => {
           handleEdit(contact) // Opens existing edit sheet
         }, 200)
       }

       const handleArchiveFromDrawer = (contactId: string) => {
         handleArchive(contactId)
         setDetailDrawerOpen(false)
       }

       const handleViewHistoryFromDrawer = (contactId: string) => {
         router.push(`/history?contact=${contactId}`)
         setDetailDrawerOpen(false)
       }
       ```

    5. Add `useRouter` import (from `next/navigation`) if not already imported.

    6. Pass `onRowClick` to ContactTable:
       ```tsx
       <ContactTable
         data={initialContacts}
         onEdit={handleEdit}
         onArchive={handleArchive}
         onRestore={handleRestore}
         onDelete={handleDelete}
         onBulkArchive={handleBulkArchive}
         onBulkDelete={handleBulkDelete}
         onRowClick={handleRowClick}
       />
       ```

    7. Render ContactDetailDrawer after EditContactSheet:
       ```tsx
       <ContactDetailDrawer
         open={detailDrawerOpen}
         onOpenChange={(open) => {
           setDetailDrawerOpen(open)
           if (!open) setDetailContact(null)
         }}
         contact={detailContact}
         onSend={handleSendFromDrawer}
         onEdit={handleEditFromDrawer}
         onArchive={handleArchiveFromDrawer}
         onViewHistory={handleViewHistoryFromDrawer}
       />
       ```

    **In `contact-table.tsx`:**

    1. Add `onRowClick` to `ContactTableProps`:
       ```typescript
       onRowClick?: (contact: Contact) => void
       ```

    2. Accept `onRowClick` in destructured props.

    3. On each `<TableRow>` in the body (where data rows render), add:
       ```tsx
       <TableRow
         key={row.id}
         onClick={() => onRowClick?.(row.original)}
         className="cursor-pointer hover:bg-muted/50"
         ...existing props
       >
       ```

    4. **Critical: stopPropagation on action buttons.** In the columns definition file (`contact-columns.tsx` or wherever action cells are defined), wrap each action button's onClick:
       ```tsx
       onClick={(e) => { e.stopPropagation(); onEdit(contact); }}
       ```
       This prevents the row click from firing when the user clicks edit, archive, restore, or delete buttons. Also add stopPropagation to the checkbox column click handler if present.

       Check `components/contacts/contact-columns.tsx` for where action buttons are rendered and add `e.stopPropagation()` to each.
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm lint` passes
    - Click a contact row -> detail drawer opens from right
    - Drawer shows contact info, notes textarea, activity summary, 4 action buttons
    - Click edit button in table row -> opens edit sheet (NOT detail drawer)
    - Click archive button in table row -> archives contact (NOT opens detail drawer)
    - Type in notes -> wait 500ms -> notes saved
    - Close drawer and reopen -> notes persist
    - Checkbox selection in table still works (stopPropagation)
  </verify>
  <done>
    - Contact row click opens detail drawer
    - Action buttons in table rows don't trigger drawer (stopPropagation)
    - Drawer action buttons work: Send, Edit, Archive, View History
    - Notes auto-save and persist across drawer open/close
    - No conflict between detail drawer and existing edit sheet
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm lint` passes
- Contacts page: click row -> detail drawer with contact info, notes, actions
- Notes: type text, close drawer, reopen -> text persists
- Table action buttons (edit, archive, delete, checkbox) don't trigger drawer
- Edit button in drawer opens edit sheet
- All existing contacts page functionality (search, filter, bulk actions, CSV import) still works
</verification>

<success_criteria>
- DRWR-02: Contact row click opens detail drawer with info, notes, and action items
- DRWR-04: Notes textarea auto-saves to database and persists across opens
- No regressions on contacts page existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/22-detail-drawers/22-03-SUMMARY.md`
</output>
