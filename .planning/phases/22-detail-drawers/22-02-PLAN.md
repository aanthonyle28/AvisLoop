---
phase: 22-detail-drawers
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - components/send/send-page-client.tsx
  - components/send/recent-activity-strip.tsx
  - app/(dashboard)/send/page.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a recent activity chip on the send page opens the request detail drawer inline without navigating to /history"
    - "The request detail drawer on the send page includes a resend option with a template selector dropdown"
    - "Closing the drawer does not navigate away from the send page"
  artifacts:
    - path: "components/send/send-page-client.tsx"
      provides: "Request drawer state management + resend/cancel handlers"
      contains: "RequestDetailDrawer"
    - path: "app/(dashboard)/send/page.tsx"
      provides: "Server-side data fetch for drawer (request detail by ID)"
  key_links:
    - from: "components/send/recent-activity-strip.tsx"
      to: "components/send/send-page-client.tsx"
      via: "onItemClick callback sets selectedRequestId"
      pattern: "onItemClick"
    - from: "components/send/send-page-client.tsx"
      to: "components/history/request-detail-drawer.tsx"
      via: "imports and renders RequestDetailDrawer"
      pattern: "RequestDetailDrawer"
    - from: "components/send/send-page-client.tsx"
      to: "/api or server action"
      via: "fetches full request data when chip clicked"
      pattern: "fetch|getRequest"
---

<objective>
Wire the existing RequestDetailDrawer component to open inline on the send page when a recent activity chip is clicked, replacing the current navigation to /history.

Purpose: Satisfies DRWR-01 (inline request drawer on send page) and DRWR-03 (resend with template selector, already built into RequestDetailDrawer).
Output: Activity chips open drawer inline; request detail drawer with resend+template selector works on send page.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-detail-drawers/22-RESEARCH.md
@components/send/send-page-client.tsx
@components/send/recent-activity-strip.tsx
@components/history/request-detail-drawer.tsx
@app/(dashboard)/send/page.tsx
@lib/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add request detail fetch and create API route or server action</name>
  <files>
    app/(dashboard)/send/page.tsx
    lib/data/send-logs.ts
  </files>
  <action>
    The send page needs to fetch a single request's full details when a chip is clicked. Two approaches:

    **Preferred approach: Pre-fetch recent activity with full details in page.tsx**

    The `getRecentActivity(5)` already fetches recent sends. Check if it returns enough data (it returns `RecentActivity` type which has id, contact_name, contact_email, subject, status, created_at). The `RequestDetailDrawer` needs a `SendLogWithContact` object (includes contact_id, business_id, template_id, error_message, etc.).

    Modify `getRecentActivity` (or create a new `getRecentActivityFull`) in `lib/data/send-logs.ts` to return full `SendLogWithContact` data for the recent 5 sends. This avoids needing a client-side fetch or API route.

    In `lib/data/send-logs.ts`, add:
    ```typescript
    export async function getRecentActivityFull(limit = 5): Promise<SendLogWithContact[]> {
      const supabase = await createClient()
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) return []

      const { data: business } = await supabase
        .from('businesses')
        .select('id')
        .eq('user_id', user.id)
        .single()

      if (!business) return []

      const { data } = await supabase
        .from('send_logs')
        .select('*, contacts(name, email)')
        .eq('business_id', business.id)
        .order('created_at', { ascending: false })
        .limit(limit)

      return (data || []) as SendLogWithContact[]
    }
    ```

    In `app/(dashboard)/send/page.tsx`:
    - Import `getRecentActivityFull` alongside existing `getRecentActivity`
    - Add `getRecentActivityFull(5)` to the parallel Promise.all
    - Pass result as `recentActivityFull` prop to `SendPageClient`
    - Keep existing `getRecentActivity(5)` for the strip display (lighter data)

    Update `SendPageClient` interface to accept `recentActivityFull: SendLogWithContact[]`.
  </action>
  <verify>
    - `pnpm typecheck` passes
    - send page fetches both summary and full activity data
  </verify>
  <done>
    - Full request data for recent 5 sends available in SendPageClient as prop
    - No client-side fetch needed when clicking chip
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire RequestDetailDrawer into send page client</name>
  <files>
    components/send/send-page-client.tsx
  </files>
  <action>
    Modify `send-page-client.tsx` to:

    1. **Add imports:**
       ```typescript
       import { RequestDetailDrawer } from '@/components/history/request-detail-drawer'
       import type { SendLogWithContact } from '@/lib/types/database'
       ```

    2. **Add prop to interface:**
       ```typescript
       recentActivityFull: SendLogWithContact[]
       ```

    3. **Add drawer state:**
       ```typescript
       const [selectedRequest, setSelectedRequest] = useState<SendLogWithContact | null>(null)
       const [requestDrawerOpen, setRequestDrawerOpen] = useState(false)
       ```

    4. **Replace handleActivityClick** (currently `router.push(`/history?open=${id}`)`) with:
       ```typescript
       const handleActivityClick = (id: string) => {
         const request = recentActivityFull.find(r => r.id === id)
         if (request) {
           setSelectedRequest(request)
           setRequestDrawerOpen(true)
         }
       }
       ```

    5. **Add resend handler** (call the existing send API):
       ```typescript
       const handleResend = async (contactId: string, templateId: string | null) => {
         // Use existing send action - import from appropriate location
         // After successful resend, close drawer and refresh
         router.refresh()
         setRequestDrawerOpen(false)
       }
       ```
       Look at how the history page handles resend from its drawer and replicate the same pattern. Check `app/(dashboard)/history/page.tsx` or `history-client.tsx` for the existing resend handler.

    6. **Add cancel handler:**
       ```typescript
       const handleCancel = async (requestId: string) => {
         // Use existing cancel action
         router.refresh()
       }
       ```

    7. **Render RequestDetailDrawer** after the Tabs component:
       ```tsx
       <RequestDetailDrawer
         open={requestDrawerOpen}
         onOpenChange={(open) => {
           setRequestDrawerOpen(open)
           if (!open) setSelectedRequest(null)
         }}
         request={selectedRequest}
         business={business}
         templates={templates}
         onResend={handleResend}
         onCancel={handleCancel}
       />
       ```

    8. **Remove the `useRouter` import** if no longer needed for activity clicks (check if it's still used for anything else). Actually keep it -- it's used for `router.refresh()`.

    **Important:** Do NOT remove the `onItemClick` prop from RecentActivityStrip -- it already wires correctly. The strip calls `onItemClick(item.id)` which now opens the drawer instead of navigating.
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm lint` passes
    - Clicking a recent activity chip opens the request detail drawer (not navigate to /history)
    - Drawer shows request details, status badge, email preview, and resend section with template dropdown
    - Closing drawer returns to send page without navigation
  </verify>
  <done>
    - Recent activity chips open request drawer inline on send page
    - Request drawer includes resend with template selector (inherited from existing component)
    - No navigation away from send page
    - Drawer state resets on close
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm lint` passes
- On send page: click a recent activity chip -> drawer slides in from right showing request details
- Drawer has resend option with template dropdown
- Close drawer -> back on send page, no navigation occurred
- "View All" link on activity strip still navigates to /history (unchanged)
</verification>

<success_criteria>
- DRWR-01: Activity chip click opens request drawer inline on send page
- DRWR-03: Request drawer has resend option with template selector dropdown
- No regression: send page tabs, stat strip, quick send, bulk send all still work
</success_criteria>

<output>
After completion, create `.planning/phases/22-detail-drawers/22-02-SUMMARY.md`
</output>
