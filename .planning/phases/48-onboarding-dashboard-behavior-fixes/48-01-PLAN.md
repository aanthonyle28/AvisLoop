---
phase: 48
plan: 01
title: "Getting Started trigger, KPI links, dismiss verify, campaign selector"
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/campaigns/page.tsx
  - app/(dashboard)/campaigns/[id]/page.tsx
  - components/dashboard/kpi-widgets.tsx
  - components/dashboard/attention-alerts.tsx
  - components/jobs/campaign-selector.tsx
autonomous: true
---

## Objective

Fix 5 behavioral issues: (1) Getting Started step 2 triggers on campaign *detail* page visit — not list page, (2) all KPI stat cards navigate to `/analytics`, (3) verify the Needs Attention dismiss actually works, and (4) add "Create new campaign" option to the CampaignSelector dropdown in Add Job.

## Context

@app/(dashboard)/campaigns/page.tsx — currently calls `markCampaignReviewed()` here (REMOVE)
@app/(dashboard)/campaigns/[id]/page.tsx — add `markCampaignReviewed()` to the Promise.all
@lib/actions/checklist.ts — `markCampaignReviewed()` is the server action (no changes needed)
@components/dashboard/kpi-widgets.tsx — 3 KPI cards with Link hrefs that need changing
@components/dashboard/attention-alerts.tsx — dismiss wiring to verify
@components/jobs/campaign-selector.tsx — add "Create new campaign" option

## Tasks

<task id="1">
### Move markCampaignReviewed from campaigns list page to detail page (GS-01, GS-02)

**File: `app/(dashboard)/campaigns/page.tsx`**
1. Remove the import: `import { markCampaignReviewed } from '@/lib/actions/checklist'`
2. Remove the call: `await markCampaignReviewed()` and its comment block (lines 16-18)
3. No other changes to this file

**File: `app/(dashboard)/campaigns/[id]/page.tsx`**
1. Add import at the top: `import { markCampaignReviewed } from '@/lib/actions/checklist'`
2. Add `markCampaignReviewed()` to the existing `Promise.all` call. The Promise.all currently destructures 6 values. Add `markCampaignReviewed()` as a 7th item. Since we don't need its return value, just add it to the array without adding a 7th destructured variable.

The corrected Promise.all should look like:
```typescript
const [campaign, enrollmentsResult, counts, analytics, templates, business] = await Promise.all([
  getCampaign(id),
  getCampaignEnrollments(id, { limit: pageSize, offset }),
  getCampaignEnrollmentCounts(id),
  getCampaignAnalytics(id),
  getAvailableTemplates(),
  getBusiness(),
  markCampaignReviewed(),
])
```

**Why this works for GS-02:** `markCampaignReviewed()` does NOT check whether the campaign ID in the URL is valid — it simply sets the `campaign_reviewed` JSONB flag. So even if the onboarding-created campaign is deleted, visiting any other campaign detail page will trigger the flag. The existing `if (current.campaign_reviewed === true) return` short-circuit prevents unnecessary writes.
</task>

<task id="2">
### Unify KPI card navigation to /analytics (DASH-02)

**File: `components/dashboard/kpi-widgets.tsx`**

Change all three KPI card Link hrefs to `/analytics`:

1. Line 57: Change `<Link href="/history?status=reviewed"` to `<Link href="/analytics"`
2. Line 78: Change `<Link href="/feedback"` to `<Link href="/analytics"`
3. Line 99: Change `<Link href="/history"` to `<Link href="/analytics"`

Three surgical string replacements, nothing else in the file changes.
</task>

<task id="3">
### Verify Needs Attention dismiss works + Add "Create new campaign" to CampaignSelector (DASH-01, JOB-01)

**DASH-01 — Verify dismiss:**
**File: `components/dashboard/attention-alerts.tsx`**

The dismiss pipeline is already correctly wired:
- `AttentionAlerts` component has `dismissedIds` state (line 194)
- `visibleAlerts` filters out dismissed IDs (line 196)
- `handleDismiss` adds ID to set (lines 200-202)
- `AlertRow` receives `onDismiss={handleDismiss}` (line 230)
- X button on desktop calls `onDismiss?.(alert.id)` with `e.stopPropagation()` (line 147)
- Mobile overflow menu has "Dismiss" item calling `onDismiss?.(alert.id)` (line 181)

**Action:** This is a verify-only task. The code is correct. No changes needed unless typecheck or lint reveals an issue. If the dismiss is broken at runtime (e.g., React state not triggering re-render), that would be a React bug — but the code is structurally correct.

**JOB-01 — Add "Create new campaign" to CampaignSelector:**
**File: `components/jobs/campaign-selector.tsx`**

1. Add import: `import { useRouter } from 'next/navigation'`
2. Add a constant for the sentinel value: `export const CAMPAIGN_CREATE = '__create_campaign__'`
3. Inside the `CampaignSelector` component, add: `const router = useRouter()`
4. Add a "Create new campaign" option to the `options` array — insert it AFTER the campaign options but BEFORE the one-off and do-not-send options:
   ```typescript
   // After the campaign options loop, before showOneOff:
   options.push({ value: CAMPAIGN_CREATE, label: '+ Create new campaign' })
   ```
5. Modify the `onChange` handler to intercept the sentinel value. Change:
   ```typescript
   onChange={(e) => onCampaignChange(e.target.value || null)}
   ```
   To:
   ```typescript
   onChange={(e) => {
     const val = e.target.value
     if (val === CAMPAIGN_CREATE) {
       router.push('/campaigns')
       return
     }
     onCampaignChange(val || null)
   }}
   ```

This navigates to `/campaigns` when "Create new campaign" is selected. The campaigns page has a "New Campaign" button for creation. The select will unmount during navigation so no stale state issue.
</task>

## Verification

```bash
pnpm lint && pnpm typecheck
```

### must_haves
- [ ] `markCampaignReviewed()` is NOT called in `app/(dashboard)/campaigns/page.tsx`
- [ ] `markCampaignReviewed()` IS called inside the Promise.all in `app/(dashboard)/campaigns/[id]/page.tsx`
- [ ] All 3 KPI card Link hrefs in `kpi-widgets.tsx` point to `/analytics` (no `/history`, `/feedback`)
- [ ] `attention-alerts.tsx` dismiss pipeline is intact: `dismissedIds` state, `visibleAlerts` filter, `handleDismiss` passed to `AlertRow`
- [ ] `campaign-selector.tsx` has a "Create new campaign" option that calls `router.push('/campaigns')` instead of updating campaign selection
- [ ] `pnpm lint` passes
- [ ] `pnpm typecheck` passes
