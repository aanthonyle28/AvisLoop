---
phase: 44-onboarding-services
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/types/database.ts
  - lib/types/onboarding.ts
  - lib/validations/onboarding.ts
  - lib/actions/onboarding.ts
  - lib/data/onboarding.ts
  - components/onboarding/steps/crm-platform-step.tsx
  - components/onboarding/onboarding-wizard.tsx
  - components/onboarding/onboarding-steps.tsx
  - app/onboarding/page.tsx
  - components/onboarding/steps/software-used-step.tsx
autonomous: true

must_haves:
  truths:
    - "Onboarding wizard has 4 steps: Business Setup, Campaign Preset, CRM Platform, SMS Consent"
    - "CRM Platform step shows square logo cards for Jobber, Housecall Pro, ServiceTitan, GorillaDesk, FieldPulse, None, and Other"
    - "Selecting 'Other' on the CRM step reveals a text input for custom CRM name"
    - "CRM Platform step is skippable (has 'Skip for now' link)"
    - "CRM Platform step is second-to-last (step 3), SMS Consent is last (step 4)"
    - "Selected CRM platform is saved to the software_used column on the businesses table"
    - "SMS Consent step still triggers onComplete (wizard completion), not the CRM step"
  artifacts:
    - path: "components/onboarding/steps/crm-platform-step.tsx"
      provides: "CRM platform selection step with logo cards"
      contains: "CRMPlatformStep"
    - path: "components/onboarding/onboarding-wizard.tsx"
      provides: "4-step wizard configuration"
      contains: "CRM Platform"
    - path: "components/onboarding/onboarding-steps.tsx"
      provides: "Step routing with case 3 for CRM, case 4 for SMS"
      contains: "CRMPlatformStep"
  key_links:
    - from: "components/onboarding/steps/crm-platform-step.tsx"
      to: "lib/actions/onboarding.ts"
      via: "saveSoftwareUsed server action"
      pattern: "saveSoftwareUsed"
    - from: "components/onboarding/onboarding-steps.tsx"
      to: "components/onboarding/steps/crm-platform-step.tsx"
      via: "case 3 in switch"
      pattern: "case 3:"
    - from: "components/onboarding/onboarding-steps.tsx"
      to: "components/onboarding/steps/sms-consent-step.tsx"
      via: "case 4 in switch (was case 3)"
      pattern: "case 4:"
---

<objective>
Add a CRM platform selection step to the onboarding wizard with square logo-style cards. The step lets users pick their field service management software (Jobber, Housecall Pro, ServiceTitan, GorillaDesk, FieldPulse, None, Other) and saves the selection to the `software_used` column. The step is skippable and positioned second-to-last (before SMS Consent).

Purpose: Captures CRM platform data for future integration planning (v2.1 roadmap). The old `software-used-step.tsx` file (dead code, never rendered in the current 3-step wizard) is replaced by a new visually-rich CRM card step.

Output: 4-step onboarding wizard where step 3 is the new CRM Platform step with square cards, and step 4 is SMS Consent (unchanged behavior, just renumbered). Dead `software-used-step.tsx` is deleted.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key source files:
@components/onboarding/onboarding-wizard.tsx — Wizard shell (STEPS array, step navigation)
@components/onboarding/onboarding-steps.tsx — Step switch router
@components/onboarding/steps/business-setup-step.tsx — Reference for step component pattern
@components/onboarding/steps/campaign-preset-step.tsx — Reference for card selection pattern (radiogroup, selected state: border-primary ring-2 ring-primary bg-primary/5)
@components/onboarding/steps/sms-consent-step.tsx — Final step that calls onComplete
@components/onboarding/steps/software-used-step.tsx — Dead code to delete (replaced by new CRM step)
@lib/types/onboarding.ts — OnboardingBusiness type
@lib/validations/onboarding.ts — SOFTWARE_OPTIONS, softwareUsedSchema
@lib/actions/onboarding.ts — saveSoftwareUsed action
@lib/data/onboarding.ts — getOnboardingStatus query
@app/onboarding/page.tsx — Server component, step clamp, business mapping
@lib/types/database.ts — Business interface (already has software_used: string | null)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update wizard infrastructure for 4 steps and create CRM platform step</name>
  <files>
    components/onboarding/onboarding-wizard.tsx
    components/onboarding/onboarding-steps.tsx
    app/onboarding/page.tsx
    lib/validations/onboarding.ts
    components/onboarding/steps/crm-platform-step.tsx
  </files>
  <action>
    **1. Update `components/onboarding/onboarding-wizard.tsx`:**

    Change the `STEPS` array from 3 to 4 entries:
    ```tsx
    const STEPS: StepConfig[] = [
      { id: 1, title: 'Business Setup', skippable: false },
      { id: 2, title: 'Campaign Preset', skippable: false },
      { id: 3, title: 'CRM Platform', skippable: true },
      { id: 4, title: 'SMS Consent', skippable: false },
    ]
    ```

    **2. Update `components/onboarding/onboarding-steps.tsx`:**

    Add import for the new step component:
    ```tsx
    import { CRMPlatformStep } from './steps/crm-platform-step'
    ```

    Update the switch statement:
    - Case 1 (Business Setup): unchanged
    - Case 2 (Campaign Preset): unchanged
    - Case 3 (NEW — CRM Platform):
      ```tsx
      case 3:
        return (
          <CRMPlatformStep
            onComplete={onGoToNext}
            onGoBack={onGoBack}
            defaultValue={business?.software_used || null}
          />
        )
      ```
    - Case 4 (SMS Consent — was case 3):
      ```tsx
      case 4:
        return (
          <SMSConsentStep
            onComplete={onComplete}
            onGoBack={onGoBack}
            isSubmitting={isSubmitting}
          />
        )
      ```

    CRITICAL: SMS Consent step must receive `onComplete` (the wizard completion handler), NOT `onGoToNext`. The CRM step receives `onGoToNext` (advances to step 4).

    **3. Update `app/onboarding/page.tsx`:**

    Change the step clamp from 3 to 4:
    ```tsx
    const currentStep = Math.min(Math.max(1, stepParam), 4)
    ```

    Update the JSDoc comment to mention 4-step flow:
    ```
    * Step 1: Business Setup (basics + services)
    * Step 2: Campaign Preset (required)
    * Step 3: CRM Platform (skippable)
    * Step 4: SMS Consent (required)
    ```

    **4. Update `lib/validations/onboarding.ts`:**

    Replace `SOFTWARE_OPTIONS` with expanded `CRM_PLATFORMS` constant:
    ```tsx
    export const CRM_PLATFORMS = [
      { value: 'jobber', label: 'Jobber', color: 'bg-emerald-500' },
      { value: 'housecall_pro', label: 'Housecall Pro', color: 'bg-blue-500' },
      { value: 'servicetitan', label: 'ServiceTitan', color: 'bg-red-500' },
      { value: 'gorilladesk', label: 'GorillaDesk', color: 'bg-orange-500' },
      { value: 'fieldpulse', label: 'FieldPulse', color: 'bg-violet-500' },
    ] as const

    export const CRM_SPECIAL_OPTIONS = [
      { value: 'none', label: 'None' },
      { value: 'other', label: 'Other' },
    ] as const
    ```

    Keep `SOFTWARE_OPTIONS` export for backward compatibility (the `saveSoftwareUsed` action uses `softwareUsedSchema` which already accepts any string, so no schema change needed there).

    **5. Create `components/onboarding/steps/crm-platform-step.tsx`:**

    New step component using square logo cards in a responsive grid.

    Props:
    ```tsx
    interface CRMPlatformStepProps {
      onComplete: () => void
      onGoBack: () => void
      defaultValue?: string | null
    }
    ```

    UI structure:
    - Heading: "What software do you use to manage jobs?"
    - Subtitle: "This helps us plan integrations. Skip if you're unsure."
    - Info banner (matches `software-used-step.tsx` pattern): `bg-info-bg border border-info-border` with `Info` icon from Phosphor — "This is for our roadmap planning only. No integration will be set up now."
    - Grid of CRM cards: `grid grid-cols-2 sm:grid-cols-3 gap-3`
      - Each CRM platform card is a square-ish button with:
        - A colored circle with 2-letter abbreviation (initials of the platform name): `w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold text-sm` with the platform's `color` class
        - Platform name below the circle
        - Selected state: `border-primary ring-2 ring-primary bg-primary/5` (matching `CampaignPresetStep` pattern)
        - Unselected state: `border-border hover:border-primary/50`
      - "None" card: uses a gray circle with a dash icon
      - "Other" card: uses a gray circle with "?" text
    - When "Other" is selected, show a text input below the grid: `<Input placeholder="e.g. Workiz, Kickserv..." />`
    - Button row: Back (outline, flex-1) + Continue (default, flex-1), both h-12 text-base
    - "Skip for now" link below buttons (same pattern as old `software-used-step.tsx`)

    Behavior:
    - Single selection (radio-style, not multi-select)
    - `useState` for selected value and custom text
    - On Continue: call `saveSoftwareUsed({ softwareUsed: selected === 'other' ? customText : selected })` then `onComplete()`
    - On Skip: just call `onComplete()` without saving
    - Use `useTransition` for the save action

    Abbreviation mapping for the colored circles:
    - Jobber: "JB" (emerald)
    - Housecall Pro: "HC" (blue)
    - ServiceTitan: "ST" (red)
    - GorillaDesk: "GD" (orange)
    - FieldPulse: "FP" (violet)
    - None: minus icon from Phosphor (`Minus`)
    - Other: "?" text (gray)

    Import icons from `@phosphor-icons/react`: `Info`, `Minus`
  </action>
  <verify>
    1. `pnpm typecheck` passes
    2. `pnpm lint` passes
    3. `crm-platform-step.tsx` exists and exports `CRMPlatformStep`
    4. `onboarding-wizard.tsx` STEPS array has 4 entries
    5. `onboarding-steps.tsx` has cases 1-4, with case 4 passing `onComplete`
    6. `app/onboarding/page.tsx` clamps step to max 4
  </verify>
  <done>Onboarding wizard has 4 steps. Step 3 shows CRM platform cards with square logo-style UI. Step 4 is SMS Consent (still triggers wizard completion). CRM step is skippable.</done>
</task>

<task type="auto">
  <name>Task 2: Delete dead software-used-step.tsx file</name>
  <files>
    components/onboarding/steps/software-used-step.tsx
  </files>
  <action>
    Delete `components/onboarding/steps/software-used-step.tsx`. This file is dead code — it was the old Step 4 from the 7-step wizard that was never wired into the current 3-step wizard. The new `crm-platform-step.tsx` replaces it entirely.

    Verify no other file imports `SoftwareUsedStep` or `software-used-step`:
    - Grep the entire codebase for `software-used-step` and `SoftwareUsedStep`
    - If any imports exist (unlikely), remove them
    - The `saveSoftwareUsed` action in `lib/actions/onboarding.ts` is KEPT because the new CRM step calls it
    - The `SOFTWARE_OPTIONS` export in `lib/validations/onboarding.ts` is KEPT for backward compatibility
  </action>
  <verify>
    1. `components/onboarding/steps/software-used-step.tsx` does NOT exist
    2. Grep for `SoftwareUsedStep` returns zero results
    3. Grep for `software-used-step` returns zero results
    4. `pnpm typecheck` passes
    5. `pnpm lint` passes
  </verify>
  <done>Dead `software-used-step.tsx` removed. No broken imports. Code consolidated — CRM platform step is the single CRM selection UI.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` — all TypeScript types resolve
2. `pnpm lint` — no lint errors
3. Onboarding wizard STEPS array has exactly 4 entries
4. Step switch in onboarding-steps.tsx has cases 1-4
5. Case 3 renders CRMPlatformStep with `onComplete={onGoToNext}`
6. Case 4 renders SMSConsentStep with `onComplete={onComplete}` (wizard completion)
7. Page clamp is `Math.min(Math.max(1, stepParam), 4)`
8. `software-used-step.tsx` is deleted
9. No dead imports of `SoftwareUsedStep` anywhere
</verification>

<success_criteria>
- 4-step onboarding wizard renders correctly
- CRM Platform step (step 3) shows square cards for 7 options (5 platforms + None + Other)
- "Other" selection reveals text input
- CRM step is skippable (skip link present)
- SMS Consent remains the final step and triggers wizard completion
- Selected CRM platform saves to database via saveSoftwareUsed
- Dead software-used-step.tsx is deleted
- `pnpm typecheck` and `pnpm lint` both pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/44-onboarding-services/44-01-SUMMARY.md`
</output>
