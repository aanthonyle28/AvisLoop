---
phase: 21-email-preview-template-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/send/message-preview.tsx
  - components/send/email-preview-modal.tsx
  - components/send/quick-send-tab.tsx
autonomous: true

must_haves:
  truths:
    - "Below the compose area, a compact preview (80-140px) shows subject (1 line), body snippet (2-3 lines clamped), and a 'View full email' link -- always visible, no expand/collapse toggle"
    - "Clicking 'View full email' opens a read-only modal with subject, resolved body, review CTA button, footer text, and From/To header"
    - "When no contact is selected, compact preview shows placeholder text with template defaults"
    - "Template variables (CUSTOMER_NAME, BUSINESS_NAME, SENDER_NAME) are resolved in both compact and full preview"
  artifacts:
    - path: "components/send/message-preview.tsx"
      provides: "Compact preview snippet (80-140px) with subject, clamped body, and 'View full email' link"
      contains: "line-clamp-3"
    - path: "components/send/email-preview-modal.tsx"
      provides: "Full email preview dialog with From/To, subject, resolved body, CTA button, footer"
      exports: ["EmailPreviewModal"]
    - path: "components/send/quick-send-tab.tsx"
      provides: "Wires compact preview and modal together with shared state"
      contains: "EmailPreviewModal"
  key_links:
    - from: "components/send/message-preview.tsx"
      to: "components/send/email-preview-modal.tsx"
      via: "onViewFull callback triggers modal open"
      pattern: "onViewFull|setShowFullPreview"
    - from: "components/send/quick-send-tab.tsx"
      to: "components/send/email-preview-modal.tsx"
      via: "renders EmailPreviewModal with open state"
      pattern: "EmailPreviewModal"
---

<objective>
Refactor the email preview into a compact always-visible snippet and add a full email preview modal.

Purpose: Users need confidence about what will be sent before clicking Send. The compact snippet shows key info at a glance; the full modal lets them inspect the exact email with resolved variables, CTA button, and footer.

Output: Refactored MessagePreview (compact snippet), new EmailPreviewModal component, updated QuickSendTab wiring.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-email-preview-template-selection/21-RESEARCH.md
@components/send/message-preview.tsx
@components/send/quick-send-tab.tsx
@components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor MessagePreview into compact snippet + create EmailPreviewModal</name>
  <files>
    components/send/message-preview.tsx
    components/send/email-preview-modal.tsx
  </files>
  <action>
**Refactor `message-preview.tsx`** to be a compact, always-visible snippet (no expand/collapse toggle):

1. Remove the `useState(false)` for `isExpanded` and the `compact` prop logic
2. Remove the "Show full preview" / "Collapse preview" toggle buttons
3. Remove the expanded view (CTA button, footer, collapse button)
4. Replace with a flat snippet layout (~80-140px height):
   - "Email Preview" label in `text-xs text-muted-foreground`
   - Subject line: `font-semibold text-sm truncate` (single line, truncated)
   - Body snippet: `text-sm text-muted-foreground line-clamp-3` (2-3 lines clamped with CSS)
   - "View full email" link: `text-sm text-primary hover:underline` button that calls `onViewFull()` callback prop
5. Keep the no-contact placeholder state ("Enter an email to preview the message")
6. Use a helper function `resolveTemplate(text, contact, business)` that replaces `{{CUSTOMER_NAME}}`, `{{BUSINESS_NAME}}`, `{{SENDER_NAME}}` with actual values — apply to both subject and body
7. Update the interface: remove `compact` prop, add `onViewFull?: () => void` callback prop
8. Container: `rounded-lg border bg-card p-4` (no email-like card styling, just a simple snippet)

**Create `email-preview-modal.tsx`** as a new component:

1. Import Dialog, DialogContent, DialogHeader, DialogTitle from `@/components/ui/dialog`
2. Props: `open: boolean`, `onOpenChange: (open: boolean) => void`, `contact: Contact | null`, `business: Business`, `template: EmailTemplate | null`
3. Use the same `resolveTemplate` helper for variable replacement (extract to a shared function or inline)
4. Modal content layout:
   - DialogTitle: "Email Preview"
   - From/To header: small text showing `From: {senderName}` and `To: {contact.email}`
   - Subject: `font-semibold text-lg`
   - Email body section with `bg-muted/30 p-6 rounded-lg` wrapper and inner `bg-card p-6 rounded shadow-sm max-w-lg mx-auto`:
     - Greeting: "Hi {contact.name},"
     - Resolved body text with `whitespace-pre-wrap`
     - CTA button: styled as `inline-block bg-primary text-primary-foreground px-6 py-3 rounded-md font-medium` (non-clickable, just visual)
     - Divider `hr`
     - Footer: "Thanks so much, {senderName}"
5. When contact is null, show "Select a contact to see the full preview" message inside the modal
6. DialogContent class: `sm:max-w-2xl` for wider modal
  </action>
  <verify>
- `pnpm typecheck` passes with no errors
- `pnpm lint` passes
- MessagePreview no longer has expand/collapse logic
- EmailPreviewModal exports correctly and uses Dialog from ui/dialog
  </verify>
  <done>
- MessagePreview renders as compact snippet with subject (1 line), body (2-3 lines clamped), and "View full email" link
- EmailPreviewModal opens a read-only dialog with From/To, subject, resolved body, CTA button, and footer
- Template variables are resolved in both components
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire compact preview and modal into QuickSendTab</name>
  <files>
    components/send/quick-send-tab.tsx
  </files>
  <action>
1. Add `import { EmailPreviewModal } from './email-preview-modal'`
2. Add state: `const [showFullPreview, setShowFullPreview] = useState(false)`
3. Update the MessagePreview usage:
   - Remove `compact={true}` prop
   - Add `onViewFull={() => setShowFullPreview(true)}` prop
4. Add EmailPreviewModal after the form closing tag (or inside the form, after send button):
   ```tsx
   <EmailPreviewModal
     open={showFullPreview}
     onOpenChange={setShowFullPreview}
     contact={previewContact}
     business={business}
     template={selectedTemplate}
   />
   ```
5. Ensure the preview section label stays as "Preview" (uppercase tracking-wider style)
  </action>
  <verify>
- `pnpm typecheck` passes
- `pnpm lint` passes
- QuickSendTab imports and renders both MessagePreview and EmailPreviewModal
- showFullPreview state connects the "View full email" link to the modal
  </verify>
  <done>
- Clicking "View full email" in the compact preview opens the EmailPreviewModal
- Modal shows the complete rendered email with resolved variables
- Closing the modal returns to the send page with compact preview still visible
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` — zero errors
2. `pnpm lint` — zero errors or warnings
3. Manual: Navigate to send page, select a contact, verify compact preview shows subject + body snippet + "View full email" link
4. Manual: Click "View full email", verify modal opens with From/To header, subject, resolved body, CTA button, footer
5. Manual: Close modal, verify compact preview remains visible
6. Manual: Without selecting a contact, verify placeholder "Enter an email to preview the message" shows
</verification>

<success_criteria>
- Compact preview is always visible below the compose area (no toggle/expand required)
- Full preview modal displays complete email with all variables resolved
- Both views use consistent variable replacement logic
- No regressions in send flow functionality
</success_criteria>

<output>
After completion, create `.planning/phases/21-email-preview-template-selection/21-01-SUMMARY.md`
</output>
