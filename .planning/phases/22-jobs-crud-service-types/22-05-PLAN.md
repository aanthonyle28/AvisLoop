---
phase: 22-jobs-crud-service-types
plan: 05
type: execute
wave: 3
depends_on: ["22-01", "22-02", "22-03"]
files_modified:
  - app/(dashboard)/settings/page.tsx
  - components/settings/service-types-section.tsx
  - lib/actions/business.ts
autonomous: true

must_haves:
  truths:
    - "User can select which service types their business offers"
    - "User can configure timing defaults per service type"
    - "Service type settings saved to business record"
  artifacts:
    - path: "components/settings/service-types-section.tsx"
      provides: "Service types configuration UI"
      contains: "ServiceTypesSection"
    - path: "lib/actions/business.ts"
      provides: "Server action for updating service type settings"
      exports: ["updateServiceTypeSettings"]
  key_links:
    - from: "components/settings/service-types-section.tsx"
      to: "lib/actions/business.ts"
      via: "updateServiceTypeSettings import"
      pattern: "import.*updateServiceTypeSettings.*from.*actions/business"
---

<objective>
Add service type settings to business settings page for selecting enabled services and configuring timing defaults.

Purpose: Businesses need to configure which services they offer (used for job creation filtering) and customize the default timing for campaign first touches per service type.

Output: Service types section in settings with multi-select for enabled types and timing inputs.
</objective>

<execution_context>
@C:\Users\aanth\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aanth\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-jobs-crud-service-types/22-RESEARCH.md
@app/(dashboard)/settings/page.tsx
@lib/actions/business.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add updateServiceTypeSettings action to business.ts</name>
  <files>lib/actions/business.ts</files>
  <action>
Add new server action to lib/actions/business.ts for updating service type settings:

```typescript
/**
 * Update business service type settings.
 * Sets which service types are enabled and timing defaults.
 */
export async function updateServiceTypeSettings(settings: {
  serviceTypesEnabled: string[]
  serviceTypeTiming: Record<string, number>
}): Promise<{ error?: string; success?: boolean }> {
  const supabase = await createClient()

  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    return { error: 'You must be logged in' }
  }

  // Validate service types
  const validTypes = ['hvac', 'plumbing', 'electrical', 'cleaning', 'roofing', 'painting', 'handyman', 'other']
  const filteredEnabled = settings.serviceTypesEnabled.filter(t => validTypes.includes(t))

  // Validate timing values (must be positive numbers)
  const validatedTiming: Record<string, number> = {}
  for (const [type, hours] of Object.entries(settings.serviceTypeTiming)) {
    if (validTypes.includes(type) && typeof hours === 'number' && hours > 0 && hours <= 168) {
      validatedTiming[type] = hours
    }
  }

  // Merge with defaults to ensure all types have values
  const defaultTiming = {
    hvac: 24, plumbing: 48, electrical: 24, cleaning: 4,
    roofing: 72, painting: 48, handyman: 24, other: 24
  }
  const finalTiming = { ...defaultTiming, ...validatedTiming }

  const { error } = await supabase
    .from('businesses')
    .update({
      service_types_enabled: filteredEnabled,
      service_type_timing: finalTiming,
    })
    .eq('user_id', user.id)

  if (error) {
    return { error: error.message }
  }

  revalidatePath('/settings')
  revalidatePath('/jobs')
  return { success: true }
}
```

Also add a getter function:

```typescript
/**
 * Get business service type settings.
 */
export async function getServiceTypeSettings(): Promise<{
  serviceTypesEnabled: string[]
  serviceTypeTiming: Record<string, number>
} | null> {
  const supabase = await createClient()

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return null

  const { data: business } = await supabase
    .from('businesses')
    .select('service_types_enabled, service_type_timing')
    .eq('user_id', user.id)
    .single()

  if (!business) return null

  return {
    serviceTypesEnabled: business.service_types_enabled || [],
    serviceTypeTiming: business.service_type_timing || {
      hvac: 24, plumbing: 48, electrical: 24, cleaning: 4,
      roofing: 72, painting: 48, handyman: 24, other: 24
    },
  }
}
```

Add the necessary imports if not present (revalidatePath from next/cache).
  </action>
  <verify>TypeScript compiles. Functions export correctly.</verify>
  <done>lib/actions/business.ts exports updateServiceTypeSettings and getServiceTypeSettings.</done>
</task>

<task type="auto">
  <name>Task 2: Create service types settings section component</name>
  <files>components/settings/service-types-section.tsx</files>
  <action>
Create components/settings/service-types-section.tsx:

```typescript
'use client'

import { useState, useTransition } from 'react'
import { toast } from 'sonner'
import { Check, Clock } from '@phosphor-icons/react'
import { Loader2 } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { updateServiceTypeSettings } from '@/lib/actions/business'
import { SERVICE_TYPES, SERVICE_TYPE_LABELS, DEFAULT_TIMING_HOURS } from '@/lib/validations/job'

interface ServiceTypesSectionProps {
  initialEnabled: string[]
  initialTiming: Record<string, number>
}

export function ServiceTypesSection({
  initialEnabled,
  initialTiming,
}: ServiceTypesSectionProps) {
  const [enabled, setEnabled] = useState<Set<string>>(new Set(initialEnabled))
  const [timing, setTiming] = useState<Record<string, number>>(initialTiming)
  const [isPending, startTransition] = useTransition()
  const [hasChanges, setHasChanges] = useState(false)

  const toggleService = (type: string) => {
    const newEnabled = new Set(enabled)
    if (newEnabled.has(type)) {
      newEnabled.delete(type)
    } else {
      newEnabled.add(type)
    }
    setEnabled(newEnabled)
    setHasChanges(true)
  }

  const updateTiming = (type: string, hours: number) => {
    setTiming(prev => ({ ...prev, [type]: hours }))
    setHasChanges(true)
  }

  const handleSave = () => {
    startTransition(async () => {
      const result = await updateServiceTypeSettings({
        serviceTypesEnabled: Array.from(enabled),
        serviceTypeTiming: timing,
      })

      if (result.error) {
        toast.error(result.error)
      } else {
        toast.success('Service type settings saved')
        setHasChanges(false)
      }
    })
  }

  const handleReset = () => {
    setEnabled(new Set(initialEnabled))
    setTiming(initialTiming)
    setHasChanges(false)
  }

  return (
    <div className="rounded-lg border border-border bg-card p-6">
      <div className="mb-4">
        <h3 className="text-lg font-medium">Service Types</h3>
        <p className="text-sm text-muted-foreground">
          Select the services your business offers. Timing controls when the first campaign message is sent after job completion.
        </p>
      </div>

      <div className="space-y-4">
        {/* Service type grid */}
        <div className="grid gap-3 sm:grid-cols-2">
          {SERVICE_TYPES.map(type => {
            const isEnabled = enabled.has(type)
            const hours = timing[type] || DEFAULT_TIMING_HOURS[type]

            return (
              <div
                key={type}
                className={`rounded-lg border p-4 transition-colors ${
                  isEnabled
                    ? 'border-primary bg-primary/5'
                    : 'border-border bg-background'
                }`}
              >
                {/* Service toggle */}
                <button
                  type="button"
                  onClick={() => toggleService(type)}
                  className="flex w-full items-center justify-between"
                >
                  <span className="font-medium">{SERVICE_TYPE_LABELS[type]}</span>
                  <div
                    className={`flex h-5 w-5 items-center justify-center rounded ${
                      isEnabled
                        ? 'bg-primary text-primary-foreground'
                        : 'border border-input bg-background'
                    }`}
                  >
                    {isEnabled && <Check className="h-3 w-3" weight="bold" />}
                  </div>
                </button>

                {/* Timing input (shown when enabled) */}
                {isEnabled && (
                  <div className="mt-3 flex items-center gap-2">
                    <Clock className="h-4 w-4 text-muted-foreground" />
                    <Label className="sr-only">Hours until first message</Label>
                    <Input
                      type="number"
                      min={1}
                      max={168}
                      value={hours}
                      onChange={(e) => updateTiming(type, parseInt(e.target.value) || 24)}
                      className="h-8 w-20"
                    />
                    <span className="text-sm text-muted-foreground">
                      hours after completion
                    </span>
                  </div>
                )}
              </div>
            )
          })}
        </div>

        {/* Actions */}
        {hasChanges && (
          <div className="flex items-center justify-end gap-2 pt-2">
            <Button variant="outline" onClick={handleReset} disabled={isPending}>
              Reset
            </Button>
            <Button onClick={handleSave} disabled={isPending}>
              {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Save Changes
            </Button>
          </div>
        )}

        {/* Help text */}
        <div className="rounded-md bg-muted p-3 text-sm text-muted-foreground">
          <p>
            <strong>Tip:</strong> Select at least one service type to enable job creation filtering.
            Timing defaults are applied when creating campaigns for specific service types.
          </p>
        </div>
      </div>
    </div>
  )
}
```

Features:
- Toggle cards for each service type
- Timing input appears when service is enabled
- Visual feedback for selected services
- Save/Reset buttons appear when changes made
- Validation (1-168 hours)
  </action>
  <verify>Component renders with toggles and timing inputs. Changes are saveable.</verify>
  <done>ServiceTypesSection component with service toggle cards, timing inputs, and save functionality.</done>
</task>

<task type="auto">
  <name>Task 3: Add service types section to settings page</name>
  <files>app/(dashboard)/settings/page.tsx</files>
  <action>
Update app/(dashboard)/settings/page.tsx to include the ServiceTypesSection:

1. Import the new component and data fetcher:
```typescript
import { ServiceTypesSection } from '@/components/settings/service-types-section'
import { getServiceTypeSettings } from '@/lib/actions/business'
```

2. In the server component, fetch service type settings:
```typescript
// Add to existing data fetching (or create if needed)
const serviceTypeSettings = await getServiceTypeSettings()
```

3. Add the section to the page layout (place after existing sections like Business Settings, Email Templates, etc.):
```typescript
{/* Service Types */}
<ServiceTypesSection
  initialEnabled={serviceTypeSettings?.serviceTypesEnabled || []}
  initialTiming={serviceTypeSettings?.serviceTypeTiming || {
    hvac: 24, plumbing: 48, electrical: 24, cleaning: 4,
    roofing: 72, painting: 48, handyman: 24, other: 24
  }}
/>
```

Ensure the section is placed logically - after business profile, before integrations or danger zone sections.
  </action>
  <verify>Navigate to /settings - Service Types section visible with toggle cards and timing inputs.</verify>
  <done>Settings page includes ServiceTypesSection with fetched initial data.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Navigate to /settings
2. Service Types section visible
3. Click toggle to enable/disable service types
4. Timing input appears for enabled types
5. Change values and Save - toast shows success
6. Refresh page - values persist
7. `pnpm lint` and `pnpm typecheck` pass
</verification>

<success_criteria>
- ServiceTypesSection component renders in settings page
- Toggle cards enable/disable service types
- Timing inputs accept hours (1-168)
- Save button only appears when changes made
- Changes persist after page refresh
- Toast notifications on save
- `pnpm typecheck` passes
</success_criteria>

<output>
After completion, create `.planning/phases/22-jobs-crud-service-types/22-05-SUMMARY.md`
</output>
