---
phase: 22-jobs-crud-service-types
plan: 04
type: execute
wave: 2
depends_on: ["22-01", "22-02"]
files_modified:
  - components/jobs/add-job-sheet.tsx
  - components/jobs/edit-job-sheet.tsx
  - components/jobs/customer-selector.tsx
  - components/jobs/service-type-select.tsx
autonomous: true

must_haves:
  truths:
    - "User can create job with customer selector dropdown"
    - "User can select service type from 8 options"
    - "User can edit job details"
    - "Customer selector searches by name and email"
  artifacts:
    - path: "components/jobs/add-job-sheet.tsx"
      provides: "Add job form in Sheet"
      contains: "AddJobSheet"
    - path: "components/jobs/edit-job-sheet.tsx"
      provides: "Edit job form in Sheet"
      contains: "EditJobSheet"
    - path: "components/jobs/customer-selector.tsx"
      provides: "Searchable customer dropdown"
      contains: "CustomerSelector"
    - path: "components/jobs/service-type-select.tsx"
      provides: "Service type dropdown"
      contains: "ServiceTypeSelect"
  key_links:
    - from: "components/jobs/add-job-sheet.tsx"
      to: "lib/actions/job.ts"
      via: "createJob import"
      pattern: "import.*createJob.*from.*actions/job"
    - from: "components/jobs/customer-selector.tsx"
      to: "Customer type"
      via: "type import"
      pattern: "import.*Customer.*from.*types/database"
---

<objective>
Create Add/Edit job forms with customer selector and service type dropdown.

Purpose: Users need forms to create and edit jobs. The customer selector reuses the autocomplete pattern from quick-send-tab.tsx with search by name/email.

Output: Add job sheet, edit job sheet, customer selector, and service type select components.
</objective>

<execution_context>
@C:\Users\aanth\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aanth\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-jobs-crud-service-types/22-RESEARCH.md
@components/send/quick-send-tab.tsx
@components/customers/add-customer-sheet.tsx
@components/customers/edit-customer-sheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create customer selector component</name>
  <files>components/jobs/customer-selector.tsx</files>
  <action>
Create components/jobs/customer-selector.tsx adapting the autocomplete pattern from quick-send-tab.tsx:

```typescript
'use client'

import { useState, useRef, useEffect, useMemo } from 'react'
import { MagnifyingGlass, X, User, CaretDown } from '@phosphor-icons/react'
import type { Customer } from '@/lib/types/database'

interface CustomerSelectorProps {
  customers: Customer[]
  value: string | null
  onChange: (customerId: string | null) => void
  error?: string
}

export function CustomerSelector({ customers, value, onChange, error }: CustomerSelectorProps) {
  const [query, setQuery] = useState('')
  const [showSuggestions, setShowSuggestions] = useState(false)
  const [highlightedIndex, setHighlightedIndex] = useState(-1)
  const inputRef = useRef<HTMLInputElement>(null)
  const suggestionsRef = useRef<HTMLDivElement>(null)

  // Find selected customer
  const selectedCustomer = useMemo(() =>
    customers.find(c => c.id === value) || null
  , [customers, value])

  // Filter suggestions (min 2 chars)
  const suggestions = useMemo(() => {
    if (!query.trim() || query.trim().length < 2) return []
    const q = query.toLowerCase().trim()
    return customers
      .filter(c =>
        c.status === 'active' && (
          c.name.toLowerCase().includes(q) ||
          c.email.toLowerCase().includes(q)
        )
      )
      .slice(0, 6)
  }, [query, customers])

  // Close on outside click
  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (
        suggestionsRef.current && !suggestionsRef.current.contains(e.target as Node) &&
        inputRef.current && !inputRef.current.contains(e.target as Node)
      ) {
        setShowSuggestions(false)
      }
    }
    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  const handleSelect = (customer: Customer) => {
    onChange(customer.id)
    setQuery('')
    setShowSuggestions(false)
    setHighlightedIndex(-1)
  }

  const handleClear = () => {
    onChange(null)
    setQuery('')
    inputRef.current?.focus()
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (!showSuggestions || suggestions.length === 0) return

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault()
        setHighlightedIndex(prev =>
          prev < suggestions.length - 1 ? prev + 1 : 0
        )
        break
      case 'ArrowUp':
        e.preventDefault()
        setHighlightedIndex(prev =>
          prev > 0 ? prev - 1 : suggestions.length - 1
        )
        break
      case 'Enter':
        e.preventDefault()
        if (highlightedIndex >= 0 && highlightedIndex < suggestions.length) {
          handleSelect(suggestions[highlightedIndex])
        }
        break
      case 'Escape':
        setShowSuggestions(false)
        setHighlightedIndex(-1)
        break
    }
  }

  // If customer selected, show selected state
  if (selectedCustomer) {
    return (
      <div className="space-y-1">
        <div
          className={`flex items-center justify-between rounded-md border px-3 py-2 ${
            error ? 'border-destructive' : 'border-input'
          } bg-background`}
        >
          <div className="flex items-center gap-2">
            <User className="h-4 w-4 text-muted-foreground" />
            <div>
              <div className="text-sm font-medium">{selectedCustomer.name}</div>
              <div className="text-xs text-muted-foreground">{selectedCustomer.email}</div>
            </div>
          </div>
          <button
            type="button"
            onClick={handleClear}
            className="rounded p-1 hover:bg-muted"
          >
            <X className="h-4 w-4 text-muted-foreground" />
          </button>
        </div>
        {error && <p className="text-sm text-destructive">{error}</p>}
      </div>
    )
  }

  return (
    <div className="relative space-y-1">
      <div className="relative">
        <MagnifyingGlass className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
        <input
          ref={inputRef}
          type="text"
          value={query}
          onChange={(e) => {
            setQuery(e.target.value)
            setShowSuggestions(true)
            setHighlightedIndex(-1)
          }}
          onFocus={() => setShowSuggestions(true)}
          onKeyDown={handleKeyDown}
          placeholder="Search customers by name or email..."
          className={`w-full rounded-md border bg-background py-2 pl-9 pr-3 text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring ${
            error ? 'border-destructive' : 'border-input'
          }`}
        />
        <CaretDown className="absolute right-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
      </div>

      {/* Suggestions dropdown */}
      {showSuggestions && suggestions.length > 0 && (
        <div
          ref={suggestionsRef}
          className="absolute z-50 mt-1 w-full rounded-md border border-border bg-popover shadow-md"
        >
          {suggestions.map((customer, index) => (
            <button
              key={customer.id}
              type="button"
              onClick={() => handleSelect(customer)}
              className={`flex w-full items-center gap-2 px-3 py-2 text-left text-sm hover:bg-muted ${
                index === highlightedIndex ? 'bg-muted' : ''
              }`}
            >
              <User className="h-4 w-4 text-muted-foreground" />
              <div>
                <div className="font-medium">{customer.name}</div>
                <div className="text-xs text-muted-foreground">{customer.email}</div>
              </div>
            </button>
          ))}
        </div>
      )}

      {/* No results message */}
      {showSuggestions && query.length >= 2 && suggestions.length === 0 && (
        <div
          ref={suggestionsRef}
          className="absolute z-50 mt-1 w-full rounded-md border border-border bg-popover p-3 text-center text-sm text-muted-foreground shadow-md"
        >
          No customers found
        </div>
      )}

      {error && <p className="text-sm text-destructive">{error}</p>}
    </div>
  )
}
```

Key features:
- Search by name or email (2 char minimum)
- Keyboard navigation (arrows, enter, escape)
- Outside click to close
- Selected state shows customer info with clear button
- Only shows active customers
  </action>
  <verify>Component renders, search works, keyboard navigation works, selection persists.</verify>
  <done>CustomerSelector component with search, keyboard nav, selection display, and clear functionality.</done>
</task>

<task type="auto">
  <name>Task 2: Create service type select component</name>
  <files>components/jobs/service-type-select.tsx</files>
  <action>
Create components/jobs/service-type-select.tsx:

```typescript
'use client'

import { SERVICE_TYPES, SERVICE_TYPE_LABELS } from '@/lib/validations/job'
import type { ServiceType } from '@/lib/types/database'

interface ServiceTypeSelectProps {
  value: ServiceType | ''
  onChange: (value: ServiceType) => void
  error?: string
  enabledTypes?: ServiceType[] // Optional: only show enabled types for business
}

export function ServiceTypeSelect({
  value,
  onChange,
  error,
  enabledTypes,
}: ServiceTypeSelectProps) {
  // Filter to enabled types if provided, otherwise show all
  const availableTypes = enabledTypes && enabledTypes.length > 0
    ? SERVICE_TYPES.filter(t => enabledTypes.includes(t))
    : SERVICE_TYPES

  return (
    <div className="space-y-1">
      <select
        value={value}
        onChange={(e) => onChange(e.target.value as ServiceType)}
        className={`w-full rounded-md border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring ${
          error ? 'border-destructive' : 'border-input'
        }`}
      >
        <option value="">Select service type...</option>
        {availableTypes.map(type => (
          <option key={type} value={type}>
            {SERVICE_TYPE_LABELS[type]}
          </option>
        ))}
      </select>
      {error && <p className="text-sm text-destructive">{error}</p>}
    </div>
  )
}
```

Simple select with:
- All 8 service types from validation
- Proper labels (HVAC, not hvac)
- Optional filtering to business's enabled types
- Error state styling
  </action>
  <verify>Component renders with all 8 options. Selection changes value.</verify>
  <done>ServiceTypeSelect component with all service types, proper labels, and optional filtering.</done>
</task>

<task type="auto">
  <name>Task 3: Create add job sheet</name>
  <files>components/jobs/add-job-sheet.tsx</files>
  <action>
Create components/jobs/add-job-sheet.tsx following add-customer-sheet pattern:

```typescript
'use client'

import { useActionState, useEffect, useState } from 'react'
import { toast } from 'sonner'
import { Loader2 } from 'lucide-react'
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
} from '@/components/ui/sheet'
import { Button } from '@/components/ui/button'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { CustomerSelector } from './customer-selector'
import { ServiceTypeSelect } from './service-type-select'
import { createJob, type JobActionState } from '@/lib/actions/job'
import { JOB_STATUSES, JOB_STATUS_LABELS } from '@/lib/validations/job'
import type { Customer, ServiceType, JobStatus } from '@/lib/types/database'

interface AddJobSheetProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  customers: Customer[]
}

export function AddJobSheet({ open, onOpenChange, customers }: AddJobSheetProps) {
  const [state, formAction, isPending] = useActionState<JobActionState | null, FormData>(
    createJob,
    null
  )

  // Local state for controlled components
  const [customerId, setCustomerId] = useState<string | null>(null)
  const [serviceType, setServiceType] = useState<ServiceType | ''>('')
  const [status, setStatus] = useState<JobStatus>('completed')
  const [notes, setNotes] = useState('')

  // Reset form when sheet closes
  useEffect(() => {
    if (!open) {
      setCustomerId(null)
      setServiceType('')
      setStatus('completed')
      setNotes('')
    }
  }, [open])

  // Handle success
  useEffect(() => {
    if (state?.success) {
      toast.success('Job created successfully')
      onOpenChange(false)
    } else if (state?.error) {
      toast.error(state.error)
    }
  }, [state, onOpenChange])

  const handleSubmit = (formData: FormData) => {
    // Add controlled values to formData
    if (customerId) formData.set('customerId', customerId)
    if (serviceType) formData.set('serviceType', serviceType)
    formData.set('status', status)
    formData.set('notes', notes)
    formAction(formData)
  }

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent className="overflow-y-auto">
        <SheetHeader>
          <SheetTitle>Add Job</SheetTitle>
          <SheetDescription>
            Create a new job for a customer. Completed jobs will be enrolled in campaigns.
          </SheetDescription>
        </SheetHeader>

        <form action={handleSubmit} className="mt-6 space-y-4">
          {/* Customer selector */}
          <div className="space-y-2">
            <Label>Customer *</Label>
            <CustomerSelector
              customers={customers}
              value={customerId}
              onChange={setCustomerId}
              error={state?.fieldErrors?.customerId?.[0]}
            />
          </div>

          {/* Service type */}
          <div className="space-y-2">
            <Label>Service Type *</Label>
            <ServiceTypeSelect
              value={serviceType}
              onChange={setServiceType}
              error={state?.fieldErrors?.serviceType?.[0]}
            />
          </div>

          {/* Status */}
          <div className="space-y-2">
            <Label>Status</Label>
            <select
              value={status}
              onChange={(e) => setStatus(e.target.value as JobStatus)}
              className="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
            >
              {JOB_STATUSES.map(s => (
                <option key={s} value={s}>
                  {JOB_STATUS_LABELS[s]}
                </option>
              ))}
            </select>
            <p className="text-xs text-muted-foreground">
              {status === 'completed'
                ? 'Completed jobs will be enrolled in campaigns automatically.'
                : 'Do Not Send jobs will not trigger review requests.'}
            </p>
          </div>

          {/* Notes */}
          <div className="space-y-2">
            <Label>Notes (optional)</Label>
            <Textarea
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              placeholder="Add any notes about this job..."
              rows={3}
            />
            {state?.fieldErrors?.notes?.[0] && (
              <p className="text-sm text-destructive">{state.fieldErrors.notes[0]}</p>
            )}
          </div>

          {/* Submit */}
          <div className="flex justify-end gap-2 pt-4">
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={isPending || !customerId || !serviceType}>
              {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Create Job
            </Button>
          </div>
        </form>
      </SheetContent>
    </Sheet>
  )
}
```
  </action>
  <verify>Sheet opens, form validates, job creation works, toast shows on success.</verify>
  <done>AddJobSheet with customer selector, service type, status, notes, and form submission.</done>
</task>

<task type="auto">
  <name>Task 4: Create edit job sheet</name>
  <files>components/jobs/edit-job-sheet.tsx</files>
  <action>
Create components/jobs/edit-job-sheet.tsx following edit-customer-sheet pattern:

```typescript
'use client'

import { useActionState, useEffect, useState } from 'react'
import { toast } from 'sonner'
import { Loader2 } from 'lucide-react'
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
} from '@/components/ui/sheet'
import { Button } from '@/components/ui/button'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { CustomerSelector } from './customer-selector'
import { ServiceTypeSelect } from './service-type-select'
import { updateJob, type JobActionState } from '@/lib/actions/job'
import { JOB_STATUSES, JOB_STATUS_LABELS } from '@/lib/validations/job'
import type { JobWithCustomer, Customer, ServiceType, JobStatus } from '@/lib/types/database'

interface EditJobSheetProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  job: JobWithCustomer
  customers: Customer[]
}

export function EditJobSheet({ open, onOpenChange, job, customers }: EditJobSheetProps) {
  const [state, formAction, isPending] = useActionState<JobActionState | null, FormData>(
    updateJob,
    null
  )

  // Local state initialized from job
  const [customerId, setCustomerId] = useState<string | null>(job.customer_id)
  const [serviceType, setServiceType] = useState<ServiceType>(job.service_type)
  const [status, setStatus] = useState<JobStatus>(job.status)
  const [notes, setNotes] = useState(job.notes || '')

  // Reset form when job changes
  useEffect(() => {
    setCustomerId(job.customer_id)
    setServiceType(job.service_type)
    setStatus(job.status)
    setNotes(job.notes || '')
  }, [job])

  // Handle success
  useEffect(() => {
    if (state?.success) {
      toast.success('Job updated successfully')
      onOpenChange(false)
    } else if (state?.error) {
      toast.error(state.error)
    }
  }, [state, onOpenChange])

  const handleSubmit = (formData: FormData) => {
    formData.set('jobId', job.id)
    if (customerId) formData.set('customerId', customerId)
    formData.set('serviceType', serviceType)
    formData.set('status', status)
    formData.set('notes', notes)
    formAction(formData)
  }

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent className="overflow-y-auto">
        <SheetHeader>
          <SheetTitle>Edit Job</SheetTitle>
          <SheetDescription>
            Update job details. Changing status to completed will set the completion timestamp.
          </SheetDescription>
        </SheetHeader>

        <form action={handleSubmit} className="mt-6 space-y-4">
          {/* Customer selector */}
          <div className="space-y-2">
            <Label>Customer *</Label>
            <CustomerSelector
              customers={customers}
              value={customerId}
              onChange={setCustomerId}
              error={state?.fieldErrors?.customerId?.[0]}
            />
          </div>

          {/* Service type */}
          <div className="space-y-2">
            <Label>Service Type *</Label>
            <ServiceTypeSelect
              value={serviceType}
              onChange={setServiceType}
              error={state?.fieldErrors?.serviceType?.[0]}
            />
          </div>

          {/* Status */}
          <div className="space-y-2">
            <Label>Status</Label>
            <select
              value={status}
              onChange={(e) => setStatus(e.target.value as JobStatus)}
              className="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
            >
              {JOB_STATUSES.map(s => (
                <option key={s} value={s}>
                  {JOB_STATUS_LABELS[s]}
                </option>
              ))}
            </select>
            <p className="text-xs text-muted-foreground">
              {status === 'completed'
                ? 'Completed jobs will be enrolled in campaigns automatically.'
                : 'Do Not Send jobs will not trigger review requests.'}
            </p>
          </div>

          {/* Notes */}
          <div className="space-y-2">
            <Label>Notes (optional)</Label>
            <Textarea
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              placeholder="Add any notes about this job..."
              rows={3}
            />
            {state?.fieldErrors?.notes?.[0] && (
              <p className="text-sm text-destructive">{state.fieldErrors.notes[0]}</p>
            )}
          </div>

          {/* Job info (read-only) */}
          <div className="rounded-md bg-muted p-3 text-sm">
            <div className="flex justify-between">
              <span className="text-muted-foreground">Created</span>
              <span>{new Date(job.created_at).toLocaleDateString()}</span>
            </div>
            {job.completed_at && (
              <div className="mt-1 flex justify-between">
                <span className="text-muted-foreground">Completed</span>
                <span>{new Date(job.completed_at).toLocaleDateString()}</span>
              </div>
            )}
          </div>

          {/* Submit */}
          <div className="flex justify-end gap-2 pt-4">
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={isPending || !customerId || !serviceType}>
              {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Save Changes
            </Button>
          </div>
        </form>
      </SheetContent>
    </Sheet>
  )
}
```
  </action>
  <verify>Sheet opens with job data prefilled. Updates work and show toast.</verify>
  <done>EditJobSheet with prefilled data, customer selector, service type, status, notes, and job info display.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Add Job button opens sheet with empty form
2. Customer selector searches and selects customers
3. Service type dropdown shows all 8 types
4. Form submission creates job with toast
5. Edit sheet opens with job data prefilled
6. Edit submission updates job with toast
7. `pnpm lint` and `pnpm typecheck` pass
</verification>

<success_criteria>
- CustomerSelector component with search, keyboard nav, selection display
- ServiceTypeSelect component with all 8 types
- AddJobSheet with form validation and submission
- EditJobSheet with prefilled data and update
- Forms disable submit until required fields filled
- Toast notifications on success/error
- `pnpm typecheck` passes
</success_criteria>

<output>
After completion, create `.planning/phases/22-jobs-crud-service-types/22-04-SUMMARY.md`
</output>
