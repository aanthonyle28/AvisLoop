---
phase: 22-jobs-crud-service-types
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260203_create_jobs.sql
  - supabase/migrations/20260203_add_service_type_settings.sql
autonomous: true

must_haves:
  truths:
    - "Jobs table exists with RLS enabled"
    - "Each job links to exactly one customer via FK"
    - "Service type column constrains to 8 valid values"
    - "Status column constrains to completed/do_not_send"
    - "Business settings include service_types_enabled and service_type_timing"
  artifacts:
    - path: "supabase/migrations/20260203_create_jobs.sql"
      provides: "Jobs table with RLS and indexes"
      contains: "CREATE TABLE IF NOT EXISTS public.jobs"
    - path: "supabase/migrations/20260203_add_service_type_settings.sql"
      provides: "Business columns for service type config"
      contains: "service_type_timing JSONB"
  key_links:
    - from: "jobs.customer_id"
      to: "customers.id"
      via: "FK constraint with ON DELETE CASCADE"
      pattern: "REFERENCES public.customers"
    - from: "jobs.business_id"
      to: "businesses.id"
      via: "FK constraint with ON DELETE CASCADE"
      pattern: "REFERENCES public.businesses"
---

<objective>
Create database schema for Jobs table with service types and business service type settings.

Purpose: Jobs are the core entity that triggers campaign enrollment when marked complete. Each job links a customer to a specific service type, enabling service-specific campaign targeting.

Output: Two migration files creating jobs table with RLS and business service type columns.
</objective>

<execution_context>
@C:\Users\aanth\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\aanth\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-jobs-crud-service-types/22-RESEARCH.md
@supabase/migrations/20260202_rename_contacts_to_customers.sql
@supabase/migrations/00002_create_business.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create jobs table migration</name>
  <files>supabase/migrations/20260203_create_jobs.sql</files>
  <action>
Create migration file for jobs table following existing patterns from customers migration:

```sql
-- Migration: 20260203_create_jobs
-- Purpose: Jobs table with service type, status, customer link, and RLS
-- Part of: Phase 22 - Jobs CRUD & Service Types (JOBS-01, JOBS-02, JOBS-03, JOBS-04)

-- ============================================================================
-- 1. Create jobs table
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_id UUID NOT NULL REFERENCES public.businesses(id) ON DELETE CASCADE,
  customer_id UUID NOT NULL REFERENCES public.customers(id) ON DELETE CASCADE,
  service_type TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'completed',
  notes TEXT,
  completed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- Service type enum-like constraint (lowercase)
  CONSTRAINT jobs_service_type_valid CHECK (
    service_type IN ('hvac', 'plumbing', 'electrical', 'cleaning', 'roofing', 'painting', 'handyman', 'other')
  ),
  -- Status enum-like constraint
  CONSTRAINT jobs_status_valid CHECK (
    status IN ('completed', 'do_not_send')
  )
);

-- ============================================================================
-- 2. Enable RLS
-- ============================================================================
ALTER TABLE public.jobs ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- 3. Create indexes
-- ============================================================================
CREATE INDEX idx_jobs_business_id ON public.jobs USING btree (business_id);
CREATE INDEX idx_jobs_customer_id ON public.jobs USING btree (customer_id);
CREATE INDEX idx_jobs_business_status ON public.jobs USING btree (business_id, status);
CREATE INDEX idx_jobs_business_service_type ON public.jobs USING btree (business_id, service_type);
CREATE INDEX idx_jobs_completed_at ON public.jobs USING btree (completed_at) WHERE completed_at IS NOT NULL;

-- ============================================================================
-- 4. RLS Policies (business-scoped via subquery pattern)
-- ============================================================================
CREATE POLICY "Users view own jobs"
ON public.jobs FOR SELECT
TO authenticated
USING (business_id IN (SELECT id FROM public.businesses WHERE user_id = (SELECT auth.uid())));

CREATE POLICY "Users insert own jobs"
ON public.jobs FOR INSERT
TO authenticated
WITH CHECK (business_id IN (SELECT id FROM public.businesses WHERE user_id = (SELECT auth.uid())));

CREATE POLICY "Users update own jobs"
ON public.jobs FOR UPDATE
TO authenticated
USING (business_id IN (SELECT id FROM public.businesses WHERE user_id = (SELECT auth.uid())))
WITH CHECK (business_id IN (SELECT id FROM public.businesses WHERE user_id = (SELECT auth.uid())));

CREATE POLICY "Users delete own jobs"
ON public.jobs FOR DELETE
TO authenticated
USING (business_id IN (SELECT id FROM public.businesses WHERE user_id = (SELECT auth.uid())));

-- ============================================================================
-- 5. Trigger for updated_at
-- ============================================================================
CREATE TRIGGER jobs_updated_at
  BEFORE UPDATE ON public.jobs
  FOR EACH ROW EXECUTE FUNCTION extensions.moddatetime(updated_at);

-- ============================================================================
-- Migration complete
-- ============================================================================
```

Key points:
- Use TEXT with CHECK constraint (not enum) for easier migrations
- Lowercase service types to avoid casing issues
- status defaults to 'completed' (most common)
- completed_at nullable - set when status is 'completed'
- Follow exact RLS pattern from customers table (subquery)
  </action>
  <verify>
Run `supabase db reset` (if local) or check migration syntax is valid SQL.
Confirm: jobs table has 8 columns, 2 constraints, 5 indexes, 4 RLS policies, 1 trigger.
  </verify>
  <done>
Migration file exists at supabase/migrations/20260203_create_jobs.sql with:
- jobs table with id, business_id, customer_id, service_type, status, notes, completed_at, created_at, updated_at
- CHECK constraints for service_type (8 values) and status (2 values)
- FK to businesses and customers with CASCADE delete
- RLS enabled with 4 policies (SELECT, INSERT, UPDATE, DELETE)
- Indexes on business_id, customer_id, status, service_type, completed_at
- moddatetime trigger for updated_at
  </done>
</task>

<task type="auto">
  <name>Task 2: Add service type settings to businesses table</name>
  <files>supabase/migrations/20260203_add_service_type_settings.sql</files>
  <action>
Create migration to add service type configuration columns to businesses table:

```sql
-- Migration: 20260203_add_service_type_settings
-- Purpose: Add service type enabled list and timing defaults to businesses
-- Part of: Phase 22 - Jobs CRUD & Service Types (SVCT-01, SVCT-02)

-- ============================================================================
-- 1. Add service types enabled column (array of enabled service types)
-- ============================================================================
ALTER TABLE public.businesses
  ADD COLUMN IF NOT EXISTS service_types_enabled TEXT[] DEFAULT '{}';

-- ============================================================================
-- 2. Add service type timing defaults (hours until first campaign touch)
-- ============================================================================
ALTER TABLE public.businesses
  ADD COLUMN IF NOT EXISTS service_type_timing JSONB DEFAULT '{
    "hvac": 24,
    "plumbing": 48,
    "electrical": 24,
    "cleaning": 4,
    "roofing": 72,
    "painting": 48,
    "handyman": 24,
    "other": 24
  }'::jsonb;

-- ============================================================================
-- 3. Comment on columns for documentation
-- ============================================================================
COMMENT ON COLUMN public.businesses.service_types_enabled IS
  'Array of service types this business offers. Selected during onboarding. Used to filter job creation options.';

COMMENT ON COLUMN public.businesses.service_type_timing IS
  'JSONB map of service type to hours until first campaign touch. Default timing auto-applied when creating campaigns.';

-- ============================================================================
-- Migration complete
-- ============================================================================
```

Key points:
- service_types_enabled is TEXT[] array - empty by default (user selects during onboarding or settings)
- service_type_timing is JSONB with sensible defaults per research:
  - HVAC: 24h (technical work, customer wants to verify working)
  - Plumbing: 48h (may need to test over time)
  - Electrical: 24h (quick verification)
  - Cleaning: 4h (immediate satisfaction)
  - Roofing: 72h (weather-dependent, need time to check)
  - Painting: 48h (need to see in different lighting)
  - Handyman: 24h (varied work, quick check)
  - Other: 24h (default)
  </action>
  <verify>
Run migration or check syntax. Verify businesses table has two new columns.
  </verify>
  <done>
Migration file exists at supabase/migrations/20260203_add_service_type_settings.sql with:
- service_types_enabled TEXT[] column (default empty array)
- service_type_timing JSONB column with defaults for all 8 service types
- Column comments for documentation
  </done>
</task>

<task type="auto">
  <name>Task 3: Update DATA_MODEL.md with jobs table documentation</name>
  <files>docs/DATA_MODEL.md</files>
  <action>
Add Jobs table section to DATA_MODEL.md following the customers table documentation pattern:

Add after the customers section:

```markdown
## Table: jobs

Stores completed service jobs for each business. Each job links to exactly one customer and has a service type for campaign targeting.

### Schema

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | UUID | NO | gen_random_uuid() | Primary key |
| business_id | UUID | NO | - | FK to businesses |
| customer_id | UUID | NO | - | FK to customers |
| service_type | TEXT | NO | - | One of: hvac, plumbing, electrical, cleaning, roofing, painting, handyman, other |
| status | TEXT | NO | 'completed' | 'completed' or 'do_not_send' |
| notes | TEXT | YES | - | Internal notes about the job |
| completed_at | TIMESTAMPTZ | YES | - | When job was marked completed (null if do_not_send) |
| created_at | TIMESTAMPTZ | YES | NOW() | Created timestamp |
| updated_at | TIMESTAMPTZ | YES | NOW() | Updated timestamp |

### RLS Policies

- Users can only view/insert/update/delete jobs for businesses they own
- Business ownership verified via subquery: `business_id IN (SELECT id FROM businesses WHERE user_id = auth.uid())`

### Indexes

- idx_jobs_business_id (btree)
- idx_jobs_customer_id (btree)
- idx_jobs_business_status (btree on business_id, status)
- idx_jobs_business_service_type (btree on business_id, service_type)
- idx_jobs_completed_at (partial: completed_at IS NOT NULL)

### Foreign Keys

- jobs.business_id references businesses.id (CASCADE)
- jobs.customer_id references customers.id (CASCADE)

### Service Types

Fixed set of 8 service types (stored lowercase):
- hvac - Heating, ventilation, air conditioning
- plumbing - Plumbing and water systems
- electrical - Electrical work
- cleaning - Cleaning services
- roofing - Roof repair and installation
- painting - Interior/exterior painting
- handyman - General handyman services
- other - Other services not listed

### Status Workflow

Simple two-state workflow for v2.0:
- `completed` - Job is done, triggers campaign enrollment (Phase 24)
- `do_not_send` - Job complete but should not trigger review request

When status changes to 'completed', completed_at is set. Campaign enrollment logic (Phase 24) uses completed_at to determine timing.
```

Also add section for businesses service type columns:

```markdown
### Business Service Type Settings

Added in Phase 22 for service-specific campaign timing:

| Column | Type | Description |
|--------|------|-------------|
| service_types_enabled | TEXT[] | Array of service types this business offers |
| service_type_timing | JSONB | Map of service type to hours until first campaign touch |

Default timing values:
- hvac: 24 hours
- plumbing: 48 hours
- electrical: 24 hours
- cleaning: 4 hours
- roofing: 72 hours
- painting: 48 hours
- handyman: 24 hours
- other: 24 hours
```
  </action>
  <verify>Read docs/DATA_MODEL.md and confirm jobs section exists with schema, RLS, indexes documented.</verify>
  <done>DATA_MODEL.md updated with jobs table documentation including schema, RLS policies, indexes, service types, and status workflow. Business service type columns documented.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Migrations exist in supabase/migrations/ with correct naming
2. Jobs table SQL is syntactically valid (no typos in constraints)
3. RLS pattern matches existing customers table exactly
4. DATA_MODEL.md documents the new table
5. `pnpm lint` passes (no TypeScript changes in this plan)
</verification>

<success_criteria>
- supabase/migrations/20260203_create_jobs.sql exists and is valid SQL
- supabase/migrations/20260203_add_service_type_settings.sql exists and is valid SQL
- docs/DATA_MODEL.md includes jobs table documentation
- Jobs table has: id, business_id, customer_id, service_type, status, notes, completed_at, created_at, updated_at
- Service type CHECK constraint includes all 8 types (lowercase)
- Status CHECK constraint includes completed and do_not_send
- FK constraints to businesses and customers with CASCADE
- RLS enabled with 4 policies following business-scoped subquery pattern
- Businesses table has service_types_enabled and service_type_timing columns
</success_criteria>

<output>
After completion, create `.planning/phases/22-jobs-crud-service-types/22-01-SUMMARY.md`
</output>
