---
phase: 07-onboarding-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00008_add_onboarding.sql
  - lib/data/onboarding.ts
  - lib/actions/onboarding.ts
autonomous: true

must_haves:
  truths:
    - "Database can track onboarding completion timestamp"
    - "Server can query onboarding status (business profile, review link, contacts, sent messages)"
    - "Server action can mark onboarding as complete"
  artifacts:
    - path: "supabase/migrations/00008_add_onboarding.sql"
      provides: "Onboarding tracking columns on businesses table"
      contains: "onboarding_completed_at"
    - path: "lib/data/onboarding.ts"
      provides: "Onboarding status query function"
      exports: ["getOnboardingStatus", "OnboardingStatus"]
    - path: "lib/actions/onboarding.ts"
      provides: "Server action for marking onboarding complete"
      exports: ["markOnboardingComplete"]
  key_links:
    - from: "lib/data/onboarding.ts"
      to: "supabase.from('businesses')"
      via: "query for onboarding_completed_at"
      pattern: "onboarding_completed_at"
    - from: "lib/data/onboarding.ts"
      to: "supabase.from('contacts')"
      via: "count query for contacts check"
      pattern: "count.*exact.*head"
    - from: "lib/data/onboarding.ts"
      to: "supabase.from('send_logs')"
      via: "count query for send check"
      pattern: "count.*exact.*head"
---

<objective>
Create database schema and data layer for tracking onboarding completion state.

Purpose: Enable the wizard and dashboard checklist to know which steps the user has completed, persist across devices, and support analytics.

Output: Migration file, getOnboardingStatus function, and markOnboardingComplete server action.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-onboarding-flow/07-RESEARCH.md

Key patterns from codebase:
- Migration files in supabase/migrations/ (00001-00007 exist)
- Data fetching in lib/data/*.ts (see subscription.ts pattern)
- Server actions in lib/actions/*.ts with 'use server' directive
- Auth via getUser() from lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding migration</name>
  <files>supabase/migrations/00008_add_onboarding.sql</files>
  <action>
Create migration file adding onboarding tracking to businesses table:

1. Add columns:
   - `onboarding_completed_at TIMESTAMPTZ` - NULL until wizard completed
   - `onboarding_steps_completed JSONB DEFAULT '[]'::jsonb` - Array of step IDs for granular tracking

2. Create index for querying incomplete onboardings:
   - `idx_businesses_onboarding_incomplete` on (user_id) WHERE onboarding_completed_at IS NULL

3. Add comments on columns documenting their purpose

Pattern from existing migrations: See 00005_create_send_logs.sql for ALTER TABLE syntax.

Important: Use IF NOT EXISTS for idempotency.
  </action>
  <verify>
File exists at supabase/migrations/00008_add_onboarding.sql
Contains: ALTER TABLE, onboarding_completed_at, onboarding_steps_completed, CREATE INDEX
  </verify>
  <done>Migration file ready for application to Supabase</done>
</task>

<task type="auto">
  <name>Task 2: Create onboarding data layer</name>
  <files>lib/data/onboarding.ts</files>
  <action>
Create data fetching function for onboarding status:

```typescript
// lib/data/onboarding.ts
import { createClient } from '@/lib/supabase/server'

export type OnboardingStatus = {
  completed: boolean
  completedAt: string | null
  steps: {
    hasBusinessProfile: boolean
    hasReviewLink: boolean
    hasContacts: boolean
    hasSentMessage: boolean
  }
}

export async function getOnboardingStatus(): Promise<OnboardingStatus | null>
```

Implementation:
1. Auth check with getUser() - return null if not authenticated
2. Query businesses table for business data (id, onboarding_completed_at, google_review_link)
3. If no business, return status with all steps false
4. Count contacts (status='active') for hasContacts
5. Count send_logs for hasSentMessage
6. Return OnboardingStatus object with all step states

Pattern: Follow lib/data/subscription.ts structure.
Use `{ count: 'exact', head: true }` for count queries.
  </action>
  <verify>
`pnpm typecheck` passes
Exports: getOnboardingStatus, OnboardingStatus
  </verify>
  <done>getOnboardingStatus returns complete status including all 4 step checks</done>
</task>

<task type="auto">
  <name>Task 3: Create markOnboardingComplete server action</name>
  <files>lib/actions/onboarding.ts</files>
  <action>
Create server action for marking onboarding as complete:

```typescript
// lib/actions/onboarding.ts
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'

export async function markOnboardingComplete(): Promise<{ success: boolean; error?: string }>
```

Implementation:
1. Auth check with getUser()
2. Update businesses table: set onboarding_completed_at = new Date().toISOString()
3. Call revalidatePath('/dashboard') to refresh dashboard data
4. Return { success: true } or { success: false, error: message }

Pattern: Follow lib/actions/business.ts for error handling structure.
  </action>
  <verify>
`pnpm typecheck` passes
`pnpm lint` passes
Export: markOnboardingComplete
  </verify>
  <done>Server action can mark onboarding complete and invalidate dashboard cache</done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. Migration file exists with correct schema
4. lib/data/onboarding.ts exports OnboardingStatus type and getOnboardingStatus function
5. lib/actions/onboarding.ts exports markOnboardingComplete
</verification>

<success_criteria>
- Migration ready for Supabase (00008_add_onboarding.sql)
- getOnboardingStatus queries all 4 steps from database
- markOnboardingComplete updates businesses.onboarding_completed_at
- All typecheck and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-onboarding-flow/07-01-SUMMARY.md`
</output>
