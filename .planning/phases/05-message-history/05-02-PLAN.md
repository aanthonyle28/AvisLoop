---
phase: 05-message-history
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - components/history/history-columns.tsx
  - components/history/history-table.tsx
  - components/history/history-client.tsx
  - components/history/empty-state.tsx
  - app/(dashboard)/history/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view list of all sent messages with recipient, date, and status"
    - "User can see message status (pending, sent, delivered, bounced, failed, complained, opened)"
    - "User can filter message history by date range"
    - "User can search message history by recipient name or email"
  artifacts:
    - path: "app/(dashboard)/history/page.tsx"
      provides: "History page with Server Component data fetching"
      exports: ["default", "metadata"]
      min_lines: 30
    - path: "components/history/history-client.tsx"
      provides: "Client orchestrator component"
      exports: ["HistoryClient"]
      min_lines: 40
    - path: "components/history/history-table.tsx"
      provides: "TanStack Table implementation"
      exports: ["HistoryTable"]
      min_lines: 60
    - path: "components/history/history-columns.tsx"
      provides: "Column definitions for history table"
      exports: ["createColumns"]
      min_lines: 50
    - path: "components/history/empty-state.tsx"
      provides: "Empty state component for history"
      exports: ["EmptyState"]
      min_lines: 20
  key_links:
    - from: "app/(dashboard)/history/page.tsx"
      to: "lib/data/send-logs.ts"
      via: "getSendLogs call with searchParams"
      pattern: "getSendLogs\\(.*query.*status.*dateFrom.*dateTo"
    - from: "components/history/history-table.tsx"
      to: "@tanstack/react-table"
      via: "useReactTable hook"
      pattern: "useReactTable"
    - from: "components/history/history-columns.tsx"
      to: "components/history/status-badge.tsx"
      via: "StatusBadge in cell renderer"
      pattern: "StatusBadge"
---

<objective>
Create the history table UI and integrate all components into a complete message history page.

Purpose: Deliver the full user-facing message history feature where users can view, filter, and search their sent messages. This completes Phase 5 requirements.

Output: Complete history page with table, columns, filtering, search, and empty state
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-message-history/05-RESEARCH.md
@.planning/phases/05-message-history/05-01-SUMMARY.md

# Existing patterns to follow
@app/(dashboard)/contacts/page.tsx
@components/contacts/contacts-client.tsx
@components/contacts/contact-table.tsx
@components/contacts/contact-columns.tsx
@components/contacts/empty-state.tsx
@lib/types/database.ts

# Components from Plan 01
@components/history/status-badge.tsx
@components/history/history-filters.tsx
@lib/data/send-logs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create history columns and table components</name>
  <files>
    components/history/history-columns.tsx
    components/history/history-table.tsx
  </files>
  <action>
Create `components/history/history-columns.tsx` with column definitions for the history table.

Columns to display:
1. **Recipient** - Contact name and email (stacked, name bold, email muted)
2. **Subject** - Email subject line (truncate if too long)
3. **Status** - StatusBadge component
4. **Sent** - Formatted date/time using date-fns format()

```typescript
// components/history/history-columns.tsx
'use client'

import { ColumnDef } from '@tanstack/react-table'
import { format } from 'date-fns'
import { StatusBadge } from './status-badge'
import type { SendLogWithContact } from '@/lib/types/database'
import type { SendStatus } from './status-badge'

export function createColumns(): ColumnDef<SendLogWithContact>[] {
  return [
    {
      accessorKey: 'contacts',
      header: 'Recipient',
      cell: ({ row }) => {
        const contact = row.original.contacts
        return (
          <div className="flex flex-col">
            <span className="font-medium">{contact.name}</span>
            <span className="text-sm text-muted-foreground">{contact.email}</span>
          </div>
        )
      },
    },
    {
      accessorKey: 'subject',
      header: 'Subject',
      cell: ({ row }) => (
        <span className="max-w-[300px] truncate block" title={row.original.subject}>
          {row.original.subject}
        </span>
      ),
    },
    {
      accessorKey: 'status',
      header: 'Status',
      cell: ({ row }) => (
        <StatusBadge status={row.original.status as SendStatus} />
      ),
    },
    {
      accessorKey: 'created_at',
      header: 'Sent',
      cell: ({ row }) => (
        <span className="text-muted-foreground">
          {format(new Date(row.original.created_at), 'MMM d, yyyy h:mm a')}
        </span>
      ),
    },
  ]
}
```

Then create `components/history/history-table.tsx` following the contact-table.tsx pattern:

```typescript
// components/history/history-table.tsx
'use client'

import { useMemo } from 'react'
import {
  useReactTable,
  getCoreRowModel,
  getSortedRowModel,
  flexRender,
  SortingState,
} from '@tanstack/react-table'
import { useState } from 'react'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { createColumns } from './history-columns'
import type { SendLogWithContact } from '@/lib/types/database'

interface HistoryTableProps {
  data: SendLogWithContact[]
}

export function HistoryTable({ data }: HistoryTableProps) {
  const columns = useMemo(() => createColumns(), [])
  const [sorting, setSorting] = useState<SortingState>([])

  const table = useReactTable({
    data,
    columns,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    onSortingChange: setSorting,
    state: {
      sorting,
    },
  })

  return (
    <div className="rounded-md border">
      <Table>
        <TableHeader>
          {table.getHeaderGroups().map((headerGroup) => (
            <TableRow key={headerGroup.id}>
              {headerGroup.headers.map((header) => (
                <TableHead key={header.id}>
                  {header.isPlaceholder
                    ? null
                    : flexRender(header.column.columnDef.header, header.getContext())}
                </TableHead>
              ))}
            </TableRow>
          ))}
        </TableHeader>
        <TableBody>
          {table.getRowModel().rows?.length ? (
            table.getRowModel().rows.map((row) => (
              <TableRow key={row.id}>
                {row.getVisibleCells().map((cell) => (
                  <TableCell key={cell.id}>
                    {flexRender(cell.column.columnDef.cell, cell.getContext())}
                  </TableCell>
                ))}
              </TableRow>
            ))
          ) : (
            <TableRow>
              <TableCell colSpan={columns.length} className="h-24 text-center">
                No messages found.
              </TableCell>
            </TableRow>
          )}
        </TableBody>
      </Table>
    </div>
  )
}
```

Note: Server-side pagination is NOT implemented in this phase. The table displays all results returned by the query (which already supports limit/offset). Pagination UI can be added in a future enhancement if needed.
  </action>
  <verify>
Run `pnpm typecheck` - no type errors.
Verify both files exist in components/history/.
  </verify>
  <done>
HistoryTable displays send logs with recipient info, subject, status badge, and formatted date. Columns are properly typed with SendLogWithContact.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create empty state and client orchestrator</name>
  <files>
    components/history/empty-state.tsx
    components/history/history-client.tsx
  </files>
  <action>
Create `components/history/empty-state.tsx` for when no messages exist or filters return no results:

```typescript
// components/history/empty-state.tsx
import { Mail, Search } from 'lucide-react'
import { Button } from '@/components/ui/button'
import Link from 'next/link'

interface EmptyStateProps {
  hasFilters: boolean
}

export function EmptyState({ hasFilters }: EmptyStateProps) {
  if (hasFilters) {
    return (
      <div className="flex flex-col items-center justify-center py-16 px-4 text-center">
        <div className="rounded-full bg-muted p-6 mb-6">
          <Search className="h-12 w-12 text-muted-foreground" />
        </div>
        <h2 className="text-2xl font-semibold tracking-tight mb-2">
          No messages found
        </h2>
        <p className="text-muted-foreground mb-4 max-w-md">
          Try adjusting your search or filters to find what you&apos;re looking for
        </p>
      </div>
    )
  }

  return (
    <div className="flex flex-col items-center justify-center py-16 px-4 text-center">
      <div className="rounded-full bg-muted p-6 mb-6">
        <Mail className="h-12 w-12 text-muted-foreground" />
      </div>
      <h2 className="text-2xl font-semibold tracking-tight mb-2">
        No messages sent yet
      </h2>
      <p className="text-muted-foreground mb-8 max-w-md">
        Send your first review request to see your message history here
      </p>
      <Button asChild>
        <Link href="/dashboard/send">Send a message</Link>
      </Button>
    </div>
  )
}
```

Then create `components/history/history-client.tsx` as the client orchestrator:

```typescript
// components/history/history-client.tsx
'use client'

import { useSearchParams } from 'next/navigation'
import { HistoryTable } from './history-table'
import { HistoryFilters } from './history-filters'
import { EmptyState } from './empty-state'
import type { SendLogWithContact } from '@/lib/types/database'

interface HistoryClientProps {
  initialLogs: SendLogWithContact[]
  total: number
}

export function HistoryClient({ initialLogs, total }: HistoryClientProps) {
  const searchParams = useSearchParams()

  // Determine if any filters are active
  const hasFilters =
    searchParams.has('query') ||
    (searchParams.has('status') && searchParams.get('status') !== 'all') ||
    searchParams.has('from') ||
    searchParams.has('to')

  const hasLogs = initialLogs.length > 0

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-3xl font-bold tracking-tight">Message History</h1>
        <p className="text-muted-foreground mt-1">
          View and track all your sent review requests
        </p>
      </div>

      {/* Always show filters if there are logs OR if filters are active */}
      {(hasLogs || hasFilters) && (
        <HistoryFilters />
      )}

      {/* Content */}
      {hasLogs ? (
        <div className="space-y-4">
          <div className="text-sm text-muted-foreground">
            Showing {initialLogs.length} of {total} message{total !== 1 ? 's' : ''}
          </div>
          <HistoryTable data={initialLogs} />
        </div>
      ) : (
        <EmptyState hasFilters={hasFilters} />
      )}
    </div>
  )
}
```

Key behaviors:
- Shows filters when logs exist OR when filters are active (so user can clear them)
- Shows "Showing X of Y messages" count
- Different empty states for "no messages ever" vs "no results match filters"
  </action>
  <verify>
Run `pnpm typecheck` - no type errors.
Verify both files exist in components/history/.
  </verify>
  <done>
HistoryClient orchestrates filters, table, and empty state. Shows appropriate empty state based on whether filters are active.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create history page with Server Component data fetching</name>
  <files>app/(dashboard)/history/page.tsx</files>
  <action>
Create `app/(dashboard)/history/page.tsx` following the contacts page pattern:

```typescript
// app/(dashboard)/history/page.tsx
import { Suspense } from 'react'
import { getSendLogs } from '@/lib/data/send-logs'
import { HistoryClient } from '@/components/history/history-client'

export const metadata = {
  title: 'Message History | AvisLoop',
  description: 'View and track all your sent review requests',
}

interface HistoryPageProps {
  searchParams: Promise<{
    query?: string
    status?: string
    from?: string
    to?: string
    page?: string
  }>
}

async function HistoryContent({ searchParams }: HistoryPageProps) {
  const params = await searchParams

  const query = params.query || ''
  const status = params.status || ''
  const dateFrom = params.from || ''
  const dateTo = params.to || ''
  const page = Number(params.page) || 1
  const limit = 50

  const { logs, total } = await getSendLogs({
    query: query || undefined,
    status: status && status !== 'all' ? status : undefined,
    dateFrom: dateFrom || undefined,
    dateTo: dateTo || undefined,
    limit,
    offset: (page - 1) * limit,
  })

  return <HistoryClient initialLogs={logs} total={total} />
}

export default async function HistoryPage(props: HistoryPageProps) {
  return (
    <div className="container py-6">
      <Suspense
        fallback={
          <div className="flex items-center justify-center py-16">
            <div className="text-center">
              <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]" />
              <p className="mt-4 text-muted-foreground">Loading message history...</p>
            </div>
          </div>
        }
      >
        <HistoryContent searchParams={props.searchParams} />
      </Suspense>
    </div>
  )
}
```

Key details:
- Uses Next.js 15 pattern: searchParams is a Promise (must await)
- Passes filter params to getSendLogs for server-side filtering
- Uses Suspense for loading state
- Matches the existing contacts page structure
  </action>
  <verify>
Run `pnpm typecheck` - no type errors.
Run `pnpm lint` - no lint errors.
Run `pnpm dev` and navigate to `/dashboard/history`:
  - Page loads without error
  - Shows loading state briefly, then content
  - Empty state shows if no messages sent
  - Filters work (search, status, date range)
  </verify>
  <done>
History page loads send logs with server-side filtering based on URL searchParams. Suspense boundary shows loading state during data fetch.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with no errors
2. `pnpm lint` passes
3. All files created:
   - components/history/history-columns.tsx
   - components/history/history-table.tsx
   - components/history/empty-state.tsx
   - components/history/history-client.tsx
   - app/(dashboard)/history/page.tsx
4. Navigate to /dashboard/history:
   - Page loads without errors
   - If no messages: shows empty state with link to send page
   - If messages exist: shows table with recipient, subject, status, date
   - Search filter works (type in search box, results update after 300ms)
   - Status filter works (select status, results update)
   - Date range filter works (select dates, results update)
   - Clear filters button resets all filters
</verification>

<success_criteria>
- User can view list of all sent messages with recipient, date, and status (HIST-01)
- User can see message status displayed as colored badges (HIST-02)
- User can filter message history by date range (HIST-03)
- User can search message history by recipient name or email (HIST-04)
- Empty states handle both "no messages" and "no results" scenarios
- Loading state shows during data fetch
- Page follows existing codebase patterns (contacts page structure)
</success_criteria>

<output>
After completion, create `.planning/phases/05-message-history/05-02-SUMMARY.md`
</output>
