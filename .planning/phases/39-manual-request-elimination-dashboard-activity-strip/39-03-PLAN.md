---
phase: 39-manual-request-elimination-dashboard-activity-strip
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - components/send/quick-send-form.tsx
  - components/send/quick-send-modal.tsx
  - app/(dashboard)/campaigns/page.tsx
  - components/campaigns/campaigns-page-client.tsx
  - components/customers/customers-client.tsx
  - app/(dashboard)/customers/page.tsx
autonomous: true

must_haves:
  truths:
    - "A 'Send one-off' button on the Campaigns page opens a QuickSendModal with a friction warning"
    - "The QuickSendModal form is extracted from QuickSendTab and works as a standalone Dialog"
    - "Clicking 'Send Message' in the Customer detail drawer opens the QuickSendModal with the customer pre-filled instead of navigating to /send"
  artifacts:
    - path: "components/send/quick-send-form.tsx"
      provides: "Reusable QuickSendForm extracted from QuickSendTab"
      contains: "QuickSendForm"
    - path: "components/send/quick-send-modal.tsx"
      provides: "Dialog wrapper with friction warning around QuickSendForm"
      contains: "QuickSendModal"
    - path: "components/campaigns/campaigns-page-client.tsx"
      provides: "Client wrapper for Campaigns page with QuickSendModal trigger"
      contains: "CampaignsPageClient"
  key_links:
    - from: "components/campaigns/campaigns-page-client.tsx"
      to: "components/send/quick-send-modal.tsx"
      via: "QuickSendModal open state"
      pattern: "QuickSendModal"
    - from: "components/customers/customers-client.tsx"
      to: "components/send/quick-send-modal.tsx"
      via: "handleSendFromDrawer opens modal instead of router.push"
      pattern: "QuickSendModal"
    - from: "app/(dashboard)/customers/page.tsx"
      to: "components/customers/customers-client.tsx"
      via: "Passes business, templates, monthlyUsage, hasReviewLink props"
      pattern: "getBusiness|getMonthlyUsage"
---

<objective>
Extract the QuickSendTab form into a reusable QuickSendForm component, wrap it in a QuickSendModal dialog with friction warning, and integrate it into the Campaigns page and Customer detail drawer.

Purpose: Users need a way to send one-off review requests after the /send page is removed. The modal lives on the Campaigns page (with a button) and can be triggered from the Customer detail drawer with a pre-filled customer.
Output: QuickSendForm, QuickSendModal, Campaigns page integration, Customer drawer integration
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-manual-request-elimination-dashboard-activity-strip/39-RESEARCH.md
@components/send/quick-send-tab.tsx
@components/send/send-page-client.tsx
@app/(dashboard)/campaigns/page.tsx
@components/customers/customers-client.tsx
@app/(dashboard)/customers/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QuickSendForm and QuickSendModal components</name>
  <files>components/send/quick-send-form.tsx, components/send/quick-send-modal.tsx</files>
  <action>
**QuickSendForm (components/send/quick-send-form.tsx):**

Create a new file by extracting the core form logic from `quick-send-tab.tsx` (549 lines). The new QuickSendForm is a simplified, reusable version.

Interface:
```typescript
interface QuickSendFormProps {
  customers: Customer[]
  business: Business & { message_templates?: MessageTemplate[] }
  templates: MessageTemplate[]
  monthlyUsage: { count: number; limit: number; tier: string }
  hasReviewLink: boolean
  prefilledCustomer?: Customer | null
  onSuccess?: () => void
}
```

Copy the following from `quick-send-tab.tsx`:
- All useState hooks (email, name, channel, smsBody, selectedTemplateId, schedulePreset, customDateTime, isPending, showSuggestions, highlightedIndex, showFullPreview)
- All useMemo hooks (matchedCustomer, canSendSms, smsDisabledReason, suggestions) -- but NOT recentCustomers (skip the "Recently Added" chips section)
- All useEffect hooks (click outside, channel reset, SMS body default)
- getScheduledFor function
- handleSelectSuggestion, handleKeyDown, handleSubmit functions
- The previewCustomer computation

Changes from QuickSendTab:
1. **Add `prefilledCustomer` prop handling:** In a new useEffect, when `prefilledCustomer` changes and is non-null, set `email` to `prefilledCustomer.email` and `name` to `prefilledCustomer.name`.
2. **Add `onSuccess` prop:** After a successful send in handleSubmit (any success toast), call `onSuccess?.()` in addition to clearing the form.
3. **Remove the "Recently Added" chips section** (the recentCustomers memo and the entire "Recently Added" JSX block). This is send-page-specific and adds clutter to a modal.
4. **Remove the outer Card-like wrapper** (`<div className="bg-card border border-border rounded-lg p-6">`). The modal provides its own container. Just render the form content starting from the section header and form element.
5. **Keep all imports** from the original: SendSettingsBar, MessagePreview, EmailPreviewModal, ChannelSelector, SmsCharacterCounter/SmsCharacterNotice, and all Phosphor icons used.

The form JSX structure is the same as QuickSendTab minus the outer card wrapper and recent customers chips.

**QuickSendModal (components/send/quick-send-modal.tsx):**

Create a Dialog wrapper around QuickSendForm.

```typescript
'use client'

import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog'
import { Warning } from '@phosphor-icons/react'
import Link from 'next/link'
import { QuickSendForm } from './quick-send-form'
import type { Customer, Business, MessageTemplate } from '@/lib/types/database'

interface QuickSendModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  customers: Customer[]
  business: Business & { message_templates?: MessageTemplate[] }
  templates: MessageTemplate[]
  monthlyUsage: { count: number; limit: number; tier: string }
  hasReviewLink: boolean
  prefilledCustomer?: Customer | null
}
```

The modal renders:
1. `<Dialog open={open} onOpenChange={onOpenChange}>`
2. `<DialogContent className="sm:max-w-xl max-h-[90vh] overflow-y-auto">`
3. `<DialogHeader>` with `<DialogTitle>Send One-Off Request</DialogTitle>` and `<DialogDescription>For edge cases only. Campaigns handle review requests automatically.</DialogDescription>`
4. **Friction warning banner** -- copy the EXACT pattern from `send-page-client.tsx` lines 98-115:
   ```tsx
   <div className="flex items-start gap-3 rounded-lg border border-warning-border bg-warning-bg p-4">
     <Warning className="h-5 w-5 text-warning shrink-0 mt-0.5" weight="fill" />
     <div className="text-sm">
       <p className="font-medium text-warning-foreground">
         Campaigns handle review requests automatically
       </p>
       <p className="mt-1 text-warning">
         Manual sending is for one-off situations. For ongoing follow-up, set up a{' '}
         <Link href="/campaigns" className="underline font-medium hover:text-warning-foreground">
           campaign
         </Link>{' '}instead.
       </p>
     </div>
   </div>
   ```
5. `<QuickSendForm {...formProps} prefilledCustomer={prefilledCustomer} onSuccess={() => onOpenChange(false)} />`

The formProps are all the QuickSendForm props except prefilledCustomer and onSuccess (spread the rest).
  </action>
  <verify>`pnpm typecheck` passes. Both new files exist and export their named components.</verify>
  <done>QuickSendForm extracts the reusable form from QuickSendTab. QuickSendModal wraps it in a Dialog with friction warning.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate QuickSendModal into Campaigns page and Customer drawer</name>
  <files>app/(dashboard)/campaigns/page.tsx, components/campaigns/campaigns-page-client.tsx, components/customers/customers-client.tsx, app/(dashboard)/customers/page.tsx</files>
  <action>
The Campaigns page is currently a Server Component. To host the QuickSendModal (which needs client-side open/close state), create a thin client wrapper.

**Step A: Create CampaignsPageClient (components/campaigns/campaigns-page-client.tsx):**

```typescript
'use client'

import { useState } from 'react'
import { PaperPlaneTilt } from '@phosphor-icons/react'
import { Button } from '@/components/ui/button'
import { QuickSendModal } from '@/components/send/quick-send-modal'
import type { Customer, Business, MessageTemplate } from '@/lib/types/database'

interface CampaignsPageClientProps {
  children: React.ReactNode
  customers: Customer[]
  business: Business & { message_templates?: MessageTemplate[] }
  templates: MessageTemplate[]
  monthlyUsage: { count: number; limit: number; tier: string }
  hasReviewLink: boolean
}

export function CampaignsPageClient({
  children,
  customers,
  business,
  templates,
  monthlyUsage,
  hasReviewLink,
}: CampaignsPageClientProps) {
  const [quickSendOpen, setQuickSendOpen] = useState(false)

  return (
    <>
      {children}

      {/* Send one-off button -- positioned at page bottom */}
      <div className="flex justify-end pt-4 border-t">
        <Button
          variant="outline"
          size="sm"
          onClick={() => setQuickSendOpen(true)}
        >
          <PaperPlaneTilt className="mr-2 h-4 w-4" />
          Send one-off request
        </Button>
      </div>

      <QuickSendModal
        open={quickSendOpen}
        onOpenChange={setQuickSendOpen}
        customers={customers}
        business={business}
        templates={templates}
        monthlyUsage={monthlyUsage}
        hasReviewLink={hasReviewLink}
      />
    </>
  )
}
```

**Step B: Update Campaigns page (app/(dashboard)/campaigns/page.tsx):**

Add server-side data fetching for the QuickSendModal props. The modal needs: customers, business, templates, monthlyUsage, hasReviewLink.

1. Add imports:
   ```typescript
   import { getBusiness } from '@/lib/actions/business'
   import { getCustomers } from '@/lib/actions/customer'
   import { getMonthlyUsage } from '@/lib/data/send-logs'
   import { redirect } from 'next/navigation'
   import { CampaignsPageClient } from '@/components/campaigns/campaigns-page-client'
   ```

2. Fetch additional data. At the top of the page function, get business (needed for redirect + modal):
   ```typescript
   const business = await getBusiness()
   if (!business) redirect('/onboarding')
   ```

3. Add to the existing Promise.all or create a second parallel fetch:
   ```typescript
   const [campaigns, presets, templates, { customers }, monthlyUsage] = await Promise.all([
     getCampaigns({ includePresets: false }),
     getCampaignPresets(),
     getAvailableTemplates(),
     getCustomers({ limit: 200 }),
     getMonthlyUsage(),
   ])
   ```

4. Wrap the page content in `CampaignsPageClient`:
   ```tsx
   return (
     <div className="container py-6 space-y-6">
       <CampaignsPageClient
         customers={customers}
         business={business}
         templates={templates}
         monthlyUsage={monthlyUsage}
         hasReviewLink={!!business.google_review_link}
       >
         {/* Existing page content (header + campaigns list/preset picker) */}
         <div className="flex items-center justify-between">
           ...existing header...
         </div>
         {!hasCustomCampaigns ? (
           ...existing empty state...
         ) : (
           ...existing campaign list...
         )}
       </CampaignsPageClient>
     </div>
   )
   ```

   Note: The `templates` variable from `getAvailableTemplates()` returns templates for campaign editing. For the QuickSendModal, we need the business's own templates. The `business` object already has `message_templates` populated via `getBusiness()`. Pass `business.message_templates || []` as the templates prop to `CampaignsPageClient`. For the campaign-related templates, keep using the `templates` from `getAvailableTemplates()` as before. Make sure the prop names are clear -- rename the campaign templates variable if needed:
   ```typescript
   const [campaigns, presets, campaignTemplates, { customers }, monthlyUsage] = ...
   ```
   Then pass `campaignTemplates` to `CampaignList` and `business.message_templates || []` filtered to email-only for the modal:
   ```typescript
   const sendTemplates = (business.message_templates || []).filter(
     (t: { channel: string }) => t.channel === 'email'
   )
   ```

**Step C: Update customers-client.tsx (Customer detail drawer integration):**

In `components/customers/customers-client.tsx`:

1. Add imports:
   ```typescript
   import { QuickSendModal } from '@/components/send/quick-send-modal'
   ```

2. Add state for the modal:
   ```typescript
   const [quickSendOpen, setQuickSendOpen] = useState(false)
   const [quickSendCustomer, setQuickSendCustomer] = useState<Customer | null>(null)
   ```

3. Change the `handleSendFromDrawer` function (currently at line 103-106):
   ```typescript
   const handleSendFromDrawer = () => {
     if (detailCustomer) {
       setQuickSendCustomer(detailCustomer)
       setQuickSendOpen(true)
     }
     setDetailDrawerOpen(false)
   }
   ```
   This opens the modal with the customer pre-filled instead of navigating to `/send`.

4. Render the `QuickSendModal` at the end of the component JSX (before the closing fragment):
   ```tsx
   <QuickSendModal
     open={quickSendOpen}
     onOpenChange={setQuickSendOpen}
     customers={customers}
     business={business}
     templates={templates}
     monthlyUsage={monthlyUsage}
     hasReviewLink={hasReviewLink}
     prefilledCustomer={quickSendCustomer}
   />
   ```

   The `customers-client.tsx` component already receives `customers` as a prop. However, it does NOT currently receive `business`, `templates`, `monthlyUsage`, or `hasReviewLink`. These must be added:

   - Update the `CustomersClientProps` interface to include:
     ```typescript
     business: Business & { message_templates?: MessageTemplate[] }
     templates: MessageTemplate[]
     monthlyUsage: { count: number; limit: number; tier: string }
     hasReviewLink: boolean
     ```

**Step D: Update customers page server component (app/(dashboard)/customers/page.tsx):**

The parent page must fetch and pass the new props to `CustomersClient`.

1. Add imports:
   ```typescript
   import { getBusiness } from '@/lib/actions/business'
   import { getMonthlyUsage } from '@/lib/data/send-logs'
   ```

2. Fetch business and monthlyUsage alongside existing queries. If `getBusiness()` is already called in this page, reuse it. Otherwise add it:
   ```typescript
   const business = await getBusiness()
   if (!business) redirect('/onboarding')
   ```

3. Add `getMonthlyUsage()` to the existing Promise.all or fetch it separately:
   ```typescript
   const monthlyUsage = await getMonthlyUsage()
   ```

4. Derive send templates from business:
   ```typescript
   const sendTemplates = (business.message_templates || []).filter(
     (t: { channel: string }) => t.channel === 'email'
   )
   ```

5. Pass new props to `CustomersClient`:
   ```tsx
   <CustomersClient
     customers={customers}
     business={business}
     templates={sendTemplates}
     monthlyUsage={monthlyUsage}
     hasReviewLink={!!business.google_review_link}
     // ...existing props
   />
   ```

**Important:** Do NOT modify `components/customers/customer-detail-drawer.tsx` directly. The drawer's `onSend` callback is already handled by the parent `customers-client.tsx`. The drawer just calls `onSend(customer)` and the parent decides what to do.
  </action>
  <verify>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. `pnpm build` succeeds
4. Verify that `app/(dashboard)/campaigns/page.tsx` imports and renders CampaignsPageClient with QuickSendModal
5. Verify that `components/customers/customers-client.tsx` no longer has `router.push('/send')` -- it opens the modal instead
6. Verify that `app/(dashboard)/customers/page.tsx` fetches business and monthlyUsage and passes them to CustomersClient
  </verify>
  <done>QuickSendModal is accessible from Campaigns page ("Send one-off request" button) and from Customer detail drawer ("Send Message" button opens modal with customer pre-filled)</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. `pnpm build` succeeds
4. QuickSendForm exists at components/send/quick-send-form.tsx
5. QuickSendModal exists at components/send/quick-send-modal.tsx
6. CampaignsPageClient exists at components/campaigns/campaigns-page-client.tsx
7. Campaigns page shows "Send one-off request" button that opens QuickSendModal
8. Customer detail drawer "Send Message" opens QuickSendModal with customer pre-filled (no router.push('/send'))
9. QuickSendModal shows friction warning banner matching send-page-client.tsx pattern
10. app/(dashboard)/customers/page.tsx fetches getBusiness() and getMonthlyUsage() and passes to CustomersClient
</verification>

<success_criteria>
- QuickSendForm is a standalone reusable form component (no card wrapper, no recent chips)
- QuickSendModal wraps QuickSendForm in Dialog with friction warning
- "Send one-off request" button visible on Campaigns page
- Customer drawer "Send Message" opens modal with pre-filled customer
- No `router.push('/send')` remains in customers-client.tsx
- customers/page.tsx passes business, templates, monthlyUsage, hasReviewLink to CustomersClient
- Production build passes
</success_criteria>

<output>
After completion, create `.planning/phases/39-manual-request-elimination-dashboard-activity-strip/39-03-SUMMARY.md`
</output>
