---
phase: 39-manual-request-elimination-dashboard-activity-strip
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - components/dashboard/recent-campaign-activity.tsx
  - components/dashboard/kpi-widgets.tsx
  - app/(dashboard)/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows only the top 3 outcome KPI cards (Reviews, Rating, Conversion) -- the bottom 3 pipeline cards are gone"
    - "A RecentCampaignActivity strip appears below the KPI cards showing the last 3-5 campaign events"
    - "The activity strip header shows inline counters like '12 active sequences . 3 pending'"
    - "Each activity item is clickable with a status icon, description, and relative timestamp"
    - "When no events exist, the strip shows 'No campaign activity yet -- complete a job to get started'"
    - "A 'View All' link in the strip header navigates to /history"
  artifacts:
    - path: "components/dashboard/recent-campaign-activity.tsx"
      provides: "RecentCampaignActivity strip component"
      contains: "RecentCampaignActivity"
    - path: "components/dashboard/kpi-widgets.tsx"
      provides: "KPI widgets with only top 3 outcome cards"
      contains: "KPIWidgets"
    - path: "app/(dashboard)/dashboard/page.tsx"
      provides: "Dashboard page with activity strip between KPIs and queue"
      contains: "RecentCampaignActivity"
  key_links:
    - from: "app/(dashboard)/dashboard/page.tsx"
      to: "lib/data/dashboard.ts"
      via: "getRecentCampaignEvents call in server component"
      pattern: "getRecentCampaignEvents"
    - from: "components/dashboard/recent-campaign-activity.tsx"
      to: "CampaignEvent type"
      via: "import from lib/types/dashboard"
      pattern: "CampaignEvent"
---

<objective>
Replace the dashboard's 3 bottom pipeline metric cards with a compact RecentCampaignActivity strip showing concrete campaign events.

Purpose: The dashboard should answer "what has the system done for me?" with real activity events, not abstract pipeline numbers. Pipeline numbers are preserved as inline counters in the strip header.
Output: New RecentCampaignActivity component, modified KPIWidgets (top 3 only), updated dashboard page layout
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-manual-request-elimination-dashboard-activity-strip/39-RESEARCH.md
@.planning/phases/39-manual-request-elimination-dashboard-activity-strip/39-01-SUMMARY.md
@components/dashboard/kpi-widgets.tsx
@app/(dashboard)/dashboard/page.tsx
@lib/types/dashboard.ts
@lib/data/dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RecentCampaignActivity strip component</name>
  <files>components/dashboard/recent-campaign-activity.tsx</files>
  <action>
Create a new client component `components/dashboard/recent-campaign-activity.tsx`.

The component receives:
```typescript
interface RecentCampaignActivityProps {
  events: CampaignEvent[]
  pipelineSummary: PipelineSummary
}
```

Import types from `@/lib/types/dashboard`. Import icons from `@phosphor-icons/react`: PaperPlaneTilt (touch_sent), Star (review_click), ChatCircleText (feedback_submitted), UserPlus (enrollment), ArrowRight (View All link). Import `formatDistanceToNow` from `date-fns`. Import `Link` from `next/link`.

**Empty state** (events.length === 0):
Render a Card-like container (`rounded-lg border bg-card px-5 py-4`) with the header "Recent Campaign Activity" and subtext "No campaign activity yet -- complete a job to get started" in text-muted-foreground.

**Populated state:**
1. **Header row** (flex justify-between, mb-3):
   - Left side: "Recent Campaign Activity" (text-sm font-semibold) followed by inline pipeline counters in a span:
     - Format: `{activeSequences} active sequences` -- if pending > 0, append ` · {pending} pending` -- if requestsSentThisWeek > 0, append ` · {requestsSentThisWeek} sent this week`
     - Style: text-xs text-muted-foreground
   - Right side: "View All" link to `/history` (text-sm text-muted-foreground hover:text-foreground, with ArrowRight icon size 14)

2. **Event list** (space-y-1):
   For each event (up to 5), render a row:
   - Icon based on event.type (map: touch_sent->PaperPlaneTilt, review_click->Star, feedback_submitted->ChatCircleText, enrollment->UserPlus), size 16, text-muted-foreground
   - Description text (text-sm, truncate, flex-1):
     - touch_sent: "Touch {touchNumber} {channel} sent to {customerName}" (if channel exists, otherwise just "Touch {touchNumber} sent to {customerName}")
     - review_click: "{customerName} clicked review link"
     - feedback_submitted: "{customerName} left {rating}-star feedback"
     - enrollment: "{customerName} enrolled in {campaignName}"
   - Relative timestamp (text-xs text-muted-foreground whitespace-nowrap): `formatDistanceToNow(new Date(event.timestamp), { addSuffix: true })`

   Each row is a `div` (not button -- we are not implementing detail drawer click in this plan, just layout):
   - className: "flex items-center gap-3 rounded px-2 py-1.5"

Wrap in outer container: `<div className="rounded-lg border bg-card px-5 py-4">`.

Also export a `RecentCampaignActivitySkeleton` function that renders a matching skeleton:
- Header row with two Skeleton blocks
- 3 event rows, each with a small circle skeleton (h-4 w-4), text skeleton (h-4 w-48), timestamp skeleton (h-3 w-16)
  </action>
  <verify>`pnpm typecheck` passes. The component file exists and exports RecentCampaignActivity and RecentCampaignActivitySkeleton.</verify>
  <done>RecentCampaignActivity component renders campaign events with inline pipeline counters, empty state, and View All link to /history</done>
</task>

<task type="auto">
  <name>Task 2: Remove pipeline cards from KPIWidgets and wire activity strip into dashboard</name>
  <files>components/dashboard/kpi-widgets.tsx, app/(dashboard)/dashboard/page.tsx</files>
  <action>
**kpi-widgets.tsx changes:**

1. Remove the entire bottom row section (lines 120-178 in the current file -- the `<div className="grid grid-cols-1 md:grid-cols-3 gap-3">` block containing the 3 pipeline Card components: "Requests Sent This Week", "Active Sequences", "Pending / Queued").

2. Keep the top row (outcome metrics) exactly as-is. Keep the `space-y-4 mb-6` wrapper div but since there is only one child now, consider simplifying to just `mb-6` on the grid div. Actually, keep the wrapper `<div className="space-y-4 mb-6">` with the single grid child inside -- it is harmless and maintains consistent spacing.

3. Update the `KPIWidgetsSkeleton` function: Remove the bottom row skeleton section (the `<div className="grid grid-cols-1 md:grid-cols-3 gap-3">` block with 3 skeleton cards). Keep only the top row skeleton (3 outcome metric skeleton cards).

**The KPIWidgets props stay the same** -- it still receives `data: DashboardKPIs`. The pipeline values in data are just not rendered as cards anymore. They will be passed separately to the activity strip.

**dashboard/page.tsx changes:**

1. Add imports at the top:
   ```typescript
   import { getRecentCampaignEvents } from '@/lib/data/dashboard'
   import { RecentCampaignActivity } from '@/components/dashboard/recent-campaign-activity'
   import type { PipelineSummary } from '@/lib/types/dashboard'
   ```

2. In the `Promise.all` call, add `getRecentCampaignEvents(business.id)` as a 5th parallel query:
   ```typescript
   const [kpiData, readyJobs, alerts, jobCounts, recentEvents] = await Promise.all([
     getDashboardKPIs(business.id),
     getReadyToSendJobs(business.id, serviceTypeTiming),
     getAttentionAlerts(business.id),
     getJobCounts(),
     getRecentCampaignEvents(business.id),
   ])
   ```

3. Build the pipeline summary from kpiData (after the Promise.all):
   ```typescript
   const pipelineSummary: PipelineSummary = {
     activeSequences: kpiData.activeSequences.value,
     pending: kpiData.pendingQueued.value,
     requestsSentThisWeek: kpiData.requestsSentThisWeek.value,
   }
   ```

4. In the JSX return, insert `<RecentCampaignActivity>` between `<KPIWidgets>` and `<ReadyToSendQueue>`:
   ```tsx
   <KPIWidgets data={kpiData} />
   <RecentCampaignActivity events={recentEvents} pipelineSummary={pipelineSummary} />
   <ReadyToSendQueue jobs={readyJobs} hasJobHistory={jobCounts.total > 0} />
   <AttentionAlerts alerts={alerts} />
   ```
  </action>
  <verify>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. `pnpm build` succeeds (production build verifies server component data fetching)
4. Verify in kpi-widgets.tsx that the bottom 3 pipeline cards are completely removed and only the top 3 outcome cards remain
  </verify>
  <done>Dashboard shows 3 outcome KPI cards + RecentCampaignActivity strip + ReadyToSendQueue + AttentionAlerts. No pipeline card components exist.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. `pnpm build` succeeds
4. kpi-widgets.tsx has only 3 outcome cards (Reviews, Rating, Conversion) -- no pipeline cards
5. KPIWidgetsSkeleton has only 3 skeleton cards
6. RecentCampaignActivity component exists with events + pipelineSummary props
7. Dashboard page fetches recentEvents and passes pipelineSummary derived from kpiData
8. Activity strip shows inline counters, event list, View All link, and empty state
</verification>

<success_criteria>
- Bottom 3 pipeline metric cards removed from kpi-widgets.tsx
- RecentCampaignActivity strip created with event list, inline counters, empty state
- Dashboard page wires data from getRecentCampaignEvents + getDashboardKPIs into the strip
- Pipeline numbers preserved as inline counters (not lost)
- Production build passes
</success_criteria>

<output>
After completion, create `.planning/phases/39-manual-request-elimination-dashboard-activity-strip/39-02-SUMMARY.md`
</output>
