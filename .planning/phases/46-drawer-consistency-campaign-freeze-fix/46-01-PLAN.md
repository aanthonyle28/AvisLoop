---
phase: 46-drawer-consistency-campaign-freeze-fix
plan: 46-01
title: "Supabase migration: add frozen enrollment status + update TypeScript types + update deleteCampaign queries"
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260226_add_frozen_enrollment_status.sql
  - lib/types/database.ts
  - lib/actions/campaign.ts
autonomous: true
---

## Objective

Add `frozen` to the campaign enrollment status constraint, expand the partial unique index to prevent duplicate frozen+active enrollments, update the TypeScript type, and update `deleteCampaign` + `getCampaignDeletionInfo` to handle frozen enrollments. This migration unblocks all other campaign freeze work in 46-02.

## Context

@components/ui/sheet.tsx (reference for later plans, not modified here)
@lib/types/database.ts (line 311: `EnrollmentStatus` type)
@lib/actions/campaign.ts (lines 190-220: getCampaignDeletionInfo; lines 255-354: deleteCampaign)
@supabase/migrations/20260204_create_campaign_enrollments.sql (lines 44-47: status constraint; line 68: unique index)
@.planning/phases/46-drawer-consistency-campaign-freeze-fix/46-RESEARCH.md

## Tasks

<task id="1">
Create a new Supabase migration file at `supabase/migrations/20260226_add_frozen_enrollment_status.sql`.

The migration must do TWO things:

1. **ALTER the status CHECK constraint** to include `'frozen'`:
```sql
ALTER TABLE public.campaign_enrollments
  DROP CONSTRAINT enrollments_status_valid,
  ADD CONSTRAINT enrollments_status_valid CHECK (
    status IN ('active', 'completed', 'stopped', 'frozen')
  );
```

2. **Expand the partial unique index** to prevent duplicate frozen+active enrollments for the same customer+campaign:
```sql
DROP INDEX IF EXISTS idx_enrollments_unique_active;
CREATE UNIQUE INDEX idx_enrollments_unique_active
  ON public.campaign_enrollments (customer_id, campaign_id)
  WHERE status IN ('active', 'frozen');
```

The migration file should have a comment header explaining the purpose: "Add 'frozen' status for campaign pause/resume. Frozen enrollments preserve touch position while campaign is paused."
</task>

<task id="2">
Update the TypeScript `EnrollmentStatus` type in `lib/types/database.ts`.

**Current (line 311):**
```typescript
export type EnrollmentStatus = 'active' | 'completed' | 'stopped'
```

**Change to:**
```typescript
export type EnrollmentStatus = 'active' | 'completed' | 'stopped' | 'frozen'
```

This is the only change in this file.
</task>

<task id="3">
Update `getCampaignDeletionInfo` in `lib/actions/campaign.ts` to count frozen enrollments as in-progress.

**Current (around line 197-203):**
The function queries `.eq('status', 'active')` to count active enrollments.

**Change:** Replace `.eq('status', 'active')` with `.in('status', ['active', 'frozen'])` in the enrollment count query.

Then update `deleteCampaign` in the same file in three places:

**Place 1 — Reassign branch, fetch enrollments (around line 262-267):**
Change `.eq('status', 'active')` to `.in('status', ['active', 'frozen'])` so frozen enrollments are also fetched for reassignment.

**Place 2 — Reassign branch, stop old enrollments (around line 270-279):**
Change `.eq('status', 'active')` to `.in('status', ['active', 'frozen'])` so frozen enrollments are stopped when deleting.

**Place 3 — Reassign branch, check existing in target (around line 294-298):**
Change `.eq('status', 'active')` to `.in('status', ['active', 'frozen'])` so we don't try to reassign a customer who already has a frozen enrollment in the target campaign.

**Place 4 — No-reassign branch, stop enrollments (around line 328-339):**
Change `.eq('status', 'active')` to `.in('status', ['active', 'frozen'])` so frozen enrollments are stopped when deleting without reassignment.

All four changes are `.eq('status', 'active')` -> `.in('status', ['active', 'frozen'])` within the `deleteCampaign` function and `getCampaignDeletionInfo` function.
</task>

## Verification

After all tasks:

1. `pnpm typecheck` passes — `'frozen'` is a valid `EnrollmentStatus` value
2. The migration file exists at `supabase/migrations/20260226_add_frozen_enrollment_status.sql` and contains both the ALTER CONSTRAINT and DROP/CREATE INDEX statements
3. `lib/types/database.ts` line 311 includes `'frozen'` in the union type
4. `grep -c "\.in\('status', \['active', 'frozen'\]\)" lib/actions/campaign.ts` returns at least 5 (the getCampaignDeletionInfo query + 4 deleteCampaign queries)
5. No remaining `.eq('status', 'active')` in `getCampaignDeletionInfo` or `deleteCampaign` functions that should include frozen (the `stopEnrollment` function at line ~488 should still use `.eq('status', 'active')` since it stops a single enrollment by ID and frozen enrollments should be unfrozen, not individually stopped)

## must_haves

- [ ] Migration file adds `'frozen'` to the CHECK constraint and expands the partial unique index to `WHERE status IN ('active', 'frozen')`
- [ ] TypeScript `EnrollmentStatus` type includes `'frozen'`
- [ ] `getCampaignDeletionInfo` counts frozen enrollments as in-progress
- [ ] `deleteCampaign` handles frozen enrollments in all 4 query locations (fetch, stop-reassign, check-existing-in-target, stop-no-reassign)
- [ ] `pnpm typecheck` passes
