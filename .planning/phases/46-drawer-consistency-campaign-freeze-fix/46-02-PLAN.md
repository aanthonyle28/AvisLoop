---
phase: 46-drawer-consistency-campaign-freeze-fix
plan: 46-02
title: "Fix toggleCampaignStatus to freeze/unfreeze enrollments + audit all frozen-aware queries across codebase"
wave: 2
depends_on: [46-01]
files_modified:
  - lib/actions/campaign.ts
  - lib/actions/enrollment.ts
  - lib/actions/customer.ts
  - lib/data/campaign.ts
  - lib/data/dashboard.ts
  - app/api/cron/resolve-enrollment-conflicts/route.ts
autonomous: true
---

## Objective

Fix the core bug: `toggleCampaignStatus` must freeze enrollments on pause (not permanently destroy them) and unfreeze on resume. Then audit and update every query across the codebase that checks enrollment status to correctly treat `frozen` as "in progress" where appropriate.

## Context

@lib/actions/campaign.ts (lines 430-477: toggleCampaignStatus — THE BUG)
@lib/actions/enrollment.ts (lines 44-99: checkEnrollmentConflict; lines 104-120: cancelActiveEnrollments; lines 126-152: stopEnrollmentsForJob)
@lib/actions/customer.ts (lines 940-956: optOutCustomerEmail stops active enrollments)
@lib/data/campaign.ts (lines 205-234: getCampaignEnrollmentCounts)
@lib/data/dashboard.ts (lines 127-139: active sequences KPI; lines 314-331: conflict detection; lines 344-361: preflight conflict; lines 770: job detail activeEnrollment find; lines 799-806: job detail preflight)
@app/api/cron/resolve-enrollment-conflicts/route.ts (lines 92-101: Task B active enrollment check)
@.planning/phases/46-drawer-consistency-campaign-freeze-fix/46-RESEARCH.md

## Tasks

<task id="1">
Rewrite `toggleCampaignStatus` in `lib/actions/campaign.ts` (lines 461-472).

**Current behavior (THE BUG):**
When pausing, sets `status='stopped'` + `stop_reason='campaign_paused'` + `stopped_at=now`. This permanently destroys enrollments.

**New behavior — On pause (newStatus === 'paused'):**
Replace the entire block (lines 462-472) with:
```typescript
if (newStatus === 'paused') {
  // Freeze active enrollments (preserves touch position for later resume)
  await supabase
    .from('campaign_enrollments')
    .update({ status: 'frozen' })
    .eq('campaign_id', campaignId)
    .eq('status', 'active')
}
```
Do NOT set `stop_reason`, `stopped_at`, or any terminal fields. Frozen is a non-terminal state.

**New behavior — On resume (newStatus === 'active'):**
Add a NEW block after the pause block:
```typescript
if (newStatus === 'active') {
  // Unfreeze frozen enrollments and adjust stale scheduled times
  const { data: frozenEnrollments } = await supabase
    .from('campaign_enrollments')
    .select('id, current_touch, touch_1_scheduled_at, touch_2_scheduled_at, touch_3_scheduled_at, touch_4_scheduled_at')
    .eq('campaign_id', campaignId)
    .eq('status', 'frozen')

  const now = new Date().toISOString()

  for (const enrollment of frozenEnrollments || []) {
    const touchKey = `touch_${enrollment.current_touch}_scheduled_at` as const
    const originalScheduled = enrollment[touchKey as keyof typeof enrollment] as string | null

    const updateData: Record<string, unknown> = { status: 'active' }

    // If the next touch was scheduled in the past, bump to now so it processes in next cron cycle
    if (originalScheduled && new Date(originalScheduled) < new Date()) {
      updateData[`touch_${enrollment.current_touch}_scheduled_at`] = now
    }

    await supabase
      .from('campaign_enrollments')
      .update(updateData)
      .eq('id', enrollment.id)
  }
}
```

Also update the JSDoc comment for `toggleCampaignStatus` (line 430-431) from:
```
Toggle campaign status (pause/resume). Pausing stops all active enrollments.
```
to:
```
Toggle campaign status (pause/resume). Pausing freezes active enrollments (preserving touch position). Resuming unfreezes them and adjusts stale scheduled times.
```
</task>

<task id="2">
Update enrollment conflict and cancellation queries in `lib/actions/enrollment.ts` to include frozen status where appropriate.

**Change 1 — `checkEnrollmentConflict` (line 57):**
Change `.eq('status', 'active')` to `.in('status', ['active', 'frozen'])`.
A frozen enrollment means the customer is still in a sequence — it must count as a conflict.

**Change 2 — `cancelActiveEnrollments` (line 116):**
Change `.eq('status', 'active')` to `.in('status', ['active', 'frozen'])`.
When replacing enrollments for a repeat job, frozen enrollments must also be canceled.

**Change 3 — `stopEnrollmentsForJob` (line 144):**
Change `.eq('status', 'active')` to `.in('status', ['active', 'frozen'])`.
When stopping enrollments for a job (e.g., editing a job's campaign), frozen enrollments for that job should also be stopped.

Then update the email opt-out function in `lib/actions/customer.ts`.

**Change 4 — `optOutCustomerEmail` (around line 943-951):**
Change `.eq('status', 'active')` to `.in('status', ['active', 'frozen'])`.
When a customer opts out, frozen enrollments must also be stopped.
</task>

<task id="3">
Update dashboard and campaign data queries to include frozen where appropriate.

**File: `lib/data/campaign.ts`**

**Change 1 — `getCampaignEnrollmentCounts` (lines 211-233):**
Add a fourth parallel query for frozen count, and return it in the result object:
```typescript
const [activeResult, completedResult, stoppedResult, frozenResult] = await Promise.all([
  // ... existing three queries ...
  supabase
    .from('campaign_enrollments')
    .select('*', { count: 'exact', head: true })
    .eq('campaign_id', campaignId)
    .eq('status', 'frozen'),
])

return {
  active: activeResult.count || 0,
  completed: completedResult.count || 0,
  stopped: stoppedResult.count || 0,
  frozen: frozenResult.count || 0,
}
```
Update the return type to include `frozen: number`.

**File: `lib/data/dashboard.ts`**

**Change 2 — Active sequences KPI (line 131):**
Change `.eq('status', 'active')` to `.in('status', ['active', 'frozen'])`.
Frozen enrollments ARE paused sequences — they count toward the "Active Sequences" KPI.

**Change 3 — Active sequences 7 days ago (line 138):**
Change `.eq('status', 'active')` to `.in('status', ['active', 'frozen'])`.
Same reasoning — must include frozen for accurate trend comparison.

**Change 4 — Conflict detection batch (line 320):**
Change `.eq('status', 'active')` to `.in('status', ['active', 'frozen'])`.
Frozen enrollments mean the customer has an in-progress sequence for conflict purposes.

**Change 5 — Preflight conflict detection (line 351):**
Change `.eq('status', 'active')` to `.in('status', ['active', 'frozen'])`.
Same reasoning as conflict detection.

**Change 6 — Job detail enrichment: find active enrollment (line 770):**
Change `enrollments.find(e => e.status === 'active')` to `enrollments.find(e => e.status === 'active' || e.status === 'frozen')`.
This is JavaScript filtering on already-fetched data, so the Supabase query at line 749-752 that fetches `campaign_enrollments` does not need status filtering (it fetches all enrollments for the job).

**Change 7 — Job detail preflight conflict (line 804):**
Change `.eq('status', 'active')` to `.in('status', ['active', 'frozen'])`.
Frozen enrollment counts as an active sequence for conflict detection.

**File: `app/api/cron/resolve-enrollment-conflicts/route.ts`**

**Change 8 — Task B active enrollment check (line 100):**
Change `.eq('status', 'active')` to `.in('status', ['active', 'frozen'])`.
A frozen enrollment means the customer is still conceptually in a sequence — queued jobs should NOT be enrolled while the enrollment is frozen.
</task>

## Verification

After all tasks:

1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. In `toggleCampaignStatus`: the pause block sets `status: 'frozen'` (NOT `stopped`), does NOT set `stop_reason` or `stopped_at`
4. In `toggleCampaignStatus`: the resume block queries `status: 'frozen'`, sets them to `active`, and adjusts stale scheduled times using `MAX(original, NOW())` logic
5. `checkEnrollmentConflict` uses `.in('status', ['active', 'frozen'])`
6. `cancelActiveEnrollments` uses `.in('status', ['active', 'frozen'])`
7. `stopEnrollmentsForJob` uses `.in('status', ['active', 'frozen'])`
8. `optOutCustomerEmail` in customer.ts uses `.in('status', ['active', 'frozen'])`
9. `getCampaignEnrollmentCounts` returns a `frozen` count
10. Dashboard active sequences KPI includes frozen
11. Conflict resolver Task B includes frozen in active enrollment check
12. No remaining `.eq('status', 'active')` in enrollment queries that should include frozen (the `stopEnrollment` single-enrollment function is an exception — it operates on a specific enrollment by ID, not a customer-wide query)

## must_haves

- [ ] Pausing a campaign sets in-progress enrollments to `frozen` status — they are NOT marked `stopped` and do NOT lose remaining touches
- [ ] Re-enabling a paused campaign unfreezes all `frozen` enrollments — they resume from the same touch position with stale scheduled times bumped to NOW
- [ ] The cron processor skips `frozen` enrollments (automatic — RPC only queries `status='active'`)
- [ ] Conflict detection treats `frozen` as "in progress" (checkEnrollmentConflict, dashboard conflict detection, cron conflict resolver Task B)
- [ ] `getCampaignEnrollmentCounts` returns a frozen count alongside active/completed/stopped
- [ ] `pnpm typecheck` and `pnpm lint` pass
