---
phase: 32-post-onboarding-guidance
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - lib/data/checklist.ts
  - lib/actions/checklist.ts
  - components/onboarding/getting-started-checklist.tsx
autonomous: true

must_haves:
  truths:
    - "Checklist state auto-computed from actual data (jobs count, campaigns count, etc.)"
    - "User can dismiss checklist and dismissal persists in database"
    - "Checklist items link to relevant pages with clear CTAs"
    - "Checklist shows progress (e.g., 2 of 4 complete)"
  artifacts:
    - path: "lib/data/checklist.ts"
      provides: "Server function to compute checklist state from actual data"
      exports: ["getChecklistState"]
    - path: "lib/actions/checklist.ts"
      provides: "Server action to dismiss/collapse checklist"
      exports: ["updateChecklistState"]
    - path: "components/onboarding/getting-started-checklist.tsx"
      provides: "Dashboard checklist card component"
      exports: ["GettingStartedChecklist"]
  key_links:
    - from: "lib/data/checklist.ts"
      to: "lib/data/jobs.ts"
      via: "Job count query"
      pattern: "getJobCount"
    - from: "lib/data/checklist.ts"
      to: "lib/data/campaign.ts"
      via: "Campaign count query"
      pattern: "getCampaign"
    - from: "components/onboarding/getting-started-checklist.tsx"
      to: "lib/data/checklist.ts"
      via: "State fetch"
      pattern: "getChecklistState"
---

<objective>
Create data functions for checklist state computation and the Getting Started Checklist UI component. The checklist auto-detects completion by querying actual data (jobs, campaigns, reviews).

Purpose: Main feature component for post-onboarding guidance. Shows new users what to do next and tracks their progress.
Output: Data functions, server action, and checklist card component.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-post-onboarding-guidance/32-RESEARCH.md
@.planning/V1-TO-V2-PHILOSOPHY.md
@lib/data/jobs.ts
@lib/data/campaign.ts
@lib/data/dashboard.ts
@lib/types/database.ts
@components/dashboard/kpi-widgets.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create checklist data function</name>
  <files>
    lib/data/checklist.ts
  </files>
  <action>
Create `lib/data/checklist.ts` with server function to compute checklist state:

```typescript
import { createClient } from '@/lib/supabase/server'
import type { OnboardingChecklist } from '@/lib/types/database'

/**
 * Checklist items definition - V2 aligned
 * DO NOT add customer-related items (V1 pattern)
 *
 * Updated 2026-02-06: Changed "Set up campaign" to "Review your campaign"
 * since users already pick preset during onboarding. Changed to track actual
 * review clicks (funnel success) via campaign_enrollments.stop_reason.
 */
export const CHECKLIST_ITEMS = [
  {
    id: 'first_job_added' as const,
    title: 'Add your first job',
    description: 'Log a job to start collecting reviews',
    href: '/jobs?action=add',
    cta: 'Add Job',
  },
  {
    id: 'campaign_reviewed' as const,
    title: 'Review your campaign',
    description: 'Check your timing and message sequence',
    href: '/campaigns',
    cta: 'View Campaign',
  },
  {
    id: 'job_completed' as const,
    title: 'Complete a job',
    description: 'Mark a job as completed to trigger automation',
    href: '/jobs',
    cta: 'View Jobs',
  },
  {
    id: 'first_review_click' as const,
    title: 'Get your first review click',
    description: 'A customer clicked through to leave a review',
    href: '/analytics',
    cta: 'View Analytics',
    // Detection: campaign_enrollments.stop_reason = 'review_clicked' > 0
    // This is actual funnel success â€” customer went to Google
  },
] as const

export type ChecklistItemId = typeof CHECKLIST_ITEMS[number]['id']

/**
 * Compute checklist state by querying actual data
 * More reliable than manual tracking - reflects real state
 */
export async function getChecklistState(businessId: string): Promise<{
  items: Record<ChecklistItemId, boolean>
  dismissed: boolean
  dismissedAt: string | null
  collapsed: boolean
  firstSeenAt: string | null
  allComplete: boolean
  completedCount: number
}> {
  const supabase = await createClient()

  // Parallel fetch all counts needed
  const [jobsResult, completedJobsResult, campaignsResult, reviewClicksResult, businessResult] = await Promise.all([
    // Count all jobs
    supabase
      .from('jobs')
      .select('id', { count: 'exact', head: true })
      .eq('business_id', businessId),

    // Count completed jobs
    supabase
      .from('jobs')
      .select('id', { count: 'exact', head: true })
      .eq('business_id', businessId)
      .eq('status', 'completed'),

    // Count active campaigns
    supabase
      .from('campaigns')
      .select('id', { count: 'exact', head: true })
      .eq('business_id', businessId)
      .eq('status', 'active'),

    // Count review clicks (funnel success - customer clicked through to Google)
    // This tracks campaign_enrollments stopped with 'review_clicked' reason
    supabase
      .from('campaign_enrollments')
      .select('id', { count: 'exact', head: true })
      .eq('business_id', businessId)
      .eq('stop_reason', 'review_clicked'),

    // Get stored checklist state (for dismissed/collapsed flags)
    supabase
      .from('businesses')
      .select('onboarding_checklist')
      .eq('id', businessId)
      .single(),
  ])

  const jobCount = jobsResult.count ?? 0
  const completedJobCount = completedJobsResult.count ?? 0
  const campaignCount = campaignsResult.count ?? 0
  const reviewClickCount = reviewClicksResult.count ?? 0

  // Parse stored checklist state
  const storedChecklist = businessResult.data?.onboarding_checklist as OnboardingChecklist | null
  const dismissed = storedChecklist?.dismissed ?? false
  const dismissedAt = storedChecklist?.dismissed_at ?? null
  const collapsed = storedChecklist?.collapsed ?? false
  const firstSeenAt = storedChecklist?.first_seen_at ?? null

  // Compute item completion from actual data
  const items: Record<ChecklistItemId, boolean> = {
    first_job_added: jobCount > 0,
    campaign_reviewed: campaignCount > 0, // Has active campaign (from onboarding preset)
    job_completed: completedJobCount > 0,
    first_review_click: reviewClickCount > 0, // Actual funnel success
  }

  const completedCount = Object.values(items).filter(Boolean).length
  const allComplete = completedCount === CHECKLIST_ITEMS.length

  return {
    items,
    dismissed,
    dismissedAt,
    collapsed,
    firstSeenAt,
    allComplete,
    completedCount,
  }
}
```

Key features:
- Auto-detects completion from actual data counts
- Parallel queries for performance
- Tracks actual review clicks (funnel success) via campaign_enrollments.stop_reason
- Returns dismissed/collapsed state from stored JSONB
- Supports auto-collapse after 3 days via firstSeenAt timestamp
- Computes completedCount and allComplete for UI
  </action>
  <verify>
    `pnpm typecheck` passes with no errors
  </verify>
  <done>
    getChecklistState function created with auto-detection logic and parallel queries
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dismiss checklist server action</name>
  <files>
    lib/actions/checklist.ts
  </files>
  <action>
Create `lib/actions/checklist.ts` with server action to dismiss checklist:

```typescript
"use server"

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'

/**
 * Dismiss or collapse the Getting Started checklist
 * Sets dismissed=true or collapsed=true in onboarding_checklist JSONB
 */
export async function updateChecklistState(
  action: 'dismiss' | 'collapse' | 'expand' | 'markSeen'
): Promise<{ success: boolean; error?: string }> {
  try {
    const supabase = await createClient()

    // Get current user's business
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
      return { success: false, error: 'Not authenticated' }
    }

    const { data: business } = await supabase
      .from('businesses')
      .select('id, onboarding_checklist')
      .eq('user_id', user.id)
      .single()

    if (!business) {
      return { success: false, error: 'Business not found' }
    }

    // Update checklist based on action
    const currentChecklist = business.onboarding_checklist || {}
    const now = new Date().toISOString()

    let updatedChecklist = { ...currentChecklist }
    switch (action) {
      case 'dismiss':
        updatedChecklist.dismissed = true
        updatedChecklist.dismissed_at = now
        break
      case 'collapse':
        updatedChecklist.collapsed = true
        break
      case 'expand':
        updatedChecklist.collapsed = false
        break
      case 'markSeen':
        // Set first_seen_at if not already set (for auto-collapse timing)
        if (!updatedChecklist.first_seen_at) {
          updatedChecklist.first_seen_at = now
        }
        break
    }

    const { error } = await supabase
      .from('businesses')
      .update({ onboarding_checklist: updatedChecklist })
      .eq('id', business.id)

    if (error) {
      console.error('Failed to dismiss checklist:', error)
      return { success: false, error: 'Failed to update checklist' }
    }

    // Revalidate dashboard to refresh checklist state
    revalidatePath('/dashboard')

    return { success: true }
  } catch (err) {
    console.error('dismissChecklist error:', err)
    return { success: false, error: 'An unexpected error occurred' }
  }
}
```

Key features:
- Authenticates user before updating
- Merges dismissed flag into existing JSONB (preserves other data)
- Sets dismissed_at timestamp for analytics
- Revalidates dashboard after update
- Returns structured success/error response
  </action>
  <verify>
    `pnpm typecheck` passes with no errors
  </verify>
  <done>
    dismissChecklist server action created with proper auth and JSONB update
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Getting Started Checklist component</name>
  <files>
    components/onboarding/getting-started-checklist.tsx
  </files>
  <action>
Create `components/onboarding/getting-started-checklist.tsx`:

```tsx
"use client"

import { useState, useTransition, useEffect } from 'react'
import Link from 'next/link'
import { X, Check, Circle, ArrowRight, CaretDown, CaretUp } from '@phosphor-icons/react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { updateChecklistState } from '@/lib/actions/checklist'
import { CHECKLIST_ITEMS, type ChecklistItemId } from '@/lib/data/checklist'
import { cn } from '@/lib/utils'
import { toast } from 'sonner'

interface GettingStartedChecklistProps {
  items: Record<ChecklistItemId, boolean>
  completedCount: number
  allComplete: boolean
  collapsed: boolean
  firstSeenAt: string | null
}

/**
 * Getting Started Checklist - Dashboard card for new users
 *
 * V2-aligned: Guides users through job completion workflow
 * - Add job -> Review campaign -> Complete job -> Get review click
 *
 * Behavior:
 * - Auto-collapses after 3 days (shows header only, expandable)
 * - User can dismiss with X button anytime
 * - Shows congratulations when all complete
 */
export function GettingStartedChecklist({
  items,
  completedCount,
  allComplete,
  collapsed: initialCollapsed,
  firstSeenAt,
}: GettingStartedChecklistProps) {
  const [isPending, startTransition] = useTransition()
  const [showCongrats, setShowCongrats] = useState(allComplete)
  const [isDismissed, setIsDismissed] = useState(false)
  const [isCollapsed, setIsCollapsed] = useState(initialCollapsed)

  // Auto-collapse after 3 days
  useEffect(() => {
    if (firstSeenAt && !isCollapsed) {
      const firstSeen = new Date(firstSeenAt)
      const threeDaysLater = new Date(firstSeen.getTime() + 3 * 24 * 60 * 60 * 1000)
      if (new Date() > threeDaysLater) {
        setIsCollapsed(true)
        startTransition(async () => {
          await updateChecklistState('collapse')
        })
      }
    }
  }, [firstSeenAt, isCollapsed])

  // Mark as seen on first render
  useEffect(() => {
    if (!firstSeenAt) {
      startTransition(async () => {
        await updateChecklistState('markSeen')
      })
    }
  }, [firstSeenAt])

  const handleDismiss = () => {
    startTransition(async () => {
      const result = await updateChecklistState('dismiss')
      if (result.success) {
        setIsDismissed(true)
      } else {
        toast.error(result.error || 'Failed to dismiss checklist')
      }
    })
  }

  const handleToggleCollapse = () => {
    const newCollapsed = !isCollapsed
    setIsCollapsed(newCollapsed)
    startTransition(async () => {
      await updateChecklistState(newCollapsed ? 'collapse' : 'expand')
    })
  }

  // Don't render if dismissed
  if (isDismissed) {
    return null
  }

  // Show congratulations message when all complete
  if (showCongrats) {
    return (
      <Card className="border-green-200 dark:border-green-800 bg-green-50/50 dark:bg-green-950/20">
        <CardContent className="p-6">
          <div className="flex items-start justify-between gap-4">
            <div className="flex items-center gap-3">
              <div className="h-10 w-10 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center">
                <Check size={24} weight="bold" className="text-green-600 dark:text-green-400" />
              </div>
              <div>
                <h3 className="font-semibold text-green-900 dark:text-green-100">
                  You are all set!
                </h3>
                <p className="text-sm text-green-700 dark:text-green-300">
                  Great job completing your setup. AvisLoop is now working for you.
                </p>
              </div>
            </div>
            <Button
              variant="ghost"
              size="icon"
              onClick={handleDismiss}
              disabled={isPending}
              className="text-green-600 hover:text-green-700 hover:bg-green-100 dark:text-green-400 dark:hover:bg-green-900"
            >
              <X size={20} />
              <span className="sr-only">Dismiss</span>
            </Button>
          </div>
        </CardContent>
      </Card>
    )
  }

  return (
    <Card>
      <CardHeader className={cn("pb-3", isCollapsed && "pb-4")}>
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div>
              <CardTitle className="text-lg">Getting Started</CardTitle>
              <p className="text-sm text-muted-foreground">
                {completedCount} of {CHECKLIST_ITEMS.length} complete
              </p>
            </div>
          </div>
          <div className="flex items-center gap-1">
            <Button
              variant="ghost"
              size="icon"
              onClick={handleToggleCollapse}
              disabled={isPending}
              className="text-muted-foreground hover:text-foreground"
            >
              {isCollapsed ? <CaretDown size={20} /> : <CaretUp size={20} />}
              <span className="sr-only">{isCollapsed ? 'Expand' : 'Collapse'} checklist</span>
            </Button>
            <Button
              variant="ghost"
              size="icon"
              onClick={handleDismiss}
              disabled={isPending}
              className="text-muted-foreground hover:text-foreground"
            >
              <X size={20} />
              <span className="sr-only">Dismiss checklist</span>
            </Button>
          </div>
        </div>
        {/* Progress bar - always visible */}
        <div className="mt-3 h-2 bg-muted rounded-full overflow-hidden">
          <div
            className="h-full bg-primary transition-all duration-300"
            style={{ width: `${(completedCount / CHECKLIST_ITEMS.length) * 100}%` }}
          />
        </div>
      </CardHeader>

      {/* Collapsible content */}
      {!isCollapsed && (
        <CardContent className="pt-0">
          <ul className="space-y-3">
            {CHECKLIST_ITEMS.map((item) => {
              const isComplete = items[item.id]
              return (
                <li key={item.id}>
                  <Link
                    href={item.href}
                    className={cn(
                      'flex items-start gap-3 p-3 rounded-lg transition-colors',
                      isComplete
                        ? 'bg-muted/50'
                        : 'hover:bg-muted/50 group'
                    )}
                  >
                    <div className={cn(
                      'mt-0.5 h-5 w-5 rounded-full flex items-center justify-center shrink-0',
                      isComplete
                        ? 'bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400'
                        : 'border-2 border-muted-foreground/30 text-transparent'
                    )}>
                      {isComplete ? (
                        <Check size={14} weight="bold" />
                      ) : (
                        <Circle size={14} />
                      )}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className={cn(
                        'font-medium text-sm',
                        isComplete && 'line-through text-muted-foreground'
                      )}>
                        {item.title}
                      </p>
                      <p className="text-xs text-muted-foreground mt-0.5">
                        {item.description}
                      </p>
                    </div>
                    {!isComplete && (
                      <ArrowRight
                        size={16}
                        className="mt-1 text-muted-foreground opacity-0 group-hover:opacity-100 transition-opacity shrink-0"
                      />
                    )}
                  </Link>
                </li>
              )
            })}
          </ul>
        </CardContent>
      )}
    </Card>
  )
}
```

Key features:
- Progress bar showing X of 4 complete
- Each item links to relevant page with hover state
- Completed items show checkmark and strikethrough
- Incomplete items show arrow on hover (affordance)
- Dismiss button (X) hides checklist
- Congratulations message when all complete
- Proper accessibility (sr-only labels, focus states)
- Matches design system (Card, colors, typography)
  </action>
  <verify>
    `pnpm typecheck` passes, `pnpm lint` passes
  </verify>
  <done>
    GettingStartedChecklist component created with progress tracking, item linking, and dismiss functionality
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` - No type errors
2. `pnpm lint` - No lint errors
3. `pnpm build` - Build succeeds
4. lib/data/checklist.ts exports getChecklistState and CHECKLIST_ITEMS
5. lib/actions/checklist.ts exports dismissChecklist
6. components/onboarding/getting-started-checklist.tsx exports GettingStartedChecklist
7. Checklist items are V2-aligned (jobs, campaigns, no customers)
</verification>

<success_criteria>
1. getChecklistState computes item completion from actual data counts
2. dismissChecklist server action updates JSONB and revalidates
3. GettingStartedChecklist shows progress bar with X of 4 complete
4. Checklist items link to correct pages (jobs, campaigns, analytics)
5. Completed items show checkmark and visual completion state
6. Dismiss button hides checklist and persists to database
7. Congratulations message shows when all complete
8. Build and typecheck pass
</success_criteria>

<output>
After completion, create `.planning/phases/32-post-onboarding-guidance/32-02-SUMMARY.md`
</output>
