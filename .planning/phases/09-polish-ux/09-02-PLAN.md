---
phase: 09-polish-ux
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - components/layout/sidebar.tsx
  - components/layout/bottom-nav.tsx
  - components/layout/app-shell.tsx
  - app/(dashboard)/layout.tsx
  - app/dashboard/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar collapses to icons on medium screens, hidden on mobile"
    - "Bottom navigation appears on mobile with Dashboard, Contacts, Send, History"
    - "Sidebar state persists in localStorage"
    - "Content has bottom padding on mobile to avoid bottom nav overlap"
    - "User avatar with dropdown in sidebar footer"
  artifacts:
    - path: "components/layout/sidebar.tsx"
      provides: "Collapsible sidebar with navigation"
      exports: ["Sidebar"]
    - path: "components/layout/bottom-nav.tsx"
      provides: "Mobile bottom navigation bar"
      exports: ["BottomNav"]
    - path: "components/layout/app-shell.tsx"
      provides: "Responsive app wrapper combining sidebar and bottom nav"
      exports: ["AppShell"]
  key_links:
    - from: "components/layout/sidebar.tsx"
      to: "lib/hooks/use-local-storage.ts"
      via: "useLocalStorage for collapsed state"
      pattern: "useLocalStorage.*sidebarCollapsed"
    - from: "components/layout/app-shell.tsx"
      to: "components/layout/sidebar.tsx"
      via: "Sidebar import and render"
      pattern: "<Sidebar"
    - from: "components/layout/app-shell.tsx"
      to: "components/layout/bottom-nav.tsx"
      via: "BottomNav import and render"
      pattern: "<BottomNav"
---

<objective>
Create the responsive app shell with collapsible sidebar and mobile bottom navigation.

Purpose: Establish the navigation structure that adapts between desktop (sidebar) and mobile (bottom nav) according to CONTEXT.md responsive decisions.

Output: Sidebar component with collapse toggle, BottomNav for mobile, and AppShell wrapper that combines them.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-polish-ux/09-CONTEXT.md
@.planning/phases/09-polish-ux/09-RESEARCH.md
@.planning/phases/09-polish-ux/09-01-SUMMARY.md
@app/protected/layout.tsx
@lib/actions/auth.ts
</context>

<codebase_structure>
## Route Structure (IMPORTANT - read before implementing)

The codebase has these route groups:
- `app/(dashboard)/` - Route group containing: contacts, send, history, billing, onboarding
  - NO layout.tsx exists yet - YOU MUST CREATE ONE
- `app/dashboard/` - Separate directory for /dashboard page and /dashboard/settings
  - NO layout.tsx exists yet - YOU MUST CREATE ONE
- `app/(marketing)/` - Marketing pages (/, /pricing) - has its own layout
- `app/auth/`, `app/login/`, `app/signup/` - Auth routes - should NOT use AppShell

The goal:
- `/dashboard`, `/dashboard/settings` -> use AppShell
- `/contacts`, `/send`, `/history`, `/billing`, `/onboarding` -> use AppShell (these are in (dashboard) group)
- Auth routes and marketing routes -> do NOT use AppShell
</codebase_structure>

<tasks>

<task type="auto">
  <name>Task 1: Create Sidebar component</name>
  <files>components/layout/sidebar.tsx</files>
  <action>
Create a collapsible sidebar component at components/layout/sidebar.tsx:

```typescript
"use client"

import { useState, useEffect } from 'react'
import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { cn } from '@/lib/utils'
import { useLocalStorage } from '@/lib/hooks/use-local-storage'
import { useIsDesktop } from '@/lib/hooks/use-media-query'
import {
  LayoutDashboard,
  Users,
  Send,
  History,
  Settings,
  CreditCard,
  ChevronLeft,
  ChevronRight,
  LogOut,
} from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Separator } from '@/components/ui/separator'
import { signOut } from '@/lib/actions/auth'

interface NavItem {
  icon: React.ElementType
  label: string
  href: string
}

const mainNav: NavItem[] = [
  { icon: LayoutDashboard, label: 'Dashboard', href: '/dashboard' },
  { icon: Users, label: 'Contacts', href: '/contacts' },
  { icon: Send, label: 'Send', href: '/send' },
  { icon: History, label: 'History', href: '/history' },
]

const secondaryNav: NavItem[] = [
  { icon: CreditCard, label: 'Billing', href: '/billing' },
  { icon: Settings, label: 'Settings', href: '/dashboard/settings' },
]

export function Sidebar() {
  const pathname = usePathname()
  const isDesktop = useIsDesktop()
  const [isCollapsed, setIsCollapsed] = useLocalStorage('sidebarCollapsed', false)

  // Auto-collapse on medium screens (tablet), expand on large
  const [autoCollapsed, setAutoCollapsed] = useState(false)

  useEffect(() => {
    // On medium screens (768-1024), auto-collapse. On large (1024+), respect user preference
    if (typeof window !== 'undefined') {
      const handleResize = () => {
        const width = window.innerWidth
        if (width >= 768 && width < 1024) {
          setAutoCollapsed(true)
        } else if (width >= 1024) {
          setAutoCollapsed(false)
        }
      }
      handleResize()
      window.addEventListener('resize', handleResize)
      return () => window.removeEventListener('resize', handleResize)
    }
  }, [])

  const collapsed = autoCollapsed || isCollapsed

  const NavLink = ({ item }: { item: NavItem }) => {
    const isActive = pathname === item.href || pathname.startsWith(item.href + '/')
    const Icon = item.icon

    return (
      <Link
        href={item.href}
        className={cn(
          "flex items-center gap-3 rounded-lg px-3 py-2 text-sm font-medium transition-all duration-200",
          "hover:bg-accent hover:text-accent-foreground",
          isActive
            ? "bg-primary text-primary-foreground hover:bg-primary/90 hover:text-primary-foreground"
            : "text-muted-foreground",
          collapsed && "justify-center px-2"
        )}
        title={collapsed ? item.label : undefined}
      >
        <Icon className="h-5 w-5 shrink-0" />
        {!collapsed && <span>{item.label}</span>}
      </Link>
    )
  }

  return (
    <aside
      className={cn(
        "hidden md:flex flex-col h-screen bg-card border-r transition-all duration-300",
        collapsed ? "w-16" : "w-64"
      )}
    >
      {/* Header */}
      <div className={cn(
        "flex items-center h-16 px-4 border-b",
        collapsed ? "justify-center" : "justify-between"
      )}>
        {!collapsed && (
          <Link href="/dashboard" className="flex items-center gap-2">
            <span className="font-bold text-lg text-primary">AvisLoop</span>
          </Link>
        )}
        <Button
          variant="ghost"
          size="icon-sm"
          onClick={() => setIsCollapsed(!isCollapsed)}
          className="shrink-0"
          aria-label={collapsed ? "Expand sidebar" : "Collapse sidebar"}
        >
          {collapsed ? (
            <ChevronRight className="h-4 w-4" />
          ) : (
            <ChevronLeft className="h-4 w-4" />
          )}
        </Button>
      </div>

      {/* Main navigation */}
      <nav className="flex-1 p-3 space-y-1">
        {!collapsed && (
          <p className="px-3 py-2 text-xs font-semibold text-muted-foreground uppercase tracking-wider">
            Main
          </p>
        )}
        {mainNav.map((item) => (
          <NavLink key={item.href} item={item} />
        ))}

        <Separator className="my-4" />

        {!collapsed && (
          <p className="px-3 py-2 text-xs font-semibold text-muted-foreground uppercase tracking-wider">
            Account
          </p>
        )}
        {secondaryNav.map((item) => (
          <NavLink key={item.href} item={item} />
        ))}
      </nav>

      {/* Footer with logout - using inline form instead of LogoutButton for styling flexibility */}
      <div className="p-3 border-t">
        <form action={signOut}>
          <Button
            type="submit"
            variant="ghost"
            className={cn(
              "w-full justify-start gap-3 text-muted-foreground hover:text-foreground",
              collapsed && "justify-center px-2"
            )}
          >
            <LogOut className="h-5 w-5 shrink-0" />
            {!collapsed && <span>Sign out</span>}
          </Button>
        </form>
      </div>
    </aside>
  )
}
```

Note: We use an inline form with signOut action instead of LogoutButton component. This gives us full control over styling (className, variant) without needing to modify the LogoutButton component. The LogoutButton component exists but doesn't accept className/variant props.
  </action>
  <verify>
1. `pnpm typecheck` - no errors
2. File exists: `ls components/layout/sidebar.tsx`
  </verify>
  <done>Sidebar component created with collapse toggle and localStorage persistence.</done>
</task>

<task type="auto">
  <name>Task 2: Create BottomNav component</name>
  <files>components/layout/bottom-nav.tsx</files>
  <action>
Create mobile bottom navigation at components/layout/bottom-nav.tsx:

```typescript
"use client"

import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { cn } from '@/lib/utils'
import { LayoutDashboard, Users, Send, History } from 'lucide-react'

const NAV_HEIGHT = 72 // 4.5rem in pixels

const items = [
  { icon: LayoutDashboard, label: 'Dashboard', href: '/dashboard' },
  { icon: Users, label: 'Contacts', href: '/contacts' },
  { icon: Send, label: 'Send', href: '/send' },
  { icon: History, label: 'History', href: '/history' },
]

export function BottomNav() {
  const pathname = usePathname()

  return (
    <nav
      className="md:hidden fixed bottom-0 left-0 right-0 z-50 bg-card/95 backdrop-blur supports-[backdrop-filter]:bg-card/80 border-t"
      style={{ height: `${NAV_HEIGHT}px` }}
      aria-label="Mobile navigation"
    >
      <div className="grid grid-cols-4 h-full">
        {items.map((item) => {
          const isActive = pathname === item.href || pathname.startsWith(item.href + '/')
          const Icon = item.icon

          return (
            <Link
              key={item.href}
              href={item.href}
              className={cn(
                "flex flex-col items-center justify-center gap-1 text-xs font-medium transition-colors",
                isActive
                  ? "text-primary"
                  : "text-muted-foreground hover:text-foreground"
              )}
            >
              <Icon className="h-5 w-5" />
              <span>{item.label}</span>
            </Link>
          )
        })}
      </div>
    </nav>
  )
}

// Export height constant for use in layouts
export const BOTTOM_NAV_HEIGHT = NAV_HEIGHT
```
  </action>
  <verify>
1. `pnpm typecheck` - no errors
2. File exists: `ls components/layout/bottom-nav.tsx`
  </verify>
  <done>BottomNav component created for mobile navigation.</done>
</task>

<task type="auto">
  <name>Task 3: Create AppShell and dashboard layouts</name>
  <files>components/layout/app-shell.tsx, app/(dashboard)/layout.tsx, app/dashboard/layout.tsx</files>
  <action>
1. Create AppShell wrapper at components/layout/app-shell.tsx:

```typescript
import { Sidebar } from './sidebar'
import { BottomNav, BOTTOM_NAV_HEIGHT } from './bottom-nav'

interface AppShellProps {
  children: React.ReactNode
}

export function AppShell({ children }: AppShellProps) {
  return (
    <div className="flex min-h-screen bg-background">
      {/* Desktop sidebar */}
      <Sidebar />

      {/* Main content area */}
      <main className="flex-1 overflow-auto">
        {/* Add bottom padding on mobile for bottom nav, remove on desktop */}
        <div className="pb-[72px] md:pb-0">
          {children}
        </div>
      </main>

      {/* Mobile bottom nav */}
      <BottomNav />
    </div>
  )
}
```

2. Create app/(dashboard)/layout.tsx to wrap the dashboard route group:

This layout wraps: /contacts, /send, /history, /billing, /onboarding

```typescript
import { AppShell } from '@/components/layout/app-shell'

export default function DashboardGroupLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return <AppShell>{children}</AppShell>
}
```

3. Create app/dashboard/layout.tsx to wrap /dashboard and /dashboard/settings:

```typescript
import { AppShell } from '@/components/layout/app-shell'

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return <AppShell>{children}</AppShell>
}
```

Both layouts use AppShell. This ensures:
- /dashboard (main dashboard page) uses AppShell
- /dashboard/settings uses AppShell (nested under /dashboard)
- /contacts, /send, /history, /billing, /onboarding use AppShell (via (dashboard) group layout)
- Auth routes (/login, /signup, etc.) do NOT use AppShell (no shared layout)
- Marketing routes use their own (marketing)/layout.tsx
  </action>
  <verify>
1. `pnpm typecheck` - no errors
2. `pnpm dev` - navigate to /dashboard, /contacts, /send, /history
3. Sidebar visible on desktop (1024px+)
4. Sidebar collapsed on tablet (768-1024px)
5. Bottom nav visible on mobile (<768px), sidebar hidden
6. Content doesn't get cut off by bottom nav on mobile
7. Test sidebar collapse persists across page refresh (toggle, refresh, still collapsed)
8. Test auto-collapse at 768-1024px breakpoint (resize window, verify sidebar auto-collapses)
  </verify>
  <done>AppShell created. Both app/(dashboard)/layout.tsx and app/dashboard/layout.tsx created to wrap their respective routes.</done>
</task>

</tasks>

<verification>
1. `pnpm lint && pnpm typecheck` passes
2. Desktop (1024px+): Sidebar expanded by default, can toggle collapse
3. Tablet (768-1024px): Sidebar auto-collapsed to icons
4. Mobile (<768px): Sidebar hidden, bottom nav visible with 4 items
5. Sidebar collapse state persists across page refresh (localStorage)
6. Active nav item has primary color highlight
7. Content scrolls properly and bottom nav doesn't overlap on mobile
8. Auto-collapse triggers at 768-1024px breakpoint
</verification>

<success_criteria>
- Sidebar component with collapse toggle (icon-only mode)
- BottomNav with Dashboard, Contacts, Send, History items
- AppShell combines both for responsive layout
- Sidebar state persists in localStorage
- Content has appropriate padding for mobile bottom nav
- Auto-collapse behavior at 768-1024px verified
- All lint and typecheck pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-polish-ux/09-02-SUMMARY.md`
</output>
