---
phase: 09-polish-ux
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - components/layout/sidebar.tsx
  - components/layout/bottom-nav.tsx
  - components/layout/app-shell.tsx
  - app/dashboard/layout.tsx
  - app/(dashboard)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar collapses to icons on medium screens, hidden on mobile"
    - "Bottom navigation appears on mobile with Dashboard, Contacts, Send, History"
    - "Sidebar state persists in localStorage"
    - "Content has bottom padding on mobile to avoid bottom nav overlap"
    - "User avatar with dropdown in sidebar footer"
  artifacts:
    - path: "components/layout/sidebar.tsx"
      provides: "Collapsible sidebar with navigation"
      exports: ["Sidebar"]
    - path: "components/layout/bottom-nav.tsx"
      provides: "Mobile bottom navigation bar"
      exports: ["BottomNav"]
    - path: "components/layout/app-shell.tsx"
      provides: "Responsive app wrapper combining sidebar and bottom nav"
      exports: ["AppShell"]
  key_links:
    - from: "components/layout/sidebar.tsx"
      to: "lib/hooks/use-local-storage.ts"
      via: "useLocalStorage for collapsed state"
      pattern: "useLocalStorage.*sidebarCollapsed"
    - from: "components/layout/app-shell.tsx"
      to: "components/layout/sidebar.tsx"
      via: "Sidebar import and render"
      pattern: "<Sidebar"
    - from: "components/layout/app-shell.tsx"
      to: "components/layout/bottom-nav.tsx"
      via: "BottomNav import and render"
      pattern: "<BottomNav"
---

<objective>
Create the responsive app shell with collapsible sidebar and mobile bottom navigation.

Purpose: Establish the navigation structure that adapts between desktop (sidebar) and mobile (bottom nav) according to CONTEXT.md responsive decisions.

Output: Sidebar component with collapse toggle, BottomNav for mobile, and AppShell wrapper that combines them.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-polish-ux/09-CONTEXT.md
@.planning/phases/09-polish-ux/09-RESEARCH.md
@.planning/phases/09-polish-ux/09-01-SUMMARY.md
@app/dashboard/layout.tsx
@app/protected/layout.tsx
@components/auth-button.tsx
@components/logout-button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sidebar component</name>
  <files>components/layout/sidebar.tsx</files>
  <action>
Create a collapsible sidebar component at components/layout/sidebar.tsx:

```typescript
"use client"

import { useState, useEffect } from 'react'
import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { cn } from '@/lib/utils'
import { useLocalStorage } from '@/lib/hooks/use-local-storage'
import { useIsDesktop } from '@/lib/hooks/use-media-query'
import {
  LayoutDashboard,
  Users,
  Send,
  History,
  Settings,
  CreditCard,
  ChevronLeft,
  ChevronRight,
  LogOut,
} from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Separator } from '@/components/ui/separator'
import { LogoutButton } from '@/components/logout-button'

interface NavItem {
  icon: React.ElementType
  label: string
  href: string
}

const mainNav: NavItem[] = [
  { icon: LayoutDashboard, label: 'Dashboard', href: '/dashboard' },
  { icon: Users, label: 'Contacts', href: '/contacts' },
  { icon: Send, label: 'Send', href: '/send' },
  { icon: History, label: 'History', href: '/history' },
]

const secondaryNav: NavItem[] = [
  { icon: CreditCard, label: 'Billing', href: '/billing' },
  { icon: Settings, label: 'Settings', href: '/dashboard/settings' },
]

export function Sidebar() {
  const pathname = usePathname()
  const isDesktop = useIsDesktop()
  const [isCollapsed, setIsCollapsed] = useLocalStorage('sidebarCollapsed', false)

  // Auto-collapse on medium screens (tablet), expand on large
  const [autoCollapsed, setAutoCollapsed] = useState(false)

  useEffect(() => {
    // On medium screens (768-1024), auto-collapse. On large (1024+), respect user preference
    if (typeof window !== 'undefined') {
      const handleResize = () => {
        const width = window.innerWidth
        if (width >= 768 && width < 1024) {
          setAutoCollapsed(true)
        } else if (width >= 1024) {
          setAutoCollapsed(false)
        }
      }
      handleResize()
      window.addEventListener('resize', handleResize)
      return () => window.removeEventListener('resize', handleResize)
    }
  }, [])

  const collapsed = autoCollapsed || isCollapsed

  const NavLink = ({ item }: { item: NavItem }) => {
    const isActive = pathname === item.href || pathname.startsWith(item.href + '/')
    const Icon = item.icon

    return (
      <Link
        href={item.href}
        className={cn(
          "flex items-center gap-3 rounded-lg px-3 py-2 text-sm font-medium transition-all duration-200",
          "hover:bg-accent hover:text-accent-foreground",
          isActive
            ? "bg-primary text-primary-foreground hover:bg-primary/90 hover:text-primary-foreground"
            : "text-muted-foreground",
          collapsed && "justify-center px-2"
        )}
        title={collapsed ? item.label : undefined}
      >
        <Icon className="h-5 w-5 shrink-0" />
        {!collapsed && <span>{item.label}</span>}
      </Link>
    )
  }

  return (
    <aside
      className={cn(
        "hidden md:flex flex-col h-screen bg-card border-r transition-all duration-300",
        collapsed ? "w-16" : "w-64"
      )}
    >
      {/* Header */}
      <div className={cn(
        "flex items-center h-16 px-4 border-b",
        collapsed ? "justify-center" : "justify-between"
      )}>
        {!collapsed && (
          <Link href="/dashboard" className="flex items-center gap-2">
            <span className="font-bold text-lg text-primary">AvisLoop</span>
          </Link>
        )}
        <Button
          variant="ghost"
          size="icon-sm"
          onClick={() => setIsCollapsed(!isCollapsed)}
          className="shrink-0"
          aria-label={collapsed ? "Expand sidebar" : "Collapse sidebar"}
        >
          {collapsed ? (
            <ChevronRight className="h-4 w-4" />
          ) : (
            <ChevronLeft className="h-4 w-4" />
          )}
        </Button>
      </div>

      {/* Main navigation */}
      <nav className="flex-1 p-3 space-y-1">
        {!collapsed && (
          <p className="px-3 py-2 text-xs font-semibold text-muted-foreground uppercase tracking-wider">
            Main
          </p>
        )}
        {mainNav.map((item) => (
          <NavLink key={item.href} item={item} />
        ))}

        <Separator className="my-4" />

        {!collapsed && (
          <p className="px-3 py-2 text-xs font-semibold text-muted-foreground uppercase tracking-wider">
            Account
          </p>
        )}
        {secondaryNav.map((item) => (
          <NavLink key={item.href} item={item} />
        ))}
      </nav>

      {/* Footer with logout */}
      <div className="p-3 border-t">
        <LogoutButton
          className={cn(
            "w-full justify-start gap-3",
            collapsed && "justify-center px-2"
          )}
          variant="ghost"
        >
          <LogOut className="h-5 w-5 shrink-0" />
          {!collapsed && <span>Sign out</span>}
        </LogoutButton>
      </div>
    </aside>
  )
}
```

Note: You may need to update LogoutButton to accept className and variant props. Check its current implementation.
  </action>
  <verify>
1. `pnpm typecheck` - no errors
2. File exists: `ls components/layout/sidebar.tsx`
  </verify>
  <done>Sidebar component created with collapse toggle and localStorage persistence.</done>
</task>

<task type="auto">
  <name>Task 2: Create BottomNav component</name>
  <files>components/layout/bottom-nav.tsx</files>
  <action>
Create mobile bottom navigation at components/layout/bottom-nav.tsx:

```typescript
"use client"

import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { cn } from '@/lib/utils'
import { LayoutDashboard, Users, Send, History } from 'lucide-react'

const NAV_HEIGHT = 72 // 4.5rem in pixels

const items = [
  { icon: LayoutDashboard, label: 'Dashboard', href: '/dashboard' },
  { icon: Users, label: 'Contacts', href: '/contacts' },
  { icon: Send, label: 'Send', href: '/send' },
  { icon: History, label: 'History', href: '/history' },
]

export function BottomNav() {
  const pathname = usePathname()

  return (
    <nav
      className="md:hidden fixed bottom-0 left-0 right-0 z-50 bg-card/95 backdrop-blur supports-[backdrop-filter]:bg-card/80 border-t"
      style={{ height: `${NAV_HEIGHT}px` }}
      aria-label="Mobile navigation"
    >
      <div className="grid grid-cols-4 h-full">
        {items.map((item) => {
          const isActive = pathname === item.href || pathname.startsWith(item.href + '/')
          const Icon = item.icon

          return (
            <Link
              key={item.href}
              href={item.href}
              className={cn(
                "flex flex-col items-center justify-center gap-1 text-xs font-medium transition-colors",
                isActive
                  ? "text-primary"
                  : "text-muted-foreground hover:text-foreground"
              )}
            >
              <Icon className="h-5 w-5" />
              <span>{item.label}</span>
            </Link>
          )
        })}
      </div>
    </nav>
  )
}

// Export height constant for use in layouts
export const BOTTOM_NAV_HEIGHT = NAV_HEIGHT
```
  </action>
  <verify>
1. `pnpm typecheck` - no errors
2. File exists: `ls components/layout/bottom-nav.tsx`
  </verify>
  <done>BottomNav component created for mobile navigation.</done>
</task>

<task type="auto">
  <name>Task 3: Create AppShell and update dashboard layouts</name>
  <files>components/layout/app-shell.tsx, app/dashboard/layout.tsx, app/(dashboard)/layout.tsx</files>
  <action>
1. Create AppShell wrapper at components/layout/app-shell.tsx:

```typescript
import { Sidebar } from './sidebar'
import { BottomNav, BOTTOM_NAV_HEIGHT } from './bottom-nav'

interface AppShellProps {
  children: React.ReactNode
}

export function AppShell({ children }: AppShellProps) {
  return (
    <div className="flex min-h-screen bg-background">
      {/* Desktop sidebar */}
      <Sidebar />

      {/* Main content area */}
      <main
        className="flex-1 overflow-auto"
        style={{ paddingBottom: `${BOTTOM_NAV_HEIGHT}px` }}
      >
        <div className="md:pb-0" style={{ paddingBottom: 0 }}>
          {children}
        </div>
      </main>

      {/* Mobile bottom nav */}
      <BottomNav />
    </div>
  )
}
```

Note: The pb-0 override on md: removes the mobile padding on desktop.

2. Update app/dashboard/layout.tsx to use AppShell:
   - Remove existing nav/header structure
   - Wrap children in AppShell component
   - Keep any auth checks that exist
   - Remove DeployButton, EnvVarWarning, ThemeSwitcher, AuthButton (they're boilerplate)

3. Check if app/(dashboard)/layout.tsx exists. If it doesn't, routes like /contacts, /send, /history may need their own layout or the (dashboard) group may need a layout.tsx that wraps in AppShell.

IMPORTANT: Check the existing route structure to understand which layout wraps which routes. The goal is:
- /dashboard/* uses AppShell
- /contacts, /send, /history, /billing, /onboarding use AppShell
- Auth routes (/login, /signup, etc.) do NOT use AppShell
- Marketing routes (/, /pricing) do NOT use AppShell

If there's a (dashboard) route group, add AppShell there. Otherwise, update whichever layout wraps the dashboard routes.
  </action>
  <verify>
1. `pnpm typecheck` - no errors
2. `pnpm dev` - navigate to /dashboard, /contacts, /send, /history
3. Sidebar visible on desktop (1024px+)
4. Sidebar collapsed on tablet (768-1024px)
5. Bottom nav visible on mobile (<768px), sidebar hidden
6. Content doesn't get cut off by bottom nav on mobile
  </verify>
  <done>AppShell created. Dashboard layouts updated to use responsive navigation.</done>
</task>

</tasks>

<verification>
1. `pnpm lint && pnpm typecheck` passes
2. Desktop (1024px+): Sidebar expanded by default, can toggle collapse
3. Tablet (768-1024px): Sidebar auto-collapsed to icons
4. Mobile (<768px): Sidebar hidden, bottom nav visible with 4 items
5. Sidebar collapse state persists across page refresh (localStorage)
6. Active nav item has primary color highlight
7. Content scrolls properly and bottom nav doesn't overlap on mobile
</verification>

<success_criteria>
- Sidebar component with collapse toggle (icon-only mode)
- BottomNav with Dashboard, Contacts, Send, History items
- AppShell combines both for responsive layout
- Sidebar state persists in localStorage
- Content has appropriate padding for mobile bottom nav
- All lint and typecheck pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-polish-ux/09-02-SUMMARY.md`
</output>
