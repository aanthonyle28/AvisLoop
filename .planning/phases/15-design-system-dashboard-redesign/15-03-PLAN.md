---
phase: 15-design-system-dashboard-redesign
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - lib/data/send-logs.ts
  - components/dashboard/stat-cards.tsx
  - components/dashboard/recent-activity.tsx
  - components/dashboard/avatar-initials.tsx
autonomous: true

must_haves:
  truths:
    - "Monthly Usage card shows send count / tier limit with blue progress bar and remaining count"
    - "Needs Attention card shows count of pending + failed items with colored badges"
    - "Review Rate card shows percentage with trend indicator and star average"
    - "Recent Activity table shows 5 most recent send_logs with avatar, contact name/email, subject, status dot+label, date"
    - "Avatar initials use deterministic color assignment based on contact name"
  artifacts:
    - path: "components/dashboard/stat-cards.tsx"
      provides: "MonthlyUsageCard, NeedsAttentionCard, ReviewRateCard components"
      exports: ["MonthlyUsageCard", "NeedsAttentionCard", "ReviewRateCard"]
    - path: "components/dashboard/recent-activity.tsx"
      provides: "RecentActivityTable component with status dots"
      exports: ["RecentActivityTable"]
    - path: "components/dashboard/avatar-initials.tsx"
      provides: "AvatarInitials component with deterministic color"
      exports: ["AvatarInitials"]
    - path: "lib/data/send-logs.ts"
      provides: "getNeedsAttentionCount and getRecentActivity data functions"
      contains: "getNeedsAttentionCount"
  key_links:
    - from: "components/dashboard/stat-cards.tsx"
      to: "lib/data/send-logs.ts"
      via: "data props from dashboard page"
      pattern: "monthlyUsage|needsAttention|responseRate"
    - from: "components/dashboard/recent-activity.tsx"
      to: "lib/data/send-logs.ts"
      via: "data props from dashboard page"
      pattern: "RecentActivity"
---

<objective>
Create the dashboard data layer additions and new dashboard components: three stat cards (Monthly Usage, Needs Attention, Review Rate), Recent Activity table, and avatar initials component -- all matching the Figma reference design.

Purpose: These are the building blocks for the redesigned dashboard page (assembled in Plan 04).
Output: New components and data functions ready for dashboard page integration.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-design-system-dashboard-redesign/15-CONTEXT.md
@lib/data/send-logs.ts
@lib/constants/billing.ts
@components/history/status-badge.tsx
@components/dashboard/response-rate-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add data layer functions for dashboard</name>
  <files>lib/data/send-logs.ts</files>
  <action>
Add two new exported functions to `lib/data/send-logs.ts`:

1. **`getNeedsAttentionCount()`** -- Returns count of sends needing attention:
   ```typescript
   export async function getNeedsAttentionCount(): Promise<{
     total: number
     pending: number
     failed: number
   }>
   ```
   - Query send_logs for the current user's business
   - Count where `status = 'pending'` (pending count)
   - Count where `status IN ('failed', 'bounced')` (failed count)
   - Total = pending + failed
   - Follow the same auth pattern as `getMonthlyUsage()` (get user, get business, query)

2. **`getRecentActivity(limit?: number)`** -- Returns recent send logs with contact info:
   ```typescript
   export async function getRecentActivity(limit: number = 5): Promise<Array<{
     id: string
     contact_name: string
     contact_email: string
     subject: string
     status: string
     created_at: string
   }>>
   ```
   - Query send_logs joined with contacts (using existing pattern from getSendLogs)
   - Select: id, contacts.name, contacts.email, subject, status, created_at
   - Order by created_at DESC, limit to `limit` rows
   - Follow same auth pattern
   - Map the result to flatten contact fields: `{ id, contact_name: row.contacts.name, contact_email: row.contacts.email, subject: row.subject, status: row.status, created_at: row.created_at }`
  </action>
  <verify>Run `pnpm typecheck` -- no type errors in send-logs.ts</verify>
  <done>getNeedsAttentionCount and getRecentActivity functions exported and typed</done>
</task>

<task type="auto">
  <name>Task 2: Create stat card and recent activity components</name>
  <files>components/dashboard/stat-cards.tsx, components/dashboard/recent-activity.tsx, components/dashboard/avatar-initials.tsx</files>
  <action>
**1. Create `components/dashboard/avatar-initials.tsx`:**

Server component (no "use client"). Renders a colored circle with initials.

```typescript
interface AvatarInitialsProps {
  name: string
  size?: "sm" | "md"  // sm=32px, md=40px
}
```

- Extract first letter of first name + first letter of last name (split by space). If single name, use first two letters.
- Deterministic color: Hash the name string to pick from a fixed palette of 8 background colors (soft pastels: blue, green, purple, orange, pink, teal, indigo, rose). Use a simple hash: sum of char codes mod 8.
- Render: `<div>` with rounded-full, the selected bg color, white text, flex center, font-medium text-sm.
- Size: sm = `w-8 h-8 text-xs`, md = `w-10 h-10 text-sm`

**2. Create `components/dashboard/stat-cards.tsx`:**

Three server components in one file. All use Phosphor icons (import from @phosphor-icons/react).

**MonthlyUsageCard:**
```typescript
interface MonthlyUsageCardProps {
  count: number
  limit: number
  tier: string
}
```
- White card with border (#E3E3E3), rounded-lg, p-5
- Top-right corner: small icon button placeholder (Phosphor `ArrowSquareOut` icon, size 16, text-muted-foreground)
- Title: "Monthly Usage" in text-sm font-medium text-muted-foreground
- Big number: `{count}/{limit}` in text-3xl font-bold, with "sends used" in text-sm text-muted-foreground below
- Progress bar: div with `bg-[#F3F4F6] rounded-full h-2`, inner div with `bg-primary rounded-full h-2` at `width: ${Math.min((count/limit)*100, 100)}%`
- Footer text: `{limit - count} remaining this month` in text-xs text-muted-foreground

**NeedsAttentionCard:**
```typescript
interface NeedsAttentionCardProps {
  total: number
  pending: number
  failed: number
}
```
- Same card style as MonthlyUsageCard
- Top-right: Phosphor `WarningCircle` icon (size 16, text-muted-foreground)
- Title: "Needs Attention"
- Big number: `{total}` in text-3xl font-bold, "items" below in text-sm text-muted-foreground
- Bottom row: Two badges side by side
  - `{pending} Pending` badge: small colored dot (bg-status-warning) + text, styled as inline-flex items-center gap-1.5 text-xs
  - `{failed} Failed` badge: small colored dot (bg-status-error) + text

**ReviewRateCard:**
```typescript
interface ReviewRateCardProps {
  rate: number
  total: number
  responded: number
  previousRate?: number  // for trend calculation
}
```
- Same card style
- Top-right: Phosphor `Star` icon (size 16, text-muted-foreground)
- Title: "Review Rate"
- Big number: `{rate}%` in text-3xl font-bold
- Trend indicator: if previousRate provided, show `+{rate - previousRate}% from last month` with Phosphor `TrendUp` or `TrendDown` icon, colored green if positive, red if negative. If no previous data, show nothing.
- Star display: render 5 stars (Phosphor `Star` weight="fill" for filled, weight="regular" for empty). Number of filled = Math.round(rate / 20). Show `{filledCount}/5 avg` next to stars in text-xs.

**3. Create `components/dashboard/recent-activity.tsx`:**

Server component.

```typescript
interface RecentActivityProps {
  activities: Array<{
    id: string
    contact_name: string
    contact_email: string
    subject: string
    status: string
    created_at: string
  }>
}
```

- Card wrapper: white bg, border, rounded-lg, overflow-hidden
- Header: "Recent activity" (font-semibold text-base) + "View All" link (text-sm text-primary, links to /history), flex justify-between, px-5 pt-5 pb-3
- Table layout using HTML table (not @tanstack/react-table -- too heavy for 5 rows):
  - Columns: CONTACT, SUBJECT, STATUS, DATE
  - Column headers: text-xs font-medium text-muted-foreground uppercase tracking-wider
  - Rows: subtle bottom border (`border-b border-[#F3F4F6] last:border-0`)
  - CONTACT cell: AvatarInitials (size sm) + div with name (font-medium text-sm) + email (text-xs text-muted-foreground)
  - SUBJECT cell: text-sm, truncated with max-w-[200px] truncate
  - STATUS cell: colored dot (8px circle, using status colors) + label text. Map statuses:
    - pending -> bg-status-warning, "Pending"
    - sent -> bg-status-info, "Sent"
    - delivered -> bg-status-success, "Delivered"
    - opened -> bg-status-info, "Clicked" (match reference)
    - failed/bounced -> bg-status-error, "Failed"
    - reviewed -> bg-status-reviewed, "Reviewed"
  - DATE cell: format created_at using `format(new Date(created_at), 'MMM d, yyyy')` from date-fns. Text-sm text-muted-foreground.
- Empty state: "No sends yet -- send your first review request!" with link to /send
  </action>
  <verify>
    Run `pnpm typecheck` -- all components type-check cleanly.
    Grep for "lucide-react" in new files -- should return nothing (all Phosphor).
  </verify>
  <done>
    MonthlyUsageCard, NeedsAttentionCard, ReviewRateCard, RecentActivityTable, and AvatarInitials components created.
    All use Phosphor icons and semantic status colors. Data functions ready.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm lint` passes
- `getNeedsAttentionCount` and `getRecentActivity` exported from lib/data/send-logs.ts
- `MonthlyUsageCard`, `NeedsAttentionCard`, `ReviewRateCard` exported from stat-cards.tsx
- `RecentActivityTable` exported from recent-activity.tsx
- `AvatarInitials` exported from avatar-initials.tsx
- No Lucide imports in any new component
- Status dots use `bg-status-*` Tailwind classes (from Plan 01 tokens)
</verification>

<success_criteria>
- Three stat cards match Figma: Monthly Usage with progress bar, Needs Attention with badges, Review Rate with stars
- Recent Activity table shows avatar, contact info, subject, status dot, date
- Avatar initials have deterministic color based on name
- All components use Phosphor icons (not Lucide)
- Status colors use semantic palette from Plan 01
- Components are pure presentational (data passed as props, no internal data fetching)
</success_criteria>

<output>
After completion, create `.planning/phases/15-design-system-dashboard-redesign/15-03-SUMMARY.md`
</output>
