---
phase: 15-design-system-dashboard-redesign
plan: 04
type: execute
wave: 3
depends_on: ["15-02", "15-03"]
files_modified:
  - app/dashboard/page.tsx
  - components/dashboard/quick-send.tsx
  - components/skeletons/dashboard-skeleton.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows Welcome header with user/business name and subtitle"
    - "3 stat cards display in a row: Monthly Usage, Needs Attention, Review Rate"
    - "Quick Send panel has contact search, template dropdown, and functional Send button"
    - "When to Send panel shows schedule presets (Immediately, In 1 hour, In the morning, In 24 hours, Different date)"
    - "Recent Activity table shows 5 most recent sends with status dots"
    - "Dashboard layout matches Figma: header -> stats row -> quick send + when to send -> recent activity"
    - "Dashboard skeleton matches the new layout"
  artifacts:
    - path: "app/dashboard/page.tsx"
      provides: "Redesigned dashboard page with all sections"
      contains: "MonthlyUsageCard"
    - path: "components/dashboard/quick-send.tsx"
      provides: "Inline Quick Send + When to Send panel"
      exports: ["QuickSend"]
    - path: "components/skeletons/dashboard-skeleton.tsx"
      provides: "Updated skeleton matching new dashboard layout"
      contains: "stat cards"
  key_links:
    - from: "app/dashboard/page.tsx"
      to: "components/dashboard/stat-cards.tsx"
      via: "imports MonthlyUsageCard, NeedsAttentionCard, ReviewRateCard"
      pattern: "MonthlyUsageCard"
    - from: "app/dashboard/page.tsx"
      to: "components/dashboard/recent-activity.tsx"
      via: "imports RecentActivityTable"
      pattern: "RecentActivityTable"
    - from: "app/dashboard/page.tsx"
      to: "lib/data/send-logs.ts"
      via: "calls getNeedsAttentionCount, getRecentActivity"
      pattern: "getNeedsAttentionCount|getRecentActivity"
    - from: "components/dashboard/quick-send.tsx"
      to: "lib/actions/send.ts"
      via: "calls batchSendReviewRequest or scheduleReviewRequest"
      pattern: "batchSendReviewRequest|scheduleReviewRequest"
---

<objective>
Assemble the redesigned dashboard page: wire stat cards and recent activity with real data, create the Quick Send + When to Send inline panel, update the dashboard skeleton, and replace the existing dashboard layout entirely.

Purpose: This is the final assembly that delivers the Figma-matching dashboard.
Output: Fully functional redesigned dashboard with real data.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-design-system-dashboard-redesign/15-CONTEXT.md
@app/dashboard/page.tsx
@components/send/send-form.tsx
@components/send/schedule-selector.tsx
@components/skeletons/dashboard-skeleton.tsx
@lib/actions/send.ts
@lib/actions/schedule.ts
@lib/data/send-logs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Quick Send component</name>
  <files>components/dashboard/quick-send.tsx</files>
  <action>
Create a "use client" component that provides inline Quick Send + When to Send functionality on the dashboard.

```typescript
"use client"

interface QuickSendProps {
  contacts: Array<{ id: string; name: string; email: string }>
  templates: Array<{ id: string; name: string; is_default: boolean }>
  recentContacts: Array<{ id: string; name: string }>  // 3-5 most recently added
}
```

**Layout:** Two side-by-side panels inside a flex container (gap-4):

**Left panel - Quick Send (flex-1):**
- White card, border, rounded-lg, p-5
- Header: Phosphor `PaperPlaneTilt` icon (size 20) + "Quick Send" text (font-semibold)
- **Contact search:** Input with Phosphor `MagnifyingGlass` icon. As user types, filter contacts list. Show dropdown of matches below input (max 5). Clicking a match selects it. Selected contact shows as a chip with X to deselect.
- **Recently added:** Row of contact name chips (rounded-full border px-3 py-1 text-xs). Clicking a chip selects that contact. Show up to 3-5 chips from `recentContacts` prop. Only show this section if no contact is selected yet.
- **Message Template:** `<select>` dropdown with template names from props. Pre-select the default template (is_default=true).
- **Template preview:** Show 2-3 lines of template body preview below dropdown (text-sm text-muted-foreground, truncated). Actually -- per context, template editing stays in Settings. Just show the dropdown, no inline preview needed.

**Right panel - When to Send (w-64 shrink-0):**
- White card, border, rounded-lg, p-5
- Header: "When to Send" (font-semibold text-sm)
- Schedule preset chips/buttons -- use chip-style toggle buttons:
  - "Immediately" (default selected)
  - "In 1 hour"
  - "In the morning (9AM)"
  - "In 24 hours"
  - "Different date"
- Chip styling: `rounded-full border px-3 py-1.5 text-xs font-medium cursor-pointer transition-colors`
  - Selected: `bg-primary/10 border-primary text-primary`
  - Unselected: `border-[#E3E3E3] text-foreground/70 hover:border-primary/50`
- "Different date" triggers showing a native date+time input below the chips
- **Scheduled confirmation:** When a non-"Immediately" preset is selected, show a small confirmation badge below: green-tinted chip showing the selected option text (e.g., "In the morning (9AM)")
- **Note:** Only "Immediately" actually sends right now. The other presets are UI-only placeholders. When the user clicks Send with a non-Immediately preset, check if schedule actions exist (they do from v1.1 Phase 12). Wire them: if `scheduledFor` is set, call `scheduleReviewRequest`; if null, call `batchSendReviewRequest`. Use the same formData pattern as send-form.tsx.

**Send button (full width below both panels):**
- `bg-primary text-white rounded-lg py-3 w-full font-medium text-sm`
- Phosphor `PaperPlaneTilt` icon (size 16, weight "fill") + "Send Request" text
- Disabled state when no contact selected
- Loading state with spinner when submitting
- Use `useActionState` for both batch and schedule actions (same pattern as send-form.tsx)
- On success: show toast via sonner (`toast.success("Review request sent!")` or `toast.success("Scheduled for ...")`)
- On error: show toast via sonner (`toast.error(errorMessage)`)
- After success, reset form state (clear selected contact, reset schedule to Immediately)

**Form data assembly on submit:**
- Set `contactIds` to JSON array of selected contact IDs (just one for Quick Send)
- Set `templateId` to selected template ID
- If schedule preset is not "Immediately", compute the scheduledFor ISO string:
  - "In 1 hour": `new Date(Date.now() + 60*60*1000).toISOString()`
  - "In the morning (9AM)": next 9AM local time
  - "In 24 hours": `new Date(Date.now() + 24*60*60*1000).toISOString()`
  - "Different date": value from the datetime-local input
- Call appropriate action based on whether scheduledFor is set

**Mobile responsive:** On screens < md, stack the two panels vertically (Quick Send on top, When to Send below). Use `flex flex-col md:flex-row`.
  </action>
  <verify>
    Run `pnpm typecheck` -- component types check cleanly.
    Grep quick-send.tsx for "lucide-react" -- should return nothing.
  </verify>
  <done>
    QuickSend component with contact search, template dropdown, schedule presets, and functional send button.
    Wired to existing send and schedule server actions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite dashboard page and update skeleton</name>
  <files>app/dashboard/page.tsx, components/skeletons/dashboard-skeleton.tsx</files>
  <action>
**1. Rewrite `app/dashboard/page.tsx`:**

Replace the entire dashboard page to match the Figma reference layout. Keep it as a Server Component.

**Data fetching (parallel with Promise.all):**
```typescript
const [status, business, usage, contactsData, responseRate, needsAttention, recentActivity, templates] = await Promise.all([
  getOnboardingStatus(),
  getBusiness(),
  getMonthlyUsage(),
  getContacts({ limit: 5 }),  // Need recent contacts for Quick Send
  getResponseRate(),
  getNeedsAttentionCount(),
  getRecentActivity(5),
  // Also fetch templates for Quick Send
  getTemplatesForBusiness(),  // Need to add this or use existing pattern
])
```

For templates: Use the existing pattern from `send/page.tsx`. Import `createClient` and query `email_templates` where `business_id = business.id` order by `is_default DESC, created_at ASC`.

For recent contacts (for Quick Send chips): Use the first 3-5 contacts from `contactsData` sorted by `created_at DESC`.

**Layout structure (exact order from Figma):**

```
<div className="p-6 space-y-6 max-w-6xl mx-auto">
  {/* 1. Welcome Header */}
  {/* 2. Stat Cards Row (3 columns) */}
  {/* 3. Quick Send + When to Send (side by side) */}
  {/* 4. Recent Activity Table */}
</div>
```

**Section 1 - Welcome Header:**
- `<h1>` "Welcome, {firstName}!" -- Extract first name from user's email (split at @, capitalize) OR business name if available. Prefer user profile display name if profiles table has one; fallback to business name; fallback to email prefix.
- `<p>` "Here's what's happening with your review requests today." in text-muted-foreground

**Section 2 - Stat Cards Row:**
```html
<div className="grid grid-cols-1 md:grid-cols-3 gap-4">
  <MonthlyUsageCard count={usage.count} limit={usage.limit} tier={usage.tier} />
  <NeedsAttentionCard total={needsAttention.total} pending={needsAttention.pending} failed={needsAttention.failed} />
  <ReviewRateCard rate={responseRate.rate} total={responseRate.total} responded={responseRate.responded} />
</div>
```

**Section 3 - Quick Send:**
```html
<QuickSend
  contacts={contactsData.contacts.map(c => ({ id: c.id, name: c.name, email: c.email }))}
  templates={templates.map(t => ({ id: t.id, name: t.name, is_default: t.is_default }))}
  recentContacts={recentContacts.map(c => ({ id: c.id, name: c.name }))}
/>
```

**Section 4 - Recent Activity:**
```html
<RecentActivityTable activities={recentActivity} />
```

**Keep the onboarding redirect:** If `!status?.completed` AND not onboarding=complete, show a simplified banner or redirect to onboarding. Keep the existing redirect logic for users who haven't completed onboarding. Remove the old layout (grid-cols-3, Quick Links sidebar, next action card, etc.) entirely.

**Remove old imports:** Clean up imports of `NextActionCard`, `OnboardingChecklist`, old stat cards, etc. that are no longer used. Keep `OnboardingChecklist` import only if showing it in a conditional (for non-completed users). Actually, per Figma, the dashboard is the full redesign -- remove the onboarding checklist from the dashboard. Users who haven't completed onboarding still get redirected to `/onboarding`.

**2. Update `components/skeletons/dashboard-skeleton.tsx`:**

Match the new layout:
```
- Welcome header skeleton (h-8 w-64, h-5 w-96)
- Stat cards row: 3 cards in grid-cols-3, each with:
  - Skeleton h-5 w-32 (title)
  - Skeleton h-10 w-24 (big number)
  - Skeleton h-2 w-full rounded-full (progress bar -- only first card)
  - Skeleton h-4 w-40 (footer text)
- Quick Send skeleton: Two side-by-side cards
  - Left (flex-1): h-5 w-28, h-10 w-full (search), row of 3 small rounded-full skeletons (chips), h-10 w-full (dropdown)
  - Right (w-64): h-5 w-32, grid of 5 rounded-full skeletons (preset chips)
  - Full-width h-12 (send button)
- Recent Activity skeleton: Card with h-5 w-36 header, 5 rows of h-12
```
  </action>
  <verify>
    Run `pnpm typecheck` -- dashboard page compiles.
    Run `pnpm lint` -- no lint errors.
    Run `pnpm build` -- full build succeeds (catches SSR issues).
  </verify>
  <done>
    Dashboard page completely redesigned to match Figma reference.
    Welcome header, 3 stat cards, Quick Send + When to Send, Recent Activity table.
    Skeleton updated to match new layout. Real data flows through all components.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm lint` passes
- `pnpm build` succeeds
- Dashboard page imports: MonthlyUsageCard, NeedsAttentionCard, ReviewRateCard, RecentActivityTable, QuickSend
- Dashboard fetches: getMonthlyUsage, getNeedsAttentionCount, getResponseRate, getRecentActivity
- Quick Send has contact search, template dropdown, schedule presets, Send button
- Recent Activity shows 5 rows with status dots
- No Lucide imports in new dashboard components
- Skeleton matches new layout structure
</verification>

<success_criteria>
- Dashboard matches Figma reference layout exactly: welcome -> stats -> quick send -> recent activity
- Stat cards show real data (send count/limit, needs attention count, review rate)
- Quick Send is functional: can search contacts, select template, choose schedule preset, and send
- Recent Activity shows 5 most recent sends with avatar, name, email, subject, status dot, date
- All icons are Phosphor (not Lucide)
- Skeleton loading state matches new layout proportions
- Mobile responsive: cards stack vertically, quick send panels stack
</success_criteria>

<output>
After completion, create `.planning/phases/15-design-system-dashboard-redesign/15-04-SUMMARY.md`
</output>
