---
phase: 27-dashboard-redesign
plan: 03
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - components/dashboard/ready-to-send-queue.tsx
  - lib/actions/dashboard.ts
autonomous: true

must_haves:
  truths:
    - "Queue displays completed jobs not yet enrolled in any campaign"
    - "Each job shows customer name, service type, and completion time"
    - "Stale jobs (exceeding service type timing threshold) show warning flag"
    - "Quick enroll button auto-matches campaign by service type"
    - "Empty state shows encouraging message for active users or onboarding CTA for new users"
  artifacts:
    - path: "components/dashboard/ready-to-send-queue.tsx"
      provides: "Ready-to-send queue component with quick enroll"
      exports: ["ReadyToSendQueue", "ReadyToSendQueueSkeleton"]
    - path: "lib/actions/dashboard.ts"
      provides: "Server actions for dashboard inline actions"
      exports: ["quickEnrollJob"]
  key_links:
    - from: "components/dashboard/ready-to-send-queue.tsx"
      to: "lib/actions/dashboard.ts"
      via: "quickEnrollJob server action"
      pattern: "quickEnrollJob"
    - from: "lib/actions/dashboard.ts"
      to: "lib/actions/enrollment.ts"
      via: "enrollment logic reuse"
      pattern: "enrollJobInCampaign|getActiveCampaignForJob"
---

<objective>
Build the Ready-to-Send Queue component and its supporting quick-enroll server action.

Purpose: The queue is the primary actionable section -- it shows business owners which completed jobs are waiting for follow-up, with urgency indicators and one-click enrollment.
Output: Queue component with inline actions and a server action for quick enrollment.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-dashboard-redesign/27-CONTEXT.md
@.planning/phases/27-dashboard-redesign/27-RESEARCH.md
@lib/types/dashboard.ts
@lib/data/dashboard.ts
@lib/actions/enrollment.ts
@lib/data/campaign.ts
@lib/types/database.ts
@components/ui/card.tsx
@components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create quick-enroll server action</name>
  <files>lib/actions/dashboard.ts</files>
  <action>
Create `lib/actions/dashboard.ts` with 'use server' directive.

**`quickEnrollJob(jobId: string): Promise<QuickEnrollResult>`**

Return type:
```typescript
type QuickEnrollResult = {
  success: boolean
  error?: string
  enrolled?: boolean
  campaignName?: string
  noMatchingCampaign?: boolean  // true if no campaign exists for service type
  serviceType?: string
}
```

Implementation:
1. Authenticate user via `supabase.auth.getUser()`.
2. Get user's business from `businesses` table.
3. Fetch the job by ID to get `service_type`. Verify job belongs to this business.
4. Check if job already has an active enrollment: query `campaign_enrollments` WHERE `job_id = jobId AND status = 'active'`. If yes, return `{ success: false, error: 'Job already enrolled in a campaign' }`.
5. Find matching active campaign: use existing `getActiveCampaignForJob(businessId, serviceType)` from `@/lib/data/campaign.ts` -- this already tries service-specific first, then falls back to "all services" campaign.
6. If no campaign found: return `{ success: true, enrolled: false, noMatchingCampaign: true, serviceType: job.service_type }`. The UI will prompt to create one.
7. If campaign found: Reuse the enrollment logic from `@/lib/actions/enrollment.ts` -- import `enrollJobInCampaign` if it exists, or inline the enrollment insert:
   - Create enrollment record in `campaign_enrollments` with status='active', current_touch=1
   - Calculate touch_1_scheduled_at based on campaign's first touch delay_hours
   - Set touch_1_status='pending'
   - Calculate subsequent touch scheduled_at times
8. `revalidatePath('/dashboard')` after successful enrollment.
9. Return `{ success: true, enrolled: true, campaignName: campaign.name }`.

Error handling: Wrap in try/catch, return `{ success: false, error: message }` on any failure.

Follow existing server action patterns from `@/lib/actions/campaign.ts`.
  </action>
  <verify>Run `pnpm typecheck` -- no errors. Verify the action signature matches expected types.</verify>
  <done>quickEnrollJob action finds matching campaign and creates enrollment, or signals no campaign exists.</done>
</task>

<task type="auto">
  <name>Task 2: Create Ready-to-Send Queue component</name>
  <files>components/dashboard/ready-to-send-queue.tsx</files>
  <action>
Create `components/dashboard/ready-to-send-queue.tsx` as a client component ('use client').

Props:
```typescript
{
  jobs: ReadyToSendJob[]       // from lib/types/dashboard
  hasJobHistory: boolean        // true if business has ANY jobs (for empty state)
}
```

**Layout:**
- Card wrapper with `id="ready-to-send-queue"` (scroll target from banner)
- CardHeader: "Ready to Send" title + Badge showing count if > 0
- CardContent: job list

**Each job row** (flex, items-center, justify-between, py-3, border-b last:border-0):
Left side:
- If `job.isStale`: WarningCircle icon (Phosphor, weight="fill", yellow) with tooltip `title` showing "{service_type} jobs typically send within {threshold}h"
- Customer name (text-sm font-medium)
- Service type (capitalized) + "Completed {relative time}" using `formatDistanceToNow` from date-fns (text-xs text-muted-foreground)

Right side:
- "Enroll" Button (size="sm") -- calls `quickEnrollJob(job.id)` via the server action
  - While loading: show spinner, disable button
  - On success with `enrolled: true`: show toast "Enrolled in {campaignName}"
  - On success with `noMatchingCampaign: true`: show dialog/toast "No campaign for {serviceType}. Create one?" with link to `/campaigns/new?serviceType={serviceType}`
  - On error: show error toast
- Overflow menu (DotsThree icon, Phosphor) via DropdownMenu:
  - "Send one-off" -> Link to `/send?jobId={job.id}`
  - "View job" -> Link to `/jobs` (no individual job page yet)

**Show only first 5 jobs.** If more exist, show "Show all ({total})" link at bottom that navigates to `/jobs?status=completed&enrolled=false`.

**Empty states:**
- `hasJobHistory === true && jobs.length === 0`: "All caught up -- no jobs waiting for enrollment" with CheckCircle icon
- `hasJobHistory === false`: "No jobs yet -- add a completed job to get started" with link to `/jobs` and a Plus icon

**ReadyToSendQueueSkeleton** (exported):
- Card with header skeleton
- 3 skeleton rows matching job row height and structure
- Same border-b pattern

Use `useTransition` from React for the enroll action loading state (not useState).
Import `quickEnrollJob` from `@/lib/actions/dashboard`.
Import `toast` from `sonner` for success/error feedback.
Import icons from `@phosphor-icons/react`: WarningCircle, DotsThree, CheckCircle, Plus.
Import `formatDistanceToNow` from `date-fns`.
Import DropdownMenu components from `@/components/ui/dropdown-menu`.
  </action>
  <verify>Run `pnpm typecheck` -- no errors. Verify ReadyToSendQueue and ReadyToSendQueueSkeleton are exported.</verify>
  <done>Queue renders jobs with urgency flags, quick enroll works via server action with toast feedback, empty states are context-aware.</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- quickEnrollJob server action exported from lib/actions/dashboard.ts
- ReadyToSendQueue and ReadyToSendQueueSkeleton exported from component
- Queue shows warning flags on stale jobs
- Enroll button triggers server action with loading state
- Empty states differ based on hasJobHistory
</verification>

<success_criteria>
- Quick enroll auto-matches campaign by service type (reuses existing getActiveCampaignForJob)
- Missing campaign scenario handled gracefully with prompt
- Service-type-aware urgency uses business timing settings
- Component follows existing codebase patterns (sonner toasts, Phosphor icons, Card/Badge UI)
</success_criteria>

<output>
After completion, create `.planning/phases/27-dashboard-redesign/27-03-SUMMARY.md`
</output>
