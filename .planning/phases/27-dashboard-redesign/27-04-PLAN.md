---
phase: 27-dashboard-redesign
plan: 04
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - components/dashboard/attention-alerts.tsx
  - lib/actions/dashboard.ts
autonomous: true

must_haves:
  truths:
    - "Alerts display delivery issues (failed, bounced) and unresolved negative feedback"
    - "Alerts sorted by severity: critical first, then warning, then info"
    - "Each alert has a contextual action (Retry, Update contact, Respond, Acknowledge)"
    - "Show 3 most critical by default, expandable to see all"
    - "Budget/billing warnings are NOT included (per CONTEXT.md)"
  artifacts:
    - path: "components/dashboard/attention-alerts.tsx"
      provides: "Severity-sorted alerts component with inline actions"
      exports: ["AttentionAlerts", "AttentionAlertsSkeleton"]
  key_links:
    - from: "components/dashboard/attention-alerts.tsx"
      to: "lib/types/dashboard.ts"
      via: "AttentionAlert type import"
      pattern: "import.*AttentionAlert"
    - from: "components/dashboard/attention-alerts.tsx"
      to: "lib/actions/dashboard.ts"
      via: "retrySend and acknowledgeAlert actions"
      pattern: "retrySend|acknowledgeAlert"
---

<objective>
Build the Attention Alerts component with severity-sorted display and contextual inline actions.

Purpose: Alerts surface delivery failures and unresolved feedback that need business owner intervention. Contextual actions (not generic "Retry") tell users exactly what to do.
Output: Attention alerts component ready for the dashboard page.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-dashboard-redesign/27-CONTEXT.md
@.planning/phases/27-dashboard-redesign/27-RESEARCH.md
@lib/types/dashboard.ts
@lib/data/dashboard.ts
@lib/actions/dashboard.ts
@components/ui/card.tsx
@components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add retrySend and acknowledgeAlert to dashboard server actions</name>
  <files>lib/actions/dashboard.ts</files>
  <action>
Add two more server actions to the existing `lib/actions/dashboard.ts` file (append, do not replace quickEnrollJob).

**`retrySend(sendLogId: string): Promise<{ success: boolean; error?: string }>`**
1. Authenticate user via `supabase.auth.getUser()`.
2. Fetch the send_log by ID. Verify it belongs to user's business.
3. Verify status is 'failed' (only failed sends are retryable, not bounced).
4. Update send_log status back to 'pending' so the cron processor picks it up again.
5. `revalidatePath('/dashboard')`.
6. Return `{ success: true }`.

**`acknowledgeAlert(sendLogId: string): Promise<{ success: boolean; error?: string }>`**
For permanent failures (bounced emails, STOP requests) that can't be retried:
1. Authenticate user.
2. Fetch the send_log by ID. Verify ownership.
3. Update a field to mark it as acknowledged. Since there's no `acknowledged` column in send_logs, set the status to 'failed' with an `error_message` that includes "[acknowledged]" prefix. This keeps it out of future alert queries.
   - Alternative: Update error_message to prepend "[ACK] " if not already present. The getAttentionAlerts query should filter out send_logs where error_message starts with '[ACK]'.
4. `revalidatePath('/dashboard')`.
5. Return `{ success: true }`.

NOTE: Update the `getAttentionAlerts` function in `lib/data/dashboard.ts` to exclude acknowledged alerts:
- Add filter: `.not('error_message', 'like', '[ACK]%')` to the failed/bounced query.

Error handling: try/catch, return `{ success: false, error }` on failure.
  </action>
  <verify>Run `pnpm typecheck` -- no errors. Verify retrySend and acknowledgeAlert are exported.</verify>
  <done>Retry resets failed sends to pending for cron pickup. Acknowledge marks permanent failures as handled.</done>
</task>

<task type="auto">
  <name>Task 2: Create Attention Alerts component</name>
  <files>components/dashboard/attention-alerts.tsx</files>
  <action>
Create `components/dashboard/attention-alerts.tsx` as a client component ('use client').

Props:
```typescript
{
  alerts: AttentionAlert[]    // from lib/types/dashboard, already severity-sorted from data layer
  feedbackCount: number       // total unresolved feedback count (for "View all" link)
}
```

**SeverityIcon subcomponent** (internal):
- critical: XCircle (Phosphor, weight="fill") in `text-red-600 dark:text-red-400`
- warning: WarningCircle (Phosphor, weight="fill") in `text-yellow-600 dark:text-yellow-400`
- info: Info (Phosphor, weight="fill") in `text-blue-600 dark:text-blue-400`

**Layout:**
- Card wrapper with `id="attention-alerts"` (scroll target)
- CardHeader: "Needs Attention" title + Badge variant="destructive" showing count if > 0
- CardContent: alert list

**Each alert row** (flex, items-start, justify-between, py-3, border-b last:border-0):
Left side:
- SeverityIcon for the alert severity
- Title (text-sm font-medium): alert.title (e.g., "Failed to send to John Smith", "Negative feedback from Sarah")
- Description (text-xs text-muted-foreground): alert.description + relative timestamp

Right side -- contextual action button based on alert type:
- `failed_send` (retryable): Button "Retry" (size="sm", variant="outline") -> calls `retrySend(alert.sendLogId!)` with loading state
- `bounced_email`: Button "Update contact" (size="sm", variant="outline") -> Link to alert.contextualAction.href
- `unresolved_feedback`: Button "Respond" (size="sm", variant="outline") -> Link to alert.contextualAction.href
- For bounced/STOP: overflow DropdownMenu with "Acknowledge" option -> calls `acknowledgeAlert(alert.sendLogId!)`

**Show only first 3 alerts by default.** Use `useState` for expanded state. Toggle "View all ({total})" / "Show less" link.

**Empty state:**
- "No issues -- everything is running smoothly" with CheckCircle icon in green
- This state should feel reassuring, not empty

**AttentionAlertsSkeleton** (exported):
- Card with header skeleton
- 3 skeleton rows with icon placeholder, text lines, and button placeholder

Use `useTransition` for action loading states.
Import `retrySend`, `acknowledgeAlert` from `@/lib/actions/dashboard`.
Import `toast` from `sonner`.
Import icons from `@phosphor-icons/react`: XCircle, WarningCircle, Info, CheckCircle, DotsThree.
  </action>
  <verify>Run `pnpm typecheck` -- no errors. Verify AttentionAlerts and AttentionAlertsSkeleton are exported.</verify>
  <done>Alerts display with severity ordering, contextual inline actions work, expand/collapse for 3+ alerts, acknowledged alerts excluded.</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- retrySend and acknowledgeAlert server actions exported
- AttentionAlerts and AttentionAlertsSkeleton exported
- Failed sends show "Retry" button, bounced show "Update contact" link
- Unresolved feedback shows "Respond" link
- Default shows 3, expandable to see all
- No budget/billing alerts included
</verification>

<success_criteria>
- Each alert type has a unique contextual action (not generic)
- Retry resets to pending status for cron pickup
- Acknowledge mechanism prevents re-showing permanent failures
- Severity ordering: critical (failed) > warning (bounced) > info (feedback)
- Dark mode supported throughout
</success_criteria>

<output>
After completion, create `.planning/phases/27-dashboard-redesign/27-04-SUMMARY.md`
</output>
