---
phase: 27-dashboard-redesign
plan: 05
type: execute
wave: 3
depends_on: ["27-01", "27-02", "27-03", "27-04"]
files_modified:
  - app/(dashboard)/dashboard/page.tsx
  - components/layout/sidebar.tsx
  - components/layout/bottom-nav.tsx
  - components/layout/app-shell.tsx
  - app/(dashboard)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard page assembles banner, KPIs, queue, and alerts in correct order"
    - "All dashboard data fetched in parallel via Promise.all()"
    - "Navigation sidebar shows Dashboard link with attention badge count"
    - "Sidebar has persistent 'Add Job' button accessible from any page"
    - "Navigation items match CONTEXT.md: Dashboard, Send/Queue, Customers, Jobs, Campaigns, Activity/History, Feedback"
    - "Bottom nav updated with dashboard as first item on mobile"
  artifacts:
    - path: "app/(dashboard)/dashboard/page.tsx"
      provides: "Dashboard page with parallel data fetching"
      min_lines: 40
    - path: "components/layout/sidebar.tsx"
      provides: "Updated sidebar with Dashboard link, badge, Add Job button"
  key_links:
    - from: "app/(dashboard)/dashboard/page.tsx"
      to: "lib/data/dashboard.ts"
      via: "Promise.all parallel fetch"
      pattern: "Promise\\.all"
    - from: "app/(dashboard)/dashboard/page.tsx"
      to: "components/dashboard"
      via: "component imports"
      pattern: "import.*components/dashboard"
    - from: "app/(dashboard)/layout.tsx"
      to: "lib/data/dashboard.ts"
      via: "getDashboardCounts() for badge"
      pattern: "getDashboardCounts"
    - from: "components/layout/sidebar.tsx"
      to: "lib/data/dashboard.ts"
      via: "getDashboardCounts for badge"
      pattern: "getDashboardCounts|dashboardCounts"
---

<objective>
Assemble the dashboard page from components built in plans 02-04, and update navigation with Dashboard link, attention badges, and persistent "Add Job" button.

Purpose: This wires everything together. The page does the parallel data fetch and distributes data to child components. Navigation changes make the dashboard discoverable and add global actions.
Output: Working dashboard page at /dashboard and updated sidebar/bottom-nav.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-dashboard-redesign/27-CONTEXT.md
@.planning/phases/27-dashboard-redesign/27-RESEARCH.md
@lib/data/dashboard.ts
@lib/types/dashboard.ts
@lib/data/business.ts
@components/layout/sidebar.tsx
@components/layout/bottom-nav.tsx
@components/layout/app-shell.tsx
@app/(dashboard)/layout.tsx
@app/(dashboard)/send/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dashboard page with parallel data fetching</name>
  <files>app/(dashboard)/dashboard/page.tsx</files>
  <action>
Create `app/(dashboard)/dashboard/page.tsx` as a Server Component (no 'use client').

This is the main page assembly. Follow the pattern from `app/(dashboard)/send/page.tsx` for auth + data fetching.

```typescript
import { getBusiness } from '@/lib/actions/business'
import { getServiceTypeSettings } from '@/lib/data/business'
import {
  getDashboardKPIs,
  getReadyToSendJobs,
  getAttentionAlerts,
} from '@/lib/data/dashboard'
import { getUnresolvedFeedbackCount } from '@/lib/data/feedback'
import { getJobCounts } from '@/lib/data/jobs'
import { redirect } from 'next/navigation'

import { ActionSummaryBanner } from '@/components/dashboard/action-summary-banner'
import { KPIWidgets } from '@/components/dashboard/kpi-widgets'
import { ReadyToSendQueue } from '@/components/dashboard/ready-to-send-queue'
import { AttentionAlerts } from '@/components/dashboard/attention-alerts'
```

Implementation:
1. `const business = await getBusiness()` -- redirect to /onboarding if null.
2. Fetch service type settings for urgency calculation.
3. Parallel fetch ALL dashboard data:
```typescript
const [kpiData, serviceSettings, readyJobs, alerts, feedbackCount, jobCounts] = await Promise.all([
  getDashboardKPIs(business.id),
  getServiceTypeSettings(),
  getReadyToSendJobs(business.id, serviceTypeTiming),
  getAttentionAlerts(business.id),
  getUnresolvedFeedbackCount(business.id),
  getJobCounts(),
])
```
Note: For serviceTypeTiming, you may need to resolve it before the Promise.all or pass defaults. Simplest: pass default timing to getReadyToSendJobs, then refine if settings exist.

4. Render layout (CONTEXT.md order):
```jsx
<div className="container mx-auto py-6 px-4 space-y-6">
  <h1 className="text-2xl font-bold">Dashboard</h1>
  <ActionSummaryBanner
    readyCount={readyJobs.length}
    alertCount={alerts.length}
  />
  <KPIWidgets data={kpiData} />
  <ReadyToSendQueue
    jobs={readyJobs}
    hasJobHistory={jobCounts.total > 0}
  />
  <AttentionAlerts
    alerts={alerts}
    feedbackCount={feedbackCount}
  />
</div>
```

Add metadata export:
```typescript
export const metadata = {
  title: 'Dashboard | AvisLoop',
}
```
  </action>
  <verify>Run `pnpm typecheck` -- no errors. Verify page imports all dashboard components correctly.</verify>
  <done>Dashboard page at /dashboard fetches data in parallel and renders all four sections in correct order.</done>
</task>

<task type="auto">
  <name>Task 2: Update navigation (sidebar, bottom-nav, app-shell, layout)</name>
  <files>
    components/layout/sidebar.tsx
    components/layout/bottom-nav.tsx
    components/layout/app-shell.tsx
    app/(dashboard)/layout.tsx
  </files>
  <action>
NOTE: This task modifies 4 files but all changes are straightforward navigation wiring -- adding nav items, passing a prop, and fetching a count. Each file change is small (5-20 lines).

**Sidebar (`components/layout/sidebar.tsx`):**

1. Add Dashboard as the FIRST item in mainNav array:
```typescript
{ icon: House, label: 'Dashboard', href: '/dashboard' }
```
Import `House` from `@phosphor-icons/react`.

2. Keep existing nav items but rename "Requests" to "Activity" per CONTEXT.md:
```typescript
const mainNav: NavItem[] = [
  { icon: House, label: 'Dashboard', href: '/dashboard' },
  { icon: PaperPlaneTilt, label: 'Send', href: '/send' },
  { icon: AddressBook, label: 'Customers', href: '/customers' },
  { icon: Briefcase, label: 'Jobs', href: '/jobs' },
  { icon: Megaphone, label: 'Campaigns', href: '/campaigns' },
  { icon: ClockCounterClockwise, label: 'Activity', href: '/history' },
  { icon: ChatCircleText, label: 'Feedback', href: '/feedback' },
]
```

3. Add badge support to NavItem interface:
```typescript
interface NavItem {
  icon: React.ElementType
  label: string
  href: string
  badge?: number  // optional badge count
}
```

4. Accept `dashboardBadge` as a prop:
```typescript
export function Sidebar({ dashboardBadge }: { dashboardBadge?: number })
```
Apply badge to the Dashboard nav item.

5. In the NavLink component, render badge if present:
```tsx
{!collapsed && item.badge && item.badge > 0 && (
  <span className="ml-auto bg-red-500 text-white text-xs font-bold rounded-full px-1.5 py-0.5 min-w-[20px] text-center">
    {item.badge > 99 ? '99+' : item.badge}
  </span>
)}
{collapsed && item.badge && item.badge > 0 && (
  <span className="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full" />
)}
```
For collapsed state, show a small red dot. For expanded, show the number.
Make NavLink position: relative when it has a badge.

6. Add persistent "Add Job" button above the Account section (between nav and footer):
```tsx
<div className="p-3 border-t border-[#E2E2E2] dark:border-border">
  <Link href="/jobs?action=add">
    <Button
      variant="outline"
      className={cn(
        "w-full justify-start gap-2 text-sm",
        collapsed && "justify-center px-2"
      )}
    >
      <Plus size={16} weight="bold" />
      {!collapsed && "Add Job"}
    </Button>
  </Link>
</div>
```
Import `Plus` from `@phosphor-icons/react`.

**Bottom Nav (`components/layout/bottom-nav.tsx`):**

1. Add Dashboard as first item, update items to match sidebar:
```typescript
const items = [
  { icon: House, label: 'Dashboard', href: '/dashboard' },
  { icon: PaperPlaneTilt, label: 'Send', href: '/send' },
  { icon: Briefcase, label: 'Jobs', href: '/jobs' },
  { icon: Megaphone, label: 'Campaigns', href: '/campaigns' },
  { icon: ClockCounterClockwise, label: 'Activity', href: '/history' },
]
```
Import `House, Briefcase, Megaphone` from `@phosphor-icons/react`.
Update grid to `grid-cols-5`.

**App Shell (`components/layout/app-shell.tsx`):**

1. Accept and pass through `dashboardBadge` prop:
```typescript
interface AppShellProps {
  children: React.ReactNode
  pageTitle?: string
  setupProgress?: { ... } | null
  dashboardBadge?: number
}
```
Pass to `<Sidebar dashboardBadge={dashboardBadge} />`.

**Dashboard Layout (`app/(dashboard)/layout.tsx`):**

1. Update the layout to fetch dashboard counts and pass as prop:
```typescript
import { getDashboardCounts } from '@/lib/data/dashboard'

export default async function DashboardGroupLayout({ children }) {
  const setupProgress = await getSetupProgress()

  // Get badge count for nav (lightweight query)
  let dashboardBadge = 0
  try {
    const counts = await getDashboardCounts()
    dashboardBadge = counts.total
  } catch {
    // Non-critical, badge just shows 0
  }

  return (
    <AppShell setupProgress={setupProgress} dashboardBadge={dashboardBadge}>
      {children}
    </AppShell>
  )
}
```
Note: `getDashboardCounts()` handles auth internally (no businessId param needed -- see Plan 27-01 Task 2). If user is not authenticated or has no business, it returns zeros.
  </action>
  <verify>Run `pnpm typecheck` -- no errors. Run `pnpm lint` -- no errors. Verify sidebar shows Dashboard as first item. Verify layout.tsx calls getDashboardCounts().</verify>
  <done>Dashboard link is first nav item with attention badge. Sidebar has "Add Job" button. Bottom nav updated for mobile. Badge count fetched in layout via getDashboardCounts() with no args.</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm lint` passes
- Dashboard page exists at app/(dashboard)/dashboard/page.tsx
- Sidebar shows Dashboard, Send, Customers, Jobs, Campaigns, Activity, Feedback
- Dashboard nav item has red badge when alerts exist
- "Add Job" button visible in sidebar (expanded and collapsed)
- Bottom nav has 5 items including Dashboard
- All data fetched in parallel via Promise.all()
- layout.tsx calls getDashboardCounts() (no args)
</verification>

<success_criteria>
- Dashboard page renders all four sections in CONTEXT.md order (banner, KPIs, queue, alerts)
- Navigation restructured per CONTEXT.md with Dashboard first
- Badge count updates on every dashboard page load
- "Add Job" accessible from any page via sidebar
- Mobile bottom nav includes key navigation items
- No waterfall data fetching
</success_criteria>

<output>
After completion, create `.planning/phases/27-dashboard-redesign/27-05-SUMMARY.md`
</output>
