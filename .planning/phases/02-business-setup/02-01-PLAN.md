---
phase: 02-business-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00002_create_business.sql
  - lib/validations/business.ts
  - lib/types/database.ts
autonomous: true

must_haves:
  truths:
    - "businesses table exists with user_id FK to auth.users"
    - "email_templates table exists with business_id FK to businesses"
    - "RLS policies prevent cross-user data access"
    - "Zod schemas validate business and template input"
  artifacts:
    - path: "supabase/migrations/00002_create_business.sql"
      provides: "Database schema for businesses and email_templates"
      contains: "CREATE TABLE"
    - path: "lib/validations/business.ts"
      provides: "Zod validation schemas"
      exports: ["businessSchema", "emailTemplateSchema"]
    - path: "lib/types/database.ts"
      provides: "TypeScript types for database tables"
      exports: ["Business", "EmailTemplate"]
  key_links:
    - from: "businesses.user_id"
      to: "auth.users.id"
      via: "FOREIGN KEY CASCADE"
    - from: "email_templates.business_id"
      to: "businesses.id"
      via: "FOREIGN KEY CASCADE"
---

<objective>
Create database schema for business profiles and email templates, along with validation schemas and TypeScript types.

Purpose: Foundation for storing business settings - this phase enables users to configure their business profile and review request settings.

Output:
- Migration file with businesses and email_templates tables, RLS policies, indexes
- Zod validation schemas following Phase 1 patterns
- TypeScript type definitions for strong typing throughout the app
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-business-setup/02-RESEARCH.md

# Phase 1 patterns to follow
@supabase/migrations/00001_create_profiles.sql
@lib/validations/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for businesses and email_templates</name>
  <files>supabase/migrations/00002_create_business.sql</files>
  <action>
Create migration file with:

1. **businesses table:**
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
   - name TEXT NOT NULL with CHECK (char_length(name) > 0)
   - google_review_link TEXT (nullable)
   - default_sender_name TEXT (nullable)
   - default_template_id UUID (add FK after email_templates created)
   - created_at TIMESTAMPTZ DEFAULT NOW()
   - updated_at TIMESTAMPTZ DEFAULT NOW()

2. **email_templates table:**
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - business_id UUID NOT NULL REFERENCES businesses(id) ON DELETE CASCADE
   - name TEXT NOT NULL with CHECK
   - subject TEXT NOT NULL with CHECK
   - body TEXT NOT NULL with CHECK
   - is_default BOOLEAN DEFAULT false
   - created_at TIMESTAMPTZ DEFAULT NOW()
   - updated_at TIMESTAMPTZ DEFAULT NOW()

3. **Add circular FK:** ALTER TABLE businesses ADD CONSTRAINT fk_default_template...ON DELETE SET NULL

4. **Enable RLS** on both tables

5. **Create indexes** on foreign key columns (user_id, business_id)

6. **RLS Policies for businesses:**
   - "Users view own businesses" SELECT with (SELECT auth.uid()) = user_id
   - "Users insert own businesses" INSERT WITH CHECK
   - "Users update own businesses" UPDATE with USING and WITH CHECK
   - "Users delete own businesses" DELETE with USING
   - All policies TO authenticated

7. **RLS Policies for email_templates:**
   - Use subquery pattern: business_id IN (SELECT id FROM businesses WHERE user_id = (SELECT auth.uid()))
   - SELECT, INSERT, UPDATE, DELETE policies
   - All policies TO authenticated

8. **moddatetime triggers** for updated_at on both tables:
   - CREATE EXTENSION IF NOT EXISTS moddatetime SCHEMA extensions
   - Create triggers for businesses_updated_at and templates_updated_at

9. **Seed default templates** (2 templates with placeholder business_id for system templates):
   - "Simple Review Request" - basic request
   - "Friendly Follow-up" - warmer tone
   - Use {{CUSTOMER_NAME}}, {{BUSINESS_NAME}}, {{REVIEW_LINK}}, {{SENDER_NAME}} variables

Follow Phase 1 migration patterns exactly (comments, naming conventions, policy structure).
  </action>
  <verify>
File exists at supabase/migrations/00002_create_business.sql with valid SQL syntax.
Run: `npx supabase db lint` or manually review SQL syntax.
  </verify>
  <done>
Migration file contains businesses table, email_templates table, RLS policies with (SELECT auth.uid()) wrapper, indexed FKs, moddatetime triggers, and 2 seed templates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Zod validation schemas for business forms</name>
  <files>lib/validations/business.ts</files>
  <action>
Create validation schemas following Phase 1 auth.ts pattern:

```typescript
import { z } from 'zod'

// Business profile validation
export const businessSchema = z.object({
  name: z
    .string()
    .min(1, 'Business name is required')
    .max(100, 'Business name must be less than 100 characters')
    .trim(),
  googleReviewLink: z
    .string()
    .url('Please enter a valid URL')
    .includes('google.com', { message: 'Must be a Google URL' })
    .optional()
    .or(z.literal('')), // Allow empty string from form
  defaultSenderName: z
    .string()
    .max(100, 'Sender name must be less than 100 characters')
    .trim()
    .optional()
    .or(z.literal('')),
  defaultTemplateId: z
    .string()
    .uuid('Invalid template ID')
    .optional()
    .or(z.literal('')),
})

// Email template validation
export const emailTemplateSchema = z.object({
  name: z
    .string()
    .min(1, 'Template name is required')
    .max(100, 'Template name must be less than 100 characters')
    .trim(),
  subject: z
    .string()
    .min(1, 'Email subject is required')
    .max(200, 'Subject must be less than 200 characters')
    .trim(),
  body: z
    .string()
    .min(1, 'Email body is required')
    .max(5000, 'Body must be less than 5000 characters')
    .trim(),
})

// Type exports
export type BusinessInput = z.infer<typeof businessSchema>
export type EmailTemplateInput = z.infer<typeof emailTemplateSchema>
```

Key patterns:
- .optional().or(z.literal('')) for optional fields that may come as empty string from forms
- .trim() on all text fields
- Match max lengths to database constraints
- URL validation for Google review link (flexible, allows any google.com URL)
  </action>
  <verify>
Run: `npx tsc --noEmit lib/validations/business.ts` - no TypeScript errors.
  </verify>
  <done>
Zod schemas export businessSchema, emailTemplateSchema, BusinessInput, EmailTemplateInput with proper optional field handling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create TypeScript types for database tables</name>
  <files>lib/types/database.ts</files>
  <action>
Create TypeScript types matching the database schema:

```typescript
// Database table types for businesses and email_templates
// These types match the schema in supabase/migrations/00002_create_business.sql

export interface Business {
  id: string
  user_id: string
  name: string
  google_review_link: string | null
  default_sender_name: string | null
  default_template_id: string | null
  created_at: string
  updated_at: string
}

export interface EmailTemplate {
  id: string
  business_id: string
  name: string
  subject: string
  body: string
  is_default: boolean
  created_at: string
  updated_at: string
}

// Combined type for business with nested templates (from Supabase joins)
export interface BusinessWithTemplates extends Business {
  email_templates: EmailTemplate[]
}

// Insert/Update types (omit auto-generated fields)
export type BusinessInsert = Omit<Business, 'id' | 'created_at' | 'updated_at'>
export type BusinessUpdate = Partial<Omit<Business, 'id' | 'user_id' | 'created_at' | 'updated_at'>>

export type EmailTemplateInsert = Omit<EmailTemplate, 'id' | 'created_at' | 'updated_at'>
export type EmailTemplateUpdate = Partial<Omit<EmailTemplate, 'id' | 'business_id' | 'created_at' | 'updated_at'>>
```

Note: Use `string` for UUID and timestamp fields (Supabase returns these as strings).
  </action>
  <verify>
Run: `npx tsc --noEmit lib/types/database.ts` - no TypeScript errors.
  </verify>
  <done>
Types exported: Business, EmailTemplate, BusinessWithTemplates, BusinessInsert, BusinessUpdate, EmailTemplateInsert, EmailTemplateUpdate.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Migration file exists with valid SQL:
   - businesses table with all columns and constraints
   - email_templates table with all columns and constraints
   - RLS enabled and policies created for both tables
   - Indexes on user_id and business_id
   - moddatetime triggers configured
   - Default templates seeded

2. Validation schemas compile:
   - `npx tsc --noEmit lib/validations/business.ts`

3. Type definitions compile:
   - `npx tsc --noEmit lib/types/database.ts`

4. Overall build passes:
   - `npm run build` completes without errors
</verification>

<success_criteria>
- Migration file ready to run in Supabase SQL Editor
- Zod schemas handle both required and optional form fields
- TypeScript types provide strong typing for database operations
- All files follow Phase 1 patterns and conventions
</success_criteria>

<output>
After completion, create `.planning/phases/02-business-setup/02-01-SUMMARY.md`
</output>
