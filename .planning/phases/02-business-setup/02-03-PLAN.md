---
phase: 02-business-setup
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - app/dashboard/settings/page.tsx
  - components/business-settings-form.tsx
  - components/email-template-form.tsx
  - components/template-list.tsx
autonomous: false

must_haves:
  truths:
    - "User can see settings page with business profile fields"
    - "User can enter and save business name"
    - "User can enter and save Google review link"
    - "User can see list of available email templates"
    - "User can select a default template"
    - "User can enter and save sender name"
    - "User can create a new email template"
    - "Settings persist across page refresh"
  artifacts:
    - path: "app/dashboard/settings/page.tsx"
      provides: "Settings page Server Component"
      min_lines: 20
    - path: "components/business-settings-form.tsx"
      provides: "Business profile form Client Component"
      min_lines: 50
    - path: "components/email-template-form.tsx"
      provides: "Email template creation form"
      min_lines: 40
    - path: "components/template-list.tsx"
      provides: "List of available templates with selection"
      min_lines: 30
  key_links:
    - from: "app/dashboard/settings/page.tsx"
      to: "lib/actions/business.ts"
      via: "getBusiness() import"
      pattern: "import.*getBusiness.*from"
    - from: "components/business-settings-form.tsx"
      to: "lib/actions/business.ts"
      via: "updateBusiness action"
      pattern: "useActionState.*updateBusiness"
    - from: "components/email-template-form.tsx"
      to: "lib/actions/business.ts"
      via: "createEmailTemplate action"
      pattern: "useActionState.*createEmailTemplate"
---

<objective>
Create the settings page UI with forms for business profile and email templates.

Purpose: Enable users to configure their business settings through a clean, functional interface following Phase 1 form patterns.

Output:
- Server Component settings page that fetches existing data
- Client Component forms using useActionState hook
- Template selection and creation UI
- Per-field validation error display
- Success/error feedback
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-business-setup/02-RESEARCH.md

# Phase 1 form patterns
@components/login-form.tsx
@components/sign-up-form.tsx

# Plan 02 artifacts (MUST exist before this plan runs)
@lib/actions/business.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Settings page Server Component</name>
  <files>app/dashboard/settings/page.tsx</files>
  <action>
Create the settings page as a Server Component that fetches data and passes to Client Component forms:

```typescript
import { redirect } from 'next/navigation'
import { createClient } from '@/lib/supabase/server'
import { getBusiness, getEmailTemplates } from '@/lib/actions/business'
import { BusinessSettingsForm } from '@/components/business-settings-form'
import { EmailTemplateForm } from '@/components/email-template-form'
import { TemplateList } from '@/components/template-list'

export default async function SettingsPage() {
  const supabase = await createClient()

  // Verify user is authenticated
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    redirect('/login')
  }

  // Fetch existing business data (null if new user)
  const business = await getBusiness()
  const templates = await getEmailTemplates()

  return (
    <div className="max-w-4xl mx-auto p-6 space-y-8">
      <div>
        <h1 className="text-3xl font-bold">Settings</h1>
        <p className="text-gray-600 mt-2">
          Configure your business profile and email templates
        </p>
      </div>

      {/* Section 1: Business Profile */}
      <section className="border rounded-lg p-6 bg-white shadow-sm">
        <h2 className="text-xl font-semibold mb-4">Business Profile</h2>
        <BusinessSettingsForm initialData={business} templates={templates} />
      </section>

      {/* Section 2: Email Templates */}
      <section className="border rounded-lg p-6 bg-white shadow-sm">
        <h2 className="text-xl font-semibold mb-4">Email Templates</h2>
        <p className="text-gray-600 mb-4">
          Customize your review request messages. Use variables like
          {' '}{'{{CUSTOMER_NAME}}'}, {'{{BUSINESS_NAME}}'}, {'{{REVIEW_LINK}}'}, {'{{SENDER_NAME}}'}.
        </p>

        {/* Show existing templates */}
        <TemplateList templates={templates} />

        {/* Only show template form if business exists */}
        {business && (
          <div className="mt-6 pt-6 border-t">
            <h3 className="text-lg font-medium mb-4">Create New Template</h3>
            <EmailTemplateForm />
          </div>
        )}

        {!business && (
          <p className="text-amber-600 text-sm mt-4">
            Save your business profile above before creating custom templates.
          </p>
        )}
      </section>
    </div>
  )
}
```

Key patterns:
- Server Component (no 'use client')
- Auth check with redirect
- Fetch data before rendering
- Pass initialData as props to Client Components
- Conditional rendering based on business existence
  </action>
  <verify>
File exists at app/dashboard/settings/page.tsx.
Check imports are correct paths.
  </verify>
  <done>
Settings page renders business profile form and email template sections. Data fetched server-side and passed to Client Components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BusinessSettingsForm Client Component</name>
  <files>components/business-settings-form.tsx</files>
  <action>
Create the business settings form following Phase 1 form patterns exactly:

```typescript
'use client'

import { useActionState } from 'react'
import { updateBusiness, BusinessActionState } from '@/lib/actions/business'
import type { Business, EmailTemplate } from '@/lib/types/database'

interface BusinessSettingsFormProps {
  initialData: Business | null
  templates: EmailTemplate[]
}

export function BusinessSettingsForm({ initialData, templates }: BusinessSettingsFormProps) {
  const [state, formAction, isPending] = useActionState<BusinessActionState | null, FormData>(
    updateBusiness,
    null
  )

  return (
    <form action={formAction} className="space-y-6">
      {/* General error */}
      {state?.error && (
        <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded">
          {state.error}
        </div>
      )}

      {/* Success message */}
      {state?.success && (
        <div className="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded">
          Settings saved successfully!
        </div>
      )}

      {/* Business Name */}
      <div>
        <label htmlFor="name" className="block text-sm font-medium text-gray-700 mb-1">
          Business Name <span className="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="name"
          name="name"
          required
          defaultValue={initialData?.name || ''}
          className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Your Business Name"
        />
        {state?.fieldErrors?.name && (
          <p className="text-red-600 text-sm mt-1">{state.fieldErrors.name[0]}</p>
        )}
      </div>

      {/* Google Review Link */}
      <div>
        <label htmlFor="googleReviewLink" className="block text-sm font-medium text-gray-700 mb-1">
          Google Review Link
        </label>
        <input
          type="url"
          id="googleReviewLink"
          name="googleReviewLink"
          defaultValue={initialData?.google_review_link || ''}
          className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="https://search.google.com/local/writereview?placeid=..."
        />
        {state?.fieldErrors?.googleReviewLink && (
          <p className="text-red-600 text-sm mt-1">{state.fieldErrors.googleReviewLink[0]}</p>
        )}
        <p className="text-sm text-gray-500 mt-1">
          Find your Google Business Profile and copy the "Write a review" link
        </p>
      </div>

      {/* Default Sender Name */}
      <div>
        <label htmlFor="defaultSenderName" className="block text-sm font-medium text-gray-700 mb-1">
          Default Sender Name
        </label>
        <input
          type="text"
          id="defaultSenderName"
          name="defaultSenderName"
          defaultValue={initialData?.default_sender_name || ''}
          className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Your Name or Business Name"
        />
        {state?.fieldErrors?.defaultSenderName && (
          <p className="text-red-600 text-sm mt-1">{state.fieldErrors.defaultSenderName[0]}</p>
        )}
        <p className="text-sm text-gray-500 mt-1">
          This name will appear in your review request emails
        </p>
      </div>

      {/* Default Template Selection */}
      <div>
        <label htmlFor="defaultTemplateId" className="block text-sm font-medium text-gray-700 mb-1">
          Default Email Template
        </label>
        <select
          id="defaultTemplateId"
          name="defaultTemplateId"
          defaultValue={initialData?.default_template_id || ''}
          className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="">Select a template...</option>
          {templates.map((template) => (
            <option key={template.id} value={template.id}>
              {template.name} {template.is_default ? '(Default)' : ''}
            </option>
          ))}
        </select>
        {state?.fieldErrors?.defaultTemplateId && (
          <p className="text-red-600 text-sm mt-1">{state.fieldErrors.defaultTemplateId[0]}</p>
        )}
      </div>

      {/* Submit Button */}
      <div className="pt-4">
        <button
          type="submit"
          disabled={isPending}
          className="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {isPending ? 'Saving...' : 'Save Settings'}
        </button>
      </div>
    </form>
  )
}
```

Key patterns (matching Phase 1):
- 'use client' directive
- useActionState<BusinessActionState | null, FormData>(action, null)
- defaultValue for form fields (not value - uncontrolled inputs)
- state?.error for general errors
- state?.fieldErrors?.fieldName[0] for field errors
- isPending for loading state
- disabled={isPending} on submit button
  </action>
  <verify>
Run: `npx tsc --noEmit components/business-settings-form.tsx` - no TypeScript errors.
  </verify>
  <done>
BusinessSettingsForm renders all fields (name, googleReviewLink, defaultSenderName, defaultTemplateId) with validation errors and success feedback.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create EmailTemplateForm and TemplateList components</name>
  <files>
    components/email-template-form.tsx
    components/template-list.tsx
  </files>
  <action>
Create the template form and list components:

**components/email-template-form.tsx:**
```typescript
'use client'

import { useActionState } from 'react'
import { createEmailTemplate, BusinessActionState } from '@/lib/actions/business'

export function EmailTemplateForm() {
  const [state, formAction, isPending] = useActionState<BusinessActionState | null, FormData>(
    createEmailTemplate,
    null
  )

  return (
    <form action={formAction} className="space-y-4">
      {/* General error */}
      {state?.error && (
        <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded">
          {state.error}
        </div>
      )}

      {/* Success message */}
      {state?.success && (
        <div className="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded">
          Template created successfully!
        </div>
      )}

      {/* Template Name */}
      <div>
        <label htmlFor="template-name" className="block text-sm font-medium text-gray-700 mb-1">
          Template Name <span className="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="template-name"
          name="name"
          required
          className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="My Custom Template"
        />
        {state?.fieldErrors?.name && (
          <p className="text-red-600 text-sm mt-1">{state.fieldErrors.name[0]}</p>
        )}
      </div>

      {/* Email Subject */}
      <div>
        <label htmlFor="template-subject" className="block text-sm font-medium text-gray-700 mb-1">
          Email Subject <span className="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="template-subject"
          name="subject"
          required
          className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="We would love your feedback, {{CUSTOMER_NAME}}!"
        />
        {state?.fieldErrors?.subject && (
          <p className="text-red-600 text-sm mt-1">{state.fieldErrors.subject[0]}</p>
        )}
      </div>

      {/* Email Body */}
      <div>
        <label htmlFor="template-body" className="block text-sm font-medium text-gray-700 mb-1">
          Email Body <span className="text-red-500">*</span>
        </label>
        <textarea
          id="template-body"
          name="body"
          required
          rows={8}
          className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
          placeholder={`Hi {{CUSTOMER_NAME}},

Thank you for choosing {{BUSINESS_NAME}}!

We would really appreciate if you could leave us a review:
{{REVIEW_LINK}}

Best regards,
{{SENDER_NAME}}`}
        />
        {state?.fieldErrors?.body && (
          <p className="text-red-600 text-sm mt-1">{state.fieldErrors.body[0]}</p>
        )}
      </div>

      {/* Submit Button */}
      <div className="pt-2">
        <button
          type="submit"
          disabled={isPending}
          className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {isPending ? 'Creating...' : 'Create Template'}
        </button>
      </div>
    </form>
  )
}
```

**components/template-list.tsx:**
```typescript
import type { EmailTemplate } from '@/lib/types/database'

interface TemplateListProps {
  templates: EmailTemplate[]
}

export function TemplateList({ templates }: TemplateListProps) {
  if (templates.length === 0) {
    return (
      <p className="text-gray-500 italic">
        No templates yet. Default templates will be available after you create your business profile.
      </p>
    )
  }

  return (
    <div className="space-y-4">
      {templates.map((template) => (
        <div
          key={template.id}
          className="border rounded-md p-4 bg-gray-50"
        >
          <div className="flex items-center justify-between mb-2">
            <h4 className="font-medium">
              {template.name}
              {template.is_default && (
                <span className="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">
                  System Default
                </span>
              )}
            </h4>
          </div>
          <p className="text-sm text-gray-600 mb-2">
            <span className="font-medium">Subject:</span> {template.subject}
          </p>
          <details className="text-sm">
            <summary className="cursor-pointer text-blue-600 hover:text-blue-800">
              View body
            </summary>
            <pre className="mt-2 p-3 bg-white border rounded text-xs whitespace-pre-wrap font-mono">
              {template.body}
            </pre>
          </details>
        </div>
      ))}
    </div>
  )
}
```

Note: TemplateList is a Server Component (no 'use client') - just displays data.
  </action>
  <verify>
Run: `npx tsc --noEmit components/email-template-form.tsx components/template-list.tsx` - no TypeScript errors.
  </verify>
  <done>
EmailTemplateForm allows creating new templates. TemplateList displays existing templates with expandable body preview.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete settings page with:
- Business profile form (name, Google review link, sender name, template selection)
- Email template list with expandable previews
- Email template creation form
- Form validation and success/error feedback
  </what-built>
  <how-to-verify>
1. Run the migration in Supabase Dashboard SQL Editor (paste contents of supabase/migrations/00002_create_business.sql)

2. Start dev server: `npm run dev`

3. Log in to the app (or create account if needed)

4. Navigate to: http://localhost:3000/dashboard/settings

5. Test business profile form:
   - Enter a business name and save -> Should show "Settings saved successfully!"
   - Reload page -> Business name should persist
   - Add Google review link (any google.com URL) -> Should save
   - Add sender name -> Should save
   - Select a template from dropdown (if templates exist) -> Should save

6. Test email template creation:
   - Fill in template name, subject, and body
   - Click "Create Template" -> Should show success
   - New template should appear in the list above

7. Test validation:
   - Clear business name and submit -> Should show field error
   - Enter invalid URL in Google review link -> Should show validation error

8. Verify data persists:
   - Refresh page -> All saved data should still be there
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. All files created:
   - app/dashboard/settings/page.tsx
   - components/business-settings-form.tsx
   - components/email-template-form.tsx
   - components/template-list.tsx

2. Build passes:
   - `npm run build` completes without errors

3. Functionality verified:
   - Settings page loads with existing data
   - Business profile can be created/updated
   - Templates can be viewed and created
   - Validation errors display per-field
   - Success messages appear after save
</verification>

<success_criteria>
- User can access settings page at /dashboard/settings
- User can create and update business profile
- User can see available email templates
- User can create custom email templates
- Form validation prevents invalid input
- Data persists across page refreshes
- All Phase 2 requirements (BUSI-01 through BUSI-04) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-business-setup/02-03-SUMMARY.md`
</output>
