---
phase: 38-onboarding-consolidation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - components/onboarding/setup-progress-pill.tsx
  - components/onboarding/setup-progress-drawer.tsx
  - lib/data/checklist.ts
  - lib/actions/checklist.ts
  - app/(dashboard)/campaigns/page.tsx
autonomous: true

must_haves:
  truths:
    - "Getting Started pill uses warm amber styling (bg-warning-bg, text-warning-foreground, border-warning-border) instead of cold blue (bg-primary/10)"
    - "The 'Review your campaign' checklist item does NOT auto-complete when a campaign is created during wizard — it requires visiting /campaigns"
    - "Visiting the campaigns page for the first time sets campaign_reviewed=true in the business onboarding_checklist JSONB"
    - "Progress bar in drawer uses warm amber (bg-warning) instead of cold blue (bg-primary)"
  artifacts:
    - path: "components/onboarding/setup-progress-pill.tsx"
      provides: "Warm amber pill styling for incomplete state"
      contains: "bg-warning-bg"
    - path: "components/onboarding/setup-progress-drawer.tsx"
      provides: "Warm amber progress bar"
      contains: "bg-warning"
    - path: "lib/actions/checklist.ts"
      provides: "markCampaignReviewed server action"
      contains: "markCampaignReviewed"
    - path: "lib/data/checklist.ts"
      provides: "campaign_reviewed reads stored flag instead of campaignCount"
      contains: "storedChecklist?.campaign_reviewed"
    - path: "app/(dashboard)/campaigns/page.tsx"
      provides: "Calls markCampaignReviewed on page load"
      contains: "markCampaignReviewed"
  key_links:
    - from: "app/(dashboard)/campaigns/page.tsx"
      to: "lib/actions/checklist.ts"
      via: "Server action called on page render"
      pattern: "await markCampaignReviewed"
    - from: "lib/data/checklist.ts"
      to: "businesses.onboarding_checklist"
      via: "Reads campaign_reviewed flag from JSONB"
      pattern: "storedChecklist\\?\\.campaign_reviewed"
---

<objective>
Replace the cold-blue Getting Started pill with warm amber accent styling, and fix the campaign_reviewed checklist item to require an actual page visit instead of auto-completing when a campaign exists.

Purpose: The warm amber pill aligns with the Phase 34 palette overhaul. The campaign_reviewed fix makes the checklist meaningful — users must actually review their campaign, not just have one created automatically during onboarding.

Output: Warm-styled pill and drawer, new markCampaignReviewed server action, fixed checklist logic, campaigns page integration.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-onboarding-consolidation/38-RESEARCH.md
@components/onboarding/setup-progress-pill.tsx
@components/onboarding/setup-progress-drawer.tsx
@lib/data/checklist.ts
@lib/actions/checklist.ts
@app/(dashboard)/campaigns/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Warm amber pill and drawer styling</name>
  <files>components/onboarding/setup-progress-pill.tsx, components/onboarding/setup-progress-drawer.tsx</files>
  <action>
  **In `setup-progress-pill.tsx`:**

  Replace the incomplete state button's className (currently lines 50-54):
  ```tsx
  'bg-primary/10 text-primary border border-primary/20',
  'hover:bg-primary/20 transition-colors'
  ```
  With warm amber tokens:
  ```tsx
  'bg-warning-bg text-warning-foreground border border-warning-border',
  'hover:bg-warning-bg/80 transition-colors'
  ```

  These tokens are already defined in globals.css and tailwind.config.ts (Phase 35):
  - `bg-warning-bg` = hsl(45 100% 96%) light / hsl(38 40% 14%) dark
  - `text-warning-foreground` = hsl(26 83% 14%) light / hsl(45 80% 85%) dark
  - `border-warning-border` = hsl(43 96% 77%) light / hsl(38 50% 25%) dark

  The complete state pill stays as-is (green success tokens are already correct).

  **In `setup-progress-drawer.tsx`:**

  Change the progress bar fill color from `bg-primary` to `bg-warning` on line 51:
  ```tsx
  // Before:
  className="h-full bg-primary transition-all duration-300"
  // After:
  className="h-full bg-warning transition-all duration-300"
  ```

  This makes the progress bar amber, matching the pill color. The `bg-warning` token maps to the amber accent hue.
  </action>
  <verify>Run `pnpm typecheck`. Grep `setup-progress-pill.tsx` for `bg-primary` — should be zero hits (all replaced with warning tokens). Grep `setup-progress-drawer.tsx` for `bg-warning` — should find the progress bar line.</verify>
  <done>Incomplete pill uses bg-warning-bg/text-warning-foreground/border-warning-border. Drawer progress bar uses bg-warning. No cold blue (bg-primary) remains in either component for the incomplete/in-progress state.</done>
</task>

<task type="auto">
  <name>Task 2: Fix campaign_reviewed to require actual page visit</name>
  <files>lib/actions/checklist.ts, lib/data/checklist.ts, app/(dashboard)/campaigns/page.tsx</files>
  <action>
  **Step A: Add `markCampaignReviewed` server action in `lib/actions/checklist.ts`:**

  Add a new exported async function at the end of the file:

  ```typescript
  /**
   * Mark the campaign as reviewed in the Getting Started checklist.
   * Called from the campaigns page on load so the checklist item
   * only completes when the user actually visits /campaigns.
   */
  export async function markCampaignReviewed(): Promise<{ success: boolean }> {
    try {
      const supabase = await createClient()
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) return { success: false }

      const { data: business } = await supabase
        .from('businesses')
        .select('id, onboarding_checklist')
        .eq('user_id', user.id)
        .single()

      if (!business) return { success: false }

      const current = (business.onboarding_checklist || {}) as Record<string, unknown>

      // Short-circuit if already marked — avoids unnecessary DB write
      if (current.campaign_reviewed === true) return { success: true }

      const { error } = await supabase
        .from('businesses')
        .update({
          onboarding_checklist: { ...current, campaign_reviewed: true }
        })
        .eq('id', business.id)

      if (error) {
        console.error('Failed to mark campaign reviewed:', error)
        return { success: false }
      }

      revalidatePath('/dashboard')
      revalidatePath('/campaigns')
      return { success: true }
    } catch (err) {
      console.error('markCampaignReviewed error:', err)
      return { success: false }
    }
  }
  ```

  The `revalidatePath` import is already at the top of the file.

  **Step B: Update `getChecklistState` in `lib/data/checklist.ts`:**

  1. Change line 76 from:
  ```typescript
  campaign_reviewed: campaignCount > 0,
  ```
  To:
  ```typescript
  campaign_reviewed: storedChecklist?.campaign_reviewed ?? false,
  ```

  2. The `campaignsResult` query (lines 39-43) is now dead code for the `campaign_reviewed` item. However, keep it for now — it may be useful for other future checklist items. Add a comment noting it could be removed:
  ```typescript
  // Count active campaigns (kept for potential future use; campaign_reviewed now uses stored flag)
  ```

  3. Also remove the `campaignCount` variable assignment (line 63) — OR keep it with a comment. Since the variable is no longer referenced in the items, the linter may flag it as unused. If so, remove the line:
  ```typescript
  // Remove or comment out:
  // const campaignCount = campaignsResult.count ?? 0
  ```
  And remove the `campaignsResult` from the Promise.all array as well to save a DB query. Update the destructured array to match:
  ```typescript
  const [jobsResult, completedJobsResult, reviewClicksResult, businessResult] = await Promise.all([
    // Count all jobs
    supabase
      .from('jobs')
      .select('id', { count: 'exact', head: true })
      .eq('business_id', businessId),
    // Count completed jobs
    supabase
      .from('jobs')
      .select('id', { count: 'exact', head: true })
      .eq('business_id', businessId)
      .eq('status', 'completed'),
    // Count review clicks
    supabase
      .from('campaign_enrollments')
      .select('id', { count: 'exact', head: true })
      .eq('business_id', businessId)
      .eq('stop_reason', 'review_clicked'),
    // Get stored checklist state
    supabase
      .from('businesses')
      .select('onboarding_checklist')
      .eq('id', businessId)
      .single(),
  ])
  ```
  This reduces parallel queries from 5 to 4.

  **Step C: Call from campaigns page in `app/(dashboard)/campaigns/page.tsx`:**

  Add the import and call at the top of the CampaignsPage function:

  ```typescript
  import { markCampaignReviewed } from '@/lib/actions/checklist'
  ```

  Inside the function body, BEFORE the existing `Promise.all` fetch:
  ```typescript
  export default async function CampaignsPage() {
    // Mark campaign as reviewed for Getting Started checklist (ONB-05)
    // Short-circuits on second+ visit (reads flag, skips write)
    await markCampaignReviewed()

    const [campaigns, presets, templates] = await Promise.all([
      // ... existing code unchanged
    ])
    // ... rest unchanged
  }
  ```

  Use `await` (not `void`) so the flag is guaranteed written before the page renders. The action short-circuits immediately on subsequent visits (one read, no write), so it adds minimal latency.
  </action>
  <verify>
  Run `pnpm typecheck` and `pnpm lint` — both must pass.
  Grep `lib/data/checklist.ts` for `storedChecklist?.campaign_reviewed` — must exist.
  Grep `lib/data/checklist.ts` for `campaignCount > 0` — must NOT exist (old logic removed).
  Grep `lib/actions/checklist.ts` for `markCampaignReviewed` — must exist.
  Grep `app/(dashboard)/campaigns/page.tsx` for `markCampaignReviewed` — must exist.
  </verify>
  <done>
  - `markCampaignReviewed` server action exists in `lib/actions/checklist.ts`
  - `getChecklistState` reads `campaign_reviewed` from stored JSONB flag (not `campaignCount > 0`)
  - Campaigns page calls `await markCampaignReviewed()` on load
  - DB queries reduced from 5 to 4 in `getChecklistState`
  - The checklist item only completes after the user visits /campaigns
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. Pill uses warm amber tokens (no `bg-primary/10` in incomplete state)
4. Drawer progress bar uses `bg-warning` (not `bg-primary`)
5. `campaign_reviewed` reads from stored JSONB flag
6. `markCampaignReviewed` action exists and is called from campaigns page
7. A fresh user who completes onboarding (creates campaign) does NOT have `campaign_reviewed: true` until visiting /campaigns
</verification>

<success_criteria>
- Getting Started pill shows warm amber (bg-warning-bg) instead of cold blue (bg-primary/10)
- Progress bar in drawer is amber (bg-warning)
- campaign_reviewed checklist item requires actual /campaigns page visit
- markCampaignReviewed server action short-circuits on repeat visits
- DB queries reduced from 5 to 4 in getChecklistState
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/38-onboarding-consolidation/38-03-SUMMARY.md`
</output>
