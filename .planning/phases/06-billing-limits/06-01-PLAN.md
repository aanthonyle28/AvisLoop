---
phase: 06-billing-limits
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00006_add_billing.sql
  - lib/stripe/client.ts
  - lib/types/database.ts
  - package.json
autonomous: true
user_setup:
  - service: stripe
    why: "Payment processing for subscriptions"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key"
      - name: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> Signing secret (after endpoint created)"
      - name: STRIPE_BASIC_PRICE_ID
        source: "Stripe Dashboard -> Products -> Basic Plan -> Price ID"
      - name: STRIPE_PRO_PRICE_ID
        source: "Stripe Dashboard -> Products -> Pro Plan -> Price ID"
    dashboard_config:
      - task: "Create Basic plan product ($49/mo)"
        location: "Stripe Dashboard -> Products -> Add product"
      - task: "Create Pro plan product ($99/mo)"
        location: "Stripe Dashboard -> Products -> Add product"
      - task: "Configure Customer Portal"
        location: "Stripe Dashboard -> Settings -> Billing -> Customer Portal"

must_haves:
  truths:
    - "stripe_customer_id column exists on businesses table"
    - "subscriptions table exists with RLS enabled"
    - "Stripe SDK is installed and client exports work"
    - "New businesses default to trial tier with 25-send limit"
  artifacts:
    - path: "supabase/migrations/00006_add_billing.sql"
      provides: "Billing schema (stripe_customer_id, subscriptions table)"
      contains: "CREATE TABLE"
    - path: "lib/stripe/client.ts"
      provides: "Server-side Stripe client"
      exports: ["stripe"]
    - path: "lib/types/database.ts"
      provides: "Subscription TypeScript types"
      contains: "interface Subscription"
  key_links:
    - from: "lib/stripe/client.ts"
      to: "STRIPE_SECRET_KEY"
      via: "environment variable"
      pattern: "process\\.env\\.STRIPE_SECRET_KEY"
---

<objective>
Set up Stripe billing infrastructure: database schema and SDK client.

Purpose: Foundation for all billing features - checkout, webhooks, portal, and usage tracking.
Output: Migration file ready for SQL Editor, Stripe client for server-side API calls.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-billing-limits/06-RESEARCH.md

# Existing types to extend
@lib/types/database.ts

# Phase 4 migration that added tier column
@supabase/migrations/00005_create_send_logs.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Stripe SDK and create client</name>
  <files>package.json, lib/stripe/client.ts</files>
  <action>
    1. Install Stripe packages:
       ```bash
       pnpm add stripe @stripe/stripe-js
       ```

    2. Create lib/stripe/client.ts:
       - Import Stripe from 'stripe'
       - Validate STRIPE_SECRET_KEY exists at module load (throw if missing in production)
       - Export singleton `stripe` instance with:
         - apiVersion: '2024-11-20.acacia' (or latest stable)
         - TypeScript enabled
       - Pattern from RESEARCH.md:
         ```typescript
         import Stripe from 'stripe'

         if (!process.env.STRIPE_SECRET_KEY) {
           throw new Error('STRIPE_SECRET_KEY is not set')
         }

         export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
           apiVersion: '2024-11-20.acacia',
           typescript: true,
         })
         ```

    NOTE: Do NOT expose Stripe client to client-side code. This is server-only.
  </action>
  <verify>
    - `pnpm typecheck` passes
    - lib/stripe/client.ts exports stripe instance
  </verify>
  <done>Stripe SDK installed, server-side client configured with env validation</done>
</task>

<task type="auto">
  <name>Task 2: Create billing database migration</name>
  <files>supabase/migrations/00006_add_billing.sql</files>
  <action>
    Create migration file with:

    NOTE: Phase 4 migration (00005_create_send_logs.sql) already added tier column to businesses
    table with DEFAULT 'basic'. Per BILL-01, new businesses should start on trial tier (25 free
    sends). This migration will:
    1. Fix the default to 'trial' for new businesses
    2. Add stripe_customer_id column
    3. Create subscriptions table

    ```sql
    -- Run in Supabase SQL Editor
    -- Migration: 00006_add_billing.sql
    -- Purpose: Add Stripe billing infrastructure

    -- ============================================================================
    -- Fix tier column default (Phase 4 set DEFAULT 'basic', should be 'trial')
    -- ============================================================================
    -- BILL-01: New businesses should start with 25 free trial sends
    ALTER TABLE public.businesses
      ALTER COLUMN tier SET DEFAULT 'trial';

    -- Fix any businesses that were created with incorrect 'basic' default
    -- (only if they have no subscription activity - indicated by no send logs)
    UPDATE public.businesses
    SET tier = 'trial'
    WHERE tier = 'basic'
      AND id NOT IN (SELECT DISTINCT business_id FROM public.send_logs);

    -- ============================================================================
    -- Add Stripe customer ID to businesses
    -- ============================================================================
    ALTER TABLE public.businesses
      ADD COLUMN IF NOT EXISTS stripe_customer_id TEXT UNIQUE;

    -- ============================================================================
    -- Create subscriptions table
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS public.subscriptions (
      id TEXT PRIMARY KEY,                    -- Stripe subscription ID (sub_xxx)
      business_id UUID NOT NULL REFERENCES public.businesses(id) ON DELETE CASCADE,
      status TEXT NOT NULL,                   -- active, past_due, canceled, etc.
      price_id TEXT NOT NULL,                 -- Stripe price ID
      current_period_start TIMESTAMPTZ,
      current_period_end TIMESTAMPTZ,
      cancel_at_period_end BOOLEAN DEFAULT false,
      canceled_at TIMESTAMPTZ,
      created_at TIMESTAMPTZ DEFAULT NOW(),
      updated_at TIMESTAMPTZ DEFAULT NOW()
    );

    -- ============================================================================
    -- Enable RLS and create policy
    -- ============================================================================
    ALTER TABLE public.subscriptions ENABLE ROW LEVEL SECURITY;

    CREATE POLICY "Users view own subscriptions"
    ON public.subscriptions FOR SELECT
    TO authenticated
    USING (business_id IN (
      SELECT id FROM public.businesses WHERE user_id = (SELECT auth.uid())
    ));

    -- ============================================================================
    -- Create index for business lookup
    -- ============================================================================
    CREATE INDEX IF NOT EXISTS idx_subscriptions_business_id ON public.subscriptions(business_id);

    -- ============================================================================
    -- Add updated_at trigger (use existing moddatetime pattern)
    -- ============================================================================
    CREATE TRIGGER subscriptions_updated_at
      BEFORE UPDATE ON public.subscriptions
      FOR EACH ROW EXECUTE FUNCTION extensions.moddatetime(updated_at);
    ```

    VERIFICATION NOTE: After applying migration, verify:
    - `SELECT column_default FROM information_schema.columns WHERE table_name = 'businesses' AND column_name = 'tier'` returns 'trial'
    - New businesses created get tier='trial' automatically
  </action>
  <verify>SQL file exists with valid syntax (no runtime check - manual apply)</verify>
  <done>Migration file ready for Supabase SQL Editor with trial tier default fix</done>
</task>

<task type="auto">
  <name>Task 3: Add Subscription types to database.ts</name>
  <files>lib/types/database.ts</files>
  <action>
    Add to lib/types/database.ts:

    1. Subscription interface:
       ```typescript
       export interface Subscription {
         id: string                    // Stripe subscription ID
         business_id: string
         status: 'active' | 'past_due' | 'canceled' | 'incomplete' | 'incomplete_expired' | 'trialing' | 'unpaid'
         price_id: string
         current_period_start: string | null
         current_period_end: string | null
         cancel_at_period_end: boolean
         canceled_at: string | null
         created_at: string
         updated_at: string
       }
       ```

    2. Add stripe_customer_id to Business interface:
       - Add: `stripe_customer_id: string | null`

    3. Insert/Update types:
       ```typescript
       export type SubscriptionInsert = Omit<Subscription, 'created_at' | 'updated_at'>
       export type SubscriptionUpdate = Partial<Omit<Subscription, 'id' | 'business_id' | 'created_at' | 'updated_at'>>
       ```
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>TypeScript types for subscription data available</done>
</task>

</tasks>

<verification>
- [ ] `pnpm typecheck` passes
- [ ] lib/stripe/client.ts exists and exports `stripe`
- [ ] supabase/migrations/00006_add_billing.sql exists
- [ ] Migration fixes tier default to 'trial' (BILL-01)
- [ ] Subscription interface added to lib/types/database.ts
- [ ] Business interface has stripe_customer_id field
</verification>

<success_criteria>
- Stripe SDK installed (stripe, @stripe/stripe-js in package.json)
- Server-side Stripe client configured with environment validation
- Database migration ready for manual apply
- Migration ensures new businesses default to trial tier (25 sends)
- TypeScript types for subscription management
</success_criteria>

<output>
After completion, create `.planning/phases/06-billing-limits/06-01-SUMMARY.md`
</output>
