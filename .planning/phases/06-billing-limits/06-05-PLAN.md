---
phase: 06-billing-limits
plan: 05
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - components/billing/usage-warning-banner.tsx
  - app/(dashboard)/send/page.tsx
  - components/send/send-form.tsx
  - lib/actions/send.ts
autonomous: true

must_haves:
  truths:
    - "Warning banner shows at 80%+ usage with sends remaining count"
    - "Send button disabled when send limit reached"
    - "Send button disabled when contact limit exceeded (Basic tier, BILL-07)"
    - "Limit reached shows inline upgrade prompt where Send button was"
    - "Usage meter on send page is clickable and links to billing"
  artifacts:
    - path: "components/billing/usage-warning-banner.tsx"
      provides: "Persistent usage warning banner"
      exports: ["UsageWarningBanner"]
    - path: "components/send/send-form.tsx"
      provides: "Updated send form with limit enforcement"
      contains: "disabled.*limitReached"
  key_links:
    - from: "components/billing/usage-warning-banner.tsx"
      to: "/billing"
      via: "Link component"
      pattern: "href.*billing"
    - from: "components/send/send-form.tsx"
      to: "lib/data/send-logs.ts"
      via: "monthlyUsage prop"
      pattern: "monthlyUsage"
---

<objective>
Add usage warnings and limit enforcement to the send flow.

Purpose: Alert users when approaching limits and provide clear upgrade path when limits are reached.
Output: Warning banner component and updated send page with limit enforcement.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-billing-limits/06-CONTEXT.md

# Existing send components
@app/(dashboard)/send/page.tsx
@components/send/send-form.tsx
@lib/actions/send.ts

# From Plan 04
@components/billing/usage-display.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usage warning banner component</name>
  <files>components/billing/usage-warning-banner.tsx</files>
  <action>
    Create components/billing/usage-warning-banner.tsx:

    ```typescript
    import Link from 'next/link'
    import { AlertTriangle } from 'lucide-react'

    interface UsageWarningBannerProps {
      count: number
      limit: number
      tier: string
      contactCount?: number    // BILL-07: contact count for Basic tier
      contactLimit?: number    // BILL-07: 200 for Basic tier
    }

    export function UsageWarningBanner({
      count,
      limit,
      tier,
      contactCount,
      contactLimit
    }: UsageWarningBannerProps) {
      const sendPercentage = (count / limit) * 100
      const sendRemaining = limit - count

      // BILL-07: Check contact limit for Basic tier
      const contactsOverLimit = tier === 'basic'
        && contactCount !== undefined
        && contactLimit !== undefined
        && contactCount > contactLimit

      // Show contact over-limit warning (BILL-07)
      if (contactsOverLimit) {
        return (
          <div className="bg-destructive/10 border border-destructive/20 rounded-lg p-4 mb-6">
            <div className="flex items-start gap-3">
              <AlertTriangle className="h-5 w-5 text-destructive shrink-0 mt-0.5" />
              <div className="space-y-1">
                <p className="font-medium text-destructive">
                  Contact limit exceeded
                </p>
                <p className="text-sm text-destructive/80">
                  You have {contactCount} contacts but your Basic plan allows {contactLimit}.{' '}
                  <Link href="/billing" className="underline font-medium">
                    Upgrade to Pro
                  </Link>{' '}
                  for unlimited contacts, or remove some contacts to send.
                </p>
              </div>
            </div>
          </div>
        )
      }

      // Don't show send warning below 80%
      if (sendPercentage < 80) return null

      // Send limit reached
      if (sendPercentage >= 100) {
        return (
          <div className="bg-destructive/10 border border-destructive/20 rounded-lg p-4 mb-6">
            <div className="flex items-start gap-3">
              <AlertTriangle className="h-5 w-5 text-destructive shrink-0 mt-0.5" />
              <div className="space-y-1">
                <p className="font-medium text-destructive">
                  {tier === 'trial' ? 'Trial' : 'Monthly'} limit reached
                </p>
                <p className="text-sm text-destructive/80">
                  You've used all {limit} sends this month.{' '}
                  <Link href="/billing" className="underline font-medium">
                    {tier === 'trial' ? 'Start a plan' : 'Upgrade your plan'}
                  </Link>{' '}
                  to keep sending review requests.
                </p>
              </div>
            </div>
          </div>
        )
      }

      // Warning at 80%+
      return (
        <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
          <div className="flex items-start gap-3">
            <AlertTriangle className="h-5 w-5 text-amber-600 shrink-0 mt-0.5" />
            <div className="space-y-1">
              <p className="font-medium text-amber-800">
                {sendRemaining} sends remaining this month
              </p>
              <p className="text-sm text-amber-700">
                You've used {count} of {limit} sends.{' '}
                <Link href="/billing" className="underline">
                  View billing
                </Link>
              </p>
            </div>
          </div>
        </div>
      )
    }
    ```

    Per CONTEXT.md:
    - Show persistent banner warning when 80%+ of send limit used
    - "20 sends remaining this month" style message
    - Soft block at limit: disable Send button, show inline message
    - Primary CTA: "Start plan" / Secondary: "View pricing"
    - BILL-07: Contact limit exceeded blocks sending for Basic tier
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>Usage warning banner component with 80% threshold and contact limit warning</done>
</task>

<task type="auto">
  <name>Task 2: Update send page with warning banner, contact count, and clickable usage</name>
  <files>app/(dashboard)/send/page.tsx</files>
  <action>
    Update app/(dashboard)/send/page.tsx:

    1. Import UsageWarningBanner and add contact count fetching:
       ```typescript
       import { UsageWarningBanner } from '@/components/billing/usage-warning-banner'
       import Link from 'next/link'
       ```

    2. Add contact count fetching for BILL-07:
       ```typescript
       // Get contact count for Basic tier limit check (BILL-07)
       const { count: contactCount } = await supabase
         .from('contacts')
         .select('*', { count: 'exact', head: true })
         .eq('business_id', business.id)
         .eq('status', 'active')

       // Contact limits by tier
       const CONTACT_LIMITS: Record<string, number | undefined> = {
         trial: undefined,    // Unlimited
         basic: 200,
         pro: undefined,      // Unlimited
       }
       const contactLimit = CONTACT_LIMITS[usage.tier]
       ```

    3. Add warning banner after the header and before the form:
       ```tsx
       <UsageWarningBanner
         count={usage.count}
         limit={usage.limit}
         tier={usage.tier}
         contactCount={contactCount ?? undefined}
         contactLimit={contactLimit}
       />
       ```

    4. Pass contact limit info to SendForm:
       ```tsx
       <SendForm
         // ... existing props
         monthlyUsage={usage}
         contactCount={contactCount ?? 0}
         contactLimit={contactLimit}
       />
       ```

    5. Make the usage display clickable (link to billing):
       Change the usage display div from:
       ```tsx
       <div className="text-sm text-muted-foreground">
         {usage.count} / {usage.limit} sends this month
       </div>
       ```
       To:
       ```tsx
       <Link
         href="/billing"
         className="text-sm text-muted-foreground hover:text-foreground transition-colors"
       >
         {usage.count} / {usage.limit} sends this month
       </Link>
       ```

    Per CONTEXT.md:
    - Usage meter is clickable - links to billing page
    - Show warning banner at 80%+ usage
    - BILL-07: Pass contact info for limit enforcement
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>Send page shows usage warnings, contact info, and clickable usage meter</done>
</task>

<task type="auto">
  <name>Task 3: Update SendForm with limit enforcement including contact limits</name>
  <files>components/send/send-form.tsx</files>
  <action>
    Read current SendForm component first, then update:

    1. Add contactCount and contactLimit props:
       ```typescript
       interface SendFormProps {
         // ... existing props
         monthlyUsage: { count: number; limit: number; tier: string }
         contactCount: number
         contactLimit?: number  // undefined = unlimited
       }
       ```

    2. Add limitReached check based on monthlyUsage and contact limits (BILL-07):
       ```typescript
       const sendLimitReached = monthlyUsage.count >= monthlyUsage.limit

       // BILL-07: Contact limit enforcement for Basic tier
       // Can add contacts over limit, but can't SEND if over contact limit
       const contactsOverLimit = contactLimit !== undefined && contactCount > contactLimit

       const limitReached = sendLimitReached || contactsOverLimit
       ```

    3. Disable the submit button when any limit reached:
       - Change button disabled condition to include limitReached
       - Example: `disabled={isPending || !selectedContactId || limitReached}`

    4. Show appropriate upgrade prompt when limit reached:
       ```tsx
       {limitReached ? (
         <div className="rounded-lg border border-destructive/20 bg-destructive/5 p-4 text-center">
           <p className="text-sm text-destructive mb-2">
             {contactsOverLimit
               ? `Contact limit exceeded (${contactCount}/${contactLimit}). Remove contacts or upgrade.`
               : `${monthlyUsage.tier === 'trial' ? 'Trial' : 'Plan'} limit reached.`
             }
           </p>
           <div className="flex gap-2 justify-center">
             <Button asChild variant="default" size="sm">
               <Link href="/billing">
                 {monthlyUsage.tier === 'trial' ? 'Start a plan' : 'Upgrade'}
               </Link>
             </Button>
             <Button asChild variant="outline" size="sm">
               <Link href="/billing#plans">View pricing</Link>
             </Button>
           </div>
         </div>
       ) : (
         <Button type="submit" disabled={isPending || !selectedContactId}>
           {isPending ? 'Sending...' : 'Send Review Request'}
         </Button>
       )}
       ```

    Per CONTEXT.md:
    - Inline blocking at trial exhaustion (not modal)
    - Message appears where Send button is
    - Primary CTA: "Start plan" / Secondary: "View pricing"
    - BILL-07: Contact limits - "Can add contacts over limit, but can't send until resolved"
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>Send form disables and shows upgrade prompt when send or contact limit reached</done>
</task>

</tasks>

<verification>
- [ ] `pnpm typecheck` passes
- [ ] Warning banner shows at 80%+ send usage
- [ ] Warning banner shows different message at 100% send usage
- [ ] Warning banner shows contact limit exceeded for Basic tier (BILL-07)
- [ ] Send button disabled when send limit reached
- [ ] Send button disabled when contact limit exceeded (Basic tier)
- [ ] Upgrade prompt shows where Send button was
- [ ] Usage display on send page links to billing
- [ ] "Start a plan" for trial, "Upgrade" for paid users
</verification>

<success_criteria>
- Users see clear warning when approaching limits (80% threshold)
- Users cannot send when send limit reached (soft block, not hard error)
- Users cannot send when contact count exceeds tier limit (BILL-07)
- Clear upgrade path shown inline where Send button was
- Usage meter clickable and leads to billing page
- Different messaging for trial vs paid users
</success_criteria>

<output>
After completion, create `.planning/phases/06-billing-limits/06-05-SUMMARY.md`
</output>
