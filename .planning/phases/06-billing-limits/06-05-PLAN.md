---
phase: 06-billing-limits
plan: 05
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - components/billing/usage-warning-banner.tsx
  - app/(dashboard)/send/page.tsx
  - components/send/send-form.tsx
autonomous: true

must_haves:
  truths:
    - "Warning banner shows at 80%+ usage with sends remaining count"
    - "Send button disabled when limit reached"
    - "Limit reached shows inline upgrade prompt where Send button was"
    - "Usage meter on send page is clickable and links to billing"
  artifacts:
    - path: "components/billing/usage-warning-banner.tsx"
      provides: "Persistent usage warning banner"
      exports: ["UsageWarningBanner"]
    - path: "components/send/send-form.tsx"
      provides: "Updated send form with limit enforcement"
      contains: "disabled.*limitReached"
  key_links:
    - from: "components/billing/usage-warning-banner.tsx"
      to: "/billing"
      via: "Link component"
      pattern: "href.*billing"
    - from: "components/send/send-form.tsx"
      to: "lib/data/send-logs.ts"
      via: "monthlyUsage prop"
      pattern: "monthlyUsage"
---

<objective>
Add usage warnings and limit enforcement to the send flow.

Purpose: Alert users when approaching limits and provide clear upgrade path when limits are reached.
Output: Warning banner component and updated send page with limit enforcement.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-billing-limits/06-CONTEXT.md

# Existing send components
@app/(dashboard)/send/page.tsx
@components/send/send-form.tsx

# From Plan 04
@components/billing/usage-display.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usage warning banner component</name>
  <files>components/billing/usage-warning-banner.tsx</files>
  <action>
    Create components/billing/usage-warning-banner.tsx:

    ```typescript
    import Link from 'next/link'
    import { AlertTriangle } from 'lucide-react'

    interface UsageWarningBannerProps {
      count: number
      limit: number
      tier: string
    }

    export function UsageWarningBanner({ count, limit, tier }: UsageWarningBannerProps) {
      const percentage = (count / limit) * 100
      const remaining = limit - count

      // Don't show below 80%
      if (percentage < 80) return null

      // Limit reached
      if (percentage >= 100) {
        return (
          <div className="bg-destructive/10 border border-destructive/20 rounded-lg p-4 mb-6">
            <div className="flex items-start gap-3">
              <AlertTriangle className="h-5 w-5 text-destructive shrink-0 mt-0.5" />
              <div className="space-y-1">
                <p className="font-medium text-destructive">
                  {tier === 'trial' ? 'Trial' : 'Monthly'} limit reached
                </p>
                <p className="text-sm text-destructive/80">
                  You've used all {limit} sends this month.{' '}
                  <Link href="/billing" className="underline font-medium">
                    {tier === 'trial' ? 'Start a plan' : 'Upgrade your plan'}
                  </Link>{' '}
                  to keep sending review requests.
                </p>
              </div>
            </div>
          </div>
        )
      }

      // Warning at 80%+
      return (
        <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
          <div className="flex items-start gap-3">
            <AlertTriangle className="h-5 w-5 text-amber-600 shrink-0 mt-0.5" />
            <div className="space-y-1">
              <p className="font-medium text-amber-800">
                {remaining} sends remaining this month
              </p>
              <p className="text-sm text-amber-700">
                You've used {count} of {limit} sends.{' '}
                <Link href="/billing" className="underline">
                  View billing
                </Link>
              </p>
            </div>
          </div>
        </div>
      )
    }
    ```

    Per CONTEXT.md:
    - Show persistent banner warning when 80%+ of send limit used
    - "20 sends remaining this month" style message
    - Soft block at limit: disable Send button, show inline message
    - Primary CTA: "Start plan" / Secondary: "View pricing"
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>Usage warning banner component with 80% threshold</done>
</task>

<task type="auto">
  <name>Task 2: Update send page with warning banner and clickable usage</name>
  <files>app/(dashboard)/send/page.tsx</files>
  <action>
    Update app/(dashboard)/send/page.tsx:

    1. Import UsageWarningBanner:
       ```typescript
       import { UsageWarningBanner } from '@/components/billing/usage-warning-banner'
       import Link from 'next/link'
       ```

    2. Add warning banner after the header and before the form:
       ```tsx
       <UsageWarningBanner
         count={usage.count}
         limit={usage.limit}
         tier={usage.tier}
       />
       ```

    3. Make the usage display clickable (link to billing):
       Change the usage display div from:
       ```tsx
       <div className="text-sm text-muted-foreground">
         {usage.count} / {usage.limit} sends this month
       </div>
       ```
       To:
       ```tsx
       <Link
         href="/billing"
         className="text-sm text-muted-foreground hover:text-foreground transition-colors"
       >
         {usage.count} / {usage.limit} sends this month
       </Link>
       ```

    Per CONTEXT.md:
    - Usage meter is clickable - links to billing page
    - Show warning banner at 80%+ usage
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>Send page shows usage warnings and clickable usage meter</done>
</task>

<task type="auto">
  <name>Task 3: Update SendForm with limit enforcement</name>
  <files>components/send/send-form.tsx</files>
  <action>
    Read current SendForm component first, then update:

    1. Add limitReached check based on monthlyUsage prop:
       ```typescript
       const limitReached = monthlyUsage.count >= monthlyUsage.limit
       ```

    2. Disable the submit button when limit reached:
       - Change button disabled condition to include limitReached
       - Example: `disabled={isPending || !selectedContactId || limitReached}`

    3. Show upgrade prompt when limit reached (replace or overlay the send button):
       ```tsx
       {limitReached ? (
         <div className="rounded-lg border border-destructive/20 bg-destructive/5 p-4 text-center">
           <p className="text-sm text-destructive mb-2">
             {monthlyUsage.tier === 'trial' ? 'Trial' : 'Plan'} limit reached.
           </p>
           <div className="flex gap-2 justify-center">
             <Button asChild variant="default" size="sm">
               <Link href="/billing">
                 {monthlyUsage.tier === 'trial' ? 'Start a plan' : 'Upgrade'}
               </Link>
             </Button>
             <Button asChild variant="outline" size="sm">
               <Link href="/billing#plans">View pricing</Link>
             </Button>
           </div>
         </div>
       ) : (
         <Button type="submit" disabled={isPending || !selectedContactId}>
           {isPending ? 'Sending...' : 'Send Review Request'}
         </Button>
       )}
       ```

    Per CONTEXT.md:
    - Inline blocking at trial exhaustion (not modal)
    - Message appears where Send button is
    - Primary CTA: "Start plan" / Secondary: "View pricing"
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>Send form disables and shows upgrade prompt when limit reached</done>
</task>

</tasks>

<verification>
- [ ] `pnpm typecheck` passes
- [ ] Warning banner shows at 80%+ usage
- [ ] Warning banner shows different message at 100%
- [ ] Send button disabled when limit reached
- [ ] Upgrade prompt shows where Send button was
- [ ] Usage display on send page links to billing
- [ ] "Start a plan" for trial, "Upgrade" for paid users
</verification>

<success_criteria>
- Users see clear warning when approaching limits (80% threshold)
- Users cannot send when limit reached (soft block, not hard error)
- Clear upgrade path shown inline where Send button was
- Usage meter clickable and leads to billing page
- Different messaging for trial vs paid users
</success_criteria>

<output>
After completion, create `.planning/phases/06-billing-limits/06-05-SUMMARY.md`
</output>
