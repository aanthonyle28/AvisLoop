---
phase: 06-billing-limits
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - app/(dashboard)/billing/page.tsx
  - components/billing/plan-card.tsx
  - components/billing/usage-display.tsx
  - components/billing/subscription-status.tsx
autonomous: true

must_haves:
  truths:
    - "User can view current plan and usage on billing page"
    - "Trial user sees plan options with subscribe buttons"
    - "Subscribed user sees current plan with manage button"
    - "Usage display shows sends used / limit this month"
  artifacts:
    - path: "app/(dashboard)/billing/page.tsx"
      provides: "Billing page"
      min_lines: 50
    - path: "components/billing/plan-card.tsx"
      provides: "Plan selection card component"
      exports: ["PlanCard"]
    - path: "components/billing/usage-display.tsx"
      provides: "Usage meter component"
      exports: ["UsageDisplay"]
  key_links:
    - from: "app/(dashboard)/billing/page.tsx"
      to: "lib/data/subscription.ts"
      via: "import getBusinessBillingInfo"
      pattern: "import.*getBusinessBillingInfo"
    - from: "components/billing/plan-card.tsx"
      to: "lib/actions/billing.ts"
      via: "import createCheckoutSession"
      pattern: "import.*createCheckoutSession"
---

<objective>
Create billing page with plan display, usage meter, and subscription management.

Purpose: Users can view their plan status, see usage, and subscribe or manage their subscription.
Output: Billing page with plan cards, usage display, and Stripe integration buttons.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-billing-limits/06-CONTEXT.md

# From Plan 02
@lib/actions/billing.ts
@lib/data/subscription.ts

# UI patterns
@components/ui/card.tsx
@components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plan card and usage display components</name>
  <files>components/billing/plan-card.tsx, components/billing/usage-display.tsx</files>
  <action>
    1. Create components/billing/plan-card.tsx:
       ```typescript
       'use client'

       import { Button } from '@/components/ui/button'
       import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card'
       import { createCheckoutSession } from '@/lib/actions/billing'
       import { useTransition } from 'react'

       interface PlanCardProps {
         name: string
         price: string
         priceId: string
         features: string[]
         current?: boolean
         recommended?: boolean
       }

       export function PlanCard({ name, price, priceId, features, current, recommended }: PlanCardProps) {
         const [isPending, startTransition] = useTransition()

         const handleSubscribe = () => {
           startTransition(() => {
             createCheckoutSession(priceId)
           })
         }

         return (
           <Card className={`relative ${recommended ? 'border-primary' : ''}`}>
             {recommended && (
               <div className="absolute -top-3 left-1/2 -translate-x-1/2 bg-primary text-primary-foreground px-3 py-1 rounded-full text-xs font-medium">
                 Recommended
               </div>
             )}
             <CardHeader>
               <CardTitle>{name}</CardTitle>
               <CardDescription>
                 <span className="text-2xl font-bold">{price}</span>
                 <span className="text-muted-foreground">/month</span>
               </CardDescription>
             </CardHeader>
             <CardContent>
               <ul className="space-y-2 text-sm">
                 {features.map((feature, i) => (
                   <li key={i} className="flex items-center gap-2">
                     <svg className="h-4 w-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                       <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                     </svg>
                     {feature}
                   </li>
                 ))}
               </ul>
             </CardContent>
             <CardFooter>
               {current ? (
                 <Button variant="outline" className="w-full" disabled>
                   Current Plan
                 </Button>
               ) : (
                 <Button
                   className="w-full"
                   onClick={handleSubscribe}
                   disabled={isPending}
                 >
                   {isPending ? 'Loading...' : 'Subscribe'}
                 </Button>
               )}
             </CardFooter>
           </Card>
         )
       }
       ```

    2. Create components/billing/usage-display.tsx:
       ```typescript
       import Link from 'next/link'

       interface UsageDisplayProps {
         count: number
         limit: number
         tier: string
       }

       export function UsageDisplay({ count, limit, tier }: UsageDisplayProps) {
         const percentage = (count / limit) * 100
         const remaining = limit - count

         // Color based on usage level
         let barColor = 'bg-primary'
         if (percentage >= 100) barColor = 'bg-destructive'
         else if (percentage >= 80) barColor = 'bg-amber-500'

         return (
           <div className="space-y-3">
             <div className="flex justify-between text-sm">
               <span className="text-muted-foreground">Sends this month</span>
               <span className="font-medium">{count} / {limit}</span>
             </div>
             <div className="h-2 bg-muted rounded-full overflow-hidden">
               <div
                 className={`h-full ${barColor} transition-all`}
                 style={{ width: `${Math.min(percentage, 100)}%` }}
               />
             </div>
             {percentage >= 80 && percentage < 100 && (
               <p className="text-sm text-amber-600">
                 {remaining} sends remaining this month
               </p>
             )}
             {percentage >= 100 && (
               <p className="text-sm text-destructive">
                 {tier === 'trial' ? 'Trial' : 'Plan'} limit reached.{' '}
                 <Link href="#plans" className="underline">Upgrade</Link> to keep sending.
               </p>
             )}
           </div>
         )
       }
       ```

    Per CONTEXT.md:
    - Show warning at 80%+ usage
    - "X sends remaining this month" message
    - Limit reached shows upgrade prompt
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>Reusable billing components created</done>
</task>

<task type="auto">
  <name>Task 2: Create subscription status component</name>
  <files>components/billing/subscription-status.tsx</files>
  <action>
    Create components/billing/subscription-status.tsx:

    ```typescript
    'use client'

    import { Button } from '@/components/ui/button'
    import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
    import { createPortalSession } from '@/lib/actions/billing'
    import { useTransition } from 'react'
    import { format } from 'date-fns'
    import type { Subscription } from '@/lib/types/database'

    interface SubscriptionStatusProps {
      subscription: Subscription | null
      tier: string
    }

    export function SubscriptionStatus({ subscription, tier }: SubscriptionStatusProps) {
      const [isPending, startTransition] = useTransition()

      const handleManage = () => {
        startTransition(() => {
          createPortalSession()
        })
      }

      // Trial user (no subscription)
      if (!subscription || tier === 'trial') {
        return (
          <Card>
            <CardHeader>
              <CardTitle>Free Trial</CardTitle>
              <CardDescription>You're on the free trial with 25 sends</CardDescription>
            </CardHeader>
            <CardContent>
              <p className="text-sm text-muted-foreground">
                Subscribe to a plan for more sends and features.
              </p>
            </CardContent>
          </Card>
        )
      }

      // Active subscription
      const planName = tier === 'pro' ? 'Pro' : 'Basic'
      const renewalDate = subscription.current_period_end
        ? format(new Date(subscription.current_period_end), 'MMMM d, yyyy')
        : null

      return (
        <Card>
          <CardHeader>
            <CardTitle>{planName} Plan</CardTitle>
            <CardDescription>
              {subscription.cancel_at_period_end
                ? `Cancels on ${renewalDate}`
                : `Renews on ${renewalDate}`}
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            {subscription.status === 'past_due' && (
              <div className="text-sm text-amber-600 bg-amber-50 p-3 rounded-lg">
                Payment failed. Please update your payment method to avoid service interruption.
              </div>
            )}
            <Button
              variant="outline"
              onClick={handleManage}
              disabled={isPending}
            >
              {isPending ? 'Loading...' : 'Manage Subscription'}
            </Button>
          </CardContent>
        </Card>
      )
    }
    ```

    Per CONTEXT.md:
    - Trial users see "Free Trial: X/25 sends used"
    - Subscribed users see plan name, price, renewal date
    - "Manage Subscription" opens Stripe Customer Portal
    - past_due shows warning about payment
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>Subscription status component with portal button</done>
</task>

<task type="auto">
  <name>Task 3: Create billing page</name>
  <files>app/(dashboard)/billing/page.tsx</files>
  <action>
    Create app/(dashboard)/billing/page.tsx:

    ```typescript
    import { getBusinessBillingInfo } from '@/lib/data/subscription'
    import { redirect } from 'next/navigation'
    import { PlanCard } from '@/components/billing/plan-card'
    import { UsageDisplay } from '@/components/billing/usage-display'
    import { SubscriptionStatus } from '@/components/billing/subscription-status'
    import { CheckCircle2 } from 'lucide-react'

    // Plan configuration
    const PLANS = [
      {
        name: 'Basic',
        price: '$49',
        priceId: process.env.STRIPE_BASIC_PRICE_ID!,
        tier: 'basic',
        features: [
          '200 review requests/month',
          '200 contacts',
          'Email support',
        ],
      },
      {
        name: 'Pro',
        price: '$99',
        priceId: process.env.STRIPE_PRO_PRICE_ID!,
        tier: 'pro',
        recommended: true,
        features: [
          '500 review requests/month',
          'Unlimited contacts',
          'Priority support',
        ],
      },
    ]

    export default async function BillingPage({
      searchParams,
    }: {
      searchParams: Promise<{ success?: string; canceled?: string }>
    }) {
      const { business, subscription, usage } = await getBusinessBillingInfo()
      const params = await searchParams

      if (!business) {
        redirect('/dashboard/settings')
      }

      const showSuccess = params.success === '1'
      const showCanceled = params.canceled === '1'

      return (
        <div className="container mx-auto py-6 px-4 max-w-4xl">
          <h1 className="text-2xl font-bold mb-6">Billing</h1>

          {/* Success message after checkout */}
          {showSuccess && (
            <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center gap-3">
              <CheckCircle2 className="h-5 w-5 text-green-600" />
              <div>
                <p className="font-medium text-green-800">Subscription activated!</p>
                <p className="text-sm text-green-700">
                  You're now on the {business.tier === 'pro' ? 'Pro' : 'Basic'} plan.
                </p>
              </div>
            </div>
          )}

          {/* Canceled message */}
          {showCanceled && (
            <div className="mb-6 p-4 bg-muted rounded-lg">
              <p className="text-muted-foreground">Checkout was canceled. You can try again below.</p>
            </div>
          )}

          {/* Current subscription status */}
          <div className="mb-8">
            <SubscriptionStatus subscription={subscription} tier={business.tier} />
          </div>

          {/* Usage */}
          <div className="mb-8">
            <h2 className="text-lg font-semibold mb-4">Usage</h2>
            <div className="p-4 border rounded-lg">
              <UsageDisplay count={usage.count} limit={usage.limit} tier={business.tier} />
            </div>
          </div>

          {/* Plan options (show for trial users or if they want to upgrade) */}
          <div id="plans">
            <h2 className="text-lg font-semibold mb-4">
              {business.tier === 'trial' ? 'Choose a Plan' : 'Available Plans'}
            </h2>
            <div className="grid md:grid-cols-2 gap-4">
              {PLANS.map((plan) => (
                <PlanCard
                  key={plan.name}
                  name={plan.name}
                  price={plan.price}
                  priceId={plan.priceId}
                  features={plan.features}
                  current={business.tier === plan.tier}
                  recommended={plan.recommended}
                />
              ))}
            </div>
          </div>
        </div>
      )
    }
    ```

    Per CONTEXT.md:
    - success_url returns to /billing?success=1 with confirmation
    - Shows "You're on Pro" with updated limits after successful checkout
    - Simple card layout: plan name, price, renewal date, usage summary
    - "View invoices" and "Manage subscription" via Stripe Portal
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>Billing page with full plan management</done>
</task>

</tasks>

<verification>
- [ ] `pnpm typecheck` passes
- [ ] Billing page loads at /billing
- [ ] Trial users see plan options with subscribe buttons
- [ ] Subscribed users see current plan with manage button
- [ ] Usage display shows correct sends used / limit
- [ ] Success message shows after checkout redirect
- [ ] PlanCard triggers Stripe Checkout on click
- [ ] SubscriptionStatus triggers Stripe Portal on manage click
</verification>

<success_criteria>
- User can view current plan status on billing page
- User can see monthly send usage with visual meter
- Trial users see subscribe buttons for Basic and Pro
- Subscribed users can access Stripe Customer Portal
- Success page shows after completing Stripe checkout
</success_criteria>

<output>
After completion, create `.planning/phases/06-billing-limits/06-04-SUMMARY.md`
</output>
