---
phase: 52-multi-business-foundation
plan: 02
type: execute
wave: 2
depends_on: ["52-01"]
files_modified:
  - components/providers/business-settings-provider.tsx
  - app/(dashboard)/layout.tsx
  - app/(dashboard)/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "A user with one business lands on the dashboard normally — no visible change from today"
    - "A user with zero businesses is redirected to /onboarding"
    - "A user with multiple businesses and no cookie auto-selects the first business and lands on the dashboard (no crash)"
    - "BusinessSettingsProvider exposes businessId, businessName, and businesses[] to client components"
    - "Existing consumers of useBusinessSettings() (add-job-sheet, edit-job-sheet, campaign-form, job-filters) continue working without changes"
  artifacts:
    - path: "components/providers/business-settings-provider.tsx"
      provides: "Extended provider with business identity"
      exports: ["BusinessSettingsProvider", "useBusinessSettings"]
    - path: "app/(dashboard)/layout.tsx"
      provides: "Layout using getActiveBusiness() and passing business identity to provider"
    - path: "app/(dashboard)/dashboard/page.tsx"
      provides: "Dashboard page using getActiveBusiness() for redirect logic"
  key_links:
    - from: "app/(dashboard)/layout.tsx"
      to: "lib/data/active-business.ts"
      via: "imports getActiveBusiness and getUserBusinesses"
      pattern: "import.*getActiveBusiness.*active-business"
    - from: "app/(dashboard)/layout.tsx"
      to: "components/providers/business-settings-provider.tsx"
      via: "passes businessId, businessName, businesses props"
      pattern: "businessId=.*businessName=.*businesses="
    - from: "app/(dashboard)/dashboard/page.tsx"
      to: "lib/data/active-business.ts"
      via: "imports getActiveBusiness for redirect logic"
      pattern: "import.*getActiveBusiness.*active-business"
    - from: "components/providers/business-settings-provider.tsx"
      to: "client components"
      via: "useBusinessSettings() hook returns businessId, businessName, businesses"
      pattern: "businessId.*businessName.*businesses"
---

<objective>
Extend BusinessSettingsProvider with business identity (businessId, businessName, businesses[]) and update the dashboard layout and page to use getActiveBusiness() instead of the old getBusiness() pattern.

Purpose: This wires the resolver from Plan 01 into the actual app. The layout resolves the active business and passes identity through the provider so client components (sidebar switcher in Phase 54, client cards in Phase 55) can access business info without prop drilling. The dashboard redirect logic is fixed to handle multi-business correctly.

Output: Modified provider, layout, and dashboard page. Existing behavior preserved for single-business users.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-multi-business-foundation/52-RESEARCH.md
@.planning/phases/52-multi-business-foundation/52-01-SUMMARY.md
@components/providers/business-settings-provider.tsx
@app/(dashboard)/layout.tsx
@app/(dashboard)/dashboard/page.tsx
@lib/data/active-business.ts
@lib/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend BusinessSettingsProvider with business identity</name>
  <files>components/providers/business-settings-provider.tsx</files>
  <action>
Modify the existing `BusinessSettingsProvider` to add three new required props and context values:

1. Add a `BusinessIdentity` type:
   ```typescript
   interface BusinessIdentity {
     id: string
     name: string
   }
   ```

2. Update `BusinessSettingsContextValue` to add:
   - `businessId: string` — the active business ID
   - `businessName: string` — the active business name
   - `businesses: BusinessIdentity[]` — all businesses the user owns

3. Update `BusinessSettingsProviderProps` to add the same three props:
   - `businessId: string`
   - `businessName: string`
   - `businesses: BusinessIdentity[]`

4. Update the component to destructure the new props and pass them in the context value.

CRITICAL: Keep the existing `enabledServiceTypes` and `customServiceNames` props and context values exactly as they are. The 4 existing consumers (`edit-job-sheet.tsx`, `add-job-sheet.tsx`, `campaign-form.tsx`, `job-filters.tsx`) destructure these fields and must continue working without any changes.

CRITICAL: Do NOT make the new props optional. They are required. The layout (updated in Task 2) will always provide them. Making them optional with fallback defaults would mask bugs and lead to runtime errors downstream.

Export the `BusinessIdentity` type so Phase 54 can import it for the switcher dropdown.
  </action>
  <verify>
Run `pnpm typecheck` -- this will FAIL at this point because the layout hasn't been updated yet to pass the new required props. This is expected. Verify the file structure looks correct manually before proceeding to Task 2.
  </verify>
  <done>
`BusinessSettingsProvider` accepts and exposes `businessId`, `businessName`, and `businesses[]` alongside existing `enabledServiceTypes` and `customServiceNames`. `BusinessIdentity` type is exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update layout to use getActiveBusiness() and pass business identity to provider</name>
  <files>app/(dashboard)/layout.tsx</files>
  <action>
Modify `app/(dashboard)/layout.tsx` to:

1. Replace the existing imports: remove `getBusiness` or `getServiceTypeSettings`-only import if needed, ADD imports:
   ```typescript
   import { getActiveBusiness, getUserBusinesses } from '@/lib/data/active-business'
   ```
   Keep the `getServiceTypeSettings` import from `@/lib/data/business` -- it is still needed and still works for single-business users (Phase 53 will refactor it).

2. Update the function body to fetch active business and businesses list in parallel:
   ```typescript
   const [business, businesses] = await Promise.all([
     getActiveBusiness(),
     getUserBusinesses(),
   ])
   ```

3. Derive `businessId` and `businessName` from the resolved business:
   ```typescript
   const businessId = business?.id ?? ''
   const businessName = business?.name ?? ''
   ```
   Using empty strings when no business exists (zero-business users). The dashboard page handles the redirect to onboarding.

4. Keep the existing `getServiceTypeSettings()` call and dashboard badge logic exactly as-is. These still work fine for single-business users and Phase 53 will update them.

5. Update the `<BusinessSettingsProvider>` JSX to pass the three new props:
   ```tsx
   <BusinessSettingsProvider
     businessId={businessId}
     businessName={businessName}
     businesses={businesses}
     enabledServiceTypes={enabledServiceTypes}
     customServiceNames={customServiceNames}
   >
   ```

The layout does NOT redirect to onboarding -- individual pages handle that. The layout just provides context.
  </action>
  <verify>
Run `pnpm typecheck` -- should now pass since both the provider and layout are updated together.
Run `pnpm lint` -- must pass.
  </verify>
  <done>
Layout uses `getActiveBusiness()` and `getUserBusinesses()`, passes `businessId`, `businessName`, and `businesses` to provider. Existing service type settings and dashboard badge logic preserved. TypeScript and lint pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update dashboard page to use getActiveBusiness() for redirect logic</name>
  <files>app/(dashboard)/dashboard/page.tsx</files>
  <action>
Modify `app/(dashboard)/dashboard/page.tsx` to:

1. Replace the import:
   ```typescript
   // REMOVE: import { getBusiness } from '@/lib/actions/business'
   // ADD:
   import { getActiveBusiness } from '@/lib/data/active-business'
   ```

2. Replace the business resolution call:
   ```typescript
   // REMOVE: const business = await getBusiness()
   // ADD:
   const business = await getActiveBusiness()
   ```

3. Keep the redirect logic exactly as-is:
   ```typescript
   if (!business) {
     redirect('/onboarding')
   }
   ```
   This now works correctly for multi-business users because `getActiveBusiness()` returns `null` ONLY when the user has zero businesses. If they have businesses but no cookie, it auto-selects the first one.

4. Keep ALL other code in the file exactly as-is. The `business.id` usage for `getDashboardKPIs(business.id)`, `getReadyToSendJobs(business.id, ...)`, etc. all continue to work because `business` is still a `Business` type.

5. The `getServiceTypeSettings()` call remains as-is (it still uses the old `.single()` pattern internally). Phase 53 will update it. For a single-business user, it works fine. For a multi-business user during the Phase 52 window (before Phase 53 runs), it will still return settings for one of the user's businesses -- which is acceptable for this interim state.

6. The `supabase.auth.getUser()` call for the greeting also remains as-is -- it's fetching user metadata, not business data.

Do NOT update any other dashboard pages (jobs, campaigns, etc.) in this plan. Phase 53 will systematically update all pages.
  </action>
  <verify>
Run `pnpm typecheck` -- must pass with zero errors.
Run `pnpm lint` -- must pass with zero errors.
Verify that `getBusiness` from `@/lib/actions/business` is no longer imported in this file.
Verify that `getActiveBusiness` from `@/lib/data/active-business` is imported.
Verify the redirect logic is `if (!business) { redirect('/onboarding') }`.
  </verify>
  <done>
Dashboard page uses `getActiveBusiness()` for business resolution. Redirect to `/onboarding` only happens for zero-business users. Multi-business users with no cookie get auto-selected to their first business. All existing data fetching continues to work with `business.id`. Lint and typecheck pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with zero errors
2. `pnpm lint` passes with zero errors
3. `pnpm dev` starts without errors -- verify manually that the dashboard loads for existing users
4. Provider exposes `businessId`, `businessName`, `businesses` via `useBusinessSettings()` hook
5. Existing consumers (`edit-job-sheet`, `add-job-sheet`, `campaign-form`, `job-filters`) still compile and work -- they destructure `enabledServiceTypes` and `customServiceNames` which are unchanged
6. Dashboard page imports from `lib/data/active-business`, NOT from `lib/actions/business`
7. No other dashboard pages were modified (Phase 53 scope)
</verification>

<success_criteria>
- BusinessSettingsProvider has 5 context values: businessId, businessName, businesses, enabledServiceTypes, customServiceNames
- Layout fetches active business and businesses list via new resolver
- Dashboard page redirect works for zero businesses (onboarding) and auto-selects for multi-business
- Existing single-business users see no change in behavior
- Lint and typecheck pass with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/52-multi-business-foundation/52-02-SUMMARY.md`
</output>
