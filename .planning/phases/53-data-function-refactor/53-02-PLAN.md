---
phase: 53-data-function-refactor
plan: 02
type: execute
wave: 2
depends_on: ["53-01"]
files_modified:
  - lib/actions/business.ts
  - lib/actions/customer.ts
  - lib/actions/job.ts
  - lib/actions/campaign.ts
  - lib/actions/dashboard.ts
  - lib/actions/billing.ts
  - lib/actions/send.ts
  - lib/actions/send-sms.action.ts
  - lib/actions/add-job-data.ts
  - lib/actions/add-job-campaigns.ts
  - lib/actions/bulk-resend.ts
  - lib/actions/checklist.ts
  - lib/actions/conflict-resolution.ts
  - lib/actions/message-template.ts
  - lib/actions/onboarding.ts
  - lib/actions/personalize.ts
  - lib/actions/schedule.ts
  - lib/actions/contact.ts
  - lib/actions/send-one-off-data.ts
  - app/(dashboard)/layout.tsx
  - app/(dashboard)/dashboard/page.tsx
  - app/(dashboard)/jobs/page.tsx
  - app/(dashboard)/campaigns/page.tsx
  - app/(dashboard)/campaigns/[id]/page.tsx
  - app/(dashboard)/customers/page.tsx
  - app/(dashboard)/analytics/page.tsx
  - app/(dashboard)/history/page.tsx
  - app/(dashboard)/feedback/page.tsx
  - app/(dashboard)/settings/page.tsx
  - app/(dashboard)/billing/page.tsx
autonomous: true

must_haves:
  truths:
    - "Zero instances of .eq('user_id', ...).single() remain in lib/actions/ that query the businesses table (grep returns zero hits excluding active-business.ts, api-key.ts, auth.ts)"
    - "Every server action that needs a business ID calls getActiveBusiness() at the top and uses business.id — no derivation from user_id"
    - "Every page-level Server Component calls getActiveBusiness() once and passes business.id to all data functions"
    - "No page in app/(dashboard)/ directly queries the businesses table inline"
    - "pnpm lint passes with zero errors"
    - "pnpm typecheck passes with zero errors"
  artifacts:
    - path: "app/(dashboard)/layout.tsx"
      provides: "Layout uses getActiveBusiness() and passes businessId to getDashboardCounts and getServiceTypeSettings"
    - path: "app/(dashboard)/dashboard/page.tsx"
      provides: "Dashboard page passes business.id to getJobCounts and getSetupProgress (previously derived internally)"
    - path: "app/(dashboard)/jobs/page.tsx"
      provides: "Jobs page calls getActiveBusiness() and passes business.id to getJobs and getCustomers"
    - path: "app/(dashboard)/campaigns/page.tsx"
      provides: "Campaigns page calls getActiveBusiness() and passes business.id to getCampaigns, getAvailableTemplates, getMonthlyUsage, getCustomers"
    - path: "app/(dashboard)/settings/page.tsx"
      provides: "Settings page calls getActiveBusiness() instead of inline supabase query"
    - path: "app/(dashboard)/feedback/page.tsx"
      provides: "Feedback page calls getActiveBusiness() instead of inline supabase query"
  key_links:
    - from: "lib/actions/*.ts"
      to: "lib/data/active-business.ts"
      via: "import { getActiveBusiness } from '@/lib/data/active-business'"
      pattern: "getActiveBusiness"
    - from: "app/(dashboard)/*/page.tsx"
      to: "lib/data/active-business.ts"
      via: "const business = await getActiveBusiness()"
      pattern: "getActiveBusiness"
    - from: "app/(dashboard)/*/page.tsx"
      to: "lib/data/*.ts data functions"
      via: "passes business.id as first argument"
      pattern: "\\(business\\.id"
---

<objective>
Refactor all server actions in `lib/actions/` to use `getActiveBusiness()` instead of deriving business from `user_id`, and update all page-level Server Components to call `getActiveBusiness()` once and thread `business.id` to all data functions (which now require explicit `businessId` from Plan 53-01).

Purpose: This completes Phase 53. After this plan, no code in the app derives a business from `user_id` using the dangerous `.single()` pattern. Creating a second business will not crash the application.

Output: ~19 modified action files and ~9 modified page files. `pnpm lint` and `pnpm typecheck` pass with zero errors.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53-data-function-refactor/53-RESEARCH.md
@.planning/phases/53-data-function-refactor/53-01-SUMMARY.md
@lib/data/active-business.ts
@app/(dashboard)/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor all lib/actions/ files to use getActiveBusiness()</name>
  <files>lib/actions/business.ts, lib/actions/customer.ts, lib/actions/job.ts, lib/actions/campaign.ts, lib/actions/dashboard.ts, lib/actions/billing.ts, lib/actions/send.ts, lib/actions/send-sms.action.ts, lib/actions/add-job-data.ts, lib/actions/add-job-campaigns.ts, lib/actions/bulk-resend.ts, lib/actions/checklist.ts, lib/actions/conflict-resolution.ts, lib/actions/message-template.ts, lib/actions/onboarding.ts, lib/actions/personalize.ts, lib/actions/schedule.ts, lib/actions/contact.ts, lib/actions/send-one-off-data.ts</files>
  <action>
For EVERY function in these 18 files that currently does `.from('businesses').select(...).eq('user_id', user.id).single()`, apply this mechanical transformation:

**The Pattern (apply uniformly):**

BEFORE:
```typescript
export async function someAction(...) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return { error: 'Not authenticated' }

  const { data: business } = await supabase
    .from('businesses')
    .select('id')
    .eq('user_id', user.id)
    .single()
  if (!business) return { error: 'Business not found' }
  // ... uses business.id
}
```

AFTER:
```typescript
import { getActiveBusiness } from '@/lib/data/active-business'

export async function someAction(...) {
  const business = await getActiveBusiness()
  if (!business) return { error: 'Business not found' }
  const supabase = await createClient()
  // ... uses business.id directly
```

IMPORTANT: `getActiveBusiness()` handles user auth internally. After calling it, you ONLY need `createClient()` for the actual data queries -- NOT for `getUser()`. If the action still needs `user.id` or `user.email` for something OTHER than business lookup (e.g., Stripe metadata), keep the `getUser()` call but remove the business lookup.

**File-by-file specifics:**

**lib/actions/business.ts** — functions: `updateBusiness`, `saveReviewLink`, `getBusiness`, `getEmailTemplates`, `updateServiceTypeSettings`, `updateReviewCooldown`
- `updateBusiness`: Replace business lookup with `getActiveBusiness()`. SPECIAL: This function has a creation-vs-update branch. For the UPDATE branch, use `business.id` from getActiveBusiness(). For the CREATE branch (when no business exists), the function must still INSERT with `user_id`. So the pattern is: call `getActiveBusiness()`, if null, get user and create new business with `user_id`. If non-null, update using `business.id`.
- `saveReviewLink`: Standard replacement
- `getBusiness`: Standard replacement (this is a duplicate of the data function -- consider if it's still needed after Plan 53-01, but for now just refactor it)
- `getEmailTemplates`: Standard replacement
- `updateServiceTypeSettings`: Standard replacement
- `updateReviewCooldown`: This uses `.eq('user_id', user.id)` WITHOUT `.single()` for an UPDATE. Still dangerous (updates ALL businesses). Replace with `getActiveBusiness()` and `.eq('id', business.id)`

**lib/actions/customer.ts** — All exported functions that do the business lookup
- Standard replacement for each function: `createCustomer`, `updateCustomer`, `getCustomers`, `bulkCreateCustomers`, and any other functions with the dangerous pattern
- NOTE: `findOrCreateCustomer` already uses `.eq('id', businessId).eq('user_id', user.id)` — SAFE, do not change

**lib/actions/job.ts** — `createJob`, `updateJob`, `deleteJob`, `markJobComplete`, and other exported functions
- Standard replacement for each
- Keep `createClient()` for the actual DB operations

**lib/actions/campaign.ts** — `createCampaign`, `updateCampaign`, `pauseCampaign`, `deleteCampaign`
- Standard replacement for each
- NOTE: After refactoring, these call data functions from lib/data/campaign.ts which now need `businessId` — thread `business.id` through

**lib/actions/dashboard.ts** — `getJobDetail`, `dismissJobFromQueue`, `markOneOffSent`
- Standard replacement for these 3 functions
- NOTE: `retrySend`, `acknowledgeAlert`, `dismissFeedbackAlert` are ALREADY SAFE — they use `.eq('id', sendLog.business_id).eq('user_id', user.id)` ownership check pattern. DO NOT CHANGE these.

**lib/actions/billing.ts** — `createCheckoutSession`, `createPortalSession`
- These need `user.email` for Stripe metadata, so keep `getUser()` for email but use `getActiveBusiness()` for business lookup
- Pattern: `const business = await getActiveBusiness(); if (!business) throw new Error('...')` then `const supabase = await createClient(); const { data: { user } } = await supabase.auth.getUser()` for the email

**lib/actions/send.ts**, **lib/actions/send-sms.action.ts** — All functions with dangerous pattern
- Standard replacement

**lib/actions/add-job-data.ts**, **lib/actions/add-job-campaigns.ts** — All functions
- Standard replacement
- These may call refactored data functions that now need businessId — thread it

**lib/actions/bulk-resend.ts** — Standard replacement

**lib/actions/checklist.ts** — All functions with dangerous pattern
- Standard replacement

**lib/actions/conflict-resolution.ts** — `resolveEnrollmentConflict`
- Standard replacement

**lib/actions/message-template.ts** — All functions with dangerous pattern
- Standard replacement

**lib/actions/onboarding.ts** — All functions
- SPECIAL CASE: `saveBusinessBasics` and similar creation functions need to CREATE a business if none exists. Pattern: call `getActiveBusiness()`. If it returns null, INSERT with user_id from `getUser()`. If it returns a business, UPDATE using `business.id`.
- For functions that only READ or UPDATE existing business data, standard replacement applies.

**lib/actions/personalize.ts** — All functions
- Standard replacement

**lib/actions/schedule.ts** — All functions
- Standard replacement

**lib/actions/contact.ts** — Legacy file parallel to customer.ts
- Standard replacement for all functions with the dangerous pattern

**lib/actions/send-one-off-data.ts** — `getSendOneOffData()`
- This function calls `getBusiness()`, `getAvailableTemplates('email')`, `getMonthlyUsage()`, and `getCustomers({ limit: 200 })` — ALL four change signature in Plan 53-01
- Add `getActiveBusiness()` at the top: `const business = await getActiveBusiness(); if (!business) return null;`
- Update all four calls to pass `business.id`:
  - `getBusiness()` → `getBusiness(business.id)` (from lib/data/business.ts)
  - `getAvailableTemplates('email')` → `getAvailableTemplates(business.id, 'email')`
  - `getMonthlyUsage()` → `getMonthlyUsage(business.id)`
  - `getCustomers({ limit: 200 })` → `getCustomers({ limit: 200 })` (check if getCustomers from lib/actions/customer.ts also changed — if it now needs businessId, pass it; if it internally calls getActiveBusiness(), leave as-is)
- Add import: `import { getActiveBusiness } from '@/lib/data/active-business'`

**Files to NOT change:**
- `lib/actions/active-business.ts` — Already correct (the resolver itself)
- `lib/actions/api-key.ts` — Queries `api_keys` table, not businesses table via user_id for a different purpose (one key per user). Safe.
- `lib/actions/auth.ts` — Account deletion deletes ALL businesses for user. This is correct behavior.
- `lib/actions/enrollment.ts` — If present, uses PK lookups. Safe.
  </action>
  <verify>
Run this grep to confirm zero dangerous instances remain:
```
grep -rn "\.from('businesses')" lib/actions/ | grep "eq('user_id'" | grep -v "active-business" | grep -v "api-key" | grep -v "auth.ts" | grep -v "// "
```
Should return zero results.

Run `grep -rn "getActiveBusiness" lib/actions/ | wc -l` — should show many hits (one per refactored function).

Run `pnpm typecheck 2>&1 | head -100` — expect errors ONLY from page-level callers of refactored data functions (or zero errors if pages are fixed in Task 2).
  </verify>
  <done>
All ~40 dangerous instances across ~19 action files replaced with getActiveBusiness() calls. No action file queries the businesses table via user_id except the excluded safe files (active-business.ts, api-key.ts, auth.ts). send-one-off-data.ts threads business.id to getBusiness, getAvailableTemplates, getMonthlyUsage, and getCustomers. Onboarding creation path still uses user_id for INSERT when getActiveBusiness() returns null. Billing actions still call getUser() for email but use getActiveBusiness() for business lookup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all page-level Server Components to call getActiveBusiness() and thread businessId</name>
  <files>app/(dashboard)/layout.tsx, app/(dashboard)/dashboard/page.tsx, app/(dashboard)/jobs/page.tsx, app/(dashboard)/campaigns/page.tsx, app/(dashboard)/campaigns/[id]/page.tsx, app/(dashboard)/customers/page.tsx, app/(dashboard)/analytics/page.tsx, app/(dashboard)/history/page.tsx, app/(dashboard)/feedback/page.tsx, app/(dashboard)/settings/page.tsx, app/(dashboard)/billing/page.tsx</files>
  <action>
Each page must call `getActiveBusiness()` once at the top and pass `business.id` to all data functions that now require it (from Plan 53-01). Use `app/(dashboard)/dashboard/page.tsx` as the reference pattern.

**app/(dashboard)/layout.tsx:**
- Currently calls `getServiceTypeSettings()` (no businessId) and `getDashboardCounts()` (no businessId)
- After Plan 53-01, both require `businessId`
- The layout already calls `getActiveBusiness()` on line 18 — reuse `business.id`
- Change line 14: `getServiceTypeSettings()` → `getServiceTypeSettings(business?.id ?? '')`
- BUT: `getServiceTypeSettings` is called BEFORE `business` is resolved (line 14 vs line 18). Restructure:
  ```typescript
  const [business, businesses] = await Promise.all([
    getActiveBusiness(),
    getUserBusinesses(),
  ])
  const businessId = business?.id ?? ''
  const serviceSettings = await getServiceTypeSettings(businessId)
  // ... then getDashboardCounts(businessId)
  ```
- Or better: move `getServiceTypeSettings` into the parallel block with a guard. Since `getActiveBusiness()` must resolve first, call it first, THEN parallel the rest:
  ```typescript
  const [business, businesses] = await Promise.all([
    getActiveBusiness(),
    getUserBusinesses(),
  ])
  const businessId = business?.id ?? ''
  const businessName = business?.name ?? ''

  const [serviceSettings, dashboardCounts] = await Promise.all([
    getServiceTypeSettings(businessId),
    getDashboardCounts(businessId).catch(() => ({ readyToSend: 0, attentionAlerts: 0, total: 0 })),
  ])
  const enabledServiceTypes = (serviceSettings?.serviceTypesEnabled || []) as ServiceType[]
  const customServiceNames = serviceSettings?.customServiceNames || []
  const dashboardBadge = dashboardCounts.total
  ```

**app/(dashboard)/dashboard/page.tsx:**
- Already calls `getActiveBusiness()` — good
- Currently calls `getServiceTypeSettings()` (line 42) — needs `business.id`: `getServiceTypeSettings(business.id)`
- Currently calls `getJobCounts()` (line 59) — needs `business.id`: `getJobCounts(business.id)`
- Currently calls `getSetupProgress()` (line 61) — needs `business.id`: `getSetupProgress(business.id)`
- The other calls (`getDashboardKPIs`, `getReadyToSendJobs`, `getAttentionAlerts`, `getRecentCampaignEvents`) already pass `business.id` — no change needed

**app/(dashboard)/jobs/page.tsx:**
- Currently calls `getJobs()` and `getCustomers()` without businessId
- Add `getActiveBusiness()` at top, redirect if null
- Pass `business.id` to `getJobs(business.id)` and `getCustomers(business.id, { limit: 200 })` (if getCustomers is refactored in Task 1)
- IMPORTANT: `getJobs` return type no longer includes `businessId`. Change destructuring from `const [{ jobs, total, businessId }, ...]` to `const [{ jobs, total }, ...]` and use `business.id` for the campaign map call

**app/(dashboard)/campaigns/page.tsx:**
- Currently calls `getBusiness()` from actions — replace with `getActiveBusiness()`
- Pass `business.id` to: `getCampaigns(business.id, ...)`, `getAvailableTemplates(business.id)`, `getMonthlyUsage(business.id)`, and `getCustomers(business.id, ...)`
- PROBLEM: `getBusiness()` from actions returned the full business with templates. `getActiveBusiness()` returns a Business without templates joined. Either:
  - Option A: Also call `getBusiness(business.id)` from lib/data/business.ts to get templates (adds one query)
  - Option B: Call `getMessageTemplates(business.id)` or `getAvailableTemplates(business.id)` separately for the email templates
  - Go with Option A: call `getBusiness(business.id)` from `lib/data/business.ts` to get the full business with templates, since downstream components need `business.message_templates`
  - Pattern:
    ```typescript
    const activeBusiness = await getActiveBusiness()
    if (!activeBusiness) redirect('/onboarding')
    const [business, campaigns, presets, ...] = await Promise.all([
      getBusiness(activeBusiness.id),
      getCampaigns(activeBusiness.id, { includePresets: false }),
      ...
    ])
    if (!business) redirect('/onboarding')
    ```

**app/(dashboard)/campaigns/[id]/page.tsx:**
- Same pattern as campaigns page: replace `getBusiness()` with `getActiveBusiness()` + `getBusiness(business.id)`
- Pass `business.id` to `getAvailableTemplates(business.id)`

**app/(dashboard)/customers/page.tsx:**
- Replace `getBusiness()` with `getActiveBusiness()` + `getBusiness(business.id)` (needs templates)
- Pass `business.id` to `getCustomers(business.id)` and `getMonthlyUsage(business.id)`

**app/(dashboard)/analytics/page.tsx:**
- Replace `getBusiness()` from lib/data/business.ts with `getActiveBusiness()`
- `getServiceTypeAnalytics(business.id)` already receives `business.id` — no change needed for that call

**app/(dashboard)/history/page.tsx:**
- Replace `getBusiness()` with `getActiveBusiness()` + `getBusiness(business.id)` (needs templates)
- Pass `business.id` to `getSendLogs(business.id, ...)`

**app/(dashboard)/feedback/page.tsx:**
- REMOVE the inline supabase query (lines 12-32): `createClient()` → `.from('businesses').select('id').eq('user_id', user.id).single()`
- Replace with `getActiveBusiness()`
- Keep the `getFeedbackForBusiness(business.id, ...)` and `getFeedbackStats(business.id)` calls — they already accept businessId

**app/(dashboard)/settings/page.tsx:**
- REMOVE the inline supabase query in `SettingsContent()` (lines 20-33): `createClient()` → `.from('businesses').select('*').eq('user_id', user.id).single()`
- Replace with `getActiveBusiness()` to get business. For the full business object, call `getBusiness(business.id)` from lib/data/business.ts.
- Pass `business.id` to: `getAvailableTemplates(business.id)`, `getServiceTypeSettings(business.id)`, `getPersonalizationSummary(business.id)`, `getCustomers(business.id)`, `getMonthlyUsage(business.id)`
- Keep `hasApiKey()` — it queries `api_keys` by `user_id`, not businesses (safe, don't change)
- Keep `user` for `hasPasswordAuth` check — still needed

**app/(dashboard)/billing/page.tsx:**
- `getBusinessBillingInfo()` now requires `businessId`
- Add `getActiveBusiness()` at top
- Call `getBusinessBillingInfo(business.id)`
- The redirect-if-no-business check is now implicit: `if (!business) redirect('/onboarding')`

**CRITICAL PITFALLS:**
1. Do NOT call `getActiveBusiness()` more than once per page. Call it once, reuse `business.id`.
2. Pages that need the full business object WITH templates should call `getBusiness(business.id)` from `lib/data/business.ts` (not `getActiveBusiness()` which returns a plain Business)
3. `getCustomers()` in actions may also need businessId passed — if it was refactored in Task 1. Check the signature and update accordingly.
4. Remove any now-unused imports (e.g., `import { getBusiness } from '@/lib/actions/business'` → `import { getActiveBusiness } from '@/lib/data/active-business'`)
  </action>
  <verify>
Run all three verification checks:

1. `grep -rn "eq('user_id'" app/(dashboard)/` — should return zero results (no inline business queries)

2. `grep -rn "eq('user_id'" lib/actions/ | grep -v "active-business\|api-key\|auth\|enrollment\|// "` — should return zero results

3. `grep -rn "eq('user_id'" lib/data/ | grep -v "active-business"` — should return zero results

4. `pnpm lint` — zero errors

5. `pnpm typecheck` — zero errors
  </verify>
  <done>
All 10 page-level Server Components call getActiveBusiness() once and pass business.id to all data functions. No page directly queries the businesses table. Settings and feedback pages no longer have inline supabase queries. Layout threads businessId to getServiceTypeSettings and getDashboardCounts. Both lint and typecheck pass cleanly.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, run the full verification sequence:

1. **Zero dangerous queries in lib/data/:**
   `grep -rn "eq('user_id'" lib/data/ | grep -v "active-business"` → zero results

2. **Zero dangerous queries in lib/actions/:**
   `grep -rn "\.from('businesses')" lib/actions/ | grep "eq('user_id'" | grep -v "active-business\|api-key\|auth"` → zero results

3. **Zero inline queries in pages:**
   `grep -rn "eq('user_id'" app/(dashboard)/` → zero results

4. **All pages use getActiveBusiness:**
   `grep -rn "getActiveBusiness" app/(dashboard)/` → hits in layout + every page that needs business data

5. **Lint passes:**
   `pnpm lint` → zero errors

6. **Typecheck passes:**
   `pnpm typecheck` → zero errors

7. **Functional smoke test (manual, post-deploy):**
   - Create a second test business via Supabase dashboard
   - Navigate to every dashboard page (Dashboard, Jobs, Campaigns, Campaigns/[id], Customers, Analytics, History, Feedback, Settings, Billing)
   - Verify no PGRST116 errors in browser console or server logs
   - Verify data shown is for the active business (not mixed)
</verification>

<success_criteria>
- Zero instances of `.eq('user_id', ...).single()` querying the businesses table remain in lib/data/, lib/actions/, or app/(dashboard)/ (excluding the three safe files: active-business.ts, api-key.ts, auth.ts)
- All server actions call getActiveBusiness() for business resolution
- All page-level Server Components call getActiveBusiness() once and thread business.id
- Onboarding creation path still works (creates business with user_id when none exists)
- Billing actions still access user.email for Stripe metadata
- pnpm lint: zero errors
- pnpm typecheck: zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/53-data-function-refactor/53-02-SUMMARY.md`
</output>
