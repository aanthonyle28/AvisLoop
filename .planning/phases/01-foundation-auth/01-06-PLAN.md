---
phase: 01-foundation-auth
plan: 06
type: execute
wave: 2
depends_on:
  - "01-04"
files_modified:
  - components/login-form.tsx
  - components/sign-up-form.tsx
  - components/forgot-password-form.tsx
  - components/update-password-form.tsx
  - components/logout-button.tsx
  - app/verify-email/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Login form uses signIn Server Action with useActionState"
    - "Signup form uses signUp Server Action with useActionState"
    - "Forgot password form uses resetPassword Server Action with useActionState"
    - "Update password form uses updatePassword Server Action with useActionState"
    - "Logout button uses signOut Server Action"
    - "Form validation errors display per-field using fieldErrors"
  artifacts:
    - path: "components/login-form.tsx"
      provides: "Login form wired to Server Actions"
      contains: "useActionState"
      min_lines: 60
    - path: "components/sign-up-form.tsx"
      provides: "Signup form wired to Server Actions"
      contains: "useActionState"
      min_lines: 80
    - path: "components/forgot-password-form.tsx"
      provides: "Forgot password form wired to Server Actions"
      contains: "useActionState"
      min_lines: 50
    - path: "components/update-password-form.tsx"
      provides: "Update password form wired to Server Actions"
      contains: "useActionState"
      min_lines: 70
    - path: "components/logout-button.tsx"
      provides: "Logout button wired to Server Action"
      contains: "signOut"
      min_lines: 10
  key_links:
    - from: "components/login-form.tsx"
      to: "lib/actions/auth.ts"
      via: "signIn import"
      pattern: "import.*signIn.*lib/actions/auth"
    - from: "components/sign-up-form.tsx"
      to: "lib/actions/auth.ts"
      via: "signUp import"
      pattern: "import.*signUp.*lib/actions/auth"
    - from: "components/logout-button.tsx"
      to: "lib/actions/auth.ts"
      via: "signOut import"
      pattern: "import.*signOut.*lib/actions/auth"
---

<objective>
Wire all auth forms to use the existing Server Actions from lib/actions/auth.ts using useActionState hook, replacing the current client-side Supabase auth.

Purpose: Server Actions provide better security (credentials never touch client), automatic Zod validation, and cleaner form state management. The actions exist but forms still use client-side auth.

Output: All 4 auth forms and logout button using Server Actions with proper error display.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-03-SUMMARY.md
@lib/actions/auth.ts
@lib/validations/auth.ts
@components/ui/form.tsx
@components/ui/input.tsx
@components/ui/button.tsx
@components/ui/card.tsx
@components/ui/label.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update LoginForm to use signIn Server Action</name>
  <files>components/login-form.tsx</files>
  <action>
Rewrite components/login-form.tsx to use Server Actions:

1. Remove client-side Supabase imports and useState for email/password
2. Import useActionState from react
3. Import signIn, AuthActionState from @/lib/actions/auth
4. Use useActionState hook: `const [state, formAction, pending] = useActionState(signIn, null)`
5. Use native form with action={formAction}
6. Display state.error for general errors
7. Display state.fieldErrors?.email and state.fieldErrors?.password for per-field errors
8. Use pending state for button disabled/loading

Pattern:
```tsx
"use client";

import { useActionState } from "react";
import { signIn, type AuthActionState } from "@/lib/actions/auth";
// ... other imports

export function LoginForm({ className, ...props }) {
  const [state, formAction, pending] = useActionState<AuthActionState | null, FormData>(signIn, null);

  return (
    <form action={formAction}>
      {/* Email field with name="email" */}
      {state?.fieldErrors?.email && <p className="text-sm text-red-500">{state.fieldErrors.email[0]}</p>}

      {/* Password field with name="password" */}
      {state?.fieldErrors?.password && <p className="text-sm text-red-500">{state.fieldErrors.password[0]}</p>}

      {/* General error */}
      {state?.error && <p className="text-sm text-red-500">{state.error}</p>}

      <Button type="submit" disabled={pending}>
        {pending ? "Logging in..." : "Login"}
      </Button>
    </form>
  );
}
```

Keep:
- shadcn/ui components (Card, Input, Button, Label)
- Layout structure and styling
- Links to signup and forgot password

Remove:
- useState for email, password, error, isLoading
- createClient from @/lib/supabase/client
- useRouter
- handleLogin async function
- e.preventDefault()
  </action>
  <verify>
1. `grep "useActionState" components/login-form.tsx` shows hook usage
2. `grep "import.*signIn" components/login-form.tsx` shows action import
3. `grep "action={formAction}" components/login-form.tsx` shows form wiring
4. `grep "name=\"email\"" components/login-form.tsx` shows proper input names
5. `grep "createClient" components/login-form.tsx` should return nothing (removed)
  </verify>
  <done>
- LoginForm uses useActionState with signIn
- Form submits via action={formAction}
- Field errors display per-field
- No client-side Supabase auth
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SignUpForm to use signUp Server Action</name>
  <files>components/sign-up-form.tsx</files>
  <action>
Rewrite components/sign-up-form.tsx to use Server Actions:

1. Import useActionState from react
2. Import signUp, AuthActionState from @/lib/actions/auth
3. Use useActionState: `const [state, formAction, pending] = useActionState(signUp, null)`
4. Add fullName field (optional, from schema)
5. Remove repeatPassword field (validation handled by Zod in server action if needed, or add confirmPassword to schema - check lib/validations/auth.ts)
6. Display field errors for email, password, fullName
7. Use pending state for loading

Note: The signUpSchema in lib/validations/auth.ts has: email, password, fullName (optional)
The form should have fields named: email, password, fullName

Keep:
- shadcn/ui components
- Layout and styling
- Link to login

Remove:
- useState for all form fields
- createClient
- useRouter
- handleSignUp async function
- Client-side password comparison
  </action>
  <verify>
1. `grep "useActionState" components/sign-up-form.tsx` shows hook usage
2. `grep "import.*signUp" components/sign-up-form.tsx` shows action import
3. `grep "name=\"fullName\"" components/sign-up-form.tsx` shows fullName field
4. `grep "createClient" components/sign-up-form.tsx` should return nothing
  </verify>
  <done>
- SignUpForm uses useActionState with signUp
- Has email, password, and optional fullName fields
- Field errors display correctly
- No client-side Supabase auth
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ForgotPasswordForm and UpdatePasswordForm to use Server Actions</name>
  <files>components/forgot-password-form.tsx, components/update-password-form.tsx</files>
  <action>
**ForgotPasswordForm (forgot-password-form.tsx):**

1. Import useActionState and resetPassword from lib/actions/auth
2. Use useActionState: `const [state, formAction, pending] = useActionState(resetPassword, null)`
3. Show success state when state?.success is true (keep the success card UI)
4. Display field errors for email
5. Use pending for loading state

The resetPassword action returns { success: true } on success, so check state?.success to show the success message card.

**UpdatePasswordForm (update-password-form.tsx):**

1. Import useActionState and updatePassword from lib/actions/auth
2. Use useActionState: `const [state, formAction, pending] = useActionState(updatePassword, null)`
3. Add confirmPassword field (required by updatePasswordSchema)
4. Display field errors for password and confirmPassword
5. Use pending for loading state

Note: updatePasswordSchema in lib/validations/auth.ts requires:
- password (min 8, max 72)
- confirmPassword (must match password)

Keep:
- shadcn/ui components
- Layout and styling
- Links

Remove:
- useState for fields
- createClient
- useRouter
- Async handlers
  </action>
  <verify>
1. `grep "useActionState" components/forgot-password-form.tsx` shows hook
2. `grep "import.*resetPassword" components/forgot-password-form.tsx` shows import
3. `grep "useActionState" components/update-password-form.tsx` shows hook
4. `grep "import.*updatePassword" components/update-password-form.tsx` shows import
5. `grep "name=\"confirmPassword\"" components/update-password-form.tsx` shows confirm field
6. `grep "createClient" components/forgot-password-form.tsx` should return nothing
7. `grep "createClient" components/update-password-form.tsx` should return nothing
  </verify>
  <done>
- ForgotPasswordForm uses resetPassword action with success state display
- UpdatePasswordForm uses updatePassword action with confirmPassword field
- Both use useActionState pattern
- No client-side Supabase auth in either
  </done>
</task>

<task type="auto">
  <name>Task 4: Update LogoutButton to use signOut Server Action and create verify-email page</name>
  <files>components/logout-button.tsx, app/verify-email/page.tsx</files>
  <action>
**LogoutButton (logout-button.tsx):**

1. Import signOut from @/lib/actions/auth
2. Create a form with the signOut action
3. signOut returns Promise<never> (always redirects), so no state needed

Pattern:
```tsx
import { signOut } from "@/lib/actions/auth";
import { Button } from "@/components/ui/button";

export function LogoutButton() {
  return (
    <form action={signOut}>
      <Button type="submit">Logout</Button>
    </form>
  );
}
```

Remove:
- "use client" directive (not needed for form action)
- createClient import
- useRouter
- async logout function

**verify-email page (app/verify-email/page.tsx):**

The signUp action redirects to /verify-email on success. Create a simple confirmation page:

```tsx
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";
import Link from "next/link";

export default function VerifyEmailPage() {
  return (
    <div className="flex min-h-svh w-full items-center justify-center p-6 md:p-10">
      <div className="w-full max-w-sm">
        <Card>
          <CardHeader>
            <CardTitle className="text-2xl">Check your email</CardTitle>
            <CardDescription>
              We sent you a verification link
            </CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground">
              Click the link in your email to verify your account.
              If you don't see it, check your spam folder.
            </p>
            <div className="mt-4 text-center text-sm">
              <Link href="/auth/login" className="underline underline-offset-4">
                Back to login
              </Link>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
1. `grep "import.*signOut" components/logout-button.tsx` shows import
2. `grep "action={signOut}" components/logout-button.tsx` shows form action
3. `grep "createClient" components/logout-button.tsx` should return nothing
4. `ls app/verify-email/page.tsx` confirms verify-email page exists
5. `npm run build` succeeds
  </verify>
  <done>
- LogoutButton uses signOut Server Action via form
- No client-side Supabase auth in LogoutButton
- verify-email page exists for post-signup redirect
- Build passes
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. All forms use useActionState pattern
3. No files import createClient from @/lib/supabase/client for auth operations
4. grep for "createClient" in form components returns nothing
5. All auth flows work:
   - /auth/login submits via Server Action
   - /auth/sign-up submits via Server Action
   - /auth/forgot-password submits via Server Action
   - /auth/update-password submits via Server Action
   - Logout button submits via Server Action
</verification>

<success_criteria>
- All 4 auth forms (login, signup, forgot-password, update-password) use useActionState with Server Actions
- LogoutButton uses signOut Server Action
- Field-level validation errors display correctly
- verify-email page exists for signup flow
- No client-side Supabase auth calls in form components
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-06-SUMMARY.md`
</output>
