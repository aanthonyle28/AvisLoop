---
phase: 01-foundation-auth
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - middleware.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Middleware intercepts requests and refreshes auth tokens"
    - "Unauthenticated users are redirected from /dashboard and /protected to /login"
    - "Authenticated users are redirected from auth pages to /dashboard"
  artifacts:
    - path: "middleware.ts"
      provides: "Next.js middleware for auth token refresh"
      exports: ["middleware", "config"]
      min_lines: 50
  key_links:
    - from: "middleware.ts"
      to: "@supabase/ssr"
      via: "createServerClient import"
      pattern: "import.*createServerClient.*@supabase/ssr"
    - from: "middleware.ts"
      to: "supabase.auth.getUser()"
      via: "JWT validation"
      pattern: "getUser\\(\\)"
---

<objective>
Fix middleware configuration by renaming proxy.ts to middleware.ts and renaming the exported function from `proxy` to `middleware`.

Purpose: Next.js requires a file named middleware.ts at the project root with a function named `middleware` for request interception to work. The current proxy.ts has correct logic but wrong naming.

Output: Working middleware that intercepts requests, refreshes auth tokens, and protects routes.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
@proxy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename proxy.ts to middleware.ts and fix function name</name>
  <files>middleware.ts, proxy.ts</files>
  <action>
1. Delete proxy.ts (it will be replaced)
2. Create middleware.ts at project root with the same content as proxy.ts BUT:
   - Rename the exported function from `proxy` to `middleware`
   - Keep all other logic identical (createServerClient, getUser(), route protection, config matcher)

The file should export:
- `middleware` function (async, takes NextRequest, returns NextResponse)
- `config` object with matcher array

Do NOT change:
- The route protection logic
- The cookie handling
- The getUser() validation pattern
- The matcher configuration

This is a pure rename/restructure - the logic is already correct.
  </action>
  <verify>
1. `ls middleware.ts` confirms file exists at project root
2. `grep "export async function middleware" middleware.ts` returns match
3. `grep "export const config" middleware.ts` returns match
4. `ls proxy.ts 2>/dev/null || echo "proxy.ts deleted"` confirms old file removed
5. `npm run build` succeeds without errors
  </verify>
  <done>
- middleware.ts exists at project root
- Exports `middleware` function (not `proxy`)
- Exports `config` with matcher
- proxy.ts no longer exists
- Build succeeds
  </done>
</task>

</tasks>

<verification>
1. Start dev server: `npm run dev`
2. Visit /dashboard without being logged in - should redirect to /login
3. Middleware manifest should show the matcher patterns
</verification>

<success_criteria>
- middleware.ts at project root with correct function name
- Route protection working (unauthenticated users redirected from /dashboard)
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-04-SUMMARY.md`
</output>
