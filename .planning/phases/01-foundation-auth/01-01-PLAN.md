---
phase: 01-foundation-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - .env.local
  - .env.example
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/middleware.ts
  - next.config.ts
  - tsconfig.json
  - tailwind.config.ts
autonomous: true
user_setup:
  - service: supabase
    why: "Authentication and database backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon public key"
    dashboard_config:
      - task: "Create Supabase project"
        location: "https://supabase.com/dashboard -> New Project"
      - task: "Update email templates for PKCE flow"
        location: "Supabase Dashboard -> Authentication -> Email Templates"

must_haves:
  truths:
    - "Next.js 15 project runs with npm run dev"
    - "Supabase client can be created in browser context"
    - "Supabase client can be created in server context"
    - "Middleware intercepts requests and refreshes auth tokens"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies including @supabase/ssr"
      contains: "@supabase/ssr"
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client factory"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client factory with cookie handling"
      exports: ["createClient"]
    - path: "src/middleware.ts"
      provides: "Token refresh and protected route redirects"
      contains: "getUser"
  key_links:
    - from: "src/middleware.ts"
      to: "supabase.auth.getUser()"
      via: "JWT validation on every request"
      pattern: "supabase\\.auth\\.getUser"
    - from: "src/lib/supabase/server.ts"
      to: "cookies()"
      via: "Next.js cookie handling"
      pattern: "await cookies\\(\\)"
---

<objective>
Set up Next.js 15 project with Supabase authentication infrastructure.

Purpose: Establish the foundation for all authentication flows. Without this, no auth features can be built.
Output: Working Next.js project with configured Supabase clients for browser and server, plus middleware for token refresh.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js project with Supabase template</name>
  <files>
    package.json
    next.config.ts
    tsconfig.json
    tailwind.config.ts
    src/app/layout.tsx
    src/app/page.tsx
  </files>
  <action>
Run `npx create-next-app@latest . -e with-supabase --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"` to scaffold the project using Supabase's official Next.js template.

This template includes:
- @supabase/supabase-js and @supabase/ssr pre-configured
- Basic Supabase client setup
- Middleware skeleton
- TypeScript configuration

If the directory is not empty, move existing .planning folder temporarily, run create-next-app, then restore .planning.

After scaffold, install additional dependencies:
```bash
npm install react-hook-form zod @hookform/resolvers
npx shadcn@latest init -d
npx shadcn@latest add form input button card label
```

Use default shadcn options (New York style, zinc base color, CSS variables).
  </action>
  <verify>
- `npm run dev` starts server on localhost:3000
- `package.json` contains @supabase/ssr, react-hook-form, zod
- shadcn components exist in src/components/ui/
  </verify>
  <done>Next.js 15 project with Supabase template and UI dependencies installed and running</done>
</task>

<task type="auto">
  <name>Task 2: Configure Supabase client factories</name>
  <files>
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    .env.local
    .env.example
  </files>
  <action>
The template includes basic client setup. Verify and update if needed to match the patterns from 01-RESEARCH.md:

**Browser Client (`src/lib/supabase/client.ts`):**
```typescript
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

**Server Client (`src/lib/supabase/server.ts`):**
Must use async function and await cookies() for Next.js 15:
```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // Called from Server Component - middleware handles refresh
          }
        },
      },
    }
  )
}
```

Create `.env.example` with placeholder values:
```
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

Create `.env.local` with same structure (user will fill in values).
  </action>
  <verify>
- `src/lib/supabase/client.ts` exports createClient function
- `src/lib/supabase/server.ts` exports async createClient function with cookies() awaited
- `.env.example` exists with documented variables
  </verify>
  <done>Supabase client factories configured for browser and server with proper cookie handling</done>
</task>

<task type="auto">
  <name>Task 3: Configure middleware for token refresh and route protection</name>
  <files>
    src/middleware.ts
  </files>
  <action>
Update middleware to:
1. Refresh auth tokens via getUser() (CRITICAL: never use getSession() on server)
2. Redirect unauthenticated users from /dashboard/* to /login
3. Redirect authenticated users from /login, /signup to /dashboard

```typescript
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) =>
            request.cookies.set(name, value)
          )
          supabaseResponse = NextResponse.next({
            request,
          })
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  // CRITICAL: Always use getUser(), never getSession()
  const { data: { user } } = await supabase.auth.getUser()

  // Redirect unauthenticated users trying to access protected routes
  if (!user && request.nextUrl.pathname.startsWith('/dashboard')) {
    const url = request.nextUrl.clone()
    url.pathname = '/login'
    return NextResponse.redirect(url)
  }

  // Redirect authenticated users away from auth pages
  if (user && (request.nextUrl.pathname === '/login' || request.nextUrl.pathname === '/signup')) {
    const url = request.nextUrl.clone()
    url.pathname = '/dashboard'
    return NextResponse.redirect(url)
  }

  return supabaseResponse
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```
  </action>
  <verify>
- `src/middleware.ts` contains getUser() call (NOT getSession)
- Middleware exports config with matcher
- Middleware handles both /dashboard protection and auth page redirects
  </verify>
  <done>Middleware configured for token refresh and route protection with proper security patterns</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run dev` starts without errors
2. `npm run build` completes successfully
3. Visiting http://localhost:3000/dashboard redirects to /login (before auth is wired up, this confirms middleware works)
4. All Supabase client files exist with correct exports
</verification>

<success_criteria>
- Next.js 15 project running with Supabase dependencies
- Browser and server Supabase clients properly configured
- Middleware refreshes tokens and protects routes
- Environment variable template exists
- shadcn/ui components installed (form, input, button, card, label)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-01-SUMMARY.md`
</output>
