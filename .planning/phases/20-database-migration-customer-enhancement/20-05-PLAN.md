---
phase: 20-database-migration-customer-enhancement
plan: 05
type: execute
wave: 3
depends_on: ["20-04"]
files_modified:
  - components/customers/customer-columns.tsx
  - components/customers/customer-filters.tsx
  - components/customers/customers-client.tsx
  - components/customers/customer-detail-drawer.tsx
  - components/ui/tag-badge.tsx
  - lib/actions/customer.ts
autonomous: true

must_haves:
  truths:
    - "Customer list shows phone number column with US formatting"
    - "Customer list shows tags column with tag badges"
    - "Tag filter UI allows selecting multiple tags (OR filtering)"
    - "Customer list filters by tag (clicking tag chip shows only tagged customers)"
    - "Phone displays with copy icon that shows toast on click"
    - "Customers without phone show 'Email-only' badge"
  artifacts:
    - path: "components/customers/customer-columns.tsx"
      provides: "Table columns with phone and tags"
      contains: "formatPhoneDisplay"
    - path: "components/customers/customer-filters.tsx"
      provides: "Tag filter chips"
      contains: "selectedTags"
    - path: "components/customers/customers-client.tsx"
      provides: "Tag filter state wiring to table"
      contains: "setFilterValue"
    - path: "components/ui/tag-badge.tsx"
      provides: "Reusable tag badge component"
      exports: ["TagBadge"]
  key_links:
    - from: "components/customers/customer-columns.tsx"
      to: "lib/utils/phone.ts"
      via: "import for display formatting"
      pattern: "import.*formatPhoneDisplay"
    - from: "components/customers/customers-client.tsx"
      to: "components/customers/customer-filters.tsx"
      via: "selectedTags prop and onTagFilterChange callback"
      pattern: "onTagFilterChange.*setSelectedTags"
    - from: "components/customers/customers-client.tsx"
      to: "TanStack Table column filter"
      via: "table.getColumn('tags')?.setFilterValue"
      pattern: "getColumn.*tags.*setFilterValue"
---

<objective>
Update customer list UI to show phone number column with formatting, tags column with badge display, and tag filter functionality. Add copy-to-clipboard for phone numbers.

Purpose: Complete CUST-02 (phone display), CUST-03 (tags UI), CUST-04 (filtering)
Output: Customer table with phone and tags columns, tag filter UI
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-database-migration-customer-enhancement/20-CONTEXT.md
@components/contacts/contact-columns.tsx
@components/contacts/contact-filters.tsx
@lib/utils/phone.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tag badge component</name>
  <files>components/ui/tag-badge.tsx</files>
  <action>
Create a reusable tag badge component at components/ui/tag-badge.tsx:

```typescript
'use client'

import { cn } from '@/lib/utils'

interface TagBadgeProps {
  tag: string
  onRemove?: () => void
  onClick?: () => void
  selected?: boolean
  className?: string
}

const PRESET_TAGS = ['VIP', 'repeat', 'commercial', 'residential']

export function TagBadge({
  tag,
  onRemove,
  onClick,
  selected = false,
  className,
}: TagBadgeProps) {
  const isPreset = PRESET_TAGS.includes(tag)

  return (
    <span
      onClick={onClick}
      className={cn(
        'inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium',
        'bg-muted text-muted-foreground',
        onClick && 'cursor-pointer hover:bg-muted/80',
        selected && 'bg-primary text-primary-foreground',
        className
      )}
    >
      {tag}
      {onRemove && (
        <button
          type="button"
          onClick={(e) => {
            e.stopPropagation()
            onRemove()
          }}
          className="ml-0.5 hover:text-foreground"
          aria-label={`Remove ${tag} tag`}
        >
          <svg
            className="h-3 w-3"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      )}
    </span>
  )
}

export function TagList({
  tags,
  onRemove,
  className,
}: {
  tags: string[]
  onRemove?: (tag: string) => void
  className?: string
}) {
  if (!tags || tags.length === 0) return null

  return (
    <div className={cn('flex flex-wrap gap-1', className)}>
      {tags.map((tag) => (
        <TagBadge
          key={tag}
          tag={tag}
          onRemove={onRemove ? () => onRemove(tag) : undefined}
        />
      ))}
    </div>
  )
}

export { PRESET_TAGS }
```
  </action>
  <verify>components/ui/tag-badge.tsx exists with TagBadge, TagList, PRESET_TAGS exports</verify>
  <done>Tag badge component created with support for display, selection state, and removal</done>
</task>

<task type="auto">
  <name>Task 2: Update customer table columns with phone and tags</name>
  <files>components/customers/customer-columns.tsx</files>
  <action>
Update customer-columns.tsx to add phone and tags columns:

1. Import phone formatting utility:
```typescript
import { formatPhoneDisplay } from '@/lib/utils/phone'
import { TagList } from '@/components/ui/tag-badge'
import { Copy, Envelope } from '@phosphor-icons/react'
import { toast } from 'sonner'
```

2. Add phone column after email column:
```typescript
{
  accessorKey: 'phone',
  header: 'Phone',
  cell: ({ row }) => {
    const phone = row.original.phone
    const phoneStatus = row.original.phone_status

    if (!phone || phoneStatus === 'missing') {
      return (
        <span className="inline-flex items-center gap-1 text-xs text-muted-foreground">
          <Envelope className="h-3 w-3" />
          Email-only
        </span>
      )
    }

    const formatted = formatPhoneDisplay(phone)

    const handleCopy = async () => {
      await navigator.clipboard.writeText(phone)
      toast.success('Phone copied to clipboard')
    }

    return (
      <div className="flex items-center gap-1">
        <span className="font-mono text-sm">{formatted}</span>
        <button
          onClick={handleCopy}
          className="p-1 hover:bg-muted rounded opacity-0 group-hover:opacity-100 transition-opacity"
          title="Copy phone number"
        >
          <Copy className="h-3 w-3 text-muted-foreground" />
        </button>
      </div>
    )
  },
},
```

3. Add tags column before status column:
```typescript
{
  accessorKey: 'tags',
  header: 'Tags',
  cell: ({ row }) => {
    const tags = row.original.tags || []
    return <TagList tags={tags} className="max-w-[200px]" />
  },
  filterFn: (row, _id, filterValue: string[]) => {
    if (!filterValue || filterValue.length === 0) return true
    const tags = row.original.tags || []
    // OR filter: show if customer has ANY selected tag
    return filterValue.some(tag => tags.includes(tag))
  },
},
```

4. Add group class to table row for hover effect:
Make sure row wrapper has `className="group"` for the copy button hover state.
  </action>
  <verify>
customer-columns.tsx has:
- Phone column with formatPhoneDisplay and copy button
- Email-only badge for missing phones
- Tags column with TagList component
- Tags filterFn using OR logic
  </verify>
  <done>Customer columns updated with phone (formatted + copy) and tags (badges + filter) columns</done>
</task>

<task type="auto">
  <name>Task 3: Add tag filter UI and wire to table</name>
  <files>
components/customers/customer-filters.tsx
components/customers/customers-client.tsx
  </files>
  <action>
**Part A: Update customer-filters.tsx to add tag filtering UI:**

1. Add imports:
```typescript
import { useState } from 'react'
import { TagBadge, PRESET_TAGS } from '@/components/ui/tag-badge'
```

2. Add tag filter section:
```typescript
interface CustomerFiltersProps {
  // existing props
  onTagFilterChange?: (tags: string[]) => void
  selectedTags?: string[]
  availableTags?: string[]  // All tags used in business
}

export function CustomerFilters({
  // existing props
  onTagFilterChange,
  selectedTags = [],
  availableTags = [],
}: CustomerFiltersProps) {
  // Combine preset tags with custom tags from business
  const allTags = [...new Set([...PRESET_TAGS, ...availableTags])]

  const toggleTag = (tag: string) => {
    const newTags = selectedTags.includes(tag)
      ? selectedTags.filter(t => t !== tag)
      : [...selectedTags, tag]
    onTagFilterChange?.(newTags)
  }

  return (
    <div className="flex flex-col gap-4">
      {/* existing filters */}

      {/* Tag filter section */}
      <div className="flex flex-wrap items-center gap-2">
        <span className="text-sm text-muted-foreground">Filter by tag:</span>
        {allTags.map(tag => (
          <TagBadge
            key={tag}
            tag={tag}
            onClick={() => toggleTag(tag)}
            selected={selectedTags.includes(tag)}
          />
        ))}
        {selectedTags.length > 0 && (
          <button
            onClick={() => onTagFilterChange?.([])}
            className="text-xs text-muted-foreground hover:text-foreground underline"
          >
            Clear
          </button>
        )}
      </div>
    </div>
  )
}
```

**Part B: Update customers-client.tsx to wire tag filter state to table column filter:**

1. Add state for selectedTags:
```typescript
const [selectedTags, setSelectedTags] = useState<string[]>([])
```

2. Compute available tags from customers:
```typescript
const availableTags = useMemo(() => {
  const tagSet = new Set<string>()
  customers.forEach(c => (c.tags || []).forEach(t => tagSet.add(t)))
  return Array.from(tagSet)
}, [customers])
```

3. **CRITICAL: Wire selectedTags to TanStack Table column filter.**
When selectedTags changes, apply filter to the tags column:
```typescript
// Effect to sync selectedTags state with table column filter
useEffect(() => {
  // Get the tags column from the table instance
  const tagsColumn = table.getColumn('tags')
  if (tagsColumn) {
    // Set the column's filter value to the selectedTags array
    // This triggers the filterFn defined in customer-columns.tsx
    tagsColumn.setFilterValue(selectedTags.length > 0 ? selectedTags : undefined)
  }
}, [selectedTags, table])
```

4. Pass props to CustomerFilters:
```typescript
<CustomerFilters
  // existing props
  onTagFilterChange={setSelectedTags}
  selectedTags={selectedTags}
  availableTags={availableTags}
/>
```

5. Ensure table instance is accessible. If using useReactTable:
```typescript
const table = useReactTable({
  data: customers,
  columns,
  getCoreRowModel: getCoreRowModel(),
  getFilteredRowModel: getFilteredRowModel(), // Required for column filtering
  // ... other options
})
```

The flow is:
1. User clicks tag chip in CustomerFilters
2. toggleTag calls onTagFilterChange(newTags)
3. setSelectedTags updates selectedTags state
4. useEffect fires, calls table.getColumn('tags')?.setFilterValue(selectedTags)
5. TanStack Table re-filters rows using filterFn from customer-columns.tsx
6. Table renders only matching customers
  </action>
  <verify>
- CustomerFilters shows tag filter chips
- Clicking tag toggles selection (visually highlighted)
- Selected tags highlighted with selected={true} styling
- Clear button resets filter
- customers-client.tsx has selectedTags state
- customers-client.tsx has useEffect that calls table.getColumn('tags')?.setFilterValue(selectedTags)
- Clicking a tag chip actually filters the table to show only matching customers
  </verify>
  <done>Tag filter UI added with multi-select OR filtering, properly wired to TanStack Table column filter</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. Tag badge component renders correctly
4. Phone column shows formatted number with copy button
5. Email-only badge shown for customers without phone
6. Tags column shows tag badges
7. Tag filter chips work with multi-select
8. Clicking a tag chip filters the customer table to show only customers with that tag
</verification>

<success_criteria>
- [ ] components/ui/tag-badge.tsx exports TagBadge, TagList, PRESET_TAGS
- [ ] Customer table has phone column with (512) 555-1234 formatting
- [ ] Phone column has copy icon that copies E.164 to clipboard with toast
- [ ] Customers without phone show "Email-only" badge
- [ ] Customer table has tags column with TagList badges
- [ ] Tag filter UI shows preset tags + custom tags from business
- [ ] Tag filter uses OR logic (any selected tag matches)
- [ ] Clear button resets tag filter
- [ ] customers-client.tsx has useEffect with table.getColumn('tags')?.setFilterValue(selectedTags)
- [ ] Clicking tag chip filters table to show only tagged customers
- [ ] `pnpm typecheck` passes
- [ ] `pnpm lint` passes
</success_criteria>

<output>
After completion, create `.planning/phases/20-database-migration-customer-enhancement/20-05-SUMMARY.md`
</output>
