---
phase: 20-database-migration-customer-enhancement
plan: 07
type: execute
wave: 3
depends_on: ["20-04"]
files_modified:
  - components/customers/customer-detail-drawer.tsx
  - components/customers/sms-consent-form.tsx
  - components/customers/add-customer-sheet.tsx
  - components/customers/edit-customer-sheet.tsx
autonomous: true

must_haves:
  truths:
    - "Customer form has SMS consent checkbox with helper text"
    - "'Add details' expandable shows consent method dropdown and notes"
    - "Customer drawer shows 'SMS: Consent needed' badge for unknown status"
    - "Customer drawer has 'Mark as consented' action button"
    - "Timezone captured from browser Intl API on customer creation"
  artifacts:
    - path: "components/customers/sms-consent-form.tsx"
      provides: "SMS consent capture form with audit trail fields"
      exports: ["SmsConsentForm"]
    - path: "components/customers/customer-detail-drawer.tsx"
      provides: "Customer drawer with consent badge and action"
      contains: "sms_consent_status"
  key_links:
    - from: "components/customers/sms-consent-form.tsx"
      to: "lib/actions/customer.ts"
      via: "updateCustomerSmsConsent action"
      pattern: "updateCustomerSmsConsent"
---

<objective>
Add SMS consent UI: checkbox with helper text on customer forms, expandable audit trail fields, consent status badge in drawer, and "Mark as consented" action. Capture timezone from browser on creation.

Purpose: SMS-03 (TCPA opt-in tracking), COMP-01 (consent audit trail), timezone for Phase 21 quiet hours
Output: SMS consent capture UI with full audit trail support
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-database-migration-customer-enhancement/20-CONTEXT.md
@components/contacts/contact-detail-drawer.tsx
@components/contacts/add-contact-sheet.tsx
@lib/actions/customer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SMS consent form component</name>
  <files>components/customers/sms-consent-form.tsx</files>
  <action>
Create a reusable SMS consent form component:

```typescript
'use client'

import { useState } from 'react'
import { Checkbox } from '@/components/ui/checkbox'
import { Button } from '@/components/ui/button'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { updateCustomerSmsConsent } from '@/lib/actions/customer'
import { toast } from 'sonner'
import { CaretDown, CaretUp, Info } from '@phosphor-icons/react'

interface SmsConsentFormProps {
  customerId?: string  // For existing customers
  initialConsented?: boolean
  onConsentChange?: (consented: boolean, method?: string, notes?: string) => void
  mode?: 'inline' | 'standalone'  // inline for forms, standalone for drawer
}

const CONSENT_METHODS = [
  { value: 'verbal_in_person', label: 'Verbal (in-person)' },
  { value: 'phone_call', label: 'Phone call' },
  { value: 'service_agreement', label: 'Service agreement' },
  { value: 'website_form', label: 'Website form' },
  { value: 'other', label: 'Other' },
]

export function SmsConsentForm({
  customerId,
  initialConsented = false,
  onConsentChange,
  mode = 'inline',
}: SmsConsentFormProps) {
  const [consented, setConsented] = useState(initialConsented)
  const [showDetails, setShowDetails] = useState(false)
  const [method, setMethod] = useState<string>('')
  const [notes, setNotes] = useState('')
  const [saving, setSaving] = useState(false)

  const handleConsentChange = (checked: boolean) => {
    setConsented(checked)
    if (!checked) {
      setShowDetails(false)
      setMethod('')
      setNotes('')
    }
    onConsentChange?.(checked, method, notes)
  }

  const handleSave = async () => {
    if (!customerId) return

    setSaving(true)

    // Get client IP via API route (optional enhancement)
    let clientIp: string | undefined
    try {
      const ipRes = await fetch('/api/client-ip')
      const ipData = await ipRes.json()
      clientIp = ipData.ip
    } catch {
      // IP capture is optional, continue without
    }

    const result = await updateCustomerSmsConsent(customerId, {
      status: consented ? 'opted_in' : 'opted_out',
      method: method || undefined,
      notes: notes || undefined,
      ip: clientIp,
    })

    setSaving(false)

    if (result.error) {
      toast.error(result.error)
    } else {
      toast.success(consented ? 'SMS consent recorded' : 'SMS opt-out recorded')
    }
  }

  return (
    <div className="space-y-3">
      <div className="flex items-start space-x-3">
        <Checkbox
          id="sms-consent"
          checked={consented}
          onCheckedChange={handleConsentChange}
        />
        <div className="space-y-1">
          <Label htmlFor="sms-consent" className="font-medium cursor-pointer">
            Customer consented to receive texts (SMS)
          </Label>
          <p className="text-sm text-muted-foreground">
            Required for SMS follow-ups
          </p>
        </div>
      </div>

      {consented && (
        <div className="pl-6">
          <button
            type="button"
            onClick={() => setShowDetails(!showDetails)}
            className="flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground"
          >
            {showDetails ? <CaretUp className="h-4 w-4" /> : <CaretDown className="h-4 w-4" />}
            {showDetails ? 'Hide' : 'Add'} consent details
          </button>
        </div>
      )}

      {showDetails && consented && (
        <div className="pl-6 space-y-4 border-l-2 border-muted ml-2">
          <div className="space-y-2">
            <Label>Consent method</Label>
            <Select value={method} onValueChange={setMethod}>
              <SelectTrigger className="w-full">
                <SelectValue placeholder="How was consent given?" />
              </SelectTrigger>
              <SelectContent>
                {CONSENT_METHODS.map(m => (
                  <SelectItem key={m.value} value={m.value}>
                    {m.label}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div className="space-y-2">
            <Label>Notes (optional)</Label>
            <Textarea
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              placeholder="Additional context about consent..."
              rows={2}
            />
          </div>

          <div className="p-3 bg-muted/50 rounded-lg text-sm text-muted-foreground">
            <div className="flex items-start gap-2">
              <Info className="h-4 w-4 mt-0.5 flex-shrink-0" />
              <div>
                <strong className="text-foreground">TCPA Compliance:</strong> This information
                creates a legal audit trail. Consent must be explicitly given by the
                customer. Date, time, and capture method are recorded automatically.
              </div>
            </div>
          </div>
        </div>
      )}

      {mode === 'standalone' && customerId && (
        <div className="pt-2">
          <Button
            onClick={handleSave}
            disabled={saving}
            size="sm"
          >
            {saving ? 'Saving...' : 'Save consent status'}
          </Button>
        </div>
      )}
    </div>
  )
}
```
  </action>
  <verify>
- SmsConsentForm component renders checkbox and helper text
- "Add details" expands to show method dropdown and notes
- Compliance info box shows in expanded state
- standalone mode shows Save button
  </verify>
  <done>SMS consent form created with checkbox, expandable audit trail fields, and compliance info</done>
</task>

<task type="auto">
  <name>Task 2: Update customer detail drawer with consent badge</name>
  <files>components/customers/customer-detail-drawer.tsx</files>
  <action>
Update customer-detail-drawer.tsx to show SMS consent status and action:

1. Add consent status badge in customer info section:
```typescript
import { SmsConsentForm } from './sms-consent-form'
import { Warning, CheckCircle, Question } from '@phosphor-icons/react'

// In the drawer content, add SMS consent section:
<div className="space-y-4">
  {/* Existing customer info */}

  {/* SMS Consent Status */}
  <div className="border-t pt-4">
    <h4 className="text-sm font-medium mb-2">SMS Consent</h4>

    {customer.sms_consent_status === 'opted_in' && (
      <div className="flex items-center gap-2 text-sm text-green-600 dark:text-green-400">
        <CheckCircle className="h-4 w-4" />
        <span>Consented</span>
        {customer.sms_consent_at && (
          <span className="text-muted-foreground">
            ({new Date(customer.sms_consent_at).toLocaleDateString()})
          </span>
        )}
      </div>
    )}

    {customer.sms_consent_status === 'opted_out' && (
      <div className="flex items-center gap-2 text-sm text-red-600 dark:text-red-400">
        <Warning className="h-4 w-4" />
        <span>Opted out</span>
      </div>
    )}

    {customer.sms_consent_status === 'unknown' && (
      <div className="space-y-3">
        <div className="flex items-center gap-2 text-sm text-amber-600 dark:text-amber-400">
          <Question className="h-4 w-4" />
          <span>SMS: Consent needed</span>
        </div>
        <SmsConsentForm
          customerId={customer.id}
          mode="standalone"
        />
      </div>
    )}

    {/* Show consent details if available */}
    {customer.sms_consent_status === 'opted_in' && customer.sms_consent_method && (
      <div className="mt-2 text-xs text-muted-foreground">
        <p>Method: {formatConsentMethod(customer.sms_consent_method)}</p>
        {customer.sms_consent_notes && <p>Notes: {customer.sms_consent_notes}</p>}
      </div>
    )}
  </div>
</div>

// Helper function:
function formatConsentMethod(method: string): string {
  const map: Record<string, string> = {
    verbal_in_person: 'Verbal (in-person)',
    phone_call: 'Phone call',
    service_agreement: 'Service agreement',
    website_form: 'Website form',
    other: 'Other',
  }
  return map[method] || method
}
```

2. Also add phone display with copy in drawer if not already:
```typescript
{customer.phone && customer.phone_status === 'valid' && (
  <div className="flex items-center gap-2">
    <span className="text-sm font-mono">{formatPhoneDisplay(customer.phone)}</span>
    <button
      onClick={() => {
        navigator.clipboard.writeText(customer.phone!)
        toast.success('Phone copied')
      }}
      className="p-1 hover:bg-muted rounded"
    >
      <Copy className="h-4 w-4 text-muted-foreground" />
    </button>
  </div>
)}
```
  </action>
  <verify>
- Drawer shows "Consented" badge with green icon for opted_in
- Drawer shows "Opted out" badge with red icon for opted_out
- Drawer shows "SMS: Consent needed" amber badge for unknown
- SmsConsentForm appears for unknown status
- Phone shown with copy button in drawer
  </verify>
  <done>Customer drawer updated with SMS consent status display and capture form</done>
</task>

<task type="auto">
  <name>Task 3: Update customer forms with SMS consent and timezone</name>
  <files>
components/customers/add-customer-sheet.tsx
components/customers/edit-customer-sheet.tsx
  </files>
  <action>
1. Update add-customer-sheet.tsx:

Add timezone detection and SMS consent section:
```typescript
'use client'

import { useEffect, useState } from 'react'
import { SmsConsentForm } from './sms-consent-form'

export function AddCustomerSheet({ ... }) {
  const [timezone, setTimezone] = useState('America/New_York')
  const [smsConsent, setSmsConsent] = useState({
    consented: false,
    method: '',
    notes: '',
  })

  // Detect timezone on mount
  useEffect(() => {
    try {
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone
      if (tz && tz.includes('/')) {
        setTimezone(tz)
      }
    } catch {
      // Use default
    }
  }, [])

  // In the form, add hidden timezone input:
  <input type="hidden" name="timezone" value={timezone} />

  // Add SMS consent section after phone field:
  <div className="space-y-2">
    <SmsConsentForm
      mode="inline"
      onConsentChange={(consented, method, notes) => {
        setSmsConsent({ consented, method: method || '', notes: notes || '' })
      }}
    />
  </div>

  // Add hidden inputs for consent data:
  <input type="hidden" name="smsConsented" value={smsConsent.consented ? 'true' : 'false'} />
  <input type="hidden" name="smsConsentMethod" value={smsConsent.method} />
  <input type="hidden" name="smsConsentNotes" value={smsConsent.notes} />
}
```

2. Update createCustomer action to handle new fields:
```typescript
// In lib/actions/customer.ts createCustomer function:

const timezone = formData.get('timezone') as string || 'America/New_York'
const smsConsented = formData.get('smsConsented') === 'true'
const smsConsentMethod = formData.get('smsConsentMethod') as string || null
const smsConsentNotes = formData.get('smsConsentNotes') as string || null

// In the insert:
{
  business_id: business.id,
  name,
  email: normalizedEmail,
  phone: phoneE164 || null,
  phone_status: phoneResult.status,
  timezone,
  tags: [],
  sms_consent_status: smsConsented ? 'opted_in' : 'unknown',
  sms_consent_at: smsConsented ? new Date().toISOString() : null,
  sms_consent_source: smsConsented ? 'manual' : null,
  sms_consent_method: smsConsented ? smsConsentMethod : null,
  sms_consent_notes: smsConsented ? smsConsentNotes : null,
  sms_consent_captured_by: smsConsented ? user.id : null,
  status: 'active',
  send_count: 0,
}
```

3. Update edit-customer-sheet.tsx similarly:
- Show current SMS consent status (read-only display)
- Don't allow changing consent status in edit form (use drawer for that)
- Do show phone and allow editing (with validation)
  </action>
  <verify>
- Add customer form captures timezone from browser
- Add customer form has SMS consent checkbox with expandable details
- Consent data passed to createCustomer action
- createCustomer saves all consent fields when consented
- Edit form shows current consent status (read-only)
  </verify>
  <done>Customer forms updated with timezone capture and SMS consent fields</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. SmsConsentForm renders correctly in add form and drawer
4. Consent checkbox expands to show method/notes fields
5. Customer drawer shows consent status badge
6. Timezone captured from browser on customer creation
</verification>

<success_criteria>
- [ ] SmsConsentForm component with checkbox, expandable details, compliance info
- [ ] Customer drawer shows "Consented" (green), "Opted out" (red), or "SMS: Consent needed" (amber) badges
- [ ] Customer drawer has inline SmsConsentForm for unknown status
- [ ] Add customer form captures timezone from Intl API
- [ ] Add customer form has SMS consent section
- [ ] createCustomer saves timezone, sms_consent_* fields
- [ ] Edit customer form shows consent status (read-only)
- [ ] `pnpm typecheck` passes
- [ ] `pnpm lint` passes
</success_criteria>

<output>
After completion, create `.planning/phases/20-database-migration-customer-enhancement/20-07-SUMMARY.md`
</output>
