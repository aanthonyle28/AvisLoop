---
phase: 20-database-migration-customer-enhancement
plan: 04
type: execute
wave: 2
depends_on: ["20-01", "20-02", "20-03"]
files_modified:
  - lib/types/database.ts
  - lib/actions/customer.ts
  - app/(dashboard)/customers/page.tsx
  - app/(dashboard)/customers/loading.tsx
  - app/(dashboard)/contacts/page.tsx
  - components/customers/*
  - middleware.ts
autonomous: true

must_haves:
  truths:
    - "All TypeScript files use 'customer' terminology (not 'contact')"
    - "/customers route displays customer list"
    - "/contacts route redirects to /customers with 301"
    - "Customer type in database.ts includes new fields (tags, phone_status, sms_consent_*)"
  artifacts:
    - path: "lib/types/database.ts"
      provides: "Customer type with all new fields"
      contains: "interface Customer"
    - path: "lib/actions/customer.ts"
      provides: "Customer server actions"
      exports: ["createCustomer", "updateCustomer", "getCustomers"]
    - path: "app/(dashboard)/customers/page.tsx"
      provides: "Customers list page"
      contains: "CustomersClient"
  key_links:
    - from: "app/(dashboard)/customers/page.tsx"
      to: "lib/actions/customer.ts"
      via: "import getCustomers"
      pattern: "import.*getCustomers.*from.*customer"
    - from: "app/(dashboard)/contacts/page.tsx"
      to: "/customers"
      via: "redirect"
      pattern: "redirect.*customers"
---

<objective>
Rename all "contact" references to "customer" throughout the codebase: types, actions, components, routes, and middleware. Add 301 redirect from /contacts to /customers.

Purpose: Complete CUST-01 - full terminology migration from Contacts to Customers
Output: All TypeScript/React code uses "customer" terminology, /contacts redirects to /customers
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-database-migration-customer-enhancement/20-CONTEXT.md
@lib/types/database.ts
@lib/actions/contact.ts
@app/(dashboard)/contacts/page.tsx
@middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update database types</name>
  <files>lib/types/database.ts</files>
  <action>
Update lib/types/database.ts:

1. Rename Contact interface to Customer and add new fields:
```typescript
export interface Customer {
  id: string
  business_id: string
  name: string
  email: string
  phone: string | null
  phone_status: 'valid' | 'invalid' | 'missing'
  tags: string[]
  status: 'active' | 'archived'
  opted_out: boolean
  notes?: string
  timezone: string | null
  sms_consent_status: 'opted_in' | 'opted_out' | 'unknown'
  sms_consent_at: string | null
  sms_consent_source: string | null
  sms_consent_method: 'verbal_in_person' | 'phone_call' | 'service_agreement' | 'website_form' | 'other' | null
  sms_consent_notes: string | null
  sms_consent_ip: string | null
  sms_consent_captured_by: string | null
  last_sent_at: string | null
  send_count: number
  created_at: string
  updated_at: string
}

export type CustomerInsert = Omit<Customer, 'id' | 'created_at' | 'updated_at' | 'last_sent_at' | 'send_count'>
export type CustomerUpdate = Partial<Omit<Customer, 'id' | 'business_id' | 'created_at' | 'updated_at'>>
```

2. Update SendLog interface to use customer_id:
```typescript
export interface SendLog {
  // ... existing fields
  customer_id: string  // renamed from contact_id
}
```

3. Update SendLogWithContact to SendLogWithCustomer:
```typescript
export interface SendLogWithCustomer extends SendLog {
  customers: Pick<Customer, 'name' | 'email'>
}
```

4. Keep Contact as a type alias for backward compatibility during transition:
```typescript
/** @deprecated Use Customer instead */
export type Contact = Customer
```
  </action>
  <verify>lib/types/database.ts contains Customer interface with all new fields, SendLog.customer_id, SendLogWithCustomer</verify>
  <done>Database types updated with Customer interface including tags, phone_status, SMS consent fields, timezone</done>
</task>

<task type="auto">
  <name>Task 2: Rename contact actions to customer actions</name>
  <files>lib/actions/customer.ts</files>
  <action>
Copy lib/actions/contact.ts to lib/actions/customer.ts and make these changes:

1. Update all imports:
   - `import { contactSchema }` -> `import { customerSchema }` from `@/lib/validations/customer`
   - `import type { Contact }` -> `import type { Customer }` from `@/lib/types/database`

2. Rename all functions:
   - findOrCreateContact -> findOrCreateCustomer
   - createContact -> createCustomer
   - updateContact -> updateCustomer
   - archiveContact -> archiveCustomer
   - restoreContact -> restoreCustomer
   - deleteContact -> deleteCustomer
   - bulkArchiveContacts -> bulkArchiveCustomers
   - bulkDeleteContacts -> bulkDeleteCustomers
   - bulkCreateContacts -> bulkCreateCustomers
   - getContacts -> getCustomers
   - updateContactNotes -> updateCustomerNotes
   - searchContacts -> searchCustomers

3. Update all type names:
   - ContactActionState -> CustomerActionState
   - BulkCreateResult stays the same (generic name)

4. Update all table references:
   - `.from('contacts')` -> `.from('customers')`

5. Update revalidatePath calls:
   - `'/dashboard/contacts'` -> `'/customers'`

6. Update error messages to say "customer" instead of "contact"

7. Add new function for updating SMS consent:
```typescript
export async function updateCustomerSmsConsent(
  customerId: string,
  consent: {
    status: 'opted_in' | 'opted_out'
    method?: string
    notes?: string
    ip?: string
  }
): Promise<CustomerActionState> {
  const supabase = await createClient()

  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    return { error: 'You must be logged in' }
  }

  const { error } = await supabase
    .from('customers')
    .update({
      sms_consent_status: consent.status,
      sms_consent_at: new Date().toISOString(),
      sms_consent_method: consent.method || null,
      sms_consent_notes: consent.notes || null,
      sms_consent_ip: consent.ip || null,
      sms_consent_captured_by: user.id,
      sms_consent_source: 'manual',
    })
    .eq('id', customerId)

  if (error) {
    return { error: error.message }
  }

  revalidatePath('/customers')
  return { success: true }
}
```

8. Add function for updating tags:
```typescript
export async function updateCustomerTags(
  customerId: string,
  tags: string[]
): Promise<CustomerActionState> {
  const supabase = await createClient()

  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    return { error: 'You must be logged in' }
  }

  if (tags.length > 5) {
    return { error: 'Maximum 5 tags allowed' }
  }

  const { error } = await supabase
    .from('customers')
    .update({ tags })
    .eq('id', customerId)

  if (error) {
    return { error: error.message }
  }

  revalidatePath('/customers')
  return { success: true }
}
```

Do NOT delete lib/actions/contact.ts yet - keep it as a re-export for transition:
```typescript
// lib/actions/contact.ts - DEPRECATED, re-exports from customer.ts
export * from './customer'
/** @deprecated Import from '@/lib/actions/customer' instead */
export { createCustomer as createContact } from './customer'
// etc.
```
  </action>
  <verify>
lib/actions/customer.ts exists with:
- All renamed functions (getCustomers, createCustomer, etc.)
- .from('customers') in all queries
- revalidatePath('/customers')
- updateCustomerSmsConsent and updateCustomerTags functions
  </verify>
  <done>Customer actions created with renamed functions, table references, and new SMS consent/tags functions</done>
</task>

<task type="auto">
  <name>Task 3: Rename components and update routes</name>
  <files>
components/customers/*
app/(dashboard)/customers/page.tsx
app/(dashboard)/customers/loading.tsx
app/(dashboard)/contacts/page.tsx
middleware.ts
  </files>
  <action>
1. Rename components/contacts/ directory to components/customers/:
   - contact-table.tsx -> customer-table.tsx
   - contact-columns.tsx -> customer-columns.tsx
   - contact-filters.tsx -> customer-filters.tsx
   - contact-detail-drawer.tsx -> customer-detail-drawer.tsx
   - add-contact-sheet.tsx -> add-customer-sheet.tsx
   - edit-contact-sheet.tsx -> edit-customer-sheet.tsx
   - csv-import-dialog.tsx -> stays same filename but update internal references
   - contacts-client.tsx -> customers-client.tsx

2. In each renamed file:
   - Update component names (ContactTable -> CustomerTable, etc.)
   - Update prop names (contact -> customer, contacts -> customers)
   - Update imports to use new paths and types
   - Update any "contact" text in UI to "customer"

3. Create app/(dashboard)/customers/ directory:
   - Copy page.tsx and loading.tsx from contacts/
   - Update imports to use components/customers/*
   - Update metadata title/description to "Customers"

4. Convert app/(dashboard)/contacts/page.tsx to redirect:
```typescript
import { redirect } from 'next/navigation'

export default function ContactsRedirect() {
  redirect('/customers')
}
```

5. Update middleware.ts:
   - Change `/contacts` to `/customers` in protectedPaths array
   - Keep both for now (middleware handles auth, redirect handles navigation)

6. Update any other files that import from contacts:
   - components/send/* - update contact references to customer
   - components/onboarding/steps/contact-step.tsx -> customer-step.tsx
   - Any other imports found via search
  </action>
  <verify>
- components/customers/ directory exists with renamed files
- app/(dashboard)/customers/page.tsx renders CustomersClient
- app/(dashboard)/contacts/page.tsx redirects to /customers
- middleware.ts protects /customers route
- `pnpm lint` passes
- `pnpm typecheck` passes
  </verify>
  <done>All components and routes renamed from contact to customer, /contacts redirects to /customers</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. Customer type in database.ts includes all new fields
4. lib/actions/customer.ts has all renamed functions
5. components/customers/ directory exists with all components
6. app/(dashboard)/customers/page.tsx exists
7. app/(dashboard)/contacts/page.tsx redirects
8. grep -r "contact" in lib/actions/ shows only deprecated re-exports
</verification>

<success_criteria>
- [ ] Customer interface in database.ts has tags, phone_status, sms_consent_*, timezone fields
- [ ] SendLog uses customer_id (not contact_id)
- [ ] lib/actions/customer.ts exports getCustomers, createCustomer, updateCustomer, etc.
- [ ] lib/actions/customer.ts has updateCustomerSmsConsent and updateCustomerTags
- [ ] components/customers/ directory with CustomerTable, CustomerColumns, etc.
- [ ] app/(dashboard)/customers/page.tsx renders customers list
- [ ] app/(dashboard)/contacts/page.tsx redirects to /customers
- [ ] middleware.ts protects /customers route
- [ ] `pnpm typecheck` passes
- [ ] `pnpm lint` passes
</success_criteria>

<output>
After completion, create `.planning/phases/20-database-migration-customer-enhancement/20-04-SUMMARY.md`
</output>
