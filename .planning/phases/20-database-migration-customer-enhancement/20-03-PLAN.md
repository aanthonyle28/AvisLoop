---
phase: 20-database-migration-customer-enhancement
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - lib/utils/phone.ts
  - lib/validations/customer.ts
autonomous: true

must_haves:
  truths:
    - "libphonenumber-js is installed as a dependency"
    - "parseAndValidatePhone() returns E.164 format for valid numbers"
    - "formatPhoneDisplay() returns (512) 555-1234 format for US numbers"
    - "Customer validation schema includes phone with E.164 validation"
  artifacts:
    - path: "lib/utils/phone.ts"
      provides: "Phone parsing, validation, and formatting utilities"
      exports: ["parseAndValidatePhone", "formatPhoneDisplay", "normalizePhone"]
    - path: "lib/validations/customer.ts"
      provides: "Customer form validation with E.164 phone validation"
      contains: "customerSchema"
  key_links:
    - from: "lib/validations/customer.ts"
      to: "lib/utils/phone.ts"
      via: "import for phone validation"
      pattern: "import.*from.*phone"
---

<objective>
Install libphonenumber-js library, create phone validation/formatting utilities, and create customer validation schema (renamed from contact.ts).

Purpose: E.164 phone validation and formatting (CUST-02), validation schema rename (CUST-01)
Output: Phone utilities and customer validation schema ready for use
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-database-migration-customer-enhancement/20-CONTEXT.md
@.planning/phases/20-database-migration-customer-enhancement/20-RESEARCH.md
@lib/validations/contact.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install libphonenumber-js</name>
  <files>package.json</files>
  <action>
Run: `pnpm add libphonenumber-js`

This adds libphonenumber-js to dependencies. It provides:
- E.164 validation and formatting
- Country-aware phone parsing
- 145KB bundle (vs 550KB for google-libphonenumber)
- TypeScript types included

Verify installation completes without errors.
  </action>
  <verify>Run `pnpm list libphonenumber-js` to confirm installation</verify>
  <done>libphonenumber-js appears in package.json dependencies and pnpm-lock.yaml</done>
</task>

<task type="auto">
  <name>Task 2: Create phone utilities</name>
  <files>lib/utils/phone.ts</files>
  <action>
Create lib/utils/phone.ts with the following utilities:

```typescript
import { parsePhoneNumber, isValidPhoneNumber, CountryCode } from 'libphonenumber-js'

export type PhoneParseResult = {
  valid: boolean
  e164?: string
  status: 'valid' | 'invalid' | 'missing'
  error?: string
}

/**
 * Parse and validate a phone number input.
 * Returns E.164 format (+15551234567) if valid.
 * Phone is optional - empty input returns { valid: true, status: 'missing' }
 */
export function parseAndValidatePhone(
  input: string | null | undefined,
  defaultCountry: CountryCode = 'US'
): PhoneParseResult {
  // Empty = optional field, valid but missing
  if (!input || input.trim() === '') {
    return { valid: true, status: 'missing' }
  }

  try {
    const phoneNumber = parsePhoneNumber(input, defaultCountry)

    if (!phoneNumber) {
      return { valid: false, status: 'invalid', error: 'Could not parse phone number' }
    }

    if (!phoneNumber.isValid()) {
      return { valid: false, status: 'invalid', error: 'Invalid phone number' }
    }

    return {
      valid: true,
      e164: phoneNumber.format('E.164'),
      status: 'valid'
    }
  } catch {
    return { valid: false, status: 'invalid', error: 'Invalid phone format' }
  }
}

/**
 * Normalize phone number to E.164 format.
 * Returns null if invalid or empty.
 */
export function normalizePhone(
  input: string | null | undefined,
  defaultCountry: CountryCode = 'US'
): string | null {
  const result = parseAndValidatePhone(input, defaultCountry)
  return result.e164 || null
}

/**
 * Format E.164 phone number for display.
 * Returns (512) 555-1234 for US numbers.
 * Returns +44 20 7946 0958 for international.
 */
export function formatPhoneDisplay(e164: string | null | undefined): string {
  if (!e164) return ''

  try {
    const phoneNumber = parsePhoneNumber(e164)
    if (!phoneNumber) return e164

    // US numbers: national format (512) 555-1234
    if (phoneNumber.country === 'US') {
      return phoneNumber.formatNational()
    }

    // International: +44 20 7946 0958
    return phoneNumber.formatInternational()
  } catch {
    return e164
  }
}

/**
 * Check if a phone number is valid for E.164.
 */
export function isValidE164(
  input: string | null | undefined,
  defaultCountry: CountryCode = 'US'
): boolean {
  if (!input) return false
  return isValidPhoneNumber(input, defaultCountry)
}
```
  </action>
  <verify>
Verify lib/utils/phone.ts:
- Imports from libphonenumber-js
- Exports parseAndValidatePhone, normalizePhone, formatPhoneDisplay, isValidE164
- PhoneParseResult type defined with valid, e164, status, error fields
  </verify>
  <done>Phone utilities created with E.164 validation, normalization, and display formatting</done>
</task>

<task type="auto">
  <name>Task 3: Create customer validation schema</name>
  <files>lib/validations/customer.ts</files>
  <action>
Create lib/validations/customer.ts (renamed from contact.ts pattern) with:

```typescript
import { z } from 'zod'
import { parseAndValidatePhone } from '@/lib/utils/phone'

/**
 * Validation schema for customer forms (add/edit).
 * Phone validation uses libphonenumber-js for E.164 compliance.
 */
export const customerSchema = z.object({
  name: z
    .string()
    .trim()
    .min(1, 'Name is required')
    .max(100, 'Name must be less than 100 characters'),
  email: z
    .string()
    .email('Invalid email address'),
  phone: z
    .string()
    .optional()
    .or(z.literal(''))
    .transform((val) => val || '')
    .refine((val) => {
      if (!val) return true // Optional field
      const result = parseAndValidatePhone(val)
      return result.valid
    }, 'Invalid phone number format'),
  timezone: z
    .string()
    .optional()
    .default('America/New_York'),
})

/**
 * Validation schema for CSV customer import (relaxed for batch processing).
 * Invalid phones don't fail validation - they're flagged for review.
 */
export const csvCustomerSchema = z.object({
  name: z
    .string()
    .trim()
    .min(1, 'Name is required')
    .max(100, 'Name must be less than 100 characters'),
  email: z
    .string()
    .email('Invalid email address'),
  phone: z
    .string()
    .optional(),
})

/**
 * Tag validation - max 5 tags, each max 50 chars.
 */
export const tagsSchema = z
  .array(z.string().trim().max(50, 'Tag must be under 50 characters'))
  .max(5, 'Maximum 5 tags allowed')

/**
 * SMS consent capture validation.
 */
export const smsConsentSchema = z.object({
  status: z.enum(['opted_in', 'opted_out']),
  method: z
    .enum(['verbal_in_person', 'phone_call', 'service_agreement', 'website_form', 'other'])
    .optional(),
  notes: z
    .string()
    .max(500, 'Notes must be under 500 characters')
    .optional(),
})

export type CustomerInput = z.infer<typeof customerSchema>
export type CSVCustomerInput = z.infer<typeof csvCustomerSchema>
export type TagsInput = z.infer<typeof tagsSchema>
export type SmsConsentInput = z.infer<typeof smsConsentSchema>
```
  </action>
  <verify>
Verify lib/validations/customer.ts:
- Imports parseAndValidatePhone from phone.ts
- Exports customerSchema, csvCustomerSchema, tagsSchema, smsConsentSchema
- customerSchema.phone uses refine() with parseAndValidatePhone
- Types exported: CustomerInput, CSVCustomerInput, TagsInput, SmsConsentInput
  </verify>
  <done>Customer validation schemas created with E.164 phone validation, tag validation, and SMS consent validation</done>
</task>

</tasks>

<verification>
1. pnpm list libphonenumber-js shows package installed
2. lib/utils/phone.ts exists with all exported functions
3. lib/validations/customer.ts exists with all schemas
4. TypeScript compiles without errors: `pnpm typecheck`
</verification>

<success_criteria>
- [ ] libphonenumber-js in package.json dependencies
- [ ] lib/utils/phone.ts exports parseAndValidatePhone, normalizePhone, formatPhoneDisplay, isValidE164
- [ ] Phone utilities handle empty input as valid (optional field)
- [ ] Phone utilities return 'invalid' status for unparseable numbers
- [ ] lib/validations/customer.ts exports customerSchema with phone validation
- [ ] lib/validations/customer.ts exports csvCustomerSchema, tagsSchema, smsConsentSchema
- [ ] `pnpm typecheck` passes
</success_criteria>

<output>
After completion, create `.planning/phases/20-database-migration-customer-enhancement/20-03-SUMMARY.md`
</output>
