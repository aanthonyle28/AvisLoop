---
phase: 20-database-migration-customer-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260202_rename_contacts_to_customers.sql
autonomous: true

must_haves:
  truths:
    - "Database table is named 'customers' (not 'contacts')"
    - "All RLS policies reference 'customers' table with correct naming"
    - "send_logs.customer_id FK references customers table"
    - "Compatibility view 'contacts' exists for rollback safety"
  artifacts:
    - path: "supabase/migrations/20260202_rename_contacts_to_customers.sql"
      provides: "Table rename migration with RLS policy updates"
      contains: "ALTER TABLE contacts RENAME TO customers"
  key_links:
    - from: "send_logs.customer_id"
      to: "customers.id"
      via: "foreign key constraint"
      pattern: "REFERENCES.*customers"
---

<objective>
Rename the contacts table to customers in PostgreSQL with atomic migration, update all foreign key references, rename RLS policies, and create a compatibility view for safety.

Purpose: Foundation for Customer terminology throughout v2.0 (CUST-01 partial - database layer)
Output: Single migration file that renames table, FK columns, indexes, and RLS policies
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-database-migration-customer-enhancement/20-CONTEXT.md
@.planning/phases/20-database-migration-customer-enhancement/20-RESEARCH.md
@supabase/migrations/00003_create_contacts.sql
@supabase/migrations/00005_create_send_logs.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create table rename migration</name>
  <files>supabase/migrations/20260202_rename_contacts_to_customers.sql</files>
  <action>
Create a new Supabase migration file that performs these operations in order:

1. Rename table: `ALTER TABLE contacts RENAME TO customers;`

2. Rename sequence: `ALTER SEQUENCE contacts_id_seq RENAME TO customers_id_seq;`

3. Rename constraints (all from 00003_create_contacts.sql):
   - contacts_name_not_empty -> customers_name_not_empty
   - contacts_email_not_empty -> customers_email_not_empty
   - contacts_status_valid -> customers_status_valid
   - contacts_unique_email_per_business -> customers_unique_email_per_business

4. Rename indexes:
   - idx_contacts_business_id -> idx_customers_business_id
   - idx_contacts_business_status -> idx_customers_business_status
   - idx_contacts_sendable -> idx_customers_sendable

5. Drop old RLS policies and create new ones with "customers" naming:
   - "Users view own customers" (SELECT)
   - "Users insert own customers" (INSERT)
   - "Users update own customers" (UPDATE)
   - "Users delete own customers" (DELETE)
   Use exact same USING/WITH CHECK clauses from original policies.

6. Rename FK column in send_logs:
   `ALTER TABLE send_logs RENAME COLUMN contact_id TO customer_id;`

7. Rename FK index:
   `ALTER INDEX idx_send_logs_contact_id RENAME TO idx_send_logs_customer_id;`

8. Create compatibility view for rollback safety:
   `CREATE VIEW contacts AS SELECT * FROM customers;`
   `GRANT ALL ON contacts TO authenticated;`

9. Rename trigger:
   `ALTER TRIGGER contacts_updated_at ON customers RENAME TO customers_updated_at;`

IMPORTANT: This is a single atomic migration. All statements run in one transaction.
  </action>
  <verify>
Verify migration file exists and contains:
- ALTER TABLE contacts RENAME TO customers
- All constraint renames
- All index renames
- DROP POLICY and CREATE POLICY statements
- ALTER TABLE send_logs RENAME COLUMN contact_id TO customer_id
- CREATE VIEW contacts AS SELECT * FROM customers
  </verify>
  <done>
Migration file exists at supabase/migrations/20260202_rename_contacts_to_customers.sql with all rename operations. Migration is ready for application via `supabase db reset` (local) or `supabase db push` (remote).
  </done>
</task>

<task type="auto">
  <name>Task 2: Document migration in DATA_MODEL.md</name>
  <files>docs/DATA_MODEL.md</files>
  <action>
If docs/DATA_MODEL.md exists, update it. If not, create it.

Add a section documenting the table rename:

```markdown
## Table: customers (renamed from contacts)

Stores customer information for each business. Renamed from `contacts` in migration 20260202.

### Schema
| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | UUID | NO | gen_random_uuid() | Primary key |
| business_id | UUID | NO | - | FK to businesses |
| name | TEXT | NO | - | Customer name |
| email | TEXT | NO | - | Email address |
| phone | TEXT | YES | - | Phone number |
| status | TEXT | NO | 'active' | 'active' or 'archived' |
| opted_out | BOOLEAN | NO | false | Email opt-out |
| notes | TEXT | YES | - | Internal notes |
| last_sent_at | TIMESTAMPTZ | YES | - | Last message sent |
| send_count | INTEGER | YES | 0 | Total sends |
| created_at | TIMESTAMPTZ | YES | NOW() | Created timestamp |
| updated_at | TIMESTAMPTZ | YES | NOW() | Updated timestamp |

### RLS Policies
- Users can only view/insert/update/delete customers for businesses they own
- Business ownership verified via subquery: `business_id IN (SELECT id FROM businesses WHERE user_id = auth.uid())`

### Indexes
- idx_customers_business_id (btree)
- idx_customers_business_status (btree on business_id, status)
- idx_customers_sendable (partial: status='active' AND opted_out=false)

### Foreign Keys
- send_logs.customer_id references customers.id

### Compatibility
- View `contacts` exists for backward compatibility during migration window
```
  </action>
  <verify>docs/DATA_MODEL.md exists and contains "customers (renamed from contacts)" section</verify>
  <done>DATA_MODEL.md documents the customers table schema, RLS policies, indexes, and compatibility view</done>
</task>

</tasks>

<verification>
1. Migration file exists at correct path
2. Migration contains all required operations (table rename, constraint renames, index renames, RLS policy recreation, FK column rename, compatibility view)
3. docs/DATA_MODEL.md updated with customers table documentation
</verification>

<success_criteria>
- [ ] Migration file supabase/migrations/20260202_rename_contacts_to_customers.sql exists
- [ ] Migration renames table, sequence, constraints, indexes, trigger
- [ ] Migration drops old RLS policies and creates new ones with "customers" naming
- [ ] Migration renames send_logs.contact_id to customer_id
- [ ] Migration creates compatibility view `contacts`
- [ ] docs/DATA_MODEL.md documents customers table
</success_criteria>

<output>
After completion, create `.planning/phases/20-database-migration-customer-enhancement/20-01-SUMMARY.md`
</output>
