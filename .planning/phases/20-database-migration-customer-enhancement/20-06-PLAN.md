---
phase: 20-database-migration-customer-enhancement
plan: 06
type: execute
wave: 3
depends_on: ["20-04"]
files_modified:
  - components/customers/csv-import-dialog.tsx
  - components/customers/phone-review-table.tsx
  - lib/actions/customer.ts
autonomous: true

must_haves:
  truths:
    - "CSV import parses phone numbers with best-effort E.164 conversion"
    - "Import results show counts: Imported / Phone needs review / Skipped"
    - "Review phone issues button appears when invalid phones exist"
    - "Fix-it table shows raw CSV value, suggested parse, edit field"
    - "Users can mark customers as email-only during review"
  artifacts:
    - path: "components/customers/csv-import-dialog.tsx"
      provides: "Enhanced CSV import with phone parsing"
      contains: "phoneStatus"
    - path: "components/customers/phone-review-table.tsx"
      provides: "Phone review/fix table"
      exports: ["PhoneReviewTable"]
  key_links:
    - from: "components/customers/csv-import-dialog.tsx"
      to: "lib/utils/phone.ts"
      via: "import for phone parsing"
      pattern: "parseAndValidatePhone"
    - from: "components/customers/csv-import-dialog.tsx"
      to: "components/customers/phone-review-table.tsx"
      via: "import and render PhoneReviewTable"
      pattern: "import.*PhoneReviewTable"
---

<objective>
Enhance CSV import to parse phone numbers with libphonenumber-js, track phone_status per row, show import results with review queue, and provide a fix-it table for invalid phones.

Purpose: CUST-02 partial - phone number import handling per CONTEXT.md decisions
Output: CSV import with phone parsing, results summary, and phone review workflow
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-database-migration-customer-enhancement/20-CONTEXT.md
@.planning/phases/20-database-migration-customer-enhancement/20-RESEARCH.md
@components/contacts/csv-import-dialog.tsx
@lib/utils/phone.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CSV import dialog with phone parsing and PhoneReviewTable integration</name>
  <files>components/customers/csv-import-dialog.tsx</files>
  <action>
Update the CSV import dialog to parse phone numbers and integrate PhoneReviewTable:

1. Add imports:
```typescript
import { parseAndValidatePhone, PhoneParseResult } from '@/lib/utils/phone'
import { PhoneReviewTable } from '@/components/customers/phone-review-table'
```

2. Add state for phone review UI:
```typescript
const [showPhoneReview, setShowPhoneReview] = useState(false)
```

3. Update ParsedRow interface:
```typescript
interface ParsedRow {
  name: string
  email: string
  phone: string | null        // Raw CSV value
  phoneE164: string | null    // Parsed E.164 (null if invalid)
  phoneStatus: 'valid' | 'invalid' | 'missing'
  isValid: boolean
  isDuplicate: boolean
  errors: string[]
}
```

4. Update row parsing logic to include phone validation:
```typescript
function parseRow(row: Record<string, string>, existingEmails: Set<string>): ParsedRow {
  const rawPhone = row.phone || row.Phone || row.phone_number || row['Phone Number'] || ''

  // Parse phone with libphonenumber-js
  const phoneResult = parseAndValidatePhone(rawPhone)

  return {
    name: row.name || row.Name || '',
    email: (row.email || row.Email || '').toLowerCase(),
    phone: rawPhone || null,
    phoneE164: phoneResult.e164 || null,
    phoneStatus: phoneResult.status,
    // ... rest of validation
  }
}
```

5. Update import results state:
```typescript
interface ImportResults {
  imported: number
  skipped: number      // Validation failures
  duplicates: number   // Email duplicates
  phoneNeedsReview: number  // NEW: invalid phone count
  customersWithPhoneIssues: Array<{
    id: string
    name: string
    email: string
    rawPhone: string
    phoneStatus: 'invalid'
  }>
}
```

6. Update import summary UI to show phone review button and conditionally render PhoneReviewTable:
```tsx
{results.phoneNeedsReview > 0 && !showPhoneReview && (
  <div className="p-4 bg-amber-50 dark:bg-amber-950 rounded-lg">
    <div className="flex items-center justify-between">
      <div>
        <p className="font-medium text-amber-700 dark:text-amber-300">
          {results.phoneNeedsReview} phone numbers need review
        </p>
        <p className="text-sm text-amber-600 dark:text-amber-400">
          These customers were imported but have invalid phone formats
        </p>
      </div>
      <Button
        variant="outline"
        onClick={() => setShowPhoneReview(true)}
      >
        Review phone issues
      </Button>
    </div>
  </div>
)}

{/* Render PhoneReviewTable when user clicks "Review phone issues" */}
{showPhoneReview && results.customersWithPhoneIssues.length > 0 && (
  <PhoneReviewTable
    issues={results.customersWithPhoneIssues}
    onComplete={() => {
      setShowPhoneReview(false)
      // Optionally refresh the customers list or close dialog
    }}
  />
)}
```

7. Store phone_status when inserting customers:
```typescript
// In bulkCreateCustomers or equivalent
{
  name: parsed.name,
  email: parsed.email,
  phone: parsed.phoneE164,  // Store E.164 or null
  phone_status: parsed.phoneStatus,
  // ...
}
```

8. After successful import, populate customersWithPhoneIssues from the response:
```typescript
// After bulkCreateCustomers returns, check for phone issues
const customersWithPhoneIssues = importedCustomers
  .filter(c => c.phone_status === 'invalid')
  .map(c => ({
    id: c.id,
    name: c.name,
    email: c.email,
    rawPhone: c.phone || '', // Original raw value
    phoneStatus: 'invalid' as const
  }))

setResults({
  imported: importedCount,
  skipped: skippedCount,
  duplicates: duplicateCount,
  phoneNeedsReview: customersWithPhoneIssues.length,
  customersWithPhoneIssues
})
```
  </action>
  <verify>
- CSV import parses phone column
- Invalid phones don't fail import (best-effort)
- Import results show phoneNeedsReview count
- "Review phone issues" button appears when needed
- Clicking button renders PhoneReviewTable with issues array
- PhoneReviewTable receives correct props (issues, onComplete)
  </verify>
  <done>CSV import enhanced with phone parsing, phone_status tracking, review prompt, and PhoneReviewTable integration</done>
</task>

<task type="auto">
  <name>Task 2: Create phone review table component</name>
  <files>components/customers/phone-review-table.tsx</files>
  <action>
Create a new component for reviewing and fixing phone issues:

```typescript
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { parseAndValidatePhone, formatPhoneDisplay } from '@/lib/utils/phone'
import { updateCustomerPhone, markCustomerEmailOnly } from '@/lib/actions/customer'
import { toast } from 'sonner'
import { Check, X, Envelope } from '@phosphor-icons/react'

interface PhoneIssue {
  id: string
  name: string
  email: string
  rawPhone: string
  suggestedParse?: string
}

interface PhoneReviewTableProps {
  issues: PhoneIssue[]
  onComplete: () => void
}

export function PhoneReviewTable({ issues, onComplete }: PhoneReviewTableProps) {
  const [editedPhones, setEditedPhones] = useState<Record<string, string>>(() => {
    // Initialize with raw values
    const initial: Record<string, string> = {}
    issues.forEach(issue => {
      initial[issue.id] = issue.rawPhone
    })
    return initial
  })

  const [processing, setProcessing] = useState<string | null>(null)
  const [resolved, setResolved] = useState<Set<string>>(new Set())

  const handleSavePhone = async (customerId: string) => {
    const phone = editedPhones[customerId]
    const result = parseAndValidatePhone(phone)

    if (!result.valid) {
      toast.error('Please enter a valid phone number or mark as email-only')
      return
    }

    setProcessing(customerId)

    const saveResult = await updateCustomerPhone(customerId, result.e164!, 'valid')

    if (saveResult.error) {
      toast.error(saveResult.error)
    } else {
      toast.success('Phone number saved')
      setResolved(prev => new Set(prev).add(customerId))
    }

    setProcessing(null)
  }

  const handleMarkEmailOnly = async (customerId: string) => {
    setProcessing(customerId)

    const result = await markCustomerEmailOnly(customerId)

    if (result.error) {
      toast.error(result.error)
    } else {
      toast.success('Marked as email-only')
      setResolved(prev => new Set(prev).add(customerId))
    }

    setProcessing(null)
  }

  const unresolvedCount = issues.length - resolved.size

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h3 className="font-medium">Review Phone Numbers</h3>
        <span className="text-sm text-muted-foreground">
          {unresolvedCount} remaining
        </span>
      </div>

      <div className="border rounded-lg overflow-hidden">
        <table className="w-full">
          <thead className="bg-muted/50">
            <tr>
              <th className="px-4 py-2 text-left text-sm font-medium">Customer</th>
              <th className="px-4 py-2 text-left text-sm font-medium">Original Value</th>
              <th className="px-4 py-2 text-left text-sm font-medium">Fix Phone</th>
              <th className="px-4 py-2 text-left text-sm font-medium">Actions</th>
            </tr>
          </thead>
          <tbody>
            {issues.map(issue => {
              const isResolved = resolved.has(issue.id)
              const isProcessing = processing === issue.id

              return (
                <tr
                  key={issue.id}
                  className={isResolved ? 'opacity-50 bg-muted/20' : ''}
                >
                  <td className="px-4 py-3">
                    <div>
                      <div className="font-medium">{issue.name}</div>
                      <div className="text-sm text-muted-foreground">{issue.email}</div>
                    </div>
                  </td>
                  <td className="px-4 py-3">
                    <code className="text-sm bg-muted px-1 py-0.5 rounded">
                      {issue.rawPhone}
                    </code>
                  </td>
                  <td className="px-4 py-3">
                    <Input
                      value={editedPhones[issue.id] || ''}
                      onChange={(e) => setEditedPhones(prev => ({
                        ...prev,
                        [issue.id]: e.target.value
                      }))}
                      placeholder="(555) 123-4567"
                      disabled={isResolved || isProcessing}
                      className="w-40"
                    />
                  </td>
                  <td className="px-4 py-3">
                    <div className="flex items-center gap-2">
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => handleSavePhone(issue.id)}
                        disabled={isResolved || isProcessing}
                      >
                        <Check className="h-4 w-4 mr-1" />
                        Save
                      </Button>
                      <Button
                        size="sm"
                        variant="ghost"
                        onClick={() => handleMarkEmailOnly(issue.id)}
                        disabled={isResolved || isProcessing}
                      >
                        <Envelope className="h-4 w-4 mr-1" />
                        Email-only
                      </Button>
                    </div>
                  </td>
                </tr>
              )
            })}
          </tbody>
        </table>
      </div>

      {unresolvedCount === 0 && (
        <div className="flex justify-end">
          <Button onClick={onComplete}>
            Done
          </Button>
        </div>
      )}
    </div>
  )
}
```
  </action>
  <verify>
- PhoneReviewTable component renders issues table
- Shows customer name, raw CSV value, editable phone field
- Save button validates and updates phone
- Email-only button marks customer as phone_status='missing'
- Resolved rows show dimmed
  </verify>
  <done>Phone review table created with inline editing, validation, and email-only option</done>
</task>

<task type="auto">
  <name>Task 3: Add phone update actions</name>
  <files>lib/actions/customer.ts</files>
  <action>
Add new server actions for phone management:

```typescript
/**
 * Update customer phone number with validation.
 */
export async function updateCustomerPhone(
  customerId: string,
  phoneE164: string,
  phoneStatus: 'valid' | 'invalid' | 'missing'
): Promise<CustomerActionState> {
  const supabase = await createClient()

  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    return { error: 'You must be logged in' }
  }

  const { error } = await supabase
    .from('customers')
    .update({
      phone: phoneE164,
      phone_status: phoneStatus,
    })
    .eq('id', customerId)

  if (error) {
    return { error: error.message }
  }

  revalidatePath('/customers')
  return { success: true }
}

/**
 * Mark customer as email-only (no phone).
 */
export async function markCustomerEmailOnly(
  customerId: string
): Promise<CustomerActionState> {
  const supabase = await createClient()

  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    return { error: 'You must be logged in' }
  }

  const { error } = await supabase
    .from('customers')
    .update({
      phone: null,
      phone_status: 'missing',
    })
    .eq('id', customerId)

  if (error) {
    return { error: error.message }
  }

  revalidatePath('/customers')
  return { success: true }
}

/**
 * Get customers with phone issues for review.
 */
export async function getCustomersWithPhoneIssues(): Promise<Array<{
  id: string
  name: string
  email: string
  rawPhone: string
}>> {
  const supabase = await createClient()

  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    return []
  }

  const { data: business } = await supabase
    .from('businesses')
    .select('id')
    .eq('user_id', user.id)
    .single()

  if (!business) {
    return []
  }

  const { data: customers } = await supabase
    .from('customers')
    .select('id, name, email, phone')
    .eq('business_id', business.id)
    .eq('phone_status', 'invalid')

  return (customers || []).map(c => ({
    id: c.id,
    name: c.name,
    email: c.email,
    rawPhone: c.phone || '',
  }))
}
```

Also update bulkCreateCustomers to include phone_status and timezone:

```typescript
// In bulkCreateCustomers, update insert to include new fields:
{
  business_id: business.id,
  name: c.name,
  email: c.email,
  phone: c.phoneE164 || null,
  phone_status: c.phoneStatus || 'missing',
  timezone: c.timezone || business.timezone || 'America/New_York',
  status: 'active',
  send_count: 0,
  tags: [],
  sms_consent_status: 'unknown',
  sms_consent_source: 'csv_import',
}
```
  </action>
  <verify>
- updateCustomerPhone action exists
- markCustomerEmailOnly action exists
- getCustomersWithPhoneIssues action exists
- bulkCreateCustomers includes phone_status, timezone, tags, sms_consent fields
  </verify>
  <done>Phone management actions added for review workflow</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. CSV import shows phone parse results
4. Invalid phones tracked with phone_status='invalid'
5. "Review phone issues" button opens PhoneReviewTable
6. Phone review table allows editing, saving, marking email-only
</verification>

<success_criteria>
- [ ] CSV import parses phone column using parseAndValidatePhone
- [ ] Import results show phoneNeedsReview count
- [ ] "Review phone issues" button appears when phoneNeedsReview > 0
- [ ] Clicking button renders PhoneReviewTable component with issues prop
- [ ] PhoneReviewTable shows raw value, edit field, save/email-only buttons
- [ ] updateCustomerPhone action validates and saves E.164 + status
- [ ] markCustomerEmailOnly action sets phone=null, phone_status='missing'
- [ ] bulkCreateCustomers sets phone_status, timezone, sms_consent_status
- [ ] `pnpm typecheck` passes
- [ ] `pnpm lint` passes
</success_criteria>

<output>
After completion, create `.planning/phases/20-database-migration-customer-enhancement/20-06-SUMMARY.md`
</output>
