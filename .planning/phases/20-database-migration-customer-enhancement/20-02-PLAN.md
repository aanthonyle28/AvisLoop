---
phase: 20-database-migration-customer-enhancement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260202_add_customer_fields.sql
autonomous: true

must_haves:
  truths:
    - "Customers table has tags column (JSONB array)"
    - "Customers table has phone_status column (valid/invalid/missing)"
    - "Customers table has SMS consent fields (status, at, source, method, notes, ip, captured_by)"
    - "Customers table has timezone column"
    - "Tags column has GIN index for fast filtering"
    - "SMS consent status defaults to 'unknown' for existing records"
  artifacts:
    - path: "supabase/migrations/20260202_add_customer_fields.sql"
      provides: "New columns for tags, phone tracking, SMS consent, timezone"
      contains: "ALTER TABLE customers ADD COLUMN tags"
  key_links:
    - from: "customers.sms_consent_captured_by"
      to: "auth.users.id"
      via: "foreign key reference"
      pattern: "REFERENCES auth.users"
---

<objective>
Add new schema fields to customers table: tags (JSONB), phone_status, SMS consent audit trail fields, and timezone. Create appropriate indexes and constraints.

Purpose: Enable tag filtering (CUST-03), phone status tracking (CUST-02), TCPA compliance (SMS-03, COMP-01), quiet hours (Phase 21 prep)
Output: Migration file adding all new columns with constraints and indexes
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-database-migration-customer-enhancement/20-CONTEXT.md
@.planning/phases/20-database-migration-customer-enhancement/20-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schema enhancement migration</name>
  <files>supabase/migrations/20260202_add_customer_fields.sql</files>
  <action>
Create a new Supabase migration file that adds the following columns to customers table:

**1. Tags (JSONB array for multi-tag support)**
```sql
ALTER TABLE customers ADD COLUMN tags JSONB DEFAULT '[]'::jsonb NOT NULL;
CREATE INDEX idx_customers_tags ON customers USING GIN (tags);
ALTER TABLE customers ADD CONSTRAINT customers_max_5_tags
  CHECK (jsonb_array_length(tags) <= 5);
```

**2. Phone status tracking**
```sql
ALTER TABLE customers ADD COLUMN phone_status TEXT
  DEFAULT 'missing'
  NOT NULL
  CHECK (phone_status IN ('valid', 'invalid', 'missing'));
```
Note: Existing records get 'missing' by default. App code will set 'valid' when E.164 validation passes.

**3. SMS consent audit trail fields (TCPA compliance)**
```sql
ALTER TABLE customers ADD COLUMN sms_consent_status TEXT
  DEFAULT 'unknown'
  NOT NULL
  CHECK (sms_consent_status IN ('opted_in', 'opted_out', 'unknown'));

ALTER TABLE customers ADD COLUMN sms_consent_at TIMESTAMPTZ;

ALTER TABLE customers ADD COLUMN sms_consent_source TEXT;

ALTER TABLE customers ADD COLUMN sms_consent_method TEXT
  CHECK (sms_consent_method IS NULL OR sms_consent_method IN (
    'verbal_in_person', 'phone_call', 'service_agreement', 'website_form', 'other'
  ));

ALTER TABLE customers ADD COLUMN sms_consent_notes TEXT;

ALTER TABLE customers ADD COLUMN sms_consent_ip INET;

ALTER TABLE customers ADD COLUMN sms_consent_captured_by UUID REFERENCES auth.users(id);

-- Index for filtering by consent status
CREATE INDEX idx_customers_sms_consent_status ON customers(sms_consent_status);
```

**4. Timezone support (for quiet hours compliance)**
```sql
ALTER TABLE customers ADD COLUMN timezone TEXT DEFAULT 'America/New_York';
```
Note: Default to US Eastern. Browser detection will provide actual timezone on creation.

**5. Update existing records for migration source**
```sql
UPDATE customers
SET sms_consent_source = 'migration'
WHERE sms_consent_status = 'unknown' AND sms_consent_source IS NULL;
```

Order migrations logically: columns first, then indexes, then data updates.
  </action>
  <verify>
Verify migration file contains:
- tags JSONB column with GIN index and max 5 constraint
- phone_status column with CHECK constraint
- All 7 sms_consent_* columns with appropriate types/constraints
- timezone column with default
- Index on sms_consent_status
- UPDATE statement to set sms_consent_source='migration'
  </verify>
  <done>
Migration file exists at supabase/migrations/20260202_add_customer_fields.sql with all new columns, indexes, and constraints for tags, phone tracking, SMS consent, and timezone.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update docs/DATA_MODEL.md with new fields</name>
  <files>docs/DATA_MODEL.md</files>
  <action>
Update the customers table documentation in docs/DATA_MODEL.md to include the new columns.

Add these rows to the Schema table (or create the full table if 20-01 hasn't run yet):

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| tags | JSONB | NO | '[]' | Array of tag strings, max 5 |
| phone_status | TEXT | NO | 'missing' | 'valid', 'invalid', or 'missing' |
| timezone | TEXT | YES | 'America/New_York' | IANA timezone for quiet hours |
| sms_consent_status | TEXT | NO | 'unknown' | 'opted_in', 'opted_out', 'unknown' |
| sms_consent_at | TIMESTAMPTZ | YES | - | When consent was recorded |
| sms_consent_source | TEXT | YES | - | How consent was obtained |
| sms_consent_method | TEXT | YES | - | Consent method enum |
| sms_consent_notes | TEXT | YES | - | Additional context |
| sms_consent_ip | INET | YES | - | IP address of consent capture |
| sms_consent_captured_by | UUID | YES | - | User who captured consent |

Add a new section:

```markdown
### SMS Consent Tracking (TCPA Compliance)

TCPA Jan 2026 rules require full audit trail for SMS consent:
- `sms_consent_status`: Current consent state
- `sms_consent_at`: Timestamp of consent capture
- `sms_consent_source`: Where consent came from ('manual', 'migration', 'website_form', etc.)
- `sms_consent_method`: How consent was given (verbal, phone call, agreement, form, other)
- `sms_consent_notes`: Free-text notes from user
- `sms_consent_ip`: Client IP at time of consent capture
- `sms_consent_captured_by`: User ID who recorded the consent

Existing customers migrated with status='unknown' and source='migration'.
SMS features skip customers with status='unknown' until consent is captured.

### Tag System

Tags stored as JSONB array, max 5 per customer.
- Presets: VIP, repeat, commercial, residential
- Custom tags allowed
- GIN index enables fast filtering with `tags @> '["VIP"]'` or `tags ?| array['VIP', 'repeat']`
```
  </action>
  <verify>docs/DATA_MODEL.md contains new column definitions and SMS Consent Tracking section</verify>
  <done>DATA_MODEL.md documents all new customer fields including tags and SMS consent audit trail</done>
</task>

</tasks>

<verification>
1. Migration file exists with all new columns
2. tags column has JSONB type, GIN index, and max 5 constraint
3. phone_status column with valid CHECK constraint
4. All 7 SMS consent fields present with correct types
5. timezone column with default
6. docs/DATA_MODEL.md updated
</verification>

<success_criteria>
- [ ] Migration file supabase/migrations/20260202_add_customer_fields.sql exists
- [ ] tags JSONB column with GIN index and customers_max_5_tags constraint
- [ ] phone_status TEXT column with CHECK (valid/invalid/missing)
- [ ] sms_consent_status, sms_consent_at, sms_consent_source columns exist
- [ ] sms_consent_method with enum CHECK constraint
- [ ] sms_consent_notes, sms_consent_ip (INET), sms_consent_captured_by (UUID FK) columns
- [ ] idx_customers_sms_consent_status index created
- [ ] timezone TEXT column with 'America/New_York' default
- [ ] docs/DATA_MODEL.md documents new fields
</success_criteria>

<output>
After completion, create `.planning/phases/20-database-migration-customer-enhancement/20-02-SUMMARY.md`
</output>
