---
phase: 51-audit-remediation
plan: "03"
title: "History Type Migration, UI Correctness, and Dead Code Cleanup"
wave: 2
depends_on:
  - 51-audit-remediation/51-01
  - 51-audit-remediation/51-02
files_modified:
  - components/history/history-client.tsx
  - components/history/history-table.tsx
  - components/history/request-detail-drawer.tsx
  - components/history/empty-state.tsx
  - lib/data/send-logs.ts
  - lib/types/database.ts
autonomous: true
findings: [F-01, F-02, F-03, F-04, F-06, F-07, F-17, F-44-04, F-44-06]
deferred_findings:
  F-08: "Export IS needed — history-table.tsx imports RESENDABLE_STATUSES from history-columns.tsx. Finding was incorrect about it being dead."
  F-14: "Brand logo is a design decision — needs custom SVG, not a code fix. Deferred to design phase."
  F-44-05: "Sequential conflict queries — performance optimization only needed at scale. Acceptable for current volume."
  F-44-08: "CRM brand colors are acceptable exceptions to semantic tokens — documented, no action needed."
  F-44-09: "V1-era naming artifact (saveSoftwareUsed) — rename in future cleanup phase. No user impact."
---

# Plan 51-03: History Type Migration, UI Correctness, and Dead Code Cleanup

## Objective

Migrate the entire history module from the deprecated `SendLogWithContact` type alias to `SendLogWithCustomer`, fix the stub cancel button and incorrect cooldown anchor in the request detail drawer, clean up dead exports and aliases, fix the `custom_service_names` nullable type, and remove the deprecated type alias from database.ts once all consumers are migrated. This plan resolves 5 High findings and touches every file in the history module.

## Context

@docs/CODE-REVIEW-41-44.md — Findings F-01, F-02, F-03, F-04, F-06, F-07, F-08, F-17, F-44-04, F-44-06
@lib/types/database.ts — Lines 190-195 (SendLogWithCustomer and deprecated SendLogWithContact alias)
@components/history/history-client.tsx — Lines 8, 15, 18, 31, 63, 94, 154 (type imports, EmptyState import, heading)
@components/history/history-table.tsx — Lines 22, 25-33 (type import and props)
@components/history/request-detail-drawer.tsx — Lines 23, 27-35, 53-58, 60-63, 104-114, 256-272 (type, cancel, cooldown, isOptedOut)
@components/history/history-columns.tsx — Line 12 (RESENDABLE_STATUSES export)
@components/history/empty-state.tsx — Lines 43-44 (EmptyState alias)
@lib/data/send-logs.ts — Lines 3, 18, 85, 389, 419 (SendLogWithContact usage)

## Tasks

<task id="1">
### Task 1: Type Migration — SendLogWithContact → SendLogWithCustomer everywhere (F-01, F-02, F-03, F-44-06, F-08, F-17)

This is a coordinated migration across 6 files. All must be changed together so the deprecated alias can be removed.

**Step 1: Migrate history-client.tsx (F-01, F-17, F-06)**

1. **F-01** — Line 15: Change import from:
   ```tsx
   import type { SendLogWithContact, Business, MessageTemplate } from '@/lib/types/database'
   ```
   to:
   ```tsx
   import type { SendLogWithCustomer, Business, MessageTemplate } from '@/lib/types/database'
   ```

2. **F-01** — Line 18: Change `initialLogs: SendLogWithContact[]` → `initialLogs: SendLogWithCustomer[]`

3. **F-01** — Line 31: Change `useState<SendLogWithContact | null>` → `useState<SendLogWithCustomer | null>`

4. **F-01** — Line 63: Change `handleRowClick` parameter type: `(request: SendLogWithContact)` → `(request: SendLogWithCustomer)`

5. **F-01** — Line 94: Change `handleInlineRetry` parameter type: `(request: SendLogWithContact)` → `(request: SendLogWithCustomer)`

6. **F-17** — Line 8: Change import from:
   ```tsx
   import { EmptyState } from './empty-state'
   ```
   to:
   ```tsx
   import { HistoryEmptyState } from './empty-state'
   ```

7. **F-17** — Line 224: Change usage from `<EmptyState hasFilters={hasFilters} />` to `<HistoryEmptyState hasFilters={hasFilters} />`

8. **F-06** — Line 154: Upgrade heading from:
   ```tsx
   <h1 className="text-2xl font-semibold tracking-tight">Send History</h1>
   ```
   to:
   ```tsx
   <h1 className="text-3xl font-bold tracking-tight">Send History</h1>
   ```
   Also line 151: The wrapping div uses `space-y-6`. Plan 51-01 already changed the page wrapper. This inner `space-y-6` is correct (it's the component's internal spacing, not the page wrapper). Verify this is the component's internal spacing, not the page-level wrapper. If it's the page-level wrapper, it should already be `space-y-8` from Plan 51-01.

**Step 2: Migrate history-table.tsx (F-02)**

1. Line 22: Change import from:
   ```tsx
   import type { SendLogWithContact } from '@/lib/types/database'
   ```
   to:
   ```tsx
   import type { SendLogWithCustomer } from '@/lib/types/database'
   ```

2. Lines 25-33: Change ALL prop types in `HistoryTableProps`:
   ```tsx
   interface HistoryTableProps {
     data: SendLogWithCustomer[]
     loading?: boolean
     onRowClick?: (request: SendLogWithCustomer) => void
     onResend?: (request: SendLogWithCustomer) => void
     rowSelection?: RowSelectionState
     onRowSelectionChange?: (selection: RowSelectionState) => void
   }
   ```

**Step 3: Migrate request-detail-drawer.tsx (F-03)**

1. Line 23: Change import from:
   ```tsx
   import type { SendLogWithContact, Business, MessageTemplate } from '@/lib/types/database'
   ```
   to:
   ```tsx
   import type { SendLogWithCustomer, Business, MessageTemplate } from '@/lib/types/database'
   ```

2. Line 30: Change prop type from:
   ```tsx
   request: SendLogWithContact | null
   ```
   to:
   ```tsx
   request: SendLogWithCustomer | null
   ```

**Step 4: Migrate lib/data/send-logs.ts (out of Phase 41-44 scope but required)**

1. Line 3: Change import from:
   ```tsx
   import type { SendLogWithContact } from '@/lib/types/database'
   ```
   to:
   ```tsx
   import type { SendLogWithCustomer } from '@/lib/types/database'
   ```

2. Line 18: Change return type from `SendLogWithContact[]` to `SendLogWithCustomer[]`:
   ```tsx
   }): Promise<{ logs: SendLogWithCustomer[]; total: number }> {
   ```

3. Line 85: Change cast from `as SendLogWithContact[]` to `as SendLogWithCustomer[]`:
   ```tsx
   logs: data as SendLogWithCustomer[],
   ```

4. Line 389: Change return type from `SendLogWithContact[]` to `SendLogWithCustomer[]`:
   ```tsx
   export async function getRecentActivityFull(limit: number = 5): Promise<SendLogWithCustomer[]> {
   ```

5. Line 419: Change cast from `as SendLogWithContact[]` to `as SendLogWithCustomer[]`:
   ```tsx
   return (data || []) as SendLogWithCustomer[]
   ```

6. Also update the JSDoc comment at line 387 that says "Returns full SendLogWithContact objects" → "Returns full SendLogWithCustomer objects"

**Step 5: Remove dead code (F-08, F-17, F-44-06)**

1. **F-08** — history-columns.tsx line 12: Remove `export` keyword from RESENDABLE_STATUSES:
   ```tsx
   const RESENDABLE_STATUSES = ['failed', 'bounced']
   ```
   Note: `history-table.tsx` imports this constant. Check the import — it uses `import { createColumns, RESENDABLE_STATUSES } from './history-columns'`. After removing the export, also update history-table.tsx to NOT import RESENDABLE_STATUSES from history-columns. Since RESENDABLE_STATUSES is used in history-table.tsx line 46 for `enableRowSelection`, either:
   - (a) Keep the export (simpler, finding is Low priority), OR
   - (b) Move the constant to both files or a shared location

   Actually, re-reading the finding: "the only consumer is `history-table.tsx` within the same module." This means the export IS used — just only within the module. The finding says "No external consumers found." The export is not truly dead since history-table.tsx imports it. The correct fix is: the `export` is fine since it's used by history-table.tsx. However, since they're in the same module (history/), you could make it module-private. But removing `export` would break history-table.tsx's import.

   **F-08 DEFERRED:** The export IS needed — `history-table.tsx` imports `RESENDABLE_STATUSES` from `history-columns.tsx` at line 21. They are separate TypeScript files, so removing `export` would break the build. The finding's recommendation to "keep constant module-private" is incorrect since the two files are separate modules. No change needed.

2. **F-17** — empty-state.tsx line 44: Remove the backward-compat alias export after updating the import in history-client.tsx (done in Step 1). Remove:
   ```tsx
   // Backward compatibility: export both names
   export { HistoryEmptyState as EmptyState }
   ```
   Just delete these two lines (the comment and the export).

3. **F-44-06** — database.ts lines 194-195: After ALL consumers are migrated (Steps 1-4), remove the deprecated alias:
   ```tsx
   /** @deprecated Use SendLogWithCustomer instead */
   export type SendLogWithContact = SendLogWithCustomer
   ```
   Delete these two lines. Run `pnpm typecheck` to confirm no remaining consumers.

4. **F-44-04** — database.ts line 42: Change `custom_service_names: string[]` to `custom_service_names: string[] | null`:
   ```tsx
   custom_service_names: string[] | null
   ```
   Then check all consumers of `business.custom_service_names` — they should already use `|| []` defensively. Verify with grep. If any consumer assumes non-null, add `|| []` fallback.
</task>

<task id="2">
### Task 2: UI Correctness — Cancel section, cooldown anchor, isOptedOut (F-04, F-07)

These fixes are in `request-detail-drawer.tsx`, which was already modified by Task 1 for the type migration.

**F-04 — Remove stub Cancel Message section + fix isOptedOut:**

1. **Remove Cancel section (lines 255-272).** The entire "Cancel Message" section renders a destructive button that silently no-ops (the `onCancel` handler just closes the drawer). Remove lines 255-272 and replace with a TODO comment:

   Delete:
   ```tsx
   {/* Cancel Section for Pending */}
   {canCancel && (
     <div className="border-t pt-6">
       <h3 className="text-sm font-medium mb-3 text-destructive">Cancel Message</h3>
       <p className="text-sm text-muted-foreground mb-3">
         This message is still pending. You can cancel it before it&apos;s sent.
       </p>
       <Button
         onClick={handleCancel}
         disabled={isCanceling}
         variant="destructive"
         className="w-full"
       >
         <X className="h-4 w-4 mr-2" />
         {isCanceling ? 'Canceling...' : 'Cancel Message'}
       </Button>
     </div>
   )}
   ```

   Replace with:
   ```tsx
   {/* TODO: Implement server-side message cancellation. Until then, no cancel UI shown. */}
   ```

2. **Remove related dead code:** After removing the Cancel section:
   - The `isCanceling` state (line 48) is now unused. Remove: `const [isCanceling, setIsCanceling] = useState(false)`
   - The `handleCancel` function (lines 104-114) is now unused. Remove the entire function.
   - The `canCancel` const (line 64) is now unused. Remove: `const canCancel = request.status === 'pending'`
   - The `onCancel` prop (line 34) is now unused. Remove from the props interface:
     ```tsx
     onCancel?: (requestId: string) => Promise<void>
     ```
   - Remove `onCancel` from the destructured props (line 44).
   - In history-client.tsx, remove the `onCancel` prop passed to `<RequestDetailDrawer>` (lines 235-238):
     ```tsx
     onCancel={async () => {
       // Cancel for pending sends is not yet implemented server-side
       setDrawerOpen(false)
     }}
     ```
     Just remove this prop entirely.

3. **Fix isOptedOut (line 61):** Currently hardcoded `false`. The `SendLogWithCustomer` type has `customers: Pick<Customer, 'name' | 'email'>` — it does NOT include `opted_out`. To properly fix this, we would need to extend the select in `send-logs.ts` to include `opted_out`. However, since the Cancel section is being removed and the only other use of `isOptedOut` is the cooldown/opted-out message section (lines 242-252), and the drawer currently does not have access to `opted_out`:

   Add a comment explaining the limitation:
   ```tsx
   // TODO: Extend SendLogWithCustomer to include customers.opted_out for accurate status
   const isOptedOut = false
   ```

   This is acceptable because the drawer is read-only (no send actions occur for opted-out customers anyway).

**F-07 — Cooldown anchor fix (lines 53-58):**

The cooldown calculation uses `request.created_at` (the send log creation date) instead of `customers.last_sent_at` (the customer's last send date). The comment at line 54 explicitly says "We don't have `last_sent_at` on `SendLogWithContact`."

Since `SendLogWithCustomer` type is `SendLog & { customers: Pick<Customer, 'name' | 'email'> }`, it does not include `last_sent_at`. To properly fix this:

1. **Extend the type:** In `lib/types/database.ts`, change the `SendLogWithCustomer` type to include `last_sent_at`:
   ```tsx
   export interface SendLogWithCustomer extends SendLog {
     customers: Pick<Customer, 'name' | 'email' | 'last_sent_at'>
   }
   ```

2. **Update the select query:** In `lib/data/send-logs.ts`, the `getSendLogs()` function (line 43) uses:
   ```tsx
   .select('*, customers!send_logs_customer_id_fkey!inner(name, email)', { count: 'exact' })
   ```

   Add `last_sent_at` to the select:
   ```tsx
   .select('*, customers!send_logs_customer_id_fkey!inner(name, email, last_sent_at)', { count: 'exact' })
   ```

   Also update `getRecentActivityFull()` (line 409) similarly:
   ```tsx
   .select('*, customers!send_logs_customer_id_fkey(name, email, last_sent_at)')
   ```

3. **Fix the cooldown calculation** in request-detail-drawer.tsx (lines 53-58):
   ```tsx
   const isOnCooldown = request.customers && (() => {
     const lastSent = request.customers.last_sent_at
       ? new Date(request.customers.last_sent_at)
       : new Date(request.created_at) // Fallback to send log date if no last_sent_at
     const cooldownEnd = new Date(lastSent.getTime() + COOLDOWN_DAYS * 24 * 60 * 60 * 1000)
     return new Date() < cooldownEnd
   })()
   ```

4. **Update the mockCustomer** (line 86): Change `last_sent_at: request.created_at` to use the actual value:
   ```tsx
   last_sent_at: request.customers.last_sent_at || request.created_at,
   ```

5. Remove the comment at line 54 that says "We don't have last_sent_at on SendLogWithContact" — it's now resolved.
</task>

## Verification

```bash
pnpm lint && pnpm typecheck
```

Both must pass with zero errors.

**Critical verification — no remaining SendLogWithContact references:**
```bash
# Should return ZERO results
grep -r "SendLogWithContact" --include="*.ts" --include="*.tsx" src/ lib/ components/ app/
```

**Manual checks:**
- Verify `lib/types/database.ts` no longer exports `SendLogWithContact`
- Verify `components/history/empty-state.tsx` no longer exports `EmptyState` alias
- Verify `request-detail-drawer.tsx` has no Cancel Message section
- Verify `request-detail-drawer.tsx` cooldown uses `customers.last_sent_at`
- Verify `history-client.tsx` heading uses `text-3xl font-bold`
- Verify `history-client.tsx` imports `HistoryEmptyState` (not `EmptyState`)
- Verify `database.ts` has `custom_service_names: string[] | null`

## must_haves

- [ ] Zero references to `SendLogWithContact` anywhere in the codebase — fully migrated to `SendLogWithCustomer` (F-01, F-02, F-03, F-44-06)
- [ ] `SendLogWithContact` type alias removed from database.ts (F-44-06)
- [ ] Cancel Message section removed from request-detail-drawer.tsx with TODO comment (F-04)
- [ ] `onCancel` prop removed from RequestDetailDrawer interface and all callers (F-04)
- [ ] All dead code from cancel removal cleaned up: `isCanceling`, `handleCancel`, `canCancel` (F-04)
- [ ] Cooldown calculation uses `customers.last_sent_at` instead of `request.created_at` (F-07)
- [ ] `SendLogWithCustomer` type includes `last_sent_at` in customers Pick (F-07)
- [ ] Send logs queries select `last_sent_at` from customers (F-07)
- [ ] History page heading uses `text-3xl font-bold tracking-tight` (F-06)
- [ ] `EmptyState` alias removed from empty-state.tsx, import updated in history-client.tsx (F-17)
- [ ] `custom_service_names` typed as `string[] | null` in database.ts (F-44-04)
- [ ] `pnpm lint` passes with zero errors
- [ ] `pnpm typecheck` passes with zero errors
