---
phase: 51-audit-remediation
plan: "02"
title: "Security, Validation, Accessibility, and Type Correctness"
wave: 1
depends_on: []
files_modified:
  - lib/actions/business.ts
  - lib/validations/onboarding.ts
  - lib/actions/onboarding.ts
  - components/onboarding/steps/crm-platform-step.tsx
  - components/history/history-filters.tsx
  - components/feedback/feedback-list.tsx
  - components/settings/service-types-section.tsx
  - app/(dashboard)/customers/page.tsx
  - lib/data/business.ts
autonomous: true
findings: [F-44-01, F-44-02, F-44-03, F-44-07, F-05, F-18, F-16, F-CC-01-customers]
---

# Plan 51-02: Security, Validation, Accessibility, and Type Correctness

## Objective

Fix all security/validation gaps (F-44-01, F-44-02, F-44-03), accessibility gaps (F-05, F-18, service-types input), CRM step UX (F-44-07), and the customers page type cast (F-16). These are independent, targeted fixes across the onboarding, validation, and accessibility surfaces.

## Context

@docs/CODE-REVIEW-41-44.md — Findings F-44-01, F-44-02, F-44-03, F-44-07, F-05, F-18, F-16
@lib/actions/business.ts — Lines 217-261 (updateServiceTypeSettings)
@lib/validations/onboarding.ts — Lines 58-60 (softwareUsedSchema)
@lib/actions/onboarding.ts — Lines 283-312 (saveSoftwareUsed)
@components/onboarding/steps/crm-platform-step.tsx — Lines 31-43 (handleContinue/handleSkip), Lines 194-201 (Skip button)
@components/history/history-filters.tsx — Lines 190-204 (date preset chips)
@components/feedback/feedback-list.tsx — Line 3 (SSR import)
@components/settings/service-types-section.tsx — Line 166 (Input without aria-label)
@app/(dashboard)/customers/page.tsx — Lines 22-24 (inline type cast)
@lib/data/business.ts — getBusiness() return type

## Tasks

<task id="1">
### Task 1: Security and Validation Fixes (F-44-01, F-44-02, F-44-03, F-44-07)

**F-44-01 — lib/actions/business.ts `updateServiceTypeSettings` defense-in-depth:**

The function uses `.eq('user_id', user.id)` directly on the businesses table update (line 261) without first fetching the business ID. All other server actions fetch business ID first then scope by `.eq('id', business.id)`. Fix by adding the fetch-first pattern.

1. In `updateServiceTypeSettings` (around line 222-226), after the auth check, add:
```tsx
// Fetch business ID first (defense-in-depth pattern)
const { data: business } = await supabase
  .from('businesses')
  .select('id')
  .eq('user_id', user.id)
  .single()

if (!business) {
  return { error: 'Business not found' }
}
```

2. Change the update query from:
```tsx
.eq('user_id', user.id)
```
to:
```tsx
.eq('id', business.id)
```

**F-44-02 — lib/validations/onboarding.ts `softwareUsedSchema` max length:**

Line 59: `softwareUsed: z.string().optional().or(z.literal(''))` has no max length.

Change to:
```tsx
softwareUsed: z.string().max(100).optional().or(z.literal('')),
```

**F-44-03 — lib/actions/onboarding.ts `saveSoftwareUsed` empty string → null:**

Line 304 already has `softwareUsed || null` which would convert empty string to null. Verify this is correct. The issue reported was in crm-platform-step.tsx line 34 where `selected || ''` saves empty string. The server action already normalizes with `|| null`. Double-check:

```tsx
const { softwareUsed } = parsed.data
```
followed by:
```tsx
.update({ software_used: softwareUsed || null })
```

This already normalizes empty string to null. The issue is actually in crm-platform-step.tsx `handleContinue`:
```tsx
const valueToSave = selected === 'other'
  ? (customText.trim() || 'other')
  : (selected || '')
```

When `selected === null`, `valueToSave = ''`. This gets sent to the server action which normalizes it. So the server-side fix is already in place. However, for defense in depth, also normalize in the client:

Change line 34 from:
```tsx
: (selected || '')
```
to:
```tsx
: (selected ?? '')
```

This is semantically the same but more explicit. The real fix is already on the server side. No additional change needed if the server action already does `|| null`.

**F-44-07 — crm-platform-step.tsx "Skip for now" → "Skip without saving":**

Line 200: Change the button text from `Skip for now` to `Skip without saving`.

Change:
```tsx
Skip for now
```
to:
```tsx
Skip without saving
```
</task>

<task id="2">
### Task 2: Accessibility Fixes and Type Correctness (F-05, F-18, service-types input, F-16)

**F-05 — history-filters.tsx date preset chips aria-pressed:**

Lines 191-204: The date preset chip buttons lack `aria-pressed`. The active state is only visual (CSS class change).

Add `aria-pressed` to each preset button. In the `.map()` for `DATE_PRESETS` (around line 192), add the attribute:

Change the `<button>` from:
```tsx
<button
  key={preset.label}
  type="button"
  onClick={() => applyPreset(preset)}
  className={`inline-flex items-center rounded-full px-3 py-1 text-sm font-medium transition-colors ${
    activePreset === preset.label
      ? 'bg-primary text-primary-foreground'
      : 'bg-muted text-muted-foreground hover:bg-muted/80'
  }`}
>
```
to:
```tsx
<button
  key={preset.label}
  type="button"
  onClick={() => applyPreset(preset)}
  aria-pressed={activePreset === preset.label}
  className={`inline-flex items-center rounded-full px-3 py-1 text-sm font-medium transition-colors ${
    activePreset === preset.label
      ? 'bg-primary text-primary-foreground'
      : 'bg-muted text-muted-foreground hover:bg-muted/80'
  }`}
>
```

**F-18 — feedback-list.tsx Phosphor import normalization:**

Line 3 imports from `@phosphor-icons/react/dist/ssr` (SSR-specific subpath). The rest of the codebase imports from `@phosphor-icons/react`. Since `feedback-list.tsx` is a Server Component, verify the standard import works by checking if other Server Components use the standard import successfully.

If the standard import works in Server Components (check by looking at other SC files that import from `@phosphor-icons/react`), change:
```tsx
import { ChatCircle } from '@phosphor-icons/react/dist/ssr'
```
to:
```tsx
import { ChatCircle } from '@phosphor-icons/react'
```

If the standard import does NOT work in Server Components (causes a build error), keep the SSR import and add a comment:
```tsx
// SSR subpath required for Server Components — standard import causes hydration issues
import { ChatCircle } from '@phosphor-icons/react/dist/ssr'
```

Check other files: look at `components/customers/empty-state.tsx`, `components/jobs/empty-state.tsx`, `components/history/empty-state.tsx` — these are likely Server Components that import from `@phosphor-icons/react`. If they work, the standard import is fine.

**Service-types-section.tsx custom service Input aria-label:**

Line 166: The custom service name `<Input>` has no `aria-label`, `id`, or associated `<label htmlFor>`. The visual label is `<h4>Custom service names</h4>` but it's not linked.

Add `aria-label` to the Input element. Find the Input at line 166:
```tsx
<Input
  value={customServiceInput}
  onChange={(e) => setCustomServiceInput(e.target.value)}
```

Add the aria-label attribute:
```tsx
<Input
  aria-label="Custom service name"
  placeholder="e.g., Garage door repair"
  value={customServiceInput}
  onChange={(e) => setCustomServiceInput(e.target.value)}
```

If the Input already has a `placeholder`, the `aria-label` provides a proper accessible name. If there's no placeholder, add one too.

**F-CC-01 (customers page portion) — customers/page.tsx spacing:**

Also in `app/(dashboard)/customers/page.tsx` line 27, change `space-y-6` to `space-y-8`:
```tsx
<div className="container py-6 space-y-8">
```
This is the customers portion of the cross-page spacing fix (other 5 pages handled by Plan 01).

**F-16 — customers/page.tsx inline type cast + getBusiness() return type:**

Line 22-24 has an inline type annotation `(t: { channel: string })` which is a workaround for `business.message_templates` being untyped:
```tsx
const sendTemplates = (business.message_templates || []).filter(
  (t: { channel: string }) => t.channel === 'email'
)
```

Fix by improving the return type of `getBusiness()` in `lib/data/business.ts`:

1. In `lib/data/business.ts`, the `getBusiness()` function (line 8) returns the raw Supabase query result. The select includes `message_templates!message_templates_business_id_fkey(...)`. Supabase infers the type but it may not match our `MessageTemplate` type.

2. Add a return type annotation to `getBusiness()`. Since the function uses a nested select, the return type should be `Business & { message_templates: Pick<MessageTemplate, 'id' | 'name' | 'subject' | 'body' | 'channel' | 'service_type' | 'is_default' | 'created_at'>[] } | null`.

   However, since the Supabase client infers types from the query, the simplest approach is to keep the Supabase inference and just remove the inline cast from the consumer:

3. In `customers/page.tsx`, remove the inline type cast:
```tsx
const sendTemplates = (business.message_templates || []).filter(
  (t) => t.channel === 'email'
)
```

If this causes a typecheck error, the Supabase type inference is not including `channel` in the inferred type. In that case, add a proper return type to `getBusiness()`:
```tsx
import type { MessageTemplate } from '@/lib/types/database'

// Add type for the nested select result
type BusinessTemplateSubset = Pick<MessageTemplate, 'id' | 'name' | 'subject' | 'body' | 'channel' | 'service_type' | 'is_default' | 'created_at'>

export async function getBusiness(): Promise<(Business & { message_templates: BusinessTemplateSubset[] }) | null> {
```

Run `pnpm typecheck` after the change to verify. If the Supabase inference already provides the correct type, no additional typing is needed — just removing the inline cast is sufficient.
</task>

## Verification

```bash
pnpm lint && pnpm typecheck
```

Both must pass with zero errors.

**Manual checks:**
- In `lib/actions/business.ts`, verify `updateServiceTypeSettings` now fetches business ID first then scopes update by `business.id` (not `user_id`)
- In `lib/validations/onboarding.ts`, verify `softwareUsedSchema` has `.max(100)`
- In `crm-platform-step.tsx`, verify Skip button says "Skip without saving"
- In `history-filters.tsx`, verify all date preset buttons have `aria-pressed` attribute
- In `feedback-list.tsx`, verify import path is either standard `@phosphor-icons/react` or documented SSR with comment
- In `service-types-section.tsx`, verify custom service Input has `aria-label`
- In `customers/page.tsx`, verify no inline type cast `(t: { channel: string })`

## must_haves

- [ ] `updateServiceTypeSettings` fetches business by user_id first, then updates by business.id (F-44-01)
- [ ] `softwareUsedSchema` has `.max(100)` validation (F-44-02)
- [ ] Empty string CRM input normalizes to null at server (F-44-03 — verify existing behavior)
- [ ] Skip button in CRM step says "Skip without saving" (F-44-07)
- [ ] Date preset chip buttons have `aria-pressed` attribute (F-05)
- [ ] feedback-list.tsx uses standard Phosphor import or has documented SSR comment (F-18)
- [ ] Custom service name Input has `aria-label` (service-types accessibility gap)
- [ ] customers/page.tsx has no inline type annotation workaround (F-16)
- [ ] customers/page.tsx uses `space-y-8` (F-CC-01 customers portion)
- [ ] `pnpm lint` passes with zero errors
- [ ] `pnpm typecheck` passes with zero errors
