---
phase: 22-detail-drawers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260201_add_contact_notes.sql
  - lib/types/database.ts
  - lib/actions/contact.ts
  - components/ui/textarea.tsx
autonomous: true

must_haves:
  truths:
    - "contacts table has a notes TEXT column"
    - "Contact type includes optional notes field"
    - "updateContactNotes server action validates input, updates DB, revalidates /contacts"
    - "Textarea UI component exists with consistent styling matching Input component"
  artifacts:
    - path: "supabase/migrations/20260201_add_contact_notes.sql"
      provides: "notes column on contacts table"
      contains: "ADD COLUMN notes"
    - path: "components/ui/textarea.tsx"
      provides: "Styled textarea component"
      exports: ["Textarea"]
    - path: "lib/actions/contact.ts"
      provides: "updateContactNotes server action"
      exports: ["updateContactNotes"]
    - path: "lib/types/database.ts"
      provides: "Contact type with notes field"
      contains: "notes"
  key_links:
    - from: "lib/actions/contact.ts"
      to: "supabase contacts table"
      via: "supabase.from('contacts').update({ notes })"
      pattern: "update.*notes"
---

<objective>
Add the notes column to contacts table, create a Textarea UI component, add the updateContactNotes server action, and update the Contact type.

Purpose: Foundation work required before contact detail drawer can display and persist notes.
Output: DB migration, Textarea component, server action, updated Contact type.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-detail-drawers/22-RESEARCH.md
@lib/types/database.ts
@lib/actions/contact.ts
@components/ui/input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB migration + Contact type + Textarea component</name>
  <files>
    supabase/migrations/20260201_add_contact_notes.sql
    lib/types/database.ts
    components/ui/textarea.tsx
  </files>
  <action>
    1. Create migration file `supabase/migrations/20260201_add_contact_notes.sql`:
       ```sql
       ALTER TABLE public.contacts ADD COLUMN notes TEXT DEFAULT '' NOT NULL;
       ```
       No new RLS policies needed -- inherits existing table policies. Skip the GIN index (premature optimization, can add later if needed).

    2. Update `lib/types/database.ts`:
       - Add `notes?: string` to the `Contact` interface (after `opted_out`). Make it optional since existing rows won't have it until migration runs, and Supabase select will return it as empty string.

    3. Create `components/ui/textarea.tsx` following the exact pattern from `components/ui/input.tsx`:
       ```typescript
       import * as React from "react";
       import { cn } from "@/lib/utils";

       const Textarea = React.forwardRef<HTMLTextAreaElement, React.ComponentProps<"textarea">>(
         ({ className, ...props }, ref) => {
           return (
             <textarea
               className={cn(
                 "flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-base shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
                 className,
               )}
               ref={ref}
               {...props}
             />
           );
         },
       );
       Textarea.displayName = "Textarea";

       export { Textarea };
       ```
       Key differences from Input: uses `textarea` element, `min-h-[60px]` instead of `h-9`, `py-2` instead of `py-1`, no `type` prop, no `file:` styles.
  </action>
  <verify>
    - `pnpm typecheck` passes (Contact type updated, Textarea exported correctly)
    - Migration file exists at correct path
    - Textarea component follows Input pattern exactly
  </verify>
  <done>
    - contacts table will gain `notes TEXT DEFAULT '' NOT NULL` column when migration runs
    - Contact type includes `notes?: string`
    - Textarea component available at `@/components/ui/textarea`
  </done>
</task>

<task type="auto">
  <name>Task 2: Add updateContactNotes server action</name>
  <files>
    lib/actions/contact.ts
  </files>
  <action>
    Add a new exported async function `updateContactNotes` to `lib/actions/contact.ts`:

    ```typescript
    export async function updateContactNotes(
      contactId: string,
      notes: string
    ): Promise<ContactActionState> {
      const supabase = await createClient()

      const { data: { user }, error: authError } = await supabase.auth.getUser()
      if (authError || !user) {
        return { error: 'You must be logged in' }
      }

      // Validate inputs
      if (!contactId || typeof contactId !== 'string') {
        return { error: 'Invalid contact ID' }
      }
      if (typeof notes !== 'string' || notes.length > 10000) {
        return { error: 'Notes must be under 10,000 characters' }
      }

      // Update notes (RLS handles ownership check)
      const { error } = await supabase
        .from('contacts')
        .update({ notes })
        .eq('id', contactId)

      if (error) {
        console.error('Failed to update contact notes:', error)
        return { error: 'Failed to save notes' }
      }

      revalidatePath('/contacts')
      return { success: true }
    }
    ```

    Place it after the existing `updateContact` function. Uses same auth pattern as other actions. No Zod needed here -- simple string validation is sufficient for a text field. RLS on the contacts table ensures user can only update their own business's contacts.
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm lint` passes
    - Function is exported and follows existing action patterns
  </verify>
  <done>
    - `updateContactNotes(contactId, notes)` server action available
    - Returns `{ success: true }` or `{ error: string }`
    - Validates auth, input length, uses RLS for ownership
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with no errors
- `pnpm lint` passes
- Migration file exists at `supabase/migrations/20260201_add_contact_notes.sql`
- `components/ui/textarea.tsx` exports `Textarea`
- `lib/actions/contact.ts` exports `updateContactNotes`
- Contact type in `lib/types/database.ts` includes `notes`
</verification>

<success_criteria>
- DB migration ready to apply (adds notes TEXT column to contacts)
- Contact type updated with notes field
- Textarea UI component created following Input pattern
- updateContactNotes server action validates and persists notes
- All lint + typecheck clean
</success_criteria>

<output>
After completion, create `.planning/phases/22-detail-drawers/22-01-SUMMARY.md`
</output>
