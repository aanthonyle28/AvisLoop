---
phase: 21-sms-foundation-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260204_extend_send_logs_sms.sql
  - supabase/migrations/20260204_create_sms_retry_queue.sql
  - lib/sms/twilio.ts
  - lib/sms/types.ts
  - lib/validations/sms.ts
autonomous: true
user_setup:
  - service: twilio
    why: "SMS sending requires Twilio account and A2P 10DLC approved campaign"
    env_vars:
      - name: TWILIO_ACCOUNT_SID
        source: "Twilio Console -> Account Info -> Account SID"
      - name: TWILIO_AUTH_TOKEN
        source: "Twilio Console -> Account Info -> Auth Token"
      - name: TWILIO_PHONE_NUMBER
        source: "Twilio Console -> Phone Numbers -> Messaging capable number (after A2P approval)"
    dashboard_config:
      - task: "A2P 10DLC campaign must be approved before sending production SMS"
        location: "Twilio Console -> Messaging -> A2P 10DLC -> Campaigns"

must_haves:
  truths:
    - "send_logs table has channel column discriminating email vs sms"
    - "send_logs table has provider_message_id JSONB for multi-provider IDs"
    - "sms_retry_queue table exists with claim pattern matching scheduled_sends"
    - "Twilio client can be instantiated without errors when env vars are set"
  artifacts:
    - path: "supabase/migrations/20260204_extend_send_logs_sms.sql"
      provides: "send_logs channel column and provider_message_id JSONB"
      contains: "channel TEXT"
    - path: "supabase/migrations/20260204_create_sms_retry_queue.sql"
      provides: "SMS retry queue with FOR UPDATE SKIP LOCKED claim RPC"
      contains: "claim_due_sms_retries"
    - path: "lib/sms/twilio.ts"
      provides: "Twilio client singleton with env validation"
      exports: ["twilioClient", "TWILIO_PHONE_NUMBER"]
    - path: "lib/sms/types.ts"
      provides: "SMS-related TypeScript types"
      exports: ["SendSmsParams", "SendSmsResult", "QuietHoursResult"]
    - path: "lib/validations/sms.ts"
      provides: "SMS message validation schema"
      exports: ["smsMessageSchema"]
  key_links:
    - from: "lib/sms/twilio.ts"
      to: "twilio SDK"
      via: "import twilio from 'twilio'"
      pattern: "twilio\\("
---

<objective>
Set up database schema extensions and Twilio client foundation for SMS sending.

Purpose: Enable multi-channel (email/SMS) support in send_logs and create infrastructure for SMS retry queue with atomic claim pattern. This is the foundational layer that all other SMS plans depend on.

Output:
- Extended send_logs table with channel discriminator and provider_message_id JSONB
- sms_retry_queue table with claim_due_sms_retries() RPC matching scheduled_sends pattern
- Twilio client singleton with environment validation
- TypeScript types and Zod validation for SMS messages
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-sms-foundation-compliance/21-RESEARCH.md
@supabase/migrations/00005_create_send_logs.sql
@supabase/migrations/00009b_create_scheduled_sends.sql
@supabase/migrations/00010_claim_due_scheduled_sends.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend send_logs table for multi-channel support</name>
  <files>supabase/migrations/20260204_extend_send_logs_sms.sql</files>
  <action>
Create migration to extend send_logs table:

1. Add channel column (TEXT NOT NULL DEFAULT 'email') with CHECK constraint for ('email', 'sms')
2. Add provider_message_id JSONB column DEFAULT '{}'::jsonb for multi-provider ID storage
3. Add customer_id UUID column (FK to customers.id) - will be used alongside contact_id during migration window
4. Create index idx_send_logs_channel on channel column
5. Backfill existing rows: UPDATE send_logs SET customer_id = contact_id WHERE customer_id IS NULL
6. After backfill, ALTER COLUMN customer_id SET NOT NULL
7. NOTE: Do NOT remove the channel column default - new rows will specify channel explicitly, but existing code paths need the default

Key patterns from research:
- Use JSONB for provider_message_id to store { resend_id: "...", twilio_sid: "..." }
- Existing provider_id column stays for backward compatibility (Resend webhooks reference it)
- customer_id parallels contact_id during migration window (contacts view exists)
  </action>
  <verify>
Run: `supabase db reset` locally to apply migration
Query: `SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'send_logs' AND column_name IN ('channel', 'provider_message_id', 'customer_id');`
All three columns should exist
  </verify>
  <done>
send_logs table has channel TEXT column, provider_message_id JSONB column, and customer_id UUID FK. Existing rows have channel='email' and customer_id populated from contact_id.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SMS retry queue table with atomic claim RPC</name>
  <files>supabase/migrations/20260204_create_sms_retry_queue.sql</files>
  <action>
Create sms_retry_queue table following the scheduled_sends pattern:

Schema:
```sql
CREATE TABLE IF NOT EXISTS public.sms_retry_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_id UUID NOT NULL REFERENCES public.businesses(id) ON DELETE CASCADE,
  send_log_id UUID NOT NULL REFERENCES public.send_logs(id) ON DELETE CASCADE,
  customer_id UUID NOT NULL REFERENCES public.customers(id) ON DELETE CASCADE,

  status TEXT NOT NULL DEFAULT 'pending',
  attempt_count INT NOT NULL DEFAULT 0,
  max_attempts INT NOT NULL DEFAULT 3,

  scheduled_for TIMESTAMPTZ NOT NULL,
  last_attempted_at TIMESTAMPTZ,
  last_error TEXT,

  reason TEXT,  -- 'quiet_hours', 'twilio_error', 'rate_limit'

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT sms_retry_queue_status_valid CHECK (
    status IN ('pending', 'processing', 'completed', 'failed', 'cancelled')
  )
);
```

Indexes:
- Partial index for pending + due (matches scheduled_sends pattern)
- Index on business_id for scoped queries

RLS Policies:
- SELECT/INSERT/UPDATE using business ownership subquery pattern

RPC Functions (same pattern as claim_due_scheduled_sends):
- claim_due_sms_retries(limit_count INT DEFAULT 50) - atomic claim with FOR UPDATE SKIP LOCKED
- recover_stuck_sms_retries(stale_minutes INT DEFAULT 10) - recovery for stuck processing records

Trigger:
- moddatetime trigger for updated_at
  </action>
  <verify>
Run: `supabase db reset` locally to apply migration
Query: `SELECT routine_name FROM information_schema.routines WHERE routine_name LIKE '%sms_retries%';`
Should show: claim_due_sms_retries, recover_stuck_sms_retries
  </verify>
  <done>
sms_retry_queue table exists with RLS policies, partial index for pending items, and claim_due_sms_retries() + recover_stuck_sms_retries() RPCs.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Twilio client, types, and validation</name>
  <files>lib/sms/twilio.ts, lib/sms/types.ts, lib/validations/sms.ts</files>
  <action>
Create lib/sms/twilio.ts - Twilio client singleton:
```typescript
import twilio from 'twilio'

const accountSid = process.env.TWILIO_ACCOUNT_SID
const authToken = process.env.TWILIO_AUTH_TOKEN
export const TWILIO_PHONE_NUMBER = process.env.TWILIO_PHONE_NUMBER

// Validate env vars at module load (fail fast)
if (!accountSid || !authToken) {
  console.warn('Twilio credentials not configured - SMS sending disabled')
}

// Export client (will be null if not configured)
export const twilioClient = accountSid && authToken
  ? twilio(accountSid, authToken)
  : null

// Helper to check if SMS is available
export function isSmsEnabled(): boolean {
  return twilioClient !== null && !!TWILIO_PHONE_NUMBER
}
```

Create lib/sms/types.ts - TypeScript types:
```typescript
export interface SendSmsParams {
  to: string              // E.164 format: +15125551234
  body: string            // Message body (max 160 GSM-7 chars for single segment)
  businessId: string
  customerId: string
  sendLogId: string
}

export interface SendSmsResult {
  success: boolean
  messageSid?: string     // Twilio message SID
  status?: string         // Twilio status (queued, sent, etc.)
  error?: string
  errorCode?: number      // Twilio error code
}

export interface QuietHoursResult {
  canSend: boolean
  nextSendTime?: Date     // UTC time for next available send window
  reason?: 'too_early' | 'too_late'
}

export type SmsRetryReason = 'quiet_hours' | 'twilio_error' | 'rate_limit'

export interface SmsRetryQueueItem {
  id: string
  business_id: string
  send_log_id: string
  customer_id: string
  status: 'pending' | 'processing' | 'completed' | 'failed' | 'cancelled'
  attempt_count: number
  max_attempts: number
  scheduled_for: string
  last_attempted_at: string | null
  last_error: string | null
  reason: SmsRetryReason | null
}
```

Create lib/validations/sms.ts - Zod validation:
```typescript
import { z } from 'zod'

// GSM-7 single segment limit
export const GSM7_LIMIT = 160

// SMS soft limit (2 segments)
export const SMS_SOFT_LIMIT = 320

export const smsMessageSchema = z.object({
  body: z.string()
    .min(1, 'Message is required')
    .max(SMS_SOFT_LIMIT, `Message cannot exceed ${SMS_SOFT_LIMIT} characters`),
  customerId: z.string().uuid('Invalid customer ID'),
  templateId: z.string().uuid('Invalid template ID').optional(),
})

export type SmsMessageInput = z.infer<typeof smsMessageSchema>

// Helper to check if message is single segment
export function isSingleSegment(body: string): boolean {
  return body.length <= GSM7_LIMIT
}

// Helper to estimate segment count (simplified - not checking GSM-7 encoding)
export function estimateSegments(body: string): number {
  if (body.length <= GSM7_LIMIT) return 1
  return Math.ceil(body.length / 153) // Multi-part messages have 153 char limit per segment
}
```

Install twilio and date-fns-tz:
```bash
pnpm add twilio date-fns-tz
```
  </action>
  <verify>
Run: `pnpm typecheck`
Import test: Create temp file that imports { twilioClient } from '@/lib/sms/twilio' - should not error
Types test: Create temp file that imports { SendSmsParams } from '@/lib/sms/types' - should not error
  </verify>
  <done>
- Twilio client exports twilioClient singleton with env validation
- Types exported: SendSmsParams, SendSmsResult, QuietHoursResult, SmsRetryReason
- Validation exports smsMessageSchema with 320 char soft limit
- pnpm typecheck passes
  </done>
</task>

</tasks>

<verification>
1. Run `supabase db reset` - all migrations apply without errors
2. Query send_logs columns - channel, provider_message_id, customer_id all exist
3. Query sms_retry_queue - table exists with correct schema
4. Query RPCs - claim_due_sms_retries and recover_stuck_sms_retries exist
5. Run `pnpm typecheck` - no type errors
6. Run `pnpm lint` - no lint errors
</verification>

<success_criteria>
- send_logs table extended with channel (TEXT), provider_message_id (JSONB), customer_id (UUID)
- sms_retry_queue table created with atomic claim pattern matching scheduled_sends
- Twilio client singleton created with graceful handling when env vars missing
- TypeScript types and Zod validation for SMS messages created
- All lint and typecheck passing
</success_criteria>

<output>
After completion, create `.planning/phases/21-sms-foundation-compliance/21-01-SUMMARY.md`
</output>
