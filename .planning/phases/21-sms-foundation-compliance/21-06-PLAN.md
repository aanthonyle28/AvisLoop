---
phase: 21-sms-foundation-compliance
plan: 06
type: execute
wave: 5
depends_on: ["21-05"]
files_modified:
  - docs/DATA_MODEL.md
  - docs/SMS_COMPLIANCE.md
autonomous: false

must_haves:
  truths:
    - "All Phase 21 requirements verified working end-to-end"
    - "SMS sends successfully via Twilio (or test mode documented)"
    - "STOP webhook updates consent status"
    - "Quiet hours enforces 8am-9pm local time"
    - "Retry queue processes failed sends"
  artifacts:
    - path: "docs/DATA_MODEL.md"
      provides: "Updated documentation with SMS fields"
      contains: "channel"
    - path: "docs/SMS_COMPLIANCE.md"
      provides: "SMS compliance documentation"
      contains: "TCPA"
  key_links: []
---

<objective>
Verify end-to-end SMS functionality and update documentation.

Purpose: Ensure all Phase 21 success criteria are met through manual testing. Update DATA_MODEL.md with send_logs changes and create SMS_COMPLIANCE.md documenting TCPA requirements and implementation.

Output:
- Verified SMS sending flow (or documented test mode)
- Updated DATA_MODEL.md with send_logs schema changes
- SMS_COMPLIANCE.md with TCPA documentation
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-sms-foundation-compliance/21-RESEARCH.md
@.planning/phases/21-sms-foundation-compliance/21-01-SUMMARY.md
@.planning/phases/21-sms-foundation-compliance/21-05-SUMMARY.md
@docs/DATA_MODEL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1a: Run automated verification checks</name>
  <files></files>
  <action>
Run automated checks to verify Phase 21 implementation before manual verification:

**1. Schema verification (CLI):**
```bash
# Check send_logs columns exist
pnpm supabase db dump --schema public --no-data | grep -A 20 "CREATE TABLE.*send_logs"
# Expect: channel, provider_message_id, customer_id columns

# Check RPC functions exist
pnpm supabase db dump --schema public --no-data | grep -E "FUNCTION.*(claim_due_sms_retries|recover_stuck_sms_retries)"
# Expect: Both functions present
```

**2. Route verification (file check):**
```bash
# Check webhook routes exist
ls -la app/api/webhooks/twilio/inbound/route.ts
ls -la app/api/webhooks/twilio/status/route.ts
# Expect: Both files exist
```

**3. Component exports verification:**
```bash
# Check component exports (via typecheck)
pnpm typecheck
# Expect: No errors related to ChannelSelector, SmsCharacterCounter
```

**4. Lint check:**
```bash
pnpm lint
# Expect: No errors
```

**5. Webhook 403 test (if dev server running):**
```bash
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:3000/api/webhooks/twilio/inbound
# Expect: 403
```

Capture results of all automated checks in verification notes.
  </action>
  <verify>
All automated checks pass:
- Schema has required columns
- RPC functions exist
- Webhook routes exist
- No typecheck errors
- No lint errors
  </verify>
  <done>
Automated verification confirms schema, routes, components, and types are correctly implemented.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
SMS Foundation & Compliance system including:
- Extended send_logs with channel column and provider_message_id JSONB
- SMS retry queue with exponential backoff
- Twilio integration with webhook signature verification
- STOP keyword handling for opt-out
- Quiet hours enforcement (8am-9pm local time)
- Channel selector UI with character counter
  </what-built>
  <how-to-verify>
**Pre-flight checks:**
1. Verify environment variables set:
   - TWILIO_ACCOUNT_SID
   - TWILIO_AUTH_TOKEN
   - TWILIO_PHONE_NUMBER (requires A2P approval)

2. If A2P NOT approved yet:
   - Note: SMS sends will fail - this is expected
   - Test can proceed in "test mode" verifying:
     - send_logs created with channel='sms'
     - Quiet hours queueing works
     - UI components render correctly
   - Skip live SMS verification steps

**UI verification:**
1. Navigate to /dashboard/send
2. Select a customer WITH valid phone AND sms_consent_status='opted_in'
3. Verify: SMS tab is enabled in channel selector
4. Select a customer WITHOUT phone
5. Verify: SMS tab is disabled with reason text
6. Switch to SMS channel
7. Verify: Character counter appears below message textarea
8. Type message over 160 chars
9. Verify: Counter turns yellow, shows "2 segments"
10. Verify: SMS message template/input includes review link placeholder

**If A2P approved - Live SMS test:**
1. Send SMS to test phone number
2. Verify SMS received with opt-out footer AND review link
3. Reply STOP
4. Verify customer sms_consent_status updated to 'opted_out'

**Quiet hours verification:**
1. Temporarily adjust checkQuietHours to return canSend: false
2. Send SMS
3. Verify: Response shows queued: true with queuedFor timestamp
4. Query sms_retry_queue: record should exist with reason='quiet_hours'
  </how-to-verify>
  <resume-signal>
Type "verified" if all checks pass (or "verified-test-mode" if A2P pending).
If issues found, describe them for fix.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 2: Update DATA_MODEL.md with send_logs changes</name>
  <files>docs/DATA_MODEL.md</files>
  <action>
Update docs/DATA_MODEL.md to add send_logs schema documentation:

Add new section after customers section:

```markdown
## Table: send_logs

Tracks all outbound messages (email and SMS) with delivery status.

### Schema

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | UUID | NO | gen_random_uuid() | Primary key |
| business_id | UUID | NO | - | FK to businesses |
| contact_id | UUID | NO | - | FK to contacts (legacy) |
| customer_id | UUID | NO | - | FK to customers |
| template_id | UUID | YES | - | FK to message_templates |
| channel | TEXT | NO | 'email' | 'email' or 'sms' |
| status | TEXT | NO | 'pending' | Send status |
| provider_id | TEXT | YES | - | Legacy Resend email ID |
| provider_message_id | JSONB | NO | '{}' | Provider IDs: {resend_id, twilio_sid} |
| error_message | TEXT | YES | - | Error details if failed |
| subject | TEXT | NO | - | Email subject or SMS body |
| is_test | BOOLEAN | NO | false | Test send flag |
| created_at | TIMESTAMPTZ | YES | NOW() | Created timestamp |
| updated_at | TIMESTAMPTZ | YES | NOW() | Updated timestamp |

### Status Values

| Status | Description |
|--------|-------------|
| pending | Message created, not yet sent |
| sent | Sent to provider (Resend/Twilio) |
| delivered | Delivery confirmed by provider |
| bounced | Email bounced |
| complained | Spam complaint |
| failed | Send failed |
| opened | Message opened (email only) |

### Channel Column

The `channel` column discriminates between email and SMS sends:
- `email`: Traditional email via Resend
- `sms`: SMS via Twilio

### Provider Message ID

The `provider_message_id` JSONB column stores provider-specific IDs:
```json
{
  "resend_id": "abc123",    // For email sends
  "twilio_sid": "SM..."     // For SMS sends
}
```

Query examples:
- Find by Resend ID: `WHERE provider_message_id->>'resend_id' = 'abc123'`
- Find by Twilio SID: `WHERE provider_message_id->>'twilio_sid' = 'SM...'`

### Indexes

- idx_send_logs_business_id (btree)
- idx_send_logs_contact_id (btree)
- idx_send_logs_customer_id (btree)
- idx_send_logs_created_at (btree DESC)
- idx_send_logs_channel (btree)

### RLS Policies

Users can only view/insert/update send_logs for businesses they own.


## Table: sms_retry_queue

Queues failed or delayed SMS sends for retry processing.

### Schema

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | UUID | NO | gen_random_uuid() | Primary key |
| business_id | UUID | NO | - | FK to businesses |
| send_log_id | UUID | NO | - | FK to send_logs |
| customer_id | UUID | NO | - | FK to customers |
| status | TEXT | NO | 'pending' | Queue status |
| attempt_count | INT | NO | 0 | Current attempt number |
| max_attempts | INT | NO | 3 | Max retry attempts |
| scheduled_for | TIMESTAMPTZ | NO | - | When to process |
| last_attempted_at | TIMESTAMPTZ | YES | - | Last attempt timestamp |
| last_error | TEXT | YES | - | Error from last attempt |
| reason | TEXT | YES | - | Why queued |
| created_at | TIMESTAMPTZ | YES | NOW() | Created timestamp |
| updated_at | TIMESTAMPTZ | YES | NOW() | Updated timestamp |

### Reason Values

| Reason | Description |
|--------|-------------|
| quiet_hours | Outside 8am-9pm customer local time |
| twilio_error | Twilio API failure (retryable) |
| rate_limit | Rate limit exceeded |

### RPC Functions

- `claim_due_sms_retries(limit_count)`: Atomically claim pending retries with FOR UPDATE SKIP LOCKED
- `recover_stuck_sms_retries(stale_minutes)`: Reset stuck processing records

### Exponential Backoff

Retry delays: 1 minute, 5 minutes, 15 minutes, then fail.
```
  </action>
  <verify>
Verify DATA_MODEL.md contains send_logs and sms_retry_queue sections
Run `pnpm lint` - no markdown errors
  </verify>
  <done>
DATA_MODEL.md updated with send_logs schema changes (channel, provider_message_id, customer_id) and sms_retry_queue documentation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create SMS_COMPLIANCE.md documentation</name>
  <files>docs/SMS_COMPLIANCE.md</files>
  <action>
Create docs/SMS_COMPLIANCE.md with TCPA compliance documentation:

```markdown
# SMS Compliance Documentation

## Overview

AvisLoop SMS messaging is designed for TCPA (Telephone Consumer Protection Act) compliance, including the January 2026 rules update requiring explicit written consent for automated SMS.

## TCPA Requirements

### 1. Consent Requirements

**Opt-In Required:**
- SMS can only be sent to customers with `sms_consent_status = 'opted_in'`
- Consent must be captured with audit trail:
  - `sms_consent_at`: Timestamp of consent
  - `sms_consent_source`: How consent was obtained
  - `sms_consent_method`: Consent method (verbal, form, etc.)
  - `sms_consent_ip`: IP address if captured online
  - `sms_consent_captured_by`: User who recorded consent

**Consent Sources:**
- `manual`: Business owner recorded consent
- `migration`: Pre-existing customers (requires re-consent)
- `website_form`: Online form submission
- `sms_reply_stop`: Opt-out via STOP reply

### 2. Opt-Out Handling

**STOP Keywords Supported:**
- STOP
- STOPALL
- UNSUBSCRIBE
- CANCEL
- END
- QUIT

**Processing:**
- Webhook at `/api/webhooks/twilio/inbound` handles STOP replies
- Customer `sms_consent_status` updated to `opted_out` within 5 minutes
- All customers with matching phone number are opted out (phone collision safety)
- Twilio sends automatic confirmation message

### 3. Quiet Hours

**Enforcement:**
- SMS only sent between 8am-9pm customer local time
- Customer timezone stored in `customers.timezone` (IANA format)
- Default timezone: America/New_York
- Messages outside window queued for next 8am

**Implementation:**
- `checkQuietHours()` in `lib/sms/quiet-hours.ts`
- Uses date-fns-tz for accurate timezone conversion
- Handles DST transitions correctly

### 4. Message Requirements

**Opt-Out Footer:**
- All SMS include "Reply STOP to opt out." footer
- Automatically appended by `sendSms()` function
- Cannot be removed by users

**Character Limits:**
- GSM-7: 160 characters per segment
- Unicode: 70 characters per segment
- UI warns at 2 segments (yellow)
- UI warns strongly at 3+ segments (red)

## A2P 10DLC Registration

### Requirements

Before sending production SMS, complete Twilio A2P 10DLC registration:

1. **Brand Registration:**
   - Business name and EIN
   - Website URL
   - Business type and industry

2. **Campaign Registration:**
   - Use case: Marketing (review requests)
   - Sample messages
   - Opt-in/opt-out flow description

### Environment Variables

```env
TWILIO_ACCOUNT_SID=ACxxxxxxxx
TWILIO_AUTH_TOKEN=xxxxxxxx
TWILIO_PHONE_NUMBER=+1xxxxxxxxxx
```

### Phone Number

After A2P approval:
- Purchase toll-free or local number
- Link to approved campaign
- Set TWILIO_PHONE_NUMBER env var

## Webhook Security

### Signature Verification

All Twilio webhooks verify signature using `twilio.validateRequest()`:
- `/api/webhooks/twilio/inbound` - STOP handling
- `/api/webhooks/twilio/status` - Delivery status

Invalid signatures rejected with 403 Forbidden.

### URL Configuration

Webhook URLs must match exactly what Twilio sees:
- Use `NEXT_PUBLIC_SITE_URL` for URL construction
- Ensure HTTPS in production
- No trailing slashes

## Retry Logic

### Exponential Backoff

Failed SMS retries with delays: 1 min, 5 min, 15 min, then fail.

### Retryable vs Permanent Errors

**Retryable (will retry):**
- Network timeout
- Rate limit
- Temporary Twilio outage

**Permanent (no retry):**
- Invalid phone number (21211)
- Unsubscribed recipient (21610)
- Not a mobile number (21614)
- Landline (30006)

## Monitoring

### Send Logs

Query SMS sends:
```sql
SELECT * FROM send_logs WHERE channel = 'sms' ORDER BY created_at DESC;
```

### Retry Queue

Check pending retries:
```sql
SELECT * FROM sms_retry_queue WHERE status = 'pending';
```

### Failed Sends

Check failures:
```sql
SELECT * FROM send_logs
WHERE channel = 'sms' AND status = 'failed'
ORDER BY created_at DESC;
```

## References

- [TCPA Compliance Guide (FCC)](https://www.fcc.gov/consumers/guides/stop-unwanted-calls-and-texts)
- [Twilio A2P 10DLC Documentation](https://www.twilio.com/docs/sms/a2p-10dlc)
- [Twilio Opt-Out Handling](https://help.twilio.com/articles/31560110671259)
```
  </action>
  <verify>
Verify docs/SMS_COMPLIANCE.md created
Contains TCPA sections, A2P guidance, webhook security
Run `pnpm lint` - no markdown errors
  </verify>
  <done>
SMS_COMPLIANCE.md created with TCPA requirements, A2P 10DLC guidance, webhook security documentation, and monitoring queries.
  </done>
</task>

</tasks>

<verification>
1. Human verification checkpoint passed (or test mode documented)
2. DATA_MODEL.md updated with send_logs and sms_retry_queue schemas
3. SMS_COMPLIANCE.md created with complete TCPA documentation
4. All Phase 21 success criteria verified or documented as pending A2P
</verification>

<success_criteria>
- All Phase 21 requirements verified or documented as blocked by A2P
- DATA_MODEL.md reflects send_logs schema changes
- SMS_COMPLIANCE.md provides complete TCPA compliance guide
- Webhook endpoints return 403 on invalid signature
- UI components render correctly
- If A2P approved: Live SMS verified with STOP handling
</success_criteria>

<output>
After completion, create `.planning/phases/21-sms-foundation-compliance/21-06-SUMMARY.md`
</output>
