---
phase: 21-sms-foundation-compliance
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - lib/sms/quiet-hours.ts
  - lib/sms/send-sms.ts
autonomous: true

must_haves:
  truths:
    - "SMS messages outside 8am-9pm customer local time return canSend=false with nextSendTime"
    - "sendSms function sends via Twilio client and returns messageSid on success"
    - "sendSms function returns error object on Twilio failure without throwing"
  artifacts:
    - path: "lib/sms/quiet-hours.ts"
      provides: "Quiet hours check with timezone conversion"
      exports: ["checkQuietHours", "QUIET_HOURS_START", "QUIET_HOURS_END"]
    - path: "lib/sms/send-sms.ts"
      provides: "Core SMS sending function via Twilio"
      exports: ["sendSms"]
  key_links:
    - from: "lib/sms/send-sms.ts"
      to: "lib/sms/twilio.ts"
      via: "twilioClient import"
      pattern: "twilioClient\\.messages\\.create"
    - from: "lib/sms/quiet-hours.ts"
      to: "date-fns-tz"
      via: "utcToZonedTime import"
      pattern: "utcToZonedTime"
---

<objective>
Implement quiet hours enforcement and core SMS sending logic.

Purpose: Ensure SMS messages respect customer timezone and TCPA quiet hours (8am-9pm local time). Create the core sendSms function that all SMS sending paths will use.

Output:
- Quiet hours checker using date-fns-tz for timezone conversion
- Core sendSms function with Twilio integration and error handling
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-sms-foundation-compliance/21-RESEARCH.md
@.planning/phases/21-sms-foundation-compliance/21-01-SUMMARY.md
@lib/sms/twilio.ts
@lib/sms/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement quiet hours enforcement with timezone conversion</name>
  <files>lib/sms/quiet-hours.ts</files>
  <action>
Create lib/sms/quiet-hours.ts using date-fns-tz for timezone conversion:

```typescript
import { toZonedTime, fromZonedTime } from 'date-fns-tz'
import type { QuietHoursResult } from './types'

// TCPA-compliant quiet hours: 8am-9pm local time
export const QUIET_HOURS_START = 8   // 8:00 AM
export const QUIET_HOURS_END = 21    // 9:00 PM (21:00)

/**
 * Check if current time is within quiet hours for customer's timezone.
 * Returns canSend: true if within 8am-9pm local time.
 * Returns nextSendTime (UTC) if currently in quiet hours.
 *
 * @param customerTimezone - IANA timezone string (e.g., 'America/New_York')
 * @param now - Optional current time for testing (defaults to new Date())
 */
export function checkQuietHours(
  customerTimezone: string,
  now: Date = new Date()
): QuietHoursResult {
  // Convert current UTC time to customer's local timezone
  const zonedNow = toZonedTime(now, customerTimezone)
  const currentHour = zonedNow.getHours()

  // Check if within 8am-9pm (8 <= hour < 21)
  if (currentHour >= QUIET_HOURS_START && currentHour < QUIET_HOURS_END) {
    return { canSend: true }
  }

  // Calculate next 8am in customer's timezone
  const next8am = new Date(zonedNow)

  if (currentHour >= QUIET_HOURS_END) {
    // After 9pm - send tomorrow at 8am
    next8am.setDate(next8am.getDate() + 1)
  }
  // Before 8am - send today at 8am (no date change needed)

  next8am.setHours(QUIET_HOURS_START, 0, 0, 0)

  // Convert back to UTC for storage
  const nextSendTimeUTC = fromZonedTime(next8am, customerTimezone)

  return {
    canSend: false,
    nextSendTime: nextSendTimeUTC,
    reason: currentHour >= QUIET_HOURS_END ? 'too_late' : 'too_early',
  }
}

/**
 * Get the default timezone for a business (fallback when customer timezone unknown).
 * Uses America/New_York as safe default for US-based home service businesses.
 */
export const DEFAULT_TIMEZONE = 'America/New_York'
```

NOTE: date-fns-tz v3.x renamed functions:
- utcToZonedTime -> toZonedTime
- zonedTimeToUtc -> fromZonedTime

Verify the correct function names after installing date-fns-tz.
  </action>
  <verify>
Run `pnpm typecheck` - no errors
Create test cases:
- 10am Eastern -> canSend: true
- 10pm Eastern -> canSend: false, nextSendTime is tomorrow 8am Eastern (in UTC)
- 3am Eastern -> canSend: false, nextSendTime is today 8am Eastern (in UTC)
  </verify>
  <done>
checkQuietHours function returns canSend: true for 8am-9pm local time, returns nextSendTime (UTC) when outside quiet hours. Uses date-fns-tz for accurate timezone conversion including DST handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement core SMS sending function</name>
  <files>lib/sms/send-sms.ts</files>
  <action>
Create lib/sms/send-sms.ts with Twilio integration:

```typescript
import { twilioClient, TWILIO_PHONE_NUMBER, isSmsEnabled } from './twilio'
import type { SendSmsParams, SendSmsResult } from './types'

// Opt-out footer required for TCPA compliance
const OPT_OUT_FOOTER = '\n\nReply STOP to opt out.'

/**
 * Send SMS via Twilio with error handling.
 * Adds TCPA-compliant opt-out footer automatically.
 *
 * Does NOT check quiet hours or consent - caller is responsible for those checks.
 *
 * @returns SendSmsResult with success/failure status
 */
export async function sendSms(params: SendSmsParams): Promise<SendSmsResult> {
  // Check if SMS is enabled
  if (!isSmsEnabled() || !twilioClient) {
    return {
      success: false,
      error: 'SMS sending is not configured. Check Twilio environment variables.',
    }
  }

  // Append opt-out footer if not already present
  const bodyWithFooter = params.body.toLowerCase().includes('stop')
    ? params.body
    : params.body + OPT_OUT_FOOTER

  try {
    const message = await twilioClient.messages.create({
      body: bodyWithFooter,
      to: params.to,
      from: TWILIO_PHONE_NUMBER,
      statusCallback: `${process.env.NEXT_PUBLIC_SITE_URL}/api/webhooks/twilio/status`,
    })

    return {
      success: true,
      messageSid: message.sid,
      status: message.status,
    }
  } catch (error: unknown) {
    // Handle Twilio-specific errors
    if (error && typeof error === 'object' && 'code' in error && 'message' in error) {
      const twilioError = error as { code: number; message: string }
      console.error(`Twilio Error ${twilioError.code}: ${twilioError.message}`)
      return {
        success: false,
        error: twilioError.message,
        errorCode: twilioError.code,
      }
    }

    // Handle generic errors
    console.error('SMS send error:', error)
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error sending SMS',
    }
  }
}

/**
 * Common Twilio error codes:
 * - 21211: Invalid 'To' Phone Number
 * - 21610: Message cannot be sent to unsubscribed recipient
 * - 21614: 'To' number is not a valid mobile number
 * - 30003: Unreachable destination handset
 * - 30005: Unknown destination handset
 * - 30006: Landline or unreachable carrier
 * - 30007: Message blocked by carrier
 * - 30008: Unknown error
 */
export const TWILIO_ERROR_CODES = {
  INVALID_TO_NUMBER: 21211,
  UNSUBSCRIBED: 21610,
  NOT_MOBILE: 21614,
  UNREACHABLE: 30003,
  UNKNOWN_HANDSET: 30005,
  LANDLINE: 30006,
  CARRIER_BLOCKED: 30007,
  UNKNOWN: 30008,
} as const

/**
 * Check if error is retryable (transient) vs permanent.
 * Permanent errors should not be retried.
 */
export function isRetryableError(errorCode?: number): boolean {
  if (!errorCode) return true // Unknown errors are retryable

  const permanentErrors = [
    TWILIO_ERROR_CODES.INVALID_TO_NUMBER,
    TWILIO_ERROR_CODES.UNSUBSCRIBED,
    TWILIO_ERROR_CODES.NOT_MOBILE,
    TWILIO_ERROR_CODES.LANDLINE,
  ]

  return !permanentErrors.includes(errorCode)
}
```

Key design decisions:
- Does NOT check quiet hours - that's the caller's responsibility (action/cron handler)
- Does NOT check consent - that's the caller's responsibility
- Always adds opt-out footer (TCPA compliance)
- Returns structured result, never throws
- Categorizes errors as retryable vs permanent
  </action>
  <verify>
Run `pnpm typecheck` - no errors
Run `pnpm lint` - no errors
Verify exports: sendSms, TWILIO_ERROR_CODES, isRetryableError all accessible
  </verify>
  <done>
sendSms function sends via Twilio client with:
- Automatic opt-out footer appending
- Status callback URL for delivery tracking
- Structured error handling (no throws)
- Error code categorization for retry logic
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - all files pass
2. Run `pnpm lint` - no lint errors
3. Import test: checkQuietHours and sendSms are importable
4. Type test: QuietHoursResult and SendSmsResult types work correctly
</verification>

<success_criteria>
- Quiet hours check correctly identifies 8am-9pm local time window
- Quiet hours returns UTC nextSendTime when outside window
- sendSms sends via Twilio and returns messageSid on success
- sendSms returns structured error on failure without throwing
- Opt-out footer automatically appended to all SMS messages
- Error codes categorized as retryable vs permanent
</success_criteria>

<output>
After completion, create `.planning/phases/21-sms-foundation-compliance/21-02-SUMMARY.md`
</output>
