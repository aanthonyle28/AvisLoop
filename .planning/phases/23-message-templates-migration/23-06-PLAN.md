---
phase: 23-message-templates-migration
plan: 06
type: execute
wave: 4
depends_on: ["23-04", "23-05"]
files_modified:
  - app/dashboard/settings/page.tsx
  - components/template-list.tsx
  - components/templates/template-list-item.tsx
autonomous: true

must_haves:
  truths:
    - "Settings page uses MessageTemplateForm instead of EmailTemplateForm"
    - "Template list shows channel badge (Email/SMS)"
    - "Template list groups templates by channel"
    - "System templates show 'Use this template' button"
    - "User templates show edit/delete actions"
  artifacts:
    - path: "app/dashboard/settings/page.tsx"
      provides: "Updated settings page with new components"
      contains: "MessageTemplateForm"
    - path: "components/template-list.tsx"
      provides: "Updated template list with channel support"
      contains: "channel"
    - path: "components/templates/template-list-item.tsx"
      provides: "Individual template row component"
      contains: "TemplateListItem"
  key_links:
    - from: "app/dashboard/settings/page.tsx"
      to: "components/templates/message-template-form.tsx"
      via: "component import"
      pattern: "import.*MessageTemplateForm"
    - from: "app/dashboard/settings/page.tsx"
      to: "lib/data/message-template.ts"
      via: "data fetching"
      pattern: "getMessageTemplates"
---

<objective>
Update settings page and template list to use new unified message templates with channel support.

Purpose: Enable users to view, create, and manage both email and SMS templates from settings.
Output: Updated settings page with message template form and channel-aware template list.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-message-templates-migration/23-CONTEXT.md
@app/dashboard/settings/page.tsx
@components/template-list.tsx
@components/email-template-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create template-list-item.tsx component</name>
  <files>components/templates/template-list-item.tsx</files>
  <action>
Create new file components/templates/template-list-item.tsx for individual template display:

```typescript
'use client'

import { useState } from 'react'
import { EnvelopeSimple, ChatCircle, Copy, Trash, CaretDown } from '@phosphor-icons/react'
import { deleteMessageTemplate, copySystemTemplate } from '@/lib/actions/message-template'
import { toast } from 'sonner'
import { useRouter } from 'next/navigation'
import { cn } from '@/lib/utils'
import type { MessageTemplate } from '@/lib/types/database'

interface TemplateListItemProps {
  template: MessageTemplate
}

export function TemplateListItem({ template }: TemplateListItemProps) {
  const router = useRouter()
  const [isExpanded, setIsExpanded] = useState(false)
  const [isDeleting, setIsDeleting] = useState(false)
  const [isCopying, setIsCopying] = useState(false)

  const handleCopy = async () => {
    setIsCopying(true)
    const result = await copySystemTemplate(template.id)
    setIsCopying(false)

    if (result.success) {
      toast.success('Template copied!', {
        description: 'You can now edit your copy.',
      })
      router.refresh()
    } else {
      toast.error('Failed to copy template', {
        description: result.error,
      })
    }
  }

  const handleDelete = async () => {
    if (!confirm('Are you sure you want to delete this template?')) {
      return
    }

    setIsDeleting(true)
    const result = await deleteMessageTemplate(template.id)
    setIsDeleting(false)

    if (result.success) {
      toast.success('Template deleted')
      router.refresh()
    } else {
      toast.error('Failed to delete template', {
        description: result.error,
      })
    }
  }

  const ChannelIcon = template.channel === 'email' ? EnvelopeSimple : ChatCircle
  const channelLabel = template.channel === 'email' ? 'Email' : 'SMS'
  const channelColor = template.channel === 'email'
    ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300'
    : 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300'

  return (
    <div className="border border-border rounded-lg bg-card overflow-hidden">
      {/* Header row */}
      <div className="flex items-center justify-between px-4 py-3">
        <div className="flex items-center gap-3 min-w-0">
          {/* Channel badge */}
          <span className={cn(
            'inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium shrink-0',
            channelColor
          )}>
            <ChannelIcon size={14} weight="bold" />
            {channelLabel}
          </span>

          {/* Template name */}
          <span className="font-medium text-foreground truncate">
            {template.name}
          </span>

          {/* System badge */}
          {template.is_default && (
            <span className="text-xs bg-primary/10 text-primary px-2 py-0.5 rounded shrink-0">
              System
            </span>
          )}
        </div>

        {/* Actions */}
        <div className="flex items-center gap-2 shrink-0">
          {template.is_default ? (
            <button
              onClick={handleCopy}
              disabled={isCopying}
              className="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-primary hover:bg-primary/10 rounded-md transition-colors disabled:opacity-50"
            >
              <Copy size={14} />
              {isCopying ? 'Copying...' : 'Use this template'}
            </button>
          ) : (
            <button
              onClick={handleDelete}
              disabled={isDeleting}
              className="inline-flex items-center gap-1 px-2 py-1.5 text-xs text-red-600 hover:bg-red-50 dark:hover:bg-red-950 rounded-md transition-colors disabled:opacity-50"
            >
              <Trash size={14} />
              {isDeleting ? 'Deleting...' : 'Delete'}
            </button>
          )}

          {/* Expand toggle */}
          <button
            onClick={() => setIsExpanded(!isExpanded)}
            className="p-1.5 hover:bg-muted rounded-md transition-colors"
            aria-label={isExpanded ? 'Collapse' : 'Expand'}
          >
            <CaretDown
              size={16}
              className={cn(
                'transition-transform',
                isExpanded && 'rotate-180'
              )}
            />
          </button>
        </div>
      </div>

      {/* Expanded content */}
      {isExpanded && (
        <div className="px-4 py-3 border-t border-border bg-muted/30">
          {template.channel === 'email' && template.subject && (
            <div className="mb-2">
              <span className="text-xs font-medium text-muted-foreground">Subject:</span>
              <p className="text-sm text-foreground">{template.subject}</p>
            </div>
          )}
          <div>
            <span className="text-xs font-medium text-muted-foreground">
              {template.channel === 'email' ? 'Body:' : 'Message:'}
            </span>
            <pre className="mt-1 p-3 bg-background border border-border rounded text-xs whitespace-pre-wrap font-mono text-foreground max-h-48 overflow-auto">
              {template.body}
            </pre>
          </div>
        </div>
      )}
    </div>
  )
}
```
  </action>
  <verify>Run `pnpm typecheck` - no errors. Component shows channel badge and appropriate actions.</verify>
  <done>Template list item component created with channel badge and copy/delete actions</done>
</task>

<task type="auto">
  <name>Task 2: Update template-list.tsx for message templates</name>
  <files>components/template-list.tsx</files>
  <action>
Update components/template-list.tsx to use MessageTemplate type and group by channel:

```typescript
import type { MessageTemplate } from '@/lib/types/database'
import { TemplateListItem } from './templates/template-list-item'

interface TemplateListProps {
  templates: MessageTemplate[]
}

export function TemplateList({ templates }: TemplateListProps) {
  if (templates.length === 0) {
    return (
      <p className="text-muted-foreground italic">
        No templates yet. Create one below or use a system default when available.
      </p>
    )
  }

  // Group templates by channel
  const emailTemplates = templates.filter(t => t.channel === 'email')
  const smsTemplates = templates.filter(t => t.channel === 'sms')

  return (
    <div className="space-y-6">
      {/* Email Templates */}
      {emailTemplates.length > 0 && (
        <div>
          <h4 className="text-sm font-medium text-muted-foreground mb-3">
            Email Templates ({emailTemplates.length})
          </h4>
          <div className="space-y-2">
            {emailTemplates.map((template) => (
              <TemplateListItem key={template.id} template={template} />
            ))}
          </div>
        </div>
      )}

      {/* SMS Templates */}
      {smsTemplates.length > 0 && (
        <div>
          <h4 className="text-sm font-medium text-muted-foreground mb-3">
            SMS Templates ({smsTemplates.length})
          </h4>
          <div className="space-y-2">
            {smsTemplates.map((template) => (
              <TemplateListItem key={template.id} template={template} />
            ))}
          </div>
        </div>
      )}
    </div>
  )
}
```

This replaces the old implementation. Key changes:
- Uses MessageTemplate type (has channel field)
- Groups templates by channel (email/sms sections)
- Uses TemplateListItem for individual template display
- Shows count per channel
  </action>
  <verify>Run `pnpm typecheck` - no errors. List groups templates correctly.</verify>
  <done>Template list updated to group by channel and use new components</done>
</task>

<task type="auto">
  <name>Task 3: Update settings page to use message templates</name>
  <files>app/dashboard/settings/page.tsx</files>
  <action>
Update app/dashboard/settings/page.tsx to:
1. Import and use MessageTemplateForm instead of EmailTemplateForm
2. Fetch from message_templates table instead of email_templates
3. Update types to MessageTemplate

Key changes:

1. Update imports:
```typescript
import { MessageTemplateForm } from '@/components/templates/message-template-form'
import { TemplateList } from '@/components/template-list'
// Remove: import { EmailTemplateForm } from '@/components/email-template-form'
import type { MessageTemplate } from '@/lib/types/database'
```

2. Update data fetching in SettingsContent:
```typescript
// Get templates from message_templates table
let templates: MessageTemplate[] = []
if (business) {
  const { data } = await supabase
    .from('message_templates')
    .select('*')
    .eq('business_id', business.id)
    .order('channel', { ascending: true })  // Email first, then SMS
    .order('is_default', { ascending: false })
    .order('created_at', { ascending: true })
  templates = data || []
}
```

3. Update template section title and description:
```tsx
{/* Section 2: Message Templates */}
<section className="border border-border rounded-lg p-6 bg-card shadow-sm">
  <h2 className="text-xl font-semibold mb-4">Message Templates</h2>
  <p className="text-muted-foreground mb-4">
    Create email and SMS templates for your review requests. Use variables like
    {' '}{'{{CUSTOMER_NAME}}'}, {'{{BUSINESS_NAME}}'}, {'{{REVIEW_LINK}}'}, {'{{SENDER_NAME}}'}.
  </p>

  {/* Show existing templates */}
  <TemplateList templates={templates} />

  {/* Only show template form if business exists */}
  {business && (
    <div className="mt-6 pt-6 border-t">
      <h3 className="text-lg font-medium mb-4">Create New Template</h3>
      <MessageTemplateForm />
    </div>
  )}

  {!business && (
    <p className="text-amber-600 text-sm mt-4">
      Save your business profile above before creating templates.
    </p>
  )}
</section>
```

4. Keep business query using email_templates FK for now (backward compat view):
```typescript
// Use explicit FK hint to resolve ambiguity from circular relationship
const { data: business } = await supabase
  .from('businesses')
  .select(`
    *,
    email_templates!email_templates_business_id_fkey (
      id,
      name,
      subject,
      body,
      is_default,
      created_at
    )
  `)
  .eq('user_id', user.id)
  .single()
```

The email_templates view still works for the business query join. The templates variable is fetched separately from message_templates.
  </action>
  <verify>Run `pnpm typecheck` and `pnpm lint` - no errors. Settings page renders with new form and list.</verify>
  <done>Settings page updated to use MessageTemplateForm and fetch from message_templates</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `pnpm typecheck` - no type errors
2. Run `pnpm lint` - no lint errors
3. Run `pnpm dev` and visit /settings
4. Template list shows channel badges (Email/SMS)
5. Template list groups by channel
6. Create Template form has Email/SMS tabs
7. System templates show "Use this template" button
8. User templates show "Delete" button
</verification>

<success_criteria>
- Settings page compiles without errors
- Template list displays with channel grouping
- MessageTemplateForm replaces EmailTemplateForm
- Channel badges visible (blue for email, green for SMS)
- System vs user template actions work correctly
- Dark mode styling preserved
</success_criteria>

<output>
After completion, create `.planning/phases/23-message-templates-migration/23-06-SUMMARY.md`
</output>
