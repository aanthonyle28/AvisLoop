---
phase: 23-message-templates-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260203_rename_to_message_templates.sql
  - docs/DATA_MODEL.md
autonomous: true

must_haves:
  truths:
    - "email_templates table renamed to message_templates"
    - "All existing email templates migrated with channel = 'email'"
    - "16 system default templates exist (8 service types x 2 channels)"
    - "RLS policies enforced on message_templates table"
    - "Backup table exists for rollback safety"
  artifacts:
    - path: "supabase/migrations/20260203_rename_to_message_templates.sql"
      provides: "Database migration for table rename and defaults"
      contains: "ALTER TABLE email_templates RENAME TO message_templates"
    - path: "docs/DATA_MODEL.md"
      provides: "Updated data model documentation"
      contains: "message_templates"
  key_links:
    - from: "message_templates.business_id"
      to: "businesses.id"
      via: "Foreign key constraint"
      pattern: "REFERENCES.*businesses.*id"
---

<objective>
Migrate email_templates table to unified message_templates table supporting both email and SMS channels.

Purpose: Enable multi-channel messaging (email + SMS) using a single table with channel discriminator, supporting Phase 24 campaigns.
Output: Database migration with renamed table, channel column, RLS policies, and 16 default templates inserted.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-message-templates-migration/23-CONTEXT.md
@.planning/phases/23-message-templates-migration/23-RESEARCH.md
@supabase/migrations/00002_create_business.sql
@docs/DATA_MODEL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for table rename and channel column</name>
  <files>supabase/migrations/20260203_rename_to_message_templates.sql</files>
  <action>
Create migration file with the following steps (all in single transaction):

1. Create backup table for rollback safety:
   ```sql
   CREATE TABLE IF NOT EXISTS email_templates_backup AS SELECT * FROM email_templates;
   ```

2. Rename table (instantaneous, no data copy):
   ```sql
   ALTER TABLE email_templates RENAME TO message_templates;
   ```

3. Add channel discriminator column with default 'email' for existing rows:
   ```sql
   ALTER TABLE message_templates
     ADD COLUMN channel TEXT NOT NULL DEFAULT 'email'
     CHECK (channel IN ('email', 'sms'));
   -- Remove default after migration (new rows must specify channel)
   ALTER TABLE message_templates ALTER COLUMN channel DROP DEFAULT;
   ```

4. Add service_type column for linking templates to service categories:
   ```sql
   ALTER TABLE message_templates
     ADD COLUMN service_type TEXT
     CHECK (service_type IS NULL OR service_type IN ('hvac', 'plumbing', 'electrical', 'cleaning', 'roofing', 'painting', 'handyman', 'other'));
   ```

5. Make business_id NULLABLE for system templates (system templates have is_default=true and business_id=NULL):
   ```sql
   ALTER TABLE message_templates ALTER COLUMN business_id DROP NOT NULL;
   ```

6. Create backward-compatible view (simple SELECT is auto-updatable in PG 9.3+):
   ```sql
   CREATE VIEW email_templates AS
     SELECT id, business_id, name, subject, body, is_default, created_at, updated_at
     FROM message_templates
     WHERE channel = 'email';
   ```

7. Drop old RLS policies and recreate on message_templates:
   - Drop: "Users view own templates", "Users insert own templates", "Users update own templates", "Users delete own templates"
   - Recreate all 4 policies on message_templates using same business_id subquery pattern
   - Add policy for reading system templates: users can SELECT where is_default = true

8. Update indexes:
   ```sql
   DROP INDEX IF EXISTS idx_email_templates_business_id;
   CREATE INDEX idx_message_templates_business_id ON message_templates(business_id);
   CREATE INDEX idx_message_templates_channel ON message_templates(channel);
   CREATE INDEX idx_message_templates_is_default ON message_templates(is_default) WHERE is_default = true;
   ```

9. Recreate moddatetime trigger on renamed table:
   ```sql
   DROP TRIGGER IF EXISTS templates_updated_at ON email_templates;
   CREATE TRIGGER message_templates_updated_at
     BEFORE UPDATE ON message_templates
     FOR EACH ROW EXECUTE FUNCTION extensions.moddatetime(updated_at);
   ```

Use BEGIN/COMMIT transaction wrapper for atomicity.
  </action>
  <verify>
Run `supabase db reset` locally. Check:
- Table `message_templates` exists with `channel` column
- View `email_templates` exists and returns only email templates
- RLS policies exist on `message_templates` (check via `\dp message_templates` in psql)
- Backup table `email_templates_backup` exists
  </verify>
  <done>Migration runs without errors, table renamed, channel column added, RLS enforced</done>
</task>

<task type="auto">
  <name>Task 2: Insert 16 default system templates into database</name>
  <files>supabase/migrations/20260203_rename_to_message_templates.sql</files>
  <action>
Add to the same migration file (after schema changes), INSERT the 16 system default templates.

System templates have:
- business_id = NULL (shared across all businesses)
- is_default = true
- Specific service_type for each template

Insert the following 16 templates:

**EMAIL templates (8 service types):**

```sql
INSERT INTO message_templates (business_id, name, channel, service_type, subject, body, is_default) VALUES
-- HVAC
(NULL, 'HVAC Service Review', 'email', 'hvac',
 'How was your AC/heating service, {{CUSTOMER_NAME}}?',
 E'Hi {{CUSTOMER_NAME}},\n\nThank you for choosing {{BUSINESS_NAME}} for your HVAC service! We hope your home is now perfectly comfortable.\n\nWe''d love to hear about your experience. Your feedback helps us continue providing excellent heating and cooling services.\n\nLeave a review here: {{REVIEW_LINK}}\n\nThanks for your trust in us,\n{{SENDER_NAME}}',
 true),

-- Plumbing
(NULL, 'Plumbing Service Review', 'email', 'plumbing',
 'Quick feedback on your plumbing service?',
 E'Hi {{CUSTOMER_NAME}},\n\nThank you for trusting {{BUSINESS_NAME}} with your plumbing needs! We hope everything is flowing smoothly now.\n\nYour feedback means a lot to us and helps other homeowners find reliable plumbing service.\n\nShare your experience: {{REVIEW_LINK}}\n\nThanks for choosing us,\n{{SENDER_NAME}}',
 true),

-- Electrical
(NULL, 'Electrical Service Review', 'email', 'electrical',
 'Your electrical work is complete - quick question?',
 E'Hi {{CUSTOMER_NAME}},\n\nThank you for choosing {{BUSINESS_NAME}} for your electrical work! Your safety and satisfaction are our top priorities.\n\nWe''d appreciate hearing about your experience. Your review helps us maintain the highest standards.\n\nLeave a review here: {{REVIEW_LINK}}\n\nBest regards,\n{{SENDER_NAME}}',
 true),

-- Cleaning
(NULL, 'Cleaning Service Review', 'email', 'cleaning',
 'Sparkling clean! How did we do?',
 E'Hi {{CUSTOMER_NAME}},\n\nWe hope your space is looking and feeling fresh after our visit! Thank you for choosing {{BUSINESS_NAME}}.\n\nWe pay attention to every detail, and your feedback helps us keep improving.\n\nShare your thoughts: {{REVIEW_LINK}}\n\nThank you,\n{{SENDER_NAME}}',
 true),

-- Roofing
(NULL, 'Roofing Service Review', 'email', 'roofing',
 'Roof work finished - your thoughts?',
 E'Hi {{CUSTOMER_NAME}},\n\nThank you for trusting {{BUSINESS_NAME}} with your roof! We take pride in protecting your home with quality workmanship.\n\nYour feedback helps other homeowners make informed decisions about their roofing needs.\n\nLeave a review: {{REVIEW_LINK}}\n\nBest regards,\n{{SENDER_NAME}}',
 true),

-- Painting
(NULL, 'Painting Service Review', 'email', 'painting',
 'Fresh paint! How does it look?',
 E'Hi {{CUSTOMER_NAME}},\n\nWe hope you''re enjoying your freshly painted space! Thank you for choosing {{BUSINESS_NAME}} to transform your home.\n\nYour review helps us continue delivering beautiful results for homeowners like you.\n\nShare your experience: {{REVIEW_LINK}}\n\nThank you,\n{{SENDER_NAME}}',
 true),

-- Handyman
(NULL, 'Handyman Service Review', 'email', 'handyman',
 'Your repairs are done - how did we do?',
 E'Hi {{CUSTOMER_NAME}},\n\nThank you for calling {{BUSINESS_NAME}} to get things done! We hope everything is working just as it should.\n\nYour feedback helps us continue providing dependable handyman services.\n\nLeave a review: {{REVIEW_LINK}}\n\nThanks again,\n{{SENDER_NAME}}',
 true),

-- Other
(NULL, 'Service Review Request', 'email', 'other',
 'We''d love your feedback!',
 E'Hi {{CUSTOMER_NAME}},\n\nThank you for choosing {{BUSINESS_NAME}}! We appreciate your trust in our services.\n\nYour feedback is valuable and helps us serve you and others better.\n\nShare your experience: {{REVIEW_LINK}}\n\nBest regards,\n{{SENDER_NAME}}',
 true);
```

**SMS templates (8 service types):**

```sql
INSERT INTO message_templates (business_id, name, channel, service_type, subject, body, is_default) VALUES
-- HVAC (138 chars)
(NULL, 'HVAC Service SMS', 'sms', 'hvac', '',
 'Hi {{CUSTOMER_NAME}}, thanks for choosing {{BUSINESS_NAME}} for HVAC! We''d love your feedback. Reply YES for review link.',
 true),

-- Plumbing (134 chars)
(NULL, 'Plumbing Service SMS', 'sms', 'plumbing', '',
 'Hi {{CUSTOMER_NAME}}, your plumbing work is done! How''d we do? Reply YES to share feedback on {{BUSINESS_NAME}}.',
 true),

-- Electrical (140 chars)
(NULL, 'Electrical Service SMS', 'sms', 'electrical', '',
 'Hi {{CUSTOMER_NAME}}, electrical work complete! Your feedback helps us serve you better. Reply YES for review link - {{BUSINESS_NAME}}',
 true),

-- Cleaning (133 chars)
(NULL, 'Cleaning Service SMS', 'sms', 'cleaning', '',
 'Hi {{CUSTOMER_NAME}}, hope your space is sparkling! Quick feedback on {{BUSINESS_NAME}}? Reply YES for review link.',
 true),

-- Roofing (131 chars)
(NULL, 'Roofing Service SMS', 'sms', 'roofing', '',
 'Hi {{CUSTOMER_NAME}}, roof work finished! We''d appreciate your thoughts on {{BUSINESS_NAME}}. Reply YES for review link.',
 true),

-- Painting (123 chars)
(NULL, 'Painting Service SMS', 'sms', 'painting', '',
 'Hi {{CUSTOMER_NAME}}, fresh paint done! How does it look? Reply YES to share feedback on {{BUSINESS_NAME}}.',
 true),

-- Handyman (114 chars)
(NULL, 'Handyman Service SMS', 'sms', 'handyman', '',
 'Hi {{CUSTOMER_NAME}}, repairs complete! How''d {{BUSINESS_NAME}} do? Reply YES for review link.',
 true),

-- Other (119 chars)
(NULL, 'Service SMS', 'sms', 'other', '',
 'Hi {{CUSTOMER_NAME}}, thanks for choosing {{BUSINESS_NAME}}! We''d love your feedback. Reply YES for review link.',
 true);
```

These 16 templates are inserted as system defaults (is_default=true, business_id=NULL) and are accessible to all businesses via RLS policy.
  </action>
  <verify>
After running `supabase db reset`, execute:
```sql
SELECT COUNT(*) FROM message_templates WHERE is_default = true;
```
Should return 16.

Also verify channel distribution:
```sql
SELECT channel, COUNT(*) FROM message_templates WHERE is_default = true GROUP BY channel;
```
Should show: email=8, sms=8.
  </verify>
  <done>16 default templates inserted into message_templates with is_default=true and business_id=NULL</done>
</task>

<task type="auto">
  <name>Task 3: Update DATA_MODEL.md with message_templates schema</name>
  <files>docs/DATA_MODEL.md</files>
  <action>
Add new section to DATA_MODEL.md documenting message_templates table:

## Table: message_templates

Unified template storage for email and SMS review request messages. Replaces email_templates (view exists for backward compatibility).

### Schema

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | UUID | NO | gen_random_uuid() | Primary key |
| business_id | UUID | YES | - | FK to businesses (NULL for system templates) |
| name | TEXT | NO | - | Template name |
| subject | TEXT | NO | - | Email subject (empty for SMS) |
| body | TEXT | NO | - | Message body |
| channel | TEXT | NO | - | 'email' or 'sms' |
| service_type | TEXT | YES | - | Service category (hvac, plumbing, etc.) |
| is_default | BOOLEAN | NO | false | System template flag |
| created_at | TIMESTAMPTZ | YES | NOW() | Created timestamp |
| updated_at | TIMESTAMPTZ | YES | NOW() | Updated timestamp |

### Channel Discriminator

- `email`: Full email template with subject + body
- `sms`: SMS message with body only (subject should be empty string)

### System Templates

- 16 default system templates (8 service types x 2 channels)
- System templates have `business_id = NULL` and `is_default = true`
- All users can read system templates (RLS policy)
- Users cannot modify or delete system templates
- "Use this template" creates an editable copy for the business

### Constraints

- `channel IN ('email', 'sms')` - CHECK constraint
- `service_type IN ('hvac', 'plumbing', 'electrical', 'cleaning', 'roofing', 'painting', 'handyman', 'other')` - CHECK constraint (nullable)
- `name` minimum 1 character
- `subject` minimum 1 character (for email)
- `body` minimum 1 character

### RLS Policies

- Users can view their own templates (business_id matches)
- Users can view system templates (is_default = true)
- Users can only insert/update/delete their own templates (not system templates)

### Indexes

- idx_message_templates_business_id (btree)
- idx_message_templates_channel (btree)
- idx_message_templates_is_default (partial: WHERE is_default = true)

### Compatibility

- View `email_templates` exists for backward compatibility during migration window
- View filters to `WHERE channel = 'email'`
- Remove view in Phase 25 after all code updated
  </action>
  <verify>DATA_MODEL.md contains message_templates section with schema, constraints, RLS, and default templates info</verify>
  <done>Documentation updated with complete message_templates schema</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `supabase db reset` - migration applies cleanly
2. Query `SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'message_templates'` - shows id, business_id, name, subject, body, channel, service_type, is_default, created_at, updated_at
3. Query `SELECT * FROM email_templates LIMIT 1` - view works
4. Query `SELECT COUNT(*) FROM message_templates WHERE is_default = true` - returns 16
5. Check RLS: `SELECT policyname FROM pg_policies WHERE tablename = 'message_templates'` - shows policies including system template read access
</verification>

<success_criteria>
- Migration file exists and runs without errors
- message_templates table has channel column with CHECK constraint
- email_templates view filters to channel = 'email'
- All 4 RLS policies recreated on message_templates
- 16 system default templates exist in database (is_default=true)
- Backup table exists for rollback
- DATA_MODEL.md documents new schema
</success_criteria>

<output>
After completion, create `.planning/phases/23-message-templates-migration/23-01-SUMMARY.md`
</output>
