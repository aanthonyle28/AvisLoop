---
phase: 23-message-templates-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260203_rename_to_message_templates.sql
  - docs/DATA_MODEL.md
autonomous: true

must_haves:
  truths:
    - "email_templates table renamed to message_templates"
    - "All existing email templates migrated with channel = 'email'"
    - "16 system default templates exist (8 service types x 2 channels)"
    - "RLS policies enforced on message_templates table"
    - "Backup table exists for rollback safety"
  artifacts:
    - path: "supabase/migrations/20260203_rename_to_message_templates.sql"
      provides: "Database migration for table rename and defaults"
      contains: "ALTER TABLE email_templates RENAME TO message_templates"
    - path: "docs/DATA_MODEL.md"
      provides: "Updated data model documentation"
      contains: "message_templates"
  key_links:
    - from: "message_templates.business_id"
      to: "businesses.id"
      via: "Foreign key constraint"
      pattern: "REFERENCES.*businesses.*id"
---

<objective>
Migrate email_templates table to unified message_templates table supporting both email and SMS channels.

Purpose: Enable multi-channel messaging (email + SMS) using a single table with channel discriminator, supporting Phase 24 campaigns.
Output: Database migration with renamed table, channel column, RLS policies, and 16 default templates.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-message-templates-migration/23-CONTEXT.md
@.planning/phases/23-message-templates-migration/23-RESEARCH.md
@supabase/migrations/00002_create_business.sql
@docs/DATA_MODEL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for table rename and channel column</name>
  <files>supabase/migrations/20260203_rename_to_message_templates.sql</files>
  <action>
Create migration file with the following steps (all in single transaction):

1. Create backup table for rollback safety:
   ```sql
   CREATE TABLE IF NOT EXISTS email_templates_backup AS SELECT * FROM email_templates;
   ```

2. Rename table (instantaneous, no data copy):
   ```sql
   ALTER TABLE email_templates RENAME TO message_templates;
   ```

3. Add channel discriminator column with default 'email' for existing rows:
   ```sql
   ALTER TABLE message_templates
     ADD COLUMN channel TEXT NOT NULL DEFAULT 'email'
     CHECK (channel IN ('email', 'sms'));
   -- Remove default after migration (new rows must specify channel)
   ALTER TABLE message_templates ALTER COLUMN channel DROP DEFAULT;
   ```

4. Create backward-compatible view (simple SELECT is auto-updatable in PG 9.3+):
   ```sql
   CREATE VIEW email_templates AS
     SELECT id, business_id, name, subject, body, is_default, created_at, updated_at
     FROM message_templates
     WHERE channel = 'email';
   ```

5. Drop old RLS policies and recreate on message_templates:
   - Drop: "Users view own templates", "Users insert own templates", "Users update own templates", "Users delete own templates"
   - Recreate all 4 policies on message_templates using same business_id subquery pattern

6. Update indexes:
   ```sql
   DROP INDEX IF EXISTS idx_email_templates_business_id;
   CREATE INDEX idx_message_templates_business_id ON message_templates(business_id);
   CREATE INDEX idx_message_templates_channel ON message_templates(channel);
   ```

7. Recreate moddatetime trigger on renamed table:
   ```sql
   DROP TRIGGER IF EXISTS templates_updated_at ON email_templates;
   CREATE TRIGGER message_templates_updated_at
     BEFORE UPDATE ON message_templates
     FOR EACH ROW EXECUTE FUNCTION extensions.moddatetime(updated_at);
   ```

Use BEGIN/COMMIT transaction wrapper for atomicity.
  </action>
  <verify>
Run `supabase db reset` locally. Check:
- Table `message_templates` exists with `channel` column
- View `email_templates` exists and returns only email templates
- RLS policies exist on `message_templates` (check via `\dp message_templates` in psql)
- Backup table `email_templates_backup` exists
  </verify>
  <done>Migration runs without errors, table renamed, channel column added, RLS enforced</done>
</task>

<task type="auto">
  <name>Task 2: Insert 16 default system templates</name>
  <files>supabase/migrations/20260203_rename_to_message_templates.sql</files>
  <action>
Add to the same migration file (after schema changes), insert 16 default templates.

NOTE: System templates need a business_id but we want them available to all businesses.
Strategy: Create a "system" business record for system templates, or insert with NULL business_id and relax constraint.

Preferred approach: Insert templates without business_id by temporarily dropping NOT NULL constraint, then restore it. Actually, per the existing pattern in 00002, system templates are stored in code and cloned on business creation.

REVISED APPROACH: Insert system templates as a seed data INSERT that runs on business creation trigger or application code. For now, document the 16 templates in the migration as comments (same as existing pattern) and add them to application code in Plan 02.

Add SQL comments documenting all 16 templates:

**EMAIL templates (8 service types):**
- hvac: Subject "How was your AC/heating service?" - Professional, emphasize comfort
- plumbing: Subject "Quick feedback on your plumbing service?" - Urgent, reliability
- electrical: Subject "Your electrical work is complete - quick question?" - Safety, expertise
- cleaning: Subject "Sparkling clean! How did we do?" - Attention to detail
- roofing: Subject "Roof work finished - your thoughts?" - Quality, protection
- painting: Subject "Fresh paint! How does it look?" - Transformation, aesthetic
- handyman: Subject "Your repairs are done - how'd we do?" - Versatility, helpfulness
- other: Subject "We'd love your feedback!" - Generic, friendly

**SMS templates (8 service types):**
Keep under 140 chars (reserve 20 for opt-out footer). No URL in body (too long).
- hvac: "Hi {{CUSTOMER_NAME}}, thanks for choosing {{BUSINESS_NAME}} for your HVAC service! We'd love your feedback. Reply YES for review link."
- plumbing: "Hi {{CUSTOMER_NAME}}, your plumbing work is done! How'd we do? Reply YES to share your feedback on {{BUSINESS_NAME}}."
- electrical: "Hi {{CUSTOMER_NAME}}, electrical work complete! Your feedback helps us serve you better. Reply YES for review link - {{BUSINESS_NAME}}"
- cleaning: "Hi {{CUSTOMER_NAME}}, hope your space is sparkling! Quick feedback on {{BUSINESS_NAME}}? Reply YES for review link."
- roofing: "Hi {{CUSTOMER_NAME}}, roof work finished! We'd appreciate your thoughts on {{BUSINESS_NAME}}. Reply YES for review link."
- painting: "Hi {{CUSTOMER_NAME}}, fresh paint done! How does it look? Reply YES to share feedback on {{BUSINESS_NAME}}."
- handyman: "Hi {{CUSTOMER_NAME}}, repairs complete! How'd {{BUSINESS_NAME}} do? Reply YES for review link."
- other: "Hi {{CUSTOMER_NAME}}, thanks for choosing {{BUSINESS_NAME}}! We'd love your feedback. Reply YES for review link."

Document these in SQL comments. Actual insertion happens in lib/constants in Plan 02.
  </action>
  <verify>Migration file contains SQL comments documenting all 16 templates with appropriate tone per service type</verify>
  <done>16 default templates documented in migration, ready for code insertion in Plan 02</done>
</task>

<task type="auto">
  <name>Task 3: Update DATA_MODEL.md with message_templates schema</name>
  <files>docs/DATA_MODEL.md</files>
  <action>
Add new section to DATA_MODEL.md documenting message_templates table:

## Table: message_templates

Unified template storage for email and SMS review request messages. Replaces email_templates (view exists for backward compatibility).

### Schema

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | UUID | NO | gen_random_uuid() | Primary key |
| business_id | UUID | NO | - | FK to businesses |
| name | TEXT | NO | - | Template name |
| subject | TEXT | NO | - | Email subject (empty for SMS) |
| body | TEXT | NO | - | Message body |
| channel | TEXT | NO | - | 'email' or 'sms' |
| is_default | BOOLEAN | NO | false | System template flag |
| created_at | TIMESTAMPTZ | YES | NOW() | Created timestamp |
| updated_at | TIMESTAMPTZ | YES | NOW() | Updated timestamp |

### Channel Discriminator

- `email`: Full email template with subject + body
- `sms`: SMS message with body only (subject should be empty string)

### Constraints

- `channel IN ('email', 'sms')` - CHECK constraint
- `name` minimum 1 character
- `subject` minimum 1 character (for email)
- `body` minimum 1 character

### RLS Policies

Same pattern as before - users can only view/insert/update/delete templates for businesses they own.

### Compatibility

- View `email_templates` exists for backward compatibility during migration window
- View filters to `WHERE channel = 'email'`
- Remove view in Phase 25 after all code updated

### Default Templates

16 system default templates (8 service types x 2 channels):
- Inserted on business creation via application code
- `is_default = true` for system templates
- Users can create copies via "Use this template" flow
  </action>
  <verify>DATA_MODEL.md contains message_templates section with schema, constraints, RLS, and default templates info</verify>
  <done>Documentation updated with complete message_templates schema</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `supabase db reset` - migration applies cleanly
2. Query `SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'message_templates'` - shows id, business_id, name, subject, body, channel, is_default, created_at, updated_at
3. Query `SELECT * FROM email_templates LIMIT 1` - view works
4. Check RLS: `SELECT policyname FROM pg_policies WHERE tablename = 'message_templates'` - shows 4 policies
</verification>

<success_criteria>
- Migration file exists and runs without errors
- message_templates table has channel column with CHECK constraint
- email_templates view filters to channel = 'email'
- All 4 RLS policies recreated on message_templates
- Backup table exists for rollback
- DATA_MODEL.md documents new schema
</success_criteria>

<output>
After completion, create `.planning/phases/23-message-templates-migration/23-01-SUMMARY.md`
</output>
