---
phase: 23-message-templates-migration
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - lib/types/database.ts
  - lib/validations/message-template.ts
  - lib/constants/default-templates.ts
autonomous: true

must_haves:
  truths:
    - "MessageTemplate type supports both email and SMS channels"
    - "Zod schema uses discriminated union for channel-specific validation"
    - "Default templates defined in constants file match database inserts"
  artifacts:
    - path: "lib/types/database.ts"
      provides: "MessageTemplate type definition"
      contains: "interface MessageTemplate"
    - path: "lib/validations/message-template.ts"
      provides: "Zod validation schema with discriminated union"
      contains: "discriminatedUnion"
    - path: "lib/constants/default-templates.ts"
      provides: "16 default templates (8 service types x 2 channels)"
      min_lines: 100
  key_links:
    - from: "lib/constants/default-templates.ts"
      to: "message_templates table"
      via: "matching template definitions"
      pattern: "service_type.*hvac|plumbing|electrical"
---

<objective>
Create TypeScript types, Zod validations, and constants for unified message templates.

Purpose: Enable type-safe operations for both email and SMS templates with proper validation.
Output: Complete TypeScript types and validation layer for message_templates table.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-message-templates-migration/23-CONTEXT.md
@.planning/phases/23-message-templates-migration/23-RESEARCH.md
@lib/types/database.ts
@lib/validations/business.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MessageTemplate types to database.ts</name>
  <files>lib/types/database.ts</files>
  <action>
Add MessageTemplate interface and related types to lib/types/database.ts:

```typescript
// Message channel literal union
export type MessageChannel = 'email' | 'sms'

// Unified message template supporting both email and SMS
export interface MessageTemplate {
  id: string
  business_id: string | null  // NULL for system templates
  name: string
  subject: string        // Required for email, empty string for SMS
  body: string
  channel: MessageChannel
  service_type: ServiceType | null  // Links to service category
  is_default: boolean
  created_at: string
  updated_at: string
}

// Insert type (omit auto-generated fields)
export type MessageTemplateInsert = Omit<MessageTemplate, 'id' | 'created_at' | 'updated_at'>

// Update type (partial, omit immutable fields)
export type MessageTemplateUpdate = Partial<Omit<MessageTemplate, 'id' | 'business_id' | 'created_at' | 'updated_at'>>

// Combined type for business with nested templates
export interface BusinessWithMessageTemplates extends Business {
  message_templates: MessageTemplate[]
}
```

Keep existing EmailTemplate type for backward compatibility but add deprecation comment:
```typescript
/** @deprecated Use MessageTemplate with channel='email' instead */
export interface EmailTemplate { ... }
```

Update BusinessWithTemplates to use MessageTemplate:
```typescript
export interface BusinessWithTemplates extends Business {
  email_templates: EmailTemplate[]  // Keep for backward compat
  message_templates?: MessageTemplate[]  // New unified templates
}
```
  </action>
  <verify>Run `pnpm typecheck` - no type errors related to MessageTemplate</verify>
  <done>MessageTemplate interface added with channel discriminator, service_type, insert/update types, deprecation on EmailTemplate</done>
</task>

<task type="auto">
  <name>Task 2: Create message-template.ts validation schema</name>
  <files>lib/validations/message-template.ts</files>
  <action>
Create new file lib/validations/message-template.ts with Zod discriminated union schema:

```typescript
import { z } from 'zod'

// Service types matching database constraint
const serviceTypes = ['hvac', 'plumbing', 'electrical', 'cleaning', 'roofing', 'painting', 'handyman', 'other'] as const

// Base fields shared by both channels
const baseTemplateFields = {
  name: z
    .string()
    .min(1, 'Template name is required')
    .max(100, 'Template name must be less than 100 characters')
    .trim(),
  service_type: z.enum(serviceTypes).nullable().optional(),
}

// Email template schema
const emailTemplateSchema = z.object({
  ...baseTemplateFields,
  channel: z.literal('email'),
  subject: z
    .string()
    .min(1, 'Email subject is required')
    .max(200, 'Subject must be less than 200 characters')
    .trim(),
  body: z
    .string()
    .min(1, 'Email body is required')
    .max(5000, 'Body must be less than 5000 characters')
    .trim(),
})

// SMS template schema (soft limit on body, allow multi-segment)
const smsTemplateSchema = z.object({
  ...baseTemplateFields,
  channel: z.literal('sms'),
  subject: z.literal('').optional().default(''), // SMS has no subject
  body: z
    .string()
    .min(1, 'SMS body is required')
    .max(320, 'SMS body too long (max 2 segments)') // Soft limit
    .trim(),
})

// Discriminated union - validates based on channel value
export const messageTemplateSchema = z.discriminatedUnion('channel', [
  emailTemplateSchema,
  smsTemplateSchema,
])

// Type exports
export type MessageTemplateInput = z.infer<typeof messageTemplateSchema>
export type EmailTemplateSchemaInput = z.infer<typeof emailTemplateSchema>
export type SMSTemplateSchemaInput = z.infer<typeof smsTemplateSchema>

// Re-export individual schemas for direct use if needed
export { emailTemplateSchema, smsTemplateSchema }
```

Key points:
- Uses z.discriminatedUnion for efficient parsing based on channel
- SMS has soft limit (320 chars = 2 segments max) with warning, not hard block
- SMS subject is empty string (not null) to satisfy DB constraint
  </action>
  <verify>Run `pnpm typecheck` - message-template.ts compiles without errors</verify>
  <done>Zod discriminated union schema created for email and SMS validation</done>
</task>

<task type="auto">
  <name>Task 3: Create default-templates.ts constants file</name>
  <files>lib/constants/default-templates.ts</files>
  <action>
Create new file lib/constants/default-templates.ts with all 16 default templates.

NOTE: These constants mirror the database INSERT in Plan 01 Task 2 and are used for:
- UI display of default templates
- Template copy operations
- Fallback if database query fails

Use the following structure:
```typescript
import type { MessageChannel, ServiceType } from '@/lib/types/database'

export interface DefaultTemplate {
  name: string
  channel: MessageChannel
  service_type: ServiceType
  subject: string  // Empty string for SMS
  body: string
}

export const DEFAULT_TEMPLATES: DefaultTemplate[] = [
  // EMAIL TEMPLATES (8 service types)
  {
    name: 'HVAC Service Review',
    channel: 'email',
    service_type: 'hvac',
    subject: 'How was your AC/heating service, {{CUSTOMER_NAME}}?',
    body: `Hi {{CUSTOMER_NAME}},

Thank you for choosing {{BUSINESS_NAME}} for your HVAC service! We hope your home is now perfectly comfortable.

We'd love to hear about your experience. Your feedback helps us continue providing excellent heating and cooling services.

Leave a review here: {{REVIEW_LINK}}

Thanks for your trust in us,
{{SENDER_NAME}}`
  },
  {
    name: 'Plumbing Service Review',
    channel: 'email',
    service_type: 'plumbing',
    subject: 'Quick feedback on your plumbing service?',
    body: `Hi {{CUSTOMER_NAME}},

Thank you for trusting {{BUSINESS_NAME}} with your plumbing needs! We hope everything is flowing smoothly now.

Your feedback means a lot to us and helps other homeowners find reliable plumbing service.

Share your experience: {{REVIEW_LINK}}

Thanks for choosing us,
{{SENDER_NAME}}`
  },
  {
    name: 'Electrical Service Review',
    channel: 'email',
    service_type: 'electrical',
    subject: 'Your electrical work is complete - quick question?',
    body: `Hi {{CUSTOMER_NAME}},

Thank you for choosing {{BUSINESS_NAME}} for your electrical work! Your safety and satisfaction are our top priorities.

We'd appreciate hearing about your experience. Your review helps us maintain the highest standards.

Leave a review here: {{REVIEW_LINK}}

Best regards,
{{SENDER_NAME}}`
  },
  {
    name: 'Cleaning Service Review',
    channel: 'email',
    service_type: 'cleaning',
    subject: 'Sparkling clean! How did we do?',
    body: `Hi {{CUSTOMER_NAME}},

We hope your space is looking and feeling fresh after our visit! Thank you for choosing {{BUSINESS_NAME}}.

We pay attention to every detail, and your feedback helps us keep improving.

Share your thoughts: {{REVIEW_LINK}}

Thank you,
{{SENDER_NAME}}`
  },
  {
    name: 'Roofing Service Review',
    channel: 'email',
    service_type: 'roofing',
    subject: 'Roof work finished - your thoughts?',
    body: `Hi {{CUSTOMER_NAME}},

Thank you for trusting {{BUSINESS_NAME}} with your roof! We take pride in protecting your home with quality workmanship.

Your feedback helps other homeowners make informed decisions about their roofing needs.

Leave a review: {{REVIEW_LINK}}

Best regards,
{{SENDER_NAME}}`
  },
  {
    name: 'Painting Service Review',
    channel: 'email',
    service_type: 'painting',
    subject: 'Fresh paint! How does it look?',
    body: `Hi {{CUSTOMER_NAME}},

We hope you're enjoying your freshly painted space! Thank you for choosing {{BUSINESS_NAME}} to transform your home.

Your review helps us continue delivering beautiful results for homeowners like you.

Share your experience: {{REVIEW_LINK}}

Thank you,
{{SENDER_NAME}}`
  },
  {
    name: 'Handyman Service Review',
    channel: 'email',
    service_type: 'handyman',
    subject: 'Your repairs are done - how did we do?',
    body: `Hi {{CUSTOMER_NAME}},

Thank you for calling {{BUSINESS_NAME}} to get things done! We hope everything is working just as it should.

Your feedback helps us continue providing dependable handyman services.

Leave a review: {{REVIEW_LINK}}

Thanks again,
{{SENDER_NAME}}`
  },
  {
    name: 'Service Review Request',
    channel: 'email',
    service_type: 'other',
    subject: "We'd love your feedback!",
    body: `Hi {{CUSTOMER_NAME}},

Thank you for choosing {{BUSINESS_NAME}}! We appreciate your trust in our services.

Your feedback is valuable and helps us serve you and others better.

Share your experience: {{REVIEW_LINK}}

Best regards,
{{SENDER_NAME}}`
  },

  // SMS TEMPLATES (8 service types) - Keep under 140 chars to reserve space for opt-out footer
  {
    name: 'HVAC Service SMS',
    channel: 'sms',
    service_type: 'hvac',
    subject: '',
    body: "Hi {{CUSTOMER_NAME}}, thanks for choosing {{BUSINESS_NAME}} for HVAC! We'd love your feedback. Reply YES for review link."
  },
  {
    name: 'Plumbing Service SMS',
    channel: 'sms',
    service_type: 'plumbing',
    subject: '',
    body: "Hi {{CUSTOMER_NAME}}, your plumbing work is done! How'd we do? Reply YES to share feedback on {{BUSINESS_NAME}}."
  },
  {
    name: 'Electrical Service SMS',
    channel: 'sms',
    service_type: 'electrical',
    subject: '',
    body: "Hi {{CUSTOMER_NAME}}, electrical work complete! Your feedback helps us serve you better. Reply YES for review link - {{BUSINESS_NAME}}"
  },
  {
    name: 'Cleaning Service SMS',
    channel: 'sms',
    service_type: 'cleaning',
    subject: '',
    body: "Hi {{CUSTOMER_NAME}}, hope your space is sparkling! Quick feedback on {{BUSINESS_NAME}}? Reply YES for review link."
  },
  {
    name: 'Roofing Service SMS',
    channel: 'sms',
    service_type: 'roofing',
    subject: '',
    body: "Hi {{CUSTOMER_NAME}}, roof work finished! We'd appreciate your thoughts on {{BUSINESS_NAME}}. Reply YES for review link."
  },
  {
    name: 'Painting Service SMS',
    channel: 'sms',
    service_type: 'painting',
    subject: '',
    body: "Hi {{CUSTOMER_NAME}}, fresh paint done! How does it look? Reply YES to share feedback on {{BUSINESS_NAME}}."
  },
  {
    name: 'Handyman Service SMS',
    channel: 'sms',
    service_type: 'handyman',
    subject: '',
    body: "Hi {{CUSTOMER_NAME}}, repairs complete! How'd {{BUSINESS_NAME}} do? Reply YES for review link."
  },
  {
    name: 'Service SMS',
    channel: 'sms',
    service_type: 'other',
    subject: '',
    body: "Hi {{CUSTOMER_NAME}}, thanks for choosing {{BUSINESS_NAME}}! We'd love your feedback. Reply YES for review link."
  },
]

// Helper to get templates by channel
export function getDefaultTemplatesByChannel(channel: MessageChannel): DefaultTemplate[] {
  return DEFAULT_TEMPLATES.filter(t => t.channel === channel)
}

// Helper to get templates by service type
export function getDefaultTemplatesByServiceType(serviceType: ServiceType): DefaultTemplate[] {
  return DEFAULT_TEMPLATES.filter(t => t.service_type === serviceType)
}

// Helper to get template by channel and service type
export function getDefaultTemplate(channel: MessageChannel, serviceType: ServiceType): DefaultTemplate | undefined {
  return DEFAULT_TEMPLATES.find(t => t.channel === channel && t.service_type === serviceType)
}
```
  </action>
  <verify>Run `pnpm typecheck` - constants file compiles. Verify all 16 templates defined (8 email + 8 SMS). Check SMS bodies under 140 chars.</verify>
  <done>16 default templates defined with appropriate tone per service type and channel</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `pnpm typecheck` - no type errors
2. Run `pnpm lint` - no lint errors
3. Check lib/types/database.ts has MessageTemplate interface with service_type field
4. Check lib/validations/message-template.ts has discriminatedUnion schema
5. Check lib/constants/default-templates.ts has 16 templates matching database inserts
</verification>

<success_criteria>
- MessageTemplate type with channel discriminator and service_type
- Zod schema validates email (subject required) vs SMS (body only)
- 16 default templates with service-appropriate tone
- Constants match database INSERT statements from Plan 01
- All types compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-message-templates-migration/23-02-SUMMARY.md`
</output>
