---
phase: 23-message-templates-migration
plan: 05
type: execute
wave: 3
depends_on: ["23-02", "23-03"]
files_modified:
  - components/templates/message-template-preview.tsx
  - components/templates/sms-preview.tsx
  - components/templates/email-preview.tsx
autonomous: true

must_haves:
  truths:
    - "Email preview shows subject + body + CTA button"
    - "SMS preview shows phone bubble mockup with message"
    - "SMS preview shows opt-out footer and character count"
    - "Both previews resolve {{PLACEHOLDER}} variables with sample data"
    - "Preview updates live as user types"
  artifacts:
    - path: "components/templates/message-template-preview.tsx"
      provides: "Conditional preview wrapper (email vs SMS)"
      contains: "MessageTemplatePreview"
    - path: "components/templates/sms-preview.tsx"
      provides: "Phone bubble mockup component"
      contains: "SMSPreview"
    - path: "components/templates/email-preview.tsx"
      provides: "Email preview component"
      contains: "EmailPreview"
  key_links:
    - from: "components/templates/message-template-preview.tsx"
      to: "components/templates/sms-preview.tsx"
      via: "conditional import"
      pattern: "import.*SMSPreview"
    - from: "components/templates/message-template-preview.tsx"
      to: "components/templates/email-preview.tsx"
      via: "conditional import"
      pattern: "import.*EmailPreview"
---

<objective>
Create dual preview components for email and SMS templates with live variable substitution.

Purpose: Show users how their template will look before saving, with appropriate rendering per channel.
Output: Preview components that render email (subject + body + CTA) or SMS (phone bubble mockup).
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-message-templates-migration/23-CONTEXT.md
@.planning/phases/23-message-templates-migration/23-RESEARCH.md
@components/send/message-preview.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email-preview.tsx component</name>
  <files>components/templates/email-preview.tsx</files>
  <action>
Create new file components/templates/email-preview.tsx:

```typescript
import type { Business } from '@/lib/types/database'

interface EmailPreviewProps {
  subject: string
  body: string
  business: Business | null
}

// Sample data for preview
const SAMPLE_CUSTOMER = {
  name: 'John Smith',
  email: 'john.smith@example.com',
}

/**
 * Resolve template placeholders with sample data
 */
function resolveTemplate(text: string, business: Business | null): string {
  const businessName = business?.name || 'Your Business'
  const senderName = business?.default_sender_name || businessName
  const reviewLink = business?.google_review_link || 'https://g.page/your-business/review'

  return text
    .replace(/{{CUSTOMER_NAME}}/gi, SAMPLE_CUSTOMER.name)
    .replace(/{{BUSINESS_NAME}}/gi, businessName)
    .replace(/{{SENDER_NAME}}/gi, senderName)
    .replace(/{{REVIEW_LINK}}/gi, reviewLink)
}

export function EmailPreview({ subject, body, business }: EmailPreviewProps) {
  const resolvedSubject = resolveTemplate(subject, business)
  const resolvedBody = resolveTemplate(body, business)
  const senderName = business?.default_sender_name || business?.name || 'Your Business'

  return (
    <div className="bg-muted/30 p-4 rounded-lg">
      <div className="text-xs text-muted-foreground mb-3 font-medium">Email Preview</div>

      <div className="bg-card border border-border rounded-lg shadow-sm max-w-lg mx-auto overflow-hidden">
        {/* Email header */}
        <div className="px-4 py-3 border-b border-border bg-muted/50">
          <div className="text-xs text-muted-foreground">
            <span className="font-medium">From:</span> {senderName}
          </div>
          <div className="text-xs text-muted-foreground">
            <span className="font-medium">To:</span> {SAMPLE_CUSTOMER.email}
          </div>
        </div>

        {/* Email subject */}
        <div className="px-4 py-3 border-b border-border">
          <div className="font-semibold text-foreground">{resolvedSubject || '(No subject)'}</div>
        </div>

        {/* Email body */}
        <div className="px-4 py-4">
          <div className="text-sm text-foreground whitespace-pre-wrap mb-6">
            {resolvedBody || '(No content)'}
          </div>

          {/* CTA Button */}
          <div className="text-center">
            <span className="inline-block bg-primary text-primary-foreground px-6 py-3 rounded-md font-medium text-sm">
              Leave a Review
            </span>
          </div>
        </div>

        {/* Email footer */}
        <div className="px-4 py-3 border-t border-border bg-muted/50">
          <div className="text-xs text-muted-foreground text-center">
            Sent via AvisLoop
          </div>
        </div>
      </div>

      {/* Sample data notice */}
      <p className="text-xs text-muted-foreground text-center mt-3">
        Preview uses sample data. Actual emails will use real customer information.
      </p>
    </div>
  )
}
```
  </action>
  <verify>Run `pnpm typecheck` - no errors. Component renders email with resolved placeholders.</verify>
  <done>Email preview component created with subject, body, CTA, and placeholder resolution</done>
</task>

<task type="auto">
  <name>Task 2: Create sms-preview.tsx component</name>
  <files>components/templates/sms-preview.tsx</files>
  <action>
Create new file components/templates/sms-preview.tsx with phone bubble mockup:

```typescript
import { useSMSCharacterCounter } from './use-sms-character-counter'
import { cn } from '@/lib/utils'
import type { Business } from '@/lib/types/database'

interface SMSPreviewProps {
  body: string
  business: Business | null
}

// Sample data for preview
const SAMPLE_CUSTOMER = {
  name: 'John Smith',
}

/**
 * Resolve template placeholders with sample data
 */
function resolveTemplate(text: string, business: Business | null): string {
  const businessName = business?.name || 'Your Business'
  const senderName = business?.default_sender_name || businessName

  return text
    .replace(/{{CUSTOMER_NAME}}/gi, SAMPLE_CUSTOMER.name)
    .replace(/{{BUSINESS_NAME}}/gi, businessName)
    .replace(/{{SENDER_NAME}}/gi, senderName)
}

export function SMSPreview({ body, business }: SMSPreviewProps) {
  const resolvedBody = resolveTemplate(body, business)
  const charInfo = useSMSCharacterCounter(body) // Count on raw body, not resolved

  return (
    <div className="bg-muted/30 p-4 rounded-lg">
      <div className="text-xs text-muted-foreground mb-3 font-medium">SMS Preview</div>

      {/* Phone frame mockup */}
      <div className="relative max-w-xs mx-auto">
        {/* Phone outline */}
        <div className="bg-card border-4 border-foreground/20 rounded-[2rem] p-3 shadow-lg">
          {/* Phone notch */}
          <div className="w-20 h-5 bg-foreground/20 rounded-full mx-auto mb-3" />

          {/* Message area */}
          <div className="bg-background rounded-xl p-3 min-h-[200px]">
            {/* Sender info */}
            <div className="text-center mb-3">
              <div className="text-xs text-muted-foreground">
                {business?.name || 'Your Business'}
              </div>
              <div className="text-[10px] text-muted-foreground/70">
                Text Message
              </div>
            </div>

            {/* Message bubble (received style - gray, left-aligned) */}
            {resolvedBody && (
              <div className="flex justify-start">
                <div className="relative max-w-[85%]">
                  {/* Bubble with tail */}
                  <div className="bg-muted text-foreground px-3 py-2 rounded-2xl rounded-bl-sm shadow-sm">
                    <p className="text-sm whitespace-pre-wrap break-words">
                      {resolvedBody}
                    </p>
                  </div>
                </div>
              </div>
            )}

            {!resolvedBody && (
              <div className="text-center text-muted-foreground text-sm italic py-8">
                Start typing to see preview...
              </div>
            )}

            {/* Opt-out footer */}
            {resolvedBody && (
              <div className="mt-3 text-center">
                <span className="text-[10px] text-muted-foreground/70 bg-muted/50 px-2 py-1 rounded">
                  Reply STOP to opt out
                </span>
              </div>
            )}
          </div>

          {/* Phone home indicator */}
          <div className="w-24 h-1 bg-foreground/20 rounded-full mx-auto mt-3" />
        </div>
      </div>

      {/* Character count info */}
      <div className="mt-4 text-center space-y-1">
        <div className={cn(
          'text-sm font-medium',
          charInfo.warning === 'error' && 'text-red-600',
          charInfo.warning === 'warning' && 'text-yellow-600',
          charInfo.warning === 'none' && 'text-muted-foreground'
        )}>
          {charInfo.length} / {charInfo.limit} characters
        </div>
        <div className="text-xs text-muted-foreground">
          {charInfo.encoding} encoding
          {charInfo.segments > 1 && (
            <span className="text-yellow-600 ml-1">
              ({charInfo.segments} SMS segments)
            </span>
          )}
        </div>
        {charInfo.warningMessage && (
          <div className={cn(
            'text-xs',
            charInfo.warning === 'error' ? 'text-red-600' : 'text-yellow-600'
          )}>
            {charInfo.warningMessage}
          </div>
        )}
      </div>

      {/* Sample data notice */}
      <p className="text-xs text-muted-foreground text-center mt-3">
        Preview uses sample data. Actual SMS will use real customer information.
      </p>
    </div>
  )
}
```

Key design decisions:
- Phone mockup with rounded corners and notch
- Gray received-style bubble (left aligned)
- Opt-out footer shown below message
- Character count displayed below phone
- Warning colors match form
  </action>
  <verify>Run `pnpm typecheck` - no errors. Component renders phone mockup with bubble.</verify>
  <done>SMS preview component created with phone bubble mockup and character info</done>
</task>

<task type="auto">
  <name>Task 3: Create message-template-preview.tsx wrapper</name>
  <files>components/templates/message-template-preview.tsx</files>
  <action>
Create new file components/templates/message-template-preview.tsx that conditionally renders email or SMS preview:

```typescript
import { EmailPreview } from './email-preview'
import { SMSPreview } from './sms-preview'
import type { Business, MessageChannel } from '@/lib/types/database'

interface MessageTemplatePreviewProps {
  channel: MessageChannel
  subject: string  // Only used for email
  body: string
  business: Business | null
}

/**
 * Conditional preview component that renders email or SMS preview
 * based on the channel prop.
 */
export function MessageTemplatePreview({
  channel,
  subject,
  body,
  business,
}: MessageTemplatePreviewProps) {
  if (channel === 'email') {
    return (
      <EmailPreview
        subject={subject}
        body={body}
        business={business}
      />
    )
  }

  return (
    <SMSPreview
      body={body}
      business={business}
    />
  )
}

// Re-export individual components for direct use
export { EmailPreview } from './email-preview'
export { SMSPreview } from './sms-preview'
```
  </action>
  <verify>Run `pnpm typecheck` - no errors. Wrapper correctly routes to email or SMS preview.</verify>
  <done>Preview wrapper component created with conditional rendering</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `pnpm typecheck` - no type errors
2. Run `pnpm lint` - no lint errors
3. Test EmailPreview: Renders subject, body, CTA button
4. Test SMSPreview: Renders phone mockup with bubble
5. Test MessageTemplatePreview: Switches between previews based on channel
6. Test placeholder resolution: {{CUSTOMER_NAME}} replaced with "John Smith"
</verification>

<success_criteria>
- Email preview shows From/To header, subject, body, CTA button
- SMS preview shows phone mockup with message bubble
- Both previews resolve {{PLACEHOLDER}} variables
- SMS shows character count and encoding below phone
- Warnings display correctly (yellow/red colors)
- Preview wrapper routes correctly based on channel
</success_criteria>

<output>
After completion, create `.planning/phases/23-message-templates-migration/23-05-SUMMARY.md`
</output>
