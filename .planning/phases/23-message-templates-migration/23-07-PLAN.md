---
phase: 23-message-templates-migration
plan: 07
type: execute
wave: 4
depends_on: ["23-03", "23-06"]
files_modified:
  - lib/actions/business.ts
  - lib/data/business.ts
  - components/send/quick-send-tab.tsx
  - app/(dashboard)/send/page.tsx
autonomous: true

must_haves:
  truths:
    - "Send page uses message_templates for template selection"
    - "getBusiness function returns message_templates (not email_templates)"
    - "Template selector on send page shows channel filter option"
    - "Backward compatibility maintained for existing email sending"
  artifacts:
    - path: "lib/actions/business.ts"
      provides: "Updated template functions for message_templates"
      contains: "message_templates"
    - path: "lib/data/business.ts"
      provides: "Updated data functions"
      contains: "message_templates"
    - path: "components/send/quick-send-tab.tsx"
      provides: "Updated template selector"
      contains: "MessageTemplate"
  key_links:
    - from: "lib/actions/business.ts"
      to: "message_templates"
      via: "Supabase query"
      pattern: "from\\(['\"]message_templates['\"]\\)"
    - from: "components/send/quick-send-tab.tsx"
      to: "lib/types/database.ts"
      via: "type import"
      pattern: "import.*MessageTemplate"
---

<objective>
Update existing template references throughout codebase to use message_templates table.

Purpose: Complete the migration by updating all code that references email_templates to use message_templates.
Output: All template-related code uses unified message_templates with backward compatibility for email sending.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-message-templates-migration/23-CONTEXT.md
@lib/actions/business.ts
@lib/data/business.ts
@components/send/quick-send-tab.tsx
@app/(dashboard)/send/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update lib/actions/business.ts template functions</name>
  <files>lib/actions/business.ts</files>
  <action>
Update lib/actions/business.ts to use message_templates:

1. Keep createEmailTemplate for backward compatibility but mark deprecated:
```typescript
/**
 * @deprecated Use createMessageTemplate from lib/actions/message-template.ts instead
 * Create a new email template (legacy function - creates with channel='email')
 */
export async function createEmailTemplate(
  _prevState: BusinessActionState | null,
  formData: FormData
): Promise<BusinessActionState> {
  // ... existing implementation but insert to message_templates with channel='email'
  const { error } = await supabase
    .from('message_templates')  // Changed from email_templates
    .insert({
      business_id: business.id,
      name,
      subject,
      body,
      channel: 'email',  // Add channel
      is_default: false,
    })
  // ...
}
```

2. Update deleteEmailTemplate to use message_templates:
```typescript
/**
 * @deprecated Use deleteMessageTemplate from lib/actions/message-template.ts instead
 */
export async function deleteEmailTemplate(
  templateId: string
): Promise<BusinessActionState> {
  // ... update to query message_templates
  const { data: template } = await supabase
    .from('message_templates')  // Changed from email_templates
    .select('is_default')
    .eq('id', templateId)
    .single()
  // ...
  const { error } = await supabase
    .from('message_templates')  // Changed from email_templates
    .delete()
    .eq('id', templateId)
  // ...
}
```

3. Update getBusiness to join message_templates:
```typescript
export async function getBusiness() {
  // ...
  const { data: business } = await supabase
    .from('businesses')
    .select(`
      *,
      message_templates (
        id,
        name,
        subject,
        body,
        channel,
        is_default,
        created_at
      )
    `)
    .eq('user_id', user.id)
    .single()

  return business
}
```

4. Update getEmailTemplates to return message_templates:
```typescript
/**
 * @deprecated Use getMessageTemplates from lib/data/message-template.ts instead
 * Fetch all templates for the current user's business.
 * Returns email templates by default for backward compatibility.
 */
export async function getEmailTemplates() {
  // ...
  const { data: templates } = await supabase
    .from('message_templates')  // Changed from email_templates
    .select('*')
    .eq('business_id', business.id)
    .eq('channel', 'email')  // Filter to email only for backward compat
    .order('is_default', { ascending: false })
    .order('created_at', { ascending: true })

  return templates || []
}
```
  </action>
  <verify>Run `pnpm typecheck` - no type errors. Functions still work with existing code.</verify>
  <done>Business actions updated to use message_templates with backward compatibility</done>
</task>

<task type="auto">
  <name>Task 2: Update lib/data/business.ts if template functions exist</name>
  <files>lib/data/business.ts</files>
  <action>
Check lib/data/business.ts for any template-related functions and update them.

If there are template fetching functions:
- Update table name from email_templates to message_templates
- Add channel filtering where appropriate
- Add deprecation comments pointing to lib/data/message-template.ts

If only business-related functions exist, ensure business queries that join templates use message_templates:

```typescript
// Example: If getBusiness exists in data layer
export async function getBusiness() {
  // ...
  const { data: business } = await supabase
    .from('businesses')
    .select(`
      *,
      message_templates (
        id,
        name,
        subject,
        body,
        channel,
        is_default,
        created_at
      )
    `)
    .eq('user_id', user.id)
    .single()
  // ...
}
```

Note: The email_templates view still exists and will work, but we should migrate to message_templates for consistency.
  </action>
  <verify>Run `pnpm typecheck` - no type errors in data layer.</verify>
  <done>Data layer updated to use message_templates</done>
</task>

<task type="auto">
  <name>Task 3: Update send page and quick-send-tab for message templates</name>
  <files>components/send/quick-send-tab.tsx, app/(dashboard)/send/page.tsx</files>
  <action>
Update send page components to use MessageTemplate type:

1. In app/(dashboard)/send/page.tsx, update template fetching:
```typescript
import type { MessageTemplate } from '@/lib/types/database'

// In the component:
// Get templates (email only for now - SMS sending in Phase 21)
const { data: templates } = await supabase
  .from('message_templates')
  .select('*')
  .eq('business_id', business.id)
  .eq('channel', 'email')  // Only email templates for sending (SMS in Phase 21)
  .order('is_default', { ascending: false })
  .order('created_at', { ascending: true })

// Type the templates array
const emailTemplates: MessageTemplate[] = templates || []
```

2. In components/send/quick-send-tab.tsx:
- Update import to use MessageTemplate type
- Update prop types from EmailTemplate to MessageTemplate
- Keep functionality the same (email sending still works)

```typescript
import type { Customer, Business, MessageTemplate } from '@/lib/types/database'

interface QuickSendTabProps {
  customers: Customer[]
  business: Business & { message_templates?: MessageTemplate[] }
  templates: MessageTemplate[]
  monthlyUsage: { count: number; limit: number; tier: string }
  hasReviewLink: boolean
}
```

3. Update components/send/send-page-client.tsx if it uses EmailTemplate:
```typescript
import type { Customer, Business, MessageTemplate, SendLogWithCustomer } from '@/lib/types/database'

interface SendPageClientProps {
  customers: Customer[]
  business: Business & { message_templates?: MessageTemplate[] }
  templates: MessageTemplate[]
  // ... rest of props
}
```

The actual template selector UI doesn't need to change - it just displays template name and uses template ID for sending. The EmailTemplate and MessageTemplate types are compatible for email channel.
  </action>
  <verify>Run `pnpm typecheck` - no type errors. Send page still works.</verify>
  <done>Send page updated to use MessageTemplate type</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `pnpm typecheck` - no type errors
2. Run `pnpm lint` - no lint errors
3. Run `pnpm dev` and test:
   - Visit /settings - templates load
   - Visit /send - template selector works
   - Create a template - saves correctly
   - Send an email - uses template correctly
</verification>

<success_criteria>
- All template references use message_templates table
- Backward compatibility maintained for email sending
- Send page template selector works
- No type errors or lint warnings
- Email sending functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/23-message-templates-migration/23-07-SUMMARY.md`
</output>
