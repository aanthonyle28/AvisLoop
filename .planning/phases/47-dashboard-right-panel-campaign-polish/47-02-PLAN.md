---
phase: 47-dashboard-right-panel-campaign-polish
plan: 02
type: execute
wave: 2
depends_on: ["47-01"]
files_modified:
  - components/dashboard/sparkline.tsx
  - components/dashboard/right-panel-default.tsx
autonomous: true

must_haves:
  truths:
    - "Each KPI card in the right panel has a light gray/muted background that visually differentiates it from the surrounding panel"
    - "Each KPI card displays a mini sparkline graph below the metric value showing the 14-day trend"
    - "When fewer than 2 data points exist, the sparkline shows a flat dashed line (not blank space or broken chart)"
    - "Activity feed items have colored circle icons — green for reviews, blue for sends, orange for feedback, neutral for enrollments"
    - "Activity feed items are clickable links that navigate to the relevant page"
    - "Activity feed items have increased vertical spacing between them"
    - "The pipeline counter row below KPI cards retains its compact 3-column horizontal layout and is NOT promoted to a full card"
  artifacts:
    - path: "components/dashboard/sparkline.tsx"
      provides: "Reusable SVG sparkline component"
      contains: "export function Sparkline"
    - path: "components/dashboard/right-panel-default.tsx"
      provides: "Updated right panel with sparklines, colored icons, clickable activity items"
      contains: "Sparkline"
  key_links:
    - from: "components/dashboard/right-panel-default.tsx"
      to: "components/dashboard/sparkline.tsx"
      via: "import Sparkline"
      pattern: "import.*Sparkline.*from"
    - from: "components/dashboard/right-panel-default.tsx"
      to: "lib/types/dashboard.ts"
      via: "DashboardKPIs with history"
      pattern: "kpiData\\.reviewsThisMonth\\.history"
---

<objective>
Create the SVG sparkline component and update the right panel with sparklines on KPI cards, colored activity feed icons, clickable activity items, and gray KPI card backgrounds.

Purpose: This is the visual layer that consumes the history data from Plan 47-01 and turns it into visible sparkline graphs on the KPI cards, plus improves the activity feed with colored icons and clickable navigation.

Output: New `sparkline.tsx` component. Updated `right-panel-default.tsx` with gray KPI backgrounds, sparklines, colored activity icons, clickable items, and increased spacing.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-dashboard-right-panel-campaign-polish/47-CONTEXT.md
@.planning/phases/47-dashboard-right-panel-campaign-polish/47-RESEARCH.md
@.planning/phases/47-dashboard-right-panel-campaign-polish/47-01-SUMMARY.md

@components/dashboard/right-panel-default.tsx
@lib/types/dashboard.ts
@app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable SVG Sparkline component</name>
  <files>components/dashboard/sparkline.tsx</files>
  <action>
Create a new file `components/dashboard/sparkline.tsx` with `'use client'` directive.

**Interface:**
```typescript
interface SparklineProps {
  data: number[]       // ordered values, oldest first
  color: string        // CSS color string (hex or hsl var) for stroke
  height?: number      // default 36
  className?: string   // additional classes for the SVG
}
```

**Implementation:**
- Export a `Sparkline` function component
- SVG with `viewBox="0 0 100 36"`, `preserveAspectRatio="none"`, `aria-hidden="true"`
- Use `style={{ width: '100%', height }}` for sizing

**Empty state (data.length < 2):**
- Render a single `<line>` from x1=4 to x2=96 at y=18
- `strokeDasharray="4 3"` with `className="text-muted-foreground/25"` and `stroke="currentColor"`
- Below the SVG in the parent, a "Not enough data" text will be shown — the sparkline component itself just shows the dashed line

**Normal state (data.length >= 2):**
- Normalize values to fit the viewBox: pad=2, x maps from 0 to w (100), y maps from h-pad to pad (inverted for SVG coords)
- Handle edge case where all values are equal (range=0): use range=1 to avoid division by zero
- Create a gradient fill under the line:
  - `<defs>` with `<linearGradient>` going from `stopColor={color} stopOpacity={0.15}` at top to `stopOpacity={0}` at bottom
  - `<path>` that traces the polyline then closes along the bottom of the viewBox
  - Generate a stable gradientId from the color prop (strip non-alphanumeric chars)
- Render `<polyline>` with:
  - `fill="none"`, `stroke={color}`, `strokeWidth="1.5"`
  - `strokeLinecap="round"`, `strokeLinejoin="round"`

Follow the code example from the RESEARCH.md document closely. Use `.toFixed(1)` for point coordinates.
  </action>
  <verify>
1. pnpm typecheck passes
2. File exists at components/dashboard/sparkline.tsx
3. Component handles both empty (< 2 data points) and normal cases
  </verify>
  <done>Sparkline component exists, handles empty and data states, uses inline SVG with gradient fill</done>
</task>

<task type="auto">
  <name>Task 2: Update right panel with sparklines, colored icons, clickable items</name>
  <files>components/dashboard/right-panel-default.tsx</files>
  <action>
Make the following changes to `right-panel-default.tsx`:

**1. Import Sparkline and Link:**
- Add `import { Sparkline } from '@/components/dashboard/sparkline'`
- `Link` from 'next/link' is already imported

**2. Define KPI accent color constants** (at module level, outside components):
```typescript
const KPI_COLORS = {
  reviews: '#F59E0B',    // amber — matches Star icon color
  rating: '#008236',     // green — matches ChartBar icon color
  conversion: '#2C879F', // teal — matches Target icon color
} as const
```

**3. KPI Cards — add gray background and sparklines:**
For each of the 3 KPI `<Card>` elements:
- Add `bg-muted/40` class to the Card (replaces default white): `<Card className="p-4 bg-muted/40 hover:bg-muted/60 transition-colors cursor-pointer">`
- After the existing `<div className="flex items-baseline gap-2">` block (the value + trend row), add the sparkline:
```tsx
<div className="mt-2">
  <Sparkline
    data={(kpiData.reviewsThisMonth.history || []).map(d => d.value)}
    color={KPI_COLORS.reviews}
    height={32}
  />
  {(!kpiData.reviewsThisMonth.history || kpiData.reviewsThisMonth.history.length < 2) && (
    <p className="text-[10px] text-muted-foreground/50 text-center mt-0.5">Not enough data</p>
  )}
</div>
```
- Apply the same pattern to `averageRating` (use `KPI_COLORS.rating`) and `conversionRate` (use `KPI_COLORS.conversion`)

**4. Pipeline counter row — NO changes:**
The `<div className="grid grid-cols-3 divide-x ...">` section stays exactly as-is. Do NOT modify it, add cards to it, or change its layout.

**5. Activity feed — colored circle icons:**
Replace the `getEventIcon` function with a `getEventStyle` function that returns icon, background class, and icon color class:

```typescript
function getEventStyle(type: CampaignEvent['type']) {
  switch (type) {
    case 'review_click':
      return { Icon: Star, bg: 'bg-success-bg', text: 'text-success' }
    case 'touch_sent':
      return { Icon: PaperPlaneTilt, bg: 'bg-info-bg', text: 'text-info' }
    case 'feedback_submitted':
      return { Icon: ChatCircleText, bg: 'bg-warning-bg', text: 'text-warning' }
    case 'enrollment':
      return { Icon: UserPlus, bg: 'bg-muted', text: 'text-muted-foreground' }
  }
}
```

Delete the old `getEventIcon` function.

**6. Activity feed — clickable items with navigation:**
Add a `getEventHref` function:
```typescript
function getEventHref(event: CampaignEvent): string {
  switch (event.type) {
    case 'review_click':
      return '/history?status=reviewed'
    case 'touch_sent':
      return '/history'
    case 'feedback_submitted':
      return '/feedback'
    case 'enrollment':
      return '/campaigns'
  }
}
```

**7. Activity feed — update the rendering:**
In the `events.slice(0, 5).map(...)` block:
- Change the wrapping `<div>` to a `<Link>` element
- Change spacing from `space-y-0.5` to `space-y-2` for increased vertical spacing
- Replace the icon rendering from a plain `<Icon>` to a colored circle:

```tsx
<Link
  key={event.id}
  href={getEventHref(event)}
  className="flex items-center gap-3 rounded-md px-2 py-2 hover:bg-muted/50 transition-colors"
>
  <div className={cn('flex items-center justify-center rounded-full w-7 h-7 shrink-0', style.bg)}>
    <style.Icon size={14} weight="fill" className={style.text} />
  </div>
  <span className="text-xs truncate flex-1 text-foreground/80">{description}</span>
  <span className="text-[11px] text-muted-foreground whitespace-nowrap">
    {formatDistanceToNow(new Date(event.timestamp), { addSuffix: true })}
  </span>
</Link>
```

- Import `cn` from `@/lib/utils` if not already imported

**8. Clean up:**
- Remove the old `getEventIcon` function (replaced by `getEventStyle`)
- Verify all imports are correct and no unused imports remain
  </action>
  <verify>
1. pnpm typecheck passes
2. pnpm lint passes
3. Each KPI card has bg-muted/40 class
4. Each KPI card renders a Sparkline component
5. Activity items are wrapped in Link elements
6. Activity icons have colored circle backgrounds using semantic tokens
7. Pipeline counter row is unchanged
  </verify>
  <done>Right panel KPI cards have gray backgrounds and sparkline graphs. Activity feed has colored circle icons with clickable navigation. Pipeline counter row is unchanged.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` — passes with no errors
2. `pnpm lint` — passes with no errors
3. `components/dashboard/sparkline.tsx` exists and exports `Sparkline`
4. `right-panel-default.tsx` imports and uses `Sparkline` for all 3 KPI cards
5. Activity feed items are `<Link>` elements with colored icons
6. Pipeline counter row layout is identical to before (no card promotion)
7. KPI cards have `bg-muted/40` background class
</verification>

<success_criteria>
- SVG sparkline component renders trend lines from history data
- Empty state shows dashed line (not broken/blank)
- KPI cards visually differentiated with gray background
- Activity feed has colored icons matching event types (green/blue/orange)
- Activity items navigate on click
- Increased vertical spacing between activity items
- Pipeline row unchanged
- TypeScript and lint clean
</success_criteria>

<output>
After completion, create `.planning/phases/47-dashboard-right-panel-campaign-polish/47-02-SUMMARY.md`
</output>
