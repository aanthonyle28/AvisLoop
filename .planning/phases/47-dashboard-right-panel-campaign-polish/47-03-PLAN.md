---
phase: 47-dashboard-right-panel-campaign-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - components/campaigns/template-preview-modal.tsx
  - components/campaigns/touch-sequence-editor.tsx
  - app/(dashboard)/campaigns/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Each touch in the touch sequence editor has a Preview button that opens a modal showing the template content"
    - "Email templates preview in an email-like frame showing subject line and body"
    - "SMS templates preview in a chat bubble style with character count"
    - "System default templates (template_id = null) show preview by looking up the matching system template from the templates prop"
    - "Campaign detail page has refreshed visual styling consistent with the warm design system"
    - "Enrollment rows show customer name, status badge, touch progress, and enrollment timing"
  artifacts:
    - path: "components/campaigns/template-preview-modal.tsx"
      provides: "Template preview dialog with email frame and SMS bubble styles"
      contains: "export function TemplatePreviewModal"
    - path: "components/campaigns/touch-sequence-editor.tsx"
      provides: "Preview button per touch row"
      contains: "TemplatePreviewModal"
    - path: "app/(dashboard)/campaigns/[id]/page.tsx"
      provides: "Visually refreshed campaign detail page with richer enrollment rows"
      contains: "enrollment"
  key_links:
    - from: "components/campaigns/touch-sequence-editor.tsx"
      to: "components/campaigns/template-preview-modal.tsx"
      via: "import and render TemplatePreviewModal"
      pattern: "TemplatePreviewModal"
---

<objective>
Add template preview modals to the touch sequence editor and visually refresh the campaign detail page.

Purpose: Users can see what each touch will send without leaving the campaign editor. The campaign detail page is brought up to the current warm design system standards with richer enrollment row information.

Output: New `TemplatePreviewModal` component. Updated `TouchSequenceEditor` with Preview buttons. Refreshed `campaigns/[id]/page.tsx` with better typography, spacing, and enrollment row content.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-dashboard-right-panel-campaign-polish/47-CONTEXT.md
@.planning/phases/47-dashboard-right-panel-campaign-polish/47-RESEARCH.md

@components/campaigns/touch-sequence-editor.tsx
@app/(dashboard)/campaigns/[id]/page.tsx
@components/ui/dialog.tsx
@lib/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TemplatePreviewModal and add Preview buttons to TouchSequenceEditor</name>
  <files>components/campaigns/template-preview-modal.tsx, components/campaigns/touch-sequence-editor.tsx</files>
  <action>
**Part A: Create `components/campaigns/template-preview-modal.tsx`**

`'use client'` directive.

**Props:**
```typescript
interface TemplatePreviewModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  template: {
    name: string
    subject: string
    body: string
    channel: 'email' | 'sms'
  } | null
}
```

**Implementation:**
- Use `Dialog`, `DialogContent`, `DialogHeader`, `DialogTitle` from `@/components/ui/dialog`
- Import `Separator` from `@/components/ui/separator`
- Import `EnvelopeSimple`, `ChatCircle` from `@phosphor-icons/react`

When `template` is null, show a message: "No template preview available. This touch uses an AI-generated default."

When `template.channel === 'email'`:
```tsx
<div className="space-y-3">
  <div className="flex items-center gap-2 text-muted-foreground">
    <EnvelopeSimple size={16} />
    <span className="text-xs font-medium uppercase tracking-wide">Email Preview</span>
  </div>
  <div className="rounded-lg border bg-muted/30 overflow-hidden">
    <div className="px-4 py-3 border-b bg-muted/50">
      <p className="text-[11px] text-muted-foreground mb-0.5">Subject</p>
      <p className="text-sm font-medium">{template.subject}</p>
    </div>
    <div className="px-4 py-4">
      <p className="text-sm whitespace-pre-wrap leading-relaxed">{template.body}</p>
    </div>
  </div>
</div>
```

When `template.channel === 'sms'`:
```tsx
<div className="space-y-3">
  <div className="flex items-center gap-2 text-muted-foreground">
    <ChatCircle size={16} />
    <span className="text-xs font-medium uppercase tracking-wide">SMS Preview</span>
  </div>
  <div className="flex justify-end">
    <div className="bg-primary text-primary-foreground rounded-2xl rounded-tr-sm px-4 py-3 max-w-[85%]">
      <p className="text-sm whitespace-pre-wrap leading-relaxed">{template.body}</p>
    </div>
  </div>
  <p className="text-xs text-muted-foreground text-right">
    {template.body.length} / 160 characters
  </p>
</div>
```

The dialog title should show the template name: `<DialogTitle>{template?.name || 'Template Preview'}</DialogTitle>`.

**Part B: Update `components/campaigns/touch-sequence-editor.tsx`**

Import the new modal:
```typescript
import { TemplatePreviewModal } from '@/components/campaigns/template-preview-modal'
```

Import `Eye` icon from `@phosphor-icons/react`.

Add state for the preview modal:
```typescript
const [previewTemplate, setPreviewTemplate] = useState<{
  name: string; subject: string; body: string; channel: 'email' | 'sms'
} | null>(null)
const [previewOpen, setPreviewOpen] = useState(false)
```

Add a `resolveTemplate` function inside the component:
```typescript
const resolveTemplate = (touch: CampaignTouchFormData) => {
  if (touch.template_id) {
    // Find the selected template
    const found = templates.find(t => t.id === touch.template_id)
    return found ? { name: found.name, subject: found.subject, body: found.body, channel: touch.channel } : null
  }
  // For default (null template_id), find the matching system template by channel
  const systemTemplate = templates.find(
    t => t.is_default && t.channel === touch.channel
  )
  return systemTemplate
    ? { name: systemTemplate.name, subject: systemTemplate.subject, body: systemTemplate.body, channel: touch.channel }
    : null
}
```

Add a Preview button next to each touch's remove button. Place it BEFORE the remove/trash button in the flex layout:
```tsx
<Button
  type="button"
  variant="ghost"
  size="icon"
  onClick={() => {
    setPreviewTemplate(resolveTemplate(touch))
    setPreviewOpen(true)
  }}
  className="shrink-0"
  aria-label={`Preview touch ${index + 1} template`}
>
  <Eye className="h-4 w-4" />
</Button>
```

Add the modal at the bottom of the component's return, outside the map loop:
```tsx
<TemplatePreviewModal
  open={previewOpen}
  onOpenChange={setPreviewOpen}
  template={previewTemplate}
/>
```

Also add `useState` to the React import if not already imported (it already uses it? — check current file for existing `useState` usage; if none, add the import).

Note: The current `touch-sequence-editor.tsx` does not have `useState` imported — it's a stateless component. Add `import { useState } from 'react'` at the top.
  </action>
  <verify>
1. pnpm typecheck passes
2. pnpm lint passes
3. TemplatePreviewModal renders email preview with subject/body frame
4. TemplatePreviewModal renders SMS preview with chat bubble + char count
5. Each touch row has a Preview (Eye) button
6. Template resolution handles both selected templates and system defaults
  </verify>
  <done>Template preview modal exists with email frame and SMS bubble styles. Each touch in the editor has a Preview button. System default templates are resolved from the templates prop.</done>
</task>

<task type="auto">
  <name>Task 2: Visual retouch of campaign detail page</name>
  <files>app/(dashboard)/campaigns/[id]/page.tsx</files>
  <action>
Refresh the campaign detail page to match the warm design system. Keep single-column layout — visual changes only, no structural reorganization.

**1. Header section:**
- Change h1 from `text-2xl font-semibold` to `text-2xl font-semibold tracking-tight` (add tracking-tight for consistency with other pages)
- Add subtitle below the service type line: already has the service type / touches text — this is fine

**2. Stats cards — restyle with consistent card typography:**
Replace the 3-card stats grid with a cleaner design:
```tsx
<div className="grid grid-cols-3 gap-4">
  <Card className="bg-muted/40">
    <CardContent className="pt-5 pb-4 px-5">
      <p className="text-xs text-muted-foreground font-medium mb-1">Active</p>
      <p className="text-2xl font-bold">{counts.active}</p>
    </CardContent>
  </Card>
  <Card className="bg-muted/40">
    <CardContent className="pt-5 pb-4 px-5">
      <p className="text-xs text-muted-foreground font-medium mb-1">Completed</p>
      <p className="text-2xl font-bold">{counts.completed}</p>
    </CardContent>
  </Card>
  <Card className="bg-muted/40">
    <CardContent className="pt-5 pb-4 px-5">
      <p className="text-xs text-muted-foreground font-medium mb-1">Stopped</p>
      <p className="text-2xl font-bold">{counts.stopped}</p>
    </CardContent>
  </Card>
</div>
```

Key changes: Remove `CardHeader` + `CardTitle` overhead; use flat `CardContent` with text-xs label + text-2xl value. Add `bg-muted/40` for the warm muted background consistent with right panel KPI cards.

**3. Touch sequence visualization — cleaner badges:**
In the touch sequence `<Card>`, update the individual touch display:
- Change `bg-muted/50` to `bg-muted/30` on the inner `<div>` for lighter weight
- This section is fine otherwise — just the slight background change

**4. Enrollment rows — richer information:**
Update each enrollment row to show more context. The current row shows customer name, enrollment time, and status badge.

Add touch progress information. Use the `current_touch` field from the enrollment data. Note from RESEARCH: `current_touch` represents the NEXT touch to send (1-indexed), so for display purposes, show "Touch {current_touch - 1} of {totalTouches} sent" for active enrollments. For completed enrollments, show "All touches sent". For stopped enrollments, show "Stopped at touch {current_touch - 1}".

However, the enrollment data currently fetched by `getCampaignEnrollments()` might not include all needed fields. Check what `enrollment` contains — it should have `current_touch`, `status`, `stop_reason`, customer name, enrolled_at, and optionally the job's service_type.

The campaign's total touch count is available as `campaign.campaign_touches.length`.

Update enrollment row rendering:
```tsx
<div
  key={enrollment.id}
  className="flex items-center justify-between p-3 rounded-lg border bg-card"
>
  <div className="min-w-0 flex-1">
    <div className="font-medium truncate">
      {enrollment.customers?.name || 'Unknown customer'}
    </div>
    <div className="flex items-center gap-2 text-sm text-muted-foreground mt-0.5">
      <span>
        {formatDistanceToNow(new Date(enrollment.enrolled_at), { addSuffix: true })}
      </span>
      {enrollment.jobs?.service_type && (
        <>
          <span className="text-muted-foreground/40">·</span>
          <span>{SERVICE_TYPE_LABELS[enrollment.jobs.service_type]}</span>
        </>
      )}
      {enrollment.status === 'active' && enrollment.current_touch && (
        <>
          <span className="text-muted-foreground/40">·</span>
          <span>
            Touch {Math.max(0, enrollment.current_touch - 1)}/{campaign.campaign_touches.length}
          </span>
        </>
      )}
    </div>
  </div>
  <div className="flex items-center gap-2 shrink-0 ml-3">
    <Badge
      variant={
        enrollment.status === 'active' ? 'default' :
        enrollment.status === 'completed' ? 'secondary' :
        enrollment.status === 'frozen' ? 'outline' :
        'outline'
      }
    >
      {ENROLLMENT_STATUS_LABELS[enrollment.status] || enrollment.status}
    </Badge>
    {enrollment.stop_reason && (
      <span className="text-xs text-muted-foreground">
        {STOP_REASON_LABELS[enrollment.stop_reason] || enrollment.stop_reason}
      </span>
    )}
  </div>
</div>
```

**5. Container spacing:**
Change `space-y-6` to `space-y-8` on the top-level container for more breathing room between sections.

**6. Clean up:**
- Remove unused imports if any (e.g. if CardHeader or CardTitle are no longer used after stats restyle)
- Verify all imports are correct
  </action>
  <verify>
1. pnpm typecheck passes
2. pnpm lint passes
3. Stats cards use flat CardContent layout with bg-muted/40
4. Enrollment rows show touch progress (Touch N/M) for active enrollments
5. Container has `space-y-8` for better section separation
6. h1 has `tracking-tight` class
  </verify>
  <done>Campaign detail page has refreshed styling — cleaner stats cards, richer enrollment rows with touch progress, better spacing, and consistent with warm design system.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` — passes with no errors
2. `pnpm lint` — passes with no errors
3. `components/campaigns/template-preview-modal.tsx` exists with email frame and SMS bubble renderers
4. Touch sequence editor shows Preview button per touch
5. Preview modal handles both selected and system default templates
6. Campaign detail page has refreshed visual styling
7. Enrollment rows show customer name, touch progress, status badge, and timing
</verification>

<success_criteria>
- Template preview modal opens from each touch with correct email/SMS styling
- System default templates display their actual content (not "no preview")
- Campaign detail page stats cards have muted backgrounds
- Enrollment rows show touch progress (Touch N of M)
- All styling consistent with warm design system
- TypeScript and lint clean
</success_criteria>

<output>
After completion, create `.planning/phases/47-dashboard-right-panel-campaign-polish/47-03-SUMMARY.md`
</output>
