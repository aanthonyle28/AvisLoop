---
phase: 11-bulk-send-resend-integrations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/validations/send.ts
  - lib/data/send-logs.ts
  - lib/actions/send.ts
  - lib/types/database.ts
autonomous: true

must_haves:
  truths:
    - "Batch send action validates all contacts in one SQL query and checks quota fits full batch before starting"
    - "Batch send returns structured results with sent/skipped/failed counts"
    - "Re-send ready query returns contacts whose 14-day cooldown has expired and were previously sent to"
  artifacts:
    - path: "lib/validations/send.ts"
      provides: "batchSendSchema with max 25 contacts"
      contains: "max(25"
    - path: "lib/actions/send.ts"
      provides: "batchSendReviewRequest server action"
      exports: ["batchSendReviewRequest"]
    - path: "lib/data/send-logs.ts"
      provides: "getResendReadyContacts query"
      exports: ["getResendReadyContacts"]
  key_links:
    - from: "lib/actions/send.ts"
      to: "lib/validations/send.ts"
      via: "batchSendSchema import"
      pattern: "import.*batchSendSchema"
    - from: "lib/actions/send.ts"
      to: "lib/email/resend"
      via: "Resend email sending per contact in batch loop"
      pattern: "resend\\.emails\\.send"
---

<objective>
Build the server-side backend for batch sending review requests and the "ready to re-send" data query.

Purpose: Enables sending review requests to up to 25 contacts at once with full validation (cooldown, opt-out, quota), and querying contacts whose cooldown has expired for re-sending.

Output: batchSendReviewRequest server action, getResendReadyContacts data query, updated batchSendSchema.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-bulk-send-resend-integrations/11-RESEARCH.md

@lib/actions/send.ts
@lib/validations/send.ts
@lib/data/send-logs.ts
@lib/rate-limit.ts
@lib/constants/billing.ts
@lib/email/resend.ts
@lib/email/templates/review-request.tsx
@lib/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update validation schema and add re-send ready query</name>
  <files>lib/validations/send.ts, lib/data/send-logs.ts</files>
  <action>
1. In `lib/validations/send.ts`:
   - Update `batchSendSchema` to change max from 50 to 25: `.max(25, 'Maximum 25 contacts per batch')`
   - Add optional `customSubject` field (same as sendRequestSchema)
   - Export the updated type

2. In `lib/data/send-logs.ts`:
   - Add `getResendReadyContacts` function that:
     - Takes a Supabase client and businessId
     - Calculates cooldown cutoff date (now minus COOLDOWN_DAYS)
     - Queries contacts table for: business_id match, status='active', opted_out=false, last_sent_at is NOT null (has been sent before), last_sent_at < cooldownDate (cooldown expired)
     - Orders by last_sent_at ascending (oldest first)
     - Returns array of contacts with id, name, email, last_sent_at, send_count
   - Import COOLDOWN_DAYS from billing constants (already imported)
   - The function should accept a pre-created Supabase client (not create its own), to be called from the send page server component
  </action>
  <verify>Run `pnpm typecheck` - no errors related to send.ts or send-logs.ts</verify>
  <done>batchSendSchema has max 25 cap; getResendReadyContacts returns contacts past cooldown</done>
</task>

<task type="auto">
  <name>Task 2: Create batchSendReviewRequest server action</name>
  <files>lib/actions/send.ts, lib/types/database.ts</files>
  <action>
1. In `lib/types/database.ts`, add a `BatchSendActionState` type (or add it in send.ts):
   ```typescript
   export type BatchSendActionState = {
     error?: string
     success?: boolean
     data?: {
       sent: number
       skipped: number
       failed: number
       details?: Array<{ contactId: string; contactName: string; status: 'sent' | 'skipped' | 'failed'; reason?: string }>
     }
   }
   ```

2. In `lib/actions/send.ts`, add `batchSendReviewRequest` server action following the existing `sendReviewRequest` pattern:

   Flow:
   a. Authenticate user (same as single send)
   b. Parse formData: contactIds as JSON string, templateId optional, customSubject optional
   c. Validate with batchSendSchema
   d. Get business (same query as single send, include tier)
   e. Check business has google_review_link
   f. Check monthly quota: get monthlyCount, calculate remainingQuota = monthlyLimit - monthlyCount. If contactIds.length > remainingQuota, return error with remaining quota amount.
   g. Fetch all requested contacts in ONE query: `.in('id', contactIds).eq('business_id', business.id)`. Do NOT filter by cooldown/opt-out in SQL - fetch all to categorize skipped vs eligible.
   h. Categorize contacts:
      - Eligible: status='active', opted_out=false, and (last_sent_at is null OR last_sent_at < cooldownDate)
      - Skipped: all others (with reason: 'cooldown', 'opted_out', 'archived', 'not_found')
   i. For contacts not found in DB results, mark as skipped with reason 'not_found'
   j. Do NOT apply the 10/min rate limit (batch has its own 25-cap control). Skip `checkSendRateLimit` call.
   k. Loop through eligible contacts and for each:
      - Create send_log with status 'pending'
      - Render email using ReviewRequestEmail template (same as single send)
      - Send via resend.emails.send with idempotencyKey
      - Update send_log status to 'sent' or 'failed'
      - Update contact last_sent_at and send_count
      - Track result (sent or failed)
   l. Return BatchSendActionState with counts and details array
   m. Call revalidatePath for '/dashboard/contacts' and '/dashboard/send'

   Important implementation notes:
   - Do NOT wrap the entire batch in a try/catch that swallows individual failures. Each contact send should have its own try/catch.
   - Use the same email template/rendering logic as sendReviewRequest
   - Import batchSendSchema from validations
   - Export the BatchSendActionState type and batchSendReviewRequest function
   - The getMonthlyCount helper is already defined in send.ts as a private function - reuse it
  </action>
  <verify>Run `pnpm typecheck` - no errors. Verify the exported function signature matches useActionState pattern (prevState, formData) => Promise</verify>
  <done>batchSendReviewRequest validates contacts, checks quota, sends emails, returns sent/skipped/failed counts with details</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with no errors
- `pnpm lint` passes
- batchSendSchema exports with max 25
- batchSendReviewRequest is exported from lib/actions/send.ts
- getResendReadyContacts is exported from lib/data/send-logs.ts
- BatchSendActionState type is defined and exported
</verification>

<success_criteria>
- batchSendSchema validates contactIds array with max 25
- batchSendReviewRequest handles: auth, quota check (full batch fits), contact categorization (eligible vs skipped), individual send with error handling, structured results
- getResendReadyContacts returns contacts where last_sent_at < cooldownDate and last_sent_at is not null
- No rate limit applied to batch (intentional - batch has its own 25-cap)
</success_criteria>

<output>
After completion, create `.planning/phases/11-bulk-send-resend-integrations/11-01-SUMMARY.md`
</output>
