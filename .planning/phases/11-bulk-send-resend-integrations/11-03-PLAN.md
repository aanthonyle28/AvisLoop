---
phase: 11-bulk-send-resend-integrations
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - components/send/contact-selector.tsx
  - components/send/send-form.tsx
  - components/send/batch-results.tsx
  - app/(dashboard)/send/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can select multiple contacts via checkboxes (up to 25)"
    - "User can 'Select all' visible/filtered contacts"
    - "User sees summary before sending: 'Sending to X contacts (Y skipped)'"
    - "User sees results after sending: sent/failed/skipped counts"
    - "User can filter to 'Ready to re-send' contacts whose cooldown expired"
  artifacts:
    - path: "components/send/contact-selector.tsx"
      provides: "Multi-select contact list with checkboxes and select-all"
      contains: "checkbox"
    - path: "components/send/send-form.tsx"
      provides: "Batch send mode with summary and results display"
      contains: "batchSendReviewRequest"
    - path: "components/send/batch-results.tsx"
      provides: "Results display component showing sent/skipped/failed"
    - path: "app/(dashboard)/send/page.tsx"
      provides: "Send page with re-send ready filter and batch support"
  key_links:
    - from: "components/send/send-form.tsx"
      to: "lib/actions/send.ts"
      via: "batchSendReviewRequest server action"
      pattern: "batchSendReviewRequest"
    - from: "components/send/contact-selector.tsx"
      to: "components/send/send-form.tsx"
      via: "selectedContacts array passed up via onSelectionChange"
      pattern: "onSelectionChange"
    - from: "app/(dashboard)/send/page.tsx"
      to: "lib/data/send-logs.ts"
      via: "getResendReadyContacts for filter"
      pattern: "getResendReadyContacts"
---

<objective>
Build the frontend UI for bulk sending review requests with multi-select, batch summary/results, and the "Ready to re-send" filter.

Purpose: Transforms the single-contact send page into a powerful batch send interface where users can select multiple contacts, see a pre-send summary, and view detailed results.

Output: Refactored contact selector with checkboxes, batch-aware send form, results component, re-send filter on send page.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-bulk-send-resend-integrations/11-RESEARCH.md
@.planning/phases/11-bulk-send-resend-integrations/11-01-SUMMARY.md

@components/send/contact-selector.tsx
@components/send/send-form.tsx
@components/send/message-preview.tsx
@app/(dashboard)/send/page.tsx
@lib/actions/send.ts
@lib/data/send-logs.ts
@lib/constants/billing.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor contact selector for multi-select with checkboxes</name>
  <files>components/send/contact-selector.tsx</files>
  <action>
Rewrite `components/send/contact-selector.tsx` to support multi-select mode:

1. Change the component interface:
   ```typescript
   interface ContactSelectorProps {
     contacts: Contact[]
     selectedIds: Set<string>
     onSelectionChange: (ids: Set<string>) => void
     maxSelection?: number  // default 25
     resendReadyIds?: Set<string>  // contacts ready for re-send
   }
   ```

2. Add state and filtering:
   - Keep existing search filter
   - Add filter mode state: 'all' | 'ready-to-resend'
   - When 'ready-to-resend' is active, filter to only contacts whose ID is in resendReadyIds
   - Show filter toggle buttons at top: "All Contacts" | "Ready to Re-send (N)"

3. Render contact list with checkboxes:
   - Use Radix Checkbox component (`@radix-ui/react-checkbox` - already installed)
   - Each row: checkbox + name + email + cooldown badge or "sent Nx" badge
   - Contacts on cooldown: show checkbox but disabled with cooldown badge
   - Contacts opted out should not appear (filtered out by page.tsx already)

4. Select All functionality:
   - "Select All" checkbox in header (above the list)
   - Selects all VISIBLE (filtered) contacts that are NOT on cooldown, up to maxSelection
   - Show indeterminate state when some but not all are selected
   - Label: "Select all (N)" or "N selected" when some are selected

5. Selection cap enforcement:
   - When selectedIds.size >= maxSelection (25), disable unchecked checkboxes
   - Show count: "X / 25 selected" near the top
   - If user tries to select more, show a subtle message: "Maximum 25 contacts per batch"

6. Contact row display:
   - For contacts in resendReadyIds: show "Ready to re-send" badge in green
   - For contacts with last_sent_at and on cooldown: show "Xd cooldown" badge in yellow (disabled)
   - For contacts never sent: show nothing or "Never sent" in gray
   - Show days since last sent for re-send ready contacts: "Last sent Xd ago"

7. Hidden inputs for form submission:
   - Replace single `<input type="hidden" name="contactId">` with `<input type="hidden" name="contactIds" value={JSON.stringify(Array.from(selectedIds))}>`

Style with existing Tailwind classes. Keep the scrollable list with max-h-80. Use the existing search input styling.
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>Contact selector shows checkboxes, supports select-all, enforces 25-cap, has re-send ready filter, passes selected IDs as JSON hidden input</done>
</task>

<task type="auto">
  <name>Task 2: Update send form for batch mode and create results component</name>
  <files>components/send/send-form.tsx, components/send/batch-results.tsx, app/(dashboard)/send/page.tsx</files>
  <action>
1. Create `components/send/batch-results.tsx`:
   - Props: `{ results: { sent: number; skipped: number; failed: number; details?: Array<{ contactId: string; contactName: string; status: 'sent' | 'skipped' | 'failed'; reason?: string }> } }`
   - Show summary card with:
     - Green: "X sent successfully" with CheckCircle2 icon
     - Yellow: "Y skipped" with AlertTriangle icon (if > 0)
     - Red: "Z failed" with XCircle icon (if > 0)
   - Expandable details section (click to toggle):
     - List each contact with their status and reason
     - Color-code by status
   - "Send More" button to reset and go back to selection
   - Use existing card/border styling patterns

2. Refactor `components/send/send-form.tsx`:
   - Change state from `selectedContact: Contact | null` to `selectedContacts: Set<string>` (set of contact IDs)
   - Add `selectedContactsList` computed from contacts array filtered by selectedContacts set
   - Replace ContactSelector usage:
     - Pass `selectedIds={selectedContacts}` and `onSelectionChange={setSelectedContacts}`
     - Pass `resendReadyIds` prop (from page.tsx)
   - Add batch action state:
     - `const [batchState, batchFormAction, isBatchPending] = useActionState(batchSendReviewRequest, null)`
   - Show pre-send summary when contacts selected:
     - "Ready to send to X contact(s)"
     - If any selected contacts are on cooldown (shouldn't happen since disabled, but safety): "Y will be skipped (cooldown/opted-out)"
     - Template selector (same as before)
   - Submit button text: "Send to X Contact(s)" instead of "Send Review Request"
   - On success: show BatchResults component with batchState.data
   - On error: show error alert (same pattern as current)
   - Keep single-send as fallback: if only 1 contact selected, still use batch action (simpler than maintaining two paths)
   - Hidden inputs in form: `contactIds` as JSON string, `templateId`
   - Update SendFormProps to include `resendReadyContactIds: string[]`

3. Update `app/(dashboard)/send/page.tsx`:
   - Import `getResendReadyContacts` from `lib/data/send-logs.ts`
   - In the data fetching section, add call to get re-send ready contacts:
     - Need to pass supabase client and business.id
     - Since getResendReadyContacts takes (supabase, businessId), call it after getting business
     - Or modify to call in the Promise.all if signature allows
   - Pass `resendReadyContactIds` to SendForm: array of contact IDs from resend-ready query
   - Update the usage display to reflect batch capability
   - Keep existing limit checks and warnings

IMPORTANT: The form should use `batchSendReviewRequest` (from Plan 01) for ALL sends now, even single contact. This simplifies the code path. Remove the single `sendReviewRequest` import and usage.

Form data format for batch:
- `contactIds`: JSON string array of UUIDs
- `templateId`: optional UUID string
- `customSubject`: optional string
  </action>
  <verify>
- `pnpm typecheck` passes
- `pnpm lint` passes
- Dev server renders send page without errors
  </verify>
  <done>
- Send page shows multi-select contact list with checkboxes
- "Select all" selects visible contacts up to 25
- "Ready to re-send" filter shows contacts past cooldown
- Pre-send summary shows count of contacts to send
- Results show sent/skipped/failed after batch completes
- Single contact sends also work through batch action
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm lint` passes
- `pnpm build` succeeds
- Contact selector renders checkboxes with select-all
- Selected count shows "X / 25 selected"
- Re-send filter shows only cooldown-expired contacts
- Batch send shows summary before sending
- Results component displays sent/skipped/failed counts
</verification>

<success_criteria>
- User can check multiple contacts (up to 25) via checkboxes
- "Select all" selects all visible/filtered non-cooldown contacts
- "Ready to re-send" filter shows contacts past 14-day cooldown with "last sent X days ago"
- Summary before send: "Sending to X contacts"
- Results after send: sent/skipped/failed with expandable details
- Form submits contactIds as JSON to batchSendReviewRequest action
</success_criteria>

<output>
After completion, create `.planning/phases/11-bulk-send-resend-integrations/11-03-SUMMARY.md`
</output>
