---
phase: 40-dashboard-command-center
plan: 04
type: execute
wave: 3
depends_on: ["40-02", "40-03"]
files_modified:
  - components/dashboard/right-panel-job-detail.tsx
  - components/dashboard/right-panel-attention-detail.tsx
  - components/dashboard/dashboard-client.tsx
  - lib/data/dashboard.ts
  - lib/types/dashboard.ts
autonomous: true

must_haves:
  truths:
    - "Clicking a Ready to Send job replaces right panel with job details showing customer info, campaign data, technician, completion date, notes, and Enroll CTA"
    - "Clicking a Needs Attention failed delivery shows customer info, error description, and Retry button"
    - "Clicking a Needs Attention low rating shows customer info, rating, feedback text, and Resolve button"
    - "Close button (X) on detail views returns right panel to default KPI/activity state"
    - "Getting Started content renders in right panel when user has not completed setup"
  artifacts:
    - path: "components/dashboard/right-panel-job-detail.tsx"
      provides: "Job detail view for right panel with customer info, campaign data, and enroll CTA"
      contains: "RightPanelJobDetail"
    - path: "components/dashboard/right-panel-attention-detail.tsx"
      provides: "Attention detail view for right panel with retry/resolve actions"
      contains: "RightPanelAttentionDetail"
  key_links:
    - from: "components/dashboard/dashboard-client.tsx"
      to: "components/dashboard/right-panel-job-detail.tsx"
      via: "renders when panelView.type === 'job-detail'"
      pattern: "job-detail"
    - from: "components/dashboard/right-panel-job-detail.tsx"
      to: "lib/actions/dashboard.ts"
      via: "calls getJobDetail to fetch full job data, calls quickEnrollJob for enrollment"
      pattern: "getJobDetail|quickEnrollJob"
---

<objective>
Create job detail and attention detail contextual views for the right panel, wire them into the dashboard, and integrate Getting Started into the panel.

Purpose: This brings the right panel to life — clicking items in the left column lists now shows rich contextual detail in the right panel instead of opening a drawer. Also integrates Getting Started content.
Output: Three contextual views (job detail, attention detail, getting started) render in the right panel based on user interaction.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/40-dashboard-command-center/40-CONTEXT.md
@.planning/phases/40-dashboard-command-center/40-01-SUMMARY.md
@.planning/phases/40-dashboard-command-center/40-02-SUMMARY.md
@.planning/phases/40-dashboard-command-center/40-03-SUMMARY.md

# Source files to reference for patterns:
@components/jobs/job-detail-drawer.tsx
@components/dashboard/attention-alerts.tsx
@lib/actions/dashboard.ts
@lib/data/dashboard.ts
@lib/types/dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create job detail and attention detail right panel views</name>
  <files>components/dashboard/right-panel-job-detail.tsx, components/dashboard/right-panel-attention-detail.tsx, lib/data/dashboard.ts, lib/types/dashboard.ts</files>
  <action>
**Enhance data layer — `lib/data/dashboard.ts`:**

Add a new function `getReadyToSendJobWithCampaign(jobId: string, businessId: string)` that fetches a single job with its matching campaign info for display in the right panel (JD-02). This function:
1. Fetches the job with customer data (name, email, phone)
2. Fetches the job's existing enrollment OR finds the matching active campaign for the service type
3. Returns an object with: job data, customer data, matching campaign name/type, technician (if the field exists — check if jobs table has a technician column; if not, skip this field), notes, completion date
4. Returns null if job not found or unauthorized

Add the return type to `lib/types/dashboard.ts`:
```typescript
export interface JobPanelDetail {
  id: string
  customer: { id: string; name: string; email: string; phone: string | null }
  serviceType: string
  status: string
  completedAt: string | null
  createdAt: string
  notes: string | null
  campaignOverride: string | null
  enrollmentResolution: string | null
  // Campaign info for display
  matchingCampaignName: string | null
  matchingCampaignId: string | null
  // Enrollment info if already enrolled
  enrollmentStatus: string | null
  enrollmentCampaignName: string | null
}
```

**Create `components/dashboard/right-panel-job-detail.tsx` (JD-01, JD-02, JD-03):**

A 'use client' component rendering job details in the right panel. This reuses content patterns from JobDetailDrawer but renders inline (not in a Sheet).

Structure:
1. **Customer Section:** Customer name (text-lg font-semibold), email + phone with copy buttons (same pattern as job-detail-drawer.tsx lines 427-458)
2. **Job Info:** Service type badge, status (StatusDot), created/completed dates, formatted with date-fns
3. **Campaign Section (JD-02):** Shows matching campaign name or enrollment status. Reuse the `renderCampaignStatus` logic pattern from job-detail-drawer.tsx but simplified — focus on:
   - If enrolled: "Enrolled in {campaignName}" with CheckCircle
   - If matching campaign but not enrolled: "Matching campaign: {name}" with Clock icon
   - If no campaign: "No matching campaign"
   - If one-off: "One-off request"
4. **Notes Section:** Display job.notes or "No notes" (italic muted)
5. **CTA Button (JD-03):** "Enroll in {Campaign Name} Campaign" primary button
   - Only shown when: job is completed, not enrolled, has matching campaign, not one_off, not conflict/queue_after
   - On click, call `quickEnrollJob(jobId)` from `@/lib/actions/dashboard`
   - Show loading spinner while enrolling, toast on success/error
   - After success, close the detail view (call `closePanel()` from useDashboardPanel)
   - For one-off jobs, show "Send One-Off" button instead (opens QuickSendModal — pass handler from parent)
   - For conflict jobs, show Replace/Skip/Queue buttons (same as current ready-to-send-queue)

Props: `{ jobId: string }` — fetches data on mount using `useEffect` + `getJobDetail` server action
State: loading/data/error with skeleton while loading

The component uses `useDashboardPanel()` to call `closePanel()` when enrollment completes.

Import icons from @phosphor-icons/react consistently with existing patterns.

**Create `components/dashboard/right-panel-attention-detail.tsx` (NA-01, NA-02, NA-03):**

A 'use client' component rendering attention alert details in the right panel.

Receives the full alert data via prop (since the parent already has it from the alerts array).

Structure varies by alert type:

**For failed_send (NA-02):**
1. Customer name (title)
2. "Send Failed" heading with XCircle icon (destructive color)
3. Error message: display the error description in a muted card/box
4. Timestamp: "Failed {timeAgo}"
5. Action: "Retry" primary button — calls `retrySend(sendLogId)` from dashboard actions
6. Loading state while retrying, toast on success/error

**For unresolved_feedback (NA-03):**
1. Customer name (title)
2. Rating display: show stars (filled/empty) based on rating value (1-5)
3. Feedback text: display in a quoted/card style if present
4. Timestamp: "Submitted {timeAgo}"
5. Action: "Resolve" outline button — links to `/feedback?id={feedbackId}` (opens feedback page)
6. Additional: "View Customer" link to customer detail

**For bounced_email:**
1. Customer name
2. "Email Bounced" heading
3. Error description
4. Action: "Update Customer" button — links to customer page
5. "Acknowledge" ghost button — calls `acknowledgeAlert(sendLogId)`

Props: `{ alert: SelectableAlertItem }` (uses the type from Plan 01)

The component uses `useDashboardPanel()` to call `closePanel()` after successful actions.
  </action>
  <verify>
Run `pnpm typecheck` — should pass.
Run `pnpm lint` — should pass.
Verify both panel components exist and handle their respective detail views.
  </verify>
  <done>Job detail panel shows customer info, campaign data, and enroll CTA (JD-01, JD-02, JD-03). Attention detail panel shows contextual actions for failed sends and low ratings (NA-01, NA-02, NA-03).</done>
</task>

<task type="auto">
  <name>Task 2: Wire detail views and Getting Started into dashboard</name>
  <files>components/dashboard/dashboard-client.tsx</files>
  <action>
**Modify `components/dashboard/dashboard-client.tsx`:**

This is the Client Component wrapper created in Plan 02. Update it to:

1. Import RightPanelJobDetail, RightPanelAttentionDetail, RightPanelGettingStarted
2. Use `useDashboardPanel()` to get current `panelView`
3. Wire the DashboardShell's `detailContent` prop:
   - When `panelView.type === 'job-detail'`: render `<RightPanelJobDetail jobId={panelView.jobId} />`
   - When `panelView.type === 'attention-detail'`: find the alert from the alerts array by ID, render `<RightPanelAttentionDetail alert={alert} />`
   - Otherwise: null

4. Wire the DashboardShell's `gettingStartedContent` prop:
   - Render `<RightPanelGettingStarted items={setupProgress.items} />` when setup progress data exists and is not all complete
   - The DashboardShell/RightPanel should show Getting Started ONLY when panelView.type === 'default' AND user hasn't completed setup (first job not added). The logic:
     - If `setupProgress.completedCount === 0` and `!setupProgress.dismissed`: show Getting Started INSTEAD of default KPI/activity
     - If some items done but not all: show compact Getting Started BELOW the default KPI/activity
     - If all complete or dismissed: show only default KPI/activity
   - Claude's discretion on exact implementation of the Getting Started / default content interplay in the right panel

5. Pass `selectedJobId` to ReadyToSendQueue based on panelView.type === 'job-detail' ? panelView.jobId : undefined
6. Pass `selectedAlertId` to AttentionAlerts based on panelView.type === 'attention-detail' ? panelView.alertId : undefined

7. Wire `onSelectJob` from ReadyToSendQueue: `(jobId) => setPanelView({ type: 'job-detail', jobId })`
8. Wire `onSelectAlert` from AttentionAlerts: `(alertId) => setPanelView({ type: 'attention-detail', alertId })`

9. Remove the WelcomeCard rendering from the left column (it's now in the right panel as Getting Started)

10. Ensure the left column passes the setup progress items to the server so it can be forwarded to the client. The dashboard page.tsx server component already fetches setupProgress — make sure it's passed through to dashboard-client.tsx.
  </action>
  <verify>
Run `pnpm typecheck` — should pass.
Run `pnpm lint` — should pass.
Test flow: click a Ready to Send job → right panel shows job detail with campaign info and Enroll button. Click X → returns to KPI/activity default. Click a Needs Attention alert → right panel shows contextual detail with retry/resolve. New users see Getting Started in right panel.
  </verify>
  <done>
All three contextual views wired into dashboard: job detail (JD-01–JD-04), attention detail (NA-01–NA-03), Getting Started (GS-01–GS-03). Close button returns to default (JD-04). Clicking items in left lists swaps right panel content. WelcomeCard removed from left column.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. Clicking Ready to Send job → right panel shows job detail with customer info, campaign data, notes, enroll CTA
4. Clicking Needs Attention failed send → right panel shows error + retry button
5. Clicking Needs Attention feedback → right panel shows rating + feedback + resolve link
6. Close (X) button returns to default KPI/activity view
7. Getting Started shows in right panel for new users (before first job)
8. Getting Started shows compact version after first job but before first review
</verification>

<success_criteria>
- JD-01: Job detail shows customer info, service type, completion date, notes
- JD-02: Job detail shows matching campaign name
- JD-03: Enroll CTA button works
- JD-04: Close returns to default view
- NA-01: Clicking attention item opens detail
- NA-02: Failed delivery shows error + retry
- NA-03: Low rating shows rating + feedback + resolve
- GS-01: Full Getting Started in right panel before first job
- GS-02: Compact Getting Started after first job, before first review
- RP-02: Panel state machine works (all 4 views are mutually exclusive)
</success_criteria>

<output>
After completion, create `.planning/phases/40-dashboard-command-center/40-04-SUMMARY.md`
</output>
