---
phase: 40-dashboard-command-center
plan: 02
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - app/(dashboard)/dashboard/page.tsx
  - components/dashboard/kpi-widgets.tsx
  - components/dashboard/recent-campaign-activity.tsx
  - components/dashboard/ready-to-send-queue.tsx
  - components/dashboard/attention-alerts.tsx
  - components/dashboard/right-panel-default.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard page renders in two-column layout using DashboardShell on desktop"
    - "Right panel default view shows 3 KPI cards, 3 pipeline counters, and recent activity feed"
    - "Ready to Send list renders compact rows (not Card wrapper) with customer name, service type badge, time since completion, and matching campaign name"
    - "Needs Attention list renders compact rows with colored left border (red for failed, amber for low rating)"
    - "Clicking a Ready to Send job item sets panel view to job-detail"
    - "Clicking a Needs Attention item sets panel view to attention-detail"
    - "Enroll All button appears in Ready to Send header with confirmation dialog"
    - "Greeting header shows dynamic subtitle with counts and right-aligned Add Job + View Campaigns buttons"
  artifacts:
    - path: "components/dashboard/right-panel-default.tsx"
      provides: "Default right panel content with compact KPIs, pipeline counters, and activity feed"
      contains: "RightPanelDefault"
    - path: "app/(dashboard)/dashboard/page.tsx"
      provides: "Dashboard page using DashboardShell layout"
      contains: "DashboardShell"
    - path: "components/dashboard/ready-to-send-queue.tsx"
      provides: "Refactored Ready to Send with compact rows and item click handler"
      contains: "onSelectJob"
    - path: "components/dashboard/attention-alerts.tsx"
      provides: "Refactored Needs Attention with compact rows and item click handler"
      contains: "onSelectAlert"
  key_links:
    - from: "app/(dashboard)/dashboard/page.tsx"
      to: "components/dashboard/dashboard-shell.tsx"
      via: "wraps content in DashboardShell"
      pattern: "DashboardShell"
    - from: "components/dashboard/ready-to-send-queue.tsx"
      to: "components/dashboard/dashboard-shell.tsx"
      via: "calls useDashboardPanel().setPanelView on job click"
      pattern: "useDashboardPanel"
---

<objective>
Wire the dashboard page into the two-column layout, create the right panel default content, and refactor left column lists to compact row format with item selection.

Purpose: This is the core dashboard restructure — transforms the single-column stack into the command center layout. After this plan, the dashboard visually works as a two-column command center with default KPI/activity panel.
Output: Dashboard page uses DashboardShell, right panel shows KPIs and activity, left column shows compact task lists.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/40-dashboard-command-center/40-CONTEXT.md
@.planning/phases/40-dashboard-command-center/40-01-SUMMARY.md

# Source files being modified:
@app/(dashboard)/dashboard/page.tsx
@components/dashboard/kpi-widgets.tsx
@components/dashboard/recent-campaign-activity.tsx
@components/dashboard/ready-to-send-queue.tsx
@components/dashboard/attention-alerts.tsx
@lib/types/dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create right panel default content component</name>
  <files>components/dashboard/right-panel-default.tsx, components/dashboard/kpi-widgets.tsx</files>
  <action>
**Create `components/dashboard/right-panel-default.tsx`:**

A 'use client' component that renders the default right panel content (DL-02, DL-03):

**Section 1: KPI Cards (compact)**
- 3 KPI cards stacked vertically (NOT the wide cards from kpi-widgets.tsx — these are compact panel-width cards)
- Each card: title (text-xs text-muted-foreground), value (text-2xl font-bold), TrendIndicator (size="sm")
  - Reviews This Month — Star icon, amber accent
  - Average Rating — ChartBar icon, green accent
  - Conversion Rate — Target icon, blue accent
- Cards use the existing `Card` component with `p-4` padding (compact)
- Import TrendIndicator from kpi-widgets.tsx (need to export it if not already exported)

**Section 2: Pipeline Counters**
- A single row or grid of 3 inline counters below the KPIs
- Format: `<value> <label>` in a compact horizontal strip
  - "X Sent" (requestsSentThisWeek)
  - "X Active" (activeSequences)
  - "X Queued" (pendingQueued)
- Use `text-sm font-semibold` for value, `text-xs text-muted-foreground` for label
- Arrange as `grid grid-cols-3` or `flex justify-between` with dividers

**Section 3: Recent Activity Feed**
- Reuse the event rendering logic from RecentCampaignActivity but in a simpler list format
- Show up to 5 events with icon, description, timestamp
- "View All" link to /history at bottom
- If no events, show "No activity yet" muted text

Props: `{ kpiData: DashboardKPIs, pipelineSummary: PipelineSummary, events: CampaignEvent[] }`

Export: `RightPanelDefault`

**Modify `components/dashboard/kpi-widgets.tsx`:**
- Export the `TrendIndicator` component (add `export` keyword if it's not already exported)
- The existing KPIWidgets component stays unchanged (it will no longer be rendered on the dashboard page, but other pages might use it in the future)
  </action>
  <verify>Run `pnpm typecheck` — should pass. Verify RightPanelDefault component renders KPIs, pipeline, and activity.</verify>
  <done>Right panel default view shows 3 compact KPI cards with trends, 3 pipeline counters, and recent activity feed (DL-02, DL-03)</done>
</task>

<task type="auto">
  <name>Task 2: Refactor left column lists and wire dashboard page to two-column layout</name>
  <files>app/(dashboard)/dashboard/page.tsx, components/dashboard/ready-to-send-queue.tsx, components/dashboard/attention-alerts.tsx</files>
  <action>
**Refactor `components/dashboard/ready-to-send-queue.tsx`:**

Transform from Card-wrapped list to compact row list for left column:

1. Add new prop: `onSelectJob?: (jobId: string) => void`
2. Remove the outer `<Card>` wrapper — render a plain `<div>` with just a header and list
3. Header bar: "Ready to Send" title (text-lg font-semibold) + badge count + **"Enroll All" button** (RS-01):
   - "Enroll All" button: `size="sm" variant="outline"`, disabled when no enrollable jobs
   - Clicking "Enroll All" opens an AlertDialog confirmation listing all job names before executing
   - The confirmation dialog shows a scrollable list of jobs that will be enrolled (customer name + service type)
   - On confirm, call `quickEnrollJob` for each enrollable job sequentially, show progress toast
4. Each job row rendered as compact clickable row:
   - **Row format**: `flex items-center gap-3 py-2.5 px-3 rounded-md cursor-pointer hover:bg-muted/50 transition-colors`
   - When clicked (not on action buttons), call `onSelectJob?.(job.id)` to open right panel detail
   - Left content: customer name (text-sm font-medium), service type as small Badge, relative time (text-xs muted)
   - Also show matching campaign name if available: `text-xs text-muted-foreground` — "→ HVAC Campaign"
   - Right side: primary action button (Enroll/Complete/Send One-Off) + dismiss X button (same as current)
   - For conflict/queue_after jobs, keep the same action buttons but in compact form
5. Add `selectedJobId?: string` prop — when a job is selected, highlight it with `bg-muted` background
6. Keep ALL existing action handlers (handleEnroll, handleComplete, handleDismiss, handleSendOneOff, etc.) — do NOT remove any functionality
7. Keep the JobDetailDrawer at the bottom of the component (it's used by Jobs page too)
8. Keep the QuickSendModal and AlertDialog for replace confirmation
9. The skeleton export (ReadyToSendQueueSkeleton) should be updated to match the new compact layout

**Refactor `components/dashboard/attention-alerts.tsx`:**

Transform from Card-wrapped list to compact row list:

1. Add new prop: `onSelectAlert?: (alertId: string) => void`
2. Remove the outer `<Card>` wrapper — render a plain `<div>` with header and list
3. Header bar: "Needs Attention" title + badge count
4. Each alert row:
   - Compact clickable row with same hover style as Ready to Send
   - **Colored left border**: `border-l-2 border-destructive` for critical (failed sends), `border-l-2 border-warning` for warning (bounced/feedback)
   - When clicked, call `onSelectAlert?.(alert.id)` to open right panel detail
   - Keep severity icon, title, description, timestamp
   - Remove inline action buttons from the row (they'll be in the right panel detail view instead — NA-02, NA-03)
   - Keep the "View all" expand toggle for 3+ alerts
5. Add `selectedAlertId?: string` prop — when selected, highlight with `bg-muted`

**Modify `app/(dashboard)/dashboard/page.tsx`:**

Restructure the dashboard page to use DashboardShell:

1. Import DashboardShell, DashboardPanelProvider from `@/components/dashboard/dashboard-shell`
2. Import RightPanelDefault from `@/components/dashboard/right-panel-default`
3. Remove the outer `<div className="container py-6 space-y-6">` wrapper
4. Wrap everything in `<DashboardPanelProvider>` then `<DashboardShell>`
5. The DashboardShell's left column (children) contains:
   - Header section with greeting, dynamic subtitle (DH-01):
     - `{greeting}, {firstName}` as h1 (text-2xl font-bold)
     - Dynamic subtitle (p tag, text-sm text-muted-foreground): "{readyJobs.length} jobs ready to send · {alerts.length} items need attention"
     - When both are 0: "Sent {kpiData.requestsSentThisWeek.value} messages this week · {kpiData.reviewsThisMonth.value} reviews received"
   - Right-aligned header action buttons (DH-02): "+ Add Job" (primary, using AddJobProvider openAddJob) and "View Campaigns" (outline, Link to /campaigns)
   - WelcomeCard (same conditional rendering as before — but only in left column, will be in right panel in Plan 04)
   - ReadyToSendQueue (now without Card wrapper, compact rows)
   - AttentionAlerts (now without Card wrapper, compact rows)
6. The DashboardShell's defaultContent renders `<RightPanelDefault>` with kpiData, pipelineSummary, and events
7. The DashboardShell's detailContent is `null` for now (filled in Plan 04)
8. Since dashboard page is a Server Component, the DashboardPanelProvider + DashboardShell wrapper must be a Client Component wrapper. Create a small `components/dashboard/dashboard-client.tsx` Client Component that wraps DashboardPanelProvider + DashboardShell and accepts all the data props from the server. The Server Component passes data down to it.

This is a large refactor. Key principle: **preserve all existing functionality** — enrollment, conflict resolution, send one-off, dismiss, etc. The only visual changes are layout (two-column) and list density (compact rows). All action handlers stay the same.
  </action>
  <verify>
Run `pnpm typecheck` — should pass.
Run `pnpm lint` — should pass.
Navigate to /dashboard — should render two-column layout on desktop, left column with compact task lists, right panel with KPIs and activity.
  </verify>
  <done>
Dashboard renders in two-column layout (DL-01). Right panel default shows KPIs + pipeline + activity (DL-02, DL-03). Ready to Send has compact rows with Enroll All button (RS-01, RS-02 partial). Needs Attention has compact rows with colored left borders. Header shows greeting with dynamic subtitle and action buttons (DH-01, DH-02). Job and alert rows are clickable to trigger panel view changes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. Dashboard page renders two-column layout on lg+ screens
4. Right panel shows compact KPI cards, pipeline counters, and activity feed
5. Left column shows compact row lists for Ready to Send and Needs Attention
6. Enroll All button appears in Ready to Send header with confirmation dialog
7. Header shows greeting with dynamic subtitle and action buttons
8. All existing enrollment/conflict/dismiss functionality preserved
</verification>

<success_criteria>
- DL-01: Two-column layout renders on desktop (left flexible, right ~360px fixed)
- DL-02: Right panel shows KPIs with trends and pipeline counters
- DL-03: Right panel shows recent activity feed
- DH-01: Greeting headline with dynamic subtitle
- DH-02: Add Job + View Campaigns buttons right-aligned
- RS-01: Enroll All with confirmation dialog
- RS-02: Clicking job opens job detail in right panel (handler wired, detail content in Plan 04)
- Existing functionality (enrollment, conflict resolution, dismiss) fully preserved
</success_criteria>

<output>
After completion, create `.planning/phases/40-dashboard-command-center/40-02-SUMMARY.md`
</output>
