---
phase: 24-multi-touch-campaign-engine
plan: 11
type: execute
wave: 5
depends_on: [24-08, 24-10]
files_modified:
  - lib/data/campaign-analytics.ts
  - components/campaigns/campaign-stats.tsx
  - app/(dashboard)/campaigns/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Campaign detail shows open/click/conversion rates per touch"
    - "Aggregated stats computed from send_logs table"
    - "Overall campaign performance metrics displayed"
  artifacts:
    - path: "lib/data/campaign-analytics.ts"
      provides: "Analytics aggregation queries"
      exports: ["getCampaignAnalytics", "getCampaignTouchStats"]
    - path: "components/campaigns/campaign-stats.tsx"
      provides: "Analytics display component"
      exports: ["CampaignStats"]
  key_links:
    - from: "lib/data/campaign-analytics.ts"
      to: "send_logs"
      via: "aggregation query"
      pattern: "GROUP BY.*touch_number"
    - from: "components/campaigns/campaign-stats.tsx"
      to: "lib/data/campaign-analytics.ts"
      via: "data fetch"
      pattern: "getCampaignTouchStats"
---

<objective>
Create campaign analytics showing performance metrics per touch and overall.

Purpose: Business owners can see how each touch performs (open rate, click rate, conversion) to optimize their campaign sequences.

Output: Analytics data functions and stats display component on campaign detail page.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/24-multi-touch-campaign-engine/24-RESEARCH.md
@lib/data/campaign.ts
@app/(dashboard)/campaigns/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create campaign analytics data functions</name>
  <files>lib/data/campaign-analytics.ts</files>
  <action>
Create lib/data/campaign-analytics.ts:

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'

export interface TouchStats {
  touch_number: number
  channel: string
  total_sends: number
  opens: number
  clicks: number
  conversions: number
  open_rate: number
  click_rate: number
  conversion_rate: number
}

export interface CampaignAnalytics {
  campaign_id: string
  total_enrollments: number
  active_enrollments: number
  completed_enrollments: number
  stopped_enrollments: number
  total_sends: number
  total_opens: number
  total_clicks: number
  total_conversions: number
  overall_open_rate: number
  overall_click_rate: number
  overall_conversion_rate: number
  touch_stats: TouchStats[]
}

/**
 * Get comprehensive analytics for a campaign.
 * Aggregates data from send_logs and campaign_enrollments.
 */
export async function getCampaignAnalytics(campaignId: string): Promise<CampaignAnalytics | null> {
  const supabase = await createClient()

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return null

  // Get enrollment counts
  const [activeResult, completedResult, stoppedResult] = await Promise.all([
    supabase
      .from('campaign_enrollments')
      .select('*', { count: 'exact', head: true })
      .eq('campaign_id', campaignId)
      .eq('status', 'active'),
    supabase
      .from('campaign_enrollments')
      .select('*', { count: 'exact', head: true })
      .eq('campaign_id', campaignId)
      .eq('status', 'completed'),
    supabase
      .from('campaign_enrollments')
      .select('*', { count: 'exact', head: true })
      .eq('campaign_id', campaignId)
      .eq('status', 'stopped'),
  ])

  const activeEnrollments = activeResult.count || 0
  const completedEnrollments = completedResult.count || 0
  const stoppedEnrollments = stoppedResult.count || 0
  const totalEnrollments = activeEnrollments + completedEnrollments + stoppedEnrollments

  // Get send_logs aggregated by touch
  const { data: sendLogs } = await supabase
    .from('send_logs')
    .select('touch_number, channel, status')
    .eq('campaign_id', campaignId)
    .not('touch_number', 'is', null)

  // Aggregate by touch
  const touchMap = new Map<number, {
    touch_number: number
    channel: string
    total: number
    opens: number
    clicks: number
  }>()

  for (const log of sendLogs || []) {
    if (log.touch_number === null) continue

    const existing = touchMap.get(log.touch_number) || {
      touch_number: log.touch_number,
      channel: log.channel || 'email',
      total: 0,
      opens: 0,
      clicks: 0,
    }

    existing.total++
    if (log.status === 'opened' || log.status === 'clicked') {
      existing.opens++
    }
    if (log.status === 'clicked') {
      existing.clicks++
    }

    touchMap.set(log.touch_number, existing)
  }

  // Count conversions (enrollments stopped with review_clicked)
  const { count: conversions } = await supabase
    .from('campaign_enrollments')
    .select('*', { count: 'exact', head: true })
    .eq('campaign_id', campaignId)
    .eq('stop_reason', 'review_clicked')

  // Calculate touch stats
  const touchStats: TouchStats[] = Array.from(touchMap.values())
    .sort((a, b) => a.touch_number - b.touch_number)
    .map(t => ({
      touch_number: t.touch_number,
      channel: t.channel,
      total_sends: t.total,
      opens: t.opens,
      clicks: t.clicks,
      conversions: 0, // Conversions attributed at campaign level, not touch level
      open_rate: t.total > 0 ? Math.round((t.opens / t.total) * 100) : 0,
      click_rate: t.total > 0 ? Math.round((t.clicks / t.total) * 100) : 0,
      conversion_rate: 0,
    }))

  // Calculate overall stats
  const totalSends = Array.from(touchMap.values()).reduce((sum, t) => sum + t.total, 0)
  const totalOpens = Array.from(touchMap.values()).reduce((sum, t) => sum + t.opens, 0)
  const totalClicks = Array.from(touchMap.values()).reduce((sum, t) => sum + t.clicks, 0)
  const totalConversions = conversions || 0

  return {
    campaign_id: campaignId,
    total_enrollments: totalEnrollments,
    active_enrollments: activeEnrollments,
    completed_enrollments: completedEnrollments,
    stopped_enrollments: stoppedEnrollments,
    total_sends: totalSends,
    total_opens: totalOpens,
    total_clicks: totalClicks,
    total_conversions: totalConversions,
    overall_open_rate: totalSends > 0 ? Math.round((totalOpens / totalSends) * 100) : 0,
    overall_click_rate: totalSends > 0 ? Math.round((totalClicks / totalSends) * 100) : 0,
    overall_conversion_rate: totalEnrollments > 0 ? Math.round((totalConversions / totalEnrollments) * 100) : 0,
    touch_stats: touchStats,
  }
}

/**
 * Get quick stats for campaign list view.
 */
export async function getCampaignQuickStats(campaignId: string): Promise<{
  active: number
  sent: number
  converted: number
}> {
  const supabase = await createClient()

  const [activeResult, sentResult, convertedResult] = await Promise.all([
    supabase
      .from('campaign_enrollments')
      .select('*', { count: 'exact', head: true })
      .eq('campaign_id', campaignId)
      .eq('status', 'active'),
    supabase
      .from('send_logs')
      .select('*', { count: 'exact', head: true })
      .eq('campaign_id', campaignId)
      .in('status', ['sent', 'delivered', 'opened', 'clicked']),
    supabase
      .from('campaign_enrollments')
      .select('*', { count: 'exact', head: true })
      .eq('campaign_id', campaignId)
      .eq('stop_reason', 'review_clicked'),
  ])

  return {
    active: activeResult.count || 0,
    sent: sentResult.count || 0,
    converted: convertedResult.count || 0,
  }
}
```
  </action>
  <verify>Analytics functions aggregate send_logs by touch with open/click/conversion rates</verify>
  <done>Campaign analytics queries aggregate send_logs for performance metrics</done>
</task>

<task type="auto">
  <name>Task 2: Create campaign stats display component</name>
  <files>components/campaigns/campaign-stats.tsx</files>
  <action>
Create components/campaigns/campaign-stats.tsx:

```typescript
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Progress } from '@/components/ui/progress'
import { Badge } from '@/components/ui/badge'
import { EnvelopeSimple, ChatCircle, Eye, CursorClick, Star } from '@phosphor-icons/react/dist/ssr'
import type { CampaignAnalytics, TouchStats } from '@/lib/data/campaign-analytics'

interface CampaignStatsProps {
  analytics: CampaignAnalytics
}

export function CampaignStats({ analytics }: CampaignStatsProps) {
  return (
    <div className="space-y-6">
      {/* Overall performance */}
      <Card>
        <CardHeader>
          <CardTitle>Overall Performance</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <Stat
              label="Total Sends"
              value={analytics.total_sends}
              icon={<EnvelopeSimple className="h-4 w-4" />}
            />
            <Stat
              label="Open Rate"
              value={`${analytics.overall_open_rate}%`}
              icon={<Eye className="h-4 w-4" />}
              color={getRateColor(analytics.overall_open_rate, 'open')}
            />
            <Stat
              label="Click Rate"
              value={`${analytics.overall_click_rate}%`}
              icon={<CursorClick className="h-4 w-4" />}
              color={getRateColor(analytics.overall_click_rate, 'click')}
            />
            <Stat
              label="Conversion Rate"
              value={`${analytics.overall_conversion_rate}%`}
              icon={<Star className="h-4 w-4" />}
              color={getRateColor(analytics.overall_conversion_rate, 'conversion')}
            />
          </div>
        </CardContent>
      </Card>

      {/* Per-touch performance */}
      {analytics.touch_stats.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Performance by Touch</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-6">
              {analytics.touch_stats.map((touch) => (
                <TouchStatRow key={touch.touch_number} stats={touch} />
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Enrollment funnel */}
      <Card>
        <CardHeader>
          <CardTitle>Enrollment Funnel</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            <FunnelRow
              label="Total Enrollments"
              value={analytics.total_enrollments}
              percentage={100}
            />
            <FunnelRow
              label="Completed (all touches sent)"
              value={analytics.completed_enrollments}
              percentage={analytics.total_enrollments > 0
                ? Math.round((analytics.completed_enrollments / analytics.total_enrollments) * 100)
                : 0}
            />
            <FunnelRow
              label="Converted (clicked review)"
              value={analytics.total_conversions}
              percentage={analytics.total_enrollments > 0
                ? Math.round((analytics.total_conversions / analytics.total_enrollments) * 100)
                : 0}
              highlight
            />
          </div>
        </CardContent>
      </Card>
    </div>
  )
}

function Stat({
  label,
  value,
  icon,
  color,
}: {
  label: string
  value: string | number
  icon: React.ReactNode
  color?: string
}) {
  return (
    <div className="space-y-1">
      <div className="flex items-center gap-2 text-muted-foreground">
        {icon}
        <span className="text-sm">{label}</span>
      </div>
      <div className={`text-2xl font-bold ${color || ''}`}>{value}</div>
    </div>
  )
}

function TouchStatRow({ stats }: { stats: TouchStats }) {
  return (
    <div className="flex items-center gap-4">
      <div className="flex items-center gap-2 w-24 shrink-0">
        <Badge variant={stats.channel === 'email' ? 'secondary' : 'default'}>
          {stats.channel === 'email' ? (
            <EnvelopeSimple className="h-3 w-3 mr-1" />
          ) : (
            <ChatCircle className="h-3 w-3 mr-1" />
          )}
          Touch {stats.touch_number}
        </Badge>
      </div>

      <div className="flex-1 grid grid-cols-4 gap-4 text-sm">
        <div>
          <span className="text-muted-foreground">Sent:</span>{' '}
          <span className="font-medium">{stats.total_sends}</span>
        </div>
        <div>
          <span className="text-muted-foreground">Opens:</span>{' '}
          <span className="font-medium">{stats.open_rate}%</span>
        </div>
        <div>
          <span className="text-muted-foreground">Clicks:</span>{' '}
          <span className="font-medium">{stats.click_rate}%</span>
        </div>
        <div className="text-right">
          <Progress value={stats.open_rate} className="h-2" />
        </div>
      </div>
    </div>
  )
}

function FunnelRow({
  label,
  value,
  percentage,
  highlight = false,
}: {
  label: string
  value: number
  percentage: number
  highlight?: boolean
}) {
  return (
    <div className="space-y-1">
      <div className="flex items-center justify-between text-sm">
        <span className={highlight ? 'font-medium text-primary' : ''}>
          {label}
        </span>
        <span className="font-medium">
          {value} ({percentage}%)
        </span>
      </div>
      <Progress value={percentage} className={`h-2 ${highlight ? '[&>div]:bg-primary' : ''}`} />
    </div>
  )
}

function getRateColor(rate: number, type: 'open' | 'click' | 'conversion'): string {
  const thresholds = {
    open: { good: 30, ok: 15 },
    click: { good: 5, ok: 2 },
    conversion: { good: 10, ok: 5 },
  }

  const { good, ok } = thresholds[type]

  if (rate >= good) return 'text-green-600 dark:text-green-400'
  if (rate >= ok) return 'text-yellow-600 dark:text-yellow-400'
  return 'text-red-600 dark:text-red-400'
}
```
  </action>
  <verify>Stats component renders overall metrics, per-touch performance, and funnel visualization</verify>
  <done>Campaign stats component displays analytics with visual indicators for performance</done>
</task>

<task type="auto">
  <name>Task 3: Add analytics to campaign detail page</name>
  <files>app/(dashboard)/campaigns/[id]/page.tsx</files>
  <action>
Update app/(dashboard)/campaigns/[id]/page.tsx to include analytics:

1. Add import:
```typescript
import { getCampaignAnalytics } from '@/lib/data/campaign-analytics'
import { CampaignStats } from '@/components/campaigns/campaign-stats'
```

2. Fetch analytics in the page:
```typescript
const [campaign, enrollments, counts, analytics] = await Promise.all([
  getCampaign(id),
  getCampaignEnrollments(id, { limit: 20 }),
  getCampaignEnrollmentCounts(id),
  getCampaignAnalytics(id),
])
```

3. Add CampaignStats section after the touch sequence card:
```typescript
{/* Performance analytics */}
{analytics && analytics.total_sends > 0 && (
  <CampaignStats analytics={analytics} />
)}
```

The analytics section should appear after the touch sequence visualization and before the enrollments list. Only show if there are actual sends to report on.
  </action>
  <verify>Campaign detail page includes CampaignStats component with analytics data</verify>
  <done>Campaign detail page displays performance analytics when data is available</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. `pnpm typecheck` - All imports compile
2. `pnpm lint` - No lint errors
3. Campaign detail shows analytics section
4. Per-touch stats show open/click rates
5. Funnel shows enrollment progression
6. Color coding indicates good/ok/poor performance
</verification>

<success_criteria>
- [ ] getCampaignAnalytics aggregates send_logs by touch_number
- [ ] Open/click/conversion rates calculated correctly
- [ ] Stats component shows overall performance metrics
- [ ] Per-touch breakdown shows channel and rates
- [ ] Funnel visualization shows enrollment progression
- [ ] Color coding highlights performance quality
- [ ] Campaign detail page includes analytics when data exists
- [ ] `pnpm typecheck` passes
</success_criteria>

<output>
After completion, create `.planning/phases/24-multi-touch-campaign-engine/24-11-SUMMARY.md`
</output>
