---
phase: 24-multi-touch-campaign-engine
plan: 10
type: execute
wave: 4
depends_on: [24-04, 24-06]
files_modified:
  - app/api/webhooks/resend/route.ts
  - lib/actions/customer.ts
autonomous: true

must_haves:
  truths:
    - "Email click webhook stops active campaign enrollment"
    - "Customer opt-out stops their active enrollments"
    - "Stop reasons are correctly recorded (review_clicked, opted_out_email)"
  artifacts:
    - path: "app/api/webhooks/resend/route.ts"
      provides: "Webhook handler with campaign stop logic"
      contains: "campaign_enrollments"
    - path: "lib/actions/customer.ts"
      provides: "Customer opt-out with enrollment stop"
      contains: "opted_out_email"
  key_links:
    - from: "app/api/webhooks/resend/route.ts"
      to: "campaign_enrollments"
      via: "stop on click"
      pattern: "review_clicked"
    - from: "lib/actions/customer.ts"
      to: "campaign_enrollments"
      via: "stop on opt-out"
      pattern: "opted_out_email"
---

<objective>
Implement stop conditions for campaigns - email clicks and customer opt-outs.

Purpose: When a customer clicks a review link or opts out of email, their active campaign enrollment should stop automatically. This prevents over-messaging and respects customer preferences.

Output: Updated webhook handler and customer opt-out action with enrollment stop logic.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/24-multi-touch-campaign-engine/24-RESEARCH.md
@.planning/phases/24-multi-touch-campaign-engine/24-CONTEXT.md
@app/api/webhooks/resend/route.ts
@lib/actions/customer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Resend webhook to stop campaigns on click</name>
  <files>app/api/webhooks/resend/route.ts</files>
  <action>
Read existing app/api/webhooks/resend/route.ts and add campaign stop logic.

**Add to the webhook handler:**

```typescript
// After updating send_log status

// Stop campaign if link clicked (review submission intent)
if (event.type === 'email.clicked') {
  const sendLogId = event.data.tags?.find((t: { name: string; value: string }) => t.name === 'send_log_id')?.value
  const enrollmentId = event.data.tags?.find((t: { name: string; value: string }) => t.name === 'enrollment_id')?.value

  // If this was a campaign email, stop the enrollment
  if (enrollmentId) {
    await supabase
      .from('campaign_enrollments')
      .update({
        status: 'stopped',
        stop_reason: 'review_clicked',
        stopped_at: new Date().toISOString(),
      })
      .eq('id', enrollmentId)
      .eq('status', 'active')  // Only stop if still active

    console.log(`Stopped enrollment ${enrollmentId} - review clicked`)
  } else if (sendLogId) {
    // Try to find enrollment via send_log
    const { data: sendLog } = await supabase
      .from('send_logs')
      .select('campaign_enrollment_id')
      .eq('id', sendLogId)
      .single()

    if (sendLog?.campaign_enrollment_id) {
      await supabase
        .from('campaign_enrollments')
        .update({
          status: 'stopped',
          stop_reason: 'review_clicked',
          stopped_at: new Date().toISOString(),
        })
        .eq('id', sendLog.campaign_enrollment_id)
        .eq('status', 'active')

      console.log(`Stopped enrollment ${sendLog.campaign_enrollment_id} - review clicked (via send_log)`)
    }
  }
}
```

**Key behaviors:**
- Check for enrollment_id tag first (added in cron)
- Fall back to looking up via send_log_id if enrollment_id not present
- Only update if status='active' (idempotent)
- Log for debugging/monitoring
- Update happens in addition to existing send_log status update
  </action>
  <verify>Webhook handler includes campaign_enrollments update on email.clicked event</verify>
  <done>Resend webhook stops active campaign enrollment when review link is clicked</done>
</task>

<task type="auto">
  <name>Task 2: Update customer opt-out to stop enrollments</name>
  <files>lib/actions/customer.ts</files>
  <action>
Read existing lib/actions/customer.ts and add enrollment stop logic to opt-out.

**Find the function that handles email opt-out** (likely `updateCustomer` or a dedicated `optOutCustomer` function).

**Add after updating opted_out = true:**

```typescript
// After updating customer opted_out field

// Stop any active campaign enrollments for this customer
if (updates.opted_out === true) {
  const supabase = await createClient()

  await supabase
    .from('campaign_enrollments')
    .update({
      status: 'stopped',
      stop_reason: 'opted_out_email',
      stopped_at: new Date().toISOString(),
    })
    .eq('customer_id', customerId)
    .eq('status', 'active')

  console.log(`Stopped active enrollments for customer ${customerId} - opted out of email`)
}
```

**If SMS opt-out is handled separately (sms_consent_status):**

```typescript
// After updating sms_consent_status = 'opted_out'
if (updates.sms_consent_status === 'opted_out') {
  // Note: Per CONTEXT.md, SMS opt-out should only skip SMS touches, not stop entire enrollment
  // This is handled in the cron processor by checking sms_consent_status before sending SMS
  // No enrollment stop needed here - just log for awareness
  console.log(`Customer ${customerId} opted out of SMS - SMS touches will be skipped`)
}
```

**Key behaviors:**
- Email opt-out (opted_out = true) stops entire enrollment
- SMS opt-out does NOT stop enrollment - just skips SMS touches (cron handles this)
- This matches CONTEXT.md: "Channel-specific skip - opted out of SMS sends email touches only"
  </action>
  <verify>Customer opt-out action includes enrollment stop when opted_out changes to true</verify>
  <done>Customer email opt-out stops their active campaign enrollments</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. `pnpm typecheck` - All imports compile
2. `pnpm lint` - No lint errors
3. Webhook handler updates campaign_enrollments on click
4. Customer opt-out stops enrollments with 'opted_out_email' reason
5. SMS opt-out does NOT stop enrollments (different behavior per TCPA)
</verification>

<success_criteria>
- [ ] Resend webhook handles email.clicked by stopping enrollment
- [ ] Stop uses enrollment_id from tags or falls back to send_log lookup
- [ ] Customer email opt-out stops active enrollments
- [ ] Stop reason recorded as 'review_clicked' or 'opted_out_email'
- [ ] SMS opt-out does NOT stop enrollment (handled in cron)
- [ ] Updates are idempotent (WHERE status='active')
- [ ] `pnpm typecheck` passes
</success_criteria>

<output>
After completion, create `.planning/phases/24-multi-touch-campaign-engine/24-10-SUMMARY.md`
</output>
