---
phase: 24-multi-touch-campaign-engine
plan: 08
type: execute
wave: 4
depends_on: [24-04, 24-07]
files_modified:
  - app/(dashboard)/campaigns/[id]/page.tsx
  - app/(dashboard)/campaigns/[id]/edit/page.tsx
  - app/(dashboard)/campaigns/new/page.tsx
  - components/campaigns/campaign-form.tsx
  - components/campaigns/touch-sequence-editor.tsx
autonomous: true

must_haves:
  truths:
    - "User can view campaign detail page with enrollment list"
    - "User can edit campaign name, service type, and touch sequence"
    - "Touch sequence editor allows adding/removing/reordering touches"
    - "Template selector shows dropdown with preview"
  artifacts:
    - path: "app/(dashboard)/campaigns/[id]/page.tsx"
      provides: "Campaign detail page"
      contains: "getCampaignEnrollments"
    - path: "components/campaigns/campaign-form.tsx"
      provides: "Campaign create/edit form"
      exports: ["CampaignForm"]
    - path: "components/campaigns/touch-sequence-editor.tsx"
      provides: "Touch sequence configuration"
      exports: ["TouchSequenceEditor"]
  key_links:
    - from: "components/campaigns/campaign-form.tsx"
      to: "lib/actions/campaign.ts"
      via: "form submission"
      pattern: "createCampaign|updateCampaign"
    - from: "components/campaigns/touch-sequence-editor.tsx"
      to: "message_templates"
      via: "template selector"
      pattern: "getAvailableTemplates"
---

<objective>
Create campaign detail page, edit page, and form components.

Purpose: Full campaign management - view enrollments, edit configuration, and configure touch sequences with template selection.

Output: Campaign detail/edit pages and form components for campaign CRUD.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/24-multi-touch-campaign-engine/24-CONTEXT.md
@lib/data/campaign.ts
@lib/actions/campaign.ts
@lib/validations/campaign.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create campaign detail page</name>
  <files>app/(dashboard)/campaigns/[id]/page.tsx</files>
  <action>
Create app/(dashboard)/campaigns/[id]/page.tsx:

```typescript
import { notFound } from 'next/navigation'
import Link from 'next/link'
import { getCampaign, getCampaignEnrollments, getCampaignEnrollmentCounts } from '@/lib/data/campaign'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { PencilSimple, EnvelopeSimple, ChatCircle, ArrowLeft } from '@phosphor-icons/react/dist/ssr'
import { SERVICE_TYPE_LABELS } from '@/lib/constants/services'
import { ENROLLMENT_STATUS_LABELS, STOP_REASON_LABELS, TOUCH_STATUS_LABELS } from '@/lib/constants/campaigns'
import { formatDistanceToNow, format } from 'date-fns'

interface CampaignDetailPageProps {
  params: Promise<{ id: string }>
}

export async function generateMetadata({ params }: CampaignDetailPageProps) {
  const { id } = await params
  const campaign = await getCampaign(id)
  return {
    title: campaign ? `${campaign.name} | Campaigns` : 'Campaign Not Found',
  }
}

export default async function CampaignDetailPage({ params }: CampaignDetailPageProps) {
  const { id } = await params
  const [campaign, enrollments, counts] = await Promise.all([
    getCampaign(id),
    getCampaignEnrollments(id, { limit: 20 }),
    getCampaignEnrollmentCounts(id),
  ])

  if (!campaign) {
    notFound()
  }

  return (
    <div className="container py-6 space-y-6">
      {/* Header */}
      <div className="flex items-start justify-between">
        <div>
          <Link
            href="/campaigns"
            className="text-sm text-muted-foreground hover:text-foreground flex items-center gap-1 mb-2"
          >
            <ArrowLeft className="h-4 w-4" />
            Back to campaigns
          </Link>
          <div className="flex items-center gap-3">
            <h1 className="text-2xl font-semibold">{campaign.name}</h1>
            <Badge variant={campaign.status === 'active' ? 'default' : 'secondary'}>
              {campaign.status === 'active' ? 'Active' : 'Paused'}
            </Badge>
          </div>
          <p className="text-muted-foreground mt-1">
            {campaign.service_type
              ? SERVICE_TYPE_LABELS[campaign.service_type]
              : 'All services'}
            {' · '}
            {campaign.campaign_touches.length} touches
          </p>
        </div>

        {!campaign.is_preset && (
          <Link href={`/campaigns/${id}/edit`}>
            <Button>
              <PencilSimple className="mr-2 h-4 w-4" />
              Edit Campaign
            </Button>
          </Link>
        )}
      </div>

      {/* Stats cards */}
      <div className="grid grid-cols-3 gap-4">
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Active Enrollments
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{counts.active}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Completed
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{counts.completed}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Stopped
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{counts.stopped}</div>
          </CardContent>
        </Card>
      </div>

      {/* Touch sequence visualization */}
      <Card>
        <CardHeader>
          <CardTitle>Touch Sequence</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex items-center gap-4 flex-wrap">
            {campaign.campaign_touches.map((touch, idx) => (
              <div key={touch.id} className="flex items-center gap-2">
                {idx > 0 && (
                  <span className="text-muted-foreground">→</span>
                )}
                <div className="flex flex-col items-center gap-1 p-3 rounded-lg border bg-muted/50">
                  <div className="flex items-center gap-2">
                    {touch.channel === 'email' ? (
                      <EnvelopeSimple className="h-5 w-5" />
                    ) : (
                      <ChatCircle className="h-5 w-5" />
                    )}
                    <span className="font-medium capitalize">{touch.channel}</span>
                  </div>
                  <span className="text-sm text-muted-foreground">
                    {touch.delay_hours < 24
                      ? `${touch.delay_hours}h after ${idx === 0 ? 'job' : `touch ${idx}`}`
                      : `${Math.round(touch.delay_hours / 24)}d after ${idx === 0 ? 'job' : `touch ${idx}`}`}
                  </span>
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Enrollments list */}
      <Card>
        <CardHeader>
          <CardTitle>Recent Enrollments</CardTitle>
        </CardHeader>
        <CardContent>
          {enrollments.length === 0 ? (
            <p className="text-muted-foreground text-center py-4">
              No enrollments yet. Jobs will be enrolled when marked complete.
            </p>
          ) : (
            <div className="space-y-3">
              {enrollments.map((enrollment) => (
                <div
                  key={enrollment.id}
                  className="flex items-center justify-between p-3 rounded-lg border"
                >
                  <div>
                    <div className="font-medium">
                      {enrollment.customers?.name || 'Unknown customer'}
                    </div>
                    <div className="text-sm text-muted-foreground">
                      Enrolled {formatDistanceToNow(new Date(enrollment.enrolled_at), { addSuffix: true })}
                      {enrollment.jobs?.service_type && (
                        <> · {SERVICE_TYPE_LABELS[enrollment.jobs.service_type]}</>
                      )}
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    <Badge
                      variant={
                        enrollment.status === 'active' ? 'default' :
                        enrollment.status === 'completed' ? 'secondary' :
                        'outline'
                      }
                    >
                      {ENROLLMENT_STATUS_LABELS[enrollment.status]}
                    </Badge>
                    {enrollment.stop_reason && (
                      <span className="text-xs text-muted-foreground">
                        {STOP_REASON_LABELS[enrollment.stop_reason]}
                      </span>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  )
}
```
  </action>
  <verify>Campaign detail page exists with stats cards, touch sequence, and enrollment list</verify>
  <done>Campaign detail page displays stats, touch sequence, and recent enrollments</done>
</task>

<task type="auto">
  <name>Task 2: Create campaign form component</name>
  <files>components/campaigns/campaign-form.tsx, components/campaigns/touch-sequence-editor.tsx</files>
  <action>
Create components/campaigns/campaign-form.tsx:

```typescript
'use client'

import { useState, useTransition } from 'react'
import { useRouter } from 'next/navigation'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { TouchSequenceEditor } from './touch-sequence-editor'
import { createCampaign, updateCampaign } from '@/lib/actions/campaign'
import { campaignWithTouchesSchema, type CampaignWithTouchesFormData } from '@/lib/validations/campaign'
import { SERVICE_TYPE_LABELS } from '@/lib/constants/services'
import { toast } from 'sonner'
import type { CampaignWithTouches, MessageTemplate } from '@/lib/types/database'

interface CampaignFormProps {
  campaign?: CampaignWithTouches
  templates: MessageTemplate[]
}

export function CampaignForm({ campaign, templates }: CampaignFormProps) {
  const router = useRouter()
  const [isPending, startTransition] = useTransition()
  const isEditing = !!campaign

  const {
    register,
    handleSubmit,
    watch,
    setValue,
    formState: { errors },
  } = useForm<CampaignWithTouchesFormData>({
    resolver: zodResolver(campaignWithTouchesSchema),
    defaultValues: {
      name: campaign?.name || '',
      service_type: campaign?.service_type || null,
      status: campaign?.status || 'active',
      touches: campaign?.campaign_touches?.map(t => ({
        touch_number: t.touch_number,
        channel: t.channel,
        delay_hours: t.delay_hours,
        template_id: t.template_id,
      })) || [
        { touch_number: 1, channel: 'email', delay_hours: 24, template_id: null },
      ],
    },
  })

  const touches = watch('touches')

  const onSubmit = (data: CampaignWithTouchesFormData) => {
    startTransition(async () => {
      const result = isEditing
        ? await updateCampaign(campaign.id, data)
        : await createCampaign(data)

      if (result.error) {
        toast.error(result.error)
        return
      }

      if (result.fieldErrors) {
        Object.entries(result.fieldErrors).forEach(([field, errors]) => {
          if (errors?.[0]) {
            toast.error(`${field}: ${errors[0]}`)
          }
        })
        return
      }

      toast.success(isEditing ? 'Campaign updated' : 'Campaign created')
      router.push('/campaigns')
    })
  }

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-8">
      {/* Basic info */}
      <div className="space-y-4">
        <div className="space-y-2">
          <Label htmlFor="name">Campaign Name</Label>
          <Input
            id="name"
            {...register('name')}
            placeholder="e.g., HVAC Follow-up"
          />
          {errors.name && (
            <p className="text-sm text-destructive">{errors.name.message}</p>
          )}
        </div>

        <div className="space-y-2">
          <Label htmlFor="service_type">Service Type</Label>
          <Select
            value={watch('service_type') || 'all'}
            onValueChange={(value) =>
              setValue('service_type', value === 'all' ? null : value as any)
            }
          >
            <SelectTrigger>
              <SelectValue placeholder="Select service type" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Services</SelectItem>
              {Object.entries(SERVICE_TYPE_LABELS).map(([value, label]) => (
                <SelectItem key={value} value={value}>
                  {label}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
          <p className="text-sm text-muted-foreground">
            Jobs with this service type will be enrolled in this campaign
          </p>
        </div>
      </div>

      {/* Touch sequence */}
      <div className="space-y-4">
        <div>
          <Label>Touch Sequence</Label>
          <p className="text-sm text-muted-foreground">
            Configure when and how to reach out after job completion
          </p>
        </div>

        <TouchSequenceEditor
          touches={touches}
          templates={templates}
          onChange={(newTouches) => setValue('touches', newTouches)}
        />

        {errors.touches && (
          <p className="text-sm text-destructive">
            {typeof errors.touches === 'string'
              ? errors.touches
              : errors.touches.message || 'Invalid touch configuration'}
          </p>
        )}
      </div>

      {/* Submit */}
      <div className="flex gap-4">
        <Button type="submit" disabled={isPending}>
          {isPending ? 'Saving...' : isEditing ? 'Save Changes' : 'Create Campaign'}
        </Button>
        <Button type="button" variant="outline" onClick={() => router.back()}>
          Cancel
        </Button>
      </div>
    </form>
  )
}
```

Create components/campaigns/touch-sequence-editor.tsx:

```typescript
'use client'

import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { Card, CardContent } from '@/components/ui/card'
import { Plus, Trash, EnvelopeSimple, ChatCircle } from '@phosphor-icons/react'
import type { CampaignTouchFormData } from '@/lib/validations/campaign'
import type { MessageTemplate, MessageChannel } from '@/lib/types/database'

interface TouchSequenceEditorProps {
  touches: CampaignTouchFormData[]
  templates: MessageTemplate[]
  onChange: (touches: CampaignTouchFormData[]) => void
}

export function TouchSequenceEditor({
  touches,
  templates,
  onChange,
}: TouchSequenceEditorProps) {
  const addTouch = () => {
    if (touches.length >= 4) return

    const newTouch: CampaignTouchFormData = {
      touch_number: touches.length + 1,
      channel: 'email',
      delay_hours: touches.length === 0 ? 24 : 48,
      template_id: null,
    }

    onChange([...touches, newTouch])
  }

  const removeTouch = (index: number) => {
    if (touches.length <= 1) return

    const newTouches = touches
      .filter((_, i) => i !== index)
      .map((t, i) => ({ ...t, touch_number: i + 1 }))

    onChange(newTouches)
  }

  const updateTouch = (index: number, updates: Partial<CampaignTouchFormData>) => {
    const newTouches = touches.map((t, i) =>
      i === index ? { ...t, ...updates } : t
    )
    onChange(newTouches)
  }

  const getTemplatesForChannel = (channel: MessageChannel) =>
    templates.filter(t => t.channel === channel)

  return (
    <div className="space-y-4">
      {touches.map((touch, index) => (
        <Card key={index}>
          <CardContent className="pt-4">
            <div className="flex items-start gap-4">
              {/* Touch number indicator */}
              <div className="flex items-center justify-center w-8 h-8 rounded-full bg-primary text-primary-foreground font-medium shrink-0">
                {touch.touch_number}
              </div>

              <div className="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                {/* Channel */}
                <div className="space-y-2">
                  <Label>Channel</Label>
                  <Select
                    value={touch.channel}
                    onValueChange={(value: MessageChannel) => {
                      updateTouch(index, { channel: value, template_id: null })
                    }}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="email">
                        <span className="flex items-center gap-2">
                          <EnvelopeSimple className="h-4 w-4" />
                          Email
                        </span>
                      </SelectItem>
                      <SelectItem value="sms">
                        <span className="flex items-center gap-2">
                          <ChatCircle className="h-4 w-4" />
                          SMS
                        </span>
                      </SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                {/* Delay */}
                <div className="space-y-2">
                  <Label>
                    {index === 0 ? 'Delay after job' : `Delay after touch ${index}`}
                  </Label>
                  <div className="flex gap-2">
                    <Input
                      type="number"
                      min={1}
                      max={720}
                      value={touch.delay_hours}
                      onChange={(e) =>
                        updateTouch(index, { delay_hours: parseInt(e.target.value) || 1 })
                      }
                      className="w-20"
                    />
                    <span className="flex items-center text-sm text-muted-foreground">
                      hours
                    </span>
                  </div>
                  <p className="text-xs text-muted-foreground">
                    {touch.delay_hours < 24
                      ? `${touch.delay_hours} hours`
                      : `${Math.round(touch.delay_hours / 24)} days`}
                  </p>
                </div>

                {/* Template */}
                <div className="space-y-2">
                  <Label>Template</Label>
                  <Select
                    value={touch.template_id || 'default'}
                    onValueChange={(value) =>
                      updateTouch(index, { template_id: value === 'default' ? null : value })
                    }
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Use default" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="default">Use default template</SelectItem>
                      {getTemplatesForChannel(touch.channel).map((template) => (
                        <SelectItem key={template.id} value={template.id}>
                          {template.name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {/* Remove button */}
              <Button
                type="button"
                variant="ghost"
                size="icon"
                onClick={() => removeTouch(index)}
                disabled={touches.length <= 1}
                className="shrink-0"
              >
                <Trash className="h-4 w-4" />
              </Button>
            </div>
          </CardContent>
        </Card>
      ))}

      {touches.length < 4 && (
        <Button type="button" variant="outline" onClick={addTouch} className="w-full">
          <Plus className="mr-2 h-4 w-4" />
          Add Touch ({touches.length}/4)
        </Button>
      )}
    </div>
  )
}
```
  </action>
  <verify>Form component exists with touch sequence editor that supports add/remove/edit touches</verify>
  <done>Campaign form allows editing name, service type, and touch sequence with template selection</done>
</task>

<task type="auto">
  <name>Task 3: Create campaign edit and new pages</name>
  <files>app/(dashboard)/campaigns/[id]/edit/page.tsx, app/(dashboard)/campaigns/new/page.tsx</files>
  <action>
Create app/(dashboard)/campaigns/[id]/edit/page.tsx:

```typescript
import { notFound } from 'next/navigation'
import Link from 'next/link'
import { getCampaign } from '@/lib/data/campaign'
import { getAvailableTemplates } from '@/lib/data/message-template'
import { CampaignForm } from '@/components/campaigns/campaign-form'
import { ArrowLeft } from '@phosphor-icons/react/dist/ssr'

interface EditCampaignPageProps {
  params: Promise<{ id: string }>
}

export async function generateMetadata({ params }: EditCampaignPageProps) {
  const { id } = await params
  const campaign = await getCampaign(id)
  return {
    title: campaign ? `Edit ${campaign.name}` : 'Campaign Not Found',
  }
}

export default async function EditCampaignPage({ params }: EditCampaignPageProps) {
  const { id } = await params
  const [campaign, templates] = await Promise.all([
    getCampaign(id),
    getAvailableTemplates(),
  ])

  if (!campaign) {
    notFound()
  }

  if (campaign.is_preset) {
    // Redirect to campaigns page - can't edit presets
    notFound()
  }

  return (
    <div className="container py-6 max-w-3xl">
      <Link
        href={`/campaigns/${id}`}
        className="text-sm text-muted-foreground hover:text-foreground flex items-center gap-1 mb-4"
      >
        <ArrowLeft className="h-4 w-4" />
        Back to campaign
      </Link>

      <div className="mb-8">
        <h1 className="text-2xl font-semibold">Edit Campaign</h1>
        <p className="text-muted-foreground">
          Configure your automated review request sequence
        </p>
      </div>

      <CampaignForm campaign={campaign} templates={templates} />
    </div>
  )
}
```

Create app/(dashboard)/campaigns/new/page.tsx:

```typescript
import Link from 'next/link'
import { getAvailableTemplates } from '@/lib/data/message-template'
import { CampaignForm } from '@/components/campaigns/campaign-form'
import { ArrowLeft } from '@phosphor-icons/react/dist/ssr'

export const metadata = {
  title: 'New Campaign | AvisLoop',
}

export default async function NewCampaignPage() {
  const templates = await getAvailableTemplates()

  return (
    <div className="container py-6 max-w-3xl">
      <Link
        href="/campaigns"
        className="text-sm text-muted-foreground hover:text-foreground flex items-center gap-1 mb-4"
      >
        <ArrowLeft className="h-4 w-4" />
        Back to campaigns
      </Link>

      <div className="mb-8">
        <h1 className="text-2xl font-semibold">New Campaign</h1>
        <p className="text-muted-foreground">
          Create an automated review request sequence for completed jobs
        </p>
      </div>

      <CampaignForm templates={templates} />
    </div>
  )
}
```
  </action>
  <verify>Edit and new pages render campaign form with templates loaded</verify>
  <done>Campaign edit and new pages provide full-page editing experience</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. `pnpm typecheck` - All imports compile
2. `pnpm lint` - No lint errors
3. /campaigns/[id] shows detail with stats and enrollments
4. /campaigns/[id]/edit loads form with existing data
5. /campaigns/new shows empty form
6. Touch sequence editor allows add/remove up to 4 touches
7. Template dropdown filters by channel
</verification>

<success_criteria>
- [ ] Campaign detail page shows stats cards (active, completed, stopped)
- [ ] Touch sequence visualized with channel icons and timing
- [ ] Recent enrollments listed with status badges
- [ ] Edit page loads campaign data into form
- [ ] New page shows empty form with defaults
- [ ] Touch sequence editor supports 1-4 touches
- [ ] Channel change resets template selection
- [ ] Template dropdown shows only matching channel templates
- [ ] `pnpm typecheck` passes
</success_criteria>

<output>
After completion, create `.planning/phases/24-multi-touch-campaign-engine/24-08-SUMMARY.md`
</output>
