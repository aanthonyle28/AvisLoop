---
phase: 24-multi-touch-campaign-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260204_create_campaigns.sql
  - supabase/migrations/20260204_create_campaign_touches.sql
  - supabase/migrations/20260204_create_campaign_enrollments.sql
  - supabase/migrations/20260204_add_send_log_campaign_fields.sql
  - docs/DATA_MODEL.md
autonomous: true

must_haves:
  truths:
    - "campaigns table exists with business_id, name, service_type, status, is_preset"
    - "campaign_touches table tracks ordered touch sequences with channel, delay, template"
    - "campaign_enrollments table tracks job progression through touches"
    - "send_logs has campaign_id and touch_number columns for analytics"
  artifacts:
    - path: "supabase/migrations/20260204_create_campaigns.sql"
      provides: "Campaign definition table with RLS"
      contains: "CREATE TABLE campaigns"
    - path: "supabase/migrations/20260204_create_campaign_touches.sql"
      provides: "Touch sequence table with constraints"
      contains: "CREATE TABLE campaign_touches"
    - path: "supabase/migrations/20260204_create_campaign_enrollments.sql"
      provides: "Enrollment tracking table with state machine"
      contains: "CREATE TABLE campaign_enrollments"
    - path: "supabase/migrations/20260204_add_send_log_campaign_fields.sql"
      provides: "Campaign tracking in send_logs"
      contains: "ADD COLUMN campaign_id"
  key_links:
    - from: "campaign_touches"
      to: "campaigns"
      via: "foreign key campaign_id"
      pattern: "REFERENCES campaigns\\(id\\)"
    - from: "campaign_enrollments"
      to: "campaigns"
      via: "foreign key campaign_id"
      pattern: "REFERENCES campaigns\\(id\\)"
    - from: "campaign_enrollments"
      to: "jobs"
      via: "foreign key job_id"
      pattern: "REFERENCES jobs\\(id\\)"
---

<objective>
Create database schema for multi-touch campaigns, touch sequences, and enrollment tracking.

Purpose: Foundation for campaign CRUD, enrollment tracking, and cron processing. This is the data layer that all other Phase 24 plans depend on.

Output: Four migration files creating campaigns, campaign_touches, campaign_enrollments tables, and send_log extensions. Full RLS policies and indexes for performance.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-multi-touch-campaign-engine/24-RESEARCH.md
@docs/DATA_MODEL.md
@supabase/migrations/20260203_create_jobs.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create campaigns table migration</name>
  <files>supabase/migrations/20260204_create_campaigns.sql</files>
  <action>
Create campaigns table with:

**Columns:**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- business_id UUID NOT NULL REFERENCES businesses(id) ON DELETE CASCADE
- name TEXT NOT NULL (min 1 char, max 100)
- service_type TEXT (NULL = "all services", constraint matches jobs service types)
- status TEXT NOT NULL DEFAULT 'active' (CHECK: 'active', 'paused')
- is_preset BOOLEAN NOT NULL DEFAULT false (system presets are read-only)
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Constraints:**
- service_type CHECK same as jobs table (hvac, plumbing, electrical, cleaning, roofing, painting, handyman, other, or NULL)
- status CHECK ('active', 'paused')
- UNIQUE (business_id, service_type) WHERE service_type IS NOT NULL (one campaign per service type per business)
- UNIQUE (business_id, is_preset) WHERE is_preset = false AND service_type IS NULL (one default campaign per business)

**RLS Policies:**
- SELECT: Users can view system presets (is_preset=true) OR their own campaigns (business_id matches user)
- INSERT: Users can only create for their own business (not preset)
- UPDATE: Users can only update their own campaigns (not preset)
- DELETE: Users can only delete their own campaigns (not preset)

**Indexes:**
- idx_campaigns_business_id (business_id)
- idx_campaigns_business_service (business_id, service_type)
- idx_campaigns_preset (is_preset) WHERE is_preset = true

**Trigger:**
- moddatetime for updated_at (follow existing pattern from jobs table)
  </action>
  <verify>Migration file exists and contains CREATE TABLE campaigns with all columns, constraints, RLS policies, and indexes</verify>
  <done>campaigns table schema defined with proper RLS for multi-tenant access and system preset protection</done>
</task>

<task type="auto">
  <name>Task 2: Create campaign_touches table migration</name>
  <files>supabase/migrations/20260204_create_campaign_touches.sql</files>
  <action>
Create campaign_touches table for ordered touch sequences:

**Columns:**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- campaign_id UUID NOT NULL REFERENCES campaigns(id) ON DELETE CASCADE
- touch_number INT NOT NULL (1-4 range)
- channel TEXT NOT NULL ('email' or 'sms')
- delay_hours INT NOT NULL (hours after job completion for touch 1, or previous touch for 2-4)
- template_id UUID REFERENCES message_templates(id) ON DELETE SET NULL
- created_at TIMESTAMPTZ DEFAULT NOW()

**Constraints:**
- touch_number BETWEEN 1 AND 4
- channel IN ('email', 'sms')
- delay_hours > 0 (minimum 1 hour delay)
- UNIQUE (campaign_id, touch_number) -- only one touch per position

**RLS Policies:**
- SELECT: Users can view touches for campaigns they can see (join to campaigns for business_id check)
- INSERT/UPDATE/DELETE: Users can only modify touches for their own campaigns (not preset campaigns)

**Indexes:**
- idx_touches_campaign_id (campaign_id, touch_number) -- for ordered fetches
- idx_touches_template_id (template_id) -- for template reference lookups
  </action>
  <verify>Migration file exists with campaign_touches table, FK to campaigns, CHECK constraints for touch_number and channel</verify>
  <done>campaign_touches table allows up to 4 ordered touches per campaign with channel and timing config</done>
</task>

<task type="auto">
  <name>Task 3: Create campaign_enrollments table migration</name>
  <files>supabase/migrations/20260204_create_campaign_enrollments.sql</files>
  <action>
Create campaign_enrollments table for tracking job progression:

**Columns:**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- business_id UUID NOT NULL REFERENCES businesses(id) ON DELETE CASCADE
- campaign_id UUID NOT NULL REFERENCES campaigns(id) ON DELETE CASCADE
- job_id UUID NOT NULL REFERENCES jobs(id) ON DELETE CASCADE
- customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE
- status TEXT NOT NULL DEFAULT 'active' (state machine: 'active', 'completed', 'stopped')
- stop_reason TEXT (NULL unless stopped: 'review_clicked', 'feedback_submitted', 'opted_out_sms', 'opted_out_email', 'owner_stopped', 'campaign_paused', 'campaign_deleted', 'repeat_job')
- current_touch INT NOT NULL DEFAULT 1 (1-4, next touch to send)
- touch_1_scheduled_at TIMESTAMPTZ
- touch_1_sent_at TIMESTAMPTZ
- touch_1_status TEXT ('pending', 'sent', 'skipped', 'failed')
- touch_2_scheduled_at TIMESTAMPTZ
- touch_2_sent_at TIMESTAMPTZ
- touch_2_status TEXT
- touch_3_scheduled_at TIMESTAMPTZ
- touch_3_sent_at TIMESTAMPTZ
- touch_3_status TEXT
- touch_4_scheduled_at TIMESTAMPTZ
- touch_4_sent_at TIMESTAMPTZ
- touch_4_status TEXT
- enrolled_at TIMESTAMPTZ DEFAULT NOW()
- completed_at TIMESTAMPTZ
- stopped_at TIMESTAMPTZ
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Constraints:**
- status IN ('active', 'completed', 'stopped')
- stop_reason CHECK matches list above or NULL
- current_touch BETWEEN 1 AND 4
- Partial unique: (customer_id, campaign_id) WHERE status = 'active' (one active enrollment per customer per campaign)

**RLS Policies:**
- SELECT: Users can view enrollments for their business
- INSERT/UPDATE/DELETE: Users can only modify enrollments for their business

**Indexes (critical for cron performance):**
- idx_enrollments_due_touches: Composite on (status, current_touch) with included columns for scheduled times WHERE status='active'
- idx_enrollments_business_campaign: (business_id, campaign_id, status)
- idx_enrollments_customer: (customer_id, status) -- for repeat job detection
- idx_enrollments_job: (job_id) -- for job detail lookups

**Trigger:**
- moddatetime for updated_at
  </action>
  <verify>Migration file exists with denormalized touch timestamps, state machine constraints, and critical cron indexes</verify>
  <done>campaign_enrollments tracks job progression with denormalized touch times for fast due-touch queries</done>
</task>

<task type="auto">
  <name>Task 4: Add campaign fields to send_logs and update DATA_MODEL.md</name>
  <files>supabase/migrations/20260204_add_send_log_campaign_fields.sql, docs/DATA_MODEL.md</files>
  <action>
**Migration (20260204_add_send_log_campaign_fields.sql):**

Add columns to existing send_logs table:
- campaign_id UUID REFERENCES campaigns(id) ON DELETE SET NULL (nullable for manual sends)
- campaign_enrollment_id UUID REFERENCES campaign_enrollments(id) ON DELETE SET NULL
- touch_number INT (nullable, 1-4 for campaign sends)
- channel TEXT NOT NULL DEFAULT 'email' (email or sms, defaults to email for backward compat)

Add index:
- idx_send_logs_campaign (campaign_id, touch_number) WHERE campaign_id IS NOT NULL

**DATA_MODEL.md:**

Add documentation sections for:
1. campaigns table (columns, constraints, RLS policies, indexes)
2. campaign_touches table (columns, constraints, relationships)
3. campaign_enrollments table (columns, state machine, denormalization explanation, indexes)
4. Updated send_logs section with campaign fields

Follow existing documentation format from customers and jobs sections.
  </action>
  <verify>`grep -l "campaign_id" supabase/migrations/20260204_add_send_log_campaign_fields.sql` returns file path; DATA_MODEL.md contains "## Table: campaigns"</verify>
  <done>send_logs can track campaign attribution and DATA_MODEL.md documents all new campaign tables</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. All migration files exist in supabase/migrations/
2. Each migration has proper RLS enabled on table creation
3. Foreign keys reference correct tables with CASCADE where appropriate
4. DATA_MODEL.md updated with campaign documentation
5. `pnpm lint` passes (no TypeScript in this plan, but verify project health)
</verification>

<success_criteria>
- [ ] campaigns table created with service_type constraint and preset protection
- [ ] campaign_touches table allows up to 4 ordered touches per campaign
- [ ] campaign_enrollments table tracks job progression with denormalized touch timestamps
- [ ] send_logs extended with campaign_id, campaign_enrollment_id, touch_number, channel
- [ ] All tables have proper RLS policies following business-scoped pattern
- [ ] Critical cron indexes defined for due-touch queries
- [ ] DATA_MODEL.md documents all new tables
</success_criteria>

<output>
After completion, create `.planning/phases/24-multi-touch-campaign-engine/24-01-SUMMARY.md`
</output>
