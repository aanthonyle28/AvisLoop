---
phase: 24-multi-touch-campaign-engine
plan: 07
type: execute
wave: 3
depends_on: [24-03, 24-04]
files_modified:
  - app/(dashboard)/campaigns/page.tsx
  - app/(dashboard)/campaigns/loading.tsx
  - components/campaigns/campaign-list.tsx
  - components/campaigns/campaign-card.tsx
  - components/campaigns/preset-picker.tsx
autonomous: true

must_haves:
  truths:
    - "User can view /campaigns page with list of their campaigns"
    - "Campaign list shows name, service type, status, and quick stats"
    - "Status toggle switch allows quick pause/resume"
    - "Preset picker shows 3 cards (Conservative, Standard, Aggressive)"
  artifacts:
    - path: "app/(dashboard)/campaigns/page.tsx"
      provides: "Campaigns page server component"
      contains: "getCampaigns"
    - path: "components/campaigns/campaign-list.tsx"
      provides: "Campaign list table/cards"
      exports: ["CampaignList"]
    - path: "components/campaigns/preset-picker.tsx"
      provides: "Preset selection cards"
      exports: ["PresetPicker"]
  key_links:
    - from: "app/(dashboard)/campaigns/page.tsx"
      to: "lib/data/campaign.ts"
      via: "data fetch"
      pattern: "getCampaigns"
    - from: "components/campaigns/campaign-list.tsx"
      to: "lib/actions/campaign.ts"
      via: "status toggle"
      pattern: "toggleCampaignStatus"
---

<objective>
Create campaigns page with list view, status toggle, and preset picker.

Purpose: Main entry point for campaign management. Users see their campaigns at a glance and can quickly toggle status or pick a preset to get started.

Output: Campaigns page, list component with status toggle, and preset picker cards.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/24-multi-touch-campaign-engine/24-CONTEXT.md
@app/(dashboard)/jobs/page.tsx
@components/ui/switch.tsx
@lib/constants/campaigns.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create campaigns page and loading state</name>
  <files>app/(dashboard)/campaigns/page.tsx, app/(dashboard)/campaigns/loading.tsx</files>
  <action>
Create app/(dashboard)/campaigns/page.tsx:

```typescript
import { Suspense } from 'react'
import { getCampaigns, getCampaignPresets } from '@/lib/data/campaign'
import { CampaignList } from '@/components/campaigns/campaign-list'
import { PresetPicker } from '@/components/campaigns/preset-picker'
import { Button } from '@/components/ui/button'
import { Plus } from '@phosphor-icons/react/dist/ssr'
import Link from 'next/link'

export const metadata = {
  title: 'Campaigns | AvisLoop',
}

export default async function CampaignsPage() {
  const [campaigns, presets] = await Promise.all([
    getCampaigns({ includePresets: false }),
    getCampaignPresets(),
  ])

  const hasCustomCampaigns = campaigns.length > 0

  return (
    <div className="container py-6 space-y-8">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-semibold">Campaigns</h1>
          <p className="text-muted-foreground">
            Automated review request sequences for completed jobs
          </p>
        </div>

        {hasCustomCampaigns && (
          <Link href="/campaigns/new">
            <Button>
              <Plus className="mr-2 h-4 w-4" />
              New Campaign
            </Button>
          </Link>
        )}
      </div>

      {!hasCustomCampaigns ? (
        // Empty state with preset picker
        <div className="space-y-6">
          <div className="rounded-lg border bg-card p-6 text-center">
            <h2 className="text-lg font-medium mb-2">Get started with a campaign</h2>
            <p className="text-muted-foreground mb-6">
              Choose a preset to automatically send review requests when jobs are completed.
            </p>
            <PresetPicker presets={presets} />
          </div>
        </div>
      ) : (
        // Campaign list
        <div className="space-y-6">
          <CampaignList campaigns={campaigns} />

          {/* Show preset picker below list for adding more campaigns */}
          <div className="rounded-lg border bg-card p-6">
            <h3 className="text-sm font-medium mb-4">Add another campaign</h3>
            <PresetPicker presets={presets} compact />
          </div>
        </div>
      )}
    </div>
  )
}
```

Create app/(dashboard)/campaigns/loading.tsx:

```typescript
import { Skeleton } from '@/components/ui/skeleton'

export default function CampaignsLoading() {
  return (
    <div className="container py-6 space-y-8">
      <div className="flex items-center justify-between">
        <div className="space-y-2">
          <Skeleton className="h-8 w-40" />
          <Skeleton className="h-4 w-64" />
        </div>
        <Skeleton className="h-10 w-32" />
      </div>

      <div className="space-y-4">
        {[1, 2, 3].map((i) => (
          <Skeleton key={i} className="h-24 w-full rounded-lg" />
        ))}
      </div>
    </div>
  )
}
```
  </action>
  <verify>Page file exists with getCampaigns call and conditional rendering for empty state</verify>
  <done>Campaigns page shows list or empty state with preset picker</done>
</task>

<task type="auto">
  <name>Task 2: Create campaign list component with status toggle</name>
  <files>components/campaigns/campaign-list.tsx, components/campaigns/campaign-card.tsx</files>
  <action>
Create components/campaigns/campaign-list.tsx:

```typescript
'use client'

import { CampaignCard } from './campaign-card'
import type { CampaignWithTouches } from '@/lib/types/database'

interface CampaignListProps {
  campaigns: CampaignWithTouches[]
}

export function CampaignList({ campaigns }: CampaignListProps) {
  if (campaigns.length === 0) {
    return (
      <div className="text-center py-8 text-muted-foreground">
        No campaigns yet
      </div>
    )
  }

  return (
    <div className="space-y-4">
      {campaigns.map((campaign) => (
        <CampaignCard key={campaign.id} campaign={campaign} />
      ))}
    </div>
  )
}
```

Create components/campaigns/campaign-card.tsx:

```typescript
'use client'

import { useState, useTransition } from 'react'
import Link from 'next/link'
import { Switch } from '@/components/ui/switch'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { DotsThree, PencilSimple, Copy, Trash } from '@phosphor-icons/react'
import { toggleCampaignStatus, deleteCampaign, duplicateCampaign } from '@/lib/actions/campaign'
import { toast } from 'sonner'
import type { CampaignWithTouches } from '@/lib/types/database'
import { SERVICE_TYPE_LABELS } from '@/lib/constants/services'

interface CampaignCardProps {
  campaign: CampaignWithTouches
}

export function CampaignCard({ campaign }: CampaignCardProps) {
  const [isPending, startTransition] = useTransition()
  const [optimisticStatus, setOptimisticStatus] = useState(campaign.status)

  const handleStatusToggle = () => {
    const newStatus = optimisticStatus === 'active' ? 'paused' : 'active'
    setOptimisticStatus(newStatus)

    startTransition(async () => {
      const result = await toggleCampaignStatus(campaign.id)
      if (result.error) {
        setOptimisticStatus(campaign.status) // Revert
        toast.error(result.error)
      } else {
        toast.success(newStatus === 'active' ? 'Campaign resumed' : 'Campaign paused')
      }
    })
  }

  const handleDuplicate = () => {
    startTransition(async () => {
      const result = await duplicateCampaign(campaign.id)
      if (result.error) {
        toast.error(result.error)
      } else {
        toast.success('Campaign duplicated')
      }
    })
  }

  const handleDelete = () => {
    if (!confirm('Delete this campaign? This cannot be undone.')) return

    startTransition(async () => {
      const result = await deleteCampaign(campaign.id)
      if (result.error) {
        toast.error(result.error)
      } else {
        toast.success('Campaign deleted')
      }
    })
  }

  const touchCount = campaign.campaign_touches?.length || 0
  const emailCount = campaign.campaign_touches?.filter(t => t.channel === 'email').length || 0
  const smsCount = campaign.campaign_touches?.filter(t => t.channel === 'sms').length || 0

  return (
    <div className="rounded-lg border bg-card p-4 hover:shadow-sm transition-shadow">
      <div className="flex items-start justify-between">
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-3">
            <Link
              href={`/campaigns/${campaign.id}`}
              className="font-medium hover:underline truncate"
            >
              {campaign.name}
            </Link>

            {campaign.service_type ? (
              <Badge variant="secondary" className="shrink-0">
                {SERVICE_TYPE_LABELS[campaign.service_type] || campaign.service_type}
              </Badge>
            ) : (
              <Badge variant="outline" className="shrink-0">
                All Services
              </Badge>
            )}
          </div>

          <div className="flex items-center gap-4 mt-2 text-sm text-muted-foreground">
            <span>
              {touchCount} {touchCount === 1 ? 'touch' : 'touches'}
            </span>
            {emailCount > 0 && <span>{emailCount} email</span>}
            {smsCount > 0 && <span>{smsCount} SMS</span>}
          </div>
        </div>

        <div className="flex items-center gap-3 shrink-0">
          <div className="flex items-center gap-2">
            <span className="text-sm text-muted-foreground">
              {optimisticStatus === 'active' ? 'Active' : 'Paused'}
            </span>
            <Switch
              checked={optimisticStatus === 'active'}
              onCheckedChange={handleStatusToggle}
              disabled={isPending}
            />
          </div>

          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" size="icon" disabled={isPending}>
                <DotsThree className="h-5 w-5" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem asChild>
                <Link href={`/campaigns/${campaign.id}/edit`}>
                  <PencilSimple className="mr-2 h-4 w-4" />
                  Edit
                </Link>
              </DropdownMenuItem>
              <DropdownMenuItem onClick={handleDuplicate}>
                <Copy className="mr-2 h-4 w-4" />
                Duplicate
              </DropdownMenuItem>
              <DropdownMenuItem
                onClick={handleDelete}
                className="text-destructive focus:text-destructive"
              >
                <Trash className="mr-2 h-4 w-4" />
                Delete
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>
    </div>
  )
}
```

Create SERVICE_TYPE_LABELS constant in lib/constants/services.ts if not exists:
```typescript
export const SERVICE_TYPE_LABELS: Record<string, string> = {
  hvac: 'HVAC',
  plumbing: 'Plumbing',
  electrical: 'Electrical',
  cleaning: 'Cleaning',
  roofing: 'Roofing',
  painting: 'Painting',
  handyman: 'Handyman',
  other: 'Other',
}
```
  </action>
  <verify>Components exist with status toggle using Switch component and dropdown actions</verify>
  <done>Campaign list shows cards with status toggle, touch counts, and action menu</done>
</task>

<task type="auto">
  <name>Task 3: Create preset picker component</name>
  <files>components/campaigns/preset-picker.tsx</files>
  <action>
Create components/campaigns/preset-picker.tsx:

```typescript
'use client'

import { useTransition } from 'react'
import { useRouter } from 'next/navigation'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { EnvelopeSimple, ChatCircle } from '@phosphor-icons/react'
import { duplicateCampaign } from '@/lib/actions/campaign'
import { CAMPAIGN_PRESETS } from '@/lib/constants/campaigns'
import { toast } from 'sonner'
import type { CampaignWithTouches } from '@/lib/types/database'
import { cn } from '@/lib/utils'

interface PresetPickerProps {
  presets: CampaignWithTouches[]
  compact?: boolean
}

export function PresetPicker({ presets, compact = false }: PresetPickerProps) {
  const router = useRouter()
  const [isPending, startTransition] = useTransition()

  const handleSelectPreset = (presetId: string) => {
    startTransition(async () => {
      const result = await duplicateCampaign(presetId)
      if (result.error) {
        toast.error(result.error)
      } else if (result.data?.campaignId) {
        toast.success('Campaign created! Configure your templates.')
        router.push(`/campaigns/${result.data.campaignId}/edit`)
      }
    })
  }

  // Match database presets with constant definitions for descriptions
  const presetsWithMeta = presets.map(preset => {
    const meta = CAMPAIGN_PRESETS.find(p =>
      preset.name.toLowerCase().includes(p.id)
    )
    return { ...preset, meta }
  })

  return (
    <div className={cn(
      'grid gap-4',
      compact ? 'grid-cols-1 md:grid-cols-3' : 'grid-cols-1 lg:grid-cols-3'
    )}>
      {presetsWithMeta.map((preset) => (
        <Card
          key={preset.id}
          className={cn(
            'relative hover:border-primary/50 transition-colors cursor-pointer',
            isPending && 'opacity-50 pointer-events-none'
          )}
          onClick={() => handleSelectPreset(preset.id)}
        >
          <CardHeader className={compact ? 'pb-2' : undefined}>
            <CardTitle className={cn(compact && 'text-base')}>
              {preset.meta?.id === 'conservative' && 'Conservative'}
              {preset.meta?.id === 'standard' && 'Standard'}
              {preset.meta?.id === 'aggressive' && 'Aggressive'}
              {!preset.meta && preset.name}
            </CardTitle>
            {!compact && (
              <CardDescription>
                {preset.meta?.description || `${preset.campaign_touches.length} touches`}
              </CardDescription>
            )}
          </CardHeader>

          <CardContent>
            {/* Touch visualization */}
            <div className={cn('flex items-center gap-2', compact && 'flex-wrap')}>
              {preset.campaign_touches.map((touch, idx) => (
                <div key={touch.id} className="flex items-center gap-1">
                  {idx > 0 && (
                    <span className="text-xs text-muted-foreground mx-1">â†’</span>
                  )}
                  <Badge
                    variant={touch.channel === 'email' ? 'secondary' : 'default'}
                    className="gap-1"
                  >
                    {touch.channel === 'email' ? (
                      <EnvelopeSimple className="h-3 w-3" />
                    ) : (
                      <ChatCircle className="h-3 w-3" />
                    )}
                    {!compact && (
                      <span className="text-xs">
                        {touch.delay_hours < 24
                          ? `${touch.delay_hours}h`
                          : `${Math.round(touch.delay_hours / 24)}d`}
                      </span>
                    )}
                  </Badge>
                </div>
              ))}
            </div>

            {!compact && (
              <Button className="w-full mt-4" disabled={isPending}>
                Use this preset
              </Button>
            )}
          </CardContent>
        </Card>
      ))}
    </div>
  )
}
```
  </action>
  <verify>Preset picker component renders 3 cards with touch sequence visualization</verify>
  <done>Preset picker displays Conservative/Standard/Aggressive options with visual touch sequence</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. `pnpm typecheck` - All imports compile
2. `pnpm lint` - No lint errors
3. Navigate to /campaigns shows page with presets (if no campaigns)
4. Status toggle calls toggleCampaignStatus action
5. Preset picker duplicates preset and redirects to edit page
</verification>

<success_criteria>
- [ ] /campaigns page renders with proper metadata
- [ ] Empty state shows preset picker prominently
- [ ] Campaign list displays name, service type badge, touch counts
- [ ] Status toggle switch updates campaign status optimistically
- [ ] Dropdown menu offers Edit, Duplicate, Delete actions
- [ ] Preset picker shows 3 cards with touch sequence visualization
- [ ] Selecting preset duplicates it and redirects to edit page
- [ ] `pnpm typecheck` passes
</success_criteria>

<output>
After completion, create `.planning/phases/24-multi-touch-campaign-engine/24-07-SUMMARY.md`
</output>
