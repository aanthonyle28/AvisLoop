---
phase: 24-multi-touch-campaign-engine
plan: 03
type: execute
wave: 2
depends_on: [24-01]
files_modified:
  - lib/types/database.ts
  - lib/validations/campaign.ts
  - lib/constants/campaigns.ts
autonomous: true

must_haves:
  truths:
    - "Campaign, CampaignTouch, CampaignEnrollment types exist with correct fields"
    - "Zod schemas validate campaign creation and touch configuration"
    - "Campaign preset constants match seeded database values"
  artifacts:
    - path: "lib/types/database.ts"
      provides: "Campaign-related TypeScript interfaces"
      contains: "interface Campaign"
    - path: "lib/validations/campaign.ts"
      provides: "Zod validation schemas"
      exports: ["campaignSchema", "campaignTouchSchema"]
    - path: "lib/constants/campaigns.ts"
      provides: "Preset definitions and timing defaults"
      contains: "CAMPAIGN_PRESETS"
  key_links:
    - from: "lib/types/database.ts"
      to: "database schema"
      via: "type definitions matching columns"
      pattern: "CampaignStatus.*active.*paused"
    - from: "lib/validations/campaign.ts"
      to: "lib/types/database.ts"
      via: "import types"
      pattern: "from.*types/database"
---

<objective>
Create TypeScript types, Zod validation schemas, and constants for campaigns.

Purpose: Type-safe foundation for campaign CRUD, enabling form validation and server action type checking.

Output: Campaign types in database.ts, Zod schemas for validation, and constants for presets and timing defaults.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/24-multi-touch-campaign-engine/24-RESEARCH.md
@.planning/phases/24-multi-touch-campaign-engine/24-CONTEXT.md
@lib/types/database.ts
@lib/validations/message-template.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add campaign types to database.ts</name>
  <files>lib/types/database.ts</files>
  <action>
Add to existing lib/types/database.ts (append after ScheduledSend types):

```typescript
// Campaign status literal union
export type CampaignStatus = 'active' | 'paused'

// Campaign definition
export interface Campaign {
  id: string
  business_id: string | null  // NULL for system presets
  name: string
  service_type: ServiceType | null  // NULL = all services
  status: CampaignStatus
  is_preset: boolean
  created_at: string
  updated_at: string
}

// Insert type
export type CampaignInsert = Omit<Campaign, 'id' | 'created_at' | 'updated_at'>

// Update type
export type CampaignUpdate = Partial<Omit<Campaign, 'id' | 'business_id' | 'is_preset' | 'created_at' | 'updated_at'>>

// Campaign touch in a sequence
export interface CampaignTouch {
  id: string
  campaign_id: string
  touch_number: number  // 1-4
  channel: MessageChannel
  delay_hours: number
  template_id: string | null
  created_at: string
}

export type CampaignTouchInsert = Omit<CampaignTouch, 'id' | 'created_at'>
export type CampaignTouchUpdate = Partial<Omit<CampaignTouch, 'id' | 'campaign_id' | 'created_at'>>

// Campaign with nested touches for full view
export interface CampaignWithTouches extends Campaign {
  campaign_touches: CampaignTouch[]
}

// Enrollment status state machine
export type EnrollmentStatus = 'active' | 'completed' | 'stopped'

// Stop reason when enrollment ends
export type EnrollmentStopReason =
  | 'review_clicked'
  | 'feedback_submitted'
  | 'opted_out_sms'
  | 'opted_out_email'
  | 'owner_stopped'
  | 'campaign_paused'
  | 'campaign_deleted'
  | 'repeat_job'

// Touch status within enrollment
export type TouchStatus = 'pending' | 'sent' | 'skipped' | 'failed'

// Campaign enrollment tracking
export interface CampaignEnrollment {
  id: string
  business_id: string
  campaign_id: string
  job_id: string
  customer_id: string
  status: EnrollmentStatus
  stop_reason: EnrollmentStopReason | null
  current_touch: number  // 1-4
  touch_1_scheduled_at: string | null
  touch_1_sent_at: string | null
  touch_1_status: TouchStatus | null
  touch_2_scheduled_at: string | null
  touch_2_sent_at: string | null
  touch_2_status: TouchStatus | null
  touch_3_scheduled_at: string | null
  touch_3_sent_at: string | null
  touch_3_status: TouchStatus | null
  touch_4_scheduled_at: string | null
  touch_4_sent_at: string | null
  touch_4_status: TouchStatus | null
  enrolled_at: string
  completed_at: string | null
  stopped_at: string | null
  created_at: string
  updated_at: string
}

export type CampaignEnrollmentInsert = Omit<CampaignEnrollment,
  'id' | 'created_at' | 'updated_at' | 'completed_at' | 'stopped_at'
>

// Enrollment with related data for list views
export interface CampaignEnrollmentWithDetails extends CampaignEnrollment {
  customers: Pick<Customer, 'id' | 'name' | 'email' | 'phone'>
  jobs: Pick<Job, 'id' | 'service_type' | 'completed_at'>
  campaigns: Pick<Campaign, 'id' | 'name'>
}

// Claimed touch from RPC for cron processing
export interface ClaimedCampaignTouch {
  enrollment_id: string
  business_id: string
  campaign_id: string
  job_id: string
  customer_id: string
  touch_number: number
  channel: MessageChannel
  template_id: string | null
  scheduled_at: string
}
```
  </action>
  <verify>`grep "interface Campaign" lib/types/database.ts` returns match; `pnpm typecheck` passes</verify>
  <done>Campaign, CampaignTouch, CampaignEnrollment types defined with proper typing for state machine and nested data</done>
</task>

<task type="auto">
  <name>Task 2: Create campaign validation schemas</name>
  <files>lib/validations/campaign.ts</files>
  <action>
Create lib/validations/campaign.ts:

```typescript
import { z } from 'zod'
import { SERVICE_TYPES } from '@/lib/constants/services'

// Service type enum from constants
const serviceTypeEnum = z.enum(['hvac', 'plumbing', 'electrical', 'cleaning', 'roofing', 'painting', 'handyman', 'other'])

// Campaign status
const campaignStatusEnum = z.enum(['active', 'paused'])

// Message channel
const channelEnum = z.enum(['email', 'sms'])

// Campaign creation/update schema
export const campaignSchema = z.object({
  name: z.string().min(1, 'Name is required').max(100, 'Name too long'),
  service_type: serviceTypeEnum.nullable(),  // NULL = all services
  status: campaignStatusEnum.default('active'),
})

export type CampaignFormData = z.infer<typeof campaignSchema>

// Single touch configuration
export const campaignTouchSchema = z.object({
  touch_number: z.number().min(1).max(4),
  channel: channelEnum,
  delay_hours: z.number().min(1, 'Minimum 1 hour delay').max(720, 'Maximum 30 days'),  // 720 hours = 30 days
  template_id: z.string().uuid().nullable(),
})

export type CampaignTouchFormData = z.infer<typeof campaignTouchSchema>

// Full campaign with touches for form submission
export const campaignWithTouchesSchema = campaignSchema.extend({
  touches: z.array(campaignTouchSchema)
    .min(1, 'At least one touch required')
    .max(4, 'Maximum 4 touches allowed')
    .refine(
      (touches) => {
        // Verify touch numbers are sequential starting from 1
        const numbers = touches.map(t => t.touch_number).sort((a, b) => a - b)
        return numbers.every((n, i) => n === i + 1)
      },
      { message: 'Touch numbers must be sequential (1, 2, 3, 4)' }
    ),
})

export type CampaignWithTouchesFormData = z.infer<typeof campaignWithTouchesSchema>

// Enrollment stop reason
const stopReasonEnum = z.enum([
  'review_clicked',
  'feedback_submitted',
  'opted_out_sms',
  'opted_out_email',
  'owner_stopped',
  'campaign_paused',
  'campaign_deleted',
  'repeat_job',
])

// Enrollment update (for stopping)
export const enrollmentUpdateSchema = z.object({
  status: z.enum(['stopped']),
  stop_reason: stopReasonEnum,
})

export type EnrollmentUpdateData = z.infer<typeof enrollmentUpdateSchema>
```
  </action>
  <verify>`pnpm typecheck` passes; `grep "export const campaignSchema" lib/validations/campaign.ts` returns match</verify>
  <done>Zod schemas validate campaign creation with touch configuration and sequential touch numbers</done>
</task>

<task type="auto">
  <name>Task 3: Create campaign constants file</name>
  <files>lib/constants/campaigns.ts</files>
  <action>
Create lib/constants/campaigns.ts:

```typescript
import type { MessageChannel, ServiceType } from '@/lib/types/database'

// Touch configuration for presets
export interface PresetTouch {
  touch_number: number
  channel: MessageChannel
  delay_hours: number
}

// Campaign preset definition (mirrors seeded data)
export interface CampaignPreset {
  id: 'conservative' | 'standard' | 'aggressive'
  name: string
  description: string
  touches: PresetTouch[]
  recommended_for: ServiceType[]  // Service types this preset works well for
}

export const CAMPAIGN_PRESETS: CampaignPreset[] = [
  {
    id: 'conservative',
    name: 'Conservative (Email Only)',
    description: '2 email touches over 3 days. Best for established relationships.',
    touches: [
      { touch_number: 1, channel: 'email', delay_hours: 24 },
      { touch_number: 2, channel: 'email', delay_hours: 72 },
    ],
    recommended_for: ['hvac', 'plumbing', 'electrical', 'roofing'],
  },
  {
    id: 'standard',
    name: 'Standard (Email + SMS)',
    description: '2 emails + 1 SMS over 7 days. Balanced approach.',
    touches: [
      { touch_number: 1, channel: 'email', delay_hours: 24 },
      { touch_number: 2, channel: 'email', delay_hours: 72 },
      { touch_number: 3, channel: 'sms', delay_hours: 168 },
    ],
    recommended_for: ['painting', 'handyman', 'other'],
  },
  {
    id: 'aggressive',
    name: 'Aggressive (Multi-Channel)',
    description: 'SMS first, then alternate channels. Fast follow-up for quick services.',
    touches: [
      { touch_number: 1, channel: 'sms', delay_hours: 4 },
      { touch_number: 2, channel: 'email', delay_hours: 24 },
      { touch_number: 3, channel: 'sms', delay_hours: 72 },
      { touch_number: 4, channel: 'email', delay_hours: 168 },
    ],
    recommended_for: ['cleaning'],
  },
]

// Get preset by ID
export function getPresetById(id: string): CampaignPreset | undefined {
  return CAMPAIGN_PRESETS.find(p => p.id === id)
}

// Default enrollment cooldown in days
export const DEFAULT_ENROLLMENT_COOLDOWN_DAYS = 30
export const MIN_ENROLLMENT_COOLDOWN_DAYS = 7
export const MAX_ENROLLMENT_COOLDOWN_DAYS = 90

// Rate limits per channel per business (per hour)
export const DEFAULT_EMAIL_RATE_LIMIT = 100
export const DEFAULT_SMS_RATE_LIMIT = 100

// Quiet hours (TCPA compliance)
export const QUIET_HOURS = {
  start: 21,  // 9 PM
  end: 8,     // 8 AM
} as const

// Touch status display labels
export const TOUCH_STATUS_LABELS: Record<string, string> = {
  pending: 'Scheduled',
  sent: 'Sent',
  skipped: 'Skipped',
  failed: 'Failed',
}

// Enrollment status display labels
export const ENROLLMENT_STATUS_LABELS: Record<string, string> = {
  active: 'Active',
  completed: 'Completed',
  stopped: 'Stopped',
}

// Stop reason display labels
export const STOP_REASON_LABELS: Record<string, string> = {
  review_clicked: 'Customer clicked review link',
  feedback_submitted: 'Customer submitted feedback',
  opted_out_sms: 'Opted out of SMS',
  opted_out_email: 'Opted out of email',
  owner_stopped: 'Manually stopped',
  campaign_paused: 'Campaign paused',
  campaign_deleted: 'Campaign deleted',
  repeat_job: 'New job enrolled (restart)',
}
```
  </action>
  <verify>`pnpm typecheck` passes; all 3 presets defined with correct touch counts</verify>
  <done>Campaign constants define presets, rate limits, quiet hours, and display labels for UI</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. `pnpm typecheck` - All campaign types and schemas compile without errors
2. `pnpm lint` - No lint errors in new files
3. Types match database schema columns exactly
4. Preset constants match seeded migration data
</verification>

<success_criteria>
- [ ] Campaign, CampaignTouch, CampaignEnrollment types in database.ts
- [ ] ClaimedCampaignTouch type for RPC return value
- [ ] Zod schemas validate campaign form data with touch configuration
- [ ] Sequential touch number validation in schema
- [ ] CAMPAIGN_PRESETS array matches seeded database presets
- [ ] Quiet hours, rate limits, and status labels defined
- [ ] `pnpm typecheck` passes
</success_criteria>

<output>
After completion, create `.planning/phases/24-multi-touch-campaign-engine/24-03-SUMMARY.md`
</output>
