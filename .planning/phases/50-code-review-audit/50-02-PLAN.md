---
phase: 50-code-review-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/50-code-review-audit/50-02-SUMMARY.md
autonomous: true

must_haves:
  truths:
    - "Every file modified in Phase 44 (Onboarding & Services) has been reviewed for security, correctness, performance, and V2 alignment"
    - "Server actions have been audited for input validation, auth checks, and RLS compliance"
    - "Custom service names data flow is verified end-to-end from UI to database"
    - "All findings are severity-rated with file location, line number, and fix recommendation"
  artifacts:
    - path: ".planning/phases/50-code-review-audit/50-02-SUMMARY.md"
      provides: "Interim findings from onboarding and data layer review of Phase 44"
  key_links:
    - from: "50-02-SUMMARY.md"
      to: "50-03 findings report"
      via: "findings carried forward to consolidated report"
---

<objective>
Systematically review all files modified in Phase 44 (19 files, ~3,904 lines) covering CRM platform step, custom service names, onboarding flow, server actions, data queries, and type definitions. Focus on security (server action input validation, auth, RLS), correctness (data flow integrity), performance (query efficiency), and V2 alignment.

Purpose: This covers AUD-04 (Phase 44 files), AUD-05 (security of server actions), AUD-06 (performance), AUD-07 (V2 alignment), and partially AUD-10 (dead code in Phase 44 files).

Output: SUMMARY with all findings from the onboarding and data layer review, ready for 50-03 consolidation.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-code-review-audit/50-RESEARCH.md
@docs/DATA_MODEL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Security & Data Flow Review (Server Actions + Data Layer, 10 files)</name>
  <files>
    lib/actions/onboarding.ts
    lib/actions/business.ts
    lib/actions/conflict-resolution.ts
    lib/actions/job.ts
    lib/data/business.ts
    lib/data/onboarding.ts
    lib/data/jobs.ts
    lib/types/database.ts
    lib/types/onboarding.ts
    lib/validations/onboarding.ts
  </files>
  <action>
Read each file completely. For each file, evaluate against these dimensions:

**Security (HIGH PRIORITY for server actions):**

For `lib/actions/onboarding.ts` (366 lines):
- Does `saveServicesOffered` validate `customServiceNames` server-side? Research found Zod schema validation with max 10 strings of 50 chars. VERIFY the exact schema constraints.
- Does it use `createClient()` (authenticated) not service role?
- Is `business_id` scoped from session, not from client input?
- Are there any `.update()` calls without `.eq('business_id', ...)` or equivalent RLS?
- Does `saveSoftwareUsed` accept arbitrary strings? Check for max length on `software_used` field.

For `lib/actions/business.ts` (302 lines):
- Does `updateServiceTypeSettings` have defense-in-depth validation for `customServiceNames`? Research found `.map(n => n.trim()).filter(n => n.length > 0 && n.length <= 50).slice(0, 10)`. VERIFY this exists and is correct.
- Same auth/RLS checks as above.
- Any SQL injection vectors? (Supabase parameterizes, but check for raw queries)

For `lib/actions/conflict-resolution.ts` and `lib/actions/job.ts`:
- Research says "minimal changes" — verify no regressions in auth patterns.
- Check that org_id/business_id scoping is maintained.

**Data Flow Integrity (custom_service_names end-to-end):**

Trace the full path:
1. `lib/validations/onboarding.ts` — schema definition for `customServiceNames`
2. `lib/actions/onboarding.ts` — `saveServicesOffered()` writes to DB
3. `lib/actions/business.ts` — `updateServiceTypeSettings()` writes to DB
4. `lib/data/business.ts` — `getServiceTypeSettings()` reads from DB, includes `custom_service_names`
5. `lib/data/onboarding.ts` — `getOnboardingStatus()` reads from DB, includes `custom_service_names`
6. `lib/types/database.ts` — `Business` type includes `custom_service_names: string[] | null`
7. `lib/types/onboarding.ts` — onboarding types include custom_service_names

Verify: If a user saves `["Duct Cleaning", "Insulation"]` through onboarding, does the same array come back when loading settings? Any type mismatches (string[] vs null vs undefined)?

**Performance:**
- `lib/data/business.ts`: Does `getServiceTypeSettings` fetch only needed columns or `select('*')`?
- `lib/data/onboarding.ts`: Same check.
- `lib/data/jobs.ts`: Any N+1 query patterns? Joins vs separate fetches?

**Dead Code:**
- RF-5: CRM platform step missing selection validation — verify in `lib/validations/onboarding.ts` (is there a schema for CRM selection? Or is it unvalidated?)
- Unused exports in type files
- Deprecated patterns in database.ts (SendLogWithContact alias — verify it's still there and document)

**V2 Alignment:**
- Do onboarding actions align with V2 flow (business setup -> campaign -> CRM -> SMS consent)?
- No V1 patterns reintroduced (manual customer creation, import-first flows)?

Record every finding with: severity, file path, line number (or range), description, and fix recommendation.
  </action>
  <verify>
- All 10 files read and reviewed
- Security audit covers: auth pattern, input validation, RLS scoping for every server action
- Data flow traced from validation schema -> server action -> database -> query -> types
- At minimum RF-5 confirmed or revised
  </verify>
  <done>
All 10 server-side and type files reviewed. Security findings documented with specific line numbers. Data flow integrity verified or gaps identified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Onboarding & Settings UI Review (9 files) + Compile SUMMARY</name>
  <files>
    app/onboarding/page.tsx
    components/onboarding/onboarding-wizard.tsx
    components/onboarding/onboarding-steps.tsx
    components/onboarding/steps/crm-platform-step.tsx
    components/onboarding/steps/business-setup-step.tsx
    components/settings/service-types-section.tsx
    components/settings/settings-tabs.tsx
    components/jobs/edit-job-sheet.tsx
    components/jobs/job-columns.tsx
  </files>
  <action>
Read each file completely. For each file, evaluate:

**Correctness:**

For `app/onboarding/page.tsx` (79 lines):
- Step clamp to 4: verify `Math.min(Math.max(step, 1), 4)` or equivalent
- Does it handle invalid step param (NaN, negative, >4)?

For `components/onboarding/onboarding-wizard.tsx` (146 lines):
- STEPS array: verify 4 entries (Business Setup, Campaign Preset, CRM Platform, SMS Consent)
- Progress bar: does it correctly reflect 4 steps?
- Navigation: can user go back? Can user skip CRM step?

For `components/onboarding/onboarding-steps.tsx` (78 lines):
- Switch/case for steps 1-4: all cases covered? Default case?

For `components/onboarding/steps/crm-platform-step.tsx` (206 lines):
- RF-5: Missing selection validation — verify: Can user click Continue without selecting? What value is saved (null vs empty string)?
- RF-6: Hardcoded colors in CRM cards — verify: `bg-emerald-500`, `bg-blue-500` etc. Are these brand-specific (acceptable) or should use semantic tokens?
- Accessibility: `role="radiogroup"`, `role="radio"`, `aria-checked` present?
- Keyboard navigation: can user select cards with arrow keys or Enter?

For `components/onboarding/steps/business-setup-step.tsx` (265 lines):
- Custom service names multi-tag input: Enter key prevention (`e.preventDefault()` in sub-input)?
- Max tag count enforcement (10 max)?
- Individual tag length enforcement (50 chars max)?
- What happens if user types > 50 chars? Truncation? Error?

For `components/settings/service-types-section.tsx` (273 lines):
- Custom service names: same tag input pattern as onboarding?
- Parity check: do onboarding and settings behave identically for custom services?
- Does unchecking "Other" clear custom service names?

For `components/settings/settings-tabs.tsx` (159 lines):
- Does it thread `customServiceNames` to `service-types-section`?

For `components/jobs/edit-job-sheet.tsx` and `job-columns.tsx`:
- Do they display custom service names correctly?
- Do they use `BusinessSettingsProvider` context?

**Accessibility:**
- CRM cards: keyboard navigable? Focus visible?
- Tag input: screen reader announces added/removed tags?
- Form validation errors: `aria-invalid` used?

**Design System:**
- CRM card styling: consistent with project card patterns?
- Tag badges: use existing `TagBadge` component or custom?
- Form layout: consistent spacing, label patterns?

After reviewing all 9 files, compile ALL findings from Task 1 and Task 2 into the SUMMARY. Structure the findings as a table with columns: ID, Severity, Phase, File, Line(s), Description, Recommendation.
  </action>
  <verify>
- All 9 files read and reviewed
- RF-5 and RF-6 confirmed or revised with exact line numbers
- CRM platform step accessibility verified
- Custom service names parity between onboarding and settings checked
- SUMMARY written to `.planning/phases/50-code-review-audit/50-02-SUMMARY.md`
  </verify>
  <done>
All 19 files from Phase 44 reviewed. SUMMARY contains a complete severity-rated findings table covering security, correctness, performance, accessibility, design system, dead code, and V2 alignment. Every finding has file path, line number, severity, description, and recommendation.
  </done>
</task>

</tasks>

<verification>
- [ ] All 10 server-side/type files reviewed with security focus
- [ ] All 9 UI/component files reviewed with correctness and accessibility focus
- [ ] Server action input validation verified for every action that writes to DB
- [ ] Auth pattern (createClient, not service role) verified for every server action
- [ ] Custom service names data flow traced end-to-end
- [ ] Known red flags RF-5, RF-6 confirmed or revised with line numbers
- [ ] Every finding has: severity, file path, line number, description, recommendation
- [ ] SUMMARY written with findings table
</verification>

<success_criteria>
19 files reviewed across security, correctness, performance, accessibility, design system, and V2 alignment. SUMMARY contains all findings in a structured format ready for consolidation in Plan 50-03. Requirements AUD-04, AUD-05 (server actions), AUD-06, AUD-07, AUD-10 (Phase 44 dead code) covered.
</success_criteria>

<output>
After completion, create `.planning/phases/50-code-review-audit/50-02-SUMMARY.md`
</output>
