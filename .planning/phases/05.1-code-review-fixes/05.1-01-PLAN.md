---
phase: 05.1-code-review-fixes
plan: 01
title: Fix Code Review Issues from Phases 4 & 5
wave: 1
depends_on: []
files_modified:
  - app/api/webhooks/resend/route.ts
  - lib/constants/billing.ts (new)
  - lib/actions/send.ts
  - lib/data/send-logs.ts
  - components/send/contact-selector.tsx
  - supabase/migrations/00006_add_monthly_count_index.sql (new)
  - app/(dashboard)/history/error.tsx (new)
autonomous: true
---

# Plan 05.1-01: Fix Code Review Issues

<objective>
Address all issues identified in the code review of Phase 4 (Core Sending) and Phase 5 (Message History). Fixes are prioritized by severity: critical first, then medium, then low.
</objective>

<context>
Code review identified:
- 1 HIGH severity issue (webhook rate limiting)
- 3 MEDIUM severity issues (index, retry consideration, atomicity)
- 5 LOW severity issues (constants duplication, error boundaries, etc.)

The webhook rate limiting is critical for production security.
</context>

<tasks>

<task id="1" title="Add webhook rate limiting">
**Priority: HIGH - Security**

Create IP-based rate limiting for the Resend webhook endpoint to prevent abuse.

**File:** `app/api/webhooks/resend/route.ts`

**Changes:**
1. Add rate limiting check BEFORE signature verification (to save CPU)
2. Use in-memory rate limiting (simple Map with TTL) or Upstash if available
3. Limit: 100 requests per minute per IP
4. Return 429 Too Many Requests when exceeded

**Implementation:**
```typescript
// At top of file, add simple in-memory rate limiter
const ipRequestCounts = new Map<string, { count: number; resetAt: number }>()
const RATE_LIMIT = 100 // requests per minute
const RATE_WINDOW = 60 * 1000 // 1 minute in ms

function checkWebhookRateLimit(ip: string): boolean {
  const now = Date.now()
  const record = ipRequestCounts.get(ip)

  if (!record || now > record.resetAt) {
    ipRequestCounts.set(ip, { count: 1, resetAt: now + RATE_WINDOW })
    return true
  }

  if (record.count >= RATE_LIMIT) {
    return false
  }

  record.count++
  return true
}

// In POST handler, before signature verification:
const ip = req.headers.get('x-forwarded-for')?.split(',')[0] || 'unknown'
if (!checkWebhookRateLimit(ip)) {
  return NextResponse.json({ error: 'Too many requests' }, { status: 429 })
}
```

**Verification:**
- [ ] Rate limiter rejects after 100 requests from same IP
- [ ] Different IPs are tracked separately
- [ ] Counter resets after 1 minute
</task>

<task id="2" title="Add composite index for monthly count query">
**Priority: MEDIUM - Performance**

Create migration for composite index to optimize the monthly send count query.

**File:** `supabase/migrations/00006_add_monthly_count_index.sql`

**Content:**
```sql
-- Migration: 00006_add_monthly_count_index
-- Purpose: Optimize monthly send count query for billing enforcement

-- Composite index for monthly usage queries
-- Covers: WHERE business_id = ? AND created_at >= ? AND status IN (...)
CREATE INDEX IF NOT EXISTS idx_send_logs_monthly_usage
ON public.send_logs (business_id, created_at DESC)
WHERE status IN ('sent', 'delivered', 'opened');
```

**Verification:**
- [ ] Migration file created
- [ ] Index uses partial index for status filter
</task>

<task id="3" title="Extract billing constants to shared file">
**Priority: LOW - Maintainability**

Create shared constants file and update all references.

**New file:** `lib/constants/billing.ts`
```typescript
// Billing tier configuration
export const TIER_LIMITS = {
  trial: { sends: 25, contacts: Infinity },
  basic: { sends: 200, contacts: 200 },
  pro: { sends: 500, contacts: Infinity },
} as const

export const MONTHLY_SEND_LIMITS: Record<string, number> = {
  trial: 25,
  basic: 200,
  pro: 500,
}

export const COOLDOWN_DAYS = 14

export type TierName = keyof typeof TIER_LIMITS
```

**Update files:**
1. `lib/actions/send.ts` - import MONTHLY_SEND_LIMITS, COOLDOWN_DAYS
2. `lib/data/send-logs.ts` - import MONTHLY_SEND_LIMITS, COOLDOWN_DAYS
3. `components/send/contact-selector.tsx` - import COOLDOWN_DAYS

**Verification:**
- [ ] Constants defined once in lib/constants/billing.ts
- [ ] All 3 files updated to import from shared file
- [ ] No duplicate constant definitions remain
</task>

<task id="4" title="Add RESEND_FROM_EMAIL validation">
**Priority: LOW - Reliability**

Add startup validation for RESEND_FROM_EMAIL to prevent production failures.

**File:** `lib/email/resend.ts`

**Add after existing validation:**
```typescript
if (!process.env.RESEND_FROM_EMAIL) {
  console.warn('RESEND_FROM_EMAIL not set - using sandbox domain (emails will fail in production)')
}

export const RESEND_FROM_EMAIL = process.env.RESEND_FROM_EMAIL || 'onboarding@resend.dev'
```

**Update:** `lib/actions/send.ts` to import and use `RESEND_FROM_EMAIL`

**Verification:**
- [ ] Warning logged if RESEND_FROM_EMAIL not set
- [ ] Constant exported from resend.ts
- [ ] send.ts uses imported constant
</task>

<task id="5" title="Add error boundary for history page">
**Priority: LOW - UX**

Create error.tsx for the history page to gracefully handle errors.

**New file:** `app/(dashboard)/history/error.tsx`
```typescript
'use client'

import { useEffect } from 'react'
import { Button } from '@/components/ui/button'
import { AlertCircle } from 'lucide-react'

export default function HistoryError({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  useEffect(() => {
    console.error('History page error:', error)
  }, [error])

  return (
    <div className="container py-6">
      <div className="flex flex-col items-center justify-center py-16 text-center">
        <AlertCircle className="h-12 w-12 text-destructive mb-4" />
        <h2 className="text-xl font-semibold mb-2">Something went wrong</h2>
        <p className="text-muted-foreground mb-6">
          We couldn&apos;t load your message history.
        </p>
        <Button onClick={reset}>Try again</Button>
      </div>
    </div>
  )
}
```

**Verification:**
- [ ] error.tsx created in history folder
- [ ] Includes reset button to retry
- [ ] Logs error for debugging
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `pnpm typecheck` - no errors
2. Run `pnpm lint` - no errors
3. Verify webhook endpoint still works (signature verification intact)
4. Verify send flow still works with extracted constants
</verification>

<must_haves>
- [ ] Webhook has rate limiting before signature verification
- [ ] Monthly count query has optimized index
- [ ] Billing constants defined in single source of truth
- [ ] History page has error boundary
- [ ] All existing functionality preserved
</must_haves>

<out_of_scope>
- Retry logic for failed sends (requires queue system, deferred)
- Atomic contact ownership check (low risk due to RLS, deferred)
- Visual indicator for opted-out contacts in selector (contacts already filtered server-side)
</out_of_scope>
