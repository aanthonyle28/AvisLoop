---
phase: 05.1-code-review-fixes
plan: 01
title: Fix Code Review Issues from Phases 4 & 5
subsystem: core
tags: [security, performance, refactor, ux]
requires: [05-message-history]
provides: [secure-webhook, billing-constants, error-boundaries]
affects: [06-billing-limits]
tech-stack:
  added: []
  patterns: [in-memory-rate-limiting, shared-constants]
key-files:
  created:
    - lib/constants/billing.ts
    - supabase/migrations/00006_add_monthly_count_index.sql
    - app/(dashboard)/history/error.tsx
  modified:
    - app/api/webhooks/resend/route.ts
    - lib/email/resend.ts
    - lib/actions/send.ts
    - lib/data/send-logs.ts
    - components/send/contact-selector.tsx
decisions:
  - id: 05.1-01-rate-limit
    desc: Use in-memory rate limiting for webhook (100 req/min per IP)
  - id: 05.1-01-billing-constants
    desc: Single source of truth for billing constants in lib/constants/billing.ts
  - id: 05.1-01-from-email
    desc: Export RESEND_FROM_EMAIL from resend.ts with warning on missing
metrics:
  duration: 3 min
  completed: 2026-01-28
---

# Phase 05.1 Plan 01: Fix Code Review Issues Summary

**One-liner:** Added webhook rate limiting, performance index, billing constants consolidation, and error boundary

## What Was Built

### 1. Webhook Rate Limiting (HIGH Priority - Security)
Added IP-based in-memory rate limiting to the Resend webhook endpoint:
- 100 requests per minute per IP
- Rate check performed BEFORE signature verification (saves CPU on attacks)
- Returns 429 Too Many Requests when exceeded
- Counter auto-resets after 1-minute window

### 2. Monthly Count Index (MEDIUM Priority - Performance)
Created migration for composite partial index:
- Index: `(business_id, created_at DESC)`
- Partial: Only indexes `status IN ('sent', 'delivered', 'opened')`
- Optimizes the monthly usage query for billing enforcement

### 3. Billing Constants Consolidation (LOW Priority - Maintainability)
Created single source of truth for billing configuration:
- `lib/constants/billing.ts` exports:
  - `TIER_LIMITS` - sends and contacts per tier
  - `MONTHLY_SEND_LIMITS` - monthly send limits by tier
  - `COOLDOWN_DAYS` - contact cooldown period (14 days)
  - `TierName` - TypeScript type for tier names
- Updated 3 files to use shared constants:
  - `lib/actions/send.ts`
  - `lib/data/send-logs.ts`
  - `components/send/contact-selector.tsx`

### 4. RESEND_FROM_EMAIL Validation (LOW Priority - Reliability)
Added environment variable validation:
- Warning logged at module load if `RESEND_FROM_EMAIL` not set
- Exported constant with sandbox domain fallback
- `lib/actions/send.ts` updated to use exported constant

### 5. History Page Error Boundary (LOW Priority - UX)
Created error.tsx for graceful error handling:
- Logs errors to console for debugging
- User-friendly error message
- Reset button to retry

## Technical Decisions

| ID | Decision | Rationale |
|----|----------|-----------|
| 05.1-01-rate-limit | In-memory rate limiting for webhook | Simple, no external deps, sufficient for edge case abuse prevention |
| 05.1-01-billing-constants | Centralize billing constants | Prevents drift, single update point, type-safe |
| 05.1-01-from-email | Export from resend.ts | Colocates email config, provides fallback for dev |

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

- [x] `pnpm typecheck` - no errors
- [x] `pnpm lint` - no errors
- [x] Rate limiter added before signature verification
- [x] Constants deduplicated across all files
- [x] Error boundary created for history page

## User Setup Required

**Migration 00006:** Run in Supabase SQL Editor:
```sql
CREATE INDEX IF NOT EXISTS idx_send_logs_monthly_usage
ON public.send_logs (business_id, created_at DESC)
WHERE status IN ('sent', 'delivered', 'opened');
```

## Commits

| Hash | Type | Description |
|------|------|-------------|
| 38b3dcc | fix | Add webhook rate limiting |
| 48ea229 | perf | Add composite index for monthly usage query |
| f6bbafa | refactor | Extract billing constants to shared file |
| 6ab9d47 | feat | Add RESEND_FROM_EMAIL validation and export |
| da7ab35 | feat | Add error boundary for history page |

## Out of Scope (Deferred)

- Retry logic for failed sends (requires queue system)
- Atomic contact ownership check (low risk due to RLS)
- Visual indicator for opted-out contacts in selector (already filtered server-side)

## Next Phase Readiness

Phase 6 (Billing & Limits) can proceed. The billing constants foundation is now in place.
