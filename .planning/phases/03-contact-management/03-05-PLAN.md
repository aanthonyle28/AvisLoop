---
phase: 03-contact-management
plan: 05
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - components/contacts/csv-import-dialog.tsx
  - components/contacts/csv-preview-table.tsx
autonomous: true

must_haves:
  truths:
    - "Users can upload CSV via drag-and-drop or file picker"
    - "CSV columns are auto-mapped to contact fields"
    - "Preview shows all rows before import"
    - "Duplicates are detected and shown to user"
  artifacts:
    - path: "components/contacts/csv-import-dialog.tsx"
      provides: "Dialog for CSV upload and import flow"
      contains: "useDropzone"
    - path: "components/contacts/csv-preview-table.tsx"
      provides: "Preview table for CSV rows"
      contains: "Table"
  key_links:
    - from: "csv-import-dialog.tsx"
      to: "papaparse"
      via: "Papa.parse"
      pattern: "Papa.parse"
    - from: "csv-import-dialog.tsx"
      to: "bulkCreateContacts"
      via: "Server Action call"
      pattern: "bulkCreateContacts"
---

<objective>
Create CSV import dialog with drag-and-drop upload, auto-mapping, preview, and duplicate detection.

Purpose: Enable bulk contact import from CSV files
Output: Import dialog with dropzone, preview, and import button
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-contact-management/03-RESEARCH.md
@.planning/phases/03-contact-management/03-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV preview table component</name>
  <files>components/contacts/csv-preview-table.tsx</files>
  <action>
Create a preview table for CSV import rows.

```typescript
'use client'

import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Badge } from '@/components/ui/badge'
import { CheckCircle, XCircle, AlertTriangle } from 'lucide-react'
```

**Props:**
```typescript
interface CSVPreviewTableProps {
  rows: Array<{
    name: string
    email: string
    phone?: string
    isValid: boolean
    isDuplicate: boolean
    errors: string[]
  }>
  existingEmails: Set<string>  // Emails already in database
}
```

**Columns:**
1. Status icon - CheckCircle (green), XCircle (red for invalid), AlertTriangle (yellow for duplicate)
2. Name
3. Email
4. Phone (or '-' if empty)
5. Errors - Show first error or "Duplicate" badge

**Styling:**
- Invalid rows: red background tint
- Duplicate rows: yellow background tint
- Valid rows: normal background
- Max height with scroll (max-h-[400px] overflow-auto)

**Footer summary:**
- Total rows: N
- Valid: N (green)
- Invalid: N (red)
- Duplicates: N (yellow)
  </action>
  <verify>`npx tsc --noEmit` passes, component exports CSVPreviewTable</verify>
  <done>Preview table shows rows with validation status and summary</done>
</task>

<task type="auto">
  <name>Task 2: Create CSV import dialog</name>
  <files>components/contacts/csv-import-dialog.tsx</files>
  <action>
Create complete CSV import dialog with multi-step flow.

```typescript
'use client'

import { useState, useCallback } from 'react'
import Papa from 'papaparse'
import { useDropzone } from 'react-dropzone'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogFooter,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Upload, FileSpreadsheet, AlertCircle, CheckCircle } from 'lucide-react'
import { CSVPreviewTable } from './csv-preview-table'
import { bulkCreateContacts, getContacts, type BulkCreateResult } from '@/lib/actions/contact'
import { contactSchema } from '@/lib/validations/contact'
```

**State:**
- step: 'upload' | 'preview' | 'importing' | 'complete'
- file: File | null
- parsedRows: parsed CSV data
- mappedContacts: validated contacts for preview
- existingEmails: Set<string> (fetched from database)
- importResult: BulkCreateResult | null

**Header auto-mapping (from RESEARCH.md):**
```typescript
const HEADER_MAPPINGS: Record<string, string> = {
  'name': 'name', 'Name': 'name', 'NAME': 'name',
  'full_name': 'name', 'fullname': 'name', 'contact_name': 'name',
  'First Name': 'name', 'first_name': 'name',
  'email': 'email', 'Email': 'email', 'EMAIL': 'email',
  'email_address': 'email', 'E-mail': 'email',
  'phone': 'phone', 'Phone': 'phone', 'PHONE': 'phone',
  'phone_number': 'phone', 'mobile': 'phone', 'Mobile': 'phone',
}
```

**Step 1: Upload**
- Dropzone with react-dropzone
- Accept: .csv files only
- "Drop CSV file here or click to upload"
- FileSpreadsheet icon
- Show selected file name if file chosen

**Step 2: Preview**
- Parse CSV with Papa.parse (header: true, skipEmptyLines: true)
- Auto-map headers to name/email/phone
- Validate each row with contactSchema
- Fetch existing emails from database
- Mark duplicates (email already in existingEmails)
- Show CSVPreviewTable
- "Import X contacts" button (count excludes invalid and duplicates)
- "Cancel" button to return to upload

**Step 3: Importing**
- Show loading spinner
- Call bulkCreateContacts with valid, non-duplicate contacts
- Update step to 'complete' when done

**Step 4: Complete**
- Show success message with counts
- "Created: X", "Skipped (duplicates): Y"
- "Close" button to close dialog
- Reset state on close

**Dropzone styling:**
- Border dashed when idle
- Border solid blue when drag active
- Rounded corners, padding, centered content
  </action>
  <verify>`npx tsc --noEmit` passes, component exports CSVImportDialog</verify>
  <done>Complete CSV import flow with upload, preview, validation, and import</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compiles
2. Components export correctly
3. PapaParse parses CSV correctly
4. react-dropzone handles file selection
</verification>

<success_criteria>
- [ ] Dropzone accepts CSV files via drag-drop or click
- [ ] CSV headers are auto-mapped to name/email/phone
- [ ] Preview table shows all rows with validation status
- [ ] Invalid rows shown in red with error messages
- [ ] Duplicate emails detected and shown in yellow
- [ ] Import button shows correct count (excludes invalid/duplicates)
- [ ] Import calls bulkCreateContacts and shows results
- [ ] Dialog resets when closed
</success_criteria>

<output>
After completion, create `.planning/phases/03-contact-management/03-05-SUMMARY.md`
</output>
