---
phase: 25-llm-personalization
plan: 11
type: execute
wave: 2
depends_on: [25-10]
files_modified:
  - lib/data/personalization.ts
  - components/settings/personalization-section.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Settings page shows estimated monthly cost for LLM personalization"
    - "Cost estimate uses per-model pricing from MODEL_COSTS"
    - "Cost display is internal transparency (not user-facing billing)"
  artifacts:
    - path: "lib/data/personalization.ts"
      provides: "Cost calculation logic and monthly projection"
      contains: "estimatedMonthlyCost"
    - path: "components/settings/personalization-section.tsx"
      provides: "Cost display in settings UI"
      contains: "month"
  key_links:
    - from: "lib/data/personalization.ts"
      to: "lib/ai/client.ts MODEL_COSTS"
      via: "import for per-model pricing"
      pattern: "MODEL_COSTS"
    - from: "components/settings/personalization-section.tsx"
      to: "lib/data/personalization.ts"
      via: "PersonalizationSummary.costEstimate"
      pattern: "costEstimate"
---

<objective>
Add cost tracking and monthly cost projection to the settings personalization section. Currently, rate limiting works and usage is displayed, but there is no cost estimate. SC #11 requires "estimated cost per month shown in settings."

Per CONTEXT.md: "Hidden -- costs absorbed into subscription tiers. Users see message limits and value metrics, not LLM costs." This means the cost display is for the business owner's transparency in settings (internal estimate), not a billing feature.

Purpose: Close SC #11 gap. Show estimated monthly LLM cost in the personalization section of settings.

Output: Cost calculation in personalization.ts, cost display in personalization-section.tsx.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@lib/data/personalization.ts
@lib/ai/client.ts
@components/settings/personalization-section.tsx
@.planning/phases/25-llm-personalization/25-10-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cost calculation to personalization data functions</name>
  <files>lib/data/personalization.ts</files>
  <action>
Add cost estimation logic to `lib/data/personalization.ts`:

**1. Import MODEL_COSTS from client.ts:**

```typescript
import { MODEL_COSTS, MODELS } from '@/lib/ai/client'
```

**2. Add cost estimation constants:**

```typescript
// Average token estimates per personalization call
// Based on typical review request message length and LLM response
const AVG_INPUT_TOKENS = 350   // System prompt (~200) + user prompt (~150)
const AVG_OUTPUT_TOKENS = 150  // Personalized message body

// Model distribution for cost weighting (from CONTEXT.md)
const MODEL_DISTRIBUTION = {
  [MODELS.GEMINI_FLASH]: 0.70,  // 70% of calls
  [MODELS.GPT_4O_MINI]: 0.25,   // 25% of calls
  [MODELS.DEEPSEEK_V3]: 0.05,   // 5% of calls
} as const
```

**3. Add cost calculation function:**

```typescript
/**
 * Calculate estimated cost per LLM call based on weighted model distribution.
 * Returns cost in USD.
 */
function calculateWeightedCostPerCall(): number {
  let totalCost = 0

  for (const [modelId, weight] of Object.entries(MODEL_DISTRIBUTION)) {
    const costs = MODEL_COSTS[modelId as keyof typeof MODEL_COSTS]
    if (!costs) continue

    const inputCost = (AVG_INPUT_TOKENS / 1_000_000) * costs.input
    const outputCost = (AVG_OUTPUT_TOKENS / 1_000_000) * costs.output
    totalCost += (inputCost + outputCost) * weight
  }

  return totalCost
}

/**
 * Estimate monthly cost based on weekly send volume.
 * Assumes consistent weekly volume projected over 4.3 weeks/month.
 */
function estimateMonthlyCost(weeklySends: number): number {
  const costPerCall = calculateWeightedCostPerCall()
  const monthlyProjectedCalls = weeklySends * 4.3  // ~4.3 weeks per month
  return monthlyProjectedCalls * costPerCall
}
```

**4. Add CostEstimate type to PersonalizationSummary:**

Update the `PersonalizationSummary` interface:

```typescript
export interface PersonalizationSummary {
  stats: PersonalizationStats
  usage: LLMUsageStats
  health: 'great' | 'good' | 'degraded'
  healthMessage: string
  costEstimate: CostEstimate
}

export interface CostEstimate {
  /** Estimated cost per LLM call in USD */
  costPerCall: number
  /** Estimated monthly cost in USD based on current volume */
  estimatedMonthlyCost: number
  /** Whether the estimate is based on actual data or projections */
  isProjection: boolean
  /** Weekly send volume used for projection */
  weeklyVolume: number
}
```

**5. Update `getPersonalizationSummary()` to include cost:**

In the `getPersonalizationSummary` function, after computing stats and usage, add:

```typescript
const costPerCall = calculateWeightedCostPerCall()
const costEstimate: CostEstimate = {
  costPerCall,
  estimatedMonthlyCost: estimateMonthlyCost(stats.campaignSendsThisWeek),
  isProjection: true,
  weeklyVolume: stats.campaignSendsThisWeek,
}
```

Then include `costEstimate` in the return object.

Do NOT change the existing stats/usage/health logic. Only add the costEstimate field.
  </action>
  <verify>
    Run `pnpm typecheck` to confirm CostEstimate type and all functions compile.
  </verify>
  <done>
    - CostEstimate interface defined with costPerCall, estimatedMonthlyCost, isProjection, weeklyVolume
    - calculateWeightedCostPerCall() uses MODEL_COSTS with model distribution weights
    - estimateMonthlyCost() projects weekly sends to monthly
    - getPersonalizationSummary() includes costEstimate in return
    - TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cost display to PersonalizationSection UI</name>
  <files>components/settings/personalization-section.tsx</files>
  <action>
Update `components/settings/personalization-section.tsx` to display the cost estimate:

**1. Add a cost display card to the stats grid:**

Change the grid from 3 columns to 4 columns (or add a new row). Add a 4th card after the Fallback Rate card:

```tsx
{/* Estimated Monthly Cost */}
<div className="rounded-lg border border-border p-4 bg-muted/30">
  <div className="text-sm font-medium text-muted-foreground mb-1">
    Est. Monthly Cost
  </div>
  <div className="flex items-baseline gap-2">
    <span className="text-2xl font-bold">
      {summary.costEstimate.weeklyVolume > 0
        ? formatCost(summary.costEstimate.estimatedMonthlyCost)
        : '--'}
    </span>
    {summary.costEstimate.isProjection && summary.costEstimate.weeklyVolume > 0 && (
      <span className="text-xs text-muted-foreground">(projected)</span>
    )}
  </div>
</div>
```

Update the grid class from `grid-cols-1 sm:grid-cols-3` to `grid-cols-1 sm:grid-cols-2 lg:grid-cols-4` to accommodate the 4th card.

**2. Add a helper to format cost:**

```typescript
/** Format a USD cost value for display. */
function formatCost(cost: number): string {
  if (cost < 0.01) return '<$0.01'
  if (cost < 1) return `$${cost.toFixed(2)}`
  return `$${cost.toFixed(2)}`
}
```

**3. Add a subtle note below the usage bar** about cost being absorbed:

After the existing usage capacity bar section, add:

```tsx
{summary.costEstimate.weeklyVolume > 0 && (
  <div className="text-xs text-muted-foreground">
    AI personalization cost is included in your plan â€” no additional charges.
    {summary.costEstimate.costPerCall > 0 && (
      <span> (~{formatCost(summary.costEstimate.costPerCall * 1000)}/1K messages)</span>
    )}
  </div>
)}
```

This reinforces the CONTEXT.md decision: "costs absorbed into subscription tiers" while still providing transparency per SC #11.

Do NOT add a separate cost tracking dashboard or billing section. This is a lightweight estimate in the existing personalization section.
  </action>
  <verify>
    Run `pnpm typecheck` to confirm the component compiles with the new CostEstimate type. Run `pnpm lint` to confirm no lint errors.
  </verify>
  <done>
    - Settings page shows "Est. Monthly Cost" card with projected amount
    - Cost formatted as USD (e.g., "$0.43")
    - "(projected)" label indicates this is an estimate
    - Note about cost being included in plan shown below usage bar
    - Per-1K-message cost shown for transparency
    - No changes when there are zero sends (shows "--")
    - Grid layout updated to accommodate 4 stats cards
    - TypeScript compiles, lint passes
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. PersonalizationSummary includes costEstimate field
4. PersonalizationSection displays estimated monthly cost
5. Cost calculation uses MODEL_COSTS from client.ts
6. Cost absorption note shown ("included in your plan")
</verification>

<success_criteria>
- Settings shows estimated monthly LLM cost based on weekly send volume
- Cost uses weighted average across model distribution (70/25/5)
- Cost display framed as transparency, not billing
- Shows "--" when no sends exist (no misleading $0.00)
- TypeScript compiles, lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/25-llm-personalization/25-11-SUMMARY.md`
</output>
