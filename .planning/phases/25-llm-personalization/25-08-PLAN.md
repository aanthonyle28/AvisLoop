---
phase: 25-llm-personalization
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/cron/process-campaign-touches/route.ts
  - lib/types/database.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Campaign personalization_enabled=false skips LLM personalization and sends raw template"
    - "Campaign personalization_enabled=true (default) continues to use LLM personalization"
  artifacts:
    - path: "app/api/cron/process-campaign-touches/route.ts"
      provides: "personalization_enabled check before LLM call"
      contains: "personalization_enabled"
  key_links:
    - from: "app/api/cron/process-campaign-touches/route.ts"
      to: "campaigns.personalization_enabled"
      via: "campaign lookup or ClaimedCampaignTouch field"
      pattern: "personalization_enabled"
---

<objective>
Fix the campaign personalization toggle defect: the `personalization_enabled` column on campaigns is saved to the database but never consulted by the cron processor during sends. Toggling personalization off currently has no effect.

Purpose: Close functional defect found in Phase 25 verification. The toggle UI and DB column exist but the cron processor always calls `personalizeWithFallback()` regardless.

Output: Cron processor checks `personalization_enabled` before attempting LLM personalization. When false, skips LLM entirely and uses raw template.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@lib/ai/fallback.ts
@app/api/cron/process-campaign-touches/route.ts
@lib/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add personalization_enabled to ClaimedCampaignTouch and cron check</name>
  <files>
    app/api/cron/process-campaign-touches/route.ts
    lib/types/database.ts
  </files>
  <action>
Two changes needed to wire the toggle:

**1. Update ClaimedCampaignTouch type** in `lib/types/database.ts`:

Add `personalization_enabled` field to the `ClaimedCampaignTouch` interface:

```typescript
export interface ClaimedCampaignTouch {
  enrollment_id: string
  business_id: string
  campaign_id: string
  job_id: string
  customer_id: string
  touch_number: number
  channel: MessageChannel
  template_id: string | null
  scheduled_at: string
  personalization_enabled: boolean  // Campaign-level AI toggle
}
```

Note: The `claim_due_campaign_touches()` RPC joins campaigns and already has access to this column. Check the RPC function definition - if it doesn't already return `personalization_enabled`, the cron processor should fetch it separately. Since the RPC returns from `campaign_enrollments` joined with `campaign_touches`, it may NOT include the campaign's `personalization_enabled` flag. In that case, DO NOT modify the RPC. Instead, fetch the campaign's `personalization_enabled` flag in the cron processor's per-touch loop by querying the campaigns table.

Two approaches (choose the simpler one):

**Approach A (preferred - no RPC change):** In the cron processor, after the existing `Promise.all` that fetches business/customer/job, add a query for the campaign:
```typescript
const { data: campaign } = await supabase
  .from('campaigns')
  .select('personalization_enabled')
  .eq('id', touch.campaign_id)
  .single()
```

Then pass `campaign?.personalization_enabled !== false` to `sendEmailTouch`.

**Approach B:** If the RPC already includes the field, just use `touch.personalization_enabled`.

**2. Guard the LLM call in `sendEmailTouch`** in `app/api/cron/process-campaign-touches/route.ts`:

Add a `personalizationEnabled` parameter to the `sendEmailTouch` function signature. Then wrap the LLM personalization block (the `if (templateBody)` block around line 242) in a check:

```typescript
if (templateBody && personalizationEnabled) {
  // existing personalizeWithFallback call
} else if (templateBody && !personalizationEnabled) {
  console.log(`Personalization disabled for campaign ${touch.campaign_id}, using raw template`)
}
```

When `personalizationEnabled` is false:
- `wasPersonalized` stays `false`
- `personalizedBody` stays empty string
- The function proceeds to send the raw template (existing behavior when personalization fails)

This is the minimal change. Do NOT restructure the rest of the function.
  </action>
  <verify>
    Run `pnpm typecheck` to confirm ClaimedCampaignTouch type is consistent and the cron route compiles. Grep for `personalization_enabled` in route.ts to confirm the check exists.
  </verify>
  <done>
    - personalization_enabled=false campaigns skip LLM call entirely and send raw template
    - personalization_enabled=true campaigns (default) continue using LLM personalization
    - No behavioral change for existing campaigns (all default to true)
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. Grep confirms `personalization_enabled` is checked before `personalizeWithFallback()` in route.ts
4. The raw template send path still works when personalization is disabled
</verification>

<success_criteria>
- Campaign personalization toggle is functional: OFF = raw template, ON = LLM personalization
- No regression in default behavior (all campaigns default to personalization_enabled=true)
- TypeScript and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/25-llm-personalization/25-08-SUMMARY.md`
</output>
