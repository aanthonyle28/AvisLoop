---
phase: 25-llm-personalization
plan: 07
type: execute
wave: 5
depends_on: ["25-05", "25-06"]
files_modified:
  - app/(dashboard)/campaigns/new/page.tsx
  - app/(dashboard)/campaigns/[id]/edit/page.tsx
  - supabase/migrations/00020_add_campaign_personalization.sql
autonomous: true

must_haves:
  truths:
    - "Campaign creation shows personalization preview before launch"
    - "Campaign edit page shows preview for existing templates"
    - "Database supports personalization_enabled flag on campaigns"
  artifacts:
    - path: "app/(dashboard)/campaigns/new/page.tsx"
      provides: "Campaign creation page with preview integration"
    - path: "app/(dashboard)/campaigns/[id]/edit/page.tsx"
      provides: "Campaign edit page with preview integration"
    - path: "supabase/migrations/00020_add_campaign_personalization.sql"
      provides: "Database migration for personalization_enabled column"
  key_links:
    - from: "app/(dashboard)/campaigns/new/page.tsx"
      to: "components/ai/personalization-preview.tsx"
      via: "component import"
      pattern: "import.*PersonalizationPreview.*from.*components/ai"
---

<objective>
Integrate personalization preview into campaign creation/edit flow and add database support for per-campaign personalization toggle.

Purpose: Complete the user experience by showing personalization preview during campaign creation. This is the "Preview at scale" requirement from CONTEXT.md - users see 3-5 sample outputs before launch.

Output: Campaign creation shows preview; database supports personalization toggle.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-llm-personalization/25-CONTEXT.md
@app/(dashboard)/campaigns/new/page.tsx
@components/campaigns/campaign-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for personalization column</name>
  <files>supabase/migrations/00020_add_campaign_personalization.sql</files>
  <action>
Create migration to add personalization_enabled column to campaigns table:

```sql
-- Add personalization_enabled column to campaigns
-- Default TRUE: personalization is on by default for all campaigns
ALTER TABLE campaigns
ADD COLUMN IF NOT EXISTS personalization_enabled BOOLEAN NOT NULL DEFAULT TRUE;

-- Add comment for documentation
COMMENT ON COLUMN campaigns.personalization_enabled IS 'Whether AI personalization is enabled for this campaign. Default TRUE.';

-- No index needed - this is a low-cardinality boolean column
-- Queries filter by business_id first, then check this flag in-memory
```

Note: Check existing migrations to get correct number. If 00020 exists, use next available number.

This migration:
- Adds personalization_enabled boolean column
- Defaults to TRUE (personalization on by default per CONTEXT.md)
- No RLS changes needed (inherits from campaigns table)
  </action>
  <verify>
Migration file exists with ALTER TABLE statement.
Run `pnpm supabase db push` or apply migration locally.
  </verify>
  <done>Database schema supports personalization_enabled flag on campaigns</done>
</task>

<task type="auto">
  <name>Task 2: Integrate preview into campaign creation page</name>
  <files>app/(dashboard)/campaigns/new/page.tsx</files>
  <action>
Read the existing campaign creation page and integrate personalization preview.

The page should show preview step after template selection:

```tsx
// Add imports
import { PersonalizationPreview } from '@/components/ai/personalization-preview'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'

// In the campaign creation flow, add preview section:
// This could be:
// 1. A separate step in a wizard
// 2. A tab alongside campaign configuration
// 3. A collapsible section below the form

// Option: Tab-based approach
<Tabs defaultValue="configure" className="mt-6">
  <TabsList>
    <TabsTrigger value="configure">Configure</TabsTrigger>
    <TabsTrigger value="preview">Preview Messages</TabsTrigger>
  </TabsList>

  <TabsContent value="configure" className="space-y-6">
    {/* Existing campaign form content */}
    <CampaignForm ... />
  </TabsContent>

  <TabsContent value="preview" className="space-y-6">
    {/* Preview section */}
    {selectedTemplate ? (
      <PersonalizationPreview
        templateBody={selectedTemplate.body}
        templateSubject={selectedTemplate.subject}
        channel={selectedChannel}
        serviceType={selectedServiceType}
      />
    ) : (
      <div className="rounded-md border border-dashed p-8 text-center text-muted-foreground">
        Select a template to preview personalization
      </div>
    )}

    {/* Preview guidance */}
    <div className="rounded-md bg-muted/50 p-4 text-sm">
      <p className="font-medium mb-2">About Personalization</p>
      <ul className="list-disc list-inside space-y-1 text-muted-foreground">
        <li>Each message is automatically customized for the customer</li>
        <li>Reviews links and opt-out language are always preserved</li>
        <li>If personalization fails, the exact template is used</li>
      </ul>
    </div>
  </TabsContent>
</Tabs>
```

Design decisions from CONTEXT.md:
- "MVP: Campaign creation preview (3-5 samples with real customer data)"
- Preview uses real customer data for trust-building
- Guidance text explains what personalization does
  </action>
  <verify>
TypeScript compiles: `pnpm typecheck` passes.
Campaign creation page includes preview tab/section.
  </verify>
  <done>Campaign creation page shows personalization preview before launch</done>
</task>

<task type="auto">
  <name>Task 3: Integrate preview into campaign edit page</name>
  <files>app/(dashboard)/campaigns/[id]/edit/page.tsx</files>
  <action>
Read the existing campaign edit page and add similar preview integration.

The edit page should show preview for the campaign's current template configuration:

```tsx
// Add imports
import { PersonalizationPreview } from '@/components/ai/personalization-preview'

// In the edit page, add preview section after form:
// Show preview based on current campaign template

<div className="mt-8 space-y-4">
  <div className="flex items-center justify-between">
    <h3 className="font-medium">Message Preview</h3>
    <p className="text-sm text-muted-foreground">
      See how messages will appear to customers
    </p>
  </div>

  {campaign.campaign_touches?.length > 0 && (
    <Tabs defaultValue={`touch-1`}>
      <TabsList>
        {campaign.campaign_touches.map((touch) => (
          <TabsTrigger key={touch.id} value={`touch-${touch.touch_number}`}>
            Touch {touch.touch_number}
          </TabsTrigger>
        ))}
      </TabsList>

      {campaign.campaign_touches.map((touch) => (
        <TabsContent key={touch.id} value={`touch-${touch.touch_number}`}>
          {touch.template_id ? (
            <PersonalizationPreview
              templateBody={templates.find(t => t.id === touch.template_id)?.body || ''}
              templateSubject={templates.find(t => t.id === touch.template_id)?.subject}
              channel={touch.channel}
              serviceType={campaign.service_type || undefined}
            />
          ) : (
            <div className="rounded-md border border-dashed p-8 text-center text-muted-foreground">
              No template selected for this touch
            </div>
          )}
        </TabsContent>
      ))}
    </Tabs>
  )}
</div>
```

Note: This requires fetching templates data to get template body/subject for preview. Add to page's data fetching.

Design from CONTEXT.md:
- "Multi-Touch Preview: Full sequence view - show all touches for one sample customer"
- Navigation via tabs for each touch
  </action>
  <verify>
TypeScript compiles: `pnpm typecheck` passes.
Campaign edit page includes preview for each touch.
  </verify>
  <done>Campaign edit page shows preview for existing campaign templates</done>
</task>

</tasks>

<verification>
All verification commands should pass:

```bash
pnpm typecheck
pnpm lint
```

Check integration:
- Migration file exists
- Campaign new page has preview tab/section
- Campaign edit page has preview per touch
</verification>

<success_criteria>
- Database has personalization_enabled column on campaigns (default TRUE)
- Campaign creation page shows PersonalizationPreview component
- Campaign edit page shows preview for each touch's template
- Preview shows 3-5 customer samples with regenerate option
- All code typechecks and lints clean
</success_criteria>

<output>
After completion, create `.planning/phases/25-llm-personalization/25-07-SUMMARY.md`
</output>
