---
phase: 25-llm-personalization
plan: 05
type: execute
wave: 4
depends_on: ["25-04"]
files_modified:
  - components/ai/personalization-preview.tsx
  - components/ai/preview-sample-card.tsx
  - components/ai/preview-diff.tsx
autonomous: true

must_haves:
  truths:
    - "User can see personalized message samples before campaign launch"
    - "Preview shows original vs personalized with diff highlighting"
    - "User can regenerate individual samples"
    - "Fallback cases are clearly indicated (not hidden)"
  artifacts:
    - path: "components/ai/personalization-preview.tsx"
      provides: "Main preview container with sample list"
      exports: ["PersonalizationPreview"]
    - path: "components/ai/preview-sample-card.tsx"
      provides: "Individual sample card with regenerate action"
      exports: ["PreviewSampleCard"]
    - path: "components/ai/preview-diff.tsx"
      provides: "Diff view comparing original and personalized"
      exports: ["PreviewDiff"]
  key_links:
    - from: "components/ai/personalization-preview.tsx"
      to: "lib/actions/personalize.ts"
      via: "server action import"
      pattern: "import.*personalizePreviewBatchAction.*from.*actions/personalize"
---

<objective>
Create preview components for personalization samples with diff view.

Purpose: Users need to see what personalization will do before launching campaigns. Preview builds trust by showing real samples with actual customer data. Diff view helps users understand what was changed.

Output: components/ai/ module with preview components ready for integration into campaign creation flow.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-llm-personalization/25-CONTEXT.md
@components/ui/button.tsx
@components/ui/card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create diff view component</name>
  <files>components/ai/preview-diff.tsx</files>
  <action>
Create `components/ai/preview-diff.tsx` for showing original vs personalized:

```tsx
'use client'

import { useState } from 'react'
import { cn } from '@/lib/utils'

interface PreviewDiffProps {
  original: string
  personalized: string
  showDiff?: boolean
  className?: string
}

/**
 * Preview diff component.
 * Shows personalized text with optional diff highlighting.
 *
 * Design from CONTEXT.md:
 * - "Friendly highlights, not developer-style red/green"
 * - First-time users: diff visible by default
 * - Returning users: clean view (handled by parent)
 */
export function PreviewDiff({
  original,
  personalized,
  showDiff = false,
  className,
}: PreviewDiffProps) {
  if (!showDiff) {
    // Clean view - just show personalized
    return (
      <div className={cn('whitespace-pre-wrap text-sm', className)}>
        {personalized}
      </div>
    )
  }

  // Diff view - highlight changes
  // Simple word-level diff for readability
  const originalWords = original.split(/\s+/)
  const personalizedWords = personalized.split(/\s+/)

  // Find common words to avoid highlighting everything
  const commonWords = new Set(
    originalWords.filter(w => personalizedWords.includes(w))
  )

  return (
    <div className={cn('space-y-3', className)}>
      {/* Original (collapsed by default) */}
      <details className="group">
        <summary className="cursor-pointer text-xs text-muted-foreground hover:text-foreground">
          See original template
        </summary>
        <div className="mt-2 rounded-md bg-muted/50 p-3 text-sm text-muted-foreground">
          {original}
        </div>
      </details>

      {/* Personalized with highlights */}
      <div className="whitespace-pre-wrap text-sm">
        {personalizedWords.map((word, i) => {
          const isNew = !commonWords.has(word)
          return (
            <span key={i}>
              {i > 0 && ' '}
              <span
                className={cn(
                  isNew && 'bg-primary/10 text-primary rounded px-0.5'
                )}
              >
                {word}
              </span>
            </span>
          )
        })}
      </div>

      {/* What was personalized summary */}
      <div className="flex items-center gap-2 text-xs text-muted-foreground">
        <span className="inline-block h-2 w-2 rounded-full bg-primary/50" />
        <span>Highlighted text was personalized</span>
      </div>
    </div>
  )
}
```

Design decisions from CONTEXT.md:
- "Friendly highlights, not developer-style red/green"
- Primary color background for new words (subtle)
- Collapsible original template
- Simple word-level diff (not character-level)
  </action>
  <verify>
TypeScript compiles: `pnpm typecheck` passes.
File exports PreviewDiff component.
  </verify>
  <done>Diff view shows personalized text with friendly highlighting of changes</done>
</task>

<task type="auto">
  <name>Task 2: Create sample card component</name>
  <files>components/ai/preview-sample-card.tsx</files>
  <action>
Create `components/ai/preview-sample-card.tsx` for individual preview samples:

```tsx
'use client'

import { useState, useTransition } from 'react'
import { ArrowsClockwise, CheckCircle, Warning } from '@phosphor-icons/react'
import { Card, CardContent, CardHeader } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'
import { PreviewDiff } from './preview-diff'

interface PreviewSampleCardProps {
  customerId: string
  customerName: string
  original: string
  personalized: string
  subject?: string
  wasPersonalized: boolean
  fallbackReason?: string
  isRepeatCustomer?: boolean
  showDiff: boolean
  onRegenerate?: (customerId: string) => Promise<void>
  className?: string
}

/**
 * Preview sample card.
 * Shows one personalized message sample with context.
 *
 * Design from CONTEXT.md:
 * - Label samples with context ("Sample 1 â€“ Complete data (repeat customer)")
 * - Regenerate single sample action
 * - Fallback cases clearly indicated
 */
export function PreviewSampleCard({
  customerId,
  customerName,
  original,
  personalized,
  subject,
  wasPersonalized,
  fallbackReason,
  isRepeatCustomer = false,
  showDiff,
  onRegenerate,
  className,
}: PreviewSampleCardProps) {
  const [isPending, startTransition] = useTransition()

  const handleRegenerate = () => {
    if (onRegenerate) {
      startTransition(async () => {
        await onRegenerate(customerId)
      })
    }
  }

  // Build context label
  const contextLabel = isRepeatCustomer
    ? 'Repeat customer'
    : 'New customer'

  return (
    <Card className={cn('relative', className)}>
      <CardHeader className="pb-2">
        <div className="flex items-start justify-between">
          <div>
            <div className="font-medium">{customerName}</div>
            <div className="text-xs text-muted-foreground">{contextLabel}</div>
          </div>

          <div className="flex items-center gap-2">
            {/* Status indicator */}
            {wasPersonalized ? (
              <span className="flex items-center gap-1 text-xs text-green-600 dark:text-green-400">
                <CheckCircle weight="fill" className="h-3.5 w-3.5" />
                Personalized
              </span>
            ) : (
              <span className="flex items-center gap-1 text-xs text-amber-600 dark:text-amber-400">
                <Warning weight="fill" className="h-3.5 w-3.5" />
                Template used
              </span>
            )}

            {/* Regenerate button */}
            {onRegenerate && (
              <Button
                variant="ghost"
                size="sm"
                onClick={handleRegenerate}
                disabled={isPending}
                className="h-7 px-2"
              >
                <ArrowsClockwise
                  className={cn('h-3.5 w-3.5', isPending && 'animate-spin')}
                />
                <span className="sr-only">Regenerate</span>
              </Button>
            )}
          </div>
        </div>
      </CardHeader>

      <CardContent className="space-y-3">
        {/* Subject (email only) */}
        {subject && (
          <div className="rounded-md bg-muted/50 px-3 py-2">
            <div className="text-xs font-medium text-muted-foreground">Subject</div>
            <div className="text-sm">{subject}</div>
          </div>
        )}

        {/* Message body */}
        <div className="rounded-md border p-3">
          <PreviewDiff
            original={original}
            personalized={personalized}
            showDiff={showDiff && wasPersonalized}
          />
        </div>

        {/* Fallback reason if not personalized */}
        {!wasPersonalized && fallbackReason && (
          <div className="rounded-md bg-amber-50 dark:bg-amber-950/20 px-3 py-2 text-xs text-amber-700 dark:text-amber-300">
            <span className="font-medium">Using template: </span>
            {getFallbackReasonText(fallbackReason)}
          </div>
        )}
      </CardContent>
    </Card>
  )
}

/**
 * Human-readable fallback reason text.
 */
function getFallbackReasonText(reason: string): string {
  switch (reason) {
    case 'rate_limited':
      return 'Rate limit reached for this hour'
    case 'timeout':
      return 'Personalization took too long'
    case 'validation_failed':
      return 'Generated message didn\'t pass quality checks'
    case 'api_error':
      return 'AI service temporarily unavailable'
    case 'retry_exhausted':
      return 'Multiple attempts failed'
    case 'missing_critical_field':
      return 'Missing required customer data'
    default:
      return 'Using standard template'
  }
}
```

Design decisions from CONTEXT.md:
- Label samples with context (repeat/new customer)
- Regenerate button per sample
- Fallback cases clearly indicated (not hidden)
- Amber color for template fallback (not red - not an error)
  </action>
  <verify>
TypeScript compiles: `pnpm typecheck` passes.
File exports PreviewSampleCard component.
  </verify>
  <done>Sample card shows personalized message with context, status, and regenerate action</done>
</task>

<task type="auto">
  <name>Task 3: Create main preview container</name>
  <files>components/ai/personalization-preview.tsx</files>
  <action>
Create `components/ai/personalization-preview.tsx` as the main preview component:

```tsx
'use client'

import { useState, useTransition, useCallback } from 'react'
import { ArrowsClockwise, Eye, EyeSlash } from '@phosphor-icons/react'
import { Button } from '@/components/ui/button'
import { Switch } from '@/components/ui/switch'
import { Label } from '@/components/ui/label'
import { cn } from '@/lib/utils'
import { PreviewSampleCard } from './preview-sample-card'
import {
  personalizePreviewBatchAction,
  personalizePreview,
} from '@/lib/actions/personalize'

interface PreviewSample {
  customerId: string
  customerName: string
  original: string
  personalized: string
  subject?: string
  wasPersonalized: boolean
  fallbackReason?: string
}

interface PersonalizationPreviewProps {
  templateBody: string
  templateSubject?: string
  channel: 'email' | 'sms'
  serviceType?: string
  className?: string
}

/**
 * Main personalization preview component.
 * Shows batch of personalized samples with diff view toggle.
 *
 * Design from CONTEXT.md:
 * - Default 3 curated samples, expandable to 5
 * - Regenerate all samples
 * - Diff toggle with smart defaults
 * - First-time users: diff visible by default
 */
export function PersonalizationPreview({
  templateBody,
  templateSubject,
  channel,
  serviceType,
  className,
}: PersonalizationPreviewProps) {
  const [samples, setSamples] = useState<PreviewSample[]>([])
  const [showDiff, setShowDiff] = useState(true)  // Default on for first-time
  const [sampleCount, setSampleCount] = useState(3)
  const [isPending, startTransition] = useTransition()
  const [error, setError] = useState<string | null>(null)

  // Load initial samples
  const loadSamples = useCallback(async () => {
    startTransition(async () => {
      setError(null)

      const result = await personalizePreviewBatchAction({
        templateBody,
        templateSubject,
        channel,
        serviceType,
        sampleCount,
      })

      if (result.error) {
        setError(result.error)
        return
      }

      if (result.data) {
        setSamples(result.data)
      }
    })
  }, [templateBody, templateSubject, channel, serviceType, sampleCount])

  // Regenerate all samples
  const handleRegenerateAll = () => {
    loadSamples()
  }

  // Regenerate single sample
  const handleRegenerateSingle = async (customerId: string) => {
    const sample = samples.find(s => s.customerId === customerId)
    if (!sample) return

    const result = await personalizePreview({
      templateBody,
      templateSubject,
      customerId,
      channel,
      serviceType,
    })

    if (result.success && result.data) {
      setSamples(prev =>
        prev.map(s =>
          s.customerId === customerId
            ? {
                ...s,
                personalized: result.data!.personalized,
                subject: result.data!.subject,
                wasPersonalized: result.data!.wasPersonalized,
                fallbackReason: result.data!.fallbackReason,
              }
            : s
        )
      )
    }
  }

  // Show more samples
  const handleShowMore = () => {
    setSampleCount(5)
    loadSamples()
  }

  // Stats
  const personalizedCount = samples.filter(s => s.wasPersonalized).length
  const totalCount = samples.length

  return (
    <div className={cn('space-y-4', className)}>
      {/* Header with controls */}
      <div className="flex items-center justify-between">
        <div>
          <h3 className="font-medium">Preview Personalization</h3>
          {totalCount > 0 && (
            <p className="text-sm text-muted-foreground">
              {personalizedCount} of {totalCount} samples personalized
            </p>
          )}
        </div>

        <div className="flex items-center gap-4">
          {/* Diff toggle */}
          <div className="flex items-center gap-2">
            <Switch
              id="show-diff"
              checked={showDiff}
              onCheckedChange={setShowDiff}
            />
            <Label htmlFor="show-diff" className="text-sm cursor-pointer">
              {showDiff ? (
                <span className="flex items-center gap-1">
                  <Eye className="h-3.5 w-3.5" />
                  Show changes
                </span>
              ) : (
                <span className="flex items-center gap-1">
                  <EyeSlash className="h-3.5 w-3.5" />
                  Clean view
                </span>
              )}
            </Label>
          </div>

          {/* Regenerate all */}
          <Button
            variant="outline"
            size="sm"
            onClick={handleRegenerateAll}
            disabled={isPending}
          >
            <ArrowsClockwise
              className={cn('h-4 w-4 mr-1', isPending && 'animate-spin')}
            />
            {samples.length === 0 ? 'Generate Preview' : 'Regenerate All'}
          </Button>
        </div>
      </div>

      {/* Error state */}
      {error && (
        <div className="rounded-md bg-destructive/10 px-4 py-3 text-sm text-destructive">
          {error}
        </div>
      )}

      {/* Empty state */}
      {samples.length === 0 && !isPending && !error && (
        <div className="rounded-md border border-dashed p-8 text-center">
          <p className="text-muted-foreground">
            Click &quot;Generate Preview&quot; to see personalized samples
          </p>
        </div>
      )}

      {/* Loading state */}
      {isPending && samples.length === 0 && (
        <div className="space-y-4">
          {[1, 2, 3].map(i => (
            <div
              key={i}
              className="h-32 rounded-md bg-muted/50 animate-pulse"
            />
          ))}
        </div>
      )}

      {/* Sample cards */}
      {samples.length > 0 && (
        <div className="space-y-4">
          {samples.map((sample, index) => (
            <PreviewSampleCard
              key={sample.customerId}
              {...sample}
              showDiff={showDiff}
              onRegenerate={handleRegenerateSingle}
            />
          ))}

          {/* Show more button */}
          {sampleCount < 5 && (
            <Button
              variant="ghost"
              size="sm"
              onClick={handleShowMore}
              disabled={isPending}
              className="w-full"
            >
              Show more samples
            </Button>
          )}
        </div>
      )}
    </div>
  )
}
```

Design decisions from CONTEXT.md:
- Default 3 samples, expandable to 5
- Regenerate all + regenerate single actions
- Diff toggle with "Show changes" / "Clean view" labels
- First-time users: diff on by default
- Stats showing personalization success rate
  </action>
  <verify>
TypeScript compiles: `pnpm typecheck` passes.
File exports PersonalizationPreview component.
  </verify>
  <done>Main preview container shows batch of samples with controls for diff view and regeneration</done>
</task>

</tasks>

<verification>
All verification commands should pass:

```bash
pnpm typecheck
pnpm lint
```

Check components/ai/ directory:
- components/ai/preview-diff.tsx exists
- components/ai/preview-sample-card.tsx exists
- components/ai/personalization-preview.tsx exists
</verification>

<success_criteria>
- PersonalizationPreview shows 3-5 sample messages
- PreviewSampleCard displays personalized vs original with context
- PreviewDiff highlights changes with friendly styling
- Fallback cases shown with amber indicator (not error state)
- Regenerate works for all samples and individual samples
- All components typecheck and lint clean
</success_criteria>

<output>
After completion, create `.planning/phases/25-llm-personalization/25-05-SUMMARY.md`
</output>
