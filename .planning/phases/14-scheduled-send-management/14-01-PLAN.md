---
phase: 14-scheduled-send-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/actions/schedule.ts
  - lib/data/scheduled.ts
  - lib/types/database.ts
  - components/ui/tabs.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Bulk cancel server action cancels multiple pending sends in one call"
    - "Bulk reschedule server action updates scheduled_for on multiple pending sends"
    - "Data layer returns send_log details (contact name, email, status, error) for completed sends"
    - "Tabs UI component exists for use in scheduled table"
  artifacts:
    - path: "lib/actions/schedule.ts"
      provides: "bulkCancelScheduledSends, bulkRescheduleScheduledSends"
      exports: ["bulkCancelScheduledSends", "bulkRescheduleScheduledSends"]
    - path: "lib/data/scheduled.ts"
      provides: "getScheduledSendsWithDetails returning send_log joins"
      exports: ["getScheduledSendsWithDetails"]
    - path: "lib/types/database.ts"
      provides: "ScheduledSendWithDetails type"
      contains: "ScheduledSendWithDetails"
    - path: "components/ui/tabs.tsx"
      provides: "Radix Tabs wrapper components"
      exports: ["Tabs", "TabsList", "TabsTrigger", "TabsContent"]
  key_links:
    - from: "lib/actions/schedule.ts"
      to: "supabase.from('scheduled_sends')"
      via: ".in('id', ids) filter for bulk operations"
      pattern: "\\.in\\('id'"
    - from: "lib/data/scheduled.ts"
      to: "supabase.from('send_logs')"
      via: ".in('id', send.send_log_ids) for per-contact results"
      pattern: "send_log_ids"
---

<objective>
Add backend infrastructure for Phase 14: bulk server actions (cancel/reschedule), enhanced data layer with send_log details, and Tabs UI component.

Purpose: Provide the server-side operations and UI primitives needed by the scheduled table rewrite in Plan 02.
Output: Two new bulk server actions, an enhanced data fetcher with per-contact results, a ScheduledSendWithDetails type, and a Radix Tabs UI component.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-scheduled-send-management/14-CONTEXT.md
@.planning/phases/14-scheduled-send-management/14-RESEARCH.md

@lib/actions/schedule.ts
@lib/data/scheduled.ts
@lib/types/database.ts
@components/ui/dialog.tsx
@components/send/schedule-selector.tsx
@lib/utils/schedule.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Radix Tabs and create Tabs UI component</name>
  <files>
    package.json
    components/ui/tabs.tsx
  </files>
  <action>
    1. Install @radix-ui/react-tabs:
       ```
       pnpm add @radix-ui/react-tabs
       ```

    2. Create `components/ui/tabs.tsx` following the existing shadcn/ui pattern used in dialog.tsx:
       - Import from `@radix-ui/react-tabs`
       - Export: `Tabs` (Root), `TabsList`, `TabsTrigger`, `TabsContent`
       - TabsList: `inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground`
       - TabsTrigger: `inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm`
       - TabsContent: `mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2`
       - Use `cn()` for className merging, `React.forwardRef` for all components
       - Add displayName for each component
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `components/ui/tabs.tsx` exports Tabs, TabsList, TabsTrigger, TabsContent
    - `@radix-ui/react-tabs` is in package.json dependencies
  </verify>
  <done>Radix Tabs installed and Tabs UI component exists with all four exports, typecheck passes</done>
</task>

<task type="auto">
  <name>Task 2: Add bulk server actions and enhanced data layer</name>
  <files>
    lib/actions/schedule.ts
    lib/data/scheduled.ts
    lib/types/database.ts
  </files>
  <action>
    1. Add `ScheduledSendWithDetails` type to `lib/types/database.ts`:
       ```typescript
       export interface SendLogDetail {
         id: string
         contact_id: string
         status: string
         error_message: string | null
         contacts: { name: string; email: string }
       }

       export interface ScheduledSendWithDetails extends ScheduledSend {
         sendLogs: SendLogDetail[]
       }
       ```

    2. Add `bulkCancelScheduledSends` to `lib/actions/schedule.ts`:
       - Accept `ids: string[]` parameter
       - Authenticate user, get business_id
       - Use `supabase.from('scheduled_sends').update({ status: 'cancelled' }).in('id', ids).eq('business_id', business.id).eq('status', 'pending').select('id')`
       - Return `{ error?: string; success?: boolean; count?: number }`
       - Call `revalidatePath('/scheduled')` on success
       - Validate ids array: at least 1, max 50

    3. Add `bulkRescheduleScheduledSends` to `lib/actions/schedule.ts`:
       - Accept `ids: string[]` and `newScheduledFor: string` parameters
       - Validate newScheduledFor is at least 1 minute in future
       - Authenticate user, get business_id
       - Use `supabase.from('scheduled_sends').update({ scheduled_for: newScheduledFor }).in('id', ids).eq('business_id', business.id).eq('status', 'pending').select('id')`
       - Return `{ error?: string; success?: boolean; count?: number }`
       - Call `revalidatePath('/scheduled')` on success
       - Validate ids array: at least 1, max 50

    4. Add `getScheduledSendsWithDetails` to `lib/data/scheduled.ts`:
       - Authenticate user, get business_id
       - Fetch all scheduled_sends for business (ordered by scheduled_for ascending)
       - For sends with status 'completed' and non-empty send_log_ids array, fetch send_logs:
         `supabase.from('send_logs').select('id, contact_id, status, error_message, contacts(name, email)').in('id', send.send_log_ids).eq('business_id', business.id)`
       - Use `Promise.all` to fetch send_logs in parallel for all completed sends
       - Return `ScheduledSendWithDetails[]` (sends with empty sendLogs for non-completed)
       - Import ScheduledSendWithDetails from types

    Important: Keep the existing `getScheduledSends`, `cancelScheduledSend`, `scheduleReviewRequest` functions unchanged. Add new functions alongside them.
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `lib/actions/schedule.ts` exports bulkCancelScheduledSends and bulkRescheduleScheduledSends
    - `lib/data/scheduled.ts` exports getScheduledSendsWithDetails
    - `lib/types/database.ts` contains ScheduledSendWithDetails interface
  </verify>
  <done>Both bulk server actions accept arrays of IDs and return count of affected rows. Data layer fetches per-contact send_log results for completed sends. All functions properly authenticate, scope to business_id, and revalidate paths.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with no new errors
2. `pnpm lint` passes
3. All existing functions in schedule.ts unchanged (no regressions)
4. New exports available: bulkCancelScheduledSends, bulkRescheduleScheduledSends, getScheduledSendsWithDetails, ScheduledSendWithDetails, Tabs/TabsList/TabsTrigger/TabsContent
</verification>

<success_criteria>
- Bulk cancel accepts array of IDs, cancels only pending sends scoped to business, returns count
- Bulk reschedule accepts array of IDs + new date, validates future date, updates only pending sends scoped to business, returns count
- Data layer returns send_logs with contact name/email/status for completed scheduled sends
- Tabs UI component wraps Radix Tabs with shadcn/ui styling patterns
- All typecheck and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-scheduled-send-management/14-01-SUMMARY.md`
</output>
