---
phase: 14-scheduled-send-management
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - components/scheduled/scheduled-table.tsx
  - components/scheduled/cancel-button.tsx
  - components/scheduled/expanded-details.tsx
  - components/scheduled/bulk-action-bar.tsx
  - components/scheduled/cancel-dialog.tsx
  - components/scheduled/reschedule-dialog.tsx
  - app/(dashboard)/scheduled/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees Pending and Past tabs with correct sends in each"
    - "User can click a row to expand inline details showing per-contact results and message preview"
    - "Completed sends show inline summary counts (sent/skipped/failed) in the list row"
    - "User can select rows via checkboxes including shift-click range selection"
    - "Floating action bar appears at bottom when rows are selected, showing count + Reschedule/Cancel buttons"
    - "Cancel confirmation uses styled dialog (not native confirm)"
    - "Reschedule dialog reuses ScheduleSelector component and shows confirmation"
    - "Bulk cancel and reschedule call server actions and clear selection on success"
  artifacts:
    - path: "components/scheduled/scheduled-table.tsx"
      provides: "Tabbed table with expandable rows, checkboxes, shift-click selection"
      min_lines: 100
    - path: "components/scheduled/expanded-details.tsx"
      provides: "Expanded row detail view with per-contact results and subject preview"
      exports: ["ExpandedDetails"]
    - path: "components/scheduled/bulk-action-bar.tsx"
      provides: "Floating action bar (Gmail-style) with selection count and action buttons"
      exports: ["BulkActionBar"]
    - path: "components/scheduled/cancel-dialog.tsx"
      provides: "Styled cancel confirmation dialog"
      exports: ["CancelDialog"]
    - path: "components/scheduled/reschedule-dialog.tsx"
      provides: "Reschedule dialog with ScheduleSelector and confirmation"
      exports: ["RescheduleDialog"]
    - path: "app/(dashboard)/scheduled/page.tsx"
      provides: "Server component calling getScheduledSendsWithDetails"
  key_links:
    - from: "components/scheduled/scheduled-table.tsx"
      to: "components/ui/tabs.tsx"
      via: "Tabs/TabsList/TabsTrigger/TabsContent imports"
      pattern: "from.*components/ui/tabs"
    - from: "components/scheduled/scheduled-table.tsx"
      to: "components/scheduled/bulk-action-bar.tsx"
      via: "BulkActionBar rendered when selection count > 0"
      pattern: "BulkActionBar"
    - from: "components/scheduled/reschedule-dialog.tsx"
      to: "components/send/schedule-selector.tsx"
      via: "ScheduleSelector import for date/time picking"
      pattern: "ScheduleSelector"
    - from: "app/(dashboard)/scheduled/page.tsx"
      to: "lib/data/scheduled.ts"
      via: "getScheduledSendsWithDetails call"
      pattern: "getScheduledSendsWithDetails"
    - from: "components/scheduled/scheduled-table.tsx"
      to: "lib/actions/schedule.ts"
      via: "bulkCancelScheduledSends and bulkRescheduleScheduledSends calls"
      pattern: "bulk(Cancel|Reschedule)ScheduledSends"
---

<objective>
Rewrite the /scheduled page with tabbed interface, expandable rows, bulk selection with shift-click, floating action bar, and styled confirmation dialogs for cancel and reschedule operations.

Purpose: Deliver the complete Phase 14 user experience -- managing scheduled sends with rich detail views and bulk operations.
Output: Fully functional scheduled send management page with Pending/Past tabs, expandable per-contact results, checkbox selection, floating action bar, and styled dialogs.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-scheduled-send-management/14-CONTEXT.md
@.planning/phases/14-scheduled-send-management/14-RESEARCH.md
@.planning/phases/14-scheduled-send-management/14-01-SUMMARY.md

@components/scheduled/scheduled-table.tsx
@components/scheduled/cancel-button.tsx
@app/(dashboard)/scheduled/page.tsx
@components/send/schedule-selector.tsx
@components/ui/dialog.tsx
@components/ui/tabs.tsx
@components/ui/checkbox.tsx
@components/ui/badge.tsx
@lib/types/database.ts
@lib/actions/schedule.ts
@lib/data/scheduled.ts
@lib/utils/schedule.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create expanded details, dialogs, and floating action bar components</name>
  <files>
    components/scheduled/expanded-details.tsx
    components/scheduled/bulk-action-bar.tsx
    components/scheduled/cancel-dialog.tsx
    components/scheduled/reschedule-dialog.tsx
  </files>
  <action>
    Create four new client components:

    1. **`components/scheduled/expanded-details.tsx`** — Expanded row detail view:
       - Props: `{ scheduledSend: ScheduledSendWithDetails }`
       - Show email subject preview if `custom_subject` exists
       - For completed sends: show results summary counts (sent/failed/skipped using semantic status colors from Phase 15 design system -- green for sent, red for failed, orange for skipped)
       - Show per-contact breakdown table: contact name, email, status badge, error_message if present
       - For pending sends: show "Scheduled for [date]" and contact count
       - Use `bg-muted/50 rounded-md p-4` container styling
       - Import Phosphor icons (not Lucide) for any icons needed
       - Calculate "skipped" as `contact_ids.length - sendLogs.length` (contacts that had no send_log due to cooldown/opt-out/archive skip)

    2. **`components/scheduled/cancel-dialog.tsx`** — Styled cancel confirmation:
       - Props: `{ open, onOpenChange, selectedCount, onConfirm, isPending }`
       - Use existing Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter from `@/components/ui/dialog`
       - Title: "Cancel N scheduled send(s)?"
       - Description: "This action cannot be undone. These scheduled sends will be cancelled and will not be processed."
       - Two buttons: "Keep Scheduled" (outline) and "Cancel N Send(s)" (destructive)
       - Disable confirm button while isPending, show spinner

    3. **`components/scheduled/reschedule-dialog.tsx`** — Reschedule picker + confirmation:
       - Props: `{ open, onOpenChange, selectedCount, onConfirm, isPending }`
       - Use Dialog components from `@/components/ui/dialog`
       - Title: "Reschedule N send(s)"
       - Description: "All selected sends will be rescheduled to the same new date and time."
       - Embed `ScheduleSelector` from `@/components/send/schedule-selector` for date/time picking
       - Show formatted new time when selected: "New scheduled time: **[formatted date]**"
       - Filter out the "Send now" preset -- only show future schedule options (In 1 hour, Next morning, In 24 hours, Custom). Do this by wrapping ScheduleSelector or by passing a filtered preset list if the component supports it. If not, create a wrapper that hides the "now" option via CSS or conditionally renders a modified version.
       - Two buttons: "Cancel" (outline) and "Reschedule N Send(s)" (primary, disabled until date selected)
       - Disable confirm button while isPending, show spinner
       - Reset scheduledFor state when dialog closes

    4. **`components/scheduled/bulk-action-bar.tsx`** — Floating action bar:
       - Props: `{ selectedCount, onReschedule, onCancel, onClearSelection }`
       - Only render when `selectedCount > 0`
       - Fixed position at bottom center of screen: `fixed bottom-6 left-1/2 -translate-x-1/2 z-50`
       - Animate in from bottom using Tailwind: `animate-in slide-in-from-bottom-5` (if available) or manual transition
       - Content: rounded-lg container with border and bg-background
       - Layout: "N selected" text | vertical separator | "Reschedule" button (outline) | "Cancel" button (destructive) | "Clear" button (ghost)
       - Use Button component from `@/components/ui/button` for action buttons (size="sm")
       - Follow Phase 15 border-only design (no shadow on the bar -- use border instead)
  </action>
  <verify>
    - `pnpm typecheck` passes
    - All four files export their named components
    - CancelDialog and RescheduleDialog use Dialog from @/components/ui/dialog (not native confirm)
    - RescheduleDialog imports ScheduleSelector
    - ExpandedDetails uses semantic status colors
  </verify>
  <done>Four supporting components created: expanded details with per-contact results, styled cancel dialog, reschedule dialog with ScheduleSelector, and floating action bar. All use existing UI primitives and Phase 15 design system.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite scheduled table with tabs, expandable rows, and bulk selection</name>
  <files>
    components/scheduled/scheduled-table.tsx
    components/scheduled/cancel-button.tsx
    app/(dashboard)/scheduled/page.tsx
  </files>
  <action>
    1. **Rewrite `components/scheduled/scheduled-table.tsx`** — Complete rewrite as a rich client component:

       **Props:** Accept `sends: ScheduledSendWithDetails[]` (updated type from Plan 01)

       **State management:**
       - `activeTab: 'pending' | 'past'` (defaults to 'pending')
       - `expanded: Record<string, boolean>` (row expanded state, reset on tab switch)
       - `rowSelection: Record<string, boolean>` (checkbox selection state, only for pending tab)
       - `lastSelectedId: string | null` (for shift-click range selection)
       - `showCancelDialog: boolean`
       - `showRescheduleDialog: boolean`
       - `isBulkPending: boolean` (loading state for bulk actions)

       **Data split:**
       - `pending`: sends with status === 'pending', sorted by scheduled_for ascending
       - `past`: sends with status !== 'pending', sorted by scheduled_for descending

       **Tabs layout** using Tabs/TabsList/TabsTrigger/TabsContent from `@/components/ui/tabs`:
       - Tab triggers: "Pending (N)" and "Past (N)" with counts
       - On tab change: reset expanded state and row selection

       **Table structure** (for each tab):
       - Desktop: HTML table with proper thead/tbody
       - Mobile: Card layout (like existing pattern)

       **Pending tab columns:**
       - Checkbox column (only in pending tab): Checkbox from `@/components/ui/checkbox`
         - Header checkbox: select all / deselect all
         - Row checkbox: individual selection
         - onClick handler with shift-click range selection:
           - Track `lastSelectedId`
           - On shift+click: get visible row IDs between lastSelectedId and clicked row, select entire range
           - On regular click: toggle single row
           - Use `e.stopPropagation()` on checkbox to prevent row expand toggle
       - Expand indicator: ChevronRight (collapsed) / ChevronDown (expanded) from Phosphor icons
       - Contacts: "N contact(s)" with Users icon
       - Scheduled For: formatted date with Clock icon
       - Status badge using Badge component with Phase 15 semantic colors
       - Individual cancel button (keep CancelButton component but update it)

       **Past tab columns:**
       - Expand indicator: ChevronRight/ChevronDown
       - Contacts: "N contact(s)"
       - Scheduled For: formatted date
       - Status badge
       - Results summary (for completed sends): "N sent / N skipped / N failed" inline text using semantic colors

       **Row click behavior:**
       - Clicking a row (not checkbox) toggles expanded state
       - Expanded row renders below as a full-width colSpan cell containing `<ExpandedDetails />`

       **Bulk action wiring:**
       - Import BulkActionBar, CancelDialog, RescheduleDialog
       - Render BulkActionBar with selectedCount and handlers
       - On "Cancel" action: open CancelDialog
       - On "Reschedule" action: open RescheduleDialog
       - On CancelDialog confirm: call `bulkCancelScheduledSends(selectedIds)`, show toast, clear selection
       - On RescheduleDialog confirm: call `bulkRescheduleScheduledSends(selectedIds, newDate)`, show toast, clear selection
       - Use `useRouter().refresh()` after successful bulk actions to refetch data

       **Mobile adaptation:**
       - Cards instead of table rows
       - Checkboxes always visible (not hover-only) on pending cards
       - Expand by tapping card
       - Floating action bar at bottom (same component, works on mobile)

    2. **Update `components/scheduled/cancel-button.tsx`:**
       - Replace `window.confirm()` with a local state + CancelDialog pattern
       - OR: Use a simpler approach -- import CancelDialog, manage `open` state locally
       - Replace Lucide icons with Phosphor icons (X -> X from @phosphor-icons/react)
       - Keep the same server action call (`cancelScheduledSend`)

    3. **Update `app/(dashboard)/scheduled/page.tsx`:**
       - Import `getScheduledSendsWithDetails` from `@/lib/data/scheduled` instead of `getScheduledSends` from `@/lib/actions/schedule`
       - Pass the detailed sends data to `ScheduledTable`
       - Replace Lucide icon imports with Phosphor equivalents (Calendar -> CalendarBlank, Send -> PaperPlaneTilt from @phosphor-icons/react)
       - Keep auth check and empty state pattern
       - Update empty state to match Phase 15 design system
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm lint` passes
    - Navigate to /scheduled page in browser:
      - Tabs show "Pending (N)" and "Past (N)"
      - Clicking a row expands to show details
      - Checkboxes appear on pending tab
      - Selecting rows shows floating action bar
      - Cancel dialog appears (styled, not native confirm)
      - Reschedule dialog shows ScheduleSelector
    - Shift-click selects range of rows
    - Bulk cancel/reschedule calls server actions
    - Mobile cards show checkboxes and expand on tap
  </verify>
  <done>
    Scheduled table fully rewritten with:
    - Pending/Past tabs with counts
    - Expandable rows showing per-contact results and message preview
    - Checkbox selection with shift-click range support
    - Floating action bar when rows selected
    - Styled cancel and reschedule dialogs (no native confirm)
    - Bulk operations wired to server actions
    - Responsive mobile card layout
    - Phase 15 design system (Phosphor icons, semantic status colors, border-only design)
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with no new errors
2. `pnpm lint` passes
3. /scheduled page loads with Pending and Past tabs
4. Clicking a completed send expands to show per-contact results with sent/skipped/failed counts
5. Pending sends have checkboxes; selecting 2+ shows floating action bar
6. Shift-clicking selects range of rows between last selected and current
7. Cancel from floating bar opens styled dialog, confirms bulk cancel
8. Reschedule from floating bar opens dialog with ScheduleSelector, confirms bulk reschedule
9. Individual cancel button uses styled dialog (not native confirm)
10. Mobile layout shows cards with checkboxes and expand support
</verification>

<success_criteria>
- MGMT-01: Tabbed list shows all scheduled sends with status, time, and recipient count
- MGMT-02: Individual and bulk cancel with styled confirmation dialogs
- MGMT-03: Completed sends show inline summary counts and expandable per-contact breakdown
- MGMT-04: Bulk reschedule via floating action bar, ScheduleSelector dialog, and confirmation
- All Phase 15 design system patterns followed (Phosphor icons, semantic colors, border-only)
- Responsive on desktop and mobile
</success_criteria>

<output>
After completion, create `.planning/phases/14-scheduled-send-management/14-02-SUMMARY.md`
</output>
