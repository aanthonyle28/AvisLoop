---
phase: 43-cross-page-consistency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/analytics/loading.tsx
  - app/(dashboard)/settings/loading.tsx
  - app/(dashboard)/settings/page.tsx
  - app/(dashboard)/jobs/page.tsx
  - app/(dashboard)/jobs/loading.tsx
  - app/(dashboard)/customers/page.tsx
  - app/(dashboard)/customers/loading.tsx
  - app/(dashboard)/history/page.tsx
  - app/(dashboard)/history/loading.tsx
  - app/(dashboard)/feedback/loading.tsx
  - app/(dashboard)/billing/loading.tsx
  - app/(dashboard)/contacts/loading.tsx
autonomous: true

must_haves:
  truths:
    - "Every data page shows a skeleton layout (not a spinner) while server data loads"
    - "Loading skeletons match the visual structure of the actual rendered page (header, filters, content area)"
    - "No page shows a double loading pattern (spinner then skeleton or skeleton then spinner)"
  artifacts:
    - path: "app/(dashboard)/analytics/loading.tsx"
      provides: "Analytics page skeleton (header + 3 summary cards + table placeholder)"
      contains: "Skeleton"
    - path: "app/(dashboard)/settings/loading.tsx"
      provides: "Settings page skeleton extracted from inline component"
      contains: "Skeleton"
  key_links:
    - from: "app/(dashboard)/jobs/page.tsx"
      to: "app/(dashboard)/jobs/loading.tsx"
      via: "Next.js route-level Suspense boundary"
      pattern: "No inline Suspense in page.tsx"
    - from: "app/(dashboard)/customers/page.tsx"
      to: "app/(dashboard)/customers/loading.tsx"
      via: "Next.js route-level Suspense boundary"
      pattern: "No inline Suspense in page.tsx"
    - from: "app/(dashboard)/history/page.tsx"
      to: "app/(dashboard)/history/loading.tsx"
      via: "Next.js route-level Suspense boundary"
      pattern: "No inline Suspense in page.tsx"
---

<objective>
Standardize loading skeletons across all dashboard pages to use route-level `loading.tsx` files with consistent spacing, matching the campaigns page reference pattern.

Purpose: Eliminate inconsistent loading experiences (spinners on some pages, skeletons on others, double loading on pages with both) and ensure every page shows a skeleton that matches its actual rendered layout.

Output: Every dashboard data page has a `loading.tsx` file using the `Skeleton` component with `container py-6 space-y-8` wrapper pattern. Pages with inline `<Suspense>` spinners are refactored to async server components that rely on route-level loading.tsx instead.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-cross-page-consistency/43-RESEARCH.md

Reference files (the gold standard):
@app/(dashboard)/campaigns/loading.tsx — Reference loading skeleton pattern
@components/skeletons/table-skeleton.tsx — Reusable table skeleton
@components/skeletons/card-skeleton.tsx — Reusable card skeleton
@components/ui/skeleton.tsx — Base skeleton primitive
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create missing loading.tsx files and normalize existing ones</name>
  <files>
    app/(dashboard)/analytics/loading.tsx
    app/(dashboard)/settings/loading.tsx
    app/(dashboard)/settings/page.tsx
    app/(dashboard)/jobs/loading.tsx
    app/(dashboard)/customers/loading.tsx
    app/(dashboard)/history/loading.tsx
    app/(dashboard)/feedback/loading.tsx
    app/(dashboard)/billing/loading.tsx
    app/(dashboard)/contacts/loading.tsx
  </files>
  <action>
    **Reference pattern** (from campaigns/loading.tsx):
    ```tsx
    import { Skeleton } from '@/components/ui/skeleton'
    export default function XxxLoading() {
      return (
        <div className="container py-6 space-y-8">
          {/* Header: title + subtitle on left, action button on right */}
          <div className="flex items-center justify-between">
            <div className="space-y-2">
              <Skeleton className="h-8 w-40" />
              <Skeleton className="h-4 w-64" />
            </div>
            <Skeleton className="h-10 w-32" />
          </div>
          {/* Content area */}
          ...
        </div>
      )
    }
    ```

    All loading.tsx files must use `container py-6 space-y-8` as the outer wrapper (the reference spacing). Pages that use `max-w-4xl` in their actual page component (feedback, billing, settings) should include that in their loading wrapper too.

    **CREATE `app/(dashboard)/analytics/loading.tsx`:**
    - Wrapper: `container py-6 space-y-8`
    - Header: `<Skeleton className="h-8 w-32" />` for title "Analytics" (no subtitle in actual page, no action button)
    - Content: 3 summary cards in a `grid grid-cols-1 md:grid-cols-3 gap-4` — each card is a `<Skeleton className="h-24 rounded-lg" />`
    - Below cards: one `<Skeleton className="h-64 rounded-lg" />` for the table breakdown area
    - Import only `Skeleton` from `@/components/ui/skeleton`

    **CREATE `app/(dashboard)/settings/loading.tsx`:**
    - Extract the inline `SettingsLoadingSkeleton` from `settings/page.tsx` into a proper `loading.tsx` file
    - Wrapper: `max-w-4xl mx-auto` (matching actual page layout)
    - Sticky header section: `<div className="sticky top-0 z-10 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-border px-6 py-4">` containing `<Skeleton className="h-9 w-32" />` and `<Skeleton className="h-5 w-80" />`
    - Body: `<div className="p-6 space-y-8">` with `<Skeleton className="h-10 w-full rounded-md" />` (tabs bar) and a card: `<div className="border rounded-lg p-6 bg-card shadow-sm">` with `<Skeleton className="h-6 w-40 mb-4" />` and 3x `<Skeleton className="h-10 rounded" />`
    - Use `Skeleton` component (NOT raw `bg-muted` divs with `animate-pulse`)

    **UPDATE `app/(dashboard)/settings/page.tsx`:**
    - Remove the inline `SettingsLoadingSkeleton` function entirely (lines 18-38)
    - The page already uses `<Suspense fallback={...}>` pattern — keep `<Suspense>` but import and use the skeleton from the new loading.tsx? NO — actually, since settings/page.tsx uses the Suspense-within-page pattern (async SettingsContent inside Suspense), the loading.tsx at route level will handle the initial page load, and the inline Suspense handles the streaming of SettingsContent. This is a VALID pattern for settings because the page component itself is synchronous and renders the Suspense boundary.
    - CORRECTION: Settings uses a different pattern from jobs/customers/history. The settings page.tsx is a synchronous component that wraps an async SettingsContent in Suspense. This is the CORRECT Next.js streaming pattern. The loading.tsx file handles the route-level loading (before page.tsx even renders), while the inline Suspense handles the async data fetch within the page.
    - So: CREATE loading.tsx as described above. KEEP the inline Suspense in page.tsx BUT replace the raw `bg-muted animate-pulse` divs with proper `Skeleton` components. Refactor `SettingsLoadingSkeleton` to use `Skeleton` from `@/components/ui/skeleton` instead of raw divs.

    **NORMALIZE `app/(dashboard)/jobs/loading.tsx`:**
    - Change `space-y-6` to `space-y-8` (match reference)
    - Add subtitle skeleton below title: wrap title + subtitle in `<div className="space-y-2">` with `<Skeleton className="h-8 w-24" />` and `<Skeleton className="h-4 w-48" />`

    **NORMALIZE `app/(dashboard)/customers/loading.tsx`:**
    - Change `space-y-6` to `space-y-8` (match reference)
    - Add subtitle skeleton: wrap title in `<div className="space-y-2">` with `<Skeleton className="h-8 w-32" />` and `<Skeleton className="h-4 w-56" />`

    **NORMALIZE `app/(dashboard)/history/loading.tsx`:**
    - Change `space-y-6` to `space-y-8` (match reference)
    - Add subtitle skeleton: wrap title in `<div className="space-y-2">` with `<Skeleton className="h-8 w-40" />` and `<Skeleton className="h-4 w-64" />`

    **NORMALIZE `app/(dashboard)/feedback/loading.tsx`:**
    - Change wrapper from `container py-8 max-w-4xl` to `container max-w-4xl py-6 space-y-8` (match reference py-6 and use space-y-8 instead of manual mb-8)
    - Wrap header skeletons in a `<div>` block (remove manual mb-8 on header since space-y-8 handles it)

    **NORMALIZE `app/(dashboard)/billing/loading.tsx`:**
    - Change wrapper from `container mx-auto py-6 px-4 space-y-6` to `container max-w-4xl py-6 space-y-8` (match actual page which uses `container max-w-4xl py-6 space-y-6`, but use space-y-8 for skeleton consistency)

    **DELETE `app/(dashboard)/contacts/loading.tsx`:**
    - The contacts page is just a redirect to /customers. The loading.tsx is dead code. Delete it.
  </action>
  <verify>
    1. `pnpm typecheck` passes
    2. `pnpm lint` passes
    3. Verify all loading.tsx files exist: analytics, settings, jobs, customers, history, feedback, billing
    4. Verify contacts/loading.tsx is deleted
    5. Verify no loading.tsx file uses raw `bg-muted` + `animate-pulse` divs (all should use Skeleton component)
    6. Verify all loading.tsx wrappers use `py-6` and `space-y-8`
  </verify>
  <done>Every dashboard data page (analytics, settings, jobs, customers, history, feedback, billing) has a loading.tsx file using the Skeleton component with consistent spacing. The dead contacts/loading.tsx is removed.</done>
</task>

<task type="auto">
  <name>Task 2: Remove inline Suspense spinners from pages that have loading.tsx</name>
  <files>
    app/(dashboard)/jobs/page.tsx
    app/(dashboard)/customers/page.tsx
    app/(dashboard)/history/page.tsx
  </files>
  <action>
    Three pages currently have BOTH a `loading.tsx` AND an inline `<Suspense fallback={spinner}>` in their page.tsx. This causes a double loading pattern: first the route-level skeleton shows, then when page.tsx renders, the inline spinner shows until the async content resolves. Fix by making the page export the async function directly (no Suspense wrapper in page.tsx).

    **REFACTOR `app/(dashboard)/jobs/page.tsx`:**
    - Remove the `import { Suspense } from 'react'` import
    - Remove the `JobsPage` wrapper function that contains the Suspense boundary
    - Remove the `<div className="container py-6 space-y-6">` wrapper (this is now in JobsClient or handled by the loading skeleton)
    - Make the default export `JobsContent` directly (rename to `JobsPage`):
      ```tsx
      export default async function JobsPage() {
        const [{ jobs, total, businessId }, { customers }] = await Promise.all([
          getJobs(),
          getCustomers({ limit: 200 }),
        ])
        // ... existing logic ...
        return <JobsClient ... />
      }
      ```
    - IMPORTANT: The `<div className="container py-6 space-y-6">` wrapper that was on the old JobsPage needs to move. Check if `JobsClient` already has a wrapper — looking at the code, `JobsClient` renders `<div className="space-y-6">` (no container). So add `container py-6` to JobsClient's outer wrapper: change `<div className="space-y-6">` to `<div className="container py-6 space-y-6">`.
    - Wait — DON'T modify JobsClient. Instead, wrap the return in the page:
      ```tsx
      return (
        <div className="container py-6 space-y-6">
          <JobsClient ... />
        </div>
      )
      ```
      This keeps the container at the page level, matching the loading.tsx structure.

    **REFACTOR `app/(dashboard)/customers/page.tsx`:**
    - Same pattern: remove Suspense import, collapse into single async default export
    - Remove the spinner fallback
    - Keep `<div className="container py-6 space-y-6">` wrapper in the page around CustomersContent's return:
      ```tsx
      export default async function CustomersPage() {
        const business = await getBusiness()
        if (!business) redirect('/onboarding')
        const [{ customers }, monthlyUsage] = await Promise.all([
          getCustomers(),
          getMonthlyUsage(),
        ])
        const sendTemplates = (business.message_templates || []).filter(
          (t: { channel: string }) => t.channel === 'email'
        )
        return (
          <div className="container py-6 space-y-6">
            <CustomersClient
              initialCustomers={customers}
              business={business}
              templates={sendTemplates}
              monthlyUsage={monthlyUsage}
              hasReviewLink={!!business.google_review_link}
            />
          </div>
        )
      }
      ```

    **REFACTOR `app/(dashboard)/history/page.tsx`:**
    - Same pattern: remove Suspense import, collapse into single async default export
    - The page accepts `searchParams` — keep that:
      ```tsx
      export default async function HistoryPage(props: HistoryPageProps) {
        const params = await props.searchParams
        // ... existing HistoryContent logic ...
        return (
          <div className="container py-6 space-y-6">
            <HistoryClient ... />
          </div>
        )
      }
      ```
    - Remove the old HistoryContent inner function — merge its body into HistoryPage directly.

    **WHY this works:** Next.js automatically wraps async page components in a Suspense boundary using the sibling `loading.tsx` as the fallback. By making the page itself async, Next.js shows loading.tsx while the page's data fetches resolve, then swaps in the rendered page. No double loading.
  </action>
  <verify>
    1. `pnpm typecheck` passes
    2. `pnpm lint` passes
    3. Grep for `Suspense` in the three modified page files — should return NO matches:
       - `grep -r "Suspense" app/(dashboard)/jobs/page.tsx` — no match
       - `grep -r "Suspense" app/(dashboard)/customers/page.tsx` — no match
       - `grep -r "Suspense" app/(dashboard)/history/page.tsx` — no match
    4. Grep for `animate-spin` in the three files — should return NO matches (no spinner fallbacks)
    5. Run `pnpm dev` and verify pages load correctly (manual spot check)
  </verify>
  <done>Jobs, customers, and history pages are async server components with no inline Suspense spinners. Route-level loading.tsx provides the only loading state, eliminating the double-loading pattern.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` — all TypeScript types resolve correctly
2. `pnpm lint` — no lint errors
3. Every dashboard data page has a loading.tsx: analytics, settings, jobs, customers, history, feedback, billing
4. No page has BOTH a loading.tsx AND an inline Suspense spinner (except settings which uses Suspense for streaming, not double-loading)
5. All loading.tsx files use `Skeleton` component (not raw `animate-pulse` divs)
6. All loading.tsx files use `py-6` in their container
7. Dead `contacts/loading.tsx` is deleted
</verification>

<success_criteria>
- All 7 data pages show skeleton loading states during data fetch
- Zero pages show the old spinner pattern (spinning circle + "Loading X...")
- Loading skeletons visually approximate the rendered page layout (header placement, filter area, content shape)
- `pnpm typecheck` and `pnpm lint` both pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/43-cross-page-consistency/43-01-SUMMARY.md`
</output>
