---
phase: 28-onboarding-redesign
plan: 03
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - lib/actions/onboarding.ts
  - lib/actions/business.ts
  - lib/data/onboarding.ts
autonomous: true

must_haves:
  truths:
    - "Server action saves business basics (name, phone, Google review link) in one call"
    - "Server action saves software_used field to business"
    - "Server action saves service types and timing defaults to business"
    - "Server action creates campaign by duplicating a preset"
    - "Server action saves SMS consent acknowledgment with timestamp"
    - "Onboarding data function returns all new business fields"
  artifacts:
    - path: "lib/actions/onboarding.ts"
      provides: "Onboarding server actions for steps 1-7"
      exports: ["saveBusinessBasics", "saveSoftwareUsed", "saveServicesOffered", "createCampaignFromPreset", "acknowledgeSMSConsent"]
    - path: "lib/actions/business.ts"
      provides: "Updated getBusiness returning new fields"
      contains: "phone"
  key_links:
    - from: "lib/actions/onboarding.ts"
      to: "lib/actions/business.ts"
      via: "updateServiceTypeSettings for step 3"
      pattern: "updateServiceTypeSettings"
    - from: "lib/actions/onboarding.ts"
      to: "lib/actions/campaign.ts"
      via: "duplicateCampaign for step 5"
      pattern: "duplicateCampaign"
---

<objective>
Create server actions for all 7 onboarding steps.

Purpose: Each wizard step needs a server action to persist data. Some reuse existing actions (updateServiceTypeSettings, duplicateCampaign), others are new (saveBusinessBasics, saveSoftwareUsed, acknowledgeSMSConsent). All must validate input and scope to authenticated user's business.

Output: All server actions ready for step components to call.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/actions/onboarding.ts
@lib/actions/business.ts
@lib/actions/campaign.ts
@lib/validations/onboarding.ts (from Plan 01)
@.planning/phases/28-onboarding-redesign/28-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding server actions for new steps</name>
  <files>lib/actions/onboarding.ts</files>
  <action>
Add new server actions to the existing `lib/actions/onboarding.ts` file. Keep existing `markOnboardingComplete` and `markOnboardingCardStep` functions unchanged.

Add these new exports:

**saveBusinessBasics** -- Step 1 action
- Import `businessBasicsSchema` from `@/lib/validations/onboarding`
- Accept `{ name: string, phone?: string, googleReviewLink?: string }` parameter
- Validate with businessBasicsSchema.safeParse()
- Auth check with supabase.auth.getUser()
- Check if business exists: if yes, update name + phone + google_review_link; if no, insert new business with user_id
- Return `{ success: boolean, error?: string }`
- revalidatePath('/onboarding') and '/dashboard'

**saveReviewDestination** -- Step 2 action
- Import `reviewDestinationSchema` from `@/lib/validations/onboarding`
- Accept `{ googleReviewLink: string }` parameter
- Validate with reviewDestinationSchema.safeParse()
- Auth check, get business, update google_review_link
- Return `{ success: boolean, error?: string }`

**saveServicesOffered** -- Step 3 action
- Import `servicesOfferedSchema` from `@/lib/validations/onboarding`
- Import `DEFAULT_TIMING_HOURS` from `@/lib/validations/job`
- Accept `{ serviceTypes: string[] }` parameter
- Validate with servicesOfferedSchema.safeParse()
- Auth check, get business
- Build timing map: for each selected service type, use DEFAULT_TIMING_HOURS[type]
- Update business with `service_types_enabled` = selected types array AND `service_type_timing` = timing map
- IMPORTANT: Must set BOTH columns (as noted in pitfall 4 from research)
- Return `{ success: boolean, error?: string }`
- revalidatePath('/settings')

**saveSoftwareUsed** -- Step 4 action
- Import `softwareUsedSchema` from `@/lib/validations/onboarding`
- Accept `{ softwareUsed: string }` parameter
- Validate with softwareUsedSchema.safeParse()
- Auth check, update business.software_used
- Return `{ success: boolean, error?: string }`

**createCampaignFromPreset** -- Step 5 action (wrapper)
- Import `duplicateCampaign` from `@/lib/actions/campaign`
- Accept `presetId: string` parameter
- Call duplicateCampaign(presetId)
- Return the result directly (has { error?: string, data?: { campaignId: string } })

**acknowledgeSMSConsent** -- Step 7 action
- Import `smsConsentSchema` from `@/lib/validations/onboarding`
- Accept `{ acknowledged: boolean }` parameter
- Validate: acknowledged must be true
- Auth check, update business with sms_consent_acknowledged = true, sms_consent_acknowledged_at = new Date().toISOString()
- Return `{ success: boolean, error?: string }`
- revalidatePath('/onboarding') and '/dashboard'

All actions follow the existing pattern in this file:
- `'use server'` directive already at top
- createClient() from '@/lib/supabase/server'
- Auth check with getUser()
- Return typed objects with success/error
  </action>
  <verify>Run `pnpm typecheck` -- no errors in lib/actions/onboarding.ts.</verify>
  <done>Six new server action functions exported from lib/actions/onboarding.ts, each with auth check, validation, and database persistence.</done>
</task>

<task type="auto">
  <name>Task 2: Update getBusiness and onboarding data to return new fields</name>
  <files>lib/actions/business.ts, lib/data/onboarding.ts</files>
  <action>
**lib/actions/business.ts** -- Update `getBusiness()` function:
The existing `getBusiness()` already uses `select('*')` on businesses table, so new columns will automatically be included in the query result. No query changes needed.

However, verify the `updateBusiness` function handles the `phone` field if passed via FormData. Add phone to the parsed fields and update query:
- Add `phone: formData.get('phone') || ''` to the parsed object
- In the update/insert queries, add `phone: parsed.data.phone || null`
- Update the businessSchema import section to handle phone if it's in the schema (it was added in Plan 01)

**lib/data/onboarding.ts** -- Update `getOnboardingStatus()`:
The function queries `select('id, onboarding_completed_at, google_review_link')` on businesses.
Expand to: `select('id, onboarding_completed_at, google_review_link, phone, software_used, service_types_enabled, sms_consent_acknowledged')`

Update the `OnboardingStatus` steps to include new checks:
```typescript
steps: {
  hasBusinessProfile: true,
  hasReviewLink: !!business.google_review_link,
  hasPhone: !!business.phone,
  hasServiceTypes: Array.isArray(business.service_types_enabled) && business.service_types_enabled.length > 0,
  hasSMSConsent: !!business.sms_consent_acknowledged,
  hasContacts: (contactCount ?? 0) > 0,
  hasSentMessage: (sendCount ?? 0) > 0,
}
```

Update the `OnboardingStatus` type at the top to include the new step fields.
  </action>
  <verify>Run `pnpm typecheck` -- no errors in business.ts or onboarding.ts data file.</verify>
  <done>getBusiness returns phone, software_used, sms_consent_acknowledged fields. OnboardingStatus includes hasPhone, hasServiceTypes, hasSMSConsent step checks.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. lib/actions/onboarding.ts exports 6 new functions (saveBusinessBasics, saveReviewDestination, saveServicesOffered, saveSoftwareUsed, createCampaignFromPreset, acknowledgeSMSConsent) plus existing 2
4. All server actions have auth checks and input validation
</verification>

<success_criteria>
- All 6 new server actions are exported and properly typed
- Each action validates input with Zod schemas from Plan 01
- Each action scopes database writes to authenticated user's business
- Step 3 action sets BOTH service_types_enabled and service_type_timing
- Step 5 action wraps existing duplicateCampaign function
- OnboardingStatus type includes new step fields
- `pnpm typecheck` passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/28-onboarding-redesign/28-03-SUMMARY.md`
</output>
