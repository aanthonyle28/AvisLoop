---
phase: 28-onboarding-redesign
plan: 06
type: execute
wave: 3
depends_on: ["28-03", "28-04"]
files_modified:
  - components/onboarding/steps/campaign-preset-step.tsx
  - components/onboarding/steps/customer-import-step.tsx
  - components/onboarding/steps/sms-consent-step.tsx
  - components/onboarding/onboarding-steps.tsx
autonomous: true

must_haves:
  truths:
    - "Step 5 shows 3 campaign presets and creates campaign on selection"
    - "Step 6 allows CSV import or skip, tracks import completion to prevent duplicates on back-nav"
    - "Step 7 explains SMS consent requirements and captures TCPA acknowledgment"
    - "Step 7 completion triggers onboarding finish and dashboard redirect"
  artifacts:
    - path: "components/onboarding/steps/campaign-preset-step.tsx"
      provides: "Step 5: Campaign preset picker with auto-creation"
      exports: ["CampaignPresetStep"]
    - path: "components/onboarding/steps/customer-import-step.tsx"
      provides: "Step 6: CSV import composition with duplicate prevention"
      exports: ["CustomerImportStep"]
    - path: "components/onboarding/steps/sms-consent-step.tsx"
      provides: "Step 7: SMS consent explanation and TCPA acknowledgment"
      exports: ["SMSConsentStep"]
  key_links:
    - from: "components/onboarding/steps/campaign-preset-step.tsx"
      to: "lib/actions/onboarding.ts"
      via: "createCampaignFromPreset server action"
      pattern: "createCampaignFromPreset"
    - from: "components/onboarding/steps/customer-import-step.tsx"
      to: "components/customers/csv-import-dialog.tsx"
      via: "composes CSVImportDialog component"
      pattern: "CSVImportDialog"
    - from: "components/onboarding/steps/sms-consent-step.tsx"
      to: "lib/actions/onboarding.ts"
      via: "acknowledgeSMSConsent server action"
      pattern: "acknowledgeSMSConsent"
---

<objective>
Build step components 5-7 (Campaign Preset, Customer Import, SMS Consent) and wire them into the step router.

Purpose: Steps 5-7 complete the onboarding flow. Step 5 auto-creates a campaign, step 6 imports initial customers, and step 7 captures TCPA consent acknowledgment. Step 7 triggers wizard completion.

Output: Three complete step components integrated into the onboarding wizard, completing the full 7-step flow.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@components/onboarding/onboarding-steps.tsx
@components/campaigns/preset-picker.tsx
@components/customers/csv-import-dialog.tsx
@lib/actions/onboarding.ts
@lib/constants/campaigns.ts
@.planning/phases/28-onboarding-redesign/28-03-SUMMARY.md
@.planning/phases/28-onboarding-redesign/28-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create step components 5-7</name>
  <files>components/onboarding/steps/campaign-preset-step.tsx, components/onboarding/steps/customer-import-step.tsx, components/onboarding/steps/sms-consent-step.tsx</files>
  <action>
Create 3 new step components following the established onboarding step pattern.

**components/onboarding/steps/campaign-preset-step.tsx** (NEW file):
- `'use client'` directive
- Props: `{ onComplete: () => void, onGoBack: () => void, presets: CampaignWithTouches[] }`
- Import CampaignWithTouches from `@/lib/types/database`
- Import CAMPAIGN_PRESETS from `@/lib/constants/campaigns`
- Import createCampaignFromPreset from `@/lib/actions/onboarding`
- Import Badge from `@/components/ui/badge`
- Import EnvelopeSimple, ChatCircle from `@phosphor-icons/react`
- Import toast from 'sonner'

Layout:
- Heading: "Choose your follow-up approach" / "Select a campaign style. You can customize it later in Settings."
- 3 preset cards in a grid (1 column mobile, 3 columns desktop):
  - Each card shows preset name (Conservative/Standard/Aggressive), description from CAMPAIGN_PRESETS, and touch sequence visualization (badges showing email/SMS icons with timing like "24h -> 72h")
  - Card click selects the preset (highlight with border-primary ring-2 ring-primary)
  - Match the visual pattern from existing PresetPicker component
- Selected state tracked with useState
- "Continue" button calls createCampaignFromPreset(selectedPreset.id)
  - On success: toast.success('Campaign created!'), then onComplete()
  - On error: toast.error(result.error)
  - Show loading spinner while creating
- Button row: "Back" (outline) and "Continue" (primary, disabled if no selection or creating)

IMPORTANT: Do NOT reuse the existing PresetPicker component directly because it navigates to the campaign edit page on selection. Build a self-contained version for onboarding that creates the campaign and continues the wizard.

**components/onboarding/steps/customer-import-step.tsx** (NEW file):
- `'use client'` directive
- Props: `{ onComplete: () => void, onGoBack: () => void }`
- Import CSVImportDialog from `@/components/customers/csv-import-dialog`
- Import useState

Layout:
- Heading: "Import your customers" / "Upload a CSV file or skip to add customers later."
- Render CSVImportDialog component (it's a dialog trigger button -- renders as "Import CSV" button)
- Track import completion: when CSVImportDialog closes successfully, set importComplete = true in state
- Show success banner if import completed: green bg with "Customers imported successfully"
- Note: CSVImportDialog doesn't have an onSuccess callback prop. Instead, after the dialog opens and the user completes import, the state updates internally. Check CSVImportDialog source -- it manages its own open/close state. The step should simply render it and track whether the user has used it.
- Alternative approach: Since CSVImportDialog is self-contained, just render it alongside a "Skip for now" button. The step doesn't need to know if import happened -- the user can always import later.
- Button row: "Back" (outline) and "Continue" or "Skip for now" (primary)
- The Continue/Skip button text: always show "Continue" (import is optional per research)
- SMS consent explanation shown as info banner at bottom: "When importing customers with phone numbers, you can set their SMS consent status in the customer list later."

PITFALL 5 PREVENTION: Do NOT track import state in localStorage. Simply render the import dialog each time. If user navigates back, they see the dialog again but CSV import deduplicates by email (existing behavior in bulkCreateCustomers).

**components/onboarding/steps/sms-consent-step.tsx** (NEW file):
- `'use client'` directive
- Props: `{ onComplete: () => Promise<void>, onGoBack: () => void, isSubmitting: boolean }`
- Import acknowledgeSMSConsent from `@/lib/actions/onboarding`
- Import Checkbox from `@radix-ui/react-checkbox`
- Import toast from 'sonner'

Layout:
- Heading: "SMS consent requirements" / "Important information about sending text messages to customers"
- Info card (border rounded-lg p-6 bg-card) with TCPA requirements:
  - Bullet list of key requirements:
    - "You must have written consent from customers before sending SMS messages"
    - "Customers can opt out at any time by replying STOP"
    - "You must keep records of when and how consent was obtained (TCPA compliance)"
    - "Messages will only be sent during business hours (8 AM - 9 PM local time)"
  - Checkbox with label (inside a highlighted bg-blue-50/blue-950 box):
    "I understand that I must obtain written consent from customers before sending them SMS messages, and I will maintain records of consent as required by TCPA regulations."
- Submit handler:
  1. Check checkbox is checked (if not, toast.error)
  2. Call acknowledgeSMSConsent({ acknowledged: true })
  3. On success: call await onComplete() (triggers markOnboardingComplete in wizard)
  4. On error: toast.error(result.error)
- Single "Complete Setup" button (full width, primary), disabled if checkbox unchecked or isSubmitting
- "Back" button above as text link or in a row
- NO "Skip" option -- SMS consent is required per research decision
  </action>
  <verify>Run `pnpm typecheck` -- all 3 step component files compile without errors.</verify>
  <done>Three step components created: CampaignPresetStep (preset picker with creation), CustomerImportStep (CSV import composition), SMSConsentStep (TCPA acknowledgment with checkbox).</done>
</task>

<task type="auto">
  <name>Task 2: Wire step components 5-7 into step router</name>
  <files>components/onboarding/onboarding-steps.tsx</files>
  <action>
Update `onboarding-steps.tsx` to import and render the real step components for cases 5-7, replacing the remaining placeholder steps.

Add imports at top:
```typescript
import { CampaignPresetStep } from './steps/campaign-preset-step'
import { CustomerImportStep } from './steps/customer-import-step'
import { SMSConsentStep } from './steps/sms-consent-step'
```

Update switch cases 5-7:
```typescript
case 5:
  return (
    <CampaignPresetStep
      onComplete={onGoToNext}
      onGoBack={onGoBack}
      presets={campaignPresets || []}
    />
  )
case 6:
  return (
    <CustomerImportStep
      onComplete={onGoToNext}
      onGoBack={onGoBack}
    />
  )
case 7:
  return (
    <SMSConsentStep
      onComplete={onComplete}
      onGoBack={onGoBack}
      isSubmitting={isSubmitting}
    />
  )
```

Remove the PlaceholderStep component (no longer needed -- all 7 steps have real components).

Remove any unused imports (Button if it was only used by PlaceholderStep, etc.).
  </action>
  <verify>Run `pnpm typecheck` and `pnpm lint`. Navigate through all 7 steps in browser -- full wizard flow works from step 1 to completion.</verify>
  <done>All 7 steps render real components. Full wizard flow: Business Basics -> Review Destination -> Services -> Software -> Campaign -> Customers -> SMS Consent -> Dashboard redirect.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. Step 5 shows 3 preset cards with touch visualization
4. Step 5 creates campaign on selection and advances
5. Step 6 shows CSV import dialog with Continue button
6. Step 7 shows TCPA requirements with checkbox
7. Step 7 "Complete Setup" saves consent and redirects to dashboard
8. Full flow 1-7 completes without errors
</verification>

<success_criteria>
- Step 5 renders 3 campaign presets, creates campaign via createCampaignFromPreset on selection
- Step 6 composes CSVImportDialog, is skippable with "Continue" button
- Step 7 captures SMS consent acknowledgment via checkbox, calls acknowledgeSMSConsent, then triggers onComplete
- All placeholder steps removed from step router
- Complete 7-step wizard flow ends with dashboard redirect
- `pnpm typecheck` passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/28-onboarding-redesign/28-06-SUMMARY.md`
</output>
