---
phase: 28-onboarding-redesign
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/actions/branded-links.ts
  - components/settings/branded-links-section.tsx
  - app/(dashboard)/settings/page.tsx
autonomous: true

user_setup:
  - service: bitly
    why: "URL shortening for branded review links"
    env_vars:
      - name: BITLY_ACCESS_TOKEN
        source: "Bitly Dashboard -> Settings -> API -> Generate Access Token (https://app.bitly.com/settings/api/)"
    dashboard_config:
      - task: "Create free Bitly account"
        location: "https://bitly.com/pages/register"

must_haves:
  truths:
    - "Settings page has a Branded Links section where business owner can configure short link preferences"
    - "Server action generates a Bitly short link from a Google review URL"
    - "If BITLY_ACCESS_TOKEN is not configured, section shows setup instructions instead of active controls"
    - "Generated short links are stored on the business record for reuse"
  artifacts:
    - path: "lib/actions/branded-links.ts"
      provides: "Server action to generate Bitly short link from review URL"
      exports: ["generateBrandedLink"]
    - path: "components/settings/branded-links-section.tsx"
      provides: "Settings UI for branded link generation and display"
      exports: ["BrandedLinksSection"]
    - path: "app/(dashboard)/settings/page.tsx"
      provides: "Settings page with BrandedLinksSection added"
      contains: "BrandedLinksSection"
  key_links:
    - from: "components/settings/branded-links-section.tsx"
      to: "lib/actions/branded-links.ts"
      via: "generateBrandedLink server action call"
      pattern: "generateBrandedLink"
    - from: "app/(dashboard)/settings/page.tsx"
      to: "components/settings/branded-links-section.tsx"
      via: "import and render in settings page"
      pattern: "BrandedLinksSection"
---

<objective>
Add branded short links (DLVR-03) as a settings page feature using Bitly API.

Purpose: DLVR-03 requires branded short links for review URLs (trust signal, not raw Google URL). Per research, this is a post-onboarding settings feature -- not part of the wizard flow. Bitly free tier provides 1,500 links/month which is sufficient for initial launch. The feature generates a short link from the business's Google review URL and stores it for use in review request messages.

Output: BrandedLinksSection component in settings page, server action for Bitly API integration, graceful degradation when API key not configured.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@app/(dashboard)/settings/page.tsx
@lib/actions/business.ts
@.planning/phases/28-onboarding-redesign/28-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create branded link server action</name>
  <files>lib/actions/branded-links.ts</files>
  <action>
Create a new server action file for Bitly short link generation.

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'

/**
 * Generate a Bitly short link from a long URL (the business's Google review link).
 * Stores the result on the business record as `branded_review_link`.
 *
 * If BITLY_ACCESS_TOKEN is not set, returns an error instructing the user to configure it.
 */
export async function generateBrandedLink(longUrl: string): Promise<{ success: boolean; shortUrl?: string; error?: string }> {
  // Validate input
  if (!longUrl || !longUrl.trim()) {
    return { success: false, error: 'Review URL is required' }
  }

  try {
    new URL(longUrl)
  } catch {
    return { success: false, error: 'Invalid URL format' }
  }

  // Check API key
  const apiToken = process.env.BITLY_ACCESS_TOKEN
  if (!apiToken) {
    return { success: false, error: 'Bitly API key not configured. Add BITLY_ACCESS_TOKEN to environment variables.' }
  }

  // Auth check
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return { success: false, error: 'Not authenticated' }
  }

  // Get business
  const { data: business } = await supabase
    .from('businesses')
    .select('id')
    .eq('user_id', user.id)
    .single()

  if (!business) {
    return { success: false, error: 'Business not found' }
  }

  // Call Bitly API v4
  try {
    const response = await fetch('https://api-ssl.bitly.com/v4/shorten', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ long_url: longUrl }),
    })

    if (!response.ok) {
      const errorBody = await response.text()
      console.error('Bitly API error:', response.status, errorBody)
      return { success: false, error: 'Failed to create short link. Please try again.' }
    }

    const data = await response.json()
    const shortUrl = data.link as string

    // Store on business record
    await supabase
      .from('businesses')
      .update({ branded_review_link: shortUrl })
      .eq('id', business.id)

    return { success: true, shortUrl }
  } catch (err) {
    console.error('Bitly API request failed:', err)
    return { success: false, error: 'Network error creating short link. Please try again.' }
  }
}
```

This requires a `branded_review_link` TEXT column on businesses table. Add a Supabase migration named `add_branded_review_link`:

```sql
ALTER TABLE businesses
  ADD COLUMN IF NOT EXISTS branded_review_link TEXT;
```

No RLS changes needed -- businesses table already has RLS policies scoped by user_id.
  </action>
  <verify>Run `pnpm typecheck` -- no errors in branded-links.ts.</verify>
  <done>Server action generates Bitly short link and stores on business record. Gracefully errors when API key missing.</done>
</task>

<task type="auto">
  <name>Task 2: Create BrandedLinksSection component and add to settings</name>
  <files>components/settings/branded-links-section.tsx, app/(dashboard)/settings/page.tsx</files>
  <action>
**components/settings/branded-links-section.tsx** -- Create a Client Component:

- `'use client'` directive
- Props: `{ googleReviewLink?: string | null, brandedReviewLink?: string | null }`
- Import generateBrandedLink from `@/lib/actions/branded-links`
- Import Button from `@/components/ui/button`
- Import Input from `@/components/ui/input`
- Import toast from 'sonner'
- Import Link (LinkSimple) icon from `@phosphor-icons/react`

Layout:
- If no googleReviewLink: show info message "Set up your Google review link first (in Business Profile above) before creating a branded short link."
- If googleReviewLink exists and brandedReviewLink exists: show the short link in a copyable input field with a "Copy" button. Show "Regenerate" button below.
- If googleReviewLink exists but no brandedReviewLink: show "Generate Short Link" button that calls generateBrandedLink(googleReviewLink)
- Loading state while generating (useTransition)
- Success: toast.success('Short link created!'), display the new link
- Error: toast.error(result.error)
- Note below: "Powered by Bitly. Free tier supports up to 1,500 links/month."

Copy button copies short link to clipboard via navigator.clipboard.writeText().

Style to match other settings sections.

**app/(dashboard)/settings/page.tsx** -- Add BrandedLinksSection:

Import BrandedLinksSection at top:
```typescript
import { BrandedLinksSection } from '@/components/settings/branded-links-section'
```

Add a new section after the Email Authentication section (from Plan 28-02):
```tsx
{/* Section: Branded Links */}
<section className="border border-border rounded-lg p-6 bg-card shadow-sm">
  <h2 className="text-xl font-semibold mb-4">Branded Review Link</h2>
  <p className="text-muted-foreground mb-4">
    Create a short, branded link for your Google review page. This appears more trustworthy in messages.
  </p>
  <BrandedLinksSection
    googleReviewLink={business?.google_review_link}
    brandedReviewLink={business?.branded_review_link}
  />
</section>
```

Ensure the business data query in settings page already fetches `branded_review_link` (it uses getBusiness which does `select('*')`, so it will be included automatically after the migration).
  </action>
  <verify>Run `pnpm typecheck` -- no errors. Settings page renders BrandedLinksSection.</verify>
  <done>Settings page includes Branded Review Link section. Component handles all states: no review link, no short link, existing short link with copy.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. Settings page shows "Branded Review Link" section
4. If BITLY_ACCESS_TOKEN not set, shows appropriate message on generate attempt
5. If API key set and Google review link exists, generates and displays short link
</verification>

<success_criteria>
- DLVR-03 requirement covered: branded short links for review URLs
- Settings page displays Branded Review Link section
- Server action calls Bitly API v4 /shorten endpoint
- Graceful degradation when API key not configured
- Short link stored on business record for reuse
- `pnpm typecheck` passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/28-onboarding-redesign/28-08-SUMMARY.md`
</output>
