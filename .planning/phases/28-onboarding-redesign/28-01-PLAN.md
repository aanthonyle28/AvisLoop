---
phase: 28-onboarding-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/types/database.ts
  - lib/types/onboarding.ts
  - lib/validations/business.ts
  - lib/validations/onboarding.ts
autonomous: true

must_haves:
  truths:
    - "Business table has phone and software_used columns"
    - "Business table has sms_consent_acknowledged and sms_consent_acknowledged_at columns"
    - "TypeScript Business interface includes new fields"
    - "Onboarding validation schemas exist for all 7 steps"
  artifacts:
    - path: "lib/types/database.ts"
      provides: "Updated Business interface with phone, software_used, sms_consent_acknowledged fields"
      contains: "software_used"
    - path: "lib/types/onboarding.ts"
      provides: "Updated OnboardingBusiness type with new fields"
      contains: "phone"
    - path: "lib/validations/business.ts"
      provides: "Updated business schema with phone field"
      contains: "phone"
    - path: "lib/validations/onboarding.ts"
      provides: "Step-specific Zod schemas for 7-step wizard"
      exports: ["businessBasicsSchema", "reviewDestinationSchema", "servicesOfferedSchema", "softwareUsedSchema", "smsConsentSchema"]
  key_links:
    - from: "lib/validations/onboarding.ts"
      to: "lib/validations/job.ts"
      via: "SERVICE_TYPES import for step 3 schema"
      pattern: "SERVICE_TYPES"
---

<objective>
Add database columns and TypeScript types for the 7-step onboarding wizard.

Purpose: Phase 28 expands onboarding from 2 to 7 steps. Business table needs phone, software_used, and sms_consent_acknowledged columns. TypeScript types and Zod validation schemas must exist before step components can be built.

Output: Migration applied, types updated, validation schemas created.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/DATA_MODEL.md
@lib/types/database.ts
@lib/types/onboarding.ts
@lib/validations/business.ts
@lib/validations/job.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for business table columns</name>
  <files>supabase migration (via Supabase MCP)</files>
  <action>
Apply a Supabase migration named `add_business_onboarding_fields` that adds these columns to the `businesses` table:

```sql
ALTER TABLE businesses
  ADD COLUMN IF NOT EXISTS phone TEXT,
  ADD COLUMN IF NOT EXISTS software_used TEXT,
  ADD COLUMN IF NOT EXISTS sms_consent_acknowledged BOOLEAN NOT NULL DEFAULT false,
  ADD COLUMN IF NOT EXISTS sms_consent_acknowledged_at TIMESTAMPTZ;
```

- `phone`: Business phone number (nullable TEXT, no validation at DB level -- app validates E.164)
- `software_used`: CRM/field service software (nullable TEXT, stores 'servicetitan', 'jobber', 'housecall_pro', 'none', or NULL)
- `sms_consent_acknowledged`: Boolean flag that business owner acknowledged SMS consent requirements during onboarding
- `sms_consent_acknowledged_at`: Timestamp when acknowledgment was recorded

No RLS changes needed -- businesses table already has RLS policies scoped by user_id.
  </action>
  <verify>Run `SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'businesses' AND column_name IN ('phone', 'software_used', 'sms_consent_acknowledged', 'sms_consent_acknowledged_at')` via Supabase MCP execute_sql to confirm 4 columns exist.</verify>
  <done>Four new columns exist on businesses table with correct types and defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types and create validation schemas</name>
  <files>lib/types/database.ts, lib/types/onboarding.ts, lib/validations/business.ts, lib/validations/onboarding.ts</files>
  <action>
**lib/types/database.ts** -- Add fields to `Business` interface (after `default_template_id`):
```typescript
phone: string | null
software_used: string | null
sms_consent_acknowledged: boolean
sms_consent_acknowledged_at: string | null
```

**lib/types/onboarding.ts** -- Expand `OnboardingBusiness` type to include new fields:
```typescript
export type OnboardingBusiness = {
  name: string
  phone: string | null
  google_review_link: string | null
  software_used: string | null
  service_types_enabled: string[] | null
  sms_consent_acknowledged: boolean
} | null
```

**lib/validations/business.ts** -- Add `phone` field to businessSchema:
```typescript
phone: z
  .string()
  .max(20, 'Phone number too long')
  .trim()
  .optional()
  .or(z.literal('')),
```

**lib/validations/onboarding.ts** -- Create NEW file with step-specific Zod schemas:

```typescript
import { z } from 'zod'
import { SERVICE_TYPES } from './job'

// Step 1: Business Basics (required)
export const businessBasicsSchema = z.object({
  name: z.string().min(1, 'Business name is required').max(100).trim(),
  phone: z.string().max(20).trim().optional().or(z.literal('')),
  googleReviewLink: z
    .string()
    .url('Please enter a valid URL')
    .optional()
    .or(z.literal('')),
})

// Step 2: Review Destination (skippable)
export const reviewDestinationSchema = z.object({
  googleReviewLink: z
    .string()
    .url('Please enter a valid URL')
    .refine(
      (val) => !val || val.includes('google'),
      'Must be a Google review URL'
    )
    .optional()
    .or(z.literal('')),
})

// Step 3: Services Offered (required)
export const servicesOfferedSchema = z.object({
  serviceTypes: z.array(z.enum(SERVICE_TYPES)).min(1, 'Select at least one service type'),
})

// Step 4: Software Used (skippable)
export const SOFTWARE_OPTIONS = [
  { value: 'servicetitan', label: 'ServiceTitan' },
  { value: 'jobber', label: 'Jobber' },
  { value: 'housecall_pro', label: 'Housecall Pro' },
  { value: 'none', label: 'None / Other' },
] as const

export const softwareUsedSchema = z.object({
  softwareUsed: z.string().optional().or(z.literal('')),
})

// Step 7: SMS Consent (required)
export const smsConsentSchema = z.object({
  acknowledged: z.literal(true, {
    errorMap: () => ({ message: 'You must acknowledge SMS consent requirements' }),
  }),
})

// Type exports
export type BusinessBasicsInput = z.infer<typeof businessBasicsSchema>
export type ReviewDestinationInput = z.infer<typeof reviewDestinationSchema>
export type ServicesOfferedInput = z.infer<typeof servicesOfferedSchema>
export type SoftwareUsedInput = z.infer<typeof softwareUsedSchema>
export type SMSConsentInput = z.infer<typeof smsConsentSchema>
```
  </action>
  <verify>Run `pnpm typecheck` -- no errors related to Business type, onboarding types, or validation schemas.</verify>
  <done>Business interface has 4 new fields, OnboardingBusiness includes new fields, businessSchema includes phone, and lib/validations/onboarding.ts exports 5 step schemas.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with no errors
2. Migration applied successfully (4 new columns on businesses table)
3. `lib/validations/onboarding.ts` exists and exports all 5 schemas
4. `lib/types/database.ts` Business interface includes phone, software_used, sms_consent_acknowledged, sms_consent_acknowledged_at
</verification>

<success_criteria>
- Database has phone, software_used, sms_consent_acknowledged, sms_consent_acknowledged_at columns on businesses table
- TypeScript types updated to include new fields
- Step-specific Zod validation schemas created for steps 1-4 and 7
- `pnpm typecheck` passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/28-onboarding-redesign/28-01-SUMMARY.md`
</output>
