---
phase: 28-onboarding-redesign
plan: 04
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - components/onboarding/onboarding-wizard.tsx
  - components/onboarding/onboarding-steps.tsx
  - components/onboarding/onboarding-progress.tsx
  - lib/types/onboarding.ts
  - app/onboarding/page.tsx
autonomous: true

must_haves:
  truths:
    - "Wizard shell supports 7 steps with correct titles and skippable flags"
    - "Progress bar shows X/7 steps"
    - "URL param ?step=N navigates to step N (clamped 1-7)"
    - "Onboarding page fetches expanded business data including service types and presets"
  artifacts:
    - path: "components/onboarding/onboarding-wizard.tsx"
      provides: "7-step wizard shell with URL-based navigation"
      contains: "totalSteps: 7"
    - path: "components/onboarding/onboarding-steps.tsx"
      provides: "Step router dispatching to 7 step components"
      contains: "case 7"
    - path: "app/onboarding/page.tsx"
      provides: "Onboarding page with expanded data fetching"
      contains: "step=${step}"
  key_links:
    - from: "components/onboarding/onboarding-wizard.tsx"
      to: "components/onboarding/onboarding-steps.tsx"
      via: "renders OnboardingSteps with currentStep prop"
      pattern: "OnboardingSteps"
    - from: "app/onboarding/page.tsx"
      to: "components/onboarding/onboarding-wizard.tsx"
      via: "renders OnboardingWizard with initialStep and business data"
      pattern: "OnboardingWizard"
---

<objective>
Expand the onboarding wizard shell from 2 to 7 steps and update the onboarding page.

Purpose: The wizard shell (navigation, progress bar, step routing) must support 7 steps before individual step components can be built. This plan updates the infrastructure without building the step UIs themselves.

Output: Wizard shell navigates 7 steps, step router has 7 cases (placeholder components for steps 3-7), page fetches expanded data.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@components/onboarding/onboarding-wizard.tsx
@components/onboarding/onboarding-steps.tsx
@components/onboarding/onboarding-progress.tsx
@app/onboarding/page.tsx
@lib/types/onboarding.ts
@.planning/phases/28-onboarding-redesign/28-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand wizard shell to 7 steps</name>
  <files>components/onboarding/onboarding-wizard.tsx, lib/types/onboarding.ts</files>
  <action>
**components/onboarding/onboarding-wizard.tsx** -- Update the STEPS config array from 2 to 7 steps:

```typescript
const STEPS: StepConfig[] = [
  { id: 1, title: 'Business Basics', skippable: false },
  { id: 2, title: 'Review Destination', skippable: true },
  { id: 3, title: 'Services Offered', skippable: false },
  { id: 4, title: 'Software Used', skippable: true },
  { id: 5, title: 'Campaign Preset', skippable: false },
  { id: 6, title: 'Import Customers', skippable: true },
  { id: 7, title: 'SMS Consent', skippable: false },
]
```

Update OnboardingWizardProps interface to accept additional data:
```typescript
interface OnboardingWizardProps {
  initialStep: number
  business: OnboardingBusiness
  campaignPresets?: CampaignWithTouches[] // For step 5
}
```

Import CampaignWithTouches from `@/lib/types/database`.

Pass campaignPresets through to OnboardingSteps:
```typescript
<OnboardingSteps
  currentStep={currentStep}
  business={business}
  campaignPresets={campaignPresets}
  onGoToNext={goToNext}
  onGoBack={goBack}
  onComplete={handleComplete}
  isSubmitting={isSubmitting}
/>
```

No other changes to wizard logic -- goToStep, goToNext, goBack, handleComplete all work generically with STEPS.length.

**lib/types/onboarding.ts** is already updated in Plan 01 with expanded OnboardingBusiness type. No changes needed here if Plan 01 is complete.
  </action>
  <verify>Run `pnpm typecheck` -- wizard shell compiles with 7 steps.</verify>
  <done>STEPS array has 7 entries, wizard shell navigation supports steps 1-7, progress bar shows X/7.</done>
</task>

<task type="auto">
  <name>Task 2: Update step router and onboarding page</name>
  <files>components/onboarding/onboarding-steps.tsx, app/onboarding/page.tsx</files>
  <action>
**components/onboarding/onboarding-steps.tsx** -- Expand to 7 cases:

Update OnboardingStepsProps to accept campaignPresets:
```typescript
interface OnboardingStepsProps {
  currentStep: number
  business: OnboardingBusiness
  campaignPresets?: CampaignWithTouches[]
  onGoToNext: () => void
  onGoBack: () => void
  onComplete: () => Promise<void>
  isSubmitting: boolean
}
```

Import CampaignWithTouches from `@/lib/types/database`.

Update the switch statement. Keep cases 1 and 2 as they are (BusinessNameStep and GoogleReviewLinkStep already work). Add placeholder cases 3-7 that render simple placeholder UI for now. These will be replaced by real step components in Plans 05 and 06:

```typescript
case 3:
  return (
    <PlaceholderStep
      title="What services do you offer?"
      description="This step will be built in Plan 05."
      onComplete={onGoToNext}
      onGoBack={onGoBack}
    />
  )
case 4:
  return (
    <PlaceholderStep
      title="What software do you use?"
      description="This step will be built in Plan 05."
      onComplete={onGoToNext}
      onGoBack={onGoBack}
      skippable
    />
  )
case 5:
  return (
    <PlaceholderStep
      title="Choose your campaign style"
      description="This step will be built in Plan 06."
      onComplete={onGoToNext}
      onGoBack={onGoBack}
    />
  )
case 6:
  return (
    <PlaceholderStep
      title="Import your customers"
      description="This step will be built in Plan 06."
      onComplete={onGoToNext}
      onGoBack={onGoBack}
      skippable
    />
  )
case 7:
  return (
    <PlaceholderStep
      title="SMS consent requirements"
      description="This step will be built in Plan 06."
      onComplete={async () => { await onComplete() }}
      onGoBack={onGoBack}
    />
  )
```

Add a simple PlaceholderStep component at the bottom of the file:
```typescript
function PlaceholderStep({
  title,
  description,
  onComplete,
  onGoBack,
  skippable = false,
}: {
  title: string
  description: string
  onComplete: () => void
  onGoBack: () => void
  skippable?: boolean
}) {
  return (
    <div className="space-y-8">
      <div className="text-center space-y-2">
        <h1 className="text-3xl font-bold">{title}</h1>
        <p className="text-muted-foreground text-lg">{description}</p>
      </div>
      <div className="flex gap-3">
        <Button variant="outline" onClick={onGoBack} className="flex-1 h-12 text-base">
          Back
        </Button>
        <Button onClick={onComplete} className="flex-1 h-12 text-base">
          {skippable ? 'Skip' : 'Continue'}
        </Button>
      </div>
    </div>
  )
}
```

Update Step 2 (GoogleReviewLinkStep) so that it calls `onGoToNext()` instead of `onComplete()` (since it's no longer the last step). Change the submit handler from `await onComplete()` to `onGoToNext()`, and update the Skip button similarly. Remove isSubmitting prop usage since step 2 is now mid-flow.

NOTE: Do NOT add phone input to Step 1 (BusinessNameStep) here. Phone collection is handled by the new BusinessBasicsStep component created in Plan 28-05, which replaces BusinessNameStep entirely.

**app/onboarding/page.tsx** -- Update:
1. Change step range clamp from `Math.min(Math.max(1, stepParam), 2)` to `Math.min(Math.max(1, stepParam), 7)`
2. Update the page comment to reference 7-step flow
3. Fetch campaign presets for step 5 using the existing `supabase` client (already created via `createClient()` at line 26 of the current page). System presets have RLS policy allowing any authenticated user to SELECT where `is_preset = true`:
```typescript
// Fetch campaign presets (system presets for step 5)
// Uses existing supabase client from auth check above -- no createServiceClient needed
const { data: presets } = await supabase
  .from('campaigns')
  .select('*, campaign_touches (*)')
  .eq('is_preset', true)
  .order('name')
```

4. Pass presets to OnboardingWizard:
```typescript
return <OnboardingWizard initialStep={currentStep} business={business} campaignPresets={presets || []} />
```

5. Update the business data fetch to also select service_types_enabled and sms_consent_acknowledged fields. Since getBusiness() uses select('*'), this happens automatically. But the OnboardingBusiness type mapping needs to ensure these fields are available. Create a mapping if needed:
```typescript
const onboardingBusiness = business ? {
  name: business.name,
  phone: business.phone || null,
  google_review_link: business.google_review_link || null,
  software_used: business.software_used || null,
  service_types_enabled: business.service_types_enabled || null,
  sms_consent_acknowledged: business.sms_consent_acknowledged || false,
} : null
```
  </action>
  <verify>Run `pnpm typecheck` -- onboarding page and step components compile. Navigate to /onboarding?step=5 in browser -- shows placeholder step.</verify>
  <done>Step router handles cases 1-7, onboarding page clamps steps 1-7, presets fetched for step 5 using existing supabase client, Step 2 navigates forward instead of completing.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. Navigating to /onboarding shows Step 1 with business name input (phone added later in Plan 28-05)
4. Progress bar shows 1/7
5. Steps 3-7 show placeholder UI with navigation buttons
6. Step 7 "Continue" calls onComplete (redirects to dashboard)
</verification>

<success_criteria>
- Wizard supports 7-step navigation with correct progress bar
- Step 1 keeps existing business name collection (phone added by Plan 28-05 BusinessBasicsStep)
- Step 2 no longer completes onboarding (navigates to step 3)
- Steps 3-7 have placeholder UI that navigates correctly
- Onboarding page fetches campaign presets for step 5
- `pnpm typecheck` passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/28-onboarding-redesign/28-04-SUMMARY.md`
</output>
