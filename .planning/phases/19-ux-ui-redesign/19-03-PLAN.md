---
phase: 19-ux-ui-redesign
plan: 03
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - app/(dashboard)/send/page.tsx
  - components/send/quick-send-tab.tsx
  - components/send/send-settings-bar.tsx
  - components/send/message-preview.tsx
  - components/send/send-form.tsx
  - components/dashboard/quick-send.tsx
autonomous: true

must_haves:
  truths:
    - "Send page renders with Quick Send / Bulk Send tabs"
    - "Quick Send tab shows email field with search and inline contact detection"
    - "If email matches existing contact, name auto-fills"
    - "If no match, user enters name and contact auto-creates on send"
    - "Contact chips labeled Added Today show below email field"
    - "Template dropdown and schedule presets persist via localStorage"
    - "Preview section shows 2-3 lines by default, expands on click"
    - "After send: clears contact/name fields, keeps template + schedule"
    - "Send button disabled with inline message when no Google review link"
  artifacts:
    - path: "app/(dashboard)/send/page.tsx"
      provides: "Send page with tab shell"
      contains: "Tabs"
    - path: "components/send/quick-send-tab.tsx"
      provides: "Quick Send tab interface"
      exports: ["QuickSendTab"]
    - path: "components/send/send-settings-bar.tsx"
      provides: "Template + schedule preset inline bar"
      exports: ["SendSettingsBar"]
    - path: "components/send/message-preview.tsx"
      provides: "Compact/expanded preview mode"
      contains: "line-clamp"
  key_links:
    - from: "app/(dashboard)/send/page.tsx"
      to: "components/send/quick-send-tab.tsx"
      via: "Tab content rendering"
      pattern: "TabsContent.*QuickSendTab"
    - from: "components/send/quick-send-tab.tsx"
      to: "lib/actions/send"
      via: "batchSendReviewRequest server action"
      pattern: "batchSendReviewRequest"
    - from: "components/send/send-settings-bar.tsx"
      to: "localStorage"
      via: "Persisting template + schedule selections"
      pattern: "localStorage"
---

<objective>
Rebuild the Send page as a tabbed interface and implement the Quick Send tab with simplified single-recipient flow.

Purpose: The Send page becomes the app's home page (Send-first design). Quick Send is the primary tab for sending individual review requests with minimal friction: type email, auto-detect contact, pick template/schedule, send.

Output: Tabbed Send page shell, QuickSendTab component, SendSettingsBar with localStorage persistence, compact/expandable message preview.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/19-ux-ui-redesign/19-CONTEXT.md
@.planning/phases/19-ux-ui-redesign/19-RESEARCH.md
@app/(dashboard)/send/page.tsx
@components/send/send-form.tsx
@components/send/message-preview.tsx
@components/send/contact-selector.tsx
@components/dashboard/quick-send.tsx
@lib/actions/send.ts
@lib/actions/schedule.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rebuild Send Page as Tabbed Shell with Quick Send Tab</name>
  <files>
    app/(dashboard)/send/page.tsx
    components/send/quick-send-tab.tsx
    components/send/send-settings-bar.tsx
  </files>
  <action>
**Send Page (app/(dashboard)/send/page.tsx):**
- Rebuild as Server Component that fetches all data needed by both tabs
- Fetch in parallel: business, contacts (limit 200), monthlyUsage, responseRate, needsAttentionCount, recentActivity, resendReadyContacts
- Render a client wrapper component (SendPageClient) that holds the Tabs
- Use Radix Tabs component: `<Tabs defaultValue="quick-send">`
  - TabsList with 2 triggers: "Quick Send" and "Bulk Send"
  - TabsContent for "quick-send" renders `<QuickSendTab />`
  - TabsContent for "bulk-send" renders placeholder div with text "Bulk Send coming soon" (Plan 06 builds this)
- Remove the old `isTest` param handling for now (onboarding test mode will be reworked in Plan 06)
- If no Google review link: instead of redirecting to settings, pass `hasReviewLink={false}` to tabs. Quick Send handles this by disabling send button with inline message.
- Page title: "Send" (not "Send Review Request")

**QuickSendTab (components/send/quick-send-tab.tsx):**
- `'use client'` component
- Props: `contacts`, `business`, `templates`, `monthlyUsage`, `hasReviewLink`
- Layout: Single column, stacked sections
- Sections from top to bottom:
  1. **SendSettingsBar** (template + schedule) — rendered at top as a compact preset bar
  2. **Email field with search + contact detection:**
     - Input field with type="email" and search icon
     - As user types email, debounce (300ms) and search contacts by email match
     - If exact email match found: show "Existing contact: {name}" chip below input, auto-fill name (editable)
     - If no match: show name input field below email
     - After send: contact auto-created if new (pass `autoCreateContact: true` flag)
  3. **Added Today chips:** Filter contacts by `created_at >= today`, show as clickable chips labeled "Added Today"
     - Clicking a chip fills in that contact's email + name
  4. **Message Preview** (compact mode, see Task 2)
  5. **Send button area:**
     - If `hasReviewLink` is false: button disabled, show inline text "Add review link to enable sending" with link to /dashboard/settings
     - If at monthly limit: show upgrade prompt (reuse existing pattern from send-form.tsx)
     - Normal: "Send Request" button with loading state
- Send flow: Use `useTransition` + manual FormData construction (same pattern as existing quick-send.tsx)
  - Call `batchSendReviewRequest` with single contact ID
  - If new contact: first create contact via server action, then send
  - On success: use `toastSendSuccess` from lib/utils/toast.ts, clear email/name fields, keep template + schedule
  - On error: use `toastError`
- For contact auto-creation on send: create a lightweight helper in `lib/actions/contact.ts` called `findOrCreateContact({ email, name, businessId })` that checks if contact exists by email, creates if not, returns contact ID. This keeps the Quick Send flow clean.

**SendSettingsBar (components/send/send-settings-bar.tsx):**
- `'use client'` component, used by both Quick Send and Bulk Send tabs
- Horizontal bar with: Template dropdown (left) + Schedule presets (right)
- Schedule presets: 4 chips + custom
  - "Immediately" (default), "In 1 hour", "Morning (9AM)", "Custom"
  - Per CONTEXT.md: trimmed to 3 + custom (remove "24 hours" from old quick-send)
  - Custom shows datetime-local input inline
- Persistence: On template/schedule change, save to localStorage:
  - `avisloop_lastTemplate`: template ID
  - `avisloop_lastSchedule`: preset name
- On mount: read from localStorage and restore selections
- Props: `templates: EmailTemplate[]`, `onTemplateChange`, `onScheduleChange`, `selectedTemplateId`, `scheduledFor`
- Keep compact: single row on desktop, stack on mobile

**DELETE old files:**
- Delete `components/dashboard/quick-send.tsx` (replaced by QuickSendTab)
- Delete `components/send/send-form.tsx` (replaced by QuickSendTab + BulkSendTab)
- Delete `components/send/contact-selector.tsx` (Quick Send uses email field; Bulk Send will use contact table directly in Plan 06)
- Delete `components/send/batch-results.tsx` (replaced by toast + drawer pattern)
- Delete `components/send/schedule-selector.tsx` (replaced by SendSettingsBar)
  </action>
  <verify>
- `pnpm typecheck` passes
- `pnpm lint` passes
- Navigate to /send: see tabs with Quick Send active
- Type an email, see contact detection working
- Select template and schedule preset, refresh page, selections restored from localStorage
  </verify>
  <done>Send page shows Quick Send / Bulk Send tabs. Quick Send tab has email field with contact detection, Added Today chips, template + schedule bar with localStorage persistence. Old send-form.tsx, quick-send.tsx, contact-selector.tsx, batch-results.tsx, and schedule-selector.tsx deleted.</done>
</task>

<task type="auto">
  <name>Task 2: Update Message Preview with Compact/Expanded Mode</name>
  <files>
    components/send/message-preview.tsx
  </files>
  <action>
**MessagePreview compact/expanded mode:**
- Add a `compact` prop (default: `true` for Quick Send)
- When compact:
  - Show subject line + first 2-3 lines of email body using `line-clamp-3` (Tailwind)
  - Show a subtle "Show full preview" button/link at bottom
  - Click expands to full preview with smooth height transition (`transition-all duration-300`)
- When expanded:
  - Show full email preview as currently rendered
  - Show "Collapse preview" link at bottom
- Use `useState` for expanded/collapsed state
- Keep existing preview logic (template variable replacement, CTA button, signature)
- When no contact selected: show dashed border placeholder (keep existing behavior)
- Remove the inline subject/body editing (customSubject, customBody, onSubjectChange, onBodyChange props) — simplify to read-only preview. These editing features were not used meaningfully and add complexity.
- New simplified props: `contact: { name: string; email: string } | null`, `business`, `template`, `compact?: boolean`
  </action>
  <verify>
- `pnpm typecheck` passes
- Preview shows 2-3 lines in compact mode
- Clicking "Show full preview" expands to full email
- Template variables correctly substituted
  </verify>
  <done>MessagePreview supports compact mode with line-clamp-3 and smooth expand/collapse. Simplified props (removed inline editing). Works in Quick Send tab.</done>
</task>

</tasks>

<verification>
- Send page at /send shows tabbed interface
- Quick Send tab: email field, contact detection, Added Today chips, template/schedule bar, compact preview, send button
- localStorage persists template + schedule across page reloads
- No Google review link: send button disabled with inline message
- Old files deleted: quick-send.tsx, send-form.tsx, contact-selector.tsx, batch-results.tsx, schedule-selector.tsx
- `pnpm typecheck && pnpm lint` pass
</verification>

<success_criteria>
Send page is tabbed. Quick Send tab works end-to-end: type email, detect/create contact, pick template/schedule, preview message, send. Old components cleaned up. localStorage persistence works.
</success_criteria>

<output>
After completion, create `.planning/phases/19-ux-ui-redesign/19-03-SUMMARY.md`
</output>
