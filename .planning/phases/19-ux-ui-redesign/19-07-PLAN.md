---
phase: 19-ux-ui-redesign
plan: 07
type: execute
wave: 4
depends_on: ["19-05"]
files_modified:
  - components/history/request-detail-drawer.tsx
  - components/history/history-columns.tsx
  - components/history/history-table.tsx
  - components/history/history-client.tsx
  - app/(dashboard)/history/page.tsx
  - lib/actions/send.ts
autonomous: true

must_haves:
  truths:
    - "Clicking a request row opens detail drawer from right"
    - "Detail drawer shows recipient, template, sent time, status timeline, email preview"
    - "Drawer has Resend button with template/schedule options"
    - "Resend disabled with tooltip when on cooldown or opted out"
    - "Inline row resend icon on hover (desktop)"
    - "Delete/Cancel available for scheduled/pending sends only"
    - "Sent history rows are permanent (no delete)"
  artifacts:
    - path: "components/history/request-detail-drawer.tsx"
      provides: "Right-side detail drawer with full request info"
      exports: ["RequestDetailDrawer"]
    - path: "components/history/history-columns.tsx"
      provides: "Updated columns with resend action"
      contains: "resend"
  key_links:
    - from: "components/history/history-table.tsx"
      to: "components/history/request-detail-drawer.tsx"
      via: "Row click opens drawer"
      pattern: "RequestDetailDrawer"
    - from: "components/history/request-detail-drawer.tsx"
      to: "lib/actions/send"
      via: "Resend uses batchSendReviewRequest"
      pattern: "batchSendReviewRequest"
---

<objective>
Add request detail drawer and resend actions to the Requests (history) page.

Purpose: The Requests page needs inline actions for managing sent requests: viewing full details, resending, and canceling scheduled sends. The detail drawer provides a comprehensive view of each request with actionable controls.

Output: RequestDetailDrawer, updated history columns with resend action, row click behavior, delete/cancel for scheduled items.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/19-ux-ui-redesign/19-CONTEXT.md
@.planning/phases/19-ux-ui-redesign/19-RESEARCH.md
@components/history/history-table.tsx
@components/history/history-columns.tsx
@components/history/history-client.tsx
@components/history/status-badge.tsx
@components/ui/sheet.tsx
@lib/actions/send.ts
@lib/data/send-logs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Request Detail Drawer</name>
  <files>
    components/history/request-detail-drawer.tsx
  </files>
  <action>
**RequestDetailDrawer (components/history/request-detail-drawer.tsx):**
- `'use client'` component using Radix Sheet (right side, `sm:max-w-lg` for wider drawer)
- Props: `open`, `onOpenChange`, `request: SendLogWithContact | null`, `business`, `templates`, `onResend`, `onCancel`
- Content sections (scrollable):
  1. **Recipient info:** Name, email (with avatar initials)
  2. **Send details:** Template name, sent/scheduled time (formatted)
  3. **Status section:**
     - Current status badge (reuse StatusBadge)
     - Delivery events timeline (if available in request.delivery_events):
       - Vertical timeline with dots and connecting line
       - Each event: icon + label + timestamp
       - Events: Sent, Delivered, Opened, Clicked, Failed, Bounced
       - If no delivery_events, just show current status
  4. **Email preview:** Full rendered email as recipient would see it
     - Reuse MessagePreview component in expanded mode (compact: false)
     - Pass the template and contact data to render the preview
  5. **Action buttons** (footer, sticky at bottom of drawer):
     - **Resend** (primary): Opens inline mini-form with template dropdown + schedule presets
       - Pre-populated with original template
       - Uses SendSettingsBar component (from Plan 03)
       - Submit calls `batchSendReviewRequest` with single contact
       - Disabled with tooltip if: contact on cooldown ("Available in X days"), contact opted out ("Contact opted out")
       - Use `title` attribute for tooltip on disabled button
     - **Cancel** (destructive, only for status === 'scheduled' or 'pending'):
       - Shows confirmation: "Cancel this scheduled send?"
       - Calls cancel server action
     - **Copy link** (secondary): Copies the review link to clipboard

**Resend eligibility logic:**
- Check contact's `last_sent_at` against cooldown period (30 days default)
- Check `opted_out` flag
- Calculate days until resend available: `cooldownEndDate - now`
- Return: `{ canResend: boolean, reason?: string, availableIn?: string }`
  </action>
  <verify>
- `pnpm typecheck` passes
- `pnpm lint` passes
- Drawer renders all sections with correct data
- Resend disabled state shows when appropriate
- Email preview renders correctly in drawer
  </verify>
  <done>Request detail drawer shows recipient info, status timeline, email preview, and action buttons. Resend respects cooldown/opt-out. Cancel available for scheduled sends.</done>
</task>

<task type="auto">
  <name>Task 2: Update History Table with Row Actions and Drawer Integration</name>
  <files>
    components/history/history-columns.tsx
    components/history/history-table.tsx
    components/history/history-client.tsx
    app/(dashboard)/history/page.tsx
  </files>
  <action>
**Update history-columns.tsx:**
- Add an Actions column at the end:
  - On desktop: show small resend icon button on row hover (use `opacity-0 group-hover:opacity-100` on table row)
  - Icon: ArrowClockwise from Phosphor, small (16px)
  - Only shown when resend is allowed (not opted out, not on cooldown)
  - Disabled appearance with tooltip when not allowed: "Available in 12 days" or "Contact opted out"
  - For scheduled/pending rows: show Cancel (X) icon button instead
- Make the entire row clickable (except action buttons):
  - Add `onClick` handler to row that opens detail drawer
  - Style: `cursor-pointer hover:bg-muted/50`
  - Use `onRowClick` callback passed via table meta

**Update history-table.tsx:**
- Add `onRowClick: (row: SendLogWithContact) => void` prop
- Pass to table via `meta: { onRowClick }`
- Apply cursor and hover styles to TableRow
- Prevent click propagation on action buttons (stopPropagation)
- Add `group` class to TableRow for hover-based action visibility

**Update history-client.tsx:**
- Add state for selected request: `const [selectedRequest, setSelectedRequest] = useState<SendLogWithContact | null>(null)`
- Add state for drawer: `const [drawerOpen, setDrawerOpen] = useState(false)`
- Pass `onRowClick` to HistoryTable that sets selectedRequest and opens drawer
- Render `<RequestDetailDrawer>` with selectedRequest data
- Handle resend: call batchSendReviewRequest, show toastSendSuccess, refresh data via `router.refresh()`
- Handle cancel: call cancel action, show toast, refresh data

**Update history page.tsx:**
- Rename page title from "Message History" to "Requests" (metadata and heading)
- Pass business and templates data to HistoryClient (needed for drawer's resend and preview)
- Fetch business data in parallel with existing fetches
  </action>
  <verify>
- `pnpm typecheck` passes
- `pnpm lint` passes
- Click a row in history table: detail drawer opens from right
- Hover over row: resend icon visible (desktop)
- Click resend in drawer: send succeeds, toast shown
- Scheduled row: cancel button visible and functional
- Page title shows "Requests"
  </verify>
  <done>History table rows are clickable and open detail drawer. Inline resend icon on hover. Cancel for scheduled sends. Page renamed to Requests. All actions work with proper toasts.</done>
</task>

</tasks>

<verification>
- Click any row in Requests table: detail drawer opens
- Drawer shows recipient, template, status timeline, email preview, action buttons
- Resend works from drawer with template/schedule options
- Resend disabled with reason when on cooldown or opted out
- Inline resend icon on desktop row hover
- Cancel works for scheduled/pending sends
- Sent history cannot be deleted
- Page title is "Requests"
- `pnpm typecheck && pnpm lint` pass
</verification>

<success_criteria>
Requests page has clickable rows, detail drawer with full request info, resend with eligibility checks, cancel for scheduled sends, and inline row actions. Page renamed from History to Requests.
</success_criteria>

<output>
After completion, create `.planning/phases/19-ux-ui-redesign/19-07-SUMMARY.md`
</output>
