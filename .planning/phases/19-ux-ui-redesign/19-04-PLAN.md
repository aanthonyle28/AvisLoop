---
phase: 19-ux-ui-redesign
plan: 04
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - components/onboarding/setup-progress-pill.tsx
  - components/onboarding/setup-progress-drawer.tsx
  - components/layout/app-shell.tsx
  - lib/data/onboarding.ts
  - components/dashboard/onboarding-cards.tsx
  - components/dashboard/onboarding-checklist.tsx
autonomous: true

must_haves:
  truths:
    - "Collapsed state shows pill/chip in header: Complete Setup X/Y"
    - "Clicking pill opens side drawer from right with checklist"
    - "4 core steps: Add contact, Review link, Choose message, Send first request"
    - "Bonus step Try Bulk Send appears only when 3+ contacts"
    - "Each step has CTA that opens relevant action inline"
    - "Setup complete shows dismissible chip"
    - "Missing review link disables send with inline message"
  artifacts:
    - path: "components/onboarding/setup-progress-pill.tsx"
      provides: "Collapsible setup pill in header"
      exports: ["SetupProgressPill"]
    - path: "components/onboarding/setup-progress-drawer.tsx"
      provides: "Right-side drawer with checklist steps"
      exports: ["SetupProgressDrawer"]
  key_links:
    - from: "components/onboarding/setup-progress-pill.tsx"
      to: "components/onboarding/setup-progress-drawer.tsx"
      via: "Sheet open state"
      pattern: "Sheet"
    - from: "components/layout/app-shell.tsx"
      to: "components/onboarding/setup-progress-pill.tsx"
      via: "Renders pill in header area"
      pattern: "SetupProgressPill"
---

<objective>
Replace the onboarding cards grid with a collapsible setup progress pill and right-side drawer.

Purpose: The old 3-card onboarding grid takes up significant dashboard real estate. The new design reduces it to a small pill in the header that expands to a detailed checklist drawer, keeping the focus on the Send interface.

Output: SetupProgressPill (header chip), SetupProgressDrawer (right-side checklist), integrated into AppShell, old onboarding components deleted.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/19-ux-ui-redesign/19-CONTEXT.md
@.planning/phases/19-ux-ui-redesign/19-RESEARCH.md
@components/dashboard/onboarding-cards.tsx
@components/dashboard/onboarding-checklist.tsx
@lib/data/onboarding.ts
@components/ui/sheet.tsx
@components/layout/app-shell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Setup Progress Pill and Drawer</name>
  <files>
    components/onboarding/setup-progress-pill.tsx
    components/onboarding/setup-progress-drawer.tsx
  </files>
  <action>
**SetupProgressPill (components/onboarding/setup-progress-pill.tsx):**
- `'use client'` component
- Props: `completedSteps: number`, `totalSteps: number`, `isAllComplete: boolean`, `onOpenDrawer: () => void`
- When NOT all complete:
  - Renders a small pill/chip button: "Complete Setup: {completed}/{total} >"
  - Styled: `rounded-full px-3 py-1.5 text-xs font-medium bg-primary/10 text-primary border border-primary/20 hover:bg-primary/15 cursor-pointer`
  - Click calls `onOpenDrawer`
- When all complete (Phase A - immediate):
  - Shows "Setup complete" chip with checkmark icon and X dismiss button
  - Click reopens checklist drawer
  - Dismiss hides the pill (store dismissed state in localStorage: `avisloop_setupDismissed`)
- When dismissed: render nothing (pill disappears from header)

**SetupProgressDrawer (components/onboarding/setup-progress-drawer.tsx):**
- `'use client'` component
- Uses Radix Sheet (right side, wider than default: `sm:max-w-md`)
- Props: `open: boolean`, `onOpenChange`, `steps: OnboardingStep[]`, `contactCount: number`, `hasReviewLink: boolean`
- Header: "Setup Your Account" with progress bar (thin, rounded, shows X/Y completion)
- Step list (4 core steps):
  1. **Add first contact** — shows check if contact exists. CTA: "Add contact" button that links to /contacts (or opens add-contact sheet if feasible)
  2. **Set review link** — shows check if `hasReviewLink`. CTA: "Add review link" button linking to /dashboard/settings
  3. **Choose a message** — shows check if template selected/customized. CTA: "Choose template" linking to /dashboard/settings (templates section)
  4. **Send your first request** — shows check if any send completed. Sub-option: "Preview & test your message" (secondary button)
     - Test modal concept: "Send real email to me" (primary) + "Preview without sending" (secondary)
     - For now, implement as simple links: "Test" links to /send with test param, "Preview" opens message preview inline
     - Step completes if user has sent any real request (check from onboarding status)
- Bonus step (conditional):
  - **Try Bulk Send** — only shown if `contactCount >= 3`
  - Not required for "Setup complete"
  - CTA: "Try Bulk Send" links to /send and switches to Bulk Send tab
- Each step: Icon (circle with number or check), title, description, CTA button, completion state
- Completed steps: muted appearance, checkmark icon, no CTA
- Incomplete steps: prominent, numbered, active CTA

**OnboardingStep type:**
```typescript
interface OnboardingStep {
  id: string
  title: string
  description: string
  completed: boolean
  cta?: { label: string; href: string }
}
```

**Wrapper component** (can be in setup-progress-pill.tsx or separate):
- Create `SetupProgress` component that combines pill + drawer
- Manages Sheet open state internally
- Props: `steps`, `contactCount`, `hasReviewLink`, `isAllComplete`
  </action>
  <verify>
- `pnpm typecheck` passes
- `pnpm lint` passes
- Pill renders in header area when onboarding incomplete
- Clicking pill opens drawer from right
- Steps show correct completion state
- Bonus step hidden when < 3 contacts
  </verify>
  <done>Setup progress pill shows in header. Drawer opens from right with 4 core steps + conditional bonus step. Each step has CTA and completion tracking. Dismiss behavior works with localStorage.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate into App Shell and Clean Up Old Components</name>
  <files>
    components/layout/app-shell.tsx
    lib/data/onboarding.ts
    components/dashboard/onboarding-cards.tsx
    components/dashboard/onboarding-checklist.tsx
  </files>
  <action>
**AppShell integration (components/layout/app-shell.tsx):**
- AppShell needs onboarding state to render the pill. Since AppShell wraps all dashboard pages, this is the right place.
- Add props to AppShell: `onboardingSteps?: OnboardingStep[]`, `contactCount?: number`, `hasReviewLink?: boolean`, `isOnboardingComplete?: boolean`
- Render `<SetupProgress>` component inside the main content area, positioned at the top-right of the content (not inside sidebar)
- On desktop: render pill as absolutely positioned in the top-right of the main content area (or as part of a thin top bar)
- On mobile: render pill in the PageHeader component (if created by Plan 01) or at the top of content

**Update dashboard layout (app/(dashboard)/layout.tsx):**
- Fetch onboarding state in the layout Server Component (parallel with other fetches)
- Pass onboarding data to AppShell
- Use existing `getOnboardingCardStatus()` and `getOnboardingStatus()` from lib/data/onboarding.ts
- Also fetch business (for hasReviewLink) and contact count

**Update onboarding data functions (lib/data/onboarding.ts):**
- Add a new function `getSetupProgress()` that returns the step data in the new format:
  - Reads onboarding_progress from DB
  - Checks: has_contact (contacts count > 0), has_review_link (business.google_review_link exists), has_template (always true if default exists), has_sent (any send_log exists)
  - Returns `{ steps: OnboardingStep[], completedCount: number, totalCount: number, isAllComplete: boolean }`
- This replaces the card-based status checking

**DELETE old files:**
- Delete `components/dashboard/onboarding-cards.tsx` (replaced by setup-progress-drawer)
- Delete `components/dashboard/onboarding-checklist.tsx` (already deprecated, now fully replaced)
- Delete `components/dashboard/review-link-modal.tsx` (if only used by onboarding cards — check imports first)
  </action>
  <verify>
- `pnpm typecheck` passes
- `pnpm lint` passes
- `pnpm build` passes (server/client boundary correct)
- Navigate between pages: setup pill visible when onboarding incomplete
- Old onboarding-cards.tsx and onboarding-checklist.tsx deleted
  </verify>
  <done>Setup progress integrated into app shell. Onboarding state fetched in layout. Old onboarding card components deleted. Build passes.</done>
</task>

</tasks>

<verification>
- Setup progress pill visible in header on all dashboard pages when onboarding incomplete
- Clicking pill opens right-side drawer with checklist
- Steps accurately reflect onboarding state
- Bonus step (Try Bulk Send) only shown with 3+ contacts
- Setup complete shows dismissible chip
- Old onboarding components deleted
- `pnpm typecheck && pnpm lint && pnpm build` pass
</verification>

<success_criteria>
Onboarding is a collapsible pill + drawer instead of a card grid. 4 core steps with CTAs. Bonus step conditional. Dismissible completion state. Old components removed.
</success_criteria>

<output>
After completion, create `.planning/phases/19-ux-ui-redesign/19-04-SUMMARY.md`
</output>
