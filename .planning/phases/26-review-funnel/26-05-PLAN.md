---
phase: 26-review-funnel
plan: 05
type: execute
wave: 3
depends_on: ["26-02", "26-03", "26-04"]
files_modified:
  - app/r/[token]/page.tsx
  - app/r/[token]/review-flow.tsx
autonomous: true

must_haves:
  truths:
    - "Invalid/expired tokens show 404 page"
    - "Customer name and business name displayed on page"
    - "1-5 star selection works with immediate visual feedback"
    - "4-5 stars redirects to Google review link"
    - "1-3 stars shows feedback form inline"
    - "Page uses FTC-compliant language ('share your experience')"
  artifacts:
    - path: "app/r/[token]/page.tsx"
      provides: "Public review page server component"
      contains: "parseReviewToken"
      min_lines: 40
    - path: "app/r/[token]/review-flow.tsx"
      provides: "Client component orchestrating review flow"
      contains: "SatisfactionRating"
      min_lines: 80
  key_links:
    - from: "app/r/[token]/page.tsx"
      to: "lib/review/token.ts"
      via: "parseReviewToken import"
      pattern: "import.*parseReviewToken"
    - from: "app/r/[token]/review-flow.tsx"
      to: "components/review/satisfaction-rating.tsx"
      via: "SatisfactionRating import"
---

<objective>
Create the public review page at /r/[token] that handles the full review funnel flow.

Purpose: This is the customer-facing entry point from email/SMS review links. It captures satisfaction rating and routes appropriately based on stars selected.
Output: Server component for token validation and data fetching, client component for interactive flow (rating → Google redirect OR feedback form).
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-review-funnel/26-RESEARCH.md
@.planning/phases/26-review-funnel/26-02-PLAN.md
@.planning/phases/26-review-funnel/26-04-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create public review page server component</name>
  <files>app/r/[token]/page.tsx</files>
  <action>
Create app/r/[token] directory and page.tsx server component that validates token and fetches data.

```typescript
import { notFound } from 'next/navigation'
import { parseReviewToken } from '@/lib/review/token'
import { createServiceRoleClient } from '@/lib/supabase/service-role'
import { ReviewFlow } from './review-flow'
import { REVIEW_PAGE_COPY } from '@/lib/review/routing'
import type { Metadata } from 'next'

interface Props {
  params: Promise<{ token: string }>
}

export async function generateMetadata({ params }: Props): Promise<Metadata> {
  return {
    title: REVIEW_PAGE_COPY.heading,
    robots: 'noindex, nofollow', // Don't index review pages
  }
}

/**
 * Public review page - entry point from email/SMS review links.
 *
 * Flow:
 * 1. Parse and validate token (expires after 30 days)
 * 2. Fetch customer and business data
 * 3. Render interactive ReviewFlow component
 *
 * Token validation happens server-side to prevent enumeration attacks.
 * Uses service role client since this is a public (unauthenticated) page.
 */
export default async function ReviewPage({ params }: Props) {
  const { token } = await params

  // Validate token
  const tokenData = parseReviewToken(token)
  if (!tokenData) {
    console.log('Invalid or expired review token')
    notFound()
  }

  // Use service role for public page (no auth context)
  const supabase = createServiceRoleClient()

  // Fetch customer and business in parallel
  const [customerResult, businessResult] = await Promise.all([
    supabase
      .from('customers')
      .select('id, name, email')
      .eq('id', tokenData.customerId)
      .single(),
    supabase
      .from('businesses')
      .select('id, name, google_review_link')
      .eq('id', tokenData.businessId)
      .single(),
  ])

  // Handle missing data
  if (customerResult.error || !customerResult.data) {
    console.error('Customer not found:', tokenData.customerId)
    notFound()
  }

  if (businessResult.error || !businessResult.data) {
    console.error('Business not found:', tokenData.businessId)
    notFound()
  }

  const customer = customerResult.data
  const business = businessResult.data

  // Check if Google review link is configured
  const hasGoogleLink = !!business.google_review_link

  return (
    <div className="min-h-screen bg-gradient-to-b from-background to-muted/30 flex items-center justify-center p-4">
      <div className="w-full max-w-lg">
        <div className="bg-card rounded-2xl shadow-xl border p-8">
          <ReviewFlow
            token={token}
            customer={{ id: customer.id, name: customer.name }}
            business={{
              id: business.id,
              name: business.name,
              googleReviewLink: business.google_review_link,
            }}
            enrollmentId={tokenData.enrollmentId}
            hasGoogleLink={hasGoogleLink}
          />
        </div>

        {/* Footer - FTC compliance language */}
        <p className="text-center text-xs text-muted-foreground mt-6 px-4">
          {REVIEW_PAGE_COPY.footer}
        </p>
      </div>
    </div>
  )
}
```
  </action>
  <verify>
Run: `dir app\r\*\page.tsx` to confirm file exists in [token] directory.
Run: `grep -n "parseReviewToken\|notFound" app/r/*/page.tsx` to confirm token validation.
Run: `pnpm typecheck` to verify TypeScript compiles.
  </verify>
  <done>Public review page exists with token validation, customer/business data fetching, and ReviewFlow component rendering.</done>
</task>

<task type="auto">
  <name>Task 2: Create review flow client component</name>
  <files>app/r/[token]/review-flow.tsx</files>
  <action>
Create review-flow.tsx client component that orchestrates the rating → destination flow.

```typescript
'use client'

import { useState, useCallback } from 'react'
import { SatisfactionRating } from '@/components/review/satisfaction-rating'
import { FeedbackForm } from '@/components/review/feedback-form'
import { ThankYouCard, RedirectingCard } from '@/components/review/thank-you-card'
import { Button } from '@/components/ui/button'
import { getReviewDestination, REVIEW_PAGE_COPY, GOOGLE_THRESHOLD } from '@/lib/review/routing'

type FlowStep = 'rating' | 'feedback' | 'redirecting' | 'complete'

interface ReviewFlowProps {
  token: string
  customer: { id: string; name: string }
  business: { id: string; name: string; googleReviewLink: string | null }
  enrollmentId?: string
  hasGoogleLink: boolean
}

/**
 * Interactive review flow orchestrator.
 *
 * Steps:
 * 1. Rating: Show star selection
 * 2a. 4-5 stars + Google link: Show redirecting, then redirect
 * 2b. 4-5 stars + no Google link: Show thank you (no redirect possible)
 * 2c. 1-3 stars: Show feedback form
 * 3. Complete: Show thank you card
 */
export function ReviewFlow({
  token,
  customer,
  business,
  enrollmentId,
  hasGoogleLink,
}: ReviewFlowProps) {
  const [step, setStep] = useState<FlowStep>('rating')
  const [rating, setRating] = useState(0)
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)

  /**
   * Record the rating and stop enrollment if applicable.
   * Called for both Google redirect (4-5) and feedback form (1-3) paths.
   */
  const recordRatingAndStop = useCallback(async (selectedRating: number, destination: 'google' | 'feedback') => {
    try {
      const response = await fetch('/api/review/rate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          token,
          rating: selectedRating,
          destination,
        }),
      })

      if (!response.ok) {
        console.error('Failed to record rating')
        // Don't block the flow on API errors
      }
    } catch (err) {
      console.error('Rating record error:', err)
    }
  }, [token])

  /**
   * Handle rating selection and route to appropriate next step.
   */
  const handleRatingSubmit = async () => {
    if (rating === 0) return

    setIsSubmitting(true)
    setError(null)

    const destination = getReviewDestination(rating)

    // Record rating and stop enrollment
    await recordRatingAndStop(rating, destination.type)

    if (destination.type === 'google') {
      // 4-5 stars: redirect to Google
      if (hasGoogleLink && business.googleReviewLink) {
        setStep('redirecting')
        // Short delay for UX, then redirect
        setTimeout(() => {
          window.location.href = business.googleReviewLink!
        }, 1500)
      } else {
        // No Google link configured - show thank you
        setStep('complete')
      }
    } else {
      // 1-3 stars: show feedback form
      setStep('feedback')
    }

    setIsSubmitting(false)
  }

  /**
   * Handle feedback form submission success.
   */
  const handleFeedbackSuccess = () => {
    setStep('complete')
  }

  // === Render based on current step ===

  if (step === 'complete') {
    return (
      <ThankYouCard
        destination={rating >= GOOGLE_THRESHOLD ? 'google' : 'feedback'}
        businessName={business.name}
      />
    )
  }

  if (step === 'redirecting') {
    return <RedirectingCard businessName={business.name} />
  }

  if (step === 'feedback') {
    return (
      <FeedbackForm
        token={token}
        rating={rating}
        businessName={business.name}
        onSuccess={handleFeedbackSuccess}
      />
    )
  }

  // Default: rating step
  return (
    <div className="space-y-8">
      {/* Greeting */}
      <div className="text-center space-y-2">
        <h1 className="text-2xl font-bold">Hi {customer.name}!</h1>
        <p className="text-muted-foreground">{REVIEW_PAGE_COPY.heading}</p>
      </div>

      {/* Star rating */}
      <div className="py-4">
        <SatisfactionRating
          value={rating}
          onChange={setRating}
          disabled={isSubmitting}
        />
      </div>

      {/* Submit button */}
      <div className="space-y-4">
        <Button
          onClick={handleRatingSubmit}
          disabled={rating === 0 || isSubmitting}
          className="w-full"
          size="lg"
        >
          {isSubmitting ? 'Processing...' : REVIEW_PAGE_COPY.submitButton}
        </Button>

        {error && (
          <p className="text-sm text-center text-destructive" role="alert">
            {error}
          </p>
        )}
      </div>

      {/* Subheading - neutral language */}
      <p className="text-center text-sm text-muted-foreground">
        {REVIEW_PAGE_COPY.subheading}
      </p>

      {/* No Google link warning (only shown to dev/debug) */}
      {!hasGoogleLink && process.env.NODE_ENV === 'development' && (
        <p className="text-xs text-center text-amber-600">
          [Dev] Google review link not configured for this business
        </p>
      )}
    </div>
  )
}
```
  </action>
  <verify>
Run: `dir app\r\*\review-flow.tsx` to confirm file exists.
Run: `grep -n "SatisfactionRating\|FeedbackForm\|ThankYouCard" app/r/*/review-flow.tsx` to confirm component usage.
Run: `pnpm typecheck` to verify TypeScript compiles.
  </verify>
  <done>Review flow client component exists with step-based rendering: rating → (Google redirect OR feedback form) → complete, with proper state management and API calls.</done>
</task>

</tasks>

<verification>
1. Page exists: `dir app\r\*\page.tsx`
2. Flow component exists: `dir app\r\*\review-flow.tsx`
3. Token validation: `grep -n "parseReviewToken" app/r/*/page.tsx`
4. Components imported: `grep -n "SatisfactionRating\|FeedbackForm" app/r/*/review-flow.tsx`
5. FTC language used: `grep -n "REVIEW_PAGE_COPY" app/r/*/*.tsx`
6. TypeScript compiles: `pnpm typecheck`
7. Lint passes: `pnpm lint`
</verification>

<success_criteria>
- app/r/[token]/page.tsx exists with token validation and data fetching
- app/r/[token]/review-flow.tsx exists with step-based flow (rating → destination)
- Invalid tokens return 404
- 4-5 stars triggers Google redirect (if link configured)
- 1-3 stars shows feedback form inline
- FTC-compliant language used throughout (REVIEW_PAGE_COPY)
- All TypeScript compiles without errors
- Lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/26-review-funnel/26-05-SUMMARY.md`
</output>
