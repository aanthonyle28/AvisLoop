---
phase: 26-review-funnel
plan: 07
type: execute
wave: 4
depends_on: ["26-03", "26-06"]
files_modified:
  - app/(dashboard)/feedback/page.tsx
  - app/(dashboard)/feedback/loading.tsx
  - components/feedback/feedback-list.tsx
  - components/feedback/feedback-card.tsx
  - components/feedback/resolve-feedback-dialog.tsx
  - lib/actions/feedback.ts
  - components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Feedback page shows list of all private feedback"
    - "Feedback cards display customer name, rating, text, and timestamp"
    - "Unresolved feedback can be marked as resolved with optional notes"
    - "Resolved feedback shows resolution status and can be reopened"
    - "Navigation includes link to feedback page with unresolved count badge"
  artifacts:
    - path: "app/(dashboard)/feedback/page.tsx"
      provides: "Feedback dashboard page"
      contains: "getFeedbackForBusiness"
    - path: "components/feedback/feedback-list.tsx"
      provides: "Feedback list component"
      min_lines: 30
    - path: "components/feedback/feedback-card.tsx"
      provides: "Individual feedback card"
      min_lines: 40
    - path: "lib/actions/feedback.ts"
      provides: "Server actions for feedback resolution"
      exports: ["resolveFeedbackAction", "unresolveFeedbackAction"]
  key_links:
    - from: "app/(dashboard)/feedback/page.tsx"
      to: "lib/data/feedback.ts"
      via: "getFeedbackForBusiness import"
    - from: "components/layout/sidebar.tsx"
      to: "/feedback"
      via: "Navigation link"
---

<objective>
Create the feedback dashboard for business owners to view and manage private feedback from customers.

Purpose: Enables business owners to review, address, and resolve negative feedback collected through the review funnel, fulfilling the requirement for a "response workflow."
Output: Dashboard page with feedback list, resolution dialog, server actions, and navigation integration.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-review-funnel/26-RESEARCH.md
@.planning/phases/26-review-funnel/26-03-PLAN.md
@components/layout/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feedback server actions</name>
  <files>lib/actions/feedback.ts</files>
  <action>
Create lib/actions/feedback.ts with server actions for resolving and unresolving feedback.

```typescript
'use server'

import { revalidatePath } from 'next/cache'
import { createClient } from '@/lib/supabase/server'
import { resolveFeedbackSchema } from '@/lib/validations/feedback'
import { z } from 'zod'

/**
 * Mark feedback as resolved with optional internal notes.
 * Revalidates the feedback page after success.
 */
export async function resolveFeedbackAction(
  formData: FormData
): Promise<{ success: boolean; error?: string }> {
  try {
    const supabase = await createClient()

    // Get current user
    const {
      data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
      return { success: false, error: 'Not authenticated' }
    }

    // Parse and validate input
    const id = formData.get('id') as string
    const internalNotes = formData.get('internal_notes') as string | null

    const validated = resolveFeedbackSchema.parse({
      id,
      internal_notes: internalNotes || undefined,
    })

    // Update feedback (RLS ensures user owns the business)
    const { error } = await supabase
      .from('customer_feedback')
      .update({
        resolved_at: new Date().toISOString(),
        resolved_by: user.id,
        internal_notes: validated.internal_notes || null,
      })
      .eq('id', validated.id)

    if (error) {
      console.error('Resolve feedback error:', error)
      return { success: false, error: 'Failed to resolve feedback' }
    }

    revalidatePath('/feedback')
    return { success: true }
  } catch (error) {
    if (error instanceof z.ZodError) {
      return { success: false, error: error.errors[0]?.message || 'Invalid input' }
    }
    console.error('Resolve feedback action error:', error)
    return { success: false, error: 'Something went wrong' }
  }
}

/**
 * Reopen resolved feedback for follow-up.
 */
export async function unresolveFeedbackAction(
  feedbackId: string
): Promise<{ success: boolean; error?: string }> {
  try {
    const supabase = await createClient()

    // Get current user
    const {
      data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
      return { success: false, error: 'Not authenticated' }
    }

    // Update feedback (RLS ensures user owns the business)
    const { error } = await supabase
      .from('customer_feedback')
      .update({
        resolved_at: null,
        resolved_by: null,
      })
      .eq('id', feedbackId)

    if (error) {
      console.error('Unresolve feedback error:', error)
      return { success: false, error: 'Failed to reopen feedback' }
    }

    revalidatePath('/feedback')
    return { success: true }
  } catch (error) {
    console.error('Unresolve feedback action error:', error)
    return { success: false, error: 'Something went wrong' }
  }
}
```
  </action>
  <verify>
Run: `dir lib\actions\feedback.ts` to confirm file exists.
Run: `grep -n "resolveFeedbackAction\|unresolveFeedbackAction" lib/actions/feedback.ts` to confirm exports.
Run: `pnpm typecheck` to verify TypeScript compiles.
  </verify>
  <done>Feedback server actions exist with resolveFeedbackAction (marks resolved with notes) and unresolveFeedbackAction (reopens feedback).</done>
</task>

<task type="auto">
  <name>Task 2: Create feedback components</name>
  <files>components/feedback/feedback-card.tsx, components/feedback/feedback-list.tsx, components/feedback/resolve-feedback-dialog.tsx</files>
  <action>
Create components/feedback directory with feedback-card.tsx, feedback-list.tsx, and resolve-feedback-dialog.tsx.

**feedback-card.tsx:**
```typescript
'use client'

import { useState } from 'react'
import { formatDistanceToNow } from 'date-fns'
import { Star, Check, RotateCcw, Mail } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'
import type { FeedbackWithCustomer } from '@/lib/types/feedback'
import { ResolveFeedbackDialog } from './resolve-feedback-dialog'
import { unresolveFeedbackAction } from '@/lib/actions/feedback'

interface FeedbackCardProps {
  feedback: FeedbackWithCustomer
}

export function FeedbackCard({ feedback }: FeedbackCardProps) {
  const [isResolveOpen, setIsResolveOpen] = useState(false)
  const [isLoading, setIsLoading] = useState(false)

  const isResolved = !!feedback.resolved_at

  const handleUnresolve = async () => {
    setIsLoading(true)
    await unresolveFeedbackAction(feedback.id)
    setIsLoading(false)
  }

  return (
    <div
      className={cn(
        'bg-card border rounded-lg p-5 transition-all',
        isResolved ? 'border-muted bg-muted/30' : 'border-border'
      )}
    >
      {/* Header */}
      <div className="flex items-start justify-between gap-4 mb-4">
        <div>
          <h3 className="font-medium">{feedback.customer.name}</h3>
          <p className="text-sm text-muted-foreground">{feedback.customer.email}</p>
        </div>

        <div className="flex items-center gap-1">
          {[1, 2, 3, 4, 5].map((star) => (
            <Star
              key={star}
              className={cn(
                'w-4 h-4',
                star <= feedback.rating
                  ? 'text-yellow-400 fill-yellow-400'
                  : 'text-muted-foreground/30'
              )}
            />
          ))}
        </div>
      </div>

      {/* Feedback text */}
      {feedback.feedback_text && (
        <p className="text-sm mb-4 whitespace-pre-wrap">{feedback.feedback_text}</p>
      )}

      {/* Internal notes (if resolved) */}
      {isResolved && feedback.internal_notes && (
        <div className="bg-muted/50 rounded-md p-3 mb-4 text-sm">
          <p className="font-medium text-xs text-muted-foreground mb-1">Internal notes:</p>
          <p>{feedback.internal_notes}</p>
        </div>
      )}

      {/* Footer */}
      <div className="flex items-center justify-between text-sm">
        <span className="text-muted-foreground">
          {formatDistanceToNow(new Date(feedback.submitted_at), { addSuffix: true })}
        </span>

        <div className="flex items-center gap-2">
          {/* Email customer button */}
          <Button variant="ghost" size="sm" asChild>
            <a href={`mailto:${feedback.customer.email}`}>
              <Mail className="w-4 h-4 mr-1" />
              Email
            </a>
          </Button>

          {isResolved ? (
            <Button
              variant="ghost"
              size="sm"
              onClick={handleUnresolve}
              disabled={isLoading}
            >
              <RotateCcw className="w-4 h-4 mr-1" />
              Reopen
            </Button>
          ) : (
            <Button
              variant="outline"
              size="sm"
              onClick={() => setIsResolveOpen(true)}
            >
              <Check className="w-4 h-4 mr-1" />
              Mark Resolved
            </Button>
          )}
        </div>
      </div>

      {/* Resolve status indicator */}
      {isResolved && (
        <div className="mt-3 pt-3 border-t border-muted text-xs text-muted-foreground">
          ✓ Resolved {formatDistanceToNow(new Date(feedback.resolved_at!), { addSuffix: true })}
        </div>
      )}

      <ResolveFeedbackDialog
        feedbackId={feedback.id}
        customerName={feedback.customer.name}
        open={isResolveOpen}
        onOpenChange={setIsResolveOpen}
      />
    </div>
  )
}
```

**feedback-list.tsx:**
```typescript
import type { FeedbackWithCustomer } from '@/lib/types/feedback'
import { FeedbackCard } from './feedback-card'
import { MessageSquare } from 'lucide-react'

interface FeedbackListProps {
  feedback: FeedbackWithCustomer[]
  emptyMessage?: string
}

export function FeedbackList({ feedback, emptyMessage }: FeedbackListProps) {
  if (feedback.length === 0) {
    return (
      <div className="text-center py-12 px-4">
        <MessageSquare className="w-12 h-12 mx-auto text-muted-foreground/50 mb-4" />
        <h3 className="text-lg font-medium mb-1">No feedback yet</h3>
        <p className="text-muted-foreground text-sm">
          {emptyMessage || 'Customer feedback from the review funnel will appear here.'}
        </p>
      </div>
    )
  }

  return (
    <div className="space-y-4">
      {feedback.map((item) => (
        <FeedbackCard key={item.id} feedback={item} />
      ))}
    </div>
  )
}
```

**resolve-feedback-dialog.tsx:**
```typescript
'use client'

import { useRef, useState } from 'react'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { resolveFeedbackAction } from '@/lib/actions/feedback'

interface ResolveFeedbackDialogProps {
  feedbackId: string
  customerName: string
  open: boolean
  onOpenChange: (open: boolean) => void
}

export function ResolveFeedbackDialog({
  feedbackId,
  customerName,
  open,
  onOpenChange,
}: ResolveFeedbackDialogProps) {
  const formRef = useRef<HTMLFormElement>(null)
  const [isLoading, setIsLoading] = useState(false)

  const handleSubmit = async (formData: FormData) => {
    setIsLoading(true)
    const result = await resolveFeedbackAction(formData)
    setIsLoading(false)

    if (result.success) {
      onOpenChange(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Resolve Feedback</DialogTitle>
        </DialogHeader>

        <form ref={formRef} action={handleSubmit}>
          <input type="hidden" name="id" value={feedbackId} />

          <div className="space-y-4 py-4">
            <p className="text-sm text-muted-foreground">
              Mark feedback from <strong>{customerName}</strong> as resolved.
            </p>

            <div>
              <label htmlFor="internal_notes" className="text-sm font-medium">
                Internal notes (optional)
              </label>
              <textarea
                id="internal_notes"
                name="internal_notes"
                rows={3}
                placeholder="How was this resolved? (not visible to customer)"
                className="w-full mt-1.5 px-3 py-2 rounded-md border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary"
              />
            </div>
          </div>

          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
              disabled={isLoading}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={isLoading}>
              {isLoading ? 'Resolving...' : 'Mark Resolved'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```
  </action>
  <verify>
Run: `dir components\feedback\*.tsx` to confirm all three files exist.
Run: `grep -n "FeedbackCard\|FeedbackList\|ResolveFeedbackDialog" components/feedback/*.tsx` to confirm exports.
Run: `pnpm typecheck` to verify TypeScript compiles.
  </verify>
  <done>Feedback components exist: FeedbackCard (displays feedback with resolve/unresolve), FeedbackList (renders cards with empty state), and ResolveFeedbackDialog (modal for adding notes).</done>
</task>

<task type="auto">
  <name>Task 3: Create feedback dashboard page</name>
  <files>app/(dashboard)/feedback/page.tsx, app/(dashboard)/feedback/loading.tsx</files>
  <action>
Create app/(dashboard)/feedback directory with page.tsx and loading.tsx.

**page.tsx:**
```typescript
import { redirect } from 'next/navigation'
import { createClient } from '@/lib/supabase/server'
import { getFeedbackForBusiness, getFeedbackStats } from '@/lib/data/feedback'
import { FeedbackList } from '@/components/feedback/feedback-list'
import { MessageSquare } from 'lucide-react'
import type { Metadata } from 'next'

export const metadata: Metadata = {
  title: 'Feedback | AvisLoop',
}

export default async function FeedbackPage() {
  const supabase = await createClient()

  // Get current user
  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login')
  }

  // Get user's business
  const { data: business } = await supabase
    .from('businesses')
    .select('id')
    .eq('user_id', user.id)
    .single()

  if (!business) {
    redirect('/onboarding')
  }

  // Fetch feedback and stats
  const [feedbackResult, stats] = await Promise.all([
    getFeedbackForBusiness(business.id, { resolved: undefined }, 1, 50),
    getFeedbackStats(business.id),
  ])

  return (
    <div className="container py-8 max-w-4xl">
      {/* Header */}
      <div className="mb-8">
        <div className="flex items-center gap-3 mb-2">
          <MessageSquare className="w-6 h-6" />
          <h1 className="text-2xl font-bold">Customer Feedback</h1>
        </div>
        <p className="text-muted-foreground">
          Private feedback from customers collected through your review funnel.
        </p>
      </div>

      {/* Stats */}
      {stats.total > 0 && (
        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
          <div className="bg-card border rounded-lg p-4">
            <p className="text-sm text-muted-foreground">Total</p>
            <p className="text-2xl font-semibold">{stats.total}</p>
          </div>
          <div className="bg-card border rounded-lg p-4">
            <p className="text-sm text-muted-foreground">Unresolved</p>
            <p className="text-2xl font-semibold text-amber-600">{stats.unresolved}</p>
          </div>
          <div className="bg-card border rounded-lg p-4">
            <p className="text-sm text-muted-foreground">Resolved</p>
            <p className="text-2xl font-semibold text-green-600">{stats.total - stats.unresolved}</p>
          </div>
          <div className="bg-card border rounded-lg p-4">
            <p className="text-sm text-muted-foreground">Avg Rating</p>
            <p className="text-2xl font-semibold">{stats.averageRating.toFixed(1)} ⭐</p>
          </div>
        </div>
      )}

      {/* Feedback list */}
      <FeedbackList
        feedback={feedbackResult.data}
        emptyMessage="When customers share feedback through your review funnel, it will appear here."
      />
    </div>
  )
}
```

**loading.tsx:**
```typescript
import { Skeleton } from '@/components/ui/skeleton'

export default function FeedbackLoading() {
  return (
    <div className="container py-8 max-w-4xl">
      <div className="mb-8">
        <Skeleton className="h-8 w-48 mb-2" />
        <Skeleton className="h-4 w-80" />
      </div>

      <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
        {[...Array(4)].map((_, i) => (
          <Skeleton key={i} className="h-20 rounded-lg" />
        ))}
      </div>

      <div className="space-y-4">
        {[...Array(3)].map((_, i) => (
          <Skeleton key={i} className="h-40 rounded-lg" />
        ))}
      </div>
    </div>
  )
}
```
  </action>
  <verify>
Run: `dir app\(dashboard)\feedback\*.tsx` to confirm files exist.
Run: `grep -n "getFeedbackForBusiness\|FeedbackList" app/(dashboard)/feedback/page.tsx` to confirm data fetching and component usage.
Run: `pnpm typecheck` to verify TypeScript compiles.
  </verify>
  <done>Feedback dashboard page exists with stats display (total, unresolved, resolved, avg rating), feedback list, and loading skeleton.</done>
</task>

<task type="auto">
  <name>Task 4: Add feedback to navigation</name>
  <files>components/layout/sidebar.tsx</files>
  <action>
Update components/layout/sidebar.tsx to include Feedback link with unresolved count badge.

Find the navigation items array and add a Feedback entry. Import MessageSquare from lucide-react if not already imported.

Add the following to the navigation items (after History or similar):

```typescript
{
  name: 'Feedback',
  href: '/feedback',
  icon: MessageSquare,
},
```

Note: The unresolved count badge will be added in Phase 27 (Dashboard Redesign) when we implement the needs-attention system. For now, just add the static link.

Ensure MessageSquare is imported from lucide-react.
  </action>
  <verify>
Run: `grep -n "Feedback\|/feedback" components/layout/sidebar.tsx` to confirm link added.
Run: `pnpm typecheck` to verify TypeScript compiles.
  </verify>
  <done>Navigation sidebar includes Feedback link at /feedback with MessageSquare icon.</done>
</task>

</tasks>

<verification>
1. Actions file exists: `dir lib\actions\feedback.ts`
2. Components exist: `dir components\feedback\*.tsx`
3. Page exists: `dir app\(dashboard)\feedback\page.tsx`
4. Loading exists: `dir app\(dashboard)\feedback\loading.tsx`
5. Navigation updated: `grep -n "/feedback" components/layout/sidebar.tsx`
6. TypeScript compiles: `pnpm typecheck`
7. Lint passes: `pnpm lint`
</verification>

<success_criteria>
- lib/actions/feedback.ts exists with resolveFeedbackAction and unresolveFeedbackAction
- components/feedback/*.tsx exists with FeedbackCard, FeedbackList, ResolveFeedbackDialog
- app/(dashboard)/feedback/page.tsx exists with stats and feedback list
- app/(dashboard)/feedback/loading.tsx exists with skeleton
- components/layout/sidebar.tsx includes /feedback link
- All TypeScript compiles without errors
- Lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/26-review-funnel/26-07-SUMMARY.md`
</output>
