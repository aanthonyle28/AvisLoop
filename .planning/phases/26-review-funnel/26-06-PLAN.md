---
phase: 26-review-funnel
plan: 06
type: execute
wave: 3
depends_on: ["26-01", "26-02", "26-03"]
files_modified:
  - app/api/review/rate/route.ts
  - app/api/feedback/route.ts
autonomous: true

must_haves:
  truths:
    - "Rating API validates token and records interaction"
    - "Rating API stops campaign enrollment when enrollmentId present"
    - "Feedback API validates token and stores feedback in database"
    - "Feedback API sends email notification to business owner"
    - "Both APIs use service role client for public access"
  artifacts:
    - path: "app/api/review/rate/route.ts"
      provides: "Rating submission endpoint"
      exports: ["POST"]
      contains: "parseReviewToken"
    - path: "app/api/feedback/route.ts"
      provides: "Feedback submission endpoint"
      exports: ["POST"]
      contains: "createFeedback"
  key_links:
    - from: "app/api/feedback/route.ts"
      to: "lib/email/resend.ts"
      via: "Email notification"
      pattern: "Resend"
    - from: "app/api/review/rate/route.ts"
      to: "campaign_enrollments"
      via: "Stop enrollment on review click"
      pattern: "campaign_enrollments"
---

<objective>
Create API routes for rating submission (with enrollment stop) and feedback submission (with owner notification).

Purpose: Provides backend endpoints for the review flow - recording interactions, stopping campaigns, storing feedback, and notifying business owners.
Output: Two API routes using service role client for public access with proper validation and error handling.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-review-funnel/26-RESEARCH.md
@.planning/phases/26-review-funnel/26-02-PLAN.md
@.planning/phases/26-review-funnel/26-03-PLAN.md
@app/api/webhooks/resend/route.ts
@lib/email/resend.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rating submission API route</name>
  <files>app/api/review/rate/route.ts</files>
  <action>
Create app/api/review/rate directory and route.ts for recording rating and stopping campaign.

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@supabase/supabase-js'
import { parseReviewToken } from '@/lib/review/token'
import { z } from 'zod'

// Use service role for public endpoint (no user context)
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
)

const ratingSchema = z.object({
  token: z.string().min(1),
  rating: z.number().int().min(1).max(5),
  destination: z.enum(['google', 'feedback']),
})

/**
 * POST /api/review/rate
 *
 * Records the customer's rating selection and stops campaign enrollment.
 * Called when customer submits their rating (before redirect or feedback form).
 *
 * This endpoint:
 * 1. Validates the review token
 * 2. Stops any active campaign enrollment (prevents further touches)
 * 3. Returns success (rating is logged but not stored separately - feedback is stored in /api/feedback)
 *
 * Note: For 4-5 star ratings going to Google, this is our only record.
 * For 1-3 star ratings, the feedback will be stored via /api/feedback.
 */
export async function POST(req: NextRequest) {
  try {
    const body = await req.json()
    const validated = ratingSchema.parse(body)

    // Validate token
    const tokenData = parseReviewToken(validated.token)
    if (!tokenData) {
      return NextResponse.json({ error: 'Invalid or expired token' }, { status: 400 })
    }

    // Verify customer and business exist
    const [customerCheck, businessCheck] = await Promise.all([
      supabase.from('customers').select('id').eq('id', tokenData.customerId).single(),
      supabase.from('businesses').select('id').eq('id', tokenData.businessId).single(),
    ])

    if (customerCheck.error || businessCheck.error) {
      return NextResponse.json({ error: 'Invalid token data' }, { status: 400 })
    }

    // Stop campaign enrollment if present
    if (tokenData.enrollmentId) {
      const stopReason = validated.destination === 'google' ? 'review_clicked' : 'feedback_submitted'

      const { error: stopError } = await supabase
        .from('campaign_enrollments')
        .update({
          status: 'stopped',
          stop_reason: stopReason,
          stopped_at: new Date().toISOString(),
        })
        .eq('id', tokenData.enrollmentId)
        .eq('status', 'active') // Only stop if still active

      if (stopError) {
        console.error('Failed to stop enrollment:', stopError)
        // Don't fail the request - enrollment stop is secondary
      } else {
        console.log(`Stopped enrollment ${tokenData.enrollmentId} - ${stopReason}`)
      }
    }

    // Log the interaction (for analytics, could expand later)
    console.log('Review rating recorded:', {
      customerId: tokenData.customerId,
      businessId: tokenData.businessId,
      rating: validated.rating,
      destination: validated.destination,
      enrollmentId: tokenData.enrollmentId || 'none',
    })

    return NextResponse.json({ success: true })
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: 'Invalid request', details: error.errors },
        { status: 400 }
      )
    }

    console.error('Rating submission error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```
  </action>
  <verify>
Run: `dir app\api\review\rate\route.ts` to confirm file exists.
Run: `grep -n "parseReviewToken\|campaign_enrollments" app/api/review/rate/route.ts` to confirm token and enrollment logic.
Run: `pnpm typecheck` to verify TypeScript compiles.
  </verify>
  <done>Rating API route exists with token validation, enrollment stop logic (review_clicked or feedback_submitted), and proper error handling.</done>
</task>

<task type="auto">
  <name>Task 2: Create feedback submission API route</name>
  <files>app/api/feedback/route.ts</files>
  <action>
Create app/api/feedback directory and route.ts for storing feedback and notifying owner.

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@supabase/supabase-js'
import { Resend } from 'resend'
import { parseReviewToken } from '@/lib/review/token'
import { feedbackSchema } from '@/lib/validations/feedback'
import { z } from 'zod'

// Use service role for public endpoint (no user context)
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
)

const resend = new Resend(process.env.RESEND_API_KEY || 'placeholder')

/**
 * POST /api/feedback
 *
 * Stores private feedback from customers who rated 1-3 stars.
 * Also sends email notification to business owner.
 *
 * This endpoint:
 * 1. Validates the review token
 * 2. Stores feedback in customer_feedback table
 * 3. Stops campaign enrollment if present
 * 4. Sends notification email to business owner
 */
export async function POST(req: NextRequest) {
  try {
    const body = await req.json()
    const validated = feedbackSchema.parse(body)

    // Validate token
    const tokenData = parseReviewToken(validated.token)
    if (!tokenData) {
      return NextResponse.json({ error: 'Invalid or expired token' }, { status: 400 })
    }

    // Fetch customer and business data
    const [customerResult, businessResult] = await Promise.all([
      supabase
        .from('customers')
        .select('id, name, email')
        .eq('id', tokenData.customerId)
        .single(),
      supabase
        .from('businesses')
        .select('id, name, user_id')
        .eq('id', tokenData.businessId)
        .single(),
    ])

    if (customerResult.error || !customerResult.data) {
      return NextResponse.json({ error: 'Customer not found' }, { status: 404 })
    }

    if (businessResult.error || !businessResult.data) {
      return NextResponse.json({ error: 'Business not found' }, { status: 404 })
    }

    const customer = customerResult.data
    const business = businessResult.data

    // Insert feedback
    const { data: feedback, error: insertError } = await supabase
      .from('customer_feedback')
      .insert({
        business_id: tokenData.businessId,
        customer_id: tokenData.customerId,
        enrollment_id: tokenData.enrollmentId || null,
        rating: validated.rating,
        feedback_text: validated.feedback_text || null,
      })
      .select()
      .single()

    if (insertError) {
      console.error('Feedback insert error:', insertError)
      return NextResponse.json({ error: 'Failed to save feedback' }, { status: 500 })
    }

    // Stop campaign enrollment if present
    if (tokenData.enrollmentId) {
      const { error: stopError } = await supabase
        .from('campaign_enrollments')
        .update({
          status: 'stopped',
          stop_reason: 'feedback_submitted',
          stopped_at: new Date().toISOString(),
        })
        .eq('id', tokenData.enrollmentId)
        .eq('status', 'active')

      if (stopError) {
        console.error('Failed to stop enrollment on feedback:', stopError)
      } else {
        console.log(`Stopped enrollment ${tokenData.enrollmentId} - feedback submitted`)
      }
    }

    // Get business owner's email
    const { data: ownerData } = await supabase.auth.admin.getUserById(business.user_id)
    const ownerEmail = ownerData?.user?.email

    // Send notification email to owner
    if (ownerEmail && process.env.RESEND_API_KEY) {
      try {
        const dashboardUrl = `${process.env.NEXT_PUBLIC_SITE_URL}/dashboard/feedback`

        await resend.emails.send({
          from: 'AvisLoop <notifications@avisloop.com>',
          to: ownerEmail,
          subject: `New feedback from ${customer.name} (${validated.rating} ⭐)`,
          html: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { background: #f8f9fa; padding: 20px; border-radius: 8px 8px 0 0; }
    .content { background: #fff; padding: 20px; border: 1px solid #e9ecef; border-top: none; }
    .footer { background: #f8f9fa; padding: 15px 20px; border-radius: 0 0 8px 8px; font-size: 14px; color: #6c757d; }
    .rating { font-size: 24px; margin: 10px 0; }
    .feedback-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
    .btn { display: inline-block; background: #0070f3; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; margin-top: 15px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2 style="margin: 0;">New Customer Feedback</h2>
    </div>
    <div class="content">
      <p><strong>Customer:</strong> ${customer.name} (${customer.email})</p>
      <p><strong>Rating:</strong></p>
      <div class="rating">${'⭐'.repeat(validated.rating)}${'☆'.repeat(5 - validated.rating)}</div>

      ${validated.feedback_text ? `
      <p><strong>Feedback:</strong></p>
      <div class="feedback-box">
        ${validated.feedback_text.replace(/\n/g, '<br>')}
      </div>
      ` : '<p><em>No additional comments provided.</em></p>'}

      <p>This feedback was submitted through your review funnel. You can respond to the customer directly or mark this as resolved in your dashboard.</p>

      <a href="${dashboardUrl}" class="btn">View in Dashboard</a>
    </div>
    <div class="footer">
      <p>This notification was sent by AvisLoop. You're receiving this because you have a business account with review funnel enabled.</p>
    </div>
  </div>
</body>
</html>
          `,
        })

        console.log(`Notification sent to ${ownerEmail} for feedback ${feedback.id}`)
      } catch (emailError) {
        console.error('Failed to send notification email:', emailError)
        // Don't fail the request - email is secondary
      }
    }

    return NextResponse.json({ success: true, feedbackId: feedback.id })
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: 'Invalid request', details: error.errors },
        { status: 400 }
      )
    }

    console.error('Feedback submission error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```
  </action>
  <verify>
Run: `dir app\api\feedback\route.ts` to confirm file exists.
Run: `grep -n "customer_feedback\|resend.emails.send" app/api/feedback/route.ts` to confirm feedback insert and email send.
Run: `pnpm typecheck` to verify TypeScript compiles.
  </verify>
  <done>Feedback API route exists with token validation, database insert, enrollment stop, and Resend email notification to business owner with styled HTML email.</done>
</task>

</tasks>

<verification>
1. Rating route exists: `dir app\api\review\rate\route.ts`
2. Feedback route exists: `dir app\api\feedback\route.ts`
3. Rating stops enrollment: `grep -n "campaign_enrollments" app/api/review/rate/route.ts`
4. Feedback sends email: `grep -n "resend.emails.send" app/api/feedback/route.ts`
5. TypeScript compiles: `pnpm typecheck`
6. Lint passes: `pnpm lint`
</verification>

<success_criteria>
- app/api/review/rate/route.ts exists with token validation and enrollment stop
- app/api/feedback/route.ts exists with feedback insert and owner notification
- Both routes use service role client for public access
- Rating API uses stop_reason: 'review_clicked' or 'feedback_submitted'
- Feedback API sends styled HTML email to business owner
- All TypeScript compiles without errors
- Lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/26-review-funnel/26-06-SUMMARY.md`
</output>
