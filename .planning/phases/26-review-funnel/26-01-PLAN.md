---
phase: 26-review-funnel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260204_create_customer_feedback.sql
  - docs/DATA_MODEL.md
autonomous: true

must_haves:
  truths:
    - "customer_feedback table exists with rating, feedback_text, and resolution fields"
    - "RLS policies allow authenticated users to view/update their business feedback"
    - "RLS policy allows anonymous users to insert feedback (validated via token in API)"
    - "Indexes support fast unresolved feedback queries"
  artifacts:
    - path: "supabase/migrations/20260204_create_customer_feedback.sql"
      provides: "Feedback storage schema"
      contains: "CREATE TABLE IF NOT EXISTS public.customer_feedback"
    - path: "docs/DATA_MODEL.md"
      provides: "Feedback schema documentation"
      contains: "## Table: customer_feedback"
  key_links:
    - from: "customer_feedback.business_id"
      to: "businesses.id"
      via: "FOREIGN KEY CASCADE"
    - from: "customer_feedback.customer_id"
      to: "customers.id"
      via: "FOREIGN KEY CASCADE"
    - from: "customer_feedback.enrollment_id"
      to: "campaign_enrollments.id"
      via: "FOREIGN KEY SET NULL"
---

<objective>
Create the customer_feedback database table for storing private feedback from 1-3 star ratings.

Purpose: Provides persistent storage for negative feedback with resolution tracking, enabling business owners to address concerns privately.
Output: Migration file creating customer_feedback table with RLS policies, indexes, and documentation.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-review-funnel/26-RESEARCH.md
@docs/DATA_MODEL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create customer_feedback table migration</name>
  <files>supabase/migrations/20260204_create_customer_feedback.sql</files>
  <action>
Create migration file with the following schema:

```sql
-- Create customer_feedback table for storing private feedback from 1-3 star ratings
-- Phase 26: Review Funnel

CREATE TABLE IF NOT EXISTS public.customer_feedback (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_id UUID NOT NULL REFERENCES public.businesses(id) ON DELETE CASCADE,
  customer_id UUID NOT NULL REFERENCES public.customers(id) ON DELETE CASCADE,
  enrollment_id UUID REFERENCES public.campaign_enrollments(id) ON DELETE SET NULL,

  -- Rating and feedback
  rating INT NOT NULL,
  feedback_text TEXT,

  -- Timestamps
  submitted_at TIMESTAMPTZ DEFAULT NOW(),

  -- Resolution workflow
  resolved_at TIMESTAMPTZ,
  resolved_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  internal_notes TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- Constraints
  CONSTRAINT feedback_rating_valid CHECK (rating BETWEEN 1 AND 5)
);

-- Indexes
CREATE INDEX idx_feedback_business_id ON public.customer_feedback(business_id);
CREATE INDEX idx_feedback_customer_id ON public.customer_feedback(customer_id);
CREATE INDEX idx_feedback_enrollment_id ON public.customer_feedback(enrollment_id);

-- Partial index for fast unresolved feedback queries
CREATE INDEX idx_feedback_unresolved
  ON public.customer_feedback(business_id, submitted_at DESC)
  WHERE resolved_at IS NULL;

-- RLS
ALTER TABLE public.customer_feedback ENABLE ROW LEVEL SECURITY;

-- Users can view feedback for their own businesses
CREATE POLICY "Users view own feedback"
  ON public.customer_feedback FOR SELECT
  TO authenticated
  USING (business_id IN (SELECT id FROM public.businesses WHERE user_id = auth.uid()));

-- Anonymous users can insert feedback (token validation happens in API route)
CREATE POLICY "Public insert feedback"
  ON public.customer_feedback FOR INSERT
  TO anon, authenticated
  WITH CHECK (true);

-- Users can update their own feedback (for resolution)
CREATE POLICY "Users update own feedback"
  ON public.customer_feedback FOR UPDATE
  TO authenticated
  USING (business_id IN (SELECT id FROM public.businesses WHERE user_id = auth.uid()));

-- Trigger for updated_at
CREATE TRIGGER customer_feedback_updated_at
  BEFORE UPDATE ON public.customer_feedback
  FOR EACH ROW
  EXECUTE FUNCTION moddatetime(updated_at);

COMMENT ON TABLE public.customer_feedback IS 'Stores private feedback from 1-3 star satisfaction ratings. Phase 26 Review Funnel.';
```
  </action>
  <verify>
Run: `dir supabase\migrations\*customer_feedback*` to confirm file exists.
Check file contains: CREATE TABLE, CHECK constraint, RLS enabled, four policies.
  </verify>
  <done>Migration file exists with customer_feedback table, rating constraint (1-5), four RLS policies, indexes including partial index for unresolved queries, and moddatetime trigger.</done>
</task>

<task type="auto">
  <name>Task 2: Document customer_feedback schema in DATA_MODEL.md</name>
  <files>docs/DATA_MODEL.md</files>
  <action>
Add documentation section for customer_feedback table to docs/DATA_MODEL.md. Append after the "Table: send_logs (Campaign Extensions)" section.

Add the following documentation:

```markdown
## Table: customer_feedback

Stores private feedback from customers who rate their experience 1-3 stars in the review funnel. Added in Phase 26.

### Schema

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | UUID | NO | gen_random_uuid() | Primary key |
| business_id | UUID | NO | - | FK to businesses |
| customer_id | UUID | NO | - | FK to customers |
| enrollment_id | UUID | YES | - | FK to campaign_enrollments (NULL for non-campaign) |
| rating | INT | NO | - | Satisfaction rating (1-5) |
| feedback_text | TEXT | YES | - | Customer's written feedback |
| submitted_at | TIMESTAMPTZ | YES | NOW() | When feedback was submitted |
| resolved_at | TIMESTAMPTZ | YES | - | When business resolved the feedback |
| resolved_by | UUID | YES | - | User who resolved the feedback |
| internal_notes | TEXT | YES | - | Business owner's internal notes |
| created_at | TIMESTAMPTZ | YES | NOW() | Created timestamp |
| updated_at | TIMESTAMPTZ | YES | NOW() | Updated timestamp |

### Purpose

The review funnel routes 1-3 star ratings to a private feedback form instead of Google reviews. This table:
- Stores negative feedback privately (no public review)
- Links feedback to campaign enrollment for stop conditions
- Tracks resolution status for follow-up workflow
- Enables email notifications to business owner

### Constraints

- `rating BETWEEN 1 AND 5` - Valid star ratings only

### RLS Policies

- SELECT: Users can view feedback for businesses they own
- INSERT: Anonymous and authenticated users can insert (token validated in API route)
- UPDATE: Users can update feedback for businesses they own (for resolution)

### Indexes

- idx_feedback_business_id (btree)
- idx_feedback_customer_id (btree)
- idx_feedback_enrollment_id (btree)
- idx_feedback_unresolved (partial: WHERE resolved_at IS NULL on business_id, submitted_at DESC)

### Foreign Keys

- customer_feedback.business_id references businesses.id (CASCADE)
- customer_feedback.customer_id references customers.id (CASCADE)
- customer_feedback.enrollment_id references campaign_enrollments.id (SET NULL)
- customer_feedback.resolved_by references auth.users.id (SET NULL)
```
  </action>
  <verify>
Run: `grep -n "Table: customer_feedback" docs/DATA_MODEL.md` to confirm section exists.
Verify section includes Schema table, RLS policies, and Indexes documentation.
  </verify>
  <done>DATA_MODEL.md includes customer_feedback table documentation with schema, purpose, constraints, RLS policies, indexes, and foreign keys.</done>
</task>

</tasks>

<verification>
1. Migration file exists: `dir supabase\migrations\*customer_feedback*`
2. Table has RLS enabled: `grep -n "ENABLE ROW LEVEL SECURITY" supabase/migrations/*customer_feedback*`
3. Rating constraint exists: `grep -n "rating BETWEEN 1 AND 5" supabase/migrations/*customer_feedback*`
4. Documentation exists: `grep -n "Table: customer_feedback" docs/DATA_MODEL.md`
5. Lint passes: `pnpm lint`
</verification>

<success_criteria>
- customer_feedback table migration file exists with proper schema
- RLS enabled with four policies (select, insert for anon+auth, update)
- Indexes created including partial index for unresolved feedback
- Rating constraint enforces 1-5 range
- DATA_MODEL.md documents the new table
- All lint checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/26-review-funnel/26-01-SUMMARY.md`
</output>
