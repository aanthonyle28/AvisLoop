---
phase: 16-onboarding-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00011_onboarding_redesign.sql
  - app/auth/callback/route.ts
  - lib/actions/auth.ts
  - components/auth/google-oauth-button.tsx
autonomous: true

must_haves:
  truths:
    - "Google OAuth callback route exchanges code for session and redirects to /dashboard"
    - "signInWithGoogle server action initiates PKCE flow via Supabase"
    - "GoogleOAuthButton component triggers signInWithGoogle on click"
    - "Database has is_test column on send_logs and onboarding_steps_completed JSONB on businesses"
  artifacts:
    - path: "supabase/migrations/00011_onboarding_redesign.sql"
      provides: "DB schema additions for phase 16"
      contains: "is_test"
    - path: "app/auth/callback/route.ts"
      provides: "OAuth callback handler"
      contains: "exchangeCodeForSession"
    - path: "lib/actions/auth.ts"
      provides: "signInWithGoogle server action"
      contains: "signInWithOAuth"
    - path: "components/auth/google-oauth-button.tsx"
      provides: "Google OAuth button component"
      contains: "signInWithGoogle"
  key_links:
    - from: "components/auth/google-oauth-button.tsx"
      to: "lib/actions/auth.ts"
      via: "signInWithGoogle server action import"
      pattern: "signInWithGoogle"
    - from: "app/auth/callback/route.ts"
      to: "@supabase/ssr"
      via: "exchangeCodeForSession call"
      pattern: "exchangeCodeForSession"
---

<objective>
Create the database migration for Phase 16 (is_test flag on send_logs, onboarding_steps_completed JSONB on businesses) and implement Google OAuth backend infrastructure (server action, callback route handler, button component).

Purpose: Provides the foundation for both the auth page redesign (Google OAuth button) and the dashboard onboarding cards (DB columns for tracking). These are independent foundations that later plans depend on.

Output: Migration SQL file, OAuth callback route, signInWithGoogle action, GoogleOAuthButton component.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-onboarding-redesign/16-RESEARCH.md
@app/auth/confirm/route.ts
@lib/actions/auth.ts
@middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for Phase 16</name>
  <files>supabase/migrations/00011_onboarding_redesign.sql</files>
  <action>
Create migration SQL file at `supabase/migrations/00011_onboarding_redesign.sql` (next sequential number after existing 00010).

IMPORTANT: The filename MUST be `00011_onboarding_redesign.sql`. Existing migrations go 00001 through 00010. Do NOT use 00016 or any other number.

1. Add `is_test BOOLEAN DEFAULT false` column to `send_logs` table (for test send flagging):
   ```sql
   ALTER TABLE public.send_logs
     ADD COLUMN IF NOT EXISTS is_test BOOLEAN DEFAULT false;
   ```
2. Add comment on `is_test` column explaining it marks test/demo sends excluded from monthly quota counting.
3. Create a partial index for quota queries that exclude test sends:
   ```sql
   CREATE INDEX IF NOT EXISTS idx_send_logs_quota_no_test
     ON public.send_logs(business_id, created_at)
     WHERE is_test = false;
   ```
4. The `onboarding_steps_completed JSONB` column already exists on businesses from migration 00008. Verify by checking the migration file. If the column exists and defaults to `'[]'::jsonb`, update the default to `'{}'::jsonb` to match the object pattern used in research (keys like `contact_created`, `template_created`, `test_sent`):
   ```sql
   ALTER TABLE public.businesses
     ALTER COLUMN onboarding_steps_completed SET DEFAULT '{}'::jsonb;
   ```
5. Add comment explaining the new JSONB structure tracks post-wizard card completion: `{ contact_created: bool, template_created: bool, test_sent: bool }`.

Do NOT recreate the onboarding_steps_completed column if it already exists. Only update the default value.
  </action>
  <verify>
1. Read the migration file and confirm it exists at `supabase/migrations/00011_onboarding_redesign.sql` (NOT 00016 or any other number)
2. Confirm it has: is_test column, partial index, default update for onboarding_steps_completed
3. Run `ls supabase/migrations/` and verify 00011 is the correct next sequential number after 00010
  </verify>
  <done>Migration file exists at 00011_onboarding_redesign.sql with is_test boolean on send_logs, partial index for quota queries, and updated default for onboarding_steps_completed.</done>
</task>

<task type="auto">
  <name>Task 2: Google OAuth infrastructure (callback route, server action, button component)</name>
  <files>app/auth/callback/route.ts, lib/actions/auth.ts, components/auth/google-oauth-button.tsx</files>
  <action>
**A. Create OAuth callback route handler** at `app/auth/callback/route.ts`:
- This is a NEW file (different from existing `app/auth/confirm/route.ts` which handles email confirmation).
- Export async `GET` handler that:
  1. Extracts `code` from URL searchParams
  2. Extracts optional `next` param (default `/dashboard`)
  3. If code exists: create Supabase server client, call `supabase.auth.exchangeCodeForSession(code)`
  4. On success: redirect to `${origin}${next}`
  5. On failure or missing code: redirect to `${origin}/auth/error`
- Use `NextResponse.redirect()` for all redirects.
- Import `createClient` from `@/lib/supabase/server`.
- Pattern follows research example exactly.

**B. Add signInWithGoogle server action** to `lib/actions/auth.ts`:
- Add new exported async function `signInWithGoogle()`:
  ```typescript
  export async function signInWithGoogle() {
    const supabase = await createClient()
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: `${process.env.NEXT_PUBLIC_SITE_URL}/auth/callback`,
      },
    })
    if (error) {
      throw error
    }
    if (data.url) {
      redirect(data.url)
    }
  }
  ```
- The `redirect()` from `next/navigation` is already imported. This action initiates the PKCE flow.
- Do NOT add `queryParams: { access_type: 'offline', prompt: 'consent' }` -- keep it simple, basic OAuth is sufficient.

**C. Create GoogleOAuthButton component** at `components/auth/google-oauth-button.tsx`:
- 'use client' component
- Renders a Button (from `@/components/ui/button`) with variant="outline" and full width
- Shows Google "G" SVG icon (inline SVG, the standard 4-color Google G logo) + text "Continue with Google"
- On click: calls `signInWithGoogle` imported from `@/lib/actions/auth`
- Has loading state (useState) that disables button and shows "Connecting..." while action is in progress
- Wrap the action call in try/catch, show error via toast (sonner) on failure, reset loading state in finally block
- Use Kumbh Sans font (inherited from body), border style matching design system (border, no shadow)

**D. Update middleware.ts**: The existing middleware redirects authenticated users from `/auth/login` and `/auth/sign-up` to `/dashboard`. Make sure it does NOT redirect from `/auth/callback` (it shouldn't since callback is a route handler, but verify the matcher pattern doesn't interfere). The current matcher already excludes static files. The callback route handler returns a redirect response itself, so middleware should pass through. No changes needed if the matcher doesn't block it -- just verify.
  </action>
  <verify>
1. Read `app/auth/callback/route.ts` and confirm it exports GET handler with exchangeCodeForSession
2. Read `lib/actions/auth.ts` and confirm signInWithGoogle function exists with signInWithOAuth call
3. Read `components/auth/google-oauth-button.tsx` and confirm it renders button that calls signInWithGoogle
4. Run `pnpm typecheck` to verify no type errors
  </verify>
  <done>OAuth callback route handles code exchange, signInWithGoogle server action initiates PKCE flow, GoogleOAuthButton component renders styled button with loading state, typecheck passes.</done>
</task>

</tasks>

<verification>
1. Migration SQL file at 00011_onboarding_redesign.sql has correct ALTER TABLE statements for is_test and onboarding_steps_completed default
2. OAuth callback route correctly exchanges code for session
3. signInWithGoogle action uses PKCE flow via Supabase
4. GoogleOAuthButton has loading state and error handling
5. `pnpm typecheck` passes
</verification>

<success_criteria>
- Database migration at 00011_onboarding_redesign.sql ready with is_test column + partial index + JSONB default update
- OAuth callback route exchanges code for session and redirects appropriately
- signInWithGoogle server action initiates Google OAuth PKCE flow
- GoogleOAuthButton component is reusable with loading/error states
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/16-onboarding-redesign/16-01-SUMMARY.md`
</output>
