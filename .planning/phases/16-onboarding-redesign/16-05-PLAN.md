---
phase: 16-onboarding-redesign
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/send/page.tsx
  - components/send/send-form.tsx
  - components/dashboard/onboarding-cards.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Clicking card 3 (/send?test=true) results in send_logs.is_test = true in the database"
    - "Test sends via card 3 are NOT counted in monthly quota"
    - "TypeScript compiles without errors on onboarding-cards.tsx icon props"
  artifacts:
    - path: "app/(dashboard)/send/page.tsx"
      provides: "Server component reads searchParams.test and passes isTest to SendForm"
      contains: "isTest"
    - path: "components/send/send-form.tsx"
      provides: "Hidden input passes isTest=true to form action when prop is true"
      contains: "isTest"
    - path: "components/dashboard/onboarding-cards.tsx"
      provides: "Correct Phosphor icon type on CardConfig"
      contains: "IconWeight"
  key_links:
    - from: "components/dashboard/onboarding-cards.tsx"
      to: "app/(dashboard)/send/page.tsx"
      via: "href=/send?test=true -> searchParams.test"
      pattern: "searchParams.*test"
    - from: "app/(dashboard)/send/page.tsx"
      to: "components/send/send-form.tsx"
      via: "isTest prop"
      pattern: "isTest="
    - from: "components/send/send-form.tsx"
      to: "lib/actions/send.ts"
      via: "hidden input name=isTest in FormData"
      pattern: "name=\"isTest\""
---

<objective>
Wire the test=true query parameter through the send page so that test sends triggered from onboarding card 3 are properly flagged in the database and excluded from quota. Also fix the Phosphor icon type mismatch in onboarding-cards.tsx.

Purpose: Closes the last verification gap in Phase 16 (Truth 6: test sends flagged and excluded from quota). The backend infrastructure already works (is_test column, action parameter, quota filter) -- only the frontend wiring from URL param to form submission is missing.

Output: 3 modified files that complete the test send pipeline end-to-end.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-onboarding-redesign/16-VERIFICATION.md

Key existing code:
- app/(dashboard)/send/page.tsx (112 lines) - Server component, renders SendForm. Does NOT currently accept searchParams.
- components/send/send-form.tsx (282 lines) - Client component, SendFormProps has no isTest prop. Form uses handleSubmit that calls batchFormAction or scheduleFormAction.
- components/dashboard/onboarding-cards.tsx (124 lines) - Card 3 links to /send?test=true. CardConfig type has `weight?: string` instead of proper Phosphor type.
- lib/actions/send.ts - Already reads `formData.get('isTest')` and inserts `is_test: isTest` into send_logs. No changes needed here.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire test query param through send page to send form</name>
  <files>
    app/(dashboard)/send/page.tsx
    components/send/send-form.tsx
  </files>
  <action>
    **app/(dashboard)/send/page.tsx:**
    1. Update the SendPage function signature to accept the Next.js App Router page props. In Next.js 15+ with App Router, searchParams is a Promise. Use:
       ```
       export default async function SendPage({ searchParams }: { searchParams: Promise<{ test?: string }> })
       ```
    2. Await searchParams at the top of the function:
       ```
       const params = await searchParams
       const isTest = params.test === 'true'
       ```
    3. Pass `isTest={isTest}` as a prop to the SendForm component (line 99-107 area).

    **components/send/send-form.tsx:**
    1. Add `isTest?: boolean` to the SendFormProps interface (after resendReadyContactIds).
    2. Destructure `isTest` in the component function parameters (default to false if undefined).
    3. Inside the `<form>` element (line 139), add a conditional hidden input:
       ```
       {isTest && <input type="hidden" name="isTest" value="true" />}
       ```
       Place it near the other hidden inputs (around line 231 where customSubject hidden input is).
    4. Add a visual test mode indicator. When isTest is true, show a small badge at the top of the form (before the error display):
       ```
       {isTest && (
         <div className="rounded-lg border border-blue-200 bg-blue-50 px-4 py-2 text-sm text-blue-700">
           Test mode - this send will not count against your monthly quota
         </div>
       )}
       ```

    NOTE: Do NOT modify lib/actions/send.ts -- it already reads isTest from FormData correctly.
  </action>
  <verify>
    Run `pnpm typecheck` -- must pass with no errors.
    Confirm by reading the modified files that:
    - SendPage reads searchParams.test
    - SendForm accepts isTest prop
    - Hidden input renders when isTest is true
  </verify>
  <done>
    Navigating to /send?test=true passes isTest=true to SendForm, which includes a hidden input name="isTest" value="true" in the form. The send action receives isTest=true and flags the send_log row with is_test=true. Test mode badge is visible.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Phosphor icon type in onboarding cards</name>
  <files>
    components/dashboard/onboarding-cards.tsx
  </files>
  <action>
    1. Check if `@phosphor-icons/react` exports an `IconWeight` type. If so, import it:
       ```
       import type { IconWeight } from '@phosphor-icons/react'
       ```
    2. Update the CardConfig type's icon property from:
       ```
       icon: React.ComponentType<{ className?: string; weight?: string }>
       ```
       To:
       ```
       icon: React.ComponentType<{ className?: string; weight?: IconWeight }>
       ```
    3. If `IconWeight` is not exported, use the union type inline:
       ```
       icon: React.ComponentType<{ className?: string; weight?: 'thin' | 'light' | 'regular' | 'bold' | 'fill' | 'duotone' }>
       ```
  </action>
  <verify>
    Run `pnpm typecheck` -- must pass with no errors on onboarding-cards.tsx.
  </verify>
  <done>
    The icon prop type in CardConfig correctly matches what Phosphor icon components expect. No TypeScript errors.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with zero errors
2. `pnpm lint` passes
3. Read app/(dashboard)/send/page.tsx and confirm searchParams.test is read and passed as isTest prop
4. Read components/send/send-form.tsx and confirm hidden input with name="isTest" renders when isTest=true
5. Read components/dashboard/onboarding-cards.tsx and confirm icon type uses IconWeight (not bare string)
</verification>

<success_criteria>
- The complete pipeline works: card 3 href (/send?test=true) -> send page reads param -> form includes hidden input -> action flags is_test=true -> quota excludes test sends
- All TypeScript types are correct (no typecheck errors)
- Lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/16-onboarding-redesign/16-05-SUMMARY.md`
</output>
