---
phase: 16-onboarding-redesign
plan: 04
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - components/dashboard/onboarding-cards.tsx
  - components/dashboard/onboarding-checklist.tsx
  - lib/data/onboarding.ts
  - lib/actions/onboarding.ts
  - lib/actions/send.ts
  - lib/data/send-logs.ts
  - app/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows 3 numbered test step cards after onboarding (create contact, create template, send test)"
    - "Cards track completion automatically based on database state"
    - "Cards disappear when all 3 are complete"
    - "Test sends are flagged with is_test=true in send_logs"
    - "Test sends are excluded from monthly quota count"
    - "The send action accepts an isTest parameter and sets is_test=true on the send_log insert"
  artifacts:
    - path: "components/dashboard/onboarding-cards.tsx"
      provides: "3 numbered onboarding step cards"
      contains: "OnboardingCards"
    - path: "lib/data/onboarding.ts"
      provides: "Card completion status tracking"
      contains: "onboarding_steps_completed"
    - path: "lib/data/send-logs.ts"
      provides: "Quota query excluding test sends"
      contains: "is_test"
    - path: "lib/actions/send.ts"
      provides: "Send action that accepts isTest parameter"
      contains: "is_test"
    - path: "app/dashboard/page.tsx"
      provides: "Dashboard rendering onboarding cards"
      contains: "OnboardingCards"
  key_links:
    - from: "app/dashboard/page.tsx"
      to: "components/dashboard/onboarding-cards.tsx"
      via: "renders OnboardingCards with status"
      pattern: "OnboardingCards"
    - from: "lib/data/send-logs.ts"
      to: "send_logs"
      via: "quota query with is_test filter"
      pattern: "is_test.*false"
    - from: "lib/data/onboarding.ts"
      to: "businesses"
      via: "reads onboarding_steps_completed JSONB"
      pattern: "onboarding_steps_completed"
    - from: "lib/actions/send.ts"
      to: "send_logs"
      via: "insert with is_test flag"
      pattern: "is_test"
---

<objective>
Create 3 dashboard onboarding cards (create contact, create template, send test), implement auto-completion tracking, wire is_test flag into the send action, and add is_test exclusion to quota counting. Replace the old onboarding checklist.

Purpose: After the simplified 2-step wizard (business name + review link), users need guided next steps on the dashboard. The 3 cards replace the old checklist and guide users through creating a contact, a template, and sending their first test review request.

Output: OnboardingCards component, updated onboarding data layer, send action with isTest support, quota exclusion for test sends, dashboard integration.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/16-onboarding-redesign/16-CONTEXT.md
@.planning/phases/16-onboarding-redesign/16-RESEARCH.md
@components/dashboard/onboarding-checklist.tsx
@lib/data/onboarding.ts
@lib/actions/onboarding.ts
@lib/actions/send.ts
@lib/data/send-logs.ts
@app/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Onboarding card completion tracking + test send quota exclusion + wire is_test into send action</name>
  <files>lib/data/onboarding.ts, lib/actions/onboarding.ts, lib/data/send-logs.ts, lib/actions/send.ts</files>
  <action>
**A. Update `lib/data/onboarding.ts`:**

1. Add new type for card completion status:
   ```typescript
   export type OnboardingCardStatus = {
     contact_created: boolean
     template_created: boolean
     test_sent: boolean
   }
   ```

2. Add function `getOnboardingCardStatus()` that auto-detects completion:
   ```typescript
   export async function getOnboardingCardStatus(): Promise<OnboardingCardStatus> {
     const supabase = await createClient()
     const { data: { user } } = await supabase.auth.getUser()
     if (!user) return { contact_created: false, template_created: false, test_sent: false }

     const { data: business } = await supabase
       .from('businesses')
       .select('id, onboarding_steps_completed')
       .eq('user_id', user.id)
       .single()

     if (!business) return { contact_created: false, template_created: false, test_sent: false }

     // Read stored status from JSONB column
     const stored = (business.onboarding_steps_completed || {}) as Partial<OnboardingCardStatus>

     // If all stored as true, return immediately (no need to re-query)
     if (stored.contact_created && stored.template_created && stored.test_sent) {
       return stored as OnboardingCardStatus
     }

     // Auto-detect completion from actual database state
     const [contactResult, templateResult, testSendResult] = await Promise.all([
       supabase.from('contacts').select('id', { count: 'exact', head: true }).eq('business_id', business.id).eq('status', 'active'),
       supabase.from('email_templates').select('id', { count: 'exact', head: true }).eq('business_id', business.id),
       supabase.from('send_logs').select('id', { count: 'exact', head: true }).eq('business_id', business.id),
     ])

     const detected: OnboardingCardStatus = {
       contact_created: (contactResult.count ?? 0) > 0,
       template_created: (templateResult.count ?? 0) > 0,
       test_sent: (testSendResult.count ?? 0) > 0,
     }

     // If any newly detected, persist to JSONB column for faster future reads
     const needsUpdate = Object.entries(detected).some(
       ([key, val]) => val && !stored[key as keyof OnboardingCardStatus]
     )
     if (needsUpdate) {
       await supabase
         .from('businesses')
         .update({ onboarding_steps_completed: detected })
         .eq('id', business.id)
     }

     return detected
   }
   ```

3. Add function `areAllCardsComplete()` helper:
   ```typescript
   export function areAllCardsComplete(status: OnboardingCardStatus): boolean {
     return status.contact_created && status.template_created && status.test_sent
   }
   ```

4. Keep the existing `getOnboardingStatus()` function and `OnboardingStatus` type -- they're still used for wizard completion check.

**B. Update `lib/actions/onboarding.ts`:**

Add server action to mark a specific card step complete (manual trigger if auto-detect isn't immediate enough):
```typescript
export async function markOnboardingCardStep(
  step: 'contact_created' | 'template_created' | 'test_sent'
): Promise<{ success: boolean; error?: string }> {
  const supabase = await createClient()
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) return { success: false, error: 'Not authenticated' }

  const { data: business } = await supabase
    .from('businesses')
    .select('id, onboarding_steps_completed')
    .eq('user_id', user.id)
    .single()

  if (!business) return { success: false, error: 'No business found' }

  const current = (business.onboarding_steps_completed || {}) as Record<string, boolean>
  current[step] = true

  const { error } = await supabase
    .from('businesses')
    .update({ onboarding_steps_completed: current })
    .eq('id', business.id)

  if (error) return { success: false, error: error.message }

  revalidatePath('/dashboard')
  return { success: true }
}
```

**C. Update `lib/data/send-logs.ts` -- Add is_test exclusion to getMonthlyUsage:**

In the `getMonthlyUsage()` function, add `.eq('is_test', false)` to the quota counting query:

Find the query that counts send_logs for monthly usage (around line 119-124):
```typescript
const { count } = await supabase
  .from('send_logs')
  .select('*', { count: 'exact', head: true })
  .eq('business_id', business.id)
  .eq('is_test', false)  // ADD THIS LINE - exclude test sends from quota
  .gte('created_at', startOfMonth.toISOString())
  .in('status', ['sent', 'delivered', 'opened'])
```

Also search for any other quota-counting queries in the codebase (check `lib/actions/send.ts` or similar) and add the same `is_test` exclusion. The send action likely checks quota before sending -- find it and add the filter there too.

**D. Wire is_test flag into the send action (`lib/actions/send.ts`):**

CRITICAL: The `is_test` column is created in 16-01's migration, but NO code currently sets it to `true`. This task fixes that.

1. Update the `sendReviewRequest` function to accept an `isTest` parameter. Since the function signature uses `FormData`, add support for reading an `isTest` field from the FormData:
   ```typescript
   // Inside sendReviewRequest, after parsing formData:
   const isTest = formData.get('isTest') === 'true'
   ```

2. Pass `is_test` into both send_log insert calls in the file. There are two insert locations (single send and batch send). Update both:
   ```typescript
   .insert({
     business_id: business.id,
     contact_id: contactId,
     template_id: templateId || null,
     status: 'pending',
     subject,
     is_test: isTest,  // ADD THIS
   })
   ```

3. For the batch send function (`batchSendReviewRequests`), also add `isTest` support:
   - Read `isTest` from the FormData the same way
   - Pass `is_test: isTest` in the insert

4. Update the card 3 href in `onboarding-cards.tsx` (Task 2) to link to `/send?test=true` so the send page knows to set `isTest=true`. The send form/page should read this query param and include a hidden `<input name="isTest" value="true" />` in the form when the `test=true` query param is present.

NOTE: If the send page is not part of this plan's files, add a comment in the onboarding cards noting that `/send?test=true` should be handled by the send page to set is_test on the form. At minimum, the send ACTION must accept and use the isTest field from FormData.
  </action>
  <verify>
1. Read lib/data/onboarding.ts and confirm getOnboardingCardStatus and OnboardingCardStatus exist
2. Read lib/actions/onboarding.ts and confirm markOnboardingCardStep exists
3. Read lib/data/send-logs.ts and confirm getMonthlyUsage has is_test filter
4. Read lib/actions/send.ts and confirm BOTH insert calls include `is_test: isTest` and that `isTest` is read from FormData
5. Search for other quota queries and confirm they also filter is_test
6. Run `pnpm typecheck`
  </verify>
  <done>Card status auto-detected from DB, is_test sends excluded from quota, send action accepts isTest from FormData and sets is_test=true on insert, markOnboardingCardStep action available for manual marking.</done>
</task>

<task type="auto">
  <name>Task 2: Dashboard onboarding cards component + page integration</name>
  <files>components/dashboard/onboarding-cards.tsx, components/dashboard/onboarding-checklist.tsx, app/dashboard/page.tsx</files>
  <action>
**A. Create `components/dashboard/onboarding-cards.tsx`:**

'use client' component that renders 3 numbered cards:

```tsx
'use client'

import { AddressBook, NotePencil, PaperPlaneTilt, ArrowRight, CheckCircle } from '@phosphor-icons/react'
import Link from 'next/link'
import { cn } from '@/lib/utils'
import type { OnboardingCardStatus } from '@/lib/data/onboarding'

type CardConfig = {
  id: keyof OnboardingCardStatus
  number: string
  title: string
  description: string
  icon: React.ComponentType<{ className?: string; weight?: string }>
  href: string
  prerequisite?: keyof OnboardingCardStatus
  prerequisiteLabel?: string
}

const CARDS: CardConfig[] = [
  {
    id: 'contact_created',
    number: '01',
    title: 'Create a test contact',
    description: 'Add someone to send a review request to',
    icon: AddressBook,
    href: '/contacts',
  },
  {
    id: 'template_created',
    number: '02',
    title: 'Create a message template',
    description: 'Customize your review request email',
    icon: NotePencil,
    href: '/dashboard/settings',
  },
  {
    id: 'test_sent',
    number: '03',
    title: 'Send a test review request',
    description: 'Try sending your first review request',
    icon: PaperPlaneTilt,
    href: '/send?test=true',
    prerequisite: 'contact_created',
    prerequisiteLabel: 'Create a contact first',
  },
]
```

IMPORTANT: Card 3 href is `/send?test=true` (not just `/send`). This query parameter signals the send page to include `isTest=true` in the FormData so the send action marks the send_log with `is_test=true`.

Component renders:
- Section heading: "Get Started" with completion counter "X of 3 complete"
- 3 cards in a horizontal grid (md:grid-cols-3, stack on mobile)
- Each card has:
  - Number label (01, 02, 03) in top-left, muted foreground
  - Completion indicator in top-right: CheckCircle (filled, green) if complete, empty circle if not
  - Icon (Phosphor, weight="regular", text-primary, h-8 w-8)
  - Title (font-semibold)
  - Description (text-sm, text-muted-foreground)
  - Warning text if prerequisite not met (text-xs, text-amber-600)
  - ArrowRight icon at bottom-right (shows on hover via group-hover)
- Cards are Link components wrapping the whole card
- Completed cards have green tint: `border-green-200 bg-green-50/50`
- Cards use border style (no shadow) per design system
- All cards are always clickable regardless of prerequisite status
- If all complete: component returns null (disappear)

**B. Deprecate `components/dashboard/onboarding-checklist.tsx`:**

The old OnboardingChecklist is no longer used. Do NOT delete it yet (other code may reference it). Instead:
- Add a comment at the top: `// DEPRECATED: Replaced by OnboardingCards in Phase 16. Safe to delete.`
- Remove the import from dashboard page.tsx in the next step.

**C. Update `app/dashboard/page.tsx`:**

1. Import the new components/functions:
   ```typescript
   import { getOnboardingCardStatus, areAllCardsComplete } from '@/lib/data/onboarding'
   import { OnboardingCards } from '@/components/dashboard/onboarding-cards'
   ```

2. Remove import of OnboardingChecklist (if still imported).

3. In the data fetching section, add getOnboardingCardStatus to the Promise.all:
   ```typescript
   const [business, usage, contactsData, responseRate, needsAttention, recentActivity, cardStatus] = await Promise.all([
     getBusiness(),
     getMonthlyUsage(),
     getContacts({ limit: 50 }),
     getResponseRate(),
     getNeedsAttentionCount(),
     getRecentActivity(5),
     getOnboardingCardStatus(),
   ])
   ```

4. Render OnboardingCards ABOVE the stat cards (between welcome header and stats), but only if NOT all cards are complete:
   ```tsx
   {/* Welcome Header */}
   <div>...</div>

   {/* Onboarding Cards (if not all complete) */}
   {!areAllCardsComplete(cardStatus) && (
     <OnboardingCards status={cardStatus} />
   )}

   {/* Stat Cards */}
   <div className="grid grid-cols-1 md:grid-cols-3 gap-4">...</div>
   ```

5. Remove the onboarding completion redirect that currently redirects to /onboarding. Change the logic:
   - Currently: `if (status && !status.completed) { redirect('/onboarding') }`
   - New behavior: Only redirect to /onboarding if the business doesn't exist yet (new user who hasn't done the 2-step wizard). If business exists but onboarding_completed_at is null, the user may have signed up via Google OAuth and need the wizard. Keep the redirect but ensure it handles the post-wizard state correctly.
   - Actually, keep the existing redirect logic as-is: `if (status && !status.completed) redirect('/onboarding')`. The wizard marks `onboarding_completed_at` when done, so this still works. The cards only show after the wizard is complete.

6. Remove the old `getOnboardingStatus` import if it's only used for the redirect check. Actually, keep it -- it's still used for the redirect check at the top of the page.
  </action>
  <verify>
1. Read onboarding-cards.tsx and confirm 3 cards with correct config, card 3 href is `/send?test=true`
2. Read dashboard page and confirm OnboardingCards is rendered with cardStatus
3. Confirm areAllCardsComplete controls visibility
4. Confirm old checklist is deprecated with comment
5. Run `pnpm typecheck` and `pnpm lint`
  </verify>
  <done>Dashboard shows 3 numbered onboarding cards after wizard completion, card 3 links to /send?test=true, cards auto-detect completion from DB, cards disappear when all 3 done, old checklist deprecated.</done>
</task>

</tasks>

<verification>
1. Dashboard shows 3 numbered cards (create contact, create template, send test)
2. Cards auto-detect completion from database state
3. Completed cards show green checkmark
4. All cards disappear when all 3 are complete
5. Card 3 links to /send?test=true to trigger test send flagging
6. Send action reads isTest from FormData and sets is_test=true on send_log insert
7. Test sends excluded from monthly quota counting (is_test=false filter)
8. `pnpm typecheck` and `pnpm lint` pass
</verification>

<success_criteria>
- 3 onboarding cards visible on dashboard after wizard completion
- Cards navigate to /contacts, /dashboard/settings, /send?test=true respectively
- Card 3 shows prerequisite warning if no contacts exist
- Auto-completion detection: cards update on page load based on actual DB state
- Send action accepts isTest FormData field and sets is_test=true on send_log insert
- is_test sends excluded from getMonthlyUsage quota count
- Cards vanish when all 3 complete
- Old onboarding checklist deprecated
</success_criteria>

<output>
After completion, create `.planning/phases/16-onboarding-redesign/16-04-SUMMARY.md`
</output>
