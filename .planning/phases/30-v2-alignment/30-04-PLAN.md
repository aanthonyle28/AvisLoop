---
phase: 30-v2-alignment
plan: 04
type: execute
wave: 2
depends_on: ["30-02"]
files_modified:
  - components/jobs/job-table.tsx
  - components/jobs/job-columns.tsx
  - components/jobs/mark-complete-button.tsx
autonomous: true

must_haves:
  truths:
    - "Job table shows 'Mark Complete' button for scheduled jobs"
    - "Clicking 'Mark Complete' transitions job to completed status"
    - "Completed jobs show completed timestamp, not Mark Complete button"
    - "Status badge reflects three-state workflow"
  artifacts:
    - path: "components/jobs/mark-complete-button.tsx"
      provides: "One-click complete action button"
      min_lines: 30
    - path: "components/jobs/job-columns.tsx"
      provides: "Updated columns with Mark Complete action"
      contains: "MarkCompleteButton"
  key_links:
    - from: "components/jobs/mark-complete-button.tsx"
      to: "lib/actions/job.ts"
      via: "markJobComplete import"
      pattern: "markJobComplete"
---

<objective>
Add "Mark Complete" button to Job Table for scheduled jobs. This enables the V2 dispatch workflow where technicians can complete jobs with one tap.

Purpose: V2FL-11 requirement. Support dispatch workflow where jobs are created before work is done.
Output: Mark Complete button in job table, status badges for three states.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-v2-alignment/30-RESEARCH.md

# Depends on Plan 02
@.planning/phases/30-v2-alignment/30-02-SUMMARY.md

# Existing patterns
@components/jobs/job-table.tsx
@components/jobs/job-columns.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MarkCompleteButton component</name>
  <files>components/jobs/mark-complete-button.tsx</files>
  <action>
Create new component at components/jobs/mark-complete-button.tsx:

```typescript
'use client'

import { useState, useTransition } from 'react'
import { Button } from '@/components/ui/button'
import { CheckCircle, CircleNotch } from '@phosphor-icons/react'
import { markJobComplete } from '@/lib/actions/job'
import { toast } from 'sonner'

interface MarkCompleteButtonProps {
  jobId: string
  size?: 'default' | 'sm' | 'xs'
}

export function MarkCompleteButton({ jobId, size = 'sm' }: MarkCompleteButtonProps) {
  const [isPending, startTransition] = useTransition()

  const handleClick = () => {
    startTransition(async () => {
      const result = await markJobComplete(jobId, true)  // true = enroll in campaign

      if (result.success) {
        toast.success('Job marked complete! Campaign enrollment started.')
      } else {
        toast.error(result.error || 'Failed to complete job')
      }
    })
  }

  return (
    <Button
      variant="default"
      size={size}
      onClick={handleClick}
      disabled={isPending}
      className="gap-1.5"
    >
      {isPending ? (
        <CircleNotch className="h-4 w-4 animate-spin" />
      ) : (
        <CheckCircle className="h-4 w-4" weight="bold" />
      )}
      {size !== 'xs' && (isPending ? 'Completing...' : 'Mark Complete')}
    </Button>
  )
}
```

This component:
- Shows loading state during transition
- Uses Phosphor icons
- Calls markJobComplete server action with enrollment=true
- Shows success/error toast
- Supports different sizes for table vs mobile
  </action>
  <verify>Run `pnpm typecheck` to confirm component types are correct</verify>
  <done>MarkCompleteButton component exists at components/jobs/mark-complete-button.tsx</done>
</task>

<task type="auto">
  <name>Task 2: Update job columns with Mark Complete action</name>
  <files>components/jobs/job-columns.tsx</files>
  <action>
Update components/jobs/job-columns.tsx to:
1. Add Mark Complete button for scheduled jobs
2. Update status badge to handle three states
3. Show completed_at timestamp for completed jobs

Find the status column and update it:

```typescript
// Status column with Mark Complete action for scheduled jobs
{
  accessorKey: 'status',
  header: ({ column }) => (
    <DataTableColumnHeader column={column} title="Status" />
  ),
  cell: ({ row }) => {
    const status = row.getValue('status') as JobStatus
    const completedAt = row.original.completed_at

    // For scheduled jobs, show Mark Complete button
    if (status === 'scheduled') {
      return (
        <div className="flex items-center gap-2">
          <Badge variant="outline" className="text-amber-600 border-amber-600/50 bg-amber-50 dark:bg-amber-950/30">
            Scheduled
          </Badge>
          <MarkCompleteButton jobId={row.original.id} size="xs" />
        </div>
      )
    }

    // For completed jobs, show badge and timestamp
    if (status === 'completed') {
      return (
        <div className="flex flex-col gap-0.5">
          <Badge variant="outline" className="text-green-600 border-green-600/50 bg-green-50 dark:bg-green-950/30 w-fit">
            Completed
          </Badge>
          {completedAt && (
            <span className="text-xs text-muted-foreground">
              {formatDistanceToNow(new Date(completedAt), { addSuffix: true })}
            </span>
          )}
        </div>
      )
    }

    // For do_not_send jobs
    return (
      <Badge variant="outline" className="text-muted-foreground border-muted-foreground/50">
        Do Not Send
      </Badge>
    )
  },
},
```

Add necessary imports at top of file:
```typescript
import { MarkCompleteButton } from './mark-complete-button'
import { formatDistanceToNow } from 'date-fns'
import { Badge } from '@/components/ui/badge'
```

Also update the actions column to conditionally show Mark Complete:

```typescript
// In the actions dropdown, add Mark Complete option for scheduled jobs
{row.original.status === 'scheduled' && (
  <DropdownMenuItem onClick={() => handleMarkComplete(row.original.id)}>
    <CheckCircle className="mr-2 h-4 w-4" />
    Mark Complete
  </DropdownMenuItem>
)}
```
  </action>
  <verify>Run `pnpm typecheck` to confirm column definition types are correct</verify>
  <done>Job columns show Mark Complete button for scheduled jobs, status badges for all three states</done>
</task>

<task type="auto">
  <name>Task 3: Update job-table.tsx to support mark complete</name>
  <files>components/jobs/job-table.tsx</files>
  <action>
Review components/jobs/job-table.tsx and ensure:

1. The table passes job status to columns correctly
2. The completed_at field is accessible in row.original
3. No changes needed if table already passes full job object

If the table uses a trimmed Job type, ensure it includes:
- status: JobStatus
- completed_at: string | null

The MarkCompleteButton handles the server action call internally via useTransition, so no additional handlers needed in job-table.tsx.

Check if there's a Job interface defined locally - if so, update it to include:
```typescript
interface Job {
  id: string
  customer_id: string
  service_type: ServiceType
  status: JobStatus  // 'scheduled' | 'completed' | 'do_not_send'
  completed_at: string | null
  notes: string | null
  created_at: string
  updated_at: string
  // ... customer relation if needed
}
```
  </action>
  <verify>Run `pnpm typecheck` to confirm table works with new columns</verify>
  <done>Job table supports Mark Complete workflow, passes full job data to columns</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. Scheduled jobs show "Mark Complete" button in table
4. Clicking button transitions to completed and shows toast
5. Completed jobs show green badge + relative timestamp
6. Do Not Send jobs show muted badge
</verification>

<success_criteria>
- Mark Complete button visible for scheduled jobs (V2FL-11)
- One-click completion triggers campaign enrollment
- Status badges reflect three-state workflow
- Timestamps shown for completed jobs
</success_criteria>

<output>
After completion, create `.planning/phases/30-v2-alignment/30-04-SUMMARY.md`
</output>
