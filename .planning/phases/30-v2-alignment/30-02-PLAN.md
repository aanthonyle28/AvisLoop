---
phase: 30-v2-alignment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260206_add_job_scheduled_status.sql
  - lib/validations/job.ts
  - lib/actions/job.ts
autonomous: true

must_haves:
  truths:
    - "Jobs support three statuses: scheduled, completed, do_not_send"
    - "New jobs default to 'scheduled' status"
    - "Only 'completed' status triggers campaign enrollment"
    - "Marking a job complete updates status and completed_at timestamp"
  artifacts:
    - path: "supabase/migrations/20260206_add_job_scheduled_status.sql"
      provides: "Database migration for scheduled status"
      contains: "scheduled"
    - path: "lib/validations/job.ts"
      provides: "Updated JOB_STATUSES array"
      contains: "scheduled"
    - path: "lib/actions/job.ts"
      provides: "markJobComplete server action"
      exports: ["markJobComplete"]
  key_links:
    - from: "lib/actions/job.ts"
      to: "lib/validations/job.ts"
      via: "JOB_STATUSES import"
      pattern: "JOB_STATUSES"
---

<objective>
Add 'scheduled' job status to support dispatch workflow where jobs are created before work is done. Add markJobComplete server action for one-click completion.

Purpose: V2FL-09/V2FL-10 requirement. Dispatch businesses create jobs in morning, technician marks complete in afternoon.
Output: Three-state job workflow with database migration and server action.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-v2-alignment/30-RESEARCH.md

# Existing patterns
@lib/validations/job.ts
@lib/actions/job.ts
@docs/DATA_MODEL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for scheduled status</name>
  <files>supabase/migrations/20260206_add_job_scheduled_status.sql</files>
  <action>
Create migration file at supabase/migrations/20260206_add_job_scheduled_status.sql:

```sql
-- Migration: Add 'scheduled' status to jobs table
-- Purpose: Support dispatch workflow (create job before work, mark complete after)

-- 1. Drop existing CHECK constraint (if exists)
ALTER TABLE public.jobs DROP CONSTRAINT IF EXISTS jobs_status_check;

-- 2. Add new CHECK constraint with 'scheduled' status
ALTER TABLE public.jobs ADD CONSTRAINT jobs_status_check
  CHECK (status IN ('scheduled', 'completed', 'do_not_send'));

-- 3. Update default to 'scheduled' (affects new rows only)
-- Existing completed jobs remain 'completed'
ALTER TABLE public.jobs ALTER COLUMN status SET DEFAULT 'scheduled';

-- 4. Add partial index for scheduled jobs query (Mark Complete button)
-- This enables fast lookup of jobs awaiting completion
CREATE INDEX IF NOT EXISTS idx_jobs_scheduled
  ON public.jobs (business_id, status)
  WHERE status = 'scheduled';

-- 5. Add comment for documentation
COMMENT ON COLUMN public.jobs.status IS 'Job status: scheduled (awaiting completion), completed (triggers campaign), do_not_send (no review request)';
```

This migration:
- Extends CHECK constraint to allow 'scheduled' status
- Changes default from 'completed' to 'scheduled' (new V2 behavior)
- Adds partial index for efficient scheduled jobs queries
- Does NOT update existing rows (completed jobs stay completed)
  </action>
  <verify>File exists at supabase/migrations/20260206_add_job_scheduled_status.sql</verify>
  <done>Migration file created, ready to apply with `supabase db reset`</done>
</task>

<task type="auto">
  <name>Task 2: Update job validations for three-state workflow</name>
  <files>lib/validations/job.ts</files>
  <action>
Update lib/validations/job.ts to add 'scheduled' status:

1. Update JOB_STATUSES array:
```typescript
// Job statuses as const array (V2: three-state workflow)
export const JOB_STATUSES = ['scheduled', 'completed', 'do_not_send'] as const
```

2. Update JOB_STATUS_LABELS:
```typescript
export const JOB_STATUS_LABELS: Record<typeof JOB_STATUSES[number], string> = {
  scheduled: 'Scheduled',
  completed: 'Completed',
  do_not_send: 'Do Not Send',
}
```

3. Add JOB_STATUS_DESCRIPTIONS for UI hints:
```typescript
export const JOB_STATUS_DESCRIPTIONS: Record<typeof JOB_STATUSES[number], string> = {
  scheduled: 'Job created, work not yet done. Will not trigger campaign.',
  completed: 'Work finished. Will enroll in matching campaign.',
  do_not_send: 'Bad experience or not applicable. Will not request review.',
}
```

4. Update jobSchema default:
```typescript
export const jobSchema = z.object({
  // ... existing fields
  status: z
    .enum(JOB_STATUSES)
    .default('scheduled'),  // Changed from 'completed' to 'scheduled'
  // ... remaining fields
})
```
  </action>
  <verify>Run `pnpm typecheck` to confirm types still work with three statuses</verify>
  <done>JOB_STATUSES includes 'scheduled', default changed to 'scheduled'</done>
</task>

<task type="auto">
  <name>Task 3: Add markJobComplete server action</name>
  <files>lib/actions/job.ts</files>
  <action>
Add markJobComplete server action to lib/actions/job.ts:

```typescript
/**
 * Mark a job as complete and optionally enroll in campaign
 * This is the V2 core action - triggers campaign enrollment
 */
export async function markJobComplete(
  jobId: string,
  enrollInCampaign: boolean = true
): Promise<JobActionState> {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    return { success: false, error: 'Unauthorized' }
  }

  const business = await getBusiness()
  if (!business) {
    return { success: false, error: 'Business not found' }
  }

  // Fetch the job to verify ownership and get customer ID
  const { data: job, error: fetchError } = await supabase
    .from('jobs')
    .select('id, business_id, customer_id, service_type, status')
    .eq('id', jobId)
    .eq('business_id', business.id)
    .single()

  if (fetchError || !job) {
    return { success: false, error: 'Job not found' }
  }

  if (job.status === 'completed') {
    return { success: false, error: 'Job is already completed' }
  }

  if (job.status === 'do_not_send') {
    return { success: false, error: 'Cannot complete a "Do Not Send" job. Edit status first.' }
  }

  // Update job status to completed
  const { error: updateError } = await supabase
    .from('jobs')
    .update({
      status: 'completed',
      completed_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
    })
    .eq('id', jobId)

  if (updateError) {
    console.error('Error marking job complete:', updateError)
    return { success: false, error: 'Failed to complete job' }
  }

  // Campaign enrollment (non-blocking)
  if (enrollInCampaign) {
    try {
      await enrollJobInCampaign(job.id, job.customer_id, job.service_type as ServiceType, business.id)
    } catch (err) {
      // Log but don't fail - job completion is primary action
      console.error('Failed to enroll job in campaign:', err)
    }
  }

  revalidatePath('/jobs')
  revalidatePath('/dashboard')

  return { success: true }
}
```

Ensure the function imports are present at top of file:
- Import getBusiness from '@/lib/data/business'
- Import enrollJobInCampaign from '@/lib/actions/campaign-enrollment' (if exists) or inline the enrollment logic
- Import ServiceType from '@/lib/types/database'
- Import revalidatePath from 'next/cache'

If enrollJobInCampaign doesn't exist in campaign-enrollment.ts, create a simplified version that:
1. Finds active campaign for service type (or all-services fallback)
2. Creates enrollment with scheduled touches
3. Returns success/failure

The existing enrollment logic from createJob should be extracted/reused.
  </action>
  <verify>Run `pnpm typecheck` to confirm markJobComplete has correct types</verify>
  <done>markJobComplete server action exists, updates status to 'completed' and triggers campaign enrollment</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. JOB_STATUSES array includes 'scheduled', 'completed', 'do_not_send'
4. jobSchema default is 'scheduled'
5. markJobComplete function exported from lib/actions/job.ts
6. Migration file exists at supabase/migrations/20260206_add_job_scheduled_status.sql
</verification>

<success_criteria>
- Database migration extends CHECK constraint with 'scheduled'
- JOB_STATUSES constant includes three statuses
- New jobs default to 'scheduled' status
- markJobComplete action handles status transition and campaign enrollment
- Migration ready to apply (user runs `supabase db reset`)
</success_criteria>

<output>
After completion, create `.planning/phases/30-v2-alignment/30-02-SUMMARY.md`
</output>
