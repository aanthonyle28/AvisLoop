---
phase: 04-core-sending
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00005_create_send_logs.sql
  - lib/types/database.ts
  - lib/validations/send.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "send_logs table exists with proper schema"
    - "contacts table has opted_out column"
    - "businesses table has tier column"
    - "RLS policies protect send_logs by business ownership"
  artifacts:
    - path: "supabase/migrations/00005_create_send_logs.sql"
      provides: "send_logs table, opted_out column, tier column, RLS policies"
      contains: "CREATE TABLE IF NOT EXISTS public.send_logs"
    - path: "lib/types/database.ts"
      provides: "SendLog TypeScript type"
      contains: "interface SendLog"
    - path: "lib/validations/send.ts"
      provides: "Zod schemas for send operations"
      exports: ["sendRequestSchema"]
  key_links:
    - from: "lib/types/database.ts"
      to: "send_logs table"
      via: "type definition matching schema"
      pattern: "SendLog.*status.*pending|sent|delivered"
---

<objective>
Create database schema and TypeScript types for email send logging and tracking.

Purpose: Foundation for tracking all send operations with status, enabling history, analytics, and webhook status updates.
Output: Migration file with send_logs table and RLS policies, updated TypeScript types, Zod validation schemas.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-sending/04-RESEARCH.md

@lib/types/database.ts
@supabase/migrations/00003_create_contacts.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create send_logs migration with schema additions</name>
  <files>supabase/migrations/00005_create_send_logs.sql</files>
  <action>
Create migration file with:

1. **send_logs table**:
```sql
CREATE TABLE IF NOT EXISTS public.send_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_id UUID NOT NULL REFERENCES public.businesses(id) ON DELETE CASCADE,
  contact_id UUID NOT NULL REFERENCES public.contacts(id) ON DELETE CASCADE,
  template_id UUID REFERENCES public.email_templates(id) ON DELETE SET NULL,
  status TEXT NOT NULL DEFAULT 'pending',
  provider_id TEXT,  -- Resend email ID
  error_message TEXT,
  subject TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT send_logs_status_valid CHECK (
    status IN ('pending', 'sent', 'delivered', 'bounced', 'complained', 'failed', 'opened')
  )
);
```

2. **Indexes** (match existing patterns):
```sql
CREATE INDEX IF NOT EXISTS idx_send_logs_business_id ON public.send_logs USING btree (business_id);
CREATE INDEX IF NOT EXISTS idx_send_logs_contact_id ON public.send_logs USING btree (contact_id);
CREATE INDEX IF NOT EXISTS idx_send_logs_created_at ON public.send_logs USING btree (created_at DESC);
```

3. **RLS policies** (using subquery pattern from contacts):
```sql
ALTER TABLE public.send_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users view own send_logs"
ON public.send_logs FOR SELECT
TO authenticated
USING (business_id IN (SELECT id FROM public.businesses WHERE user_id = (SELECT auth.uid())));

CREATE POLICY "Users insert own send_logs"
ON public.send_logs FOR INSERT
TO authenticated
WITH CHECK (business_id IN (SELECT id FROM public.businesses WHERE user_id = (SELECT auth.uid())));

CREATE POLICY "Users update own send_logs"
ON public.send_logs FOR UPDATE
TO authenticated
USING (business_id IN (SELECT id FROM public.businesses WHERE user_id = (SELECT auth.uid())))
WITH CHECK (business_id IN (SELECT id FROM public.businesses WHERE user_id = (SELECT auth.uid())));
```

4. **updated_at trigger**:
```sql
CREATE TRIGGER send_logs_updated_at
  BEFORE UPDATE ON public.send_logs
  FOR EACH ROW EXECUTE FUNCTION extensions.moddatetime(updated_at);
```

5. **Add opted_out to contacts**:
```sql
ALTER TABLE public.contacts
  ADD COLUMN IF NOT EXISTS opted_out BOOLEAN NOT NULL DEFAULT false;

CREATE INDEX IF NOT EXISTS idx_contacts_sendable
ON public.contacts USING btree (business_id, status, opted_out)
WHERE status = 'active' AND opted_out = false;
```

6. **Add tier to businesses** (for MVP limit enforcement):
```sql
ALTER TABLE public.businesses
  ADD COLUMN IF NOT EXISTS tier TEXT NOT NULL DEFAULT 'basic',
  ADD CONSTRAINT businesses_tier_valid CHECK (tier IN ('basic', 'pro', 'trial'));
```
  </action>
  <verify>File exists at supabase/migrations/00005_create_send_logs.sql and contains CREATE TABLE, RLS policies, and ALTER TABLE statements</verify>
  <done>Migration file complete with send_logs table, indexes, RLS policies, opted_out column, and tier column</done>
</task>

<task type="auto">
  <name>Task 2: Add SendLog types to database.ts</name>
  <files>lib/types/database.ts</files>
  <action>
Add to existing lib/types/database.ts file:

1. **SendLog interface** (after Contact interface):
```typescript
export interface SendLog {
  id: string
  business_id: string
  contact_id: string
  template_id: string | null
  status: 'pending' | 'sent' | 'delivered' | 'bounced' | 'complained' | 'failed' | 'opened'
  provider_id: string | null
  error_message: string | null
  subject: string
  created_at: string
  updated_at: string
}

export type SendLogInsert = Omit<SendLog, 'id' | 'created_at' | 'updated_at' | 'provider_id' | 'error_message'>
export type SendLogUpdate = Partial<Pick<SendLog, 'status' | 'provider_id' | 'error_message'>>
```

2. **Update Contact interface** - add opted_out field:
```typescript
// In Contact interface, add:
opted_out: boolean
```

3. **Update Business interface** - add tier field:
```typescript
// In Business interface, add:
tier: 'basic' | 'pro' | 'trial'
```

4. **Add SendLogWithContact type** for history display:
```typescript
export interface SendLogWithContact extends SendLog {
  contacts: Pick<Contact, 'name' | 'email'>
}
```
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors in database.ts</verify>
  <done>SendLog, SendLogInsert, SendLogUpdate types exported; Contact has opted_out; Business has tier</done>
</task>

<task type="auto">
  <name>Task 3: Create send validation schemas</name>
  <files>lib/validations/send.ts</files>
  <action>
Create lib/validations/send.ts with Zod schemas:

```typescript
import { z } from 'zod'

/**
 * Schema for send review request action.
 * Validates required IDs and optional message customization.
 */
export const sendRequestSchema = z.object({
  contactId: z.string().uuid('Invalid contact ID'),
  templateId: z.string().uuid('Invalid template ID').optional(),
  // Optional message customization (if user edits before sending)
  customSubject: z.string().min(1, 'Subject is required').max(200, 'Subject too long').optional(),
  customBody: z.string().min(1, 'Message body is required').max(5000, 'Message too long').optional(),
})

/**
 * Schema for batch send (future use).
 */
export const batchSendSchema = z.object({
  contactIds: z.array(z.string().uuid()).min(1, 'Select at least one contact').max(50, 'Maximum 50 contacts per batch'),
  templateId: z.string().uuid('Invalid template ID').optional(),
})

export type SendRequest = z.infer<typeof sendRequestSchema>
export type BatchSendRequest = z.infer<typeof batchSendSchema>
```
  </action>
  <verify>Run `npx tsc --noEmit` - no errors; file exports sendRequestSchema, batchSendSchema, SendRequest, BatchSendRequest</verify>
  <done>Send validation schemas created with proper UUID validation and limits</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. Migration file has all required sections (table, indexes, RLS, triggers, ALTER TABLEs)
3. lib/types/database.ts exports SendLog, SendLogInsert, SendLogUpdate, SendLogWithContact
4. lib/validations/send.ts exports sendRequestSchema with proper validation
5. Contact interface includes opted_out: boolean
6. Business interface includes tier: 'basic' | 'pro' | 'trial'
</verification>

<success_criteria>
- Migration file ready for application to Supabase
- TypeScript types match migration schema exactly
- Zod validation schemas ready for Server Action use
- All new types properly exported
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-sending/04-01-SUMMARY.md`
</output>
