---
phase: 04-core-sending
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - lib/email/resend.ts
  - lib/email/templates/review-request.tsx
  - lib/rate-limit.ts
autonomous: true
user_setup:
  - service: resend
    why: "Email sending provider"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify sending domain"
        location: "Resend Dashboard -> Domains"
  - service: upstash
    why: "Serverless rate limiting"
    env_vars:
      - name: UPSTASH_REDIS_REST_URL
        source: "Upstash Console -> Database -> REST API -> URL"
      - name: UPSTASH_REDIS_REST_TOKEN
        source: "Upstash Console -> Database -> REST API -> Token"

must_haves:
  truths:
    - "Resend client can send emails"
    - "React Email template renders review request"
    - "Rate limiter can check and enforce limits"
  artifacts:
    - path: "lib/email/resend.ts"
      provides: "Resend client singleton"
      exports: ["resend"]
    - path: "lib/email/templates/review-request.tsx"
      provides: "React Email template for review requests"
      exports: ["ReviewRequestEmail"]
    - path: "lib/rate-limit.ts"
      provides: "Rate limiting configuration"
      exports: ["sendRatelimit"]
  key_links:
    - from: "lib/email/resend.ts"
      to: "process.env.RESEND_API_KEY"
      via: "environment variable"
      pattern: "process\\.env\\.RESEND_API_KEY"
    - from: "lib/rate-limit.ts"
      to: "process.env.UPSTASH_REDIS_REST_URL"
      via: "environment variable"
      pattern: "process\\.env\\.UPSTASH_REDIS"
---

<objective>
Set up email infrastructure with Resend client, React Email template, and Upstash rate limiting.

Purpose: Enable sending review request emails with professional templates and abuse protection.
Output: Configured email client, styled email template, and rate limiter ready for Server Action.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-sending/04-RESEARCH.md

@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install email and rate limiting packages</name>
  <files>package.json</files>
  <action>
Install required packages using pnpm:

```bash
pnpm add resend @react-email/components @react-email/render @upstash/ratelimit @upstash/redis
```

This adds:
- `resend` - Email sending API client
- `@react-email/components` - React components for emails (Html, Body, Container, etc.)
- `@react-email/render` - Render React components to HTML string
- `@upstash/ratelimit` - Serverless rate limiting
- `@upstash/redis` - Redis client for Upstash

Verify package.json is updated with all 5 dependencies.
  </action>
  <verify>Run `pnpm list resend @react-email/components @react-email/render @upstash/ratelimit @upstash/redis` - all packages listed</verify>
  <done>All 5 packages installed and listed in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create Resend client and email template</name>
  <files>lib/email/resend.ts, lib/email/templates/review-request.tsx</files>
  <action>
1. **Create lib/email directory** if it doesn't exist.

2. **Create lib/email/resend.ts**:
```typescript
import { Resend } from 'resend'

// Validate environment variable exists (will throw at module load if missing)
if (!process.env.RESEND_API_KEY) {
  throw new Error('RESEND_API_KEY environment variable is required')
}

// Export singleton Resend client
export const resend = new Resend(process.env.RESEND_API_KEY)
```

3. **Create lib/email/templates/review-request.tsx**:
```tsx
import {
  Body,
  Container,
  Head,
  Heading,
  Html,
  Preview,
  Text,
  Button,
  Hr,
} from '@react-email/components'

export interface ReviewRequestEmailProps {
  customerName: string
  businessName: string
  reviewLink: string
  senderName: string
}

export function ReviewRequestEmail({
  customerName,
  businessName,
  reviewLink,
  senderName,
}: ReviewRequestEmailProps) {
  return (
    <Html>
      <Head />
      <Preview>Share your experience with {businessName}</Preview>
      <Body style={main}>
        <Container style={container}>
          <Heading style={h1}>Hi {customerName},</Heading>

          <Text style={text}>
            Thank you for choosing {businessName}! We&apos;d really appreciate it if
            you could take a moment to share your experience.
          </Text>

          <Button href={reviewLink} style={button}>
            Leave a Review
          </Button>

          <Hr style={divider} />

          <Text style={footer}>
            Thanks so much,
            <br />
            {senderName}
          </Text>
        </Container>
      </Body>
    </Html>
  )
}

// Email-safe styles (inline CSS required for email clients)
const main = {
  backgroundColor: '#f6f9fc',
  fontFamily:
    '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',
}

const container = {
  backgroundColor: '#ffffff',
  margin: '0 auto',
  padding: '40px 20px',
  borderRadius: '4px',
  maxWidth: '580px',
}

const h1 = {
  color: '#1a1a1a',
  fontSize: '24px',
  fontWeight: '600' as const,
  lineHeight: '1.3',
  margin: '0 0 20px',
}

const text = {
  color: '#4a4a4a',
  fontSize: '16px',
  lineHeight: '1.6',
  margin: '0 0 24px',
}

const button = {
  backgroundColor: '#2563eb',
  borderRadius: '6px',
  color: '#ffffff',
  fontSize: '16px',
  fontWeight: '600' as const,
  textDecoration: 'none',
  textAlign: 'center' as const,
  display: 'block',
  padding: '12px 24px',
  margin: '0 auto',
}

const divider = {
  borderColor: '#e6e6e6',
  margin: '32px 0',
}

const footer = {
  color: '#6a6a6a',
  fontSize: '14px',
  lineHeight: '1.5',
}

export default ReviewRequestEmail
```

Note: Use `&apos;` for apostrophe in JSX text content to avoid ESLint react/no-unescaped-entities warning.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors in email files; files export resend and ReviewRequestEmail</verify>
  <done>Resend client singleton created; React Email template with proper styling and props</done>
</task>

<task type="auto">
  <name>Task 3: Create rate limiter configuration</name>
  <files>lib/rate-limit.ts</files>
  <action>
Create lib/rate-limit.ts with Upstash rate limiter:

```typescript
import { Ratelimit } from '@upstash/ratelimit'
import { Redis } from '@upstash/redis'

// Validate environment variables
if (!process.env.UPSTASH_REDIS_REST_URL || !process.env.UPSTASH_REDIS_REST_TOKEN) {
  // Don't throw in dev - allow app to run without rate limiting configured
  console.warn('Upstash Redis not configured - rate limiting disabled')
}

// Create Redis client (or null if not configured)
const redis = process.env.UPSTASH_REDIS_REST_URL && process.env.UPSTASH_REDIS_REST_TOKEN
  ? new Redis({
      url: process.env.UPSTASH_REDIS_REST_URL,
      token: process.env.UPSTASH_REDIS_REST_TOKEN,
    })
  : null

/**
 * Per-user rate limit for sending emails.
 * Allows 10 sends per minute to prevent abuse while allowing normal usage.
 * Returns { success: true } if not configured (dev mode bypass).
 */
export const sendRatelimit = redis
  ? new Ratelimit({
      redis,
      limiter: Ratelimit.slidingWindow(10, '1 m'),
      prefix: 'ratelimit:send',
    })
  : null

/**
 * Check rate limit for a user.
 * Returns { success: true, remaining: number } or { success: false } if limited.
 * Bypasses in development if Upstash not configured.
 */
export async function checkSendRateLimit(userId: string): Promise<{
  success: boolean
  remaining?: number
}> {
  if (!sendRatelimit) {
    // No rate limiting configured - allow all requests (dev mode)
    return { success: true, remaining: 999 }
  }

  const result = await sendRatelimit.limit(userId)
  return {
    success: result.success,
    remaining: result.remaining,
  }
}
```

This design:
- Gracefully handles missing Upstash config (dev mode)
- Provides helper function for clean usage in Server Actions
- Uses sliding window algorithm (10 per minute)
- Returns remaining count for UI feedback
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors; file exports sendRatelimit and checkSendRateLimit</verify>
  <done>Rate limiter with dev-mode bypass and helper function ready</done>
</task>

</tasks>

<verification>
1. `pnpm list resend @react-email/components @react-email/render @upstash/ratelimit @upstash/redis` shows all packages
2. `npx tsc --noEmit` passes without errors
3. lib/email/resend.ts exports resend
4. lib/email/templates/review-request.tsx exports ReviewRequestEmail with proper props interface
5. lib/rate-limit.ts exports sendRatelimit and checkSendRateLimit
6. All imports resolve correctly
</verification>

<success_criteria>
- All 5 npm packages installed
- Resend client singleton ready for import
- React Email template renders review request with customizable props
- Rate limiter configured with dev-mode bypass
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-sending/04-02-SUMMARY.md`
</output>
