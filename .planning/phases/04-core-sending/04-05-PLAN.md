---
phase: 04-core-sending
plan: 05
type: execute
wave: 3
depends_on: ["04-03"]
files_modified:
  - app/(dashboard)/send/page.tsx
  - components/send/contact-selector.tsx
  - components/send/message-preview.tsx
  - components/send/send-form.tsx
autonomous: false

must_haves:
  truths:
    - "User can select a contact from dropdown or search"
    - "User sees message preview before sending"
    - "User can edit subject line before sending"
    - "User can edit message body before sending"
    - "User sees 'Sent' confirmation after successful send"
    - "User sees clear error if send fails"
    - "Send button disabled during sending with loading indicator"
  artifacts:
    - path: "app/(dashboard)/send/page.tsx"
      provides: "Send review request page"
      min_lines: 30
    - path: "components/send/send-form.tsx"
      provides: "Main send form with contact selection and preview"
      min_lines: 100
    - path: "components/send/contact-selector.tsx"
      provides: "Contact dropdown/search component"
      min_lines: 50
    - path: "components/send/message-preview.tsx"
      provides: "Email preview with subject and body edit capability"
      min_lines: 80
  key_links:
    - from: "components/send/send-form.tsx"
      to: "lib/actions/send.ts"
      via: "Server Action import"
      pattern: "import.*sendReviewRequest"
    - from: "app/(dashboard)/send/page.tsx"
      to: "lib/data/send-logs.ts"
      via: "data fetching"
      pattern: "getMonthlyUsage"
---

<objective>
Create the send review request UI with contact selection, message preview, and confirmation.

Purpose: Enable users to select a contact, preview/edit the message, and send with immediate feedback.
Output: Complete send flow UI matching existing dashboard patterns.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-sending/04-RESEARCH.md
@.planning/phases/04-core-sending/04-03-SUMMARY.md

@app/(dashboard)/contacts/page.tsx
@components/contacts/add-contact-dialog.tsx
@lib/actions/send.ts
@lib/data/send-logs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Send page and contact selector component</name>
  <files>app/(dashboard)/send/page.tsx, components/send/contact-selector.tsx</files>
  <action>
1. **Create app/(dashboard)/send/page.tsx** (Server Component):
```tsx
import { getBusiness } from '@/lib/actions/business'
import { getContacts } from '@/lib/actions/contact'
import { getMonthlyUsage } from '@/lib/data/send-logs'
import { SendForm } from '@/components/send/send-form'
import { redirect } from 'next/navigation'

export default async function SendPage() {
  const business = await getBusiness()

  if (!business) {
    redirect('/dashboard/settings')
  }

  if (!business.google_review_link) {
    return (
      <div className="container mx-auto py-6 px-4">
        <h1 className="text-2xl font-bold mb-6">Send Review Request</h1>
        <div className="rounded-lg border border-yellow-200 bg-yellow-50 p-6">
          <h2 className="font-semibold text-yellow-800 mb-2">Setup Required</h2>
          <p className="text-yellow-700 mb-4">
            Please add your Google review link in settings before sending review requests.
          </p>
          <a
            href="/dashboard/settings"
            className="text-sm font-medium text-yellow-800 underline hover:no-underline"
          >
            Go to Settings
          </a>
        </div>
      </div>
    )
  }

  const [{ contacts }, usage] = await Promise.all([
    getContacts({ limit: 200 }),
    getMonthlyUsage(),
  ])

  // Filter to only sendable contacts (active, not opted out)
  const sendableContacts = contacts.filter(
    c => c.status === 'active' && !c.opted_out
  )

  return (
    <div className="container mx-auto py-6 px-4">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold">Send Review Request</h1>
        <div className="text-sm text-muted-foreground">
          {usage.count} / {usage.limit} sends this month
        </div>
      </div>

      {sendableContacts.length === 0 ? (
        <div className="rounded-lg border border-muted p-6 text-center">
          <p className="text-muted-foreground mb-4">
            No contacts available to send to. Add some contacts first!
          </p>
          <a
            href="/dashboard/contacts"
            className="text-sm font-medium text-primary underline hover:no-underline"
          >
            Go to Contacts
          </a>
        </div>
      ) : (
        <SendForm
          contacts={sendableContacts}
          business={business}
          templates={business.email_templates || []}
          monthlyUsage={usage}
        />
      )}
    </div>
  )
}
```

2. **Create components/send/contact-selector.tsx**:
```tsx
'use client'

import { useState, useMemo } from 'react'
import type { Contact } from '@/lib/types/database'

interface ContactSelectorProps {
  contacts: Contact[]
  selectedId: string | null
  onSelect: (contact: Contact | null) => void
}

export function ContactSelector({
  contacts,
  selectedId,
  onSelect,
}: ContactSelectorProps) {
  const [search, setSearch] = useState('')

  const filteredContacts = useMemo(() => {
    if (!search) return contacts
    const lower = search.toLowerCase()
    return contacts.filter(
      c => c.name.toLowerCase().includes(lower) || c.email.toLowerCase().includes(lower)
    )
  }, [contacts, search])

  const selectedContact = contacts.find(c => c.id === selectedId)

  // Calculate cooldown status
  const getCooldownStatus = (contact: Contact) => {
    if (!contact.last_sent_at) return null
    const lastSent = new Date(contact.last_sent_at)
    const cooldownEnd = new Date(lastSent.getTime() + 14 * 24 * 60 * 60 * 1000)
    if (new Date() < cooldownEnd) {
      const daysLeft = Math.ceil((cooldownEnd.getTime() - Date.now()) / (24 * 60 * 60 * 1000))
      return `${daysLeft}d cooldown`
    }
    return null
  }

  return (
    <div className="space-y-3">
      <label className="block text-sm font-medium">Select Contact</label>

      <input
        type="text"
        placeholder="Search contacts..."
        value={search}
        onChange={e => setSearch(e.target.value)}
        className="w-full px-3 py-2 border rounded-md text-sm"
      />

      {selectedContact && (
        <div className="flex items-center justify-between p-3 bg-primary/10 rounded-md">
          <div>
            <div className="font-medium">{selectedContact.name}</div>
            <div className="text-sm text-muted-foreground">{selectedContact.email}</div>
          </div>
          <button
            type="button"
            onClick={() => onSelect(null)}
            className="text-sm text-primary hover:underline"
          >
            Change
          </button>
        </div>
      )}

      {!selectedContact && (
        <div className="max-h-60 overflow-y-auto border rounded-md divide-y">
          {filteredContacts.length === 0 ? (
            <div className="p-4 text-center text-muted-foreground text-sm">
              No contacts found
            </div>
          ) : (
            filteredContacts.map(contact => {
              const cooldown = getCooldownStatus(contact)
              const disabled = !!cooldown

              return (
                <button
                  key={contact.id}
                  type="button"
                  disabled={disabled}
                  onClick={() => onSelect(contact)}
                  className={`w-full p-3 text-left hover:bg-muted/50 ${
                    disabled ? 'opacity-50 cursor-not-allowed' : ''
                  }`}
                >
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="font-medium">{contact.name}</div>
                      <div className="text-sm text-muted-foreground">{contact.email}</div>
                    </div>
                    {cooldown && (
                      <span className="text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded">
                        {cooldown}
                      </span>
                    )}
                    {contact.send_count > 0 && !cooldown && (
                      <span className="text-xs text-muted-foreground">
                        Sent {contact.send_count}x
                      </span>
                    )}
                  </div>
                </button>
              )
            })
          )}
        </div>
      )}

      {/* Hidden input for form submission */}
      <input type="hidden" name="contactId" value={selectedId || ''} />
    </div>
  )
}
```
  </action>
  <verify>Files exist and export correct components; `npx tsc --noEmit` passes</verify>
  <done>Send page fetches data and renders SendForm; ContactSelector shows searchable list with cooldown status</done>
</task>

<task type="auto">
  <name>Task 2: Create message preview and main send form</name>
  <files>components/send/message-preview.tsx, components/send/send-form.tsx</files>
  <action>
1. **Create components/send/message-preview.tsx**:
```tsx
'use client'

import { useState } from 'react'
import type { Contact, Business, EmailTemplate } from '@/lib/types/database'

interface MessagePreviewProps {
  contact: Contact | null
  business: Business
  template: EmailTemplate | null
  customSubject: string
  customBody: string
  onSubjectChange: (subject: string) => void
  onBodyChange: (body: string) => void
}

export function MessagePreview({
  contact,
  business,
  template,
  customSubject,
  customBody,
  onSubjectChange,
  onBodyChange,
}: MessagePreviewProps) {
  const [isEditingSubject, setIsEditingSubject] = useState(false)
  const [isEditingBody, setIsEditingBody] = useState(false)

  const defaultSubject = template?.subject || `${business.name} would love your feedback!`
  const defaultBody = template?.body || `Thank you for choosing ${business.name}! We'd really appreciate it if you could take a moment to share your experience.`
  const displaySubject = customSubject || defaultSubject
  const displayBody = customBody || defaultBody
  const senderName = business.default_sender_name || business.name

  if (!contact) {
    return (
      <div className="rounded-lg border border-dashed p-6 text-center text-muted-foreground">
        Select a contact to preview the message
      </div>
    )
  }

  return (
    <div className="rounded-lg border overflow-hidden">
      <div className="bg-muted/30 px-4 py-3 border-b">
        <div className="text-sm text-muted-foreground mb-1">Preview</div>
        <div className="flex items-center justify-between">
          {isEditingSubject ? (
            <input
              type="text"
              value={customSubject || defaultSubject}
              onChange={e => onSubjectChange(e.target.value)}
              onBlur={() => setIsEditingSubject(false)}
              autoFocus
              className="flex-1 px-2 py-1 border rounded text-sm font-medium"
            />
          ) : (
            <button
              type="button"
              onClick={() => setIsEditingSubject(true)}
              className="text-left group"
            >
              <span className="font-medium">{displaySubject}</span>
              <span className="ml-2 text-xs text-primary opacity-0 group-hover:opacity-100">
                Edit
              </span>
            </button>
          )}
        </div>
      </div>

      <div className="p-6 bg-gray-50">
        <div className="bg-white rounded-lg p-6 shadow-sm max-w-lg mx-auto">
          <h2 className="text-xl font-semibold mb-4">Hi {contact.name},</h2>

          {isEditingBody ? (
            <textarea
              value={customBody || defaultBody}
              onChange={e => onBodyChange(e.target.value)}
              onBlur={() => setIsEditingBody(false)}
              autoFocus
              rows={4}
              className="w-full px-3 py-2 border rounded text-sm text-gray-600 mb-6"
            />
          ) : (
            <button
              type="button"
              onClick={() => setIsEditingBody(true)}
              className="text-left group w-full"
            >
              <p className="text-gray-600 mb-6">
                {displayBody}
                <span className="ml-2 text-xs text-primary opacity-0 group-hover:opacity-100">
                  Edit
                </span>
              </p>
            </button>
          )}

          <div className="text-center mb-6">
            <span className="inline-block bg-blue-600 text-white px-6 py-3 rounded-md font-medium">
              Leave a Review
            </span>
          </div>

          <hr className="my-6 border-gray-200" />

          <p className="text-gray-500 text-sm">
            Thanks so much,<br />
            {senderName}
          </p>
        </div>
      </div>

      {/* Hidden inputs for form */}
      {customSubject && (
        <input type="hidden" name="customSubject" value={customSubject} />
      )}
      {customBody && (
        <input type="hidden" name="customBody" value={customBody} />
      )}
    </div>
  )
}
```

2. **Create components/send/send-form.tsx**:
```tsx
'use client'

import { useActionState, useEffect, useState } from 'react'
import { sendReviewRequest } from '@/lib/actions/send'
import { ContactSelector } from './contact-selector'
import { MessagePreview } from './message-preview'
import type { Contact, Business, EmailTemplate } from '@/lib/types/database'
import { CheckCircle2, Loader2, AlertCircle } from 'lucide-react'

interface SendFormProps {
  contacts: Contact[]
  business: Business & { email_templates?: EmailTemplate[] }
  templates: EmailTemplate[]
  monthlyUsage: { count: number; limit: number; tier: string }
}

export function SendForm({
  contacts,
  business,
  templates,
  monthlyUsage,
}: SendFormProps) {
  const [selectedContact, setSelectedContact] = useState<Contact | null>(null)
  const [selectedTemplate, setSelectedTemplate] = useState<EmailTemplate | null>(
    templates.find(t => t.is_default) || templates[0] || null
  )
  const [customSubject, setCustomSubject] = useState('')
  const [customBody, setCustomBody] = useState('')
  const [showSuccess, setShowSuccess] = useState(false)

  const [state, formAction, isPending] = useActionState(sendReviewRequest, null)

  // Handle successful send
  useEffect(() => {
    if (state?.success) {
      setShowSuccess(true)
      // Reset form after showing success
      setTimeout(() => {
        setSelectedContact(null)
        setCustomSubject('')
        setCustomBody('')
        setShowSuccess(false)
      }, 3000)
    }
  }, [state?.success])

  const atLimit = monthlyUsage.count >= monthlyUsage.limit

  if (showSuccess) {
    return (
      <div className="rounded-lg border border-green-200 bg-green-50 p-8 text-center">
        <CheckCircle2 className="w-12 h-12 text-green-600 mx-auto mb-4" />
        <h2 className="text-xl font-semibold text-green-800 mb-2">
          Review Request Sent!
        </h2>
        <p className="text-green-700">
          Your message to {selectedContact?.name} has been sent successfully.
        </p>
      </div>
    )
  }

  return (
    <form action={formAction} className="space-y-6">
      {/* Error display */}
      {state?.error && (
        <div className="rounded-lg border border-red-200 bg-red-50 p-4 flex items-start gap-3">
          <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
          <div>
            <p className="font-medium text-red-800">Unable to send</p>
            <p className="text-sm text-red-700">{state.error}</p>
          </div>
        </div>
      )}

      {/* Limit warning */}
      {atLimit && (
        <div className="rounded-lg border border-yellow-200 bg-yellow-50 p-4">
          <p className="font-medium text-yellow-800">Monthly limit reached</p>
          <p className="text-sm text-yellow-700">
            You&apos;ve used all {monthlyUsage.limit} sends this month.
            {monthlyUsage.tier !== 'pro' && ' Upgrade to Pro for more sends.'}
          </p>
        </div>
      )}

      <div className="grid gap-6 md:grid-cols-2">
        {/* Left column: Contact selection + template */}
        <div className="space-y-6">
          <ContactSelector
            contacts={contacts}
            selectedId={selectedContact?.id || null}
            onSelect={setSelectedContact}
          />

          {templates.length > 1 && (
            <div className="space-y-2">
              <label className="block text-sm font-medium">Template</label>
              <select
                className="w-full px-3 py-2 border rounded-md text-sm"
                value={selectedTemplate?.id || ''}
                onChange={e => {
                  const tpl = templates.find(t => t.id === e.target.value)
                  setSelectedTemplate(tpl || null)
                  setCustomSubject('') // Reset custom values when template changes
                  setCustomBody('')
                }}
              >
                {templates.map(t => (
                  <option key={t.id} value={t.id}>
                    {t.name} {t.is_default && '(Default)'}
                  </option>
                ))}
              </select>
              <input type="hidden" name="templateId" value={selectedTemplate?.id || ''} />
            </div>
          )}
        </div>

        {/* Right column: Preview */}
        <div>
          <MessagePreview
            contact={selectedContact}
            business={business}
            template={selectedTemplate}
            customSubject={customSubject}
            customBody={customBody}
            onSubjectChange={setCustomSubject}
            onBodyChange={setCustomBody}
          />
        </div>
      </div>

      {/* Submit button */}
      <div className="flex justify-end pt-4 border-t">
        <button
          type="submit"
          disabled={!selectedContact || isPending || atLimit}
          className="inline-flex items-center px-6 py-3 rounded-md bg-primary text-primary-foreground font-medium hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {isPending ? (
            <>
              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
              Sending...
            </>
          ) : (
            'Send Review Request'
          )}
        </button>
      </div>
    </form>
  )
}
```
  </action>
  <verify>`npx tsc --noEmit` passes; components export correctly</verify>
  <done>Message preview shows editable subject and body; SendForm orchestrates full send flow with success/error states; customBody passed via hidden input</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete send review request UI with contact selection, message preview, and confirmation</what-built>
  <how-to-verify>
1. Start dev server: `pnpm dev`
2. Log in and ensure you have:
   - A business with Google review link configured
   - At least one active contact
3. Navigate to `/dashboard/send`
4. Verify:
   - Monthly usage counter shows in header
   - Contact list displays with search
   - Selecting a contact shows message preview
   - Subject can be edited by clicking
   - "Send Review Request" button is enabled
5. Test editing:
   - Click subject to edit it
   - Click message body to edit it
   - Verify changes appear in preview
6. Test send flow:
   - Click "Send Review Request"
   - Verify loading state shows
   - Verify success message appears (or error if Resend not configured)
7. Verify cooldown:
   - After sending, contact should show cooldown badge
   - Contact should be disabled in selector
  </how-to-verify>
  <resume-signal>Type "approved" when send UI works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. `pnpm lint` passes
3. Send page at /dashboard/send loads correctly
4. Contact selector shows searchable list with cooldown indicators
5. Message preview renders with contact name and business details
6. Subject editing works (click to edit)
7. Body editing works (click to edit)
8. Send button triggers Server Action
8. Success state displays after successful send
9. Error state displays on failure
</verification>

<success_criteria>
- User can select contact from searchable dropdown
- User can see and edit subject line
- User can see and edit message body
- User sees styled email preview
- Send button shows loading state
- Success confirmation displays after send
- Error messages display on failure
- Cooldown status visible on recently-sent contacts
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-sending/04-05-SUMMARY.md`
</output>
