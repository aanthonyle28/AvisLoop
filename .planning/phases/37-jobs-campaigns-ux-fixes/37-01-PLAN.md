---
phase: 37-jobs-campaigns-ux-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/actions/job.ts
  - lib/actions/campaign.ts
  - components/campaigns/campaign-form.tsx
  - components/campaigns/touch-sequence-editor.tsx
autonomous: true

must_haves:
  truths:
    - "Creating a new job via the Add Job sheet succeeds end-to-end and the job appears in the jobs table"
    - "Editing a campaign's touch sequence (changing delay, channel, or template) and saving persists the changes — reloading shows the updated touches"
  artifacts:
    - path: "lib/actions/job.ts"
      provides: "Fixed createJob server action"
    - path: "lib/actions/campaign.ts"
      provides: "Fixed updateCampaign server action with debug logging"
    - path: "components/campaigns/campaign-form.tsx"
      provides: "Campaign form with proper dirty tracking for touches array"
  key_links:
    - from: "components/campaigns/campaign-form.tsx"
      to: "lib/actions/campaign.ts"
      via: "updateCampaign call with form data including touches"
      pattern: "updateCampaign.*campaign\\.id.*data"
    - from: "components/campaigns/touch-sequence-editor.tsx"
      to: "components/campaigns/campaign-form.tsx"
      via: "onChange callback -> setValue('touches', newTouches)"
      pattern: "setValue\\('touches'"
---

<objective>
Fix the two known bugs: job creation failure (JC-03) and campaign save/touch persistence failure (JC-08).

Purpose: These bugs block core V2 workflows — job creation is THE primary user action, and campaign editing is critical for setup. Both must work before any further UX changes to these flows.

Output: Working job creation and campaign edit save flows, verified by typecheck + lint passing.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-jobs-campaigns-ux-fixes/37-RESEARCH.md

Key files:
@lib/actions/job.ts
@lib/actions/campaign.ts
@components/campaigns/campaign-form.tsx
@components/campaigns/touch-sequence-editor.tsx
@components/jobs/add-job-sheet.tsx
@lib/validations/campaign.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix job creation bug (JC-03)</name>
  <files>lib/actions/job.ts, components/jobs/add-job-sheet.tsx</files>
  <action>
  Investigate and fix the job creation bug. The research identified these potential causes (in priority order):

  1. **Most likely — try creating a job via the running app or trace the code path manually:**
     - Run `pnpm dev` and attempt to create a job via the Add Job sheet
     - Check browser console and terminal for any error messages
     - If the error is from Supabase (RLS, constraint violation), the fix is in the migration/RLS
     - If the error is from Zod validation, check what field is failing

  2. **Possible code issue — FormData population:**
     - In `add-job-sheet.tsx`, `handleSubmit` manually sets `serviceType` via `formData.set('serviceType', serviceType)` where `serviceType` state could be `''` (empty string)
     - The submit button has `disabled={!serviceType}` guard but check if this guard fires correctly
     - In `createJob` (lib/actions/job.ts line 62), `const status = formData.get('status') as string || 'scheduled'` — if status is empty string, `||` won't trigger (empty string is falsy, so it WILL fall through to 'scheduled' — this is actually correct)
     - Check if `enrollInCampaign` handling (line 64-65) is correct: `enrollInCampaignValue === null` returns `true` (the default). When status is 'scheduled', `enrollInCampaign` is not set in formData, so `formData.get('enrollInCampaign')` returns `null`, and `null === null` is `true`. This means `enrollInCampaign` is always `true` for scheduled jobs. This is fine because enrollment only happens when status is 'completed' (line 162).

  3. **Fix approach based on findings:**
     - If the bug is environmental (works in code review but fails at runtime), add detailed error logging to `createJob`:
       - Log the parsed form data values before Zod validation
       - Log the Zod parse result on failure
       - Log the Supabase insert error details
     - If the bug is a specific code issue, fix it directly
     - Ensure the `formData.set('serviceType', serviceType)` line handles the case where `serviceType` is empty string — add a guard before submission or validate earlier

  4. **Defensive improvement regardless of root cause:**
     - In `createJob`, add a check for empty `serviceType` before Zod validation: if `!serviceType`, return `{ fieldErrors: { serviceType: ['Service type is required'] } }`
     - This provides a better user-facing error instead of a cryptic Zod enum failure
  </action>
  <verify>
  - `pnpm typecheck` passes
  - `pnpm lint` passes
  - Manually trace the createJob flow: formData with valid customer, service type, and status should produce a successful insert
  </verify>
  <done>The createJob server action handles edge cases (empty serviceType, missing fields) with clear error messages, and the defensive checks ensure robust job creation.</done>
</task>

<task type="auto">
  <name>Task 2: Fix campaign save bug — touch sequences not persisting (JC-08)</name>
  <files>components/campaigns/campaign-form.tsx, lib/actions/campaign.ts</files>
  <action>
  Fix the campaign edit save bug where touch sequences don't persist. The research identified the most likely cause:

  **Root cause: react-hook-form `setValue` not triggering dirty tracking for the touches array.**

  In `campaign-form.tsx`:
  - `TouchSequenceEditor` calls `onChange` which calls `setValue('touches', newTouches)`
  - `react-hook-form`'s `setValue` does NOT mark the field as dirty by default
  - When `handleSubmit` runs, if the form doesn't consider `touches` as changed, it may submit the original `defaultValues` touches

  **Fix (HIGH confidence):**

  1. In `campaign-form.tsx` line 143, change:
     ```typescript
     onChange={(newTouches) => setValue('touches', newTouches)}
     ```
     to:
     ```typescript
     onChange={(newTouches) => setValue('touches', newTouches, { shouldDirty: true, shouldValidate: true })}
     ```

  2. **However**, this alone may not fix it if `handleSubmit` uses `defaultValues` for non-dirty fields. Verify by checking what data `onSubmit` receives. The `handleSubmit(onSubmit)` pattern passes ALL form values (not just dirty ones) to `onSubmit`, so dirty tracking shouldn't affect the submitted data.

  3. **Alternative root cause — stale closure:** The `watches('touches')` returns the current value, passed to `TouchSequenceEditor`. If `TouchSequenceEditor` modifies touches and calls `onChange`, which calls `setValue`, the `watch` should return updated values. But if there's a stale reference issue, the submitted data could have old values.

  4. **Definitive fix approach:**
     - Add `{ shouldDirty: true, shouldValidate: true }` to the `setValue` call (good practice regardless)
     - Add console.log in `onSubmit` to log `data.touches` and verify the correct touches are being submitted
     - Add console.log in `updateCampaign` to log the `touchesJson` before the RPC call
     - Check if the `template_id` field causes issues — when "Use default template" is selected, `template_id` is `null`. Verify the RPC handles null correctly.

  5. **Also check:** The `personalization_enabled` field uses `setValue` with the Switch. If that persists correctly but touches don't, the issue is specific to the touches array (complex object vs boolean).

  6. **If the RPC is the issue:** Check the `replace_campaign_touches` migration was applied. Run `SELECT * FROM pg_proc WHERE proname = 'replace_campaign_touches'` to verify. If the function doesn't exist, the RPC call would return an error — but the action already handles that (line 154).

  After identifying and fixing the issue, remove any temporary console.log statements (or leave them as comments for future debugging).
  </action>
  <verify>
  - `pnpm typecheck` passes
  - `pnpm lint` passes
  - The `setValue` call for touches includes `{ shouldDirty: true, shouldValidate: true }`
  - The `onSubmit` handler correctly receives updated touch data
  </verify>
  <done>Campaign form correctly tracks touch sequence changes and the updateCampaign action persists them via the RPC. Editing a touch (changing delay, channel, or template) and saving reflects the changes on reload.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with zero errors
2. `pnpm lint` passes with zero errors
3. The createJob action in `lib/actions/job.ts` has defensive checks for empty serviceType
4. The campaign form's touch `setValue` includes dirty tracking options
5. No regressions in existing form behavior (scheduled/completed job status selection, campaign create flow)
</verification>

<success_criteria>
- Job creation works end-to-end (from Add Job sheet to database insert to success toast)
- Campaign touch editing persists (change delay hours, save, reload — delay is updated)
- Both fixes are defensive and handle edge cases with clear error messages
- Typecheck and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/37-jobs-campaigns-ux-fixes/37-01-SUMMARY.md`
</output>
