---
phase: 13-scheduling-and-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/data/scheduled.ts
  - components/layout/app-shell.tsx
  - components/layout/sidebar.tsx
  - components/layout/bottom-nav.tsx
  - app/(dashboard)/layout.tsx
  - app/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar includes a Scheduled link with pending count badge when count > 0"
    - "Mobile bottom nav includes a Scheduled link with pending count badge"
    - "Dashboard shows count of pending scheduled sends"
  artifacts:
    - path: "lib/data/scheduled.ts"
      provides: "getPendingScheduledCount server data function"
      exports: ["getPendingScheduledCount"]
    - path: "components/layout/sidebar.tsx"
      provides: "Scheduled nav item with badge"
      contains: "Scheduled"
    - path: "components/layout/bottom-nav.tsx"
      provides: "Scheduled nav item with badge"
      contains: "Scheduled"
    - path: "app/dashboard/page.tsx"
      provides: "Pending scheduled count display"
      contains: "getPendingScheduledCount"
  key_links:
    - from: "app/(dashboard)/layout.tsx"
      to: "lib/data/scheduled.ts"
      via: "Server Component fetches count, passes as prop"
      pattern: "getPendingScheduledCount"
    - from: "components/layout/sidebar.tsx"
      to: "/scheduled"
      via: "Nav link href"
      pattern: "href.*scheduled"
    - from: "components/layout/bottom-nav.tsx"
      to: "/scheduled"
      via: "Nav link href"
      pattern: "href.*scheduled"
---

<objective>
Add "Scheduled" navigation item with pending count badge to sidebar and mobile bottom nav, and show pending scheduled sends count on the dashboard.

Purpose: Users need to discover and access the scheduling feature from anywhere in the app (NAV-01, NAV-02).
Output: Navigation links with dynamic badge counts, dashboard stat card for pending sends.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-scheduling-and-navigation/13-RESEARCH.md

Key existing files:
@lib/data/send-logs.ts (pattern for server data functions)
@components/layout/sidebar.tsx (client component, NavItem pattern with mainNav array)
@components/layout/bottom-nav.tsx (client component, items array with 4 nav items)
@components/layout/app-shell.tsx (currently no props, wraps Sidebar + BottomNav)
@app/(dashboard)/layout.tsx (Server Component, renders AppShell)
@app/dashboard/page.tsx (Server Component, fetches data in parallel)
@components/ui/badge.tsx (Badge component with variant support)
@lib/types/database.ts (ScheduledSend type already defined)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create getPendingScheduledCount and wire count through navigation</name>
  <files>
    lib/data/scheduled.ts
    components/layout/app-shell.tsx
    components/layout/sidebar.tsx
    components/layout/bottom-nav.tsx
    app/(dashboard)/layout.tsx
  </files>
  <action>
    1. Create `lib/data/scheduled.ts` with a `getPendingScheduledCount()` function:
       - Import createClient from `@/lib/supabase/server`
       - Get authenticated user, then get their business_id
       - Query `scheduled_sends` with `.select('*', { count: 'exact', head: true }).eq('business_id', business.id).eq('status', 'pending')`
       - Return `count || 0` (return 0 for unauthenticated/no-business cases)
       - Follow the pattern from `lib/data/send-logs.ts`

    2. Update `app/(dashboard)/layout.tsx`:
       - Make the default export an async Server Component
       - Import and call `getPendingScheduledCount()`
       - Pass `scheduledCount` prop to `AppShell`

    3. Update `components/layout/app-shell.tsx`:
       - Add `scheduledCount?: number` to AppShellProps
       - Pass `scheduledCount` to both `Sidebar` and `BottomNav` components

    4. Update `components/layout/sidebar.tsx`:
       - Add `scheduledCount?: number` prop to the Sidebar component
       - Import `Calendar` from lucide-react (for the Scheduled icon)
       - Add `{ icon: Calendar, label: 'Scheduled', href: '/scheduled' }` to `mainNav` array, positioned after Send and before History
       - Import Badge from `@/components/ui/badge`
       - In the NavLink component, accept an optional `count` prop
       - When rendering the Scheduled nav item, pass `scheduledCount` as the count prop
       - Display `<Badge variant="secondary" className="ml-auto text-xs px-1.5 py-0">{count > 99 ? '99+' : count}</Badge>` when count > 0 and sidebar is not collapsed
       - When collapsed and count > 0, show a small dot indicator (4x4 bg-primary rounded-full absolute top-0 right-0)

    5. Update `components/layout/bottom-nav.tsx`:
       - Add `scheduledCount?: number` prop to BottomNav
       - Import `Calendar` from lucide-react
       - Add `{ icon: Calendar, label: 'Scheduled', href: '/scheduled' }` to items array after Send, before History
       - Update `grid-cols-4` to `grid-cols-5` since there are now 5 items
       - Show a small badge indicator when scheduledCount > 0: a small circle with the count positioned at the top-right of the icon, using absolute positioning within a relative container. Cap display at "9+" for mobile (smaller space).

    IMPORTANT: The sidebar and bottom-nav are "use client" components. They cannot call server functions directly. The count MUST be passed as a prop from the Server Component layout through AppShell.
  </action>
  <verify>
    - `pnpm typecheck` passes with no errors
    - `pnpm lint` passes
    - Grep for "getPendingScheduledCount" in layout.tsx confirms it is called
    - Grep for "Scheduled" in sidebar.tsx and bottom-nav.tsx confirms nav items exist
    - Grep for "scheduledCount" in app-shell.tsx confirms prop is passed through
  </verify>
  <done>
    - Sidebar shows "Scheduled" nav item with Calendar icon between Send and History
    - Sidebar shows badge count when scheduledCount > 0, hidden when 0
    - Mobile bottom nav shows "Scheduled" with 5 items in grid
    - Count is fetched server-side in layout and passed as prop
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pending scheduled sends count to dashboard</name>
  <files>
    app/dashboard/page.tsx
  </files>
  <action>
    1. In `app/dashboard/page.tsx`:
       - Import `getPendingScheduledCount` from `@/lib/data/scheduled`
       - Import `Calendar` from lucide-react
       - Add `getPendingScheduledCount()` to the existing `Promise.all` call (the one that already fetches onboarding status, business, usage, contacts, and response rate)
       - Add a new stat card in the "Quick stats cards" grid (the `grid gap-4 sm:grid-cols-2` div), after the existing cards:
         - Same card pattern as "Sends This Month" and "Contacts" cards
         - Icon: Calendar with bg-primary/10 background
         - Title: "Scheduled"
         - Value: the pending count number (large text)
         - Subtitle: "pending" (muted text)
         - Link: "View scheduled" linking to /scheduled
       - Update the grid to `sm:grid-cols-3` if there are now 4 stat cards (Sends, Contacts, Response Rate, Scheduled), so they fit better. Or keep `sm:grid-cols-2` if 4 cards look fine in 2x2.

    NOTE: The ResponseRateCard is already a separate component. Keep the Scheduled card inline like the other two cards for consistency (no need for a separate component for a simple stat display).
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm lint` passes
    - Grep for "Scheduled" in dashboard/page.tsx confirms stat card exists
    - Grep for "getPendingScheduledCount" in dashboard/page.tsx confirms data is fetched
  </verify>
  <done>
    - Dashboard shows a "Scheduled" stat card with pending count
    - Card links to /scheduled page
    - Count is fetched in parallel with other dashboard data
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` -- all files compile without errors
2. `pnpm lint` -- no lint errors introduced
3. Sidebar has 5 main nav items: Dashboard, Contacts, Send, Scheduled, History
4. Bottom nav has 5 items in a 5-column grid
5. Dashboard has a Scheduled stat card with pending count
6. Count is fetched from server and passed as props (no client-side fetching)
</verification>

<success_criteria>
- NAV-01: Sidebar and mobile bottom nav include "Scheduled" link with pending count badge
- NAV-02: Dashboard shows count of pending scheduled sends
- All data fetching happens server-side
- Typecheck and lint pass cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-scheduling-and-navigation/13-01-SUMMARY.md`
</output>
