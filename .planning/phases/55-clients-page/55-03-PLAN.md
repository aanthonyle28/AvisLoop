---
phase: 55-clients-page
plan: 03
type: execute
wave: 3
depends_on: ["55-01", "55-02"]
files_modified:
  - components/businesses/business-detail-drawer.tsx
  - components/businesses/businesses-client.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a card opens a detail drawer showing all agency metadata fields"
    - "User can toggle edit mode and modify all metadata fields (ratings, fee, competitor info, dates, GBP access)"
    - "Saving edits persists changes to the database and updates the card grid"
    - "Notes field auto-saves with 500ms debounce and flushes on drawer close"
    - "Drawer includes side-by-side competitive analysis section showing client vs competitor reviews"
    - "Drawer includes a 'Switch to this business' button that calls switchBusiness action"
  artifacts:
    - path: "components/businesses/business-detail-drawer.tsx"
      provides: "Full detail drawer with view/edit modes, auto-save notes, competitive analysis"
      contains: "BusinessDetailDrawer"
      min_lines: 150
    - path: "components/businesses/businesses-client.tsx"
      provides: "Updated client shell with drawer integration"
      contains: "BusinessDetailDrawer"
  key_links:
    - from: "components/businesses/business-detail-drawer.tsx"
      to: "lib/actions/business-metadata.ts"
      via: "Server action calls for metadata and notes"
      pattern: "updateBusinessMetadata|updateBusinessNotes"
    - from: "components/businesses/business-detail-drawer.tsx"
      to: "lib/validations/business-metadata.ts"
      via: "Client-side pre-validation before save"
      pattern: "businessMetadataSchema"
    - from: "components/businesses/businesses-client.tsx"
      to: "components/businesses/business-detail-drawer.tsx"
      via: "Drawer rendered with selectedBusiness state"
      pattern: "BusinessDetailDrawer"
---

<objective>
Create the BusinessDetailDrawer with full agency metadata display, inline edit mode, auto-save notes, competitive analysis section, and integrate it into the BusinessesClient shell.

Purpose: This is the primary interaction surface for agency owners to view and manage client metadata. The drawer shows the full picture of each client's Google presence, competitive positioning, and agency relationship details.
Output: BusinessDetailDrawer component with view/edit toggle, auto-save notes (matching CustomerDetailDrawer pattern), competitive analysis section, integrated into the existing BusinessesClient.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-clients-page/55-RESEARCH.md
@.planning/phases/55-clients-page/55-01-SUMMARY.md
@.planning/phases/55-clients-page/55-02-SUMMARY.md

Key references in codebase:
@components/customers/customer-detail-drawer.tsx — PRIMARY REFERENCE: Auto-save notes pattern (lines 51-97), Sheet layout, SheetBody/SheetFooter pattern
@components/ui/sheet.tsx — Sheet, SheetContent, SheetHeader, SheetBody, SheetFooter, SheetTitle, SheetDescription
@lib/actions/business-metadata.ts — updateBusinessMetadata(), updateBusinessNotes() (created in 55-01)
@lib/validations/business-metadata.ts — businessMetadataSchema, BusinessMetadataInput (created in 55-01)
@lib/actions/active-business.ts — switchBusiness() action for "Switch to this business" button
@components/businesses/businesses-client.tsx — Client shell to integrate drawer into (created in 55-02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: BusinessDetailDrawer component</name>
  <files>
    components/businesses/business-detail-drawer.tsx
  </files>
  <action>
Create `components/businesses/business-detail-drawer.tsx` as a Client Component.

**Props:**
```typescript
interface BusinessDetailDrawerProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  business: Business | null
  isActive: boolean
  onBusinessUpdated: (updated: Business) => void  // callback to update local state in parent
}
```

**State Management:**
- `isEditing: boolean` — toggles between view and edit mode
- `isSaving: boolean` — loading state during save
- `formData: Partial<BusinessMetadataInput>` — edit form state (initialized from business props)
- Notes auto-save: Follow EXACT pattern from `customer-detail-drawer.tsx` lines 51-97:
  - `notes: string` state
  - `timeoutRef`, `notesRef`, `initialNotesRef` refs
  - Sync notes when business changes (useEffect on business)
  - Keep notesRef in sync
  - Flush pending on drawer close (useEffect on open)
  - `handleNotesChange` with 500ms setTimeout debounce calling `updateBusinessNotes(business.id, value)`

**When `isEditing` toggles to true:** Initialize formData from current business values:
```typescript
setFormData({
  google_rating_start: business.google_rating_start,
  google_rating_current: business.google_rating_current,
  review_count_start: business.review_count_start,
  review_count_current: business.review_count_current,
  monthly_fee: business.monthly_fee,
  start_date: business.start_date,
  gbp_access: business.gbp_access,
  competitor_name: business.competitor_name,
  competitor_review_count: business.competitor_review_count,
})
```

**Save handler:**
```typescript
async function handleSave() {
  if (!business) return
  setIsSaving(true)
  const result = await updateBusinessMetadata(business.id, formData)
  setIsSaving(false)
  if (result.success) {
    toast.success('Changes saved')
    // Update parent state with merged values
    onBusinessUpdated({ ...business, ...formData })
    setIsEditing(false)
  } else {
    toast.error(result.error || 'Failed to save')
  }
}
```

**Drawer Layout (using Sheet from components/ui/sheet.tsx):**

```
Sheet (side="right", sm:max-w-lg)
├── SheetHeader
│   ├── SheetTitle: business.name
│   └── SheetDescription: "Client details and competitive analysis"
│
├── SheetBody (space-y-6)
│   ├── Section 1: Google Performance
│   │   ├── h4: "Google Performance" (text-sm font-medium mb-3)
│   │   ├── View mode: Grid of key-value pairs (2 columns on sm)
│   │   │   ├── Rating Start: business.google_rating_start (or "Not set")
│   │   │   ├── Rating Current: business.google_rating_current (or "Not set")
│   │   │   ├── Reviews Start: business.review_count_start (or "Not set")
│   │   │   ├── Reviews Current: business.review_count_current (or "Not set")
│   │   │   └── Reviews Gained: computed (review_count_current - review_count_start), green if positive
│   │   └── Edit mode: Input fields for ratings (type="number", step="0.1", min="1", max="5")
│   │       and review counts (type="number", min="0")
│   │
│   ├── Section 2: Competitive Analysis (CLIENT-08)
│   │   ├── h4: "Competitive Analysis" (text-sm font-medium mb-3)
│   │   ├── View mode: Side-by-side comparison
│   │   │   ├── Left column: "Your Client" — review_count_current, google_rating_current
│   │   │   ├── Right column: competitor_name — competitor_review_count
│   │   │   └── Center/bottom: Gap indicator
│   │   │       ├── Positive gap: green badge "+N reviews ahead"
│   │   │       ├── Negative gap: red badge "N reviews behind"
│   │   │       └── No data: muted "Add competitor data to see gap"
│   │   └── Edit mode: Input for competitor_name (text) and competitor_review_count (number)
│   │
│   ├── Section 3: Agency Details
│   │   ├── h4: "Agency Details" (text-sm font-medium mb-3)
│   │   ├── View mode:
│   │   │   ├── Monthly Fee: formatted as "$X.XX" (or "Not set")
│   │   │   ├── Start Date: formatted with date-fns format(parseISO(date), 'MMM d, yyyy') (or "Not set")
│   │   │   └── GBP Access: green "Yes" / red "No" / muted "Not set"
│   │   └── Edit mode:
│   │       ├── Monthly Fee: Input type="number" step="0.01" min="0"
│   │       ├── Start Date: Input type="date"
│   │       └── GBP Access: Checkbox or Switch
│   │
│   └── Section 4: Notes (always editable, no edit mode toggle needed)
│       ├── Label: "Notes"
│       ├── Description: "Private agency notes (auto-saved)"
│       └── Textarea: value={notes}, onChange={handleNotesChange}
│           ├── min-h-[120px] resize-none
│           └── placeholder="Add notes about this client..."
│
└── SheetFooter (flex flex-col gap-2)
    ├── Edit/Save button:
    │   ├── Not editing: Button "Edit Details" (variant="outline", PencilSimple icon)
    │   └── Editing: Two buttons — "Save" (default, disabled={isSaving}) + "Cancel" (variant="ghost")
    └── Switch business button:
        └── Button "Switch to this business" (variant="ghost", ArrowsClockwise icon)
            ├── Only shown if !isActive (don't show for already-active business)
            ├── onClick: call switchBusiness(business.id) from lib/actions/active-business.ts
            └── Shows toast on success
```

**View mode key-value pair pattern:**
```tsx
<div className="flex justify-between text-sm">
  <span className="text-muted-foreground">Rating Start</span>
  <span className="font-medium">{business.google_rating_start?.toFixed(1) ?? 'Not set'}</span>
</div>
```

**Edit mode input pattern:**
```tsx
<div className="space-y-1.5">
  <Label htmlFor="google-rating-start" className="text-xs">Rating Start</Label>
  <Input
    id="google-rating-start"
    type="number"
    step="0.1"
    min="1"
    max="5"
    value={formData.google_rating_start ?? ''}
    onChange={(e) => setFormData(prev => ({
      ...prev,
      google_rating_start: e.target.value ? Number(e.target.value) : null
    }))}
    placeholder="e.g., 4.2"
  />
</div>
```

**Competitive Analysis side-by-side layout (CLIENT-08):**
Use a 2-column grid with a gap indicator between/below:
```tsx
<div className="grid grid-cols-2 gap-4">
  {/* Client column */}
  <div className="space-y-2 text-center">
    <p className="text-xs text-muted-foreground font-medium uppercase tracking-wide">Your Client</p>
    <p className="text-3xl font-bold">{business.review_count_current ?? '—'}</p>
    <p className="text-xs text-muted-foreground">reviews</p>
  </div>
  {/* Competitor column */}
  <div className="space-y-2 text-center">
    <p className="text-xs text-muted-foreground font-medium uppercase tracking-wide">
      {business.competitor_name || 'Competitor'}
    </p>
    <p className="text-3xl font-bold">{business.competitor_review_count ?? '—'}</p>
    <p className="text-xs text-muted-foreground">reviews</p>
  </div>
</div>
{/* Gap indicator */}
<div className="text-center mt-3">
  {hasCompetitorData ? (
    <span className={cn(
      "inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium",
      gap > 0 ? "bg-green-50 text-success dark:bg-green-950/30" :
      gap < 0 ? "bg-red-50 text-destructive dark:bg-red-950/30" :
      "bg-muted text-muted-foreground"
    )}>
      {gap > 0 ? `+${gap} reviews ahead` : gap < 0 ? `${Math.abs(gap)} reviews behind` : 'Tied'}
    </span>
  ) : (
    <p className="text-sm text-muted-foreground">Add competitor data to see gap analysis</p>
  )}
</div>
```

**Imports needed:**
- Sheet components from `@/components/ui/sheet`
- Button from `@/components/ui/button`
- Input from `@/components/ui/input`
- Label from `@/components/ui/label`
- Textarea from `@/components/ui/textarea`
- Switch from `@/components/ui/switch` (for GBP access toggle)
- Phosphor icons: PencilSimple, ArrowsClockwise, Star
- date-fns: format, parseISO
- toast from sonner
- Business type from `@/lib/types/database`
- updateBusinessMetadata, updateBusinessNotes from `@/lib/actions/business-metadata`
- switchBusiness from `@/lib/actions/active-business`
- cn from `@/lib/utils`

**When drawer closes:** Reset `isEditing` to false (so it opens in view mode next time).

**Critical patterns to follow exactly:**
- Notes auto-save: Copy the debounce pattern from customer-detail-drawer.tsx verbatim (useState + 3 refs + 2 useEffects + handleNotesChange with setTimeout)
- Sheet width: `sm:max-w-lg` (512px) matching customer detail drawer
- SheetBody for scrollable content area
- Guard: `if (!business) return null` at top of component
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm lint` passes
    - Component file exists with all 4 sections (Google Performance, Competitive Analysis, Agency Details, Notes)
    - Notes auto-save pattern matches customer-detail-drawer.tsx (3 refs, 2 useEffects, setTimeout 500ms)
    - Edit mode renders inputs for all 9 metadata fields
    - Competitive analysis shows side-by-side comparison
  </verify>
  <done>
    BusinessDetailDrawer renders all agency metadata in organized sections. View mode shows formatted values. Edit mode provides input fields with save/cancel. Notes auto-save with 500ms debounce. Competitive analysis shows side-by-side client vs competitor comparison with gap badge.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate drawer into BusinessesClient</name>
  <files>
    components/businesses/businesses-client.tsx
  </files>
  <action>
Update `components/businesses/businesses-client.tsx` (created in Plan 55-02) to wire the BusinessDetailDrawer:

1. Add import: `import { BusinessDetailDrawer } from './business-detail-drawer'`

2. The `selectedBusiness` and `drawerOpen` state should already exist from Plan 55-02. If not, add them:
   ```typescript
   const [selectedBusiness, setSelectedBusiness] = useState<Business | null>(null)
   const [drawerOpen, setDrawerOpen] = useState(false)
   ```

3. Add local `businesses` state to enable optimistic updates after metadata edits:
   ```typescript
   const [localBusinesses, setLocalBusinesses] = useState<Business[]>(businesses)
   ```
   Use `localBusinesses` for rendering the grid instead of the `businesses` prop directly.

4. Add `handleBusinessUpdated` callback:
   ```typescript
   const handleBusinessUpdated = (updated: Business) => {
     setLocalBusinesses(prev => prev.map(b => b.id === updated.id ? updated : b))
     setSelectedBusiness(updated)  // update drawer display too
   }
   ```

5. Replace the drawer placeholder comment with actual drawer render:
   ```tsx
   <BusinessDetailDrawer
     open={drawerOpen}
     onOpenChange={setDrawerOpen}
     business={selectedBusiness}
     isActive={selectedBusiness?.id === activeBusinessId}
     onBusinessUpdated={handleBusinessUpdated}
   />
   ```

6. Ensure the card grid maps over `localBusinesses` (not `businesses` prop).

7. Sync `localBusinesses` with prop when prop changes (e.g., after revalidation):
   ```typescript
   useEffect(() => {
     setLocalBusinesses(businesses)
   }, [businesses])
   ```

This wiring ensures:
- Clicking a card opens the drawer with that business's data
- Editing metadata in the drawer updates both the drawer and the card grid immediately (optimistic)
- After `revalidatePath('/businesses')` fires from the server action, Next.js will re-render the page with fresh data, which flows through props to localBusinesses
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm lint` passes
    - Clicking a business card opens the detail drawer with correct data
    - Editing metadata and saving updates the card grid without a full page reload
    - Drawer closes cleanly and notes flush on close
    - "Switch to this business" button works (calls switchBusiness action)
  </verify>
  <done>
    BusinessDetailDrawer fully integrated into BusinessesClient. Card clicks open drawer. Metadata edits update grid optimistically. Notes auto-save on change and flush on close. Switch business button available for non-active businesses.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm lint` passes with zero errors
- Full flow works: navigate to /businesses -> see card grid -> click card -> drawer opens -> view metadata -> edit metadata -> save -> card updates -> close drawer -> notes flushed
- Competitive analysis section shows side-by-side comparison in view mode
- Notes auto-save triggers on typing (500ms debounce) and flushes pending on drawer close
- Edit mode shows inputs for all 9 metadata fields
- Cancel edit discards changes and returns to view mode
- "Switch to this business" button shown only for non-active businesses
- All CLIENT requirements (03, 04, 05, 06, 08) satisfied
</verification>

<success_criteria>
- CLIENT-03 satisfied: Card click opens detail drawer with full agency metadata
- CLIENT-04 satisfied: Drawer shows Google ratings, review counts, reviews gained, fee, start date, GBP access, competitor data, notes
- CLIENT-05 satisfied: User can edit all metadata fields in the drawer
- CLIENT-06 satisfied: Notes auto-save with debounce (no save button needed)
- CLIENT-08 satisfied: Side-by-side competitive analysis with gap indicator
- Auto-save pattern matches existing CustomerDetailDrawer exactly
</success_criteria>

<output>
After completion, create `.planning/phases/55-clients-page/55-03-SUMMARY.md`
</output>
