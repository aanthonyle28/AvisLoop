---
phase: 55-clients-page
plan: 02
type: execute
wave: 2
depends_on: ["55-01"]
files_modified:
  - app/(dashboard)/businesses/page.tsx
  - app/(dashboard)/businesses/loading.tsx
  - components/businesses/businesses-client.tsx
  - components/businesses/business-card.tsx
  - components/businesses/business-card-skeleton.tsx
autonomous: true

must_haves:
  truths:
    - "Navigating to /businesses shows a responsive card grid with one card per client business"
    - "Each card displays business name, service type badge, Google rating, and reviews gained"
    - "Each card shows a competitive gap indicator (green if ahead, red if behind, muted if no data)"
    - "Clicking a card sets selectedBusiness state in the client shell (drawer integration in Plan 55-03)"
    - "Loading state shows skeleton card grid while data fetches"
    - "Empty state guides user when no businesses exist"
  artifacts:
    - path: "app/(dashboard)/businesses/page.tsx"
      provides: "Server Component page that fetches all businesses"
      contains: "getUserBusinessesWithMetadata"
    - path: "app/(dashboard)/businesses/loading.tsx"
      provides: "Skeleton loading state with card placeholders"
      contains: "BusinessCardSkeleton"
    - path: "components/businesses/businesses-client.tsx"
      provides: "Client shell managing card grid and drawer state"
      contains: "selectedBusiness"
    - path: "components/businesses/business-card.tsx"
      provides: "Presentational card with agency metadata display"
      contains: "InteractiveCard"
    - path: "components/businesses/business-card-skeleton.tsx"
      provides: "Skeleton placeholder matching card layout"
      contains: "Skeleton"
  key_links:
    - from: "app/(dashboard)/businesses/page.tsx"
      to: "lib/data/businesses.ts"
      via: "Server Component data fetch"
      pattern: "getUserBusinessesWithMetadata"
    - from: "components/businesses/businesses-client.tsx"
      to: "components/businesses/business-card.tsx"
      via: "Grid map rendering"
      pattern: "businesses\\.map"
    - from: "components/businesses/business-card.tsx"
      to: "components/ui/card.tsx"
      via: "InteractiveCard with hoverAccent"
      pattern: "InteractiveCard"
---

<objective>
Create the /businesses page with a responsive card grid showing all client businesses with agency metadata (name, service type, Google rating, reviews gained, competitive gap).

Purpose: This is the primary view for agency owners to see all their clients at a glance with key performance indicators. The card grid is the entry point for the detail drawer (Plan 55-03).
Output: Server Component page, Client Component shell with drawer state management, BusinessCard presentational component, skeleton loading state.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-clients-page/55-RESEARCH.md
@.planning/phases/55-clients-page/55-01-SUMMARY.md

Key references in codebase:
@app/(dashboard)/customers/page.tsx — Server Component page pattern (getActiveBusiness + redirect)
@app/(dashboard)/customers/loading.tsx — Skeleton loading pattern
@components/dashboard/kpi-widgets.tsx — InteractiveCard grid + KPIWidgetsSkeleton pattern
@components/ui/card.tsx — InteractiveCard with hoverAccent variants
@lib/types/database.ts — Business interface with agency metadata fields (added in 55-01)
@lib/data/businesses.ts — getUserBusinessesWithMetadata() (created in 55-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server Component page + loading skeleton</name>
  <files>
    app/(dashboard)/businesses/page.tsx
    app/(dashboard)/businesses/loading.tsx
    components/businesses/business-card-skeleton.tsx
  </files>
  <action>
1. Create `app/(dashboard)/businesses/page.tsx` as a Server Component:
   ```typescript
   import { getActiveBusiness } from '@/lib/data/active-business'
   import { getUserBusinessesWithMetadata } from '@/lib/data/businesses'
   import { BusinessesClient } from '@/components/businesses/businesses-client'
   import { redirect } from 'next/navigation'

   export const metadata = {
     title: 'Businesses',
     description: 'Manage your client businesses',
   }

   export default async function BusinessesPage() {
     const activeBusiness = await getActiveBusiness()
     if (!activeBusiness) redirect('/onboarding')

     const businesses = await getUserBusinessesWithMetadata()

     return (
       <div className="container py-6 space-y-8">
         <BusinessesClient
           businesses={businesses}
           activeBusinessId={activeBusiness.id}
         />
       </div>
     )
   }
   ```
   Follow the exact same pattern as `app/(dashboard)/customers/page.tsx`: getActiveBusiness for auth guard, separate data function for page-specific data, pass to client component.

2. Create `components/businesses/business-card-skeleton.tsx`:
   - A card-shaped skeleton matching the BusinessCard layout
   - Uses `Skeleton` from `@/components/ui/skeleton` and `Card` from `@/components/ui/card`
   - Layout: Card with p-6, skeleton for business name (h-5 w-32), skeleton for service type badge (h-5 w-16), skeleton for rating (h-8 w-12), skeleton for reviews gained (h-4 w-24), skeleton for competitive gap (h-4 w-20)

3. Create `app/(dashboard)/businesses/loading.tsx`:
   ```typescript
   import { Skeleton } from '@/components/ui/skeleton'
   import { BusinessCardSkeleton } from '@/components/businesses/business-card-skeleton'

   export default function BusinessesLoading() {
     return (
       <div className="container py-6 space-y-8">
         {/* Header */}
         <div className="space-y-2">
           <Skeleton className="h-8 w-40" />
           <Skeleton className="h-4 w-64" />
         </div>
         {/* Card grid skeleton */}
         <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
           {[1, 2, 3].map((i) => (
             <BusinessCardSkeleton key={i} />
           ))}
         </div>
       </div>
     )
   }
   ```
  </action>
  <verify>
    - `pnpm typecheck` passes
    - File exists at `app/(dashboard)/businesses/page.tsx`
    - File exists at `app/(dashboard)/businesses/loading.tsx`
    - File exists at `components/businesses/business-card-skeleton.tsx`
  </verify>
  <done>
    Server Component page fetches all businesses and passes to client shell. Loading skeleton shows 3 card placeholders in a responsive grid.
  </done>
</task>

<task type="auto">
  <name>Task 2: BusinessCard + BusinessesClient grid</name>
  <files>
    components/businesses/business-card.tsx
    components/businesses/businesses-client.tsx
  </files>
  <action>
1. Create `components/businesses/business-card.tsx` as a presentational component:
   - Props: `business: Business`, `isActive: boolean` (to show "Active" indicator for current business)
   - Uses `InteractiveCard` with `hoverAccent="amber"` and `className="p-6"`
   - Card layout (top to bottom):
     a) **Header row:** Business name (font-semibold truncate) + active badge (if isActive, show small green "Active" text/dot)
     b) **Service type badge:** Show first enabled service type from `business.service_types_enabled` as a Badge-like element (text-xs font-medium bg-muted px-2 py-0.5 rounded-full). If multiple types, append "+N" (e.g., "HVAC +2"). If no types enabled, show "No services". Capitalize the display text.
     c) **Google rating:** Show `business.google_rating_current` as a star rating display (e.g., "4.3" with a Star icon from Phosphor). If null, show muted "No rating".
     d) **Reviews gained:** Compute `reviewsGained = (review_count_current ?? 0) - (review_count_start ?? 0)`. Show as "+N reviews" in green if positive, "0 reviews" muted if zero, or show "No data" muted if both values are null.
     e) **Competitive gap indicator (CLIENT-07):** Compute `competitiveGap = (review_count_current ?? 0) - (competitor_review_count ?? 0)`. Visual indicator:
        - `competitiveGap > 0`: green text `+N ahead`
        - `competitiveGap < 0`: red/destructive text `N behind`
        - Both values null: muted "No competitor data"
        - Only one value null: muted "Incomplete data"
   - Use `cn()` for conditional classes
   - Use Phosphor icons: `Star` (weight="fill") for rating, `TrendUp`/`TrendDown` or `ArrowUp`/`ArrowDown` for gap indicator
   - Do NOT add onClick — the parent handles click via wrapping or passing handler

2. Create `components/businesses/businesses-client.tsx` as a Client Component:
   - Props: `businesses: Business[]`, `activeBusinessId: string`
   - State: `selectedBusiness: Business | null` (for drawer, initially null)
   - State: `drawerOpen: boolean` (false initially)
   - Renders:
     a) **Page header:** "Businesses" (text-3xl font-bold tracking-tight) + description "Manage your client businesses"
     b) **Card grid:** `grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4`
        - Map over `businesses` array
        - Each card wrapped in a div with `onClick={() => { setSelectedBusiness(biz); setDrawerOpen(true) }}`
        - Pass `isActive={biz.id === activeBusinessId}` to each BusinessCard
     c) **Drawer placeholder:** Comment `{/* BusinessDetailDrawer will be added in Plan 55-03 */}` with the state variables `selectedBusiness` and `drawerOpen` ready for use
     d) **Empty state:** If `businesses.length === 0`, show centered empty state:
        - Icon in circle (Buildings from Phosphor, weight="regular", in a bg-muted rounded-full p-6)
        - Title: "No businesses yet"
        - Description: "Create your first business to get started with AvisLoop."
        - No CTA button yet (Phase 56 adds the Add Business button)
   - Mark as `'use client'` at top
   - Import `Business` type from `@/lib/types/database`
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm lint` passes
    - Navigate to `/businesses` in dev mode shows the card grid (if businesses exist) or empty state
    - Each card shows business name, service type, rating, reviews gained, and competitive gap
    - Clicking a card updates `selectedBusiness` state (verified via React DevTools or console.log)
  </verify>
  <done>
    Responsive card grid displays all client businesses with agency metadata. Cards show business name, service type badge, Google rating, reviews gained, and competitive gap indicator. Client shell has state management ready for drawer integration in Plan 55-03.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm lint` passes with zero errors
- `/businesses` route renders under the dashboard layout (sidebar visible)
- Card grid is responsive: 1 column on mobile, 2 on tablet, 3 on desktop
- Each card shows: business name, service type badge, Google rating, reviews gained, competitive gap
- Active business card shows "Active" indicator
- Loading skeleton shows 3 placeholder cards
- Empty state shown when user has no businesses
- Clicking a card sets selectedBusiness state (drawer not yet wired)
</verification>

<success_criteria>
- CLIENT-01 satisfied: Card grid on /businesses page
- CLIENT-02 satisfied: Each card shows name, service type, Google rating, reviews gained
- CLIENT-07 satisfied: Competitive gap visual indicator on each card
- Page follows Server Component -> Client Component shell pattern
- Loading state and empty state both handled
</success_criteria>

<output>
After completion, create `.planning/phases/55-clients-page/55-02-SUMMARY.md`
</output>
