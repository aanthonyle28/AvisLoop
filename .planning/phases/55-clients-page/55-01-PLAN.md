---
phase: 55-clients-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260227_add_agency_metadata.sql
  - lib/types/database.ts
  - lib/data/businesses.ts
  - lib/actions/business-metadata.ts
  - lib/validations/business-metadata.ts
autonomous: true

must_haves:
  truths:
    - "10 nullable agency metadata columns exist on the businesses table"
    - "Business TypeScript interface includes all 10 new nullable fields"
    - "getUserBusinessesWithMetadata() returns all businesses owned by the authenticated user with agency columns"
    - "updateBusinessMetadata() persists metadata changes and revalidates /businesses"
    - "updateBusinessNotes() persists notes without revalidating (fire-and-forget for auto-save)"
    - "Zod schema validates all agency metadata fields with correct constraints"
  artifacts:
    - path: "supabase/migrations/20260227_add_agency_metadata.sql"
      provides: "10 agency metadata columns on businesses table"
      contains: "ALTER TABLE public.businesses"
    - path: "lib/types/database.ts"
      provides: "Extended Business interface with agency fields"
      contains: "google_rating_start"
    - path: "lib/data/businesses.ts"
      provides: "getUserBusinessesWithMetadata data function"
      exports: ["getUserBusinessesWithMetadata"]
    - path: "lib/actions/business-metadata.ts"
      provides: "Server actions for metadata and notes updates"
      exports: ["updateBusinessMetadata", "updateBusinessNotes"]
    - path: "lib/validations/business-metadata.ts"
      provides: "Zod validation schema for agency metadata"
      exports: ["businessMetadataSchema"]
  key_links:
    - from: "lib/actions/business-metadata.ts"
      to: "lib/validations/business-metadata.ts"
      via: "Zod safeParse before database write"
      pattern: "businessMetadataSchema\\.safeParse"
    - from: "lib/data/businesses.ts"
      to: "supabase businesses table"
      via: "select('*') with user_id filter"
      pattern: "\\.from\\('businesses'\\)"
---

<objective>
Add 10 agency metadata columns to the businesses table and create the full data layer (TypeScript types, data function, server actions, validation) that Plans 55-02 and 55-03 depend on.

Purpose: This is the foundation for the entire Clients Page feature. Without the database columns and data access layer, neither the card grid nor the detail drawer can function.
Output: Migration file, extended Business interface, data function, two server actions, Zod validation schema.
</objective>

<execution_context>
@C:\Users\aanth\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\aanth\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-clients-page/55-RESEARCH.md

Key references in codebase:
@lib/types/database.ts — Business interface to extend (lines 27-47)
@lib/data/active-business.ts — getUserBusinesses() pattern to follow (lines 69-84)
@lib/actions/customer.ts — updateCustomerNotes() pattern for fire-and-forget notes action
@lib/validations/customer.ts — Zod schema pattern to follow
@supabase/migrations/20260225072556_add_custom_service_names.sql — Column addition migration pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migration + TypeScript types</name>
  <files>
    supabase/migrations/20260227_add_agency_metadata.sql
    lib/types/database.ts
  </files>
  <action>
1. Create migration file `supabase/migrations/20260227_add_agency_metadata.sql` with:
   ```sql
   ALTER TABLE public.businesses
     ADD COLUMN IF NOT EXISTS google_rating_start NUMERIC(2,1) DEFAULT NULL,
     ADD COLUMN IF NOT EXISTS google_rating_current NUMERIC(2,1) DEFAULT NULL,
     ADD COLUMN IF NOT EXISTS review_count_start INTEGER DEFAULT NULL,
     ADD COLUMN IF NOT EXISTS review_count_current INTEGER DEFAULT NULL,
     ADD COLUMN IF NOT EXISTS monthly_fee NUMERIC(10,2) DEFAULT NULL,
     ADD COLUMN IF NOT EXISTS start_date DATE DEFAULT NULL,
     ADD COLUMN IF NOT EXISTS gbp_access BOOLEAN DEFAULT NULL,
     ADD COLUMN IF NOT EXISTS competitor_name TEXT DEFAULT NULL,
     ADD COLUMN IF NOT EXISTS competitor_review_count INTEGER DEFAULT NULL,
     ADD COLUMN IF NOT EXISTS agency_notes TEXT DEFAULT NULL;
   ```
   Add COMMENT ON COLUMN for each column (documentation purpose). Follow exact pattern from `20260225072556_add_custom_service_names.sql`.

   IMPORTANT: All columns MUST be nullable (no NOT NULL) because existing businesses rows have no agency data.
   IMPORTANT: Use NUMERIC(2,1) for ratings (exact decimal, avoids floating point issues like 4.299999).
   IMPORTANT: Use NUMERIC(10,2) for monthly_fee (currency precision).

2. Extend the `Business` interface in `lib/types/database.ts` by adding these 10 fields after the `updated_at` field:
   ```typescript
   // Agency metadata (all nullable -- only populated for agency-managed businesses)
   google_rating_start: number | null
   google_rating_current: number | null
   review_count_start: number | null
   review_count_current: number | null
   monthly_fee: number | null
   start_date: string | null         // DATE stored as ISO string
   gbp_access: boolean | null
   competitor_name: string | null
   competitor_review_count: number | null
   agency_notes: string | null
   ```

   Do NOT modify any other interface or type in this file. Only add fields to the existing Business interface.
  </action>
  <verify>
    - `pnpm typecheck` passes (no TypeScript errors from the interface change)
    - Migration file exists at `supabase/migrations/20260227_add_agency_metadata.sql`
    - Business interface in `lib/types/database.ts` includes all 10 new nullable fields
  </verify>
  <done>
    Migration file ready for `supabase db push`. Business interface includes all 10 agency metadata fields typed as nullable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Data function + server actions + validation</name>
  <files>
    lib/data/businesses.ts
    lib/actions/business-metadata.ts
    lib/validations/business-metadata.ts
  </files>
  <action>
1. Create `lib/data/businesses.ts` with a single export `getUserBusinessesWithMetadata()`:
   - Import `createClient` from `@/lib/supabase/server`
   - Import `Business` type from `@/lib/types/database`
   - Authenticate user via `supabase.auth.getUser()`
   - If not authenticated, return empty array
   - Query `supabase.from('businesses').select('*').eq('user_id', user.id).order('created_at', { ascending: true })`
   - Return `data ?? []` typed as `Business[]`
   - Do NOT use `.single()` — this returns ALL businesses as an array
   - Do NOT use `getActiveBusiness()` — this page shows ALL businesses, not the active one

2. Create `lib/validations/business-metadata.ts` with Zod schema:
   ```typescript
   import { z } from 'zod'

   export const businessMetadataSchema = z.object({
     google_rating_start: z.number().min(1).max(5).nullable().optional(),
     google_rating_current: z.number().min(1).max(5).nullable().optional(),
     review_count_start: z.number().int().min(0).nullable().optional(),
     review_count_current: z.number().int().min(0).nullable().optional(),
     monthly_fee: z.number().min(0).max(99999.99).nullable().optional(),
     start_date: z.string().nullable().optional(),
     gbp_access: z.boolean().nullable().optional(),
     competitor_name: z.string().max(200).nullable().optional(),
     competitor_review_count: z.number().int().min(0).nullable().optional(),
   })

   export type BusinessMetadataInput = z.infer<typeof businessMetadataSchema>
   ```
   Note: `agency_notes` is NOT in this schema — notes have their own dedicated action.

3. Create `lib/actions/business-metadata.ts` with two server actions:

   a) `updateBusinessMetadata(businessId: string, data: BusinessMetadataInput)`:
      - Mark file as `'use server'`
      - Import `createClient`, `revalidatePath`, `businessMetadataSchema`
      - Authenticate user via `supabase.auth.getUser()` — return `{ error: 'Not authenticated' }` if fails
      - Validate `data` with `businessMetadataSchema.safeParse(data)` — return field errors if fails
      - Update `supabase.from('businesses').update(parsed.data).eq('id', businessId)` — RLS ensures ownership
      - Call `revalidatePath('/businesses')` on success
      - Return `{ success: true }` or `{ error: error.message }`

   b) `updateBusinessNotes(businessId: string, notes: string)`:
      - Follow the exact pattern from `updateCustomerNotes` in `lib/actions/customer.ts`
      - Authenticate user
      - Validate: `typeof notes !== 'string' || notes.length > 10000` returns error
      - Update: `supabase.from('businesses').update({ agency_notes: notes }).eq('id', businessId)`
      - Do NOT call `revalidatePath` — notes auto-save is fire-and-forget (no visual rerender needed)
      - Return `{ success: true }` or `{ error: error.message }`

   Both actions return `Promise<{ error?: string; success?: boolean }>`.
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm lint` passes
    - `lib/data/businesses.ts` exports `getUserBusinessesWithMetadata`
    - `lib/actions/business-metadata.ts` has `'use server'` directive and exports both actions
    - `lib/validations/business-metadata.ts` exports `businessMetadataSchema` and `BusinessMetadataInput`
  </verify>
  <done>
    Data function returns all user businesses with metadata. Two server actions handle metadata updates (with revalidation) and notes updates (fire-and-forget). Zod schema validates all 9 editable metadata fields.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes with zero errors
- `pnpm lint` passes with zero errors
- Migration file at `supabase/migrations/20260227_add_agency_metadata.sql` contains all 10 column additions
- `Business` interface in `lib/types/database.ts` has 10 new nullable fields
- `getUserBusinessesWithMetadata()` in `lib/data/businesses.ts` queries by user_id and returns Business[]
- `updateBusinessMetadata()` validates with Zod, updates via Supabase, revalidates /businesses
- `updateBusinessNotes()` validates length, updates via Supabase, no revalidation
- No existing files broken (BusinessSettingsProvider, getActiveBusiness, etc. still work because new fields are additive and nullable)
</verification>

<success_criteria>
- All 5 new files created with correct exports
- TypeScript compiles cleanly with extended Business interface
- Data function and server actions follow established codebase patterns
- Migration is safe for existing data (all columns nullable)
</success_criteria>

<output>
After completion, create `.planning/phases/55-clients-page/55-01-SUMMARY.md`
</output>
