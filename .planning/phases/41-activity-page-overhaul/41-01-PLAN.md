---
phase: 41
plan: 41-01
title: "Fix resend logic, page header, and inline retry"
wave: 1
depends_on: []
files_modified:
  - components/history/history-columns.tsx
  - components/history/history-table.tsx
  - components/history/history-client.tsx
  - app/(dashboard)/history/page.tsx
autonomous: true
---

## Objective

Fix the Activity page so the Retry button only appears on failed/bounced rows, is always visible inline (no hover-to-reveal), performs an immediate resend (no drawer), and the page header matches the standard pattern with "Send History" title and dynamic count.

## Context

@components/history/history-columns.tsx — Actions column with broken `canResend` logic and `opacity-0 group-hover:opacity-100` pattern
@components/history/history-table.tsx — Table component with `RESENDABLE_STATUSES` duplicate and `group` class on rows
@components/history/history-client.tsx — Page header ("Activity"), `handleQuickResend` (opens drawer instead of direct resend), bulk bar text
@app/(dashboard)/history/page.tsx — Server component with `metadata.title: 'Activity'`
@.planning/phases/41-activity-page-overhaul/41-RESEARCH.md — Full research with code examples and patterns

## Tasks

<task id="1">
### Fix RESENDABLE_STATUSES and actions column in history-columns.tsx

1. Change `RESENDABLE_STATUSES` to `['failed', 'bounced']` (remove `'complained'` — complained customers have `opted_out=true`, so retry will silently fail)
2. Export `RESENDABLE_STATUSES` so `history-table.tsx` can import it instead of duplicating:
   ```tsx
   export const RESENDABLE_STATUSES = ['failed', 'bounced']
   ```
3. Replace the actions column cell logic. Remove:
   - `const isPending = request.status === 'pending'`
   - `const canResend = !isPending && onResend`
   - The entire cancel button (pending cancel is unused/stub)
   - The `opacity-0 group-hover:opacity-100 transition-opacity` classes from the wrapper div

   New actions column:
   ```tsx
   {
     id: 'actions',
     header: '',
     cell: ({ row }) => {
       const request = row.original
       const isResendable = RESENDABLE_STATUSES.includes(request.status)

       if (!isResendable || !onResend) return null

       return (
         <div className="flex items-center justify-end">
           <Button
             variant="ghost"
             size="sm"
             onClick={(e) => {
               e.stopPropagation()
               onResend(request)
             }}
             className="h-8 px-2 gap-1.5"
           >
             <ArrowClockwise className="h-4 w-4" />
             Retry
           </Button>
         </div>
       )
     },
   }
   ```
4. Remove the `onCancel` prop from `CreateColumnsProps` interface and `createColumns` parameters — it is unused (the cancel handler is a stub toast).
5. Remove the `X` import from `@phosphor-icons/react` if it is no longer used after removing the cancel button.
</task>

<task id="2">
### Update history-table.tsx and history-client.tsx

**history-table.tsx:**
1. Remove the local `RESENDABLE_STATUSES` constant. Import from `history-columns.tsx`:
   ```tsx
   import { createColumns, RESENDABLE_STATUSES } from './history-columns'
   ```
2. Remove `onCancel` from `HistoryTableProps` interface and component parameters.
3. Remove `onCancel` from the `createColumns()` call.
4. Keep `className="group cursor-pointer hover:bg-muted/50"` on `<TableRow>` — the `group` class is harmless and removing it would be a cosmetic-only change.

**history-client.tsx:**
1. Update the page header from:
   ```tsx
   <h1 className="text-3xl font-bold tracking-tight">Activity</h1>
   <p className="text-muted-foreground mt-1">
     View your sent messages and their delivery status
   </p>
   ```
   To (matching jobs-client.tsx pattern):
   ```tsx
   <h1 className="text-2xl font-semibold tracking-tight">Send History</h1>
   <p className="text-muted-foreground">
     Track delivery status of your sent messages &middot; {total} total
   </p>
   ```
   Note: `text-2xl font-semibold` matches jobs page; previous was `text-3xl font-bold`.

2. Replace `handleQuickResend` (opens drawer) with `handleInlineRetry` (direct resend):
   ```tsx
   const handleInlineRetry = async (request: SendLogWithContact) => {
     setIsRetrying(true)
     try {
       const result = await bulkResendRequests([request.id])
       if (result.success) {
         toast.success('Message resent', {
           description: 'The message has been queued for delivery.',
           duration: 5000,
         })
         setRowSelection({})
         refresh()
       } else {
         toast.error('Failed to resend', {
           description: result.error || 'An error occurred',
           duration: 5000,
         })
       }
     } finally {
       setIsRetrying(false)
     }
   }
   ```

3. Remove `handleQuickCancel` function entirely. Remove `handleCancel` function and its eslint-disable comment.

4. Update the `<HistoryTable>` props:
   - Change `onResend={handleQuickResend}` to `onResend={handleInlineRetry}`
   - Remove `onCancel={handleQuickCancel}`

5. Update the bulk bar text from `"{selectedCount} failed message{s} selected"` to `"{selectedCount} message{selectedCount !== 1 ? 's' : ''} selected"` (status-agnostic).

6. Remove the `sendReviewRequest` import if no longer used (it is still used by `handleResend` in the drawer, so keep it).

**page.tsx:**
1. Update metadata:
   ```tsx
   export const metadata = {
     title: 'Send History',
     description: 'Track delivery status of your sent messages',
   }
   ```
2. Update the Suspense fallback text from "Loading activity..." to "Loading send history...".
</task>

## Verification

After implementation, run:
```bash
pnpm lint && pnpm typecheck
```

Then manually verify in the codebase:

1. `history-columns.tsx` — `RESENDABLE_STATUSES` is `['failed', 'bounced']`, exported. No `opacity-0` or `group-hover:opacity-100` in the file. No `onCancel` prop. Retry button has text "Retry" next to the icon.
2. `history-table.tsx` — imports `RESENDABLE_STATUSES` from `history-columns`. No local `RESENDABLE_STATUSES` definition. No `onCancel` in props or `createColumns` call.
3. `history-client.tsx` — header says "Send History" with `text-2xl font-semibold`. Subtitle includes `{total} total`. No `handleQuickResend` function. `handleInlineRetry` calls `bulkResendRequests([id])` directly. No `handleQuickCancel` or `handleCancel`. `onResend={handleInlineRetry}` passed to table. Bulk bar text says "message(s) selected" not "failed message(s)".
4. `page.tsx` — metadata title is "Send History".

## must_haves

- [ ] Retry button ONLY rendered for rows where status is 'failed' or 'bounced' — not for delivered, sent, opened, pending, or complained
- [ ] Retry button is always visible inline — no opacity-0 or group-hover pattern anywhere in the actions column
- [ ] Retry button shows icon + "Retry" text label (not icon-only)
- [ ] Clicking Retry calls bulkResendRequests directly (no drawer opens)
- [ ] Page title is "Send History" with text-2xl font-semibold matching Jobs page pattern
- [ ] Subtitle includes dynamic total count
- [ ] RESENDABLE_STATUSES defined in ONE place (history-columns.tsx), imported by history-table.tsx
- [ ] page.tsx metadata title updated to "Send History"
- [ ] pnpm lint passes
- [ ] pnpm typecheck passes
